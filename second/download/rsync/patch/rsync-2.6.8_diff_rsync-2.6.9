diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/access.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/access.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/access.c	2005-11-11 00:42:46.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/access.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,32 +1,29 @@
-/* 
-   Copyright (C) Andrew Tridgell 1998
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
 /*
-  hosts allow/deny code for rsync
-
-  */
+ * Routines to authenticate access to a daemon (hosts allow/deny).
+ *
+ * Copyright (C) 1998 Andrew Tridgell
+ * Copyright (C) 2004, 2005 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
-
 static int match_hostname(char *host, char *tok)
 {
 	if (!host || !*host)
 		return 0;
 	return wildmatch(tok, host);
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/authenticate.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/authenticate.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/authenticate.c	2006-03-07 02:22:20.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/authenticate.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,26 +1,27 @@
-/* -*- c-file-style: "linux"; -*-
+/*
+ * Support rsync daemon authentication.
+ *
+ * Copyright (C) 1998-2000 Andrew Tridgell
+ * Copyright (C) 2002, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
-   Copyright (C) 1998-2000 by Andrew Tridgell
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/* support rsync authentication */
 #include "rsync.h"
 
 extern char *password_file;
 
 /***************************************************************************
 encode a buffer using base64 - simple and slow algorithm. null terminates
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/backup.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/backup.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/backup.c	2006-02-25 00:43:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/backup.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,25 +1,26 @@
 /*
-   Copyright (C) Andrew Tridgell 1999
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/* backup handling code */
+ * Backup handling code.
+ *
+ * Copyright (C) 1999 Andrew Tridgell
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int backup_dir_len;
 extern unsigned int backup_dir_remainder;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/batch.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/batch.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/batch.c	2006-01-25 05:40:43.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/batch.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,12 +1,27 @@
-/* -*- c-file-style: "linux" -*-
-
-   Weiss 1/1999
-   Batch utilities for rsync.
-
-*/
+/*
+ * Support for the batch-file options.
+ *
+ * Copyright (C) 1999 Weiss
+ * Copyright (C) 2004 Chris Shoemaker
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 #include "zlib/zlib.h"
 #include <time.h>
 
 extern int eol_nulls;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/byteorder.h /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/byteorder.h
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/byteorder.h	1996-06-22 13:04:20.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/byteorder.h	2006-04-26 07:51:12.000000000 +0800
@@ -1,28 +1,29 @@
-/* 
-   simple byteorder handling
-   Copyright (C) Andrew Tridgell 1992-1995
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * Simple byteorder handling.
+ *
+ * Copyright (C) 1992-1995 Andrew Tridgell
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #undef CAREFUL_ALIGNMENT
 
-/* we know that the x86 can handle misalignment and has the "right" 
+/* we know that the x86 can handle misalignment and has the "right"
    byteorder */
 #ifdef __i386__
 #define CAREFUL_ALIGNMENT 0
 #endif
 
 #ifndef CAREFUL_ALIGNMENT
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9: case_N.h
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/checksum.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/checksum.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/checksum.c	2005-01-02 05:08:05.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/checksum.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,24 +1,27 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Routines to support checksumming of bytes.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2004, 2005 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 int csum_length=2; /* initial value */
 
 #define CSUM_CHUNK 64
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/chmod.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/chmod.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/chmod.c	2006-02-24 09:56:18.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/chmod.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,6 +1,27 @@
+/*
+ * Implement the core of the --chmod option.
+ *
+ * Copyright (C) 2002 Scott Howard
+ * Copyright (C) 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
 #include "rsync.h"
 
 extern mode_t orig_umask;
 
 #define FLAG_X_KEEP (1<<0)
 #define FLAG_DIRS_ONLY (1<<1)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/cleanup.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/cleanup.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/cleanup.c	2006-02-04 02:46:38.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/cleanup.c	2006-10-15 23:43:26.000000000 +0800
@@ -1,33 +1,38 @@
-/* -*- c-file-style: "linux" -*-
-
-   Copyright (C) 1996-2000 by Andrew Tridgell
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2002 by Martin Pool
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * End-of-run cleanup routines.
+ *
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
+extern int am_server;
+extern int am_daemon;
 extern int io_error;
 extern int keep_partial;
 extern int log_got_error;
 extern char *partial_dir;
+extern char *logfile_name;
 
 #ifdef HAVE_SIGACTION
 static struct sigaction sigact;
 #endif
 
 /**
@@ -84,98 +89,132 @@
 
 /**
  * Eventually calls exit(), passing @p code, therefore does not return.
  *
  * @param code one of the RERR_* codes from errcode.h.
  **/
-void _exit_cleanup(int code, const char *file, int line)
+NORETURN void _exit_cleanup(int code, const char *file, int line)
 {
-	int ocode = code;
-	static int inside_cleanup = 0;
-
-	if (inside_cleanup > 10) {
-		/* prevent the occasional infinite recursion */
-		return;
-	}
-	inside_cleanup++;
+	static int cleanup_step = 0;
+	static int exit_code = 0;
+	static int unmodified_code = 0;
 
 	SIGACTION(SIGUSR1, SIG_IGN);
 	SIGACTION(SIGUSR2, SIG_IGN);
 
-	if (verbose > 3) {
-		rprintf(FINFO,"_exit_cleanup(code=%d, file=%s, line=%d): entered\n",
-			code, file, line);
-	}
+	if (exit_code) /* Preserve first error code when recursing. */
+		code = exit_code;
 
-	if (cleanup_child_pid != -1) {
-		int status;
-		if (wait_process(cleanup_child_pid, &status, WNOHANG)
-		 == cleanup_child_pid) {
-			status = WEXITSTATUS(status);
-			if (status > code)
-				code = status;
+	/* Some of our actions might cause a recursive call back here, so we
+	 * keep track of where we are in the cleanup and never repeat a step. */
+	switch (cleanup_step) {
+#include "case_N.h" /* case 0: cleanup_step++; */
+
+		exit_code = unmodified_code = code;
+
+		if (verbose > 3) {
+			rprintf(FINFO,
+				"_exit_cleanup(code=%d, file=%s, line=%d): entered\n",
+				code, file, line);
 		}
-	}
 
-	if (cleanup_got_literal && cleanup_fname && keep_partial
-	    && handle_partial_dir(cleanup_new_fname, PDIR_CREATE)) {
-		char *fname = cleanup_fname;
-		cleanup_fname = NULL;
-		if (cleanup_fd_r != -1)
-			close(cleanup_fd_r);
-		if (cleanup_fd_w != -1) {
-			flush_write_file(cleanup_fd_w);
-			close(cleanup_fd_w);
+		/* FALLTHROUGH */
+#include "case_N.h"
+
+		if (cleanup_child_pid != -1) {
+			int status;
+			int pid = wait_process(cleanup_child_pid, &status, WNOHANG);
+			if (pid == cleanup_child_pid) {
+				status = WEXITSTATUS(status);
+				if (status > code)
+					code = exit_code = status;
+			}
 		}
-		finish_transfer(cleanup_new_fname, fname, NULL,
-				cleanup_file, 0, !partial_dir);
-	}
-	io_flush(FULL_FLUSH);
-	if (cleanup_fname)
-		do_unlink(cleanup_fname);
-	if (code)
-		kill_all(SIGUSR1);
-	if (cleanup_pid && cleanup_pid == getpid()) {
-		char *pidf = lp_pid_file();
-		if (pidf && *pidf)
-			unlink(lp_pid_file());
-	}
 
-	if (code == 0) {
-		if (io_error & IOERR_DEL_LIMIT)
-			code = RERR_DEL_LIMIT;
-		if (io_error & IOERR_VANISHED)
-			code = RERR_VANISHED;
-		if (io_error & IOERR_GENERAL || log_got_error)
-			code = RERR_PARTIAL;
-	}
+		/* FALLTHROUGH */
+#include "case_N.h"
+
+		if (cleanup_got_literal && cleanup_fname && cleanup_new_fname
+		 && keep_partial && handle_partial_dir(cleanup_new_fname, PDIR_CREATE)) {
+			char *fname = cleanup_fname;
+			cleanup_fname = NULL;
+			if (cleanup_fd_r != -1)
+				close(cleanup_fd_r);
+			if (cleanup_fd_w != -1) {
+				flush_write_file(cleanup_fd_w);
+				close(cleanup_fd_w);
+			}
+			finish_transfer(cleanup_new_fname, fname, NULL,
+					cleanup_file, 0, !partial_dir);
+		}
+
+		/* FALLTHROUGH */
+#include "case_N.h"
+
+		io_flush(FULL_FLUSH);
+
+		/* FALLTHROUGH */
+#include "case_N.h"
+
+		if (cleanup_fname)
+			do_unlink(cleanup_fname);
+		if (code)
+			kill_all(SIGUSR1);
+		if (cleanup_pid && cleanup_pid == getpid()) {
+			char *pidf = lp_pid_file();
+			if (pidf && *pidf)
+				unlink(lp_pid_file());
+		}
+
+		if (code == 0) {
+			if (io_error & IOERR_DEL_LIMIT)
+				code = exit_code = RERR_DEL_LIMIT;
+			if (io_error & IOERR_VANISHED)
+				code = exit_code = RERR_VANISHED;
+			if (io_error & IOERR_GENERAL || log_got_error)
+				code = exit_code = RERR_PARTIAL;
+		}
+
+		if (code || am_daemon || (logfile_name && (am_server || !verbose)))
+			log_exit(code, file, line);
+
+		/* FALLTHROUGH */
+#include "case_N.h"
+
+		if (verbose > 2) {
+			rprintf(FINFO,
+				"_exit_cleanup(code=%d, file=%s, line=%d): "
+				"about to call exit(%d)\n",
+				unmodified_code, file, line, code);
+		}
+
+		/* FALLTHROUGH */
+#include "case_N.h"
 
-	if (code)
-		log_exit(code, file, line);
+		close_all();
 
-	if (verbose > 2) {
-		rprintf(FINFO,"_exit_cleanup(code=%d, file=%s, line=%d): about to call exit(%d)\n",
-			ocode, file, line, code);
+		/* FALLTHROUGH */
+	default:
+		break;
 	}
 
-	close_all();
 	exit(code);
 }
 
 void cleanup_disable(void)
 {
-	cleanup_fname = NULL;
+	cleanup_fname = cleanup_new_fname = NULL;
 	cleanup_got_literal = 0;
 }
 
 
 void cleanup_set(char *fnametmp, char *fname, struct file_struct *file,
 		 int fd_r, int fd_w)
 {
-	cleanup_fname = fname ? fnametmp : NULL;
-	cleanup_new_fname = fname;
+	cleanup_fname = fnametmp;
+	cleanup_new_fname = fname; /* can be NULL on a partial-dir failure */
 	cleanup_file = file;
 	cleanup_fd_r = fd_r;
 	cleanup_fd_w = fd_w;
 }
 
 void cleanup_set_pid(pid_t pid)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/clientname.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/clientname.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/clientname.c	2006-02-25 00:43:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/clientname.c	2006-10-14 07:17:27.000000000 +0800
@@ -1,38 +1,34 @@
-/* -*- c-file-style: "linux" -*-
-
-   rsync -- fast file replication program
-
-   Copyright (C) 1992-2001 by Andrew Tridgell <tridge@samba.org>
-   Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/**
- * @file clientname.c
- *
+/*
  * Functions for looking up the remote name or addr of a socket.
  *
+ * Copyright (C) 1992-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2002, 2003, 2004 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+/*
  * This file is now converted to use the new-style getaddrinfo()
  * interface, which supports IPv6 but is also supported on recent
  * IPv4-only machines.  On systems that don't have that interface, we
  * emulate it using the KAME implementation.
- **/
+ */
 
 #include "rsync.h"
 
 static const char default_name[] = "UNKNOWN";
 extern int am_server;
 
@@ -51,13 +47,13 @@
 	if (initialised)
 		return addr_buf;
 
 	initialised = 1;
 
 	if (am_server) {	/* daemon over --rsh mode */
-		strcpy(addr_buf, "0.0.0.0");
+		strlcpy(addr_buf, "0.0.0.0", sizeof addr_buf);
 		if ((ssh_info = getenv("SSH_CONNECTION")) != NULL
 		    || (ssh_info = getenv("SSH_CLIENT")) != NULL
 		    || (ssh_info = getenv("SSH2_CLIENT")) != NULL) {
 			strlcpy(addr_buf, ssh_info, sizeof addr_buf);
 			/* Truncate the value to just the IP address. */
 			if ((p = strchr(addr_buf, ' ')) != NULL)
@@ -100,13 +96,13 @@
 	struct sockaddr_storage ss;
 	socklen_t ss_len;
 
 	if (initialised)
 		return name_buf;
 
-	strcpy(name_buf, default_name);
+	strlcpy(name_buf, default_name, sizeof name_buf);
 	initialised = 1;
 
 	memset(&ss, 0, sizeof ss);
 
 	if (am_server) {	/* daemon over --rsh mode */
 		char *addr = client_addr(fd);
@@ -134,22 +130,24 @@
 #ifdef INET6
 		case AF_INET6:
 			ss_len = sizeof (struct sockaddr_in6);
 			memcpy(&ss, answer->ai_addr, ss_len);
 			break;
 #endif
+		default:
+			exit_cleanup(RERR_SOCKETIO);
 		}
 		freeaddrinfo(answer);
 	} else {
 		ss_len = sizeof ss;
 		client_sockaddr(fd, &ss, &ss_len);
 	}
 
 	if (lookup_name(fd, &ss, ss_len, name_buf, sizeof name_buf,
 			port_buf, sizeof port_buf) == 0)
-		check_name(fd, &ss, name_buf);
+		check_name(fd, &ss, name_buf, sizeof name_buf);
 
 	return name_buf;
 }
 
 
 
@@ -207,24 +205,24 @@
  * Look up a name from @p ss into @p name_buf.
  *
  * @param fd file descriptor for client socket.
  **/
 int lookup_name(int fd, const struct sockaddr_storage *ss,
 		socklen_t ss_len,
-		char *name_buf, size_t name_buf_len,
-		char *port_buf, size_t port_buf_len)
+		char *name_buf, size_t name_buf_size,
+		char *port_buf, size_t port_buf_size)
 {
 	int name_err;
 
 	/* reverse lookup */
 	name_err = getnameinfo((struct sockaddr *) ss, ss_len,
-			       name_buf, name_buf_len,
-			       port_buf, port_buf_len,
+			       name_buf, name_buf_size,
+			       port_buf, port_buf_size,
 			       NI_NAMEREQD | NI_NUMERICSERV);
 	if (name_err != 0) {
-		strcpy(name_buf, default_name);
+		strlcpy(name_buf, default_name, name_buf_size);
 		rprintf(FLOG, "name lookup failed for %s: %s\n",
 			client_addr(fd), gai_strerror(name_err));
 		return name_err;
 	}
 
 	return 0;
@@ -299,13 +297,13 @@
  * We don't do anything with the service when checking the name,
  * because it doesn't seem that it could be spoofed in any way, and
  * getaddrinfo on random service names seems to cause problems on AIX.
  **/
 int check_name(int fd,
 	       const struct sockaddr_storage *ss,
-	       char *name_buf)
+	       char *name_buf, size_t name_buf_size)
 {
 	struct addrinfo hints, *res, *res0;
 	int error;
 	int ss_family = get_sockaddr_family(ss);
 
 	memset(&hints, 0, sizeof hints);
@@ -313,13 +311,13 @@
 	hints.ai_flags = AI_CANONNAME;
 	hints.ai_socktype = SOCK_STREAM;
 	error = getaddrinfo(name_buf, NULL, &hints, &res0);
 	if (error) {
 		rprintf(FLOG, "forward name lookup for %s failed: %s\n",
 			name_buf, gai_strerror(error));
-		strcpy(name_buf, default_name);
+		strlcpy(name_buf, default_name, name_buf_size);
 		return error;
 	}
 
 	/* Given all these results, we expect that one of them will be
 	 * the same as ss.  The comparison is a bit complicated. */
 	for (res = res0; res; res = res->ai_next) {
@@ -329,18 +327,18 @@
 
 	if (!res0) {
 		/* We hit the end of the list without finding an
 		 * address that was the same as ss. */
 		rprintf(FLOG, "no known address for \"%s\": "
 			"spoofed address?\n", name_buf);
-		strcpy(name_buf, default_name);
+		strlcpy(name_buf, default_name, name_buf_size);
 	} else if (res == NULL) {
 		/* We hit the end of the list without finding an
 		 * address that was the same as ss. */
 		rprintf(FLOG, "%s is not a known address for \"%s\": "
 			"spoofed address?\n", client_addr(fd), name_buf);
-		strcpy(name_buf, default_name);
+		strlcpy(name_buf, default_name, name_buf_size);
 	}
 
 	freeaddrinfo(res0);
 	return 0;
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/clientserver.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/clientserver.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/clientserver.c	2006-04-11 08:28:02.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/clientserver.c	2006-10-24 08:36:42.000000000 +0800
@@ -1,37 +1,33 @@
-/* -*- c-file-style: "linux"; -*-
+/*
+ * The socket based protocol for setting up a connection with rsyncd.
  *
- * Copyright (C) 1998-2001 by Andrew Tridgell <tridge@samba.org>
- * Copyright (C) 2001-2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1998-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 2001-2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2002, 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/**
- * @file
- *
- * The socket based protocol for setting up a connection with
- * rsyncd.
- **/
-
 #include "rsync.h"
 
 extern int verbose;
 extern int quiet;
+extern int output_motd;
 extern int list_only;
 extern int am_sender;
 extern int am_server;
 extern int am_daemon;
 extern int am_root;
 extern int rsync_port;
@@ -41,25 +37,26 @@
 extern int filesfrom_fd;
 extern int remote_protocol;
 extern int protocol_version;
 extern int io_timeout;
 extern int no_detach;
 extern int default_af_hint;
+extern int logfile_format_has_i;
+extern int logfile_format_has_o_or_i;
 extern mode_t orig_umask;
 extern char *bind_address;
 extern char *sockopts;
 extern char *config_file;
+extern char *logfile_format;
 extern char *files_from;
 extern char *tmpdir;
 extern struct chmod_mode_struct *chmod_modes;
 extern struct filter_list_struct server_filter_list;
 
 char *auth_user;
 int read_only = 0;
-int daemon_log_format_has_i = 0;
-int daemon_log_format_has_o_or_i = 0;
 int module_id = -1;
 struct chmod_mode_struct *daemon_chmod_modes;
 
 /* Length of lp_path() string when in daemon mode & not chrooted, else 0. */
 unsigned int module_dirlen = 0;
 
@@ -110,13 +107,13 @@
 
 	ret = start_inband_exchange(user, path, fd, fd, argc);
 
 	return ret ? ret : client_run(fd, fd, -1, argc, argv);
 }
 
-int start_inband_exchange(char *user, char *path, int f_in, int f_out, 
+int start_inband_exchange(char *user, char *path, int f_in, int f_out,
 			  int argc)
 {
 	int i;
 	char *sargs[MAX_ARGS];
 	int sargc = 0;
 	char line[BIGPATHBUFLEN];
@@ -206,13 +203,16 @@
 			rprintf(FERROR, "%s\n", line);
 			/* This is always fatal; the server will now
 			 * close the socket. */
 			return -1;
 		}
 
-		rprintf(FINFO, "%s\n", line);
+		/* This might be a MOTD line or a module listing, but there is
+		 * no way to differentiate it.  The manpage mentions this. */
+		if (output_motd)
+			rprintf(FINFO, "%s\n", line);
 	}
 	kluge_around_eof = 0;
 
 	for (i = 0; i < sargc; i++) {
 		io_printf(f_out, "%s\n", sargs[i]);
 	}
@@ -325,19 +325,18 @@
 
 	module_id = i;
 
 	if (lp_read_only(i))
 		read_only = 1;
 
-	if (lp_transfer_logging(i)) {
-		if (log_format_has(lp_log_format(i), 'i'))
-			daemon_log_format_has_i = 1;
-		if (daemon_log_format_has_i
-		    || log_format_has(lp_log_format(i), 'o'))
-			daemon_log_format_has_o_or_i = 1;
-	}
+	if (lp_transfer_logging(i) && !logfile_format)
+		logfile_format = lp_log_format(i);
+	if (log_format_has(logfile_format, 'i'))
+		logfile_format_has_i = 1;
+	if (logfile_format_has_i || log_format_has(logfile_format, 'o'))
+		logfile_format_has_o_or_i = 1;
 
 	am_root = (MY_UID() == 0);
 
 	if (am_root) {
 		p = lp_uid(i);
 		if (!name_to_uid(p, &uid)) {
@@ -391,13 +390,13 @@
 	    XFLG_ABS_IF_SLASH | XFLG_OLD_PREFIXES | XFLG_FATAL_ERRORS);
 
 	p = lp_exclude(i);
 	parse_rule(&server_filter_list, p, MATCHFLG_WORD_SPLIT,
 		   XFLG_ABS_IF_SLASH | XFLG_OLD_PREFIXES);
 
-	log_init();
+	log_init(1);
 
 #ifdef HAVE_PUTENV
 	if (*lp_prexfer_exec(i) || *lp_postxfer_exec(i)) {
 		char *modname, *modpath, *hostaddr, *hostname, *username;
 		int status;
 		if (asprintf(&modname, "RSYNC_MODULE_NAME=%s", name) < 0
@@ -420,32 +419,35 @@
 			if (pid < 0) {
 				rsyserr(FLOG, errno, "fork failed");
 				io_printf(f_out, "@ERROR: fork failed\n");
 				return -1;
 			}
 			if (pid) {
-				char *ret1, *ret2;
+				if (asprintf(&p, "RSYNC_PID=%ld", (long)pid) > 0)
+					putenv(p);
 				if (wait_process(pid, &status, 0) < 0)
 					status = -1;
-				if (asprintf(&ret1, "RSYNC_RAW_STATUS=%d", status) > 0)
-					putenv(ret1);
+				if (asprintf(&p, "RSYNC_RAW_STATUS=%d", status) > 0)
+					putenv(p);
 				if (WIFEXITED(status))
 					status = WEXITSTATUS(status);
 				else
 					status = -1;
-				if (asprintf(&ret2, "RSYNC_EXIT_STATUS=%d", status) > 0)
-					putenv(ret2);
+				if (asprintf(&p, "RSYNC_EXIT_STATUS=%d", status) > 0)
+					putenv(p);
 				system(lp_postxfer_exec(i));
 				_exit(status);
 			}
 		}
 		/* For pre-xfer exec, fork a child process to run the indicated
 		 * command, though it first waits for the parent process to
 		 * send us the user's request via a pipe. */
 		if (*lp_prexfer_exec(i)) {
 			int fds[2];
+			if (asprintf(&p, "RSYNC_PID=%ld", (long)getpid()) > 0)
+				putenv(p);
 			if (pipe(fds) < 0 || (pre_exec_pid = fork()) < 0) {
 				rsyserr(FLOG, errno, "pre-xfer exec preparation failed");
 				io_printf(f_out, "@ERROR: pre-xfer exec preparation failed\n");
 				return -1;
 			}
 			if (pre_exec_pid == 0) {
@@ -453,26 +455,24 @@
 				int j, len;
 				close(fds[1]);
 				set_blocking(fds[0]);
 				len = read_arg_from_pipe(fds[0], buf, BIGPATHBUFLEN);
 				if (len <= 0)
 					_exit(1);
-				if (asprintf(&p, "RSYNC_REQUEST=%s", buf) < 0)
-					out_of_memory("rsync_module");
-				putenv(p);
+				if (asprintf(&p, "RSYNC_REQUEST=%s", buf) > 0)
+					putenv(p);
 				for (j = 0; ; j++) {
 					len = read_arg_from_pipe(fds[0], buf,
 								 BIGPATHBUFLEN);
 					if (len <= 0) {
 						if (!len)
 							break;
 						_exit(1);
 					}
-					if (asprintf(&p, "RSYNC_ARG%d=%s", j, buf) < 0)
-						out_of_memory("rsync_module");
-					putenv(p);
+					if (asprintf(&p, "RSYNC_ARG%d=%s", j, buf) > 0)
+						putenv(p);
 				}
 				close(fds[0]);
 				close(STDIN_FILENO);
 				close(STDOUT_FILENO);
 				status = system(lp_prexfer_exec(i));
 				if (!WIFEXITED(status))
@@ -504,21 +504,21 @@
 			rsyserr(FLOG, errno, "chroot %s failed",
 				lp_path(i));
 			io_printf(f_out, "@ERROR: chroot failed\n");
 			return -1;
 		}
 
-		if (!push_dir("/")) {
+		if (!push_dir("/", 0)) {
 			rsyserr(FLOG, errno, "chdir %s failed\n",
 				lp_path(i));
 			io_printf(f_out, "@ERROR: chdir failed\n");
 			return -1;
 		}
 
 	} else {
-		if (!push_dir(lp_path(i))) {
+		if (!push_dir(lp_path(i), 0)) {
 			rsyserr(FLOG, errno, "chdir %s failed\n",
 				lp_path(i));
 			io_printf(f_out, "@ERROR: chdir failed\n");
 			return -1;
 		}
 		sanitize_paths = 1;
@@ -838,13 +838,13 @@
 
 	if (rsync_port == 0 && (rsync_port = lp_rsync_port()) == 0)
 		rsync_port = RSYNC_PORT;
 	if (bind_address == NULL && *lp_bind_address())
 		bind_address = lp_bind_address();
 
-	log_init();
+	log_init(0);
 
 	rprintf(FLOG, "rsyncd version %s starting, listening on port %d\n",
 		RSYNC_VERSION, rsync_port);
 	/* TODO: If listening on a particular address, then show that
 	 * address too.  In fact, why not just do inet_ntop on the
 	 * local address??? */
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/compat.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/compat.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/compat.c	2006-02-25 00:43:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/compat.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,30 +1,27 @@
-/* 
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/**
- * @file compat.c
- *
+/*
  * Compatibility routines for older rsync protocol versions.
- **/
+ *
+ * Copyright (C) Andrew Tridgell 1996
+ * Copyright (C) Paul Mackerras 1996
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 int remote_protocol = 0;
 
 extern int verbose;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.guess /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.guess
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.guess	2004-03-06 15:00:47.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.guess	2006-11-02 10:01:25.000000000 +0800
@@ -1,12 +1,13 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
 #   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003 Free Software Foundation, Inc.
+#   2000, 2001, 2002, 2003, 2004, 2005, 2006 Free Software Foundation,
+#   Inc.
 
-timestamp='2003-10-03'
+timestamp='2006-07-02'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
 # the Free Software Foundation; either version 2 of the License, or
 # (at your option) any later version.
 #
@@ -14,13 +15,14 @@
 # WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 # General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
+# 02110-1301, USA.
 #
 # As a special exception to the GNU General Public License, if you
 # distribute this file as part of a program that contains a
 # configuration script generated by Autoconf, you may include it under
 # the same distribution terms that you use for the rest of that program.
 
@@ -50,30 +53,30 @@
 Report bugs and patches to <config-patches@gnu.org>."
 
 version="\
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005
 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
 
 help="
 Try \`$me --help' for more information."
 
 # Parse command line
 while test $# -gt 0 ; do
   case $1 in
     --time-stamp | --time* | -t )
-       echo "$timestamp" ; exit 0 ;;
+       echo "$timestamp" ; exit ;;
     --version | -v )
-       echo "$version" ; exit 0 ;;
+       echo "$version" ; exit ;;
     --help | --h* | -h )
-       echo "$usage"; exit 0 ;;
+       echo "$usage"; exit ;;
     -- )     # Stop option processing
        shift; break ;;
     - )	# Use stdin as input.
        break ;;
     -* )
        echo "$me: invalid option $1$help" >&2
@@ -101,13 +104,13 @@
 # Portable tmp directory creation inspired by the Autoconf team.
 
 set_cc_for_build='
 trap "exitcode=\$?; (rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null) && exit \$exitcode" 0 ;
 trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" 1 2 13 15 ;
 : ${TMPDIR=/tmp} ;
- { tmp=`(umask 077 && mktemp -d -q "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
+ { tmp=`(umask 077 && mktemp -d "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
  { test -n "$RANDOM" && tmp=$TMPDIR/cg$$-$RANDOM && (umask 077 && mkdir $tmp) ; } ||
  { tmp=$TMPDIR/cg-$$ && (umask 077 && mkdir $tmp) && echo "Warning: creating insecure temp directory" >&2 ; } ||
  { echo "$me: cannot create a temporary directory in $TMPDIR" >&2 ; exit 1 ; } ;
 dummy=$tmp/dummy ;
 tmpfiles="$dummy.c $dummy.o $dummy.rel $dummy" ;
 case $CC_FOR_BUILD,$HOST_CC,$CC in
@@ -120,13 +123,13 @@
 	if test x"$CC_FOR_BUILD" = x ; then
 	  CC_FOR_BUILD=no_compiler_found ;
 	fi
 	;;
  ,,*)   CC_FOR_BUILD=$CC ;;
  ,*,*)  CC_FOR_BUILD=$HOST_CC ;;
-esac ;'
+esac ; set_cc_for_build= ;'
 
 # This is needed to find uname on a Pyramid OSx when run in the BSD universe.
 # (ghazi@noc.rutgers.edu 1994-08-24)
 if (test -f /.attbin/uname) >/dev/null 2>&1 ; then
 	PATH=$PATH:/.attbin ; export PATH
 fi
@@ -193,56 +196,38 @@
 		;;
 	esac
 	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
 	# contains redundant information, the shorter form:
 	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
 	echo "${machine}-${os}${release}"
-	exit 0 ;;
-    amiga:OpenBSD:*:*)
-	echo m68k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    arc:OpenBSD:*:*)
-	echo mipsel-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    hp300:OpenBSD:*:*)
-	echo m68k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    mac68k:OpenBSD:*:*)
-	echo m68k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    macppc:OpenBSD:*:*)
-	echo powerpc-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    mvme68k:OpenBSD:*:*)
-	echo m68k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    mvme88k:OpenBSD:*:*)
-	echo m88k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    mvmeppc:OpenBSD:*:*)
-	echo powerpc-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    pmax:OpenBSD:*:*)
-	echo mipsel-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    sgi:OpenBSD:*:*)
-	echo mipseb-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    sun3:OpenBSD:*:*)
-	echo m68k-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
-    wgrisc:OpenBSD:*:*)
-	echo mipsel-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:OpenBSD:*:*)
-	echo ${UNAME_MACHINE}-unknown-openbsd${UNAME_RELEASE}
-	exit 0 ;;
+	UNAME_MACHINE_ARCH=`arch | sed 's/OpenBSD.//'`
+	echo ${UNAME_MACHINE_ARCH}-unknown-openbsd${UNAME_RELEASE}
+	exit ;;
+    *:ekkoBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-ekkobsd${UNAME_RELEASE}
+	exit ;;
+    *:SolidBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-solidbsd${UNAME_RELEASE}
+	exit ;;
+    macppc:MirBSD:*:*)
+	echo powerpc-unknown-mirbsd${UNAME_RELEASE}
+	exit ;;
+    *:MirBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-mirbsd${UNAME_RELEASE}
+	exit ;;
     alpha:OSF1:*:*)
-	if test $UNAME_RELEASE = "V4.0"; then
+	case $UNAME_RELEASE in
+	*4.0)
 		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
-	fi
+		;;
+	*5.*)
+	        UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
+		;;
+	esac
 	# According to Compaq, /usr/sbin/psrinfo has been available on
 	# OSF/1 and Tru64 systems produced since 1995.  I hope that
 	# covers most systems running today.  This code pipes the CPU
 	# types through head -n 1, so we only detect the type of CPU 0.
 	ALPHA_CPU_TYPE=`/usr/sbin/psrinfo -v | sed -n -e 's/^  The alpha \(.*\) processor.*$/\1/p' | head -n 1`
 	case "$ALPHA_CPU_TYPE" in
@@ -274,149 +259,159 @@
 		UNAME_MACHINE="alphaev69" ;;
 	    "EV7 (21364)")
 		UNAME_MACHINE="alphaev7" ;;
 	    "EV7.9 (21364A)")
 		UNAME_MACHINE="alphaev79" ;;
 	esac
+	# A Pn.n version is a patched version.
 	# A Vn.n version is a released version.
 	# A Tn.n version is a released field test version.
 	# A Xn.n version is an unreleased experimental baselevel.
 	# 1.2 uses "1.2" for uname -r.
-	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[VTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
-	exit 0 ;;
-    Alpha*:OpenVMS:*:*)
-	echo alpha-hp-vms
-	exit 0 ;;
+	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[PVTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+	exit ;;
     Alpha\ *:Windows_NT*:*)
 	# How do we know it's Interix rather than the generic POSIX subsystem?
 	# Should we change UNAME_MACHINE based on the output of uname instead
 	# of the specific Alpha model?
 	echo alpha-pc-interix
-	exit 0 ;;
+	exit ;;
     21064:Windows_NT:50:3)
 	echo alpha-dec-winnt3.5
-	exit 0 ;;
+	exit ;;
     Amiga*:UNIX_System_V:4.0:*)
 	echo m68k-unknown-sysv4
-	exit 0;;
+	exit ;;
     *:[Aa]miga[Oo][Ss]:*:*)
 	echo ${UNAME_MACHINE}-unknown-amigaos
-	exit 0 ;;
+	exit ;;
     *:[Mm]orph[Oo][Ss]:*:*)
 	echo ${UNAME_MACHINE}-unknown-morphos
-	exit 0 ;;
+	exit ;;
     *:OS/390:*:*)
 	echo i370-ibm-openedition
-	exit 0 ;;
+	exit ;;
+    *:z/VM:*:*)
+	echo s390-ibm-zvmoe
+	exit ;;
+    *:OS400:*:*)
+        echo powerpc-ibm-os400
+	exit ;;
     arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
 	echo arm-acorn-riscix${UNAME_RELEASE}
-	exit 0;;
+	exit ;;
+    arm:riscos:*:*|arm:RISCOS:*:*)
+	echo arm-unknown-riscos
+	exit ;;
     SR2?01:HI-UX/MPP:*:* | SR8000:HI-UX/MPP:*:*)
 	echo hppa1.1-hitachi-hiuxmpp
-	exit 0;;
+	exit ;;
     Pyramid*:OSx*:*:* | MIS*:OSx*:*:* | MIS*:SMP_DC-OSx*:*:*)
 	# akee@wpdis03.wpafb.af.mil (Earle F. Ake) contributed MIS and NILE.
 	if test "`(/bin/universe) 2>/dev/null`" = att ; then
 		echo pyramid-pyramid-sysv3
 	else
 		echo pyramid-pyramid-bsd
 	fi
-	exit 0 ;;
+	exit ;;
     NILE*:*:*:dcosx)
 	echo pyramid-pyramid-svr4
-	exit 0 ;;
+	exit ;;
     DRS?6000:unix:4.0:6*)
 	echo sparc-icl-nx6
-	exit 0 ;;
-    DRS?6000:UNIX_SV:4.2*:7*)
+	exit ;;
+    DRS?6000:UNIX_SV:4.2*:7* | DRS?6000:isis:4.2*:7*)
 	case `/usr/bin/uname -p` in
-	    sparc) echo sparc-icl-nx7 && exit 0 ;;
+	    sparc) echo sparc-icl-nx7; exit ;;
 	esac ;;
     sun4H:SunOS:5.*:*)
 	echo sparc-hal-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit 0 ;;
+	exit ;;
     sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
 	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit 0 ;;
+	exit ;;
     i86pc:SunOS:5.*:*)
 	echo i386-pc-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit 0 ;;
+	exit ;;
     sun4*:SunOS:6*:*)
 	# According to config.sub, this is the proper way to canonicalize
 	# SunOS6.  Hard to guess exactly what SunOS6 will be like, but
 	# it's likely to be more like Solaris than SunOS4.
 	echo sparc-sun-solaris3`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit 0 ;;
+	exit ;;
     sun4*:SunOS:*:*)
 	case "`/usr/bin/arch -k`" in
 	    Series*|S4*)
 		UNAME_RELEASE=`uname -v`
 		;;
 	esac
 	# Japanese Language versions have a version number like `4.1.3-JL'.
 	echo sparc-sun-sunos`echo ${UNAME_RELEASE}|sed -e 's/-/_/'`
-	exit 0 ;;
+	exit ;;
     sun3*:SunOS:*:*)
 	echo m68k-sun-sunos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     sun*:*:4.2BSD:*)
 	UNAME_RELEASE=`(sed 1q /etc/motd | awk '{print substr($5,1,3)}') 2>/dev/null`
 	test "x${UNAME_RELEASE}" = "x" && UNAME_RELEASE=3
 	case "`/bin/arch`" in
 	    sun3)
 		echo m68k-sun-sunos${UNAME_RELEASE}
 		;;
 	    sun4)
 		echo sparc-sun-sunos${UNAME_RELEASE}
 		;;
 	esac
-	exit 0 ;;
+	exit ;;
     aushp:SunOS:*:*)
 	echo sparc-auspex-sunos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     # The situation for MiNT is a little confusing.  The machine name
     # can be virtually everything (everything which is not
     # "atarist" or "atariste" at least should have a processor
     # > m68000).  The system name ranges from "MiNT" over "FreeMiNT"
     # to the lowercase version "mint" (or "freemint").  Finally
     # the system name "TOS" denotes a system which is actually not
     # MiNT.  But MiNT is downward compatible to TOS, so this should
     # be no problem.
     atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
         echo m68k-atari-mint${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
 	echo m68k-atari-mint${UNAME_RELEASE}
-        exit 0 ;;
+        exit ;;
     *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
         echo m68k-atari-mint${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
         echo m68k-milan-mint${UNAME_RELEASE}
-        exit 0 ;;
+        exit ;;
     hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
         echo m68k-hades-mint${UNAME_RELEASE}
-        exit 0 ;;
+        exit ;;
     *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
         echo m68k-unknown-mint${UNAME_RELEASE}
-        exit 0 ;;
+        exit ;;
+    m68k:machten:*:*)
+	echo m68k-apple-machten${UNAME_RELEASE}
+	exit ;;
     powerpc:machten:*:*)
 	echo powerpc-apple-machten${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     RISC*:Mach:*:*)
 	echo mips-dec-mach_bsd4.3
-	exit 0 ;;
+	exit ;;
     RISC*:ULTRIX:*:*)
 	echo mips-dec-ultrix${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     VAX*:ULTRIX*:*:*)
 	echo vax-dec-ultrix${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     2020:CLIX:*:* | 2430:CLIX:*:*)
 	echo clipper-intergraph-clix${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     mips:*:*:UMIPS | mips:*:*:RISCos)
 	eval $set_cc_for_build
 	sed 's/^	//' << EOF >$dummy.c
 #ifdef __cplusplus
 #include <stdio.h>  /* for printf() prototype */
 	int main (int argc, char *argv[]) {
@@ -434,38 +429,39 @@
 	  printf ("mips-mips-riscos%sbsd\n", argv[1]); exit (0);
 	#endif
 	#endif
 	  exit (-1);
 	}
 EOF
-	$CC_FOR_BUILD -o $dummy $dummy.c \
-	  && $dummy `echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` \
-	  && exit 0
+	$CC_FOR_BUILD -o $dummy $dummy.c &&
+	  dummyarg=`echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` &&
+	  SYSTEM_NAME=`$dummy $dummyarg` &&
+	    { echo "$SYSTEM_NAME"; exit; }
 	echo mips-mips-riscos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     Motorola:PowerMAX_OS:*:*)
 	echo powerpc-motorola-powermax
-	exit 0 ;;
+	exit ;;
     Motorola:*:4.3:PL8-*)
 	echo powerpc-harris-powermax
-	exit 0 ;;
+	exit ;;
     Night_Hawk:*:*:PowerMAX_OS | Synergy:PowerMAX_OS:*:*)
 	echo powerpc-harris-powermax
-	exit 0 ;;
+	exit ;;
     Night_Hawk:Power_UNIX:*:*)
 	echo powerpc-harris-powerunix
-	exit 0 ;;
+	exit ;;
     m88k:CX/UX:7*:*)
 	echo m88k-harris-cxux7
-	exit 0 ;;
+	exit ;;
     m88k:*:4*:R4*)
 	echo m88k-motorola-sysv4
-	exit 0 ;;
+	exit ;;
     m88k:*:3*:R3*)
 	echo m88k-motorola-sysv3
-	exit 0 ;;
+	exit ;;
     AViiON:dgux:*:*)
         # DG/UX returns AViiON for all architectures
         UNAME_PROCESSOR=`/usr/bin/uname -p`
 	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
 	then
 	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
@@ -475,43 +471,43 @@
 	    else
 		echo m88k-dg-dguxbcs${UNAME_RELEASE}
 	    fi
 	else
 	    echo i586-dg-dgux${UNAME_RELEASE}
 	fi
- 	exit 0 ;;
+ 	exit ;;
     M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
 	echo m88k-dolphin-sysv3
-	exit 0 ;;
+	exit ;;
     M88*:*:R3*:*)
 	# Delta 88k system running SVR3
 	echo m88k-motorola-sysv3
-	exit 0 ;;
+	exit ;;
     XD88*:*:*:*) # Tektronix XD88 system running UTekV (SVR3)
 	echo m88k-tektronix-sysv3
-	exit 0 ;;
+	exit ;;
     Tek43[0-9][0-9]:UTek:*:*) # Tektronix 4300 system running UTek (BSD)
 	echo m68k-tektronix-bsd
-	exit 0 ;;
+	exit ;;
     *:IRIX*:*:*)
 	echo mips-sgi-irix`echo ${UNAME_RELEASE}|sed -e 's/-/_/g'`
-	exit 0 ;;
+	exit ;;
     ????????:AIX?:[12].1:2)   # AIX 2.2.1 or AIX 2.1.1 is RT/PC AIX.
-	echo romp-ibm-aix      # uname -m gives an 8 hex-code CPU id
-	exit 0 ;;              # Note that: echo "'`uname -s`'" gives 'AIX '
+	echo romp-ibm-aix     # uname -m gives an 8 hex-code CPU id
+	exit ;;               # Note that: echo "'`uname -s`'" gives 'AIX '
     i*86:AIX:*:*)
 	echo i386-ibm-aix
-	exit 0 ;;
+	exit ;;
     ia64:AIX:*:*)
 	if [ -x /usr/bin/oslevel ] ; then
 		IBM_REV=`/usr/bin/oslevel`
 	else
 		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
 	fi
 	echo ${UNAME_MACHINE}-ibm-aix${IBM_REV}
-	exit 0 ;;
+	exit ;;
     *:AIX:2:3)
 	if grep bos325 /usr/include/stdio.h >/dev/null 2>&1; then
 		eval $set_cc_for_build
 		sed 's/^		//' << EOF >$dummy.c
 		#include <sys/systemcfg.h>
 
@@ -520,20 +516,24 @@
 			if (!__power_pc())
 				exit(1);
 			puts("powerpc-ibm-aix3.2.5");
 			exit(0);
 			}
 EOF
-		$CC_FOR_BUILD -o $dummy $dummy.c && $dummy && exit 0
-		echo rs6000-ibm-aix3.2.5
+		if $CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy`
+		then
+			echo "$SYSTEM_NAME"
+		else
+			echo rs6000-ibm-aix3.2.5
+		fi
 	elif grep bos324 /usr/include/stdio.h >/dev/null 2>&1; then
 		echo rs6000-ibm-aix3.2.4
 	else
 		echo rs6000-ibm-aix3.2
 	fi
-	exit 0 ;;
+	exit ;;
     *:AIX:*:[45])
 	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
 	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
 		IBM_ARCH=rs6000
 	else
 		IBM_ARCH=powerpc
@@ -541,34 +541,34 @@
 	if [ -x /usr/bin/oslevel ] ; then
 		IBM_REV=`/usr/bin/oslevel`
 	else
 		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
 	fi
 	echo ${IBM_ARCH}-ibm-aix${IBM_REV}
-	exit 0 ;;
+	exit ;;
     *:AIX:*:*)
 	echo rs6000-ibm-aix
-	exit 0 ;;
+	exit ;;
     ibmrt:4.4BSD:*|romp-ibm:BSD:*)
 	echo romp-ibm-bsd4.4
-	exit 0 ;;
+	exit ;;
     ibmrt:*BSD:*|romp-ibm:BSD:*)            # covers RT/PC BSD and
 	echo romp-ibm-bsd${UNAME_RELEASE}   # 4.3 with uname added to
-	exit 0 ;;                           # report: romp-ibm BSD 4.3
+	exit ;;                             # report: romp-ibm BSD 4.3
     *:BOSX:*:*)
 	echo rs6000-bull-bosx
-	exit 0 ;;
+	exit ;;
     DPX/2?00:B.O.S.:*:*)
 	echo m68k-bull-sysv3
-	exit 0 ;;
+	exit ;;
     9000/[34]??:4.3bsd:1.*:*)
 	echo m68k-hp-bsd
-	exit 0 ;;
+	exit ;;
     hp300:4.4BSD:*:* | 9000/[34]??:4.3bsd:2.*:*)
 	echo m68k-hp-bsd4.4
-	exit 0 ;;
+	exit ;;
     9000/[34678]??:HP-UX:*:*)
 	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
 	case "${UNAME_MACHINE}" in
 	    9000/31? )            HP_ARCH=m68000 ;;
 	    9000/[34]?? )         HP_ARCH=m68k ;;
 	    9000/[678][0-9][0-9])
@@ -624,27 +624,37 @@
 		    (CCOPTS= $CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null) && HP_ARCH=`$dummy`
 		    test -z "$HP_ARCH" && HP_ARCH=hppa
 		fi ;;
 	esac
 	if [ ${HP_ARCH} = "hppa2.0w" ]
 	then
-	    # avoid double evaluation of $set_cc_for_build
-	    test -n "$CC_FOR_BUILD" || eval $set_cc_for_build
-	    if echo __LP64__ | (CCOPTS= $CC_FOR_BUILD -E -) | grep __LP64__ >/dev/null
+	    eval $set_cc_for_build
+
+	    # hppa2.0w-hp-hpux* has a 64-bit kernel and a compiler generating
+	    # 32-bit code.  hppa64-hp-hpux* has the same kernel and a compiler
+	    # generating 64-bit code.  GNU and HP use different nomenclature:
+	    #
+	    # $ CC_FOR_BUILD=cc ./config.guess
+	    # => hppa2.0w-hp-hpux11.23
+	    # $ CC_FOR_BUILD="cc +DA2.0w" ./config.guess
+	    # => hppa64-hp-hpux11.23
+
+	    if echo __LP64__ | (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) |
+		grep __LP64__ >/dev/null
 	    then
 		HP_ARCH="hppa2.0w"
 	    else
 		HP_ARCH="hppa64"
 	    fi
 	fi
 	echo ${HP_ARCH}-hp-hpux${HPUX_REV}
-	exit 0 ;;
+	exit ;;
     ia64:HP-UX:*:*)
 	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
 	echo ia64-hp-hpux${HPUX_REV}
-	exit 0 ;;
+	exit ;;
     3050*:HI-UX:*:*)
 	eval $set_cc_for_build
 	sed 's/^	//' << EOF >$dummy.c
 	#include <unistd.h>
 	int
 	main ()
@@ -666,159 +676,185 @@
 	  else if (CPU_IS_HP_MC68K (cpu))
 	    puts ("m68k-hitachi-hiuxwe2");
 	  else puts ("unknown-hitachi-hiuxwe2");
 	  exit (0);
 	}
 EOF
-	$CC_FOR_BUILD -o $dummy $dummy.c && $dummy && exit 0
+	$CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy` &&
+		{ echo "$SYSTEM_NAME"; exit; }
 	echo unknown-hitachi-hiuxwe2
-	exit 0 ;;
+	exit ;;
     9000/7??:4.3bsd:*:* | 9000/8?[79]:4.3bsd:*:* )
 	echo hppa1.1-hp-bsd
-	exit 0 ;;
+	exit ;;
     9000/8??:4.3bsd:*:*)
 	echo hppa1.0-hp-bsd
-	exit 0 ;;
+	exit ;;
     *9??*:MPE/iX:*:* | *3000*:MPE/iX:*:*)
 	echo hppa1.0-hp-mpeix
-	exit 0 ;;
+	exit ;;
     hp7??:OSF1:*:* | hp8?[79]:OSF1:*:* )
 	echo hppa1.1-hp-osf
-	exit 0 ;;
+	exit ;;
     hp8??:OSF1:*:*)
 	echo hppa1.0-hp-osf
-	exit 0 ;;
+	exit ;;
     i*86:OSF1:*:*)
 	if [ -x /usr/sbin/sysversion ] ; then
 	    echo ${UNAME_MACHINE}-unknown-osf1mk
 	else
 	    echo ${UNAME_MACHINE}-unknown-osf1
 	fi
-	exit 0 ;;
+	exit ;;
     parisc*:Lites*:*:*)
 	echo hppa1.1-hp-lites
-	exit 0 ;;
+	exit ;;
     C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
 	echo c1-convex-bsd
-        exit 0 ;;
+        exit ;;
     C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
 	if getsysinfo -f scalar_acc
 	then echo c32-convex-bsd
 	else echo c2-convex-bsd
 	fi
-        exit 0 ;;
+        exit ;;
     C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
 	echo c34-convex-bsd
-        exit 0 ;;
+        exit ;;
     C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
 	echo c38-convex-bsd
-        exit 0 ;;
+        exit ;;
     C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
 	echo c4-convex-bsd
-        exit 0 ;;
+        exit ;;
     CRAY*Y-MP:*:*:*)
 	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	exit ;;
     CRAY*[A-Z]90:*:*:*)
 	echo ${UNAME_MACHINE}-cray-unicos${UNAME_RELEASE} \
 	| sed -e 's/CRAY.*\([A-Z]90\)/\1/' \
 	      -e y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/ \
 	      -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	exit ;;
     CRAY*TS:*:*:*)
 	echo t90-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	exit ;;
     CRAY*T3E:*:*:*)
 	echo alphaev5-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	exit ;;
     CRAY*SV1:*:*:*)
 	echo sv1-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	exit ;;
     *:UNICOS/mp:*:*)
-	echo nv1-cray-unicosmp${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit 0 ;;
+	echo craynv-cray-unicosmp${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit ;;
     F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
 	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
         FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
         FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
         echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
-        exit 0 ;;
+        exit ;;
+    5000:UNIX_System_V:4.*:*)
+        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+        FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
+        echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+	exit ;;
     i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
 	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     sparc*:BSD/OS:*:*)
 	echo sparc-unknown-bsdi${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:BSD/OS:*:*)
 	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
-	exit 0 ;;
-    *:FreeBSD:*:*|*:GNU/FreeBSD:*:*)
-	# Determine whether the default compiler uses glibc.
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#include <features.h>
-	#if __GLIBC__ >= 2
-	LIBC=gnu
-	#else
-	LIBC=
-	#endif
-EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^LIBC=`
-	# GNU/FreeBSD systems have a "k" prefix to indicate we are using
-	# FreeBSD's kernel, but not the complete OS.
-	case ${LIBC} in gnu) kernel_only='k' ;; esac
-	echo ${UNAME_MACHINE}-unknown-${kernel_only}freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`${LIBC:+-$LIBC}
-	exit 0 ;;
+	exit ;;
+    *:FreeBSD:*:*)
+	case ${UNAME_MACHINE} in
+	    pc98)
+		echo i386-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+	    amd64)
+		echo x86_64-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+	    *)
+		echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+	esac
+	exit ;;
     i*:CYGWIN*:*)
 	echo ${UNAME_MACHINE}-pc-cygwin
-	exit 0 ;;
+	exit ;;
     i*:MINGW*:*)
 	echo ${UNAME_MACHINE}-pc-mingw32
-	exit 0 ;;
+	exit ;;
+    i*:windows32*:*)
+    	# uname -m includes "-pc" on this system.
+    	echo ${UNAME_MACHINE}-mingw32
+	exit ;;
     i*:PW*:*)
 	echo ${UNAME_MACHINE}-pc-pw32
-	exit 0 ;;
-    x86:Interix*:[34]*)
-	echo i586-pc-interix${UNAME_RELEASE}|sed -e 's/\..*//'
-	exit 0 ;;
+	exit ;;
+    x86:Interix*:[3456]*)
+	echo i586-pc-interix${UNAME_RELEASE}
+	exit ;;
+    EM64T:Interix*:[3456]*)
+	echo x86_64-unknown-interix${UNAME_RELEASE}
+	exit ;;
     [345]86:Windows_95:* | [345]86:Windows_98:* | [345]86:Windows_NT:*)
 	echo i${UNAME_MACHINE}-pc-mks
-	exit 0 ;;
+	exit ;;
     i*:Windows_NT*:* | Pentium*:Windows_NT*:*)
 	# How do we know it's Interix rather than the generic POSIX subsystem?
 	# It also conflicts with pre-2.0 versions of AT&T UWIN. Should we
 	# UNAME_MACHINE based on the output of uname instead of i386?
 	echo i586-pc-interix
-	exit 0 ;;
+	exit ;;
     i*:UWIN*:*)
 	echo ${UNAME_MACHINE}-pc-uwin
-	exit 0 ;;
+	exit ;;
+    amd64:CYGWIN*:*:* | x86_64:CYGWIN*:*:*)
+	echo x86_64-unknown-cygwin
+	exit ;;
     p*:CYGWIN*:*)
 	echo powerpcle-unknown-cygwin
-	exit 0 ;;
+	exit ;;
     prep*:SunOS:5.*:*)
 	echo powerpcle-unknown-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit 0 ;;
+	exit ;;
     *:GNU:*:*)
+	# the GNU system
 	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
-	exit 0 ;;
+	exit ;;
+    *:GNU/*:*:*)
+	# other systems with GNU libc and userland
+	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-gnu
+	exit ;;
     i*86:Minix:*:*)
 	echo ${UNAME_MACHINE}-pc-minix
-	exit 0 ;;
+	exit ;;
     arm*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
+    avr32*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
     cris:Linux:*:*)
 	echo cris-axis-linux-gnu
-	exit 0 ;;
+	exit ;;
+    crisv32:Linux:*:*)
+	echo crisv32-axis-linux-gnu
+	exit ;;
+    frv:Linux:*:*)
+    	echo frv-unknown-linux-gnu
+	exit ;;
     ia64:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
+    m32r*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
     m68*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     mips:Linux:*:*)
 	eval $set_cc_for_build
 	sed 's/^	//' << EOF >$dummy.c
 	#undef CPU
 	#undef mips
 	#undef mipsel
@@ -829,14 +865,18 @@
 	CPU=mips
 	#else
 	CPU=
 	#endif
 	#endif
 EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^CPU=`
-	test x"${CPU}" != x && echo "${CPU}-unknown-linux-gnu" && exit 0
+	eval "`$CC_FOR_BUILD -E $dummy.c 2>/dev/null | sed -n '
+	    /^CPU/{
+		s: ::g
+		p
+	    }'`"
+	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
 	;;
     mips64:Linux:*:*)
 	eval $set_cc_for_build
 	sed 's/^	//' << EOF >$dummy.c
 	#undef CPU
 	#undef mips64
@@ -848,21 +888,28 @@
 	CPU=mips64
 	#else
 	CPU=
 	#endif
 	#endif
 EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^CPU=`
-	test x"${CPU}" != x && echo "${CPU}-unknown-linux-gnu" && exit 0
+	eval "`$CC_FOR_BUILD -E $dummy.c 2>/dev/null | sed -n '
+	    /^CPU/{
+		s: ::g
+		p
+	    }'`"
+	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
 	;;
+    or32:Linux:*:*)
+	echo or32-unknown-linux-gnu
+	exit ;;
     ppc:Linux:*:*)
 	echo powerpc-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     ppc64:Linux:*:*)
 	echo powerpc64-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     alpha:Linux:*:*)
 	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
 	  EV5)   UNAME_MACHINE=alphaev5 ;;
 	  EV56)  UNAME_MACHINE=alphaev56 ;;
 	  PCA56) UNAME_MACHINE=alphapca56 ;;
 	  PCA57) UNAME_MACHINE=alphapca56 ;;
@@ -870,39 +917,42 @@
 	  EV67)  UNAME_MACHINE=alphaev67 ;;
 	  EV68*) UNAME_MACHINE=alphaev68 ;;
         esac
 	objdump --private-headers /bin/sh | grep ld.so.1 >/dev/null
 	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
 	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
-	exit 0 ;;
+	exit ;;
     parisc:Linux:*:* | hppa:Linux:*:*)
 	# Look for CPU level
 	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
 	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
 	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
 	  *)    echo hppa-unknown-linux-gnu ;;
 	esac
-	exit 0 ;;
+	exit ;;
     parisc64:Linux:*:* | hppa64:Linux:*:*)
 	echo hppa64-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     s390:Linux:*:* | s390x:Linux:*:*)
 	echo ${UNAME_MACHINE}-ibm-linux
-	exit 0 ;;
+	exit ;;
     sh64*:Linux:*:*)
     	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     sh*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     sparc:Linux:*:* | sparc64:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
+    vax:Linux:*:*)
+	echo ${UNAME_MACHINE}-dec-linux-gnu
+	exit ;;
     x86_64:Linux:*:*)
 	echo x86_64-unknown-linux-gnu
-	exit 0 ;;
+	exit ;;
     i*86:Linux:*:*)
 	# The BFD linker knows what the default object file format is, so
 	# first see if it will tell us. cd to the root directory to prevent
 	# problems with other programs or directories called `ld' in the path.
 	# Set LC_ALL=C to ensure ld outputs messages in English.
 	ld_supported_targets=`cd /; LC_ALL=C ld --help 2>&1 \
@@ -914,21 +964,21 @@
         case "$ld_supported_targets" in
 	  elf32-i386)
 		TENTATIVE="${UNAME_MACHINE}-pc-linux-gnu"
 		;;
 	  a.out-i386-linux)
 		echo "${UNAME_MACHINE}-pc-linux-gnuaout"
-		exit 0 ;;
+		exit ;;
 	  coff-i386)
 		echo "${UNAME_MACHINE}-pc-linux-gnucoff"
-		exit 0 ;;
+		exit ;;
 	  "")
 		# Either a pre-BFD a.out linker (linux-gnuoldld) or
 		# one that does not give us useful --help.
 		echo "${UNAME_MACHINE}-pc-linux-gnuoldld"
-		exit 0 ;;
+		exit ;;
 	esac
 	# Determine whether the default compiler is a.out or elf
 	eval $set_cc_for_build
 	sed 's/^	//' << EOF >$dummy.c
 	#include <features.h>
 	#ifdef __ELF__
@@ -939,73 +989,84 @@
 	LIBC=gnulibc1
 	#  endif
 	# else
 	LIBC=gnulibc1
 	# endif
 	#else
-	#ifdef __INTEL_COMPILER
+	#if defined(__INTEL_COMPILER) || defined(__PGI) || defined(__SUNPRO_C) || defined(__SUNPRO_CC)
 	LIBC=gnu
 	#else
 	LIBC=gnuaout
 	#endif
 	#endif
 	#ifdef __dietlibc__
 	LIBC=dietlibc
 	#endif
 EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^LIBC=`
-	test x"${LIBC}" != x && echo "${UNAME_MACHINE}-pc-linux-${LIBC}" && exit 0
-	test x"${TENTATIVE}" != x && echo "${TENTATIVE}" && exit 0
+	eval "`$CC_FOR_BUILD -E $dummy.c 2>/dev/null | sed -n '
+	    /^LIBC/{
+		s: ::g
+		p
+	    }'`"
+	test x"${LIBC}" != x && {
+		echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
+		exit
+	}
+	test x"${TENTATIVE}" != x && { echo "${TENTATIVE}"; exit; }
 	;;
     i*86:DYNIX/ptx:4*:*)
 	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
 	# earlier versions are messed up and put the nodename in both
 	# sysname and nodename.
 	echo i386-sequent-sysv4
-	exit 0 ;;
+	exit ;;
     i*86:UNIX_SV:4.2MP:2.*)
         # Unixware is an offshoot of SVR4, but it has its own version
         # number series starting with 2...
         # I am not positive that other SVR4 systems won't match this,
 	# I just have to hope.  -- rms.
         # Use sysv4.2uw... so that sysv4* matches it.
 	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
-	exit 0 ;;
+	exit ;;
     i*86:OS/2:*:*)
 	# If we were able to find `uname', then EMX Unix compatibility
 	# is probably installed.
 	echo ${UNAME_MACHINE}-pc-os2-emx
-	exit 0 ;;
+	exit ;;
     i*86:XTS-300:*:STOP)
 	echo ${UNAME_MACHINE}-unknown-stop
-	exit 0 ;;
+	exit ;;
     i*86:atheos:*:*)
 	echo ${UNAME_MACHINE}-unknown-atheos
-	exit 0 ;;
+	exit ;;
+    i*86:syllable:*:*)
+	echo ${UNAME_MACHINE}-pc-syllable
+	exit ;;
     i*86:LynxOS:2.*:* | i*86:LynxOS:3.[01]*:* | i*86:LynxOS:4.0*:*)
 	echo i386-unknown-lynxos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     i*86:*DOS:*:*)
 	echo ${UNAME_MACHINE}-pc-msdosdjgpp
-	exit 0 ;;
+	exit ;;
     i*86:*:4.*:* | i*86:SYSTEM_V:4.*:*)
 	UNAME_REL=`echo ${UNAME_RELEASE} | sed 's/\/MP$//'`
 	if grep Novell /usr/include/link.h >/dev/null 2>/dev/null; then
 		echo ${UNAME_MACHINE}-univel-sysv${UNAME_REL}
 	else
 		echo ${UNAME_MACHINE}-pc-sysv${UNAME_REL}
 	fi
-	exit 0 ;;
-    i*86:*:5:[78]*)
+	exit ;;
+    i*86:*:5:[678]*)
+    	# UnixWare 7.x, OpenUNIX and OpenServer 6.
 	case `/bin/uname -X | grep "^Machine"` in
 	    *486*)	     UNAME_MACHINE=i486 ;;
 	    *Pentium)	     UNAME_MACHINE=i586 ;;
 	    *Pent*|*Celeron) UNAME_MACHINE=i686 ;;
 	esac
 	echo ${UNAME_MACHINE}-unknown-sysv${UNAME_RELEASE}${UNAME_SYSTEM}${UNAME_VERSION}
-	exit 0 ;;
+	exit ;;
     i*86:*:3.2:*)
 	if test -f /usr/options/cb.name; then
 		UNAME_REL=`sed -n 's/.*Version //p' </usr/options/cb.name`
 		echo ${UNAME_MACHINE}-pc-isc$UNAME_REL
 	elif /bin/uname -X 2>/dev/null >/dev/null ; then
 		UNAME_REL=`(/bin/uname -X|grep Release|sed -e 's/.*= //')`
@@ -1017,203 +1078,229 @@
 		(/bin/uname -X|grep '^Machine.*Pentium Pro' >/dev/null) \
 			&& UNAME_MACHINE=i686
 		echo ${UNAME_MACHINE}-pc-sco$UNAME_REL
 	else
 		echo ${UNAME_MACHINE}-pc-sysv32
 	fi
-	exit 0 ;;
+	exit ;;
     pc:*:*:*)
 	# Left here for compatibility:
         # uname -m prints for DJGPP always 'pc', but it prints nothing about
         # the processor, so we play safe by assuming i386.
 	echo i386-pc-msdosdjgpp
-        exit 0 ;;
+        exit ;;
     Intel:Mach:3*:*)
 	echo i386-pc-mach3
-	exit 0 ;;
+	exit ;;
     paragon:*:*:*)
 	echo i860-intel-osf1
-	exit 0 ;;
+	exit ;;
     i860:*:4.*:*) # i860-SVR4
 	if grep Stardent /usr/include/sys/uadmin.h >/dev/null 2>&1 ; then
 	  echo i860-stardent-sysv${UNAME_RELEASE} # Stardent Vistra i860-SVR4
 	else # Add other i860-SVR4 vendors below as they are discovered.
 	  echo i860-unknown-sysv${UNAME_RELEASE}  # Unknown i860-SVR4
 	fi
-	exit 0 ;;
+	exit ;;
     mini*:CTIX:SYS*5:*)
 	# "miniframe"
 	echo m68010-convergent-sysv
-	exit 0 ;;
+	exit ;;
     mc68k:UNIX:SYSTEM5:3.51m)
 	echo m68k-convergent-sysv
-	exit 0 ;;
+	exit ;;
     M680?0:D-NIX:5.3:*)
 	echo m68k-diab-dnix
-	exit 0 ;;
-    M68*:*:R3V[567]*:*)
-	test -r /sysV68 && echo 'm68k-motorola-sysv' && exit 0 ;;
-    3[34]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0 | SDS2:*:4.0:3.0 | SHG2:*:4.0:3.0)
+	exit ;;
+    M68*:*:R3V[5678]*:*)
+	test -r /sysV68 && { echo 'm68k-motorola-sysv'; exit; } ;;
+    3[345]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0 | SDS2:*:4.0:3.0 | SHG2:*:4.0:3.0 | S7501*:*:4.0:3.0)
 	OS_REL=''
 	test -r /etc/.relid \
 	&& OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
 	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-	  && echo i486-ncr-sysv4.3${OS_REL} && exit 0
+	  && { echo i486-ncr-sysv4.3${OS_REL}; exit; }
 	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
-	  && echo i586-ncr-sysv4.3${OS_REL} && exit 0 ;;
+	  && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
     3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
         /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-          && echo i486-ncr-sysv4 && exit 0 ;;
+          && { echo i486-ncr-sysv4; exit; } ;;
     m68*:LynxOS:2.*:* | m68*:LynxOS:3.0*:*)
 	echo m68k-unknown-lynxos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     mc68030:UNIX_System_V:4.*:*)
 	echo m68k-atari-sysv4
-	exit 0 ;;
+	exit ;;
     TSUNAMI:LynxOS:2.*:*)
 	echo sparc-unknown-lynxos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     rs6000:LynxOS:2.*:*)
 	echo rs6000-unknown-lynxos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     PowerPC:LynxOS:2.*:* | PowerPC:LynxOS:3.[01]*:* | PowerPC:LynxOS:4.0*:*)
 	echo powerpc-unknown-lynxos${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     SM[BE]S:UNIX_SV:*:*)
 	echo mips-dde-sysv${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     RM*:ReliantUNIX-*:*:*)
 	echo mips-sni-sysv4
-	exit 0 ;;
+	exit ;;
     RM*:SINIX-*:*:*)
 	echo mips-sni-sysv4
-	exit 0 ;;
+	exit ;;
     *:SINIX-*:*:*)
 	if uname -p 2>/dev/null >/dev/null ; then
 		UNAME_MACHINE=`(uname -p) 2>/dev/null`
 		echo ${UNAME_MACHINE}-sni-sysv4
 	else
 		echo ns32k-sni-sysv
 	fi
-	exit 0 ;;
+	exit ;;
     PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
                       # says <Richard.M.Bartel@ccMail.Census.GOV>
         echo i586-unisys-sysv4
-        exit 0 ;;
+        exit ;;
     *:UNIX_System_V:4*:FTX*)
 	# From Gerald Hewes <hewes@openmarket.com>.
 	# How about differentiating between stratus architectures? -djm
 	echo hppa1.1-stratus-sysv4
-	exit 0 ;;
+	exit ;;
     *:*:*:FTX*)
 	# From seanf@swdc.stratus.com.
 	echo i860-stratus-sysv4
-	exit 0 ;;
+	exit ;;
+    i*86:VOS:*:*)
+	# From Paul.Green@stratus.com.
+	echo ${UNAME_MACHINE}-stratus-vos
+	exit ;;
     *:VOS:*:*)
 	# From Paul.Green@stratus.com.
 	echo hppa1.1-stratus-vos
-	exit 0 ;;
+	exit ;;
     mc68*:A/UX:*:*)
 	echo m68k-apple-aux${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     news*:NEWS-OS:6*:*)
 	echo mips-sony-newsos6
-	exit 0 ;;
+	exit ;;
     R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
 	if [ -d /usr/nec ]; then
 	        echo mips-nec-sysv${UNAME_RELEASE}
 	else
 	        echo mips-unknown-sysv${UNAME_RELEASE}
 	fi
-        exit 0 ;;
+        exit ;;
     BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
 	echo powerpc-be-beos
-	exit 0 ;;
+	exit ;;
     BeMac:BeOS:*:*)	# BeOS running on Mac or Mac clone, PPC only.
 	echo powerpc-apple-beos
-	exit 0 ;;
+	exit ;;
     BePC:BeOS:*:*)	# BeOS running on Intel PC compatible.
 	echo i586-pc-beos
-	exit 0 ;;
+	exit ;;
     SX-4:SUPER-UX:*:*)
 	echo sx4-nec-superux${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     SX-5:SUPER-UX:*:*)
 	echo sx5-nec-superux${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     SX-6:SUPER-UX:*:*)
 	echo sx6-nec-superux${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     Power*:Rhapsody:*:*)
 	echo powerpc-apple-rhapsody${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:Rhapsody:*:*)
 	echo ${UNAME_MACHINE}-apple-rhapsody${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:Darwin:*:*)
-	case `uname -p` in
-	    *86) UNAME_PROCESSOR=i686 ;;
-	    powerpc) UNAME_PROCESSOR=powerpc ;;
+	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
+	case $UNAME_PROCESSOR in
+	    unknown) UNAME_PROCESSOR=powerpc ;;
 	esac
 	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:procnto*:*:* | *:QNX:[0123456789]*:*)
 	UNAME_PROCESSOR=`uname -p`
 	if test "$UNAME_PROCESSOR" = "x86"; then
 		UNAME_PROCESSOR=i386
 		UNAME_MACHINE=pc
 	fi
 	echo ${UNAME_PROCESSOR}-${UNAME_MACHINE}-nto-qnx${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:QNX:*:4*)
 	echo i386-pc-qnx
-	exit 0 ;;
-    NSR-[DGKLNPTVWY]:NONSTOP_KERNEL:*:*)
+	exit ;;
+    NSE-?:NONSTOP_KERNEL:*:*)
+	echo nse-tandem-nsk${UNAME_RELEASE}
+	exit ;;
+    NSR-?:NONSTOP_KERNEL:*:*)
 	echo nsr-tandem-nsk${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:NonStop-UX:*:*)
 	echo mips-compaq-nonstopux
-	exit 0 ;;
+	exit ;;
     BS2000:POSIX*:*:*)
 	echo bs2000-siemens-sysv
-	exit 0 ;;
+	exit ;;
     DS/*:UNIX_System_V:*:*)
 	echo ${UNAME_MACHINE}-${UNAME_SYSTEM}-${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
     *:Plan9:*:*)
 	# "uname -m" is not consistent, so use $cputype instead. 386
 	# is converted to i386 for consistency with other x86
 	# operating systems.
 	if test "$cputype" = "386"; then
 	    UNAME_MACHINE=i386
 	else
 	    UNAME_MACHINE="$cputype"
 	fi
 	echo ${UNAME_MACHINE}-unknown-plan9
-	exit 0 ;;
+	exit ;;
     *:TOPS-10:*:*)
 	echo pdp10-unknown-tops10
-	exit 0 ;;
+	exit ;;
     *:TENEX:*:*)
 	echo pdp10-unknown-tenex
-	exit 0 ;;
+	exit ;;
     KS10:TOPS-20:*:* | KL10:TOPS-20:*:* | TYPE4:TOPS-20:*:*)
 	echo pdp10-dec-tops20
-	exit 0 ;;
+	exit ;;
     XKL-1:TOPS-20:*:* | TYPE5:TOPS-20:*:*)
 	echo pdp10-xkl-tops20
-	exit 0 ;;
+	exit ;;
     *:TOPS-20:*:*)
 	echo pdp10-unknown-tops20
-	exit 0 ;;
+	exit ;;
     *:ITS:*:*)
 	echo pdp10-unknown-its
-	exit 0 ;;
+	exit ;;
     SEI:*:*:SEIUX)
         echo mips-sei-seiux${UNAME_RELEASE}
-	exit 0 ;;
+	exit ;;
+    *:DragonFly:*:*)
+	echo ${UNAME_MACHINE}-unknown-dragonfly`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
+	exit ;;
+    *:*VMS:*:*)
+    	UNAME_MACHINE=`(uname -p) 2>/dev/null`
+	case "${UNAME_MACHINE}" in
+	    A*) echo alpha-dec-vms ; exit ;;
+	    I*) echo ia64-dec-vms ; exit ;;
+	    V*) echo vax-dec-vms ; exit ;;
+	esac ;;
+    *:XENIX:*:SysV)
+	echo i386-pc-xenix
+	exit ;;
+    i*86:skyos:*:*)
+	echo ${UNAME_MACHINE}-pc-skyos`echo ${UNAME_RELEASE}` | sed -e 's/ .*$//'
+	exit ;;
+    i*86:rdos:*:*)
+	echo ${UNAME_MACHINE}-pc-rdos
+	exit ;;
 esac
 
 #echo '(No uname command or uname output not recognized.)' 1>&2
 #echo "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" 1>&2
 
 eval $set_cc_for_build
@@ -1239,13 +1326,13 @@
 #endif
          ); exit (0);
 #endif
 #endif
 
 #if defined (__arm) && defined (__acorn) && defined (__unix)
-  printf ("arm-acorn-riscix"); exit (0);
+  printf ("arm-acorn-riscix\n"); exit (0);
 #endif
 
 #if defined (hp300) && !defined (hpux)
   printf ("m68k-hp-bsd\n"); exit (0);
 #endif
 
@@ -1328,52 +1415,55 @@
 #endif
 
   exit (1);
 }
 EOF
 
-$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && $dummy && exit 0
+$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && SYSTEM_NAME=`$dummy` &&
+	{ echo "$SYSTEM_NAME"; exit; }
 
 # Apollos put the system type in the environment.
 
-test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit 0; }
+test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit; }
 
 # Convex versions that predate uname can use getsysinfo(1)
 
 if [ -x /usr/convex/getsysinfo ]
 then
     case `getsysinfo -f cpu_type` in
     c1*)
 	echo c1-convex-bsd
-	exit 0 ;;
+	exit ;;
     c2*)
 	if getsysinfo -f scalar_acc
 	then echo c32-convex-bsd
 	else echo c2-convex-bsd
 	fi
-	exit 0 ;;
+	exit ;;
     c34*)
 	echo c34-convex-bsd
-	exit 0 ;;
+	exit ;;
     c38*)
 	echo c38-convex-bsd
-	exit 0 ;;
+	exit ;;
     c4*)
 	echo c4-convex-bsd
-	exit 0 ;;
+	exit ;;
     esac
 fi
 
 cat >&2 <<EOF
 $0: unable to guess system type
 
 This script, last modified $timestamp, has failed to recognize
 the operating system you are using. It is advised that you
 download the most up to date version of the config scripts from
 
-    ftp://ftp.gnu.org/pub/gnu/config/
+  http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/config.guess
+and
+  http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/config.sub
 
 If the version you run ($0) is already up to date, please
 send the following data and any information you think might be
 pertinent to <config-patches@gnu.org> in order to provide the needed
 information to handle your system.
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.h.in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.h.in
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.h.in	2006-04-18 01:54:00.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.h.in	2006-11-07 12:39:47.000000000 +0800
@@ -173,16 +173,20 @@
 /* Define to 1 if you have the `locale_charset' function. */
 #undef HAVE_LOCALE_CHARSET
 
 /* Define to 1 if you have the <locale.h> header file. */
 #undef HAVE_LOCALE_H
 
-/* Define to 1 if long double works and has more range or precision than
-   double. */
+/* Define to 1 if the type `long double' works and has more range or precision
+   than `double'. */
 #undef HAVE_LONG_DOUBLE
 
+/* Define to 1 if the type `long double' works and has more range or precision
+   than `double'. */
+#undef HAVE_LONG_DOUBLE_WIDER
+
 /* Define to 1 if you have the `lseek64' function. */
 #undef HAVE_LSEEK64
 
 /* Define to 1 if you have the `lutimes' function. */
 #undef HAVE_LUTIMES
 
@@ -415,12 +419,15 @@
 #undef MAJOR_IN_MKDEV
 
 /* Define to 1 if `major', `minor', and `makedev' are declared in
    <sysmacros.h>. */
 #undef MAJOR_IN_SYSMACROS
 
+/* Define to 1 if makedev() takes 3 args */
+#undef MAKEDEV_TAKES_3_ARGS
+
 /* Define to 1 if mknod() can create FIFOs. */
 #undef MKNOD_CREATES_FIFOS
 
 /* Define to 1 if mknod() can create sockets. */
 #undef MKNOD_CREATES_SOCKETS
 
@@ -463,33 +470,33 @@
 /* Define to 1 if sockets need to be shutdown */
 #undef SHUTDOWN_ALL_SOCKETS
 
 /* Define to 1 if "signed char" is a valid type */
 #undef SIGNED_CHAR_OK
 
-/* The size of a `int', as computed by sizeof. */
+/* The size of `int', as computed by sizeof. */
 #undef SIZEOF_INT
 
-/* The size of a `long', as computed by sizeof. */
+/* The size of `long', as computed by sizeof. */
 #undef SIZEOF_LONG
 
-/* The size of a `long long', as computed by sizeof. */
+/* The size of `long long', as computed by sizeof. */
 #undef SIZEOF_LONG_LONG
 
-/* The size of a `off64_t', as computed by sizeof. */
+/* The size of `off64_t', as computed by sizeof. */
 #undef SIZEOF_OFF64_T
 
-/* The size of a `off_t', as computed by sizeof. */
+/* The size of `off_t', as computed by sizeof. */
 #undef SIZEOF_OFF_T
 
-/* The size of a `short', as computed by sizeof. */
+/* The size of `short', as computed by sizeof. */
 #undef SIZEOF_SHORT
 
 /* If using the C implementation of alloca, define if you know the
    direction of stack growth for your system; otherwise it will be
-   automatically deduced at run-time.
+   automatically deduced at runtime.
 	STACK_DIRECTION > 0 => grows toward higher addresses
 	STACK_DIRECTION < 0 => grows toward lower addresses
 	STACK_DIRECTION = 0 => direction of growth unknown */
 #undef STACK_DIRECTION
 
 /* Define to 1 if you have the ANSI C header files. */
@@ -520,19 +527,19 @@
 #undef inline
 #endif
 
 /* Define to `int' if <sys/types.h> does not define. */
 #undef mode_t
 
-/* Define to `long' if <sys/types.h> does not define. */
+/* Define to `long int' if <sys/types.h> does not define. */
 #undef off_t
 
 /* Define to `int' if <sys/types.h> does not define. */
 #undef pid_t
 
-/* Define to `unsigned' if <sys/types.h> does not define. */
+/* Define to `unsigned int' if <sys/types.h> does not define. */
 #undef size_t
 
 /* type to use in place of socklen_t if not defined */
 #undef socklen_t
 
 /* Define to `int' if <sys/types.h> doesn't define. */
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.sub /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.sub
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/config.sub	2004-03-06 15:00:16.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/config.sub	2006-11-02 10:01:25.000000000 +0800
@@ -1,12 +1,13 @@
 #! /bin/sh
 # Configuration validation subroutine script.
 #   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003 Free Software Foundation, Inc.
+#   2000, 2001, 2002, 2003, 2004, 2005, 2006 Free Software Foundation,
+#   Inc.
 
-timestamp='2003-08-18'
+timestamp='2006-07-02'
 
 # This file is (in principle) common to ALL GNU software.
 # The presence of a machine in this file suggests that SOME GNU software
 # can handle that machine.  It does not imply ALL GNU software can.
 #
 # This file is free software; you can redistribute it and/or modify
@@ -18,20 +19,21 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330,
-# Boston, MA 02111-1307, USA.
-
+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
+# 02110-1301, USA.
+#
 # As a special exception to the GNU General Public License, if you
 # distribute this file as part of a program that contains a
 # configuration script generated by Autoconf, you may include it under
 # the same distribution terms that you use for the rest of that program.
 
+
 # Please send patches to <config-patches@gnu.org>.  Submit a context
 # diff and a properly formatted ChangeLog entry.
 #
 # Configuration subroutine to validate and canonicalize a configuration type.
 # Supply the specified configuration type as an argument.
 # If it is invalid, we print an error message on stderr and exit with code 1.
@@ -67,42 +69,42 @@
 
 Report bugs and patches to <config-patches@gnu.org>."
 
 version="\
 GNU config.sub ($timestamp)
 
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005
 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
 
 help="
 Try \`$me --help' for more information."
 
 # Parse command line
 while test $# -gt 0 ; do
   case $1 in
     --time-stamp | --time* | -t )
-       echo "$timestamp" ; exit 0 ;;
+       echo "$timestamp" ; exit ;;
     --version | -v )
-       echo "$version" ; exit 0 ;;
+       echo "$version" ; exit ;;
     --help | --h* | -h )
-       echo "$usage"; exit 0 ;;
+       echo "$usage"; exit ;;
     -- )     # Stop option processing
        shift; break ;;
     - )	# Use stdin as input.
        break ;;
     -* )
        echo "$me: invalid option $1$help"
        exit 1 ;;
 
     *local*)
        # First pass through any local machine types.
        echo $1
-       exit 0;;
+       exit ;;
 
     * )
        break ;;
   esac
 done
 
@@ -115,13 +117,15 @@
 esac
 
 # Separate what the user gave into CPU-COMPANY and OS or KERNEL-OS (if any).
 # Here we must recognize all the valid KERNEL-OS combinations.
 maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
 case $maybe_os in
-  nto-qnx* | linux-gnu* | linux-dietlibc | kfreebsd*-gnu* | netbsd*-gnu* | storm-chaos* | os2-emx* | rtmk-nova*)
+  nto-qnx* | linux-gnu* | linux-dietlibc | linux-newlib* | linux-uclibc* | \
+  uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | \
+  storm-chaos* | os2-emx* | rtmk-nova*)
     os=-$maybe_os
     basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
     ;;
   *)
     basic_machine=`echo $1 | sed 's/-[^-]*$//'`
     if [ $basic_machine != $1 ]
@@ -141,13 +145,13 @@
 	-dec* | -mips* | -sequent* | -encore* | -pc532* | -sgi* | -sony* | \
 	-att* | -7300* | -3300* | -delta* | -motorola* | -sun[234]* | \
 	-unicom* | -ibm* | -next | -hp | -isi* | -apollo | -altos* | \
 	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
 	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
 	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
-	-apple | -axis)
+	-apple | -axis | -knuth | -cray)
 		os=
 		basic_machine=$1
 		;;
 	-sim | -cisco | -oki | -wec | -winbond)
 		os=
 		basic_machine=$1
@@ -166,12 +170,16 @@
  		os=-chorusrdb
 		basic_machine=$1
  		;;
 	-hiux*)
 		os=-hiuxwe2
 		;;
+	-sco6)
+		os=-sco5v6
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
 	-sco5)
 		os=-sco3.2v5
 		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
 		;;
 	-sco4)
 		os=-sco3.2v4
@@ -182,12 +190,16 @@
 		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
 		;;
 	-sco3.2v[4-9]*)
 		# Don't forget version if it is 3.2v4 or newer.
 		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
 		;;
+	-sco5v6*)
+		# Don't forget version if it is 3.2v4 or newer.
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
 	-sco*)
 		os=-sco3.2v2
 		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
 		;;
 	-udk*)
 		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
@@ -226,60 +238,69 @@
 	# Some are omitted here because they have special meanings below.
 	1750a | 580 \
 	| a29k \
 	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
 	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
 	| am33_2.0 \
-	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr \
+	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr | avr32 \
+	| bfin \
 	| c4x | clipper \
 	| d10v | d30v | dlx | dsp16xx \
 	| fr30 | frv \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
 	| i370 | i860 | i960 | ia64 \
 	| ip2k | iq2000 \
-	| m32r | m68000 | m68k | m88k | mcore \
+	| m32c | m32r | m32rle | m68000 | m68k | m88k \
+	| maxq | mb | microblaze | mcore \
 	| mips | mipsbe | mipseb | mipsel | mipsle \
 	| mips16 \
 	| mips64 | mips64el \
 	| mips64vr | mips64vrel \
 	| mips64orion | mips64orionel \
 	| mips64vr4100 | mips64vr4100el \
 	| mips64vr4300 | mips64vr4300el \
 	| mips64vr5000 | mips64vr5000el \
+	| mips64vr5900 | mips64vr5900el \
 	| mipsisa32 | mipsisa32el \
 	| mipsisa32r2 | mipsisa32r2el \
 	| mipsisa64 | mipsisa64el \
 	| mipsisa64r2 | mipsisa64r2el \
 	| mipsisa64sb1 | mipsisa64sb1el \
 	| mipsisa64sr71k | mipsisa64sr71kel \
 	| mipstx39 | mipstx39el \
 	| mn10200 | mn10300 \
+	| mt \
 	| msp430 \
+	| nios | nios2 \
 	| ns16k | ns32k \
-	| openrisc | or32 \
+	| or32 \
 	| pdp10 | pdp11 | pj | pjl \
 	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
 	| pyramid \
-	| sh | sh[1234] | sh[23]e | sh[34]eb | shbe | shle | sh[1234]le | sh3ele \
+	| sh | sh[1234] | sh[24]a | sh[23]e | sh[34]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
 	| sh64 | sh64le \
-	| sparc | sparc64 | sparc86x | sparclet | sparclite | sparcv9 | sparcv9b \
-	| strongarm \
+	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
+	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
+	| spu | strongarm \
 	| tahoe | thumb | tic4x | tic80 | tron \
 	| v850 | v850e \
 	| we32k \
-	| x86 | xscale | xstormy16 | xtensa \
+	| x86 | xscale | xscalee[bl] | xstormy16 | xtensa \
 	| z8k)
 		basic_machine=$basic_machine-unknown
 		;;
 	m6811 | m68hc11 | m6812 | m68hc12)
 		# Motorola 68HC11/12.
 		basic_machine=$basic_machine-unknown
 		os=-none
 		;;
 	m88110 | m680[12346]0 | m683?2 | m68360 | m5200 | v70 | w65 | z8k)
 		;;
+	ms1)
+		basic_machine=mt-unknown
+		;;
 
 	# We use `pc' rather than `unknown'
 	# because (1) that's what they normally are, and
 	# (2) the word "unknown" tends to confuse beginning users.
 	i*86 | x86_64)
 	  basic_machine=$basic_machine-pc
@@ -293,59 +314,64 @@
 	580-* \
 	| a29k-* \
 	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
 	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
 	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
-	| avr-* \
-	| bs2000-* \
+	| avr-* | avr32-* \
+	| bfin-* | bs2000-* \
 	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
-	| clipper-* | cydra-* \
+	| clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
 	| elxsi-* \
 	| f30[01]-* | f700-* | fr30-* | frv-* | fx80-* \
 	| h8300-* | h8500-* \
 	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
 	| i*86-* | i860-* | i960-* | ia64-* \
 	| ip2k-* | iq2000-* \
-	| m32r-* \
+	| m32c-* | m32r-* | m32rle-* \
 	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
-	| m88110-* | m88k-* | mcore-* \
+	| m88110-* | m88k-* | maxq-* | mcore-* \
 	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
 	| mips16-* \
 	| mips64-* | mips64el-* \
 	| mips64vr-* | mips64vrel-* \
 	| mips64orion-* | mips64orionel-* \
 	| mips64vr4100-* | mips64vr4100el-* \
 	| mips64vr4300-* | mips64vr4300el-* \
 	| mips64vr5000-* | mips64vr5000el-* \
+	| mips64vr5900-* | mips64vr5900el-* \
 	| mipsisa32-* | mipsisa32el-* \
 	| mipsisa32r2-* | mipsisa32r2el-* \
 	| mipsisa64-* | mipsisa64el-* \
 	| mipsisa64r2-* | mipsisa64r2el-* \
 	| mipsisa64sb1-* | mipsisa64sb1el-* \
 	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
 	| mipstx39-* | mipstx39el-* \
+	| mmix-* \
+	| mt-* \
 	| msp430-* \
-	| none-* | np1-* | nv1-* | ns16k-* | ns32k-* \
+	| nios-* | nios2-* \
+	| none-* | np1-* | ns16k-* | ns32k-* \
 	| orion-* \
 	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
 	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
 	| pyramid-* \
 	| romp-* | rs6000-* \
-	| sh-* | sh[1234]-* | sh[23]e-* | sh[34]eb-* | shbe-* \
+	| sh-* | sh[1234]-* | sh[24]a-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
 	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
-	| sparc-* | sparc64-* | sparc86x-* | sparclet-* | sparclite-* \
-	| sparcv9-* | sparcv9b-* | strongarm-* | sv1-* | sx?-* \
+	| sparc-* | sparc64-* | sparc64b-* | sparc64v-* | sparc86x-* | sparclet-* \
+	| sparclite-* \
+	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | strongarm-* | sv1-* | sx?-* \
 	| tahoe-* | thumb-* \
 	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
 	| tron-* \
 	| v850-* | v850e-* | vax-* \
 	| we32k-* \
-	| x86-* | x86_64-* | xps100-* | xscale-* | xstormy16-* \
-	| xtensa-* \
+	| x86-* | x86_64-* | xps100-* | xscale-* | xscalee[bl]-* \
+	| xstormy16-* | xtensa-* \
 	| ymp-* \
 	| z8k-*)
 		;;
 	# Recognize the various machine names and aliases which stand
 	# for a CPU type and a company and sometimes even an OS.
 	386bsd)
@@ -359,12 +385,15 @@
 		basic_machine=we32k-att
 		;;
 	a29khif)
 		basic_machine=a29k-amd
 		os=-udi
 		;;
+    	abacus)
+		basic_machine=abacus-unknown
+		;;
 	adobe68k)
 		basic_machine=m68010-adobe
 		os=-scout
 		;;
 	alliant | fx80)
 		basic_machine=fx80-alliant
@@ -376,12 +405,15 @@
 		basic_machine=a29k-none
 		os=-bsd
 		;;
 	amd64)
 		basic_machine=x86_64-pc
 		;;
+	amd64-*)
+		basic_machine=x86_64-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
 	amdahl)
 		basic_machine=580-amdahl
 		os=-sysv
 		;;
 	amiga | amiga-*)
 		basic_machine=m68k-unknown
@@ -435,18 +467,33 @@
 		os=-bsd
 		;;
 	cray | j90)
 		basic_machine=j90-cray
 		os=-unicos
 		;;
+	craynv)
+		basic_machine=craynv-cray
+		os=-unicosmp
+		;;
+	cr16c)
+		basic_machine=cr16c-unknown
+		os=-elf
+		;;
 	crds | unos)
 		basic_machine=m68k-crds
 		;;
+	crisv32 | crisv32-* | etraxfs*)
+		basic_machine=crisv32-axis
+		;;
 	cris | cris-* | etrax*)
 		basic_machine=cris-axis
 		;;
+	crx)
+		basic_machine=crx-unknown
+		os=-elf
+		;;
 	da30 | da30-*)
 		basic_machine=m68k-da30
 		;;
 	decstation | decstation-3100 | pmax | pmax-* | pmin | dec3100 | decstatn)
 		basic_machine=mips-dec
 		;;
@@ -463,12 +510,16 @@
 		basic_machine=m68k-motorola
 		;;
 	delta88)
 		basic_machine=m88k-motorola
 		os=-sysv3
 		;;
+	djgpp)
+		basic_machine=i586-pc
+		os=-msdosdjgpp
+		;;
 	dpx20 | dpx20-*)
 		basic_machine=rs6000-bull
 		os=-bosx
 		;;
 	dpx2* | dpx2*-bull)
 		basic_machine=m68k-bull
@@ -641,28 +692,27 @@
 	mips3*-*)
 		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`
 		;;
 	mips3*)
 		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`-unknown
 		;;
-	mmix*)
-		basic_machine=mmix-knuth
-		os=-mmixware
-		;;
 	monitor)
 		basic_machine=m68k-rom68k
 		os=-coff
 		;;
 	morphos)
 		basic_machine=powerpc-unknown
 		os=-morphos
 		;;
 	msdos)
 		basic_machine=i386-pc
 		os=-msdos
 		;;
+	ms1-*)
+		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
+		;;
 	mvs)
 		basic_machine=i370-ibm
 		os=-mvs
 		;;
 	ncr3000)
 		basic_machine=i486-ncr
@@ -725,26 +775,25 @@
 		basic_machine=mips-compaq
 		os=-nonstopux
 		;;
 	np1)
 		basic_machine=np1-gould
 		;;
-	nv1)
-		basic_machine=nv1-cray
-		os=-unicosmp
-		;;
 	nsr-tandem)
 		basic_machine=nsr-tandem
 		;;
 	op50n-* | op60c-*)
 		basic_machine=hppa1.1-oki
 		os=-proelf
 		;;
-	or32 | or32-*)
+	openrisc | openrisc-*)
 		basic_machine=or32-unknown
-		os=-coff
+		;;
+	os400)
+		basic_machine=powerpc-ibm
+		os=-os400
 		;;
 	OSE68000 | ose68000)
 		basic_machine=m68000-ericsson
 		os=-ose
 		;;
 	os68k)
@@ -765,12 +814,18 @@
 	pbb)
 		basic_machine=m68k-tti
 		;;
 	pc532 | pc532-*)
 		basic_machine=ns32k-pc532
 		;;
+	pc98)
+		basic_machine=i386-pc
+		;;
+	pc98-*)
+		basic_machine=i386-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
 	pentium | p5 | k5 | k6 | nexgen | viac3)
 		basic_machine=i586-pc
 		;;
 	pentiumpro | p6 | 6x86 | athlon | athlon_*)
 		basic_machine=i686-pc
 		;;
@@ -821,12 +876,16 @@
 		basic_machine=i386-ibm
 		;;
 	pw32)
 		basic_machine=i586-unknown
 		os=-pw32
 		;;
+	rdos)
+		basic_machine=i386-pc
+		os=-rdos
+		;;
 	rom68k)
 		basic_machine=m68k-rom68k
 		os=-coff
 		;;
 	rm[46]00)
 		basic_machine=mips-siemens
@@ -960,12 +1019,16 @@
 		basic_machine=pdp10-xkl
 		os=-tops20
 		;;
 	tower | tower-32)
 		basic_machine=m68k-ncr
 		;;
+	tpf)
+		basic_machine=s390x-ibm
+		os=-tpf
+		;;
 	udi29k)
 		basic_machine=a29k-amd
 		os=-udi
 		;;
 	ultra3)
 		basic_machine=a29k-nyu
@@ -1003,12 +1066,16 @@
 		os=-none
 		;;
 	w89k-*)
 		basic_machine=hppa1.1-winbond
 		os=-proelf
 		;;
+	xbox)
+		basic_machine=i686-pc
+		os=-mingw32
+		;;
 	xps | xps100)
 		basic_machine=xps100-honeywell
 		;;
 	ymp)
 		basic_machine=ymp-cray
 		os=-unicos
@@ -1033,12 +1100,15 @@
 	op60c)
 		basic_machine=hppa1.1-oki
 		;;
 	romp)
 		basic_machine=romp-ibm
 		;;
+	mmix)
+		basic_machine=mmix-knuth
+		;;
 	rs6000)
 		basic_machine=rs6000-ibm
 		;;
 	vax)
 		basic_machine=vax-dec
 		;;
@@ -1049,19 +1119,16 @@
 	pdp11)
 		basic_machine=pdp11-dec
 		;;
 	we32k)
 		basic_machine=we32k-att
 		;;
-	sh3 | sh4 | sh[34]eb | sh[1234]le | sh[23]ele)
+	sh[1234] | sh[24]a | sh[34]eb | sh[1234]le | sh[23]ele)
 		basic_machine=sh-unknown
 		;;
-	sh64)
-		basic_machine=sh64-unknown
-		;;
-	sparc | sparcv9 | sparcv9b)
+	sparc | sparcv8 | sparcv9 | sparcv9b | sparcv9v)
 		basic_machine=sparc-sun
 		;;
 	cydra)
 		basic_machine=cydra-cydrome
 		;;
 	orion)
@@ -1128,25 +1195,29 @@
 	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -sunos | -sunos[34]*\
 	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -solaris* | -sym* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
 	      | -aos* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
 	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
-	      | -hiux* | -386bsd* | -netbsd* | -openbsd* | -kfreebsd* | -freebsd* | -riscix* \
-	      | -lynxos* | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
+	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
+	      | -openbsd* | -solidbsd* \
+	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
+	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
 	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
 	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
 	      | -chorusos* | -chorusrdb* \
 	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
-	      | -mingw32* | -linux-gnu* | -uxpv* | -beos* | -mpeix* | -udk* \
+	      | -mingw32* | -linux-gnu* | -linux-newlib* | -linux-uclibc* \
+	      | -uxpv* | -beos* | -mpeix* | -udk* \
 	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
 	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
 	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
 	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
 	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
-	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei*)
+	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
+	      | -skyos* | -haiku* | -rdos* | -toppers*)
 	# Remember, each alternative MUST END IN *, to match a version number.
 		;;
 	-qnx*)
 		case $basic_machine in
 		    x86-* | i*86-*)
 			;;
@@ -1158,13 +1229,13 @@
 	-nto-qnx*)
 		;;
 	-nto*)
 		os=`echo $os | sed -e 's|nto|nto-qnx|'`
 		;;
 	-sim | -es1800* | -hms* | -xray | -os68k* | -none* | -v88r* \
-	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* \
+	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* | -haiku* \
 	      | -macos* | -mpw* | -magic* | -mmixware* | -mon960* | -lnews*)
 		;;
 	-mac*)
 		os=`echo $os | sed -e 's|mac|macos|'`
 		;;
 	-linux-dietlibc)
@@ -1179,12 +1250,15 @@
 	-sunos6*)
 		os=`echo $os | sed -e 's|sunos6|solaris3|'`
 		;;
 	-opened*)
 		os=-openedition
 		;;
+        -os400*)
+		os=-os400
+		;;
 	-wince*)
 		os=-wince
 		;;
 	-osfrose*)
 		os=-osfrose
 		;;
@@ -1200,12 +1274,15 @@
 	-acis*)
 		os=-aos
 		;;
 	-atheos*)
 		os=-atheos
 		;;
+	-syllable*)
+		os=-syllable
+		;;
 	-386bsd)
 		os=-bsd
 		;;
 	-ctix* | -uts*)
 		os=-sysv
 		;;
@@ -1222,12 +1299,15 @@
 	-sinix5.*)
 		os=`echo $os | sed -e 's|sinix|sysv|'`
 		;;
 	-sinix*)
 		os=-sysv4
 		;;
+        -tpf*)
+		os=-tpf
+		;;
 	-triton*)
 		os=-sysv3
 		;;
 	-oss*)
 		os=-sysv3
 		;;
@@ -1258,12 +1338,15 @@
 	-aros*)
 		os=-aros
 		;;
 	-kaos*)
 		os=-kaos
 		;;
+	-zvmoe)
+		os=-zvmoe
+		;;
 	-none)
 		;;
 	*)
 		# Get rid of the `-' at the beginning of $os.
 		os=`echo $os | sed 's/[^-]*-//'`
 		echo Invalid configuration \`$1\': system \`$os\' not recognized 1>&2
@@ -1280,24 +1363,27 @@
 # "-sun"), then you have to tell the case statement up towards the top
 # that MANUFACTURER isn't an operating system.  Otherwise, code above
 # will signal an error saying that MANUFACTURER isn't an operating
 # system, and we'll never get to this point.
 
 case $basic_machine in
+        spu-*)
+		os=-elf
+		;;
 	*-acorn)
 		os=-riscix1.2
 		;;
 	arm*-rebel)
 		os=-linux
 		;;
 	arm*-semi)
 		os=-aout
 		;;
-    c4x-* | tic4x-*)
-        os=-coff
-        ;;
+        c4x-* | tic4x-*)
+        	os=-coff
+		;;
 	# This must come before the *-dec entry.
 	pdp10-*)
 		os=-tops20
 		;;
 	pdp11-*)
 		os=-none
@@ -1335,15 +1421,21 @@
 	sparc-* | *-sun)
 		os=-sunos4.1.1
 		;;
 	*-be)
 		os=-beos
 		;;
+	*-haiku)
+		os=-haiku
+		;;
 	*-ibm)
 		os=-aix
 		;;
+    	*-knuth)
+		os=-mmixware
+		;;
 	*-wec)
 		os=-proelf
 		;;
 	*-winbond)
 		os=-proelf
 		;;
@@ -1470,15 +1562,21 @@
 			-genix*)
 				vendor=ns
 				;;
 			-mvs* | -opened*)
 				vendor=ibm
 				;;
+			-os400*)
+				vendor=ibm
+				;;
 			-ptx*)
 				vendor=sequent
 				;;
+			-tpf*)
+				vendor=ibm
+				;;
 			-vxsim* | -vxworks* | -windiss*)
 				vendor=wrs
 				;;
 			-aux*)
 				vendor=apple
 				;;
@@ -1497,13 +1595,13 @@
 		esac
 		basic_machine=`echo $basic_machine | sed "s/unknown/$vendor/"`
 		;;
 esac
 
 echo $basic_machine$os
-exit 0
+exit
 
 # Local variables:
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/configure /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/configure
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/configure	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/configure	2006-11-07 12:39:47.000000000 +0800
@@ -1,11 +1,12 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.59.
+# Generated by GNU Autoconf 2.60a.
 #
-# Copyright (C) 2003 Free Software Foundation, Inc.
+# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
+# 2002, 2003, 2004, 2005, 2006 Free Software Foundation, Inc.
 # This configure script is free software; the Free Software Foundation
 # gives unlimited permission to copy, distribute and modify it.
 ## --------------------- ##
 ## M4sh Initialization.  ##
 ## --------------------- ##
 
@@ -13,27 +14,86 @@
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
   emulate sh
   NULLCMD=:
   # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
   # is contrary to our usage.  Disable this feature.
   alias -g '${1+"$@"}'='"$@"'
-elif test -n "${BASH_VERSION+set}" && (set -o posix) >/dev/null 2>&1; then
-  set -o posix
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in *posix*) set -o posix;; esac
 fi
+BIN_SH=xpg4; export BIN_SH # for Tru64
 DUALCASE=1; export DUALCASE # for MKS sh
 
+
+# PATH needs CR
+# Avoid depending upon Character Ranges.
+as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+as_cr_digits='0123456789'
+as_cr_alnum=$as_cr_Letters$as_cr_digits
+
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
+
 # Support unset when possible.
 if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
   as_unset=unset
 else
   as_unset=false
 fi
 
 
+# IFS
+# We need space, tab and new line, in precisely that order.  Quoting is
+# there to prevent editors from complaining about space-tab.
+# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+# splitting by setting IFS to empty value.)
+as_nl='
+'
+IFS=" ""	$as_nl"
+
+# Find who we are.  Look in the path if we contain no directory separator.
+case $0 in
+  *[\\/]* ) as_myself=$0 ;;
+  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+done
+IFS=$as_save_IFS
+
+     ;;
+esac
+# We did not find ourselves, most probably we were run as `sh COMMAND'
+# in which case we are not to be found in the path.
+if test "x$as_myself" = x; then
+  as_myself=$0
+fi
+if test ! -f "$as_myself"; then
+  echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+  { (exit 1); exit 1; }
+fi
+
 # Work around bugs in pre-3.0 UWIN ksh.
-$as_unset ENV MAIL MAILPATH
+for as_var in ENV MAIL MAILPATH
+do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+done
 PS1='$ '
 PS2='> '
 PS4='+ '
 
 # NLS nuisances.
 for as_var in \
@@ -41,279 +101,587 @@
   LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER \
   LC_TELEPHONE LC_TIME
 do
   if (set +x; test -z "`(eval $as_var=C; export $as_var) 2>&1`"); then
     eval $as_var=C; export $as_var
   else
-    $as_unset $as_var
+    ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
   fi
 done
 
 # Required to use basename.
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
-if (basename /) >/dev/null 2>&1 && test "X`basename / 2>&1`" = "X/"; then
+if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
   as_basename=basename
 else
   as_basename=false
 fi
 
 
 # Name of the executable.
-as_me=`$as_basename "$0" ||
+as_me=`$as_basename -- "$0" ||
 $as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
 	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)$' \| \
-	 .     : '\(.\)' 2>/dev/null ||
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
 echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{ s//\1/; q; }
-  	  /^X\/\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\/\(\/\).*/{ s//\1/; q; }
+    sed '/^.*\/\([^/][^/]*\)\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\).*/{
+	    s//\1/
+	    q
+	  }
   	  s/.*/./; q'`
 
+# CDPATH.
+$as_unset CDPATH
 
-# PATH needs CR, and LINENO needs CR and PATH.
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
 
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+if test "x$CONFIG_SHELL" = x; then
+  if (eval ":") 2>/dev/null; then
+  as_have_required=yes
+else
+  as_have_required=no
 fi
 
+  if test $as_have_required = yes && 	 (eval ":
+(as_func_return () {
+  (exit \$1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
 
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2"  || {
-  # Find who we are.  Look in the path if we contain no path at all
-  # relative or not.
-  case $0 in
-    *[\\/]* ) as_myself=$0 ;;
-    *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-done
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
 
-       ;;
-  esac
-  # We did not find ourselves, most probably we were run as `sh COMMAND'
-  # in which case we are not to be found in the path.
-  if test "x$as_myself" = x; then
-    as_myself=$0
-  fi
-  if test ! -f "$as_myself"; then
-    { echo "$as_me: error: cannot find myself; rerun with an absolute path" >&2
-   { (exit 1); exit 1; }; }
-  fi
-  case $CONFIG_SHELL in
-  '')
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test \$exitcode = 0) || { (exit 1); exit 1; }
+
+(
+  as_lineno_1=\$LINENO
+  as_lineno_2=\$LINENO
+  test \"x\$as_lineno_1\" != \"x\$as_lineno_2\" &&
+  test \"x\`expr \$as_lineno_1 + 1\`\" = \"x\$as_lineno_2\") || { (exit 1); exit 1; }
+") 2> /dev/null; then
+  :
+else
+  as_candidate_shells=
     as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
+for as_dir in /usr/bin/posix$PATH_SEPARATOR/bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  for as_base in sh bash ksh sh5; do
-	 case $as_dir in
+  case $as_dir in
 	 /*)
-	   if ("$as_dir/$as_base" -c '
+	   for as_base in sh bash ksh sh5; do
+	     as_candidate_shells="$as_candidate_shells $as_dir/$as_base"
+	   done;;
+       esac
+done
+IFS=$as_save_IFS
+
+
+      for as_shell in $as_candidate_shells $SHELL; do
+	 # Try only shells that exist, to save several forks.
+	 if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
+		{ ("$as_shell") 2> /dev/null <<\_ASEOF
+# Be Bourne compatible
+if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
+  emulate sh
+  NULLCMD=:
+  # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
+  # is contrary to our usage.  Disable this feature.
+  alias -g '${1+"$@"}'='"$@"'
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in *posix*) set -o posix;; esac
+fi
+BIN_SH=xpg4; export BIN_SH # for Tru64
+DUALCASE=1; export DUALCASE # for MKS sh
+
+:
+_ASEOF
+}; then
+  CONFIG_SHELL=$as_shell
+	       as_have_required=yes
+	       if { "$as_shell" 2> /dev/null <<\_ASEOF
+# Be Bourne compatible
+if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
+  emulate sh
+  NULLCMD=:
+  # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
+  # is contrary to our usage.  Disable this feature.
+  alias -g '${1+"$@"}'='"$@"'
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in *posix*) set -o posix;; esac
+fi
+BIN_SH=xpg4; export BIN_SH # for Tru64
+DUALCASE=1; export DUALCASE # for MKS sh
+
+:
+(as_func_return () {
+  (exit $1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
+
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
+
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = "$1" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test $exitcode = 0) || { (exit 1); exit 1; }
+
+(
   as_lineno_1=$LINENO
   as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
   test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2" ') 2>/dev/null; then
-	     $as_unset BASH_ENV || test "${BASH_ENV+set}" != set || { BASH_ENV=; export BASH_ENV; }
-	     $as_unset ENV || test "${ENV+set}" != set || { ENV=; export ENV; }
-	     CONFIG_SHELL=$as_dir/$as_base
-	     export CONFIG_SHELL
-	     exec "$CONFIG_SHELL" "$0" ${1+"$@"}
-	   fi;;
-	 esac
-       done
-done
-;;
-  esac
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2") || { (exit 1); exit 1; }
+
+_ASEOF
+}; then
+  break
+fi
+
+fi
+
+      done
+
+      if test "x$CONFIG_SHELL" != x; then
+  for as_var in BASH_ENV ENV
+        do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+        done
+        export CONFIG_SHELL
+        exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
+fi
+
+
+    if test $as_have_required = no; then
+  echo This script requires a shell more modern than all the
+      echo shells that I found on your system.  Please install a
+      echo modern shell, or manually run the script under such a
+      echo shell if you do have one.
+      { (exit 1); exit 1; }
+fi
+
+
+fi
+
+fi
+
+
+
+(eval "as_func_return () {
+  (exit \$1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
+
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
+
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test \$exitcode = 0") || {
+  echo No shell found that supports shell functions.
+  echo Please tell autoconf@gnu.org about your system,
+  echo including any error possibly output before this
+  echo message
+}
+
+
+
+  as_lineno_1=$LINENO
+  as_lineno_2=$LINENO
+  test "x$as_lineno_1" != "x$as_lineno_2" &&
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2" || {
 
   # Create $as_me.lineno as a copy of $as_myself, but with $LINENO
   # uniformly replaced by the line number.  The first 'sed' inserts a
-  # line-number line before each line; the second 'sed' does the real
-  # work.  The second script uses 'N' to pair each line-number line
-  # with the numbered line, and appends trailing '-' during
-  # substitution so that $LINENO is not a special case at line end.
+  # line-number line after each line using $LINENO; the second 'sed'
+  # does the real work.  The second script uses 'N' to pair each
+  # line-number line with the line containing $LINENO, and appends
+  # trailing '-' during substitution so that $LINENO is not a special
+  # case at line end.
   # (Raja R Harinath suggested sed '=', and Paul Eggert wrote the
-  # second 'sed' script.  Blame Lee E. McMahon for sed's syntax.  :-)
-  sed '=' <$as_myself |
+  # scripts with optimization help from Paolo Bonzini.  Blame Lee
+  # E. McMahon (1931-1989) for sed's syntax.  :-)
+  sed -n '
+    p
+    /[$]LINENO/=
+  ' <$as_myself |
     sed '
+      s/[$]LINENO.*/&-/
+      t lineno
+      b
+      :lineno
       N
-      s,$,-,
-      : loop
-      s,^\(['$as_cr_digits']*\)\(.*\)[$]LINENO\([^'$as_cr_alnum'_]\),\1\2\1\3,
+      :loop
+      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
       t loop
-      s,-$,,
-      s,^['$as_cr_digits']*\n,,
+      s/-\n.*//
     ' >$as_me.lineno &&
-  chmod +x $as_me.lineno ||
+  chmod +x "$as_me.lineno" ||
     { echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2
    { (exit 1); exit 1; }; }
 
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
-  # original and so on.  Autoconf is especially sensible to this).
-  . ./$as_me.lineno
+  # original and so on.  Autoconf is especially sensitive to this).
+  . "./$as_me.lineno"
   # Exit status is that of the last command.
   exit
 }
 
 
-case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
-  *c*,-n*) ECHO_N= ECHO_C='
-' ECHO_T='	' ;;
-  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
-  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
+if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+  as_dirname=dirname
+else
+  as_dirname=false
+fi
+
+ECHO_C= ECHO_N= ECHO_T=
+case `echo -n x` in
+-n*)
+  case `echo 'x\c'` in
+  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+  *)   ECHO_C='\c';;
+  esac;;
+*)
+  ECHO_N='-n';;
 esac
 
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
 rm -f conf$$ conf$$.exe conf$$.file
+if test -d conf$$.dir; then
+  rm -f conf$$.dir/conf$$.file
+else
+  rm -f conf$$.dir
+  mkdir conf$$.dir
+fi
 echo >conf$$.file
 if ln -s conf$$.file conf$$ 2>/dev/null; then
-  # We could just check for DJGPP; but this test a) works b) is more generic
-  # and c) will remain valid once DJGPP supports symlinks (DJGPP 2.04).
-  if test -f conf$$.exe; then
-    # Don't use ln at all; we don't have any links
+  as_ln_s='ln -s'
+  # ... but there are two gotchas:
+  # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+  # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+  # In both cases, we have to default to `cp -p'.
+  ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
     as_ln_s='cp -p'
-  else
-    as_ln_s='ln -s'
-  fi
 elif ln conf$$.file conf$$ 2>/dev/null; then
   as_ln_s=ln
 else
   as_ln_s='cp -p'
 fi
-rm -f conf$$ conf$$.exe conf$$.file
+rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+rmdir conf$$.dir 2>/dev/null
 
 if mkdir -p . 2>/dev/null; then
   as_mkdir_p=:
 else
   test -d ./-p && rmdir ./-p
   as_mkdir_p=false
 fi
 
-as_executable_p="test -f"
+# Find out whether ``test -x'' works.  Don't use a zero-byte file, as
+# systems may use methods other than mode bits to determine executability.
+cat >conf$$.file <<_ASEOF
+#! /bin/sh
+exit 0
+_ASEOF
+chmod +x conf$$.file
+if test -x conf$$.file >/dev/null 2>&1; then
+  as_executable_p="test -x"
+else
+  as_executable_p=:
+fi
+rm -f conf$$.file
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
 
 # Sed expression to map a string onto a valid variable name.
 as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
 
 
-# IFS
-# We need space, tab and new line, in precisely that order.
-as_nl='
-'
-IFS=" 	$as_nl"
-
-# CDPATH.
-$as_unset CDPATH
 
+exec 7<&0 </dev/null 6>&1
 
 # Name of the host.
 # hostname on some systems (SVR3.2, Linux) returns a bogus exit status,
 # so uname gets run too.
 ac_hostname=`(hostname || uname -n) 2>/dev/null | sed 1q`
 
-exec 6>&1
-
 #
 # Initializations.
 #
 ac_default_prefix=/usr/local
+ac_clean_files=
 ac_config_libobj_dir=.
+LIBOBJS=
 cross_compiling=no
 subdirs=
 MFLAGS=
 MAKEFLAGS=
 SHELL=${CONFIG_SHELL-/bin/sh}
 
-# Maximum number of lines to put in a shell here document.
-# This variable seems obsolete.  It should probably be removed, and
-# only ac_max_sed_lines should be used.
-: ${ac_max_here_lines=38}
-
 # Identity of this package.
 PACKAGE_NAME=
 PACKAGE_TARNAME=
 PACKAGE_VERSION=
 PACKAGE_STRING=
 PACKAGE_BUGREPORT=
 
 ac_unique_file="byteorder.h"
 # Factoring default headers for most tests.
 ac_includes_default="\
 #include <stdio.h>
-#if HAVE_SYS_TYPES_H
+#ifdef HAVE_SYS_TYPES_H
 # include <sys/types.h>
 #endif
-#if HAVE_SYS_STAT_H
+#ifdef HAVE_SYS_STAT_H
 # include <sys/stat.h>
 #endif
-#if STDC_HEADERS
+#ifdef STDC_HEADERS
 # include <stdlib.h>
 # include <stddef.h>
 #else
-# if HAVE_STDLIB_H
+# ifdef HAVE_STDLIB_H
 #  include <stdlib.h>
 # endif
 #endif
-#if HAVE_STRING_H
-# if !STDC_HEADERS && HAVE_MEMORY_H
+#ifdef HAVE_STRING_H
+# if !defined STDC_HEADERS && defined HAVE_MEMORY_H
 #  include <memory.h>
 # endif
 # include <string.h>
 #endif
-#if HAVE_STRINGS_H
+#ifdef HAVE_STRINGS_H
 # include <strings.h>
 #endif
-#if HAVE_INTTYPES_H
+#ifdef HAVE_INTTYPES_H
 # include <inttypes.h>
-#else
-# if HAVE_STDINT_H
-#  include <stdint.h>
-# endif
 #endif
-#if HAVE_UNISTD_H
+#ifdef HAVE_STDINT_H
+# include <stdint.h>
+#endif
+#ifdef HAVE_UNISTD_H
 # include <unistd.h>
 #endif"
 
-ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
+ac_subst_vars='SHELL
+PATH_SEPARATOR
+PACKAGE_NAME
+PACKAGE_TARNAME
+PACKAGE_VERSION
+PACKAGE_STRING
+PACKAGE_BUGREPORT
+exec_prefix
+prefix
+program_transform_name
+bindir
+sbindir
+libexecdir
+datarootdir
+datadir
+sysconfdir
+sharedstatedir
+localstatedir
+includedir
+oldincludedir
+docdir
+infodir
+htmldir
+dvidir
+pdfdir
+psdir
+libdir
+localedir
+mandir
+DEFS
+ECHO_C
+ECHO_N
+ECHO_T
+LIBS
+build_alias
+host_alias
+target_alias
+RSYNC_VERSION
+build
+build_cpu
+build_vendor
+build_os
+host
+host_cpu
+host_vendor
+host_os
+target
+target_cpu
+target_vendor
+target_os
+CC
+CFLAGS
+LDFLAGS
+CPPFLAGS
+ac_ct_CC
+EXEEXT
+OBJEXT
+CPP
+GREP
+EGREP
+INSTALL_PROGRAM
+INSTALL_SCRIPT
+INSTALL_DATA
+HAVE_REMSH
+LIBOBJS
+ALLOCA
+OBJ_SAVE
+OBJ_RESTORE
+CC_SHOBJ_FLAG
+BUILD_POPT
+LTLIBOBJS'
 ac_subst_files=''
+      ac_precious_vars='build_alias
+host_alias
+target_alias
+CC
+CFLAGS
+LDFLAGS
+CPPFLAGS
+CPP'
+
 
 # Initialize some variables set by options.
 ac_init_help=
 ac_init_version=false
 # The variables have the same names as the options, with
 # dashes changed to underlines.
@@ -334,40 +702,54 @@
 
 # Installation directory options.
 # These are left unexpanded so users can "make install exec_prefix=/foo"
 # and all the variables that are supposed to be based on exec_prefix
 # by default will actually change.
 # Use braces instead of parens because sh, perl, etc. also accept them.
+# (The list follows the same order as the GNU Coding Standards.)
 bindir='${exec_prefix}/bin'
 sbindir='${exec_prefix}/sbin'
 libexecdir='${exec_prefix}/libexec'
-datadir='${prefix}/share'
+datarootdir='${prefix}/share'
+datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
-libdir='${exec_prefix}/lib'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
-infodir='${prefix}/info'
-mandir='${prefix}/man'
+docdir='${datarootdir}/doc/${PACKAGE}'
+infodir='${datarootdir}/info'
+htmldir='${docdir}'
+dvidir='${docdir}'
+pdfdir='${docdir}'
+psdir='${docdir}'
+libdir='${exec_prefix}/lib'
+localedir='${datarootdir}/locale'
+mandir='${datarootdir}/man'
 
 ac_prev=
+ac_dashdash=
 for ac_option
 do
   # If the previous option needs an argument, assign it.
   if test -n "$ac_prev"; then
-    eval "$ac_prev=\$ac_option"
+    eval $ac_prev=\$ac_option
     ac_prev=
     continue
   fi
 
-  ac_optarg=`expr "x$ac_option" : 'x[^=]*=\(.*\)'`
+  case $ac_option in
+  *=*)	ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
+  *)	ac_optarg=yes ;;
+  esac
 
   # Accept the important Cygnus configure options, so we can diagnose typos.
 
-  case $ac_option in
+  case $ac_dashdash$ac_option in
+  --)
+    ac_dashdash=yes ;;
 
   -bindir | --bindir | --bindi | --bind | --bin | --bi)
     ac_prev=bindir ;;
   -bindir=* | --bindir=* | --bindi=* | --bind=* | --bin=* | --bi=*)
     bindir=$ac_optarg ;;
 
@@ -383,39 +765,51 @@
   | --cache-f=* | --cache-=* | --cache=* | --cach=* | --cac=* | --ca=* | --c=*)
     cache_file=$ac_optarg ;;
 
   --config-cache | -C)
     cache_file=config.cache ;;
 
-  -datadir | --datadir | --datadi | --datad | --data | --dat | --da)
+  -datadir | --datadir | --datadi | --datad)
     ac_prev=datadir ;;
-  -datadir=* | --datadir=* | --datadi=* | --datad=* | --data=* | --dat=* \
-  | --da=*)
+  -datadir=* | --datadir=* | --datadi=* | --datad=*)
     datadir=$ac_optarg ;;
 
+  -datarootdir | --datarootdir | --datarootdi | --datarootd | --dataroot \
+  | --dataroo | --dataro | --datar)
+    ac_prev=datarootdir ;;
+  -datarootdir=* | --datarootdir=* | --datarootdi=* | --datarootd=* \
+  | --dataroot=* | --dataroo=* | --dataro=* | --datar=*)
+    datarootdir=$ac_optarg ;;
+
   -disable-* | --disable-*)
     ac_feature=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_feature" : ".*[^-_$as_cr_alnum]" >/dev/null &&
       { echo "$as_me: error: invalid feature name: $ac_feature" >&2
    { (exit 1); exit 1; }; }
     ac_feature=`echo $ac_feature | sed 's/-/_/g'`
-    eval "enable_$ac_feature=no" ;;
+    eval enable_$ac_feature=no ;;
+
+  -docdir | --docdir | --docdi | --doc | --do)
+    ac_prev=docdir ;;
+  -docdir=* | --docdir=* | --docdi=* | --doc=* | --do=*)
+    docdir=$ac_optarg ;;
+
+  -dvidir | --dvidir | --dvidi | --dvid | --dvi | --dv)
+    ac_prev=dvidir ;;
+  -dvidir=* | --dvidir=* | --dvidi=* | --dvid=* | --dvi=* | --dv=*)
+    dvidir=$ac_optarg ;;
 
   -enable-* | --enable-*)
     ac_feature=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_feature" : ".*[^-_$as_cr_alnum]" >/dev/null &&
       { echo "$as_me: error: invalid feature name: $ac_feature" >&2
    { (exit 1); exit 1; }; }
     ac_feature=`echo $ac_feature | sed 's/-/_/g'`
-    case $ac_option in
-      *=*) ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`;;
-      *) ac_optarg=yes ;;
-    esac
-    eval "enable_$ac_feature='$ac_optarg'" ;;
+    eval enable_$ac_feature=\$ac_optarg ;;
 
   -exec-prefix | --exec_prefix | --exec-prefix | --exec-prefi \
   | --exec-pref | --exec-pre | --exec-pr | --exec-p | --exec- \
   | --exec | --exe | --ex)
     ac_prev=exec_prefix ;;
   -exec-prefix=* | --exec_prefix=* | --exec-prefix=* | --exec-prefi=* \
@@ -436,12 +830,18 @@
 
   -host | --host | --hos | --ho)
     ac_prev=host_alias ;;
   -host=* | --host=* | --hos=* | --ho=*)
     host_alias=$ac_optarg ;;
 
+  -htmldir | --htmldir | --htmldi | --htmld | --html | --htm | --ht)
+    ac_prev=htmldir ;;
+  -htmldir=* | --htmldir=* | --htmldi=* | --htmld=* | --html=* | --htm=* \
+  | --ht=*)
+    htmldir=$ac_optarg ;;
+
   -includedir | --includedir | --includedi | --included | --include \
   | --includ | --inclu | --incl | --inc)
     ac_prev=includedir ;;
   -includedir=* | --includedir=* | --includedi=* | --included=* | --include=* \
   | --includ=* | --inclu=* | --incl=* | --inc=*)
     includedir=$ac_optarg ;;
@@ -460,19 +860,22 @@
   | --libexe | --libex | --libe)
     ac_prev=libexecdir ;;
   -libexecdir=* | --libexecdir=* | --libexecdi=* | --libexecd=* | --libexec=* \
   | --libexe=* | --libex=* | --libe=*)
     libexecdir=$ac_optarg ;;
 
+  -localedir | --localedir | --localedi | --localed | --locale)
+    ac_prev=localedir ;;
+  -localedir=* | --localedir=* | --localedi=* | --localed=* | --locale=*)
+    localedir=$ac_optarg ;;
+
   -localstatedir | --localstatedir | --localstatedi | --localstated \
-  | --localstate | --localstat | --localsta | --localst \
-  | --locals | --local | --loca | --loc | --lo)
+  | --localstate | --localstat | --localsta | --localst | --locals)
     ac_prev=localstatedir ;;
   -localstatedir=* | --localstatedir=* | --localstatedi=* | --localstated=* \
-  | --localstate=* | --localstat=* | --localsta=* | --localst=* \
-  | --locals=* | --local=* | --loca=* | --loc=* | --lo=*)
+  | --localstate=* | --localstat=* | --localsta=* | --localst=* | --locals=*)
     localstatedir=$ac_optarg ;;
 
   -mandir | --mandir | --mandi | --mand | --man | --ma | --m)
     ac_prev=mandir ;;
   -mandir=* | --mandir=* | --mandi=* | --mand=* | --man=* | --ma=* | --m=*)
     mandir=$ac_optarg ;;
@@ -531,12 +934,22 @@
   | --program-transform=* | --program-transfor=* \
   | --program-transfo=* | --program-transf=* \
   | --program-trans=* | --program-tran=* \
   | --progr-tra=* | --program-tr=* | --program-t=*)
     program_transform_name=$ac_optarg ;;
 
+  -pdfdir | --pdfdir | --pdfdi | --pdfd | --pdf | --pd)
+    ac_prev=pdfdir ;;
+  -pdfdir=* | --pdfdir=* | --pdfdi=* | --pdfd=* | --pdf=* | --pd=*)
+    pdfdir=$ac_optarg ;;
+
+  -psdir | --psdir | --psdi | --psd | --ps)
+    ac_prev=psdir ;;
+  -psdir=* | --psdir=* | --psdi=* | --psd=* | --ps=*)
+    psdir=$ac_optarg ;;
+
   -q | -quiet | --quiet | --quie | --qui | --qu | --q \
   | -silent | --silent | --silen | --sile | --sil)
     silent=yes ;;
 
   -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
     ac_prev=sbindir ;;
@@ -587,26 +1000,22 @@
     ac_package=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_package" : ".*[^-_$as_cr_alnum]" >/dev/null &&
       { echo "$as_me: error: invalid package name: $ac_package" >&2
    { (exit 1); exit 1; }; }
     ac_package=`echo $ac_package| sed 's/-/_/g'`
-    case $ac_option in
-      *=*) ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`;;
-      *) ac_optarg=yes ;;
-    esac
-    eval "with_$ac_package='$ac_optarg'" ;;
+    eval with_$ac_package=\$ac_optarg ;;
 
   -without-* | --without-*)
     ac_package=`expr "x$ac_option" : 'x-*without-\(.*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_package" : ".*[^-_$as_cr_alnum]" >/dev/null &&
       { echo "$as_me: error: invalid package name: $ac_package" >&2
    { (exit 1); exit 1; }; }
     ac_package=`echo $ac_package | sed 's/-/_/g'`
-    eval "with_$ac_package=no" ;;
+    eval with_$ac_package=no ;;
 
   --x)
     # Obsolete; use --with-x.
     with_x=yes ;;
 
   -x-includes | --x-includes | --x-include | --x-includ | --x-inclu \
@@ -631,14 +1040,13 @@
   *=*)
     ac_envvar=`expr "x$ac_option" : 'x\([^=]*\)='`
     # Reject names that are not valid shell variable names.
     expr "x$ac_envvar" : ".*[^_$as_cr_alnum]" >/dev/null &&
       { echo "$as_me: error: invalid variable name: $ac_envvar" >&2
    { (exit 1); exit 1; }; }
-    ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`
-    eval "$ac_envvar='$ac_optarg'"
+    eval $ac_envvar=\$ac_optarg
     export $ac_envvar ;;
 
   *)
     # FIXME: should be removed in autoconf 3.0.
     echo "$as_me: WARNING: you should use --build, --host, --target" >&2
     expr "x$ac_option" : ".*[^-._$as_cr_alnum]" >/dev/null &&
@@ -652,33 +1060,25 @@
 if test -n "$ac_prev"; then
   ac_option=--`echo $ac_prev | sed 's/_/-/g'`
   { echo "$as_me: error: missing argument to $ac_option" >&2
    { (exit 1); exit 1; }; }
 fi
 
-# Be sure to have absolute paths.
-for ac_var in exec_prefix prefix
-do
-  eval ac_val=$`echo $ac_var`
-  case $ac_val in
-    [\\/$]* | ?:[\\/]* | NONE | '' ) ;;
-    *)  { echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
-   { (exit 1); exit 1; }; };;
-  esac
-done
-
-# Be sure to have absolute paths.
-for ac_var in bindir sbindir libexecdir datadir sysconfdir sharedstatedir \
-	      localstatedir libdir includedir oldincludedir infodir mandir
+# Be sure to have absolute directory names.
+for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
+		datadir sysconfdir sharedstatedir localstatedir includedir \
+		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
+		libdir localedir mandir
 do
-  eval ac_val=$`echo $ac_var`
+  eval ac_val=\$$ac_var
   case $ac_val in
-    [\\/$]* | ?:[\\/]* ) ;;
-    *)  { echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
-   { (exit 1); exit 1; }; };;
+    [\\/$]* | ?:[\\/]* )  continue;;
+    NONE | '' ) case $ac_var in *prefix ) continue;; esac;;
   esac
+  { echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
+   { (exit 1); exit 1; }; }
 done
 
 # There might be people who depend on the old broken behavior: `$host'
 # used to hold the argument of --host etc.
 # FIXME: To remove some day.
 build=$build_alias
@@ -699,81 +1099,83 @@
 ac_tool_prefix=
 test -n "$host_alias" && ac_tool_prefix=$host_alias-
 
 test "$silent" = yes && exec 6>/dev/null
 
 
+ac_pwd=`pwd` && test -n "$ac_pwd" &&
+ac_ls_di=`ls -di .` &&
+ac_pwd_ls_di=`cd "$ac_pwd" && ls -di .` ||
+  { echo "$as_me: error: Working directory cannot be determined" >&2
+   { (exit 1); exit 1; }; }
+test "X$ac_ls_di" = "X$ac_pwd_ls_di" ||
+  { echo "$as_me: error: pwd does not report name of working directory" >&2
+   { (exit 1); exit 1; }; }
+
+
 # Find the source files, if location was not specified.
 if test -z "$srcdir"; then
   ac_srcdir_defaulted=yes
-  # Try the directory containing this script, then its parent.
-  ac_confdir=`(dirname "$0") 2>/dev/null ||
+  # Try the directory containing this script, then the parent directory.
+  ac_confdir=`$as_dirname -- "$0" ||
 $as_expr X"$0" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
 	 X"$0" : 'X\(//\)[^/]' \| \
 	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)' \| \
-	 .     : '\(.\)' 2>/dev/null ||
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
 echo X"$0" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
   	  s/.*/./; q'`
   srcdir=$ac_confdir
-  if test ! -r $srcdir/$ac_unique_file; then
+  if test ! -r "$srcdir/$ac_unique_file"; then
     srcdir=..
   fi
 else
   ac_srcdir_defaulted=no
 fi
-if test ! -r $srcdir/$ac_unique_file; then
-  if test "$ac_srcdir_defaulted" = yes; then
-    { echo "$as_me: error: cannot find sources ($ac_unique_file) in $ac_confdir or .." >&2
-   { (exit 1); exit 1; }; }
-  else
-    { echo "$as_me: error: cannot find sources ($ac_unique_file) in $srcdir" >&2
-   { (exit 1); exit 1; }; }
-  fi
-fi
-(cd $srcdir && test -r ./$ac_unique_file) 2>/dev/null ||
-  { echo "$as_me: error: sources are in $srcdir, but \`cd $srcdir' does not work" >&2
-   { (exit 1); exit 1; }; }
-srcdir=`echo "$srcdir" | sed 's%\([^\\/]\)[\\/]*$%\1%'`
-ac_env_build_alias_set=${build_alias+set}
-ac_env_build_alias_value=$build_alias
-ac_cv_env_build_alias_set=${build_alias+set}
-ac_cv_env_build_alias_value=$build_alias
-ac_env_host_alias_set=${host_alias+set}
-ac_env_host_alias_value=$host_alias
-ac_cv_env_host_alias_set=${host_alias+set}
-ac_cv_env_host_alias_value=$host_alias
-ac_env_target_alias_set=${target_alias+set}
-ac_env_target_alias_value=$target_alias
-ac_cv_env_target_alias_set=${target_alias+set}
-ac_cv_env_target_alias_value=$target_alias
-ac_env_CC_set=${CC+set}
-ac_env_CC_value=$CC
-ac_cv_env_CC_set=${CC+set}
-ac_cv_env_CC_value=$CC
-ac_env_CFLAGS_set=${CFLAGS+set}
-ac_env_CFLAGS_value=$CFLAGS
-ac_cv_env_CFLAGS_set=${CFLAGS+set}
-ac_cv_env_CFLAGS_value=$CFLAGS
-ac_env_LDFLAGS_set=${LDFLAGS+set}
-ac_env_LDFLAGS_value=$LDFLAGS
-ac_cv_env_LDFLAGS_set=${LDFLAGS+set}
-ac_cv_env_LDFLAGS_value=$LDFLAGS
-ac_env_CPPFLAGS_set=${CPPFLAGS+set}
-ac_env_CPPFLAGS_value=$CPPFLAGS
-ac_cv_env_CPPFLAGS_set=${CPPFLAGS+set}
-ac_cv_env_CPPFLAGS_value=$CPPFLAGS
-ac_env_CPP_set=${CPP+set}
-ac_env_CPP_value=$CPP
-ac_cv_env_CPP_set=${CPP+set}
-ac_cv_env_CPP_value=$CPP
-
+if test ! -r "$srcdir/$ac_unique_file"; then
+  test "$ac_srcdir_defaulted" = yes && srcdir="$ac_confdir or .."
+  { echo "$as_me: error: cannot find sources ($ac_unique_file) in $srcdir" >&2
+   { (exit 1); exit 1; }; }
+fi
+ac_msg="sources are in $srcdir, but \`cd $srcdir' does not work"
+ac_abs_confdir=`(
+	cd "$srcdir" && test -r "./$ac_unique_file" || { echo "$as_me: error: $ac_msg" >&2
+   { (exit 1); exit 1; }; }
+	pwd)`
+# When building in place, set srcdir=.
+if test "$ac_abs_confdir" = "$ac_pwd"; then
+  srcdir=.
+fi
+# Remove unnecessary trailing slashes from srcdir.
+# Double slashes in file names in object file debugging info
+# mess up M-x gdb in Emacs.
+case $srcdir in
+*/) srcdir=`expr "X$srcdir" : 'X\(.*[^/]\)' \| "X$srcdir" : 'X\(.*\)'`;;
+esac
+for ac_var in $ac_precious_vars; do
+  eval ac_env_${ac_var}_set=\${${ac_var}+set}
+  eval ac_env_${ac_var}_value=\$${ac_var}
+  eval ac_cv_env_${ac_var}_set=\${${ac_var}+set}
+  eval ac_cv_env_${ac_var}_value=\$${ac_var}
+done
+
 #
 # Report the --help message.
 #
 if test "$ac_init_help" = "long"; then
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
@@ -795,15 +1197,12 @@
   -q, --quiet, --silent   do not print \`checking...' messages
       --cache-file=FILE   cache test results in FILE [disabled]
   -C, --config-cache      alias for \`--cache-file=config.cache'
   -n, --no-create         do not create output files
       --srcdir=DIR        find the sources in DIR [configure dir or \`..']
 
-_ACEOF
-
-  cat <<_ACEOF
 Installation directories:
   --prefix=PREFIX         install architecture-independent files in PREFIX
 			  [$ac_default_prefix]
   --exec-prefix=EPREFIX   install architecture-dependent files in EPREFIX
 			  [PREFIX]
 
@@ -815,21 +1214,28 @@
 For better control, use the options below.
 
 Fine tuning of the installation directories:
   --bindir=DIR           user executables [EPREFIX/bin]
   --sbindir=DIR          system admin executables [EPREFIX/sbin]
   --libexecdir=DIR       program executables [EPREFIX/libexec]
-  --datadir=DIR          read-only architecture-independent data [PREFIX/share]
   --sysconfdir=DIR       read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR   modifiable architecture-independent data [PREFIX/com]
   --localstatedir=DIR    modifiable single-machine data [PREFIX/var]
   --libdir=DIR           object code libraries [EPREFIX/lib]
   --includedir=DIR       C header files [PREFIX/include]
   --oldincludedir=DIR    C header files for non-gcc [/usr/include]
-  --infodir=DIR          info documentation [PREFIX/info]
-  --mandir=DIR           man documentation [PREFIX/man]
+  --datarootdir=DIR      read-only arch.-independent data root [PREFIX/share]
+  --datadir=DIR          read-only architecture-independent data [DATAROOTDIR]
+  --infodir=DIR          info documentation [DATAROOTDIR/info]
+  --localedir=DIR        locale-dependent data [DATAROOTDIR/locale]
+  --mandir=DIR           man documentation [DATAROOTDIR/man]
+  --docdir=DIR           documentation root [DATAROOTDIR/doc/PACKAGE]
+  --htmldir=DIR          html documentation [DOCDIR]
+  --dvidir=DIR           dvi documentation [DOCDIR]
+  --pdfdir=DIR           pdf documentation [DOCDIR]
+  --psdir=DIR            ps documentation [DOCDIR]
 _ACEOF
 
   cat <<\_ACEOF
 
 System types:
   --build=BUILD     configure for building on BUILD [guessed]
@@ -858,138 +1264,109 @@
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
   --with-included-popt    use bundled popt library, not from system
   --with-rsync-path=PATH  set default --rsync-path to PATH (default: rsync)
   --with-rsyncd-conf=PATH set configuration file for rsync server to PATH
                           (default: /etc/rsyncd.conf)
   --with-rsh=CMD          set remote shell command to CMD (default: ssh)
+  --with-nobody-group=GROUP
+                          set the default unprivileged group (default nobody
+                          or nogroup)
 
 Some influential environment variables:
   CC          C compiler command
   CFLAGS      C compiler flags
   LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
               nonstandard directory <lib dir>
-  CPPFLAGS    C/C++ preprocessor flags, e.g. -I<include dir> if you have
-              headers in a nonstandard directory <include dir>
+  CPPFLAGS    C/C++/Objective C preprocessor flags, e.g. -I<include dir> if
+              you have headers in a nonstandard directory <include dir>
   CPP         C preprocessor
 
 Use these variables to override the choices made by `configure' or to help
 it to find libraries and programs with nonstandard names/locations.
 
 _ACEOF
+ac_status=$?
 fi
 
 if test "$ac_init_help" = "recursive"; then
   # If there are subdirs, report their specific --help.
-  ac_popdir=`pwd`
   for ac_dir in : $ac_subdirs_all; do test "x$ac_dir" = x: && continue
-    test -d $ac_dir || continue
+    test -d "$ac_dir" || continue
     ac_builddir=.
 
-if test "$ac_dir" != .; then
+case "$ac_dir" in
+.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+*)
   ac_dir_suffix=/`echo "$ac_dir" | sed 's,^\.[\\/],,'`
-  # A "../" for each directory in $ac_dir_suffix.
-  ac_top_builddir=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,../,g'`
-else
-  ac_dir_suffix= ac_top_builddir=
-fi
+  # A ".." for each directory in $ac_dir_suffix.
+  ac_top_builddir_sub=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,/..,g;s,/,,'`
+  case $ac_top_builddir_sub in
+  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+  esac ;;
+esac
+ac_abs_top_builddir=$ac_pwd
+ac_abs_builddir=$ac_pwd$ac_dir_suffix
+# for backward compatibility:
+ac_top_builddir=$ac_top_build_prefix
 
 case $srcdir in
-  .)  # No --srcdir option.  We are building in place.
+  .)  # We are building in place.
     ac_srcdir=.
-    if test -z "$ac_top_builddir"; then
-       ac_top_srcdir=.
-    else
-       ac_top_srcdir=`echo $ac_top_builddir | sed 's,/$,,'`
-    fi ;;
-  [\\/]* | ?:[\\/]* )  # Absolute path.
+    ac_top_srcdir=$ac_top_builddir_sub
+    ac_abs_top_srcdir=$ac_pwd ;;
+  [\\/]* | ?:[\\/]* )  # Absolute name.
     ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir ;;
-  *) # Relative path.
-    ac_srcdir=$ac_top_builddir$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_builddir$srcdir ;;
-esac
-
-# Do not use `cd foo && pwd` to compute absolute paths, because
-# the directories may not exist.
-case `pwd` in
-.) ac_abs_builddir="$ac_dir";;
-*)
-  case "$ac_dir" in
-  .) ac_abs_builddir=`pwd`;;
-  [\\/]* | ?:[\\/]* ) ac_abs_builddir="$ac_dir";;
-  *) ac_abs_builddir=`pwd`/"$ac_dir";;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_top_builddir=${ac_top_builddir}.;;
-*)
-  case ${ac_top_builddir}. in
-  .) ac_abs_top_builddir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_top_builddir=${ac_top_builddir}.;;
-  *) ac_abs_top_builddir=$ac_abs_builddir/${ac_top_builddir}.;;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_srcdir=$ac_srcdir;;
-*)
-  case $ac_srcdir in
-  .) ac_abs_srcdir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_srcdir=$ac_srcdir;;
-  *) ac_abs_srcdir=$ac_abs_builddir/$ac_srcdir;;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_top_srcdir=$ac_top_srcdir;;
-*)
-  case $ac_top_srcdir in
-  .) ac_abs_top_srcdir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_top_srcdir=$ac_top_srcdir;;
-  *) ac_abs_top_srcdir=$ac_abs_builddir/$ac_top_srcdir;;
-  esac;;
+    ac_top_srcdir=$srcdir
+    ac_abs_top_srcdir=$srcdir ;;
+  *) # Relative name.
+    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+    ac_top_srcdir=$ac_top_build_prefix$srcdir
+    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
 esac
+ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
 
-    cd $ac_dir
-    # Check for guested configure; otherwise get Cygnus style configure.
-    if test -f $ac_srcdir/configure.gnu; then
-      echo
-      $SHELL $ac_srcdir/configure.gnu  --help=recursive
-    elif test -f $ac_srcdir/configure; then
-      echo
-      $SHELL $ac_srcdir/configure  --help=recursive
-    elif test -f $ac_srcdir/configure.ac ||
-	   test -f $ac_srcdir/configure.in; then
-      echo
-      $ac_configure --help
+    cd "$ac_dir" || { ac_status=$?; continue; }
+    # Check for guested configure.
+    if test -f "$ac_srcdir/configure.gnu"; then
+      echo &&
+      $SHELL "$ac_srcdir/configure.gnu" --help=recursive
+    elif test -f "$ac_srcdir/configure"; then
+      echo &&
+      $SHELL "$ac_srcdir/configure" --help=recursive
     else
       echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
-    fi
-    cd "$ac_popdir"
+    fi || ac_status=$?
+    cd "$ac_pwd" || { ac_status=$?; break; }
   done
 fi
 
-test -n "$ac_init_help" && exit 0
+test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
+configure
+generated by GNU Autoconf 2.60a
 
-Copyright (C) 2003 Free Software Foundation, Inc.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
+2002, 2003, 2004, 2005, 2006 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
-  exit 0
+  exit
 fi
-exec 5>config.log
-cat >&5 <<_ACEOF
+cat >config.log <<_ACEOF
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by $as_me, which was
-generated by GNU Autoconf 2.59.  Invocation command line was
+generated by GNU Autoconf 2.60a.  Invocation command line was
 
   $ $0 $@
 
 _ACEOF
+exec 5>>config.log
 {
 cat <<_ASUNAME
 ## --------- ##
 ## Platform. ##
 ## --------- ##
 
@@ -1002,13 +1379,13 @@
 /usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null || echo unknown`
 /bin/uname -X     = `(/bin/uname -X) 2>/dev/null     || echo unknown`
 
 /bin/arch              = `(/bin/arch) 2>/dev/null              || echo unknown`
 /usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null       || echo unknown`
 /usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null || echo unknown`
-hostinfo               = `(hostinfo) 2>/dev/null               || echo unknown`
+/usr/bin/hostinfo      = `(/usr/bin/hostinfo) 2>/dev/null      || echo unknown`
 /bin/machine           = `(/bin/machine) 2>/dev/null           || echo unknown`
 /usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null       || echo unknown`
 /bin/universe          = `(/bin/universe) 2>/dev/null          || echo unknown`
 
 _ASUNAME
 
@@ -1016,12 +1393,13 @@
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   echo "PATH: $as_dir"
 done
+IFS=$as_save_IFS
 
 } >&5
 
 cat >&5 <<_ACEOF
 
 
@@ -1037,24 +1415,23 @@
 # Strip out --silent because we don't want to record it for future runs.
 # Also quote any args containing shell meta-characters.
 # Make two passes to allow for proper duplicate-argument suppression.
 ac_configure_args=
 ac_configure_args0=
 ac_configure_args1=
-ac_sep=
 ac_must_keep_next=false
 for ac_pass in 1 2
 do
   for ac_arg
   do
     case $ac_arg in
     -no-create | --no-c* | -n | -no-recursion | --no-r*) continue ;;
     -q | -quiet | --quiet | --quie | --qui | --qu | --q \
     | -silent | --silent | --silen | --sile | --sil)
       continue ;;
-    *" "*|*"	"*|*[\[\]\~\#\$\^\&\*\(\)\{\}\\\|\;\<\>\?\"\']*)
+    *\'*)
       ac_arg=`echo "$ac_arg" | sed "s/'/'\\\\\\\\''/g"` ;;
     esac
     case $ac_pass in
     1) ac_configure_args0="$ac_configure_args0 '$ac_arg'" ;;
     2)
       ac_configure_args1="$ac_configure_args1 '$ac_arg'"
@@ -1070,110 +1447,126 @@
 	      "$ac_configure_args1"*" '$ac_arg' "* ) continue ;;
 	    esac
 	    ;;
 	  -* ) ac_must_keep_next=true ;;
 	esac
       fi
-      ac_configure_args="$ac_configure_args$ac_sep'$ac_arg'"
-      # Get rid of the leading space.
-      ac_sep=" "
+      ac_configure_args="$ac_configure_args '$ac_arg'"
       ;;
     esac
   done
 done
 $as_unset ac_configure_args0 || test "${ac_configure_args0+set}" != set || { ac_configure_args0=; export ac_configure_args0; }
 $as_unset ac_configure_args1 || test "${ac_configure_args1+set}" != set || { ac_configure_args1=; export ac_configure_args1; }
 
 # When interrupted or exit'd, cleanup temporary files, and complete
 # config.log.  We remove comments because anyway the quotes in there
 # would cause problems or look ugly.
-# WARNING: Be sure not to use single quotes in there, as some shells,
-# such as our DU 5.0 friend, will then `close' the trap.
+# WARNING: Use '\'' to represent an apostrophe within the trap.
+# WARNING: Do not start the trap code with a newline, due to a FreeBSD 4.0 bug.
 trap 'exit_status=$?
   # Save into config.log some information that might help in debugging.
   {
     echo
 
     cat <<\_ASBOX
 ## ---------------- ##
 ## Cache variables. ##
 ## ---------------- ##
 _ASBOX
     echo
     # The following way of writing the cache mishandles newlines in values,
-{
+(
+  for ac_var in `(set) 2>&1 | sed -n '\''s/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'\''`; do
+    eval ac_val=\$$ac_var
+    case $ac_val in #(
+    *${as_nl}*)
+      case $ac_var in #(
+      *_cv_*) { echo "$as_me:$LINENO: WARNING: Cache variable $ac_var contains a newline." >&5
+echo "$as_me: WARNING: Cache variable $ac_var contains a newline." >&2;} ;;
+      esac
+      case $ac_var in #(
+      _ | IFS | as_nl) ;; #(
+      *) $as_unset $ac_var ;;
+      esac ;;
+    esac
+  done
   (set) 2>&1 |
-    case `(ac_space='"'"' '"'"'; set | grep ac_space) 2>&1` in
-    *ac_space=\ *)
+    case $as_nl`(ac_space='\'' '\''; set) 2>&1` in #(
+    *${as_nl}ac_space=\ *)
       sed -n \
-	"s/'"'"'/'"'"'\\\\'"'"''"'"'/g;
-	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='"'"'\\2'"'"'/p"
-      ;;
+	"s/'\''/'\''\\\\'\'''\''/g;
+	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\''\\2'\''/p"
+      ;; #(
     *)
-      sed -n \
-	"s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1=\\2/p"
+      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
       ;;
-    esac;
-}
+    esac |
+    sort
+)
     echo
 
     cat <<\_ASBOX
 ## ----------------- ##
 ## Output variables. ##
 ## ----------------- ##
 _ASBOX
     echo
     for ac_var in $ac_subst_vars
     do
-      eval ac_val=$`echo $ac_var`
-      echo "$ac_var='"'"'$ac_val'"'"'"
+      eval ac_val=\$$ac_var
+      case $ac_val in
+      *\'\''*) ac_val=`echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+      esac
+      echo "$ac_var='\''$ac_val'\''"
     done | sort
     echo
 
     if test -n "$ac_subst_files"; then
       cat <<\_ASBOX
-## ------------- ##
-## Output files. ##
-## ------------- ##
+## ------------------- ##
+## File substitutions. ##
+## ------------------- ##
 _ASBOX
       echo
       for ac_var in $ac_subst_files
       do
-	eval ac_val=$`echo $ac_var`
-	echo "$ac_var='"'"'$ac_val'"'"'"
+	eval ac_val=\$$ac_var
+	case $ac_val in
+	*\'\''*) ac_val=`echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+	esac
+	echo "$ac_var='\''$ac_val'\''"
       done | sort
       echo
     fi
 
     if test -s confdefs.h; then
       cat <<\_ASBOX
 ## ----------- ##
 ## confdefs.h. ##
 ## ----------- ##
 _ASBOX
       echo
-      sed "/^$/d" confdefs.h | sort
+      cat confdefs.h
       echo
     fi
     test "$ac_signal" != 0 &&
       echo "$as_me: caught signal $ac_signal"
     echo "$as_me: exit $exit_status"
   } >&5
-  rm -f core *.core &&
-  rm -rf conftest* confdefs* conf$$* $ac_clean_files &&
+  rm -f core *.core core.conftest.* &&
+    rm -f -r conftest* confdefs* conf$$* $ac_clean_files &&
     exit $exit_status
-     ' 0
+' 0
 for ac_signal in 1 2 13 15; do
   trap 'ac_signal='$ac_signal'; { (exit 1); exit 1; }' $ac_signal
 done
 ac_signal=0
 
 # confdefs.h avoids OS command line length limits that DEFS can exceed.
-rm -rf conftest* confdefs.h
-# AIX cpp loses on an empty file, so make sure it contains at least a newline.
-echo >confdefs.h
+rm -f -r conftest* confdefs.h
 
 # Predefined preprocessor variables.
 
 cat >>confdefs.h <<_ACEOF
 #define PACKAGE_NAME "$PACKAGE_NAME"
 _ACEOF
@@ -1198,20 +1591,23 @@
 #define PACKAGE_BUGREPORT "$PACKAGE_BUGREPORT"
 _ACEOF
 
 
 # Let the site file select an alternate cache file if it wants to.
 # Prefer explicitly selected file to automatically selected ones.
-if test -z "$CONFIG_SITE"; then
-  if test "x$prefix" != xNONE; then
-    CONFIG_SITE="$prefix/share/config.site $prefix/etc/config.site"
-  else
-    CONFIG_SITE="$ac_default_prefix/share/config.site $ac_default_prefix/etc/config.site"
-  fi
+if test -n "$CONFIG_SITE"; then
+  set x "$CONFIG_SITE"
+elif test "x$prefix" != xNONE; then
+  set x "$prefix/share/config.site" "$prefix/etc/config.site"
+else
+  set x "$ac_default_prefix/share/config.site" \
+	"$ac_default_prefix/etc/config.site"
 fi
-for ac_site_file in $CONFIG_SITE; do
+shift
+for ac_site_file
+do
   if test -r "$ac_site_file"; then
     { echo "$as_me:$LINENO: loading site script $ac_site_file" >&5
 echo "$as_me: loading site script $ac_site_file" >&6;}
     sed 's/^/| /' "$ac_site_file" >&5
     . "$ac_site_file"
   fi
@@ -1221,31 +1617,30 @@
   # Some versions of bash will fail to source /dev/null (special
   # files actually), so we avoid doing that.
   if test -f "$cache_file"; then
     { echo "$as_me:$LINENO: loading cache $cache_file" >&5
 echo "$as_me: loading cache $cache_file" >&6;}
     case $cache_file in
-      [\\/]* | ?:[\\/]* ) . $cache_file;;
-      *)                      . ./$cache_file;;
+      [\\/]* | ?:[\\/]* ) . "$cache_file";;
+      *)                      . "./$cache_file";;
     esac
   fi
 else
   { echo "$as_me:$LINENO: creating cache $cache_file" >&5
 echo "$as_me: creating cache $cache_file" >&6;}
   >$cache_file
 fi
 
 # Check that the precious variables saved in the cache have kept the same
 # value.
 ac_cache_corrupted=false
-for ac_var in `(set) 2>&1 |
-	       sed -n 's/^ac_env_\([a-zA-Z_0-9]*\)_set=.*/\1/p'`; do
+for ac_var in $ac_precious_vars; do
   eval ac_old_set=\$ac_cv_env_${ac_var}_set
   eval ac_new_set=\$ac_env_${ac_var}_set
-  eval ac_old_val="\$ac_cv_env_${ac_var}_value"
-  eval ac_new_val="\$ac_env_${ac_var}_value"
+  eval ac_old_val=\$ac_cv_env_${ac_var}_value
+  eval ac_new_val=\$ac_env_${ac_var}_value
   case $ac_old_set,$ac_new_set in
     set,)
       { echo "$as_me:$LINENO: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&5
 echo "$as_me: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&2;}
       ac_cache_corrupted=: ;;
     ,set)
@@ -1264,14 +1659,13 @@
 	ac_cache_corrupted=:
       fi;;
   esac
   # Pass precious variables to config.status.
   if test "$ac_new_set" = set; then
     case $ac_new_val in
-    *" "*|*"	"*|*[\[\]\~\#\$\^\&\*\(\)\{\}\\\|\;\<\>\?\"\']*)
-      ac_arg=$ac_var=`echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
+    *\'*) ac_arg=$ac_var=`echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
     *) ac_arg=$ac_var=$ac_new_val ;;
     esac
     case " $ac_configure_args " in
       *" '$ac_arg' "*) ;; # Avoid dups.  Use of quotes ensures accuracy.
       *) ac_configure_args="$ac_configure_args '$ac_arg'" ;;
     esac
@@ -1282,18 +1676,12 @@
 echo "$as_me: error: changes in the environment can compromise the build" >&2;}
   { { echo "$as_me:$LINENO: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&5
 echo "$as_me: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&2;}
    { (exit 1); exit 1; }; }
 fi
 
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
 
 
 
 
 
 
@@ -1304,20 +1692,25 @@
 
 
 
 
 
 
+ac_ext=c
+ac_cpp='$CPP $CPPFLAGS'
+ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 
 
-          ac_config_headers="$ac_config_headers config.h"
+ac_config_headers="$ac_config_headers config.h"
 
 
 
-RSYNC_VERSION=2.6.8
+RSYNC_VERSION=2.6.9
 
 { echo "$as_me:$LINENO: Configuring rsync $RSYNC_VERSION" >&5
 echo "$as_me: Configuring rsync $RSYNC_VERSION" >&6;}
 
 
 cat >>confdefs.h <<_ACEOF
@@ -1325,110 +1718,160 @@
 _ACEOF
 
 
 LDFLAGS=${LDFLAGS-""}
 
 ac_aux_dir=
-for ac_dir in $srcdir $srcdir/.. $srcdir/../..; do
-  if test -f $ac_dir/install-sh; then
+for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
+  if test -f "$ac_dir/install-sh"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/install-sh -c"
     break
-  elif test -f $ac_dir/install.sh; then
+  elif test -f "$ac_dir/install.sh"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/install.sh -c"
     break
-  elif test -f $ac_dir/shtool; then
+  elif test -f "$ac_dir/shtool"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/shtool install -c"
     break
   fi
 done
 if test -z "$ac_aux_dir"; then
-  { { echo "$as_me:$LINENO: error: cannot find install-sh or install.sh in $srcdir $srcdir/.. $srcdir/../.." >&5
-echo "$as_me: error: cannot find install-sh or install.sh in $srcdir $srcdir/.. $srcdir/../.." >&2;}
+  { { echo "$as_me:$LINENO: error: cannot find install-sh or install.sh in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" >&5
+echo "$as_me: error: cannot find install-sh or install.sh in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" >&2;}
    { (exit 1); exit 1; }; }
 fi
-ac_config_guess="$SHELL $ac_aux_dir/config.guess"
-ac_config_sub="$SHELL $ac_aux_dir/config.sub"
-ac_configure="$SHELL $ac_aux_dir/configure" # This should be Cygnus configure.
+
+# These three variables are undocumented and unsupported,
+# and are intended to be withdrawn in a future Autoconf release.
+# They can cause serious problems if a builder's source tree is in a directory
+# whose full name contains unusual characters.
+ac_config_guess="$SHELL $ac_aux_dir/config.guess"  # Please don't use this var.
+ac_config_sub="$SHELL $ac_aux_dir/config.sub"  # Please don't use this var.
+ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
+
 
 # Make sure we can run config.sub.
-$ac_config_sub sun4 >/dev/null 2>&1 ||
-  { { echo "$as_me:$LINENO: error: cannot run $ac_config_sub" >&5
-echo "$as_me: error: cannot run $ac_config_sub" >&2;}
+$SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
+  { { echo "$as_me:$LINENO: error: cannot run $SHELL $ac_aux_dir/config.sub" >&5
+echo "$as_me: error: cannot run $SHELL $ac_aux_dir/config.sub" >&2;}
    { (exit 1); exit 1; }; }
 
-echo "$as_me:$LINENO: checking build system type" >&5
-echo $ECHO_N "checking build system type... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking build system type" >&5
+echo $ECHO_N "checking build system type... $ECHO_C" >&6; }
 if test "${ac_cv_build+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  ac_cv_build_alias=$build_alias
-test -z "$ac_cv_build_alias" &&
-  ac_cv_build_alias=`$ac_config_guess`
-test -z "$ac_cv_build_alias" &&
+  ac_build_alias=$build_alias
+test "x$ac_build_alias" = x &&
+  ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
+test "x$ac_build_alias" = x &&
   { { echo "$as_me:$LINENO: error: cannot guess build type; you must specify one" >&5
 echo "$as_me: error: cannot guess build type; you must specify one" >&2;}
    { (exit 1); exit 1; }; }
-ac_cv_build=`$ac_config_sub $ac_cv_build_alias` ||
-  { { echo "$as_me:$LINENO: error: $ac_config_sub $ac_cv_build_alias failed" >&5
-echo "$as_me: error: $ac_config_sub $ac_cv_build_alias failed" >&2;}
+ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
+  { { echo "$as_me:$LINENO: error: $SHELL $ac_aux_dir/config.sub $ac_build_alias failed" >&5
+echo "$as_me: error: $SHELL $ac_aux_dir/config.sub $ac_build_alias failed" >&2;}
    { (exit 1); exit 1; }; }
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_build" >&5
-echo "${ECHO_T}$ac_cv_build" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_build" >&5
+echo "${ECHO_T}$ac_cv_build" >&6; }
+case $ac_cv_build in
+*-*-*) ;;
+*) { { echo "$as_me:$LINENO: error: invalid value of canonical build" >&5
+echo "$as_me: error: invalid value of canonical build" >&2;}
+   { (exit 1); exit 1; }; };;
+esac
 build=$ac_cv_build
-build_cpu=`echo $ac_cv_build | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\1/'`
-build_vendor=`echo $ac_cv_build | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\2/'`
-build_os=`echo $ac_cv_build | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\3/'`
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_build
+shift
+build_cpu=$1
+build_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+build_os=$*
+IFS=$ac_save_IFS
+case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
 
 
-echo "$as_me:$LINENO: checking host system type" >&5
-echo $ECHO_N "checking host system type... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking host system type" >&5
+echo $ECHO_N "checking host system type... $ECHO_C" >&6; }
 if test "${ac_cv_host+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  ac_cv_host_alias=$host_alias
-test -z "$ac_cv_host_alias" &&
-  ac_cv_host_alias=$ac_cv_build_alias
-ac_cv_host=`$ac_config_sub $ac_cv_host_alias` ||
-  { { echo "$as_me:$LINENO: error: $ac_config_sub $ac_cv_host_alias failed" >&5
-echo "$as_me: error: $ac_config_sub $ac_cv_host_alias failed" >&2;}
+  if test "x$host_alias" = x; then
+  ac_cv_host=$ac_cv_build
+else
+  ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
+    { { echo "$as_me:$LINENO: error: $SHELL $ac_aux_dir/config.sub $host_alias failed" >&5
+echo "$as_me: error: $SHELL $ac_aux_dir/config.sub $host_alias failed" >&2;}
    { (exit 1); exit 1; }; }
+fi
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_host" >&5
-echo "${ECHO_T}$ac_cv_host" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_host" >&5
+echo "${ECHO_T}$ac_cv_host" >&6; }
+case $ac_cv_host in
+*-*-*) ;;
+*) { { echo "$as_me:$LINENO: error: invalid value of canonical host" >&5
+echo "$as_me: error: invalid value of canonical host" >&2;}
+   { (exit 1); exit 1; }; };;
+esac
 host=$ac_cv_host
-host_cpu=`echo $ac_cv_host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\1/'`
-host_vendor=`echo $ac_cv_host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\2/'`
-host_os=`echo $ac_cv_host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\3/'`
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_host
+shift
+host_cpu=$1
+host_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+host_os=$*
+IFS=$ac_save_IFS
+case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
 
 
-echo "$as_me:$LINENO: checking target system type" >&5
-echo $ECHO_N "checking target system type... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking target system type" >&5
+echo $ECHO_N "checking target system type... $ECHO_C" >&6; }
 if test "${ac_cv_target+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  ac_cv_target_alias=$target_alias
-test "x$ac_cv_target_alias" = "x" &&
-  ac_cv_target_alias=$ac_cv_host_alias
-ac_cv_target=`$ac_config_sub $ac_cv_target_alias` ||
-  { { echo "$as_me:$LINENO: error: $ac_config_sub $ac_cv_target_alias failed" >&5
-echo "$as_me: error: $ac_config_sub $ac_cv_target_alias failed" >&2;}
+  if test "x$target_alias" = x; then
+  ac_cv_target=$ac_cv_host
+else
+  ac_cv_target=`$SHELL "$ac_aux_dir/config.sub" $target_alias` ||
+    { { echo "$as_me:$LINENO: error: $SHELL $ac_aux_dir/config.sub $target_alias failed" >&5
+echo "$as_me: error: $SHELL $ac_aux_dir/config.sub $target_alias failed" >&2;}
    { (exit 1); exit 1; }; }
+fi
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_target" >&5
-echo "${ECHO_T}$ac_cv_target" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_target" >&5
+echo "${ECHO_T}$ac_cv_target" >&6; }
+case $ac_cv_target in
+*-*-*) ;;
+*) { { echo "$as_me:$LINENO: error: invalid value of canonical target" >&5
+echo "$as_me: error: invalid value of canonical target" >&2;}
+   { (exit 1); exit 1; }; };;
+esac
 target=$ac_cv_target
-target_cpu=`echo $ac_cv_target | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\1/'`
-target_vendor=`echo $ac_cv_target | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\2/'`
-target_os=`echo $ac_cv_target | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\3/'`
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_target
+shift
+target_cpu=$1
+target_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+target_os=$*
+IFS=$ac_save_IFS
+case $target_os in *\ *) target_os=`echo "$target_os" | sed 's/ /-/g'`;; esac
 
 
 # The aliases save the names the user supplied, while $host etc.
 # will get canonicalized.
 test -n "$target_alias" &&
   test "$program_prefix$program_suffix$program_transform_name" = \
@@ -1440,174 +1883,151 @@
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}gcc", so it can be a program name with args.
 set dummy ${ac_tool_prefix}gcc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { echo "$as_me:$LINENO: result: $CC" >&5
+echo "${ECHO_T}$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
+
 fi
 if test -z "$ac_cv_prog_CC"; then
   ac_ct_CC=$CC
   # Extract the first word of "gcc", so it can be a program name with args.
 set dummy gcc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$ac_ct_CC"; then
   ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_CC="gcc"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 ac_ct_CC=$ac_cv_prog_ac_ct_CC
 if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
+  { echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
+echo "${ECHO_T}$ac_ct_CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
-  CC=$ac_ct_CC
+  if test "x$ac_ct_CC" = x; then
+    CC=""
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ echo "$as_me:$LINENO: WARNING: In the future, Autoconf will not detect cross-tools
+whose name does not start with the host triplet.  If you think this
+configuration is useful to you, please write to autoconf@gnu.org." >&5
+echo "$as_me: WARNING: In the future, Autoconf will not detect cross-tools
+whose name does not start with the host triplet.  If you think this
+configuration is useful to you, please write to autoconf@gnu.org." >&2;}
+ac_tool_warned=yes ;;
+esac
+    CC=$ac_ct_CC
+  fi
 else
   CC="$ac_cv_prog_CC"
 fi
 
 if test -z "$CC"; then
-  if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
+          if test -n "$ac_tool_prefix"; then
+    # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
 set dummy ${ac_tool_prefix}cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
-else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
-fi
-
-fi
-if test -z "$ac_cv_prog_CC"; then
-  ac_ct_CC=$CC
-  # Extract the first word of "cc", so it can be a program name with args.
-set dummy cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  if test -n "$ac_ct_CC"; then
-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
-    ac_cv_prog_ac_ct_CC="cc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-done
-
-fi
-fi
-ac_ct_CC=$ac_cv_prog_ac_ct_CC
-if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
+  { echo "$as_me:$LINENO: result: $CC" >&5
+echo "${ECHO_T}$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
-  CC=$ac_ct_CC
-else
-  CC="$ac_cv_prog_CC"
-fi
 
+  fi
 fi
 if test -z "$CC"; then
   # Extract the first word of "cc", so it can be a program name with args.
 set dummy cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
@@ -1615,23 +2035,24 @@
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
      fi
     ac_cv_prog_CC="cc"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 if test $ac_prog_rejected = yes; then
   # We found a bogon in the path, so make sure we never use it.
   set dummy $ac_cv_prog_CC
   shift
   if test $# != 0; then
@@ -1643,132 +2064,165 @@
   fi
 fi
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { echo "$as_me:$LINENO: result: $CC" >&5
+echo "${ECHO_T}$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
+
 fi
 if test -z "$CC"; then
   if test -n "$ac_tool_prefix"; then
-  for ac_prog in cl
+  for ac_prog in cl.exe
   do
     # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
 set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { echo "$as_me:$LINENO: result: $CC" >&5
+echo "${ECHO_T}$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
+
     test -n "$CC" && break
   done
 fi
 if test -z "$CC"; then
   ac_ct_CC=$CC
-  for ac_prog in cl
+  for ac_prog in cl.exe
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$ac_ct_CC"; then
   ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 ac_ct_CC=$ac_cv_prog_ac_ct_CC
 if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
+  { echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
+echo "${ECHO_T}$ac_ct_CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
+
   test -n "$ac_ct_CC" && break
 done
 
-  CC=$ac_ct_CC
+  if test "x$ac_ct_CC" = x; then
+    CC=""
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ echo "$as_me:$LINENO: WARNING: In the future, Autoconf will not detect cross-tools
+whose name does not start with the host triplet.  If you think this
+configuration is useful to you, please write to autoconf@gnu.org." >&5
+echo "$as_me: WARNING: In the future, Autoconf will not detect cross-tools
+whose name does not start with the host triplet.  If you think this
+configuration is useful to you, please write to autoconf@gnu.org." >&2;}
+ac_tool_warned=yes ;;
+esac
+    CC=$ac_ct_CC
+  fi
 fi
 
 fi
 
 
 test -z "$CC" && { { echo "$as_me:$LINENO: error: no acceptable C compiler found in \$PATH
 See \`config.log' for more details." >&5
 echo "$as_me: error: no acceptable C compiler found in \$PATH
 See \`config.log' for more details." >&2;}
    { (exit 1); exit 1; }; }
 
 # Provide some information about the compiler.
-echo "$as_me:$LINENO:" \
-     "checking for C compiler version" >&5
+echo "$as_me:$LINENO: checking for C compiler version" >&5
 ac_compiler=`set X $ac_compile; echo $2`
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler --version </dev/null >&5\"") >&5
-  (eval $ac_compiler --version </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler --version >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compiler --version >&5") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -v </dev/null >&5\"") >&5
-  (eval $ac_compiler -v </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -v >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compiler -v >&5") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -V </dev/null >&5\"") >&5
-  (eval $ac_compiler -V </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -V >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compiler -V >&5") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
 
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -1787,77 +2241,109 @@
 _ACEOF
 ac_clean_files_save=$ac_clean_files
 ac_clean_files="$ac_clean_files a.out a.exe b.out"
 # Try to create an executable without -o first, disregard a.out.
 # It will help us diagnose broken compilers, and finding out an intuition
 # of exeext.
-echo "$as_me:$LINENO: checking for C compiler default output file name" >&5
-echo $ECHO_N "checking for C compiler default output file name... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for C compiler default output file name" >&5
+echo $ECHO_N "checking for C compiler default output file name... $ECHO_C" >&6; }
 ac_link_default=`echo "$ac_link" | sed 's/ -o *conftest[^ ]*//'`
-if { (eval echo "$as_me:$LINENO: \"$ac_link_default\"") >&5
-  (eval $ac_link_default) 2>&5
+#
+# List of possible output files, starting from the most likely.
+# The algorithm is not robust to junk in `.', hence go to wildcards (a.*)
+# only as a last resort.  b.out is created by i960 compilers.
+ac_files='a_out.exe a.exe conftest.exe a.out conftest a.* conftest.* b.out'
+#
+# The IRIX 6 linker writes into existing files which may not be
+# executable, retaining their permissions.  Remove them first so a
+# subsequent execution test works.
+ac_rmfiles=
+for ac_file in $ac_files
+do
+  case $ac_file in
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.o | *.obj ) ;;
+    * ) ac_rmfiles="$ac_rmfiles $ac_file";;
+  esac
+done
+rm -f $ac_rmfiles
+
+if { (ac_try="$ac_link_default"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link_default") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-  # Find the output, starting from the most likely.  This scheme is
-# not robust to junk in `.', hence go to wildcards (a.*) only as a last
-# resort.
-
-# Be careful to initialize this variable, since it used to be cached.
-# Otherwise an old cache value of `no' led to `EXEEXT = no' in a Makefile.
-ac_cv_exeext=
-# b.out is created by i960 compilers.
-for ac_file in a_out.exe a.exe conftest.exe a.out conftest a.* conftest.* b.out
+  # Autoconf-2.13 could set the ac_cv_exeext variable to `no'.
+# So ignore a value of `no', otherwise this would lead to `EXEEXT = no'
+# in a Makefile.  We should not override ac_cv_exeext if it was cached,
+# so that the user can short-circuit this test for compilers unknown to
+# Autoconf.
+for ac_file in $ac_files ''
 do
   test -f "$ac_file" || continue
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.o | *.obj )
-	;;
-    conftest.$ac_ext )
-	# This is the source file.
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.o | *.obj )
 	;;
     [ab].out )
 	# We found the default executable, but exeext='' is most
 	# certainly right.
 	break;;
     *.* )
-	ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-	# FIXME: I believe we export ac_cv_exeext for Libtool,
-	# but it would be cool to find out if it's true.  Does anybody
-	# maintain Libtool? --akim.
-	export ac_cv_exeext
+        if test "${ac_cv_exeext+set}" = set && test "$ac_cv_exeext" != no;
+	then :; else
+	   ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
+	fi
+	# We set ac_cv_exeext here because the later test for it is not
+	# safe: cross compilers may not add the suffix if given an `-o'
+	# argument, so we may need to know it at that point already.
+	# Even if this section looks crufty: it has the advantage of
+	# actually working.
 	break;;
     * )
 	break;;
   esac
 done
+test "$ac_cv_exeext" = no && ac_cv_exeext=
+
 else
+  ac_file=''
+fi
+
+{ echo "$as_me:$LINENO: result: $ac_file" >&5
+echo "${ECHO_T}$ac_file" >&6; }
+if test -z "$ac_file"; then
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 { { echo "$as_me:$LINENO: error: C compiler cannot create executables
 See \`config.log' for more details." >&5
 echo "$as_me: error: C compiler cannot create executables
 See \`config.log' for more details." >&2;}
    { (exit 77); exit 77; }; }
 fi
 
 ac_exeext=$ac_cv_exeext
-echo "$as_me:$LINENO: result: $ac_file" >&5
-echo "${ECHO_T}$ac_file" >&6
 
-# Check the compiler produces executables we can run.  If not, either
+# Check that the compiler produces executables we can run.  If not, either
 # the compiler is broken, or we cross compile.
-echo "$as_me:$LINENO: checking whether the C compiler works" >&5
-echo $ECHO_N "checking whether the C compiler works... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether the C compiler works" >&5
+echo $ECHO_N "checking whether the C compiler works... $ECHO_C" >&6; }
 # FIXME: These cross compiler hacks should be removed for Autoconf 3.0
 # If not cross compiling, check that we can run a simple program.
 if test "$cross_compiling" != yes; then
   if { ac_try='./$ac_file'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
     cross_compiling=no
   else
     if test "$cross_compiling" = maybe; then
@@ -1870,41 +2356,45 @@
 If you meant to cross compile, use \`--host'.
 See \`config.log' for more details." >&2;}
    { (exit 1); exit 1; }; }
     fi
   fi
 fi
-echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+{ echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
 
 rm -f a.out a.exe conftest$ac_cv_exeext b.out
 ac_clean_files=$ac_clean_files_save
-# Check the compiler produces executables we can run.  If not, either
+# Check that the compiler produces executables we can run.  If not, either
 # the compiler is broken, or we cross compile.
-echo "$as_me:$LINENO: checking whether we are cross compiling" >&5
-echo $ECHO_N "checking whether we are cross compiling... $ECHO_C" >&6
-echo "$as_me:$LINENO: result: $cross_compiling" >&5
-echo "${ECHO_T}$cross_compiling" >&6
-
-echo "$as_me:$LINENO: checking for suffix of executables" >&5
-echo $ECHO_N "checking for suffix of executables... $ECHO_C" >&6
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+{ echo "$as_me:$LINENO: checking whether we are cross compiling" >&5
+echo $ECHO_N "checking whether we are cross compiling... $ECHO_C" >&6; }
+{ echo "$as_me:$LINENO: result: $cross_compiling" >&5
+echo "${ECHO_T}$cross_compiling" >&6; }
+
+{ echo "$as_me:$LINENO: checking for suffix of executables" >&5
+echo $ECHO_N "checking for suffix of executables... $ECHO_C" >&6; }
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
   # If both `conftest.exe' and `conftest' are `present' (well, observable)
 # catch `conftest.exe'.  For instance with Cygwin, `ls conftest' will
 # work properly (i.e., refer to `conftest.exe'), while it won't with
 # `rm'.
 for ac_file in conftest.exe conftest conftest.*; do
   test -f "$ac_file" || continue
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.o | *.obj ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.o | *.obj ) ;;
     *.* ) ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-	  export ac_cv_exeext
 	  break;;
     * ) break;;
   esac
 done
 else
   { { echo "$as_me:$LINENO: error: cannot compute suffix of executables: cannot compile and link
@@ -1912,20 +2402,20 @@
 echo "$as_me: error: cannot compute suffix of executables: cannot compile and link
 See \`config.log' for more details." >&2;}
    { (exit 1); exit 1; }; }
 fi
 
 rm -f conftest$ac_cv_exeext
-echo "$as_me:$LINENO: result: $ac_cv_exeext" >&5
-echo "${ECHO_T}$ac_cv_exeext" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_exeext" >&5
+echo "${ECHO_T}$ac_cv_exeext" >&6; }
 
 rm -f conftest.$ac_ext
 EXEEXT=$ac_cv_exeext
 ac_exeext=$EXEEXT
-echo "$as_me:$LINENO: checking for suffix of object files" >&5
-echo $ECHO_N "checking for suffix of object files... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for suffix of object files" >&5
+echo $ECHO_N "checking for suffix of object files... $ECHO_C" >&6; }
 if test "${ac_cv_objext+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -1939,20 +2429,26 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.o conftest.obj
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-  for ac_file in `(ls conftest.o conftest.obj; ls conftest.*) 2>/dev/null`; do
+  for ac_file in conftest.o conftest.obj conftest.*; do
+  test -f "$ac_file" || continue;
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf ) ;;
     *) ac_cv_objext=`expr "$ac_file" : '.*\.\(.*\)'`
        break;;
   esac
 done
 else
   echo "$as_me: failed program was:" >&5
@@ -1964,18 +2460,18 @@
 See \`config.log' for more details." >&2;}
    { (exit 1); exit 1; }; }
 fi
 
 rm -f conftest.$ac_cv_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_objext" >&5
-echo "${ECHO_T}$ac_cv_objext" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_objext" >&5
+echo "${ECHO_T}$ac_cv_objext" >&6; }
 OBJEXT=$ac_cv_objext
 ac_objext=$OBJEXT
-echo "$as_me:$LINENO: checking whether we are using the GNU C compiler" >&5
-echo $ECHO_N "checking whether we are using the GNU C compiler... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether we are using the GNU C compiler" >&5
+echo $ECHO_N "checking whether we are using the GNU C compiler... $ECHO_C" >&6; }
 if test "${ac_cv_c_compiler_gnu+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -1992,55 +2488,183 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_compiler_gnu=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_compiler_gnu=no
+	ac_compiler_gnu=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 ac_cv_c_compiler_gnu=$ac_compiler_gnu
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_compiler_gnu" >&5
-echo "${ECHO_T}$ac_cv_c_compiler_gnu" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_c_compiler_gnu" >&5
+echo "${ECHO_T}$ac_cv_c_compiler_gnu" >&6; }
 GCC=`test $ac_compiler_gnu = yes && echo yes`
 ac_test_CFLAGS=${CFLAGS+set}
 ac_save_CFLAGS=$CFLAGS
-CFLAGS="-g"
-echo "$as_me:$LINENO: checking whether $CC accepts -g" >&5
-echo $ECHO_N "checking whether $CC accepts -g... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether $CC accepts -g" >&5
+echo $ECHO_N "checking whether $CC accepts -g... $ECHO_C" >&6; }
 if test "${ac_cv_prog_cc_g+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  cat >conftest.$ac_ext <<_ACEOF
+  ac_save_c_werror_flag=$ac_c_werror_flag
+   ac_c_werror_flag=yes
+   ac_cv_prog_cc_g=no
+   CFLAGS="-g"
+   cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  ac_cv_prog_cc_g=yes
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	CFLAGS=""
+      cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  :
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	ac_c_werror_flag=$ac_save_c_werror_flag
+	 CFLAGS="-g"
+	 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
@@ -2050,43 +2674,64 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_prog_cc_g=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_prog_cc_g=no
+
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+   ac_c_werror_flag=$ac_save_c_werror_flag
 fi
-echo "$as_me:$LINENO: result: $ac_cv_prog_cc_g" >&5
-echo "${ECHO_T}$ac_cv_prog_cc_g" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_prog_cc_g" >&5
+echo "${ECHO_T}$ac_cv_prog_cc_g" >&6; }
 if test "$ac_test_CFLAGS" = set; then
   CFLAGS=$ac_save_CFLAGS
 elif test $ac_cv_prog_cc_g = yes; then
   if test "$GCC" = yes; then
     CFLAGS="-g -O2"
   else
@@ -2096,18 +2741,18 @@
   if test "$GCC" = yes; then
     CFLAGS="-O2"
   else
     CFLAGS=
   fi
 fi
-echo "$as_me:$LINENO: checking for $CC option to accept ANSI C" >&5
-echo $ECHO_N "checking for $CC option to accept ANSI C... $ECHO_C" >&6
-if test "${ac_cv_prog_cc_stdc+set}" = set; then
+{ echo "$as_me:$LINENO: checking for $CC option to accept ISO C89" >&5
+echo $ECHO_N "checking for $CC option to accept ISO C89... $ECHO_C" >&6; }
+if test "${ac_cv_prog_cc_c89+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  ac_cv_prog_cc_stdc=no
+  ac_cv_prog_cc_c89=no
 ac_save_CC=$CC
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
@@ -2135,18 +2780,23 @@
   return s;
 }
 
 /* OSF 4.0 Compaq cc is some sort of almost-ANSI by default.  It has
    function prototypes and stuff, but not '\xHH' hex character constants.
    These don't provoke an error unfortunately, instead are silently treated
-   as 'x'.  The following induces an error, until -std1 is added to get
+   as 'x'.  The following induces an error, until -std is added to get
    proper ANSI mode.  Curiously '\x00'!='x' always comes out true, for an
    array size at least.  It's necessary to write '\x00'==0 to get something
-   that's true only with -std1.  */
+   that's true only with -std.  */
 int osf4_cc_array ['\x00' == 0 ? 1 : -1];
 
+/* IBM C 6 for AIX is almost-ANSI by default, but it replaces macro parameters
+   inside strings and character constants.  */
+#define FOO(x) 'x'
+int xlc6_cc_array[FOO(a) == 'x' ? 1 : -1];
+
 int test (int i, double x);
 struct s1 {int (*f) (int a);};
 struct s2 {int (*f) (double a);};
 int pairnames (int, char **, FILE *(*)(struct buf *, struct stat *, int), int, int);
 int argc;
 char **argv;
@@ -2155,220 +2805,93 @@
 {
 return f (e, argv, 0) != argv[0]  ||  f (e, argv, 1) != argv[1];
   ;
   return 0;
 }
 _ACEOF
-# Don't try gcc -ansi; that turns off useful extensions and
-# breaks some systems' header files.
-# AIX			-qlanglvl=ansi
-# Ultrix and OSF/1	-std1
-# HP-UX 10.20 and later	-Ae
-# HP-UX older versions	-Aa -D_HPUX_SOURCE
-# SVR4			-Xc -D__EXTENSIONS__
-for ac_arg in "" -qlanglvl=ansi -std1 -Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
+for ac_arg in '' -qlanglvl=extc89 -qlanglvl=ansi -std \
+	-Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
 do
   CC="$ac_save_CC $ac_arg"
   rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_prog_cc_stdc=$ac_arg
-break
+  ac_cv_prog_cc_c89=$ac_arg
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext
+
+rm -f core conftest.err conftest.$ac_objext
+  test "x$ac_cv_prog_cc_c89" != "xno" && break
 done
-rm -f conftest.$ac_ext conftest.$ac_objext
+rm -f conftest.$ac_ext
 CC=$ac_save_CC
 
 fi
-
-case "x$ac_cv_prog_cc_stdc" in
-  x|xno)
-    echo "$as_me:$LINENO: result: none needed" >&5
-echo "${ECHO_T}none needed" >&6 ;;
+# AC_CACHE_VAL
+case "x$ac_cv_prog_cc_c89" in
+  x)
+    { echo "$as_me:$LINENO: result: none needed" >&5
+echo "${ECHO_T}none needed" >&6; } ;;
+  xno)
+    { echo "$as_me:$LINENO: result: unsupported" >&5
+echo "${ECHO_T}unsupported" >&6; } ;;
   *)
-    echo "$as_me:$LINENO: result: $ac_cv_prog_cc_stdc" >&5
-echo "${ECHO_T}$ac_cv_prog_cc_stdc" >&6
-    CC="$CC $ac_cv_prog_cc_stdc" ;;
+    CC="$CC $ac_cv_prog_cc_c89"
+    { echo "$as_me:$LINENO: result: $ac_cv_prog_cc_c89" >&5
+echo "${ECHO_T}$ac_cv_prog_cc_c89" >&6; } ;;
 esac
 
-# Some people use a C++ compiler to compile C.  Since we use `exit',
-# in C++ we need to declare it.  In case someone uses the same compiler
-# for both compiling C and C++ we need to have the C++ compiler decide
-# the declaration of exit, since it's the most demanding environment.
-cat >conftest.$ac_ext <<_ACEOF
-#ifndef __cplusplus
-  choke me
-#endif
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  for ac_declaration in \
-   '' \
-   'extern "C" void std::exit (int) throw (); using std::exit;' \
-   'extern "C" void std::exit (int); using std::exit;' \
-   'extern "C" void exit (int) throw ();' \
-   'extern "C" void exit (int);' \
-   'void exit (int);'
-do
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-$ac_declaration
-#include <stdlib.h>
-int
-main ()
-{
-exit (42);
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  :
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-continue
-fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-$ac_declaration
-int
-main ()
-{
-exit (42);
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-done
-rm -f conftest*
-if test -n "$ac_declaration"; then
-  echo '#ifdef __cplusplus' >>confdefs.h
-  echo $ac_declaration      >>confdefs.h
-  echo '#endif'             >>confdefs.h
-fi
-
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
 
-fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
-echo "$as_me:$LINENO: checking how to run the C preprocessor" >&5
-echo $ECHO_N "checking how to run the C preprocessor... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking how to run the C preprocessor" >&5
+echo $ECHO_N "checking how to run the C preprocessor... $ECHO_C" >&6; }
 # On Suns, sometimes $CPP names a directory.
 if test -n "$CPP" && test -d "$CPP"; then
   CPP=
 fi
 if test -z "$CPP"; then
   if test "${ac_cv_prog_CPP+set}" = set; then
@@ -2396,14 +2919,19 @@
 # include <limits.h>
 #else
 # include <assert.h>
 #endif
 		     Syntax error
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -2422,26 +2950,32 @@
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Broken: fails on valid input.
 continue
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether non-existent headers
+  # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <ac_nonexistent.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -2479,14 +3014,14 @@
 
 fi
   CPP=$ac_cv_prog_CPP
 else
   ac_cv_prog_CPP=$CPP
 fi
-echo "$as_me:$LINENO: result: $CPP" >&5
-echo "${ECHO_T}$CPP" >&6
+{ echo "$as_me:$LINENO: result: $CPP" >&5
+echo "${ECHO_T}$CPP" >&6; }
 ac_preproc_ok=false
 for ac_c_preproc_warn_flag in '' yes
 do
   # Use a header file that comes with gcc, so configuring glibc
   # with a fresh cross-compiler works.
   # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
@@ -2503,14 +3038,19 @@
 # include <limits.h>
 #else
 # include <assert.h>
 #endif
 		     Syntax error
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -2529,26 +3069,32 @@
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Broken: fails on valid input.
 continue
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether non-existent headers
+  # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <ac_nonexistent.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -2590,25 +3137,172 @@
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
-echo "$as_me:$LINENO: checking for egrep" >&5
-echo $ECHO_N "checking for egrep... $ECHO_C" >&6
-if test "${ac_cv_prog_egrep+set}" = set; then
+{ echo "$as_me:$LINENO: checking for grep that handles long lines and -e" >&5
+echo $ECHO_N "checking for grep that handles long lines and -e... $ECHO_C" >&6; }
+if test "${ac_cv_path_GREP+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  # Extract the first word of "grep ggrep" to use in msg output
+if test -z "$GREP"; then
+set dummy grep ggrep; ac_prog_name=$2
+if test "${ac_cv_path_GREP+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  ac_path_GREP_found=false
+# Loop through the user's path and test for each of PROGNAME-LIST
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  for ac_prog in grep ggrep; do
+  for ac_exec_ext in '' $ac_executable_extensions; do
+    ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
+    { test -f "$ac_path_GREP" && $as_executable_p "$ac_path_GREP"; } || continue
+    # Check for GNU ac_path_GREP and select it if it is found.
+  # Check for GNU $ac_path_GREP
+case `"$ac_path_GREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
+*)
+  ac_count=0
+  echo $ECHO_N "0123456789$ECHO_C" >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    echo 'GREP' >> "conftest.nl"
+    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    ac_count=`expr $ac_count + 1`
+    if test $ac_count -gt ${ac_path_GREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_GREP="$ac_path_GREP"
+      ac_path_GREP_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
+  done
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
+
+
+    $ac_path_GREP_found && break 3
+  done
+done
+
+done
+IFS=$as_save_IFS
+
+
+fi
+
+GREP="$ac_cv_path_GREP"
+if test -z "$GREP"; then
+  { { echo "$as_me:$LINENO: error: no acceptable $ac_prog_name could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&5
+echo "$as_me: error: no acceptable $ac_prog_name could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&2;}
+   { (exit 1); exit 1; }; }
+fi
+
+else
+  ac_cv_path_GREP=$GREP
+fi
+
+
+fi
+{ echo "$as_me:$LINENO: result: $ac_cv_path_GREP" >&5
+echo "${ECHO_T}$ac_cv_path_GREP" >&6; }
+ GREP="$ac_cv_path_GREP"
+
+
+{ echo "$as_me:$LINENO: checking for egrep" >&5
+echo $ECHO_N "checking for egrep... $ECHO_C" >&6; }
+if test "${ac_cv_path_EGREP+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
+   then ac_cv_path_EGREP="$GREP -E"
+   else
+     # Extract the first word of "egrep" to use in msg output
+if test -z "$EGREP"; then
+set dummy egrep; ac_prog_name=$2
+if test "${ac_cv_path_EGREP+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if echo a | (grep -E '(a|b)') >/dev/null 2>&1
-    then ac_cv_prog_egrep='grep -E'
-    else ac_cv_prog_egrep='egrep'
+  ac_path_EGREP_found=false
+# Loop through the user's path and test for each of PROGNAME-LIST
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  for ac_prog in egrep; do
+  for ac_exec_ext in '' $ac_executable_extensions; do
+    ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
+    { test -f "$ac_path_EGREP" && $as_executable_p "$ac_path_EGREP"; } || continue
+    # Check for GNU ac_path_EGREP and select it if it is found.
+  # Check for GNU $ac_path_EGREP
+case `"$ac_path_EGREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
+*)
+  ac_count=0
+  echo $ECHO_N "0123456789$ECHO_C" >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    echo 'EGREP' >> "conftest.nl"
+    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    ac_count=`expr $ac_count + 1`
+    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_EGREP="$ac_path_EGREP"
+      ac_path_EGREP_max=$ac_count
     fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
+  done
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
+
+
+    $ac_path_EGREP_found && break 3
+  done
+done
+
+done
+IFS=$as_save_IFS
+
+
+fi
+
+EGREP="$ac_cv_path_EGREP"
+if test -z "$EGREP"; then
+  { { echo "$as_me:$LINENO: error: no acceptable $ac_prog_name could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&5
+echo "$as_me: error: no acceptable $ac_prog_name could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&2;}
+   { (exit 1); exit 1; }; }
+fi
+
+else
+  ac_cv_path_EGREP=$EGREP
+fi
+
+
+   fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_prog_egrep" >&5
-echo "${ECHO_T}$ac_cv_prog_egrep" >&6
- EGREP=$ac_cv_prog_egrep
+{ echo "$as_me:$LINENO: result: $ac_cv_path_EGREP" >&5
+echo "${ECHO_T}$ac_cv_path_EGREP" >&6; }
+ EGREP="$ac_cv_path_EGREP"
 
 
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
 # incompatible versions:
 # SysV /etc/install, /usr/sbin/install
@@ -2618,14 +3312,14 @@
 # AmigaOS /C/install, which installs bootblocks on floppy discs
 # AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
 # AFS /usr/afsws/bin/install, which mishandles nonexistent args
 # SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
 # OS/2's system install, which has a completely different semantic
 # ./install, which can be erroneously created by make from ./install.sh.
-echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
-echo $ECHO_N "checking for a BSD-compatible install... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
+echo $ECHO_N "checking for a BSD-compatible install... $ECHO_C" >&6; }
 if test -z "$INSTALL"; then
 if test "${ac_cv_path_install+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -2641,13 +3335,13 @@
   *)
     # OSF1 and SCO ODT 3.0 have their own names for install.
     # Don't use installbsd from OSF since it installs stuff as root
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-	if $as_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
+	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_executable_p "$as_dir/$ac_prog$ac_exec_ext"; }; then
 	  if test $ac_prog = install &&
 	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
 	    # AIX install.  It has an incompatible calling convention.
 	    :
 	  elif test $ac_prog = install &&
 	    grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
@@ -2660,200 +3354,579 @@
 	fi
       done
     done
     ;;
 esac
 done
+IFS=$as_save_IFS
 
 
 fi
   if test "${ac_cv_path_install+set}" = set; then
     INSTALL=$ac_cv_path_install
   else
-    # As a last resort, use the slow shell script.  We don't cache a
-    # path for INSTALL within a source directory, because that will
+    # As a last resort, use the slow shell script.  Don't cache a
+    # value for INSTALL within a source directory, because that will
     # break other packages using the cache if that directory is
-    # removed, or if the path is relative.
+    # removed, or if the value is a relative name.
     INSTALL=$ac_install_sh
   fi
 fi
-echo "$as_me:$LINENO: result: $INSTALL" >&5
-echo "${ECHO_T}$INSTALL" >&6
+{ echo "$as_me:$LINENO: result: $INSTALL" >&5
+echo "${ECHO_T}$INSTALL" >&6; }
 
 # Use test -z because SunOS4 sh mishandles braces in ${var-val}.
 # It thinks the first close brace ends the variable substitution.
 test -z "$INSTALL_PROGRAM" && INSTALL_PROGRAM='${INSTALL}'
 
 test -z "$INSTALL_SCRIPT" && INSTALL_SCRIPT='${INSTALL}'
 
 test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
 
+   case $ac_cv_prog_cc_stdc in
+  no) ac_cv_prog_cc_c99=no; ac_cv_prog_cc_c89=no ;;
+  *) { echo "$as_me:$LINENO: checking for $CC option to accept ISO C99" >&5
+echo $ECHO_N "checking for $CC option to accept ISO C99... $ECHO_C" >&6; }
+if test "${ac_cv_prog_cc_c99+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  ac_cv_prog_cc_c99=no
+ac_save_CC=$CC
+cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <stdarg.h>
+#include <stdbool.h>
+#include <stdlib.h>
+#include <wchar.h>
+#include <stdio.h>
 
+// Check varargs macros.  These examples are taken from C99 6.10.3.5.
+#define debug(...) fprintf (stderr, __VA_ARGS__)
+#define showlist(...) puts (#__VA_ARGS__)
+#define report(test,...) ((test) ? puts (#test) : printf (__VA_ARGS__))
+static void
+test_varargs_macros (void)
+{
+  int x = 1234;
+  int y = 5678;
+  debug ("Flag");
+  debug ("X = %d\n", x);
+  showlist (The first, second, and third items.);
+  report (x>y, "x is %d but y is %d", x, y);
+}
+
+// Check long long types.
+#define BIG64 18446744073709551615ull
+#define BIG32 4294967295ul
+#define BIG_OK (BIG64 / BIG32 == 4294967297ull && BIG64 % BIG32 == 0)
+#if !BIG_OK
+  your preprocessor is broken;
+#endif
+#if BIG_OK
+#else
+  your preprocessor is broken;
+#endif
+static long long int bignum = -9223372036854775807LL;
+static unsigned long long int ubignum = BIG64;
 
+struct incomplete_array
+{
+  int datasize;
+  double data[];
+};
 
+struct named_init {
+  int number;
+  const wchar_t *name;
+  double average;
+};
 
-cat >>confdefs.h <<\_ACEOF
-#define _GNU_SOURCE 1
-_ACEOF
+typedef const char *ccp;
 
+static inline int
+test_restrict (ccp restrict text)
+{
+  // See if C++-style comments work.
+  // Iterate through items via the restricted pointer.
+  // Also check for declarations in for loops.
+  for (unsigned int i = 0; *(text+i) != '\0'; ++i)
+    continue;
+  return 0;
+}
 
-if test x"$ac_cv_prog_cc_stdc" = x"no"; then
-	{ echo "$as_me:$LINENO: WARNING: rsync requires an ANSI C compiler and you don't seem to have one" >&5
-echo "$as_me: WARNING: rsync requires an ANSI C compiler and you don't seem to have one" >&2;}
-fi
+// Check varargs and va_copy.
+static void
+test_varargs (const char *format, ...)
+{
+  va_list args;
+  va_start (args, format);
+  va_list args_copy;
+  va_copy (args_copy, args);
 
-# We must decide this before testing the compiler.
+  const char *str;
+  int number;
+  float fnumber;
 
-# Please allow this to default to yes, so that your users have more
-# chance of getting a useful stack trace if problems occur.
+  while (*format)
+    {
+      switch (*format++)
+	{
+	case 's': // string
+	  str = va_arg (args_copy, const char *);
+	  break;
+	case 'd': // int
+	  number = va_arg (args_copy, int);
+	  break;
+	case 'f': // float
+	  fnumber = va_arg (args_copy, double);
+	  break;
+	default:
+	  break;
+	}
+    }
+  va_end (args_copy);
+  va_end (args);
+}
 
-echo "$as_me:$LINENO: checking whether to include debugging symbols" >&5
-echo $ECHO_N "checking whether to include debugging symbols... $ECHO_C" >&6
-# Check whether --enable-debug or --disable-debug was given.
-if test "${enable_debug+set}" = set; then
-  enableval="$enable_debug"
+int
+main ()
+{
 
-fi;
+  // Check bool.
+  _Bool success = false;
 
-if test x"$enable_debug" = x"no"; then
-    echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
-    CFLAGS=${CFLAGS-"-O"}
-else
-    echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
-    # leave CFLAGS alone; AC_PROG_CC will try to include -g if it can
-        fi
+  // Check restrict.
+  if (test_restrict ("String literal") == 0)
+    success = true;
+  char *restrict newvar = "Another string";
 
+  // Check varargs.
+  test_varargs ("s, d' f .", "string", 65, 34.234);
+  test_varargs_macros ();
 
-# Check whether --enable-profile or --disable-profile was given.
-if test "${enable_profile+set}" = set; then
-  enableval="$enable_profile"
+  // Check flexible array members.
+  struct incomplete_array *ia =
+    malloc (sizeof (struct incomplete_array) + (sizeof (double) * 10));
+  ia->datasize = 10;
+  for (int i = 0; i < ia->datasize; ++i)
+    ia->data[i] = i * 1.234;
 
-fi;
-if test x"$enable_profile" = x"yes"; then
-	CFLAGS="$CFLAGS -pg"
-fi
+  // Check named initializers.
+  struct named_init ni = {
+    .number = 34,
+    .name = L"Test wide string",
+    .average = 543.34343,
+  };
 
+  ni.number = 58;
 
-# Specifically, this turns on panic_action handling.
-# Check whether --enable-maintainer-mode or --disable-maintainer-mode was given.
-if test "${enable_maintainer_mode+set}" = set; then
-  enableval="$enable_maintainer_mode"
+  int dynamic_array[ni.number];
+  dynamic_array[ni.number - 1] = 543;
 
-fi;
-if test x"$enable_maintainer_mode" = x"yes"; then
-	CFLAGS="$CFLAGS -DMAINTAINER_MODE"
-fi
+  // work around unused variable warnings
+  return (!success || bignum == 0LL || ubignum == 0uLL || newvar[0] == 'x'
+	  || dynamic_array[ni.number - 1] != 543);
 
+  ;
+  return 0;
+}
+_ACEOF
+for ac_arg in '' -std=gnu99 -c99 -qlanglvl=extc99
+do
+  CC="$ac_save_CC $ac_arg"
+  rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  ac_cv_prog_cc_c99=$ac_arg
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
 
-# This is needed for our included version of popt.  Kind of silly, but
-# I don't want our version too far out of sync.
-CFLAGS="$CFLAGS -DHAVE_CONFIG_H"
 
-# If GCC, turn on warnings.
-if test x"$GCC" = x"yes"; then
-	CFLAGS="$CFLAGS -Wall -W"
 fi
 
+rm -f core conftest.err conftest.$ac_objext
+  test "x$ac_cv_prog_cc_c99" != "xno" && break
+done
+rm -f conftest.$ac_ext
+CC=$ac_save_CC
 
-# Check whether --with-included-popt or --without-included-popt was given.
-if test "${with_included_popt+set}" = set; then
-  withval="$with_included_popt"
-
-fi;
-
-
-# Check whether --with-rsync-path or --without-rsync-path was given.
-if test "${with_rsync_path+set}" = set; then
-  withval="$with_rsync_path"
-   RSYNC_PATH="$with_rsync_path"
+fi
+# AC_CACHE_VAL
+case "x$ac_cv_prog_cc_c99" in
+  x)
+    { echo "$as_me:$LINENO: result: none needed" >&5
+echo "${ECHO_T}none needed" >&6; } ;;
+  xno)
+    { echo "$as_me:$LINENO: result: unsupported" >&5
+echo "${ECHO_T}unsupported" >&6; } ;;
+  *)
+    CC="$CC $ac_cv_prog_cc_c99"
+    { echo "$as_me:$LINENO: result: $ac_cv_prog_cc_c99" >&5
+echo "${ECHO_T}$ac_cv_prog_cc_c99" >&6; } ;;
+esac
+if test "x$ac_cv_prog_cc_c99" != xno; then
+  ac_cv_prog_cc_stdc=$ac_cv_prog_cc_c99
 else
-   RSYNC_PATH="rsync"
-fi;
-
-
-cat >>confdefs.h <<_ACEOF
-#define RSYNC_PATH "$RSYNC_PATH"
+  { echo "$as_me:$LINENO: checking for $CC option to accept ISO C89" >&5
+echo $ECHO_N "checking for $CC option to accept ISO C89... $ECHO_C" >&6; }
+if test "${ac_cv_prog_cc_c89+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  ac_cv_prog_cc_c89=no
+ac_save_CC=$CC
+cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
 _ACEOF
-
-
-
-# Check whether --with-rsyncd-conf or --without-rsyncd-conf was given.
-if test "${with_rsyncd_conf+set}" = set; then
-  withval="$with_rsyncd_conf"
-   if test ! -z "$with_rsyncd_conf" ; then
-		case $with_rsyncd_conf in
-			yes|no)
-				RSYNCD_SYSCONF="/etc/rsyncd.conf"
-				;;
-			/*)
-				RSYNCD_SYSCONF="$with_rsyncd_conf"
-				;;
-			*)
-                                { { echo "$as_me:$LINENO: error: You must specify an absolute path to --with-rsyncd-conf=PATH" >&5
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <stdarg.h>
+#include <stdio.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+/* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
+struct buf { int x; };
+FILE * (*rcsopen) (struct buf *, struct stat *, int);
+static char *e (p, i)
+     char **p;
+     int i;
+{
+  return p[i];
+}
+static char *f (char * (*g) (char **, int), char **p, ...)
+{
+  char *s;
+  va_list v;
+  va_start (v,p);
+  s = g (p, va_arg (v,int));
+  va_end (v);
+  return s;
+}
+
+/* OSF 4.0 Compaq cc is some sort of almost-ANSI by default.  It has
+   function prototypes and stuff, but not '\xHH' hex character constants.
+   These don't provoke an error unfortunately, instead are silently treated
+   as 'x'.  The following induces an error, until -std is added to get
+   proper ANSI mode.  Curiously '\x00'!='x' always comes out true, for an
+   array size at least.  It's necessary to write '\x00'==0 to get something
+   that's true only with -std.  */
+int osf4_cc_array ['\x00' == 0 ? 1 : -1];
+
+/* IBM C 6 for AIX is almost-ANSI by default, but it replaces macro parameters
+   inside strings and character constants.  */
+#define FOO(x) 'x'
+int xlc6_cc_array[FOO(a) == 'x' ? 1 : -1];
+
+int test (int i, double x);
+struct s1 {int (*f) (int a);};
+struct s2 {int (*f) (double a);};
+int pairnames (int, char **, FILE *(*)(struct buf *, struct stat *, int), int, int);
+int argc;
+char **argv;
+int
+main ()
+{
+return f (e, argv, 0) != argv[0]  ||  f (e, argv, 1) != argv[1];
+  ;
+  return 0;
+}
+_ACEOF
+for ac_arg in '' -qlanglvl=extc89 -qlanglvl=ansi -std \
+	-Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
+do
+  CC="$ac_save_CC $ac_arg"
+  rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  ac_cv_prog_cc_c89=$ac_arg
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+
+fi
+
+rm -f core conftest.err conftest.$ac_objext
+  test "x$ac_cv_prog_cc_c89" != "xno" && break
+done
+rm -f conftest.$ac_ext
+CC=$ac_save_CC
+
+fi
+# AC_CACHE_VAL
+case "x$ac_cv_prog_cc_c89" in
+  x)
+    { echo "$as_me:$LINENO: result: none needed" >&5
+echo "${ECHO_T}none needed" >&6; } ;;
+  xno)
+    { echo "$as_me:$LINENO: result: unsupported" >&5
+echo "${ECHO_T}unsupported" >&6; } ;;
+  *)
+    CC="$CC $ac_cv_prog_cc_c89"
+    { echo "$as_me:$LINENO: result: $ac_cv_prog_cc_c89" >&5
+echo "${ECHO_T}$ac_cv_prog_cc_c89" >&6; } ;;
+esac
+if test "x$ac_cv_prog_cc_c89" != xno; then
+  ac_cv_prog_cc_stdc=$ac_cv_prog_cc_c89
+else
+  ac_cv_prog_cc_stdc=no
+fi
+
+
+fi
+
+ ;;
+esac
+  { echo "$as_me:$LINENO: checking for $CC option to accept ISO Standard C" >&5
+echo $ECHO_N "checking for $CC option to accept ISO Standard C... $ECHO_C" >&6; }
+  if test "${ac_cv_prog_cc_stdc+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+fi
+
+  case $ac_cv_prog_cc_stdc in
+  no) { echo "$as_me:$LINENO: result: unsupported" >&5
+echo "${ECHO_T}unsupported" >&6; } ;;
+  '') { echo "$as_me:$LINENO: result: none needed" >&5
+echo "${ECHO_T}none needed" >&6; } ;;
+  *) { echo "$as_me:$LINENO: result: $ac_cv_prog_cc_stdc" >&5
+echo "${ECHO_T}$ac_cv_prog_cc_stdc" >&6; } ;;
+esac
+
+
+
+
+
+cat >>confdefs.h <<\_ACEOF
+#define _GNU_SOURCE 1
+_ACEOF
+
+
+if test x"$ac_cv_prog_cc_stdc" = x"no"; then
+	{ echo "$as_me:$LINENO: WARNING: rsync requires an ANSI C compiler and you don't seem to have one" >&5
+echo "$as_me: WARNING: rsync requires an ANSI C compiler and you don't seem to have one" >&2;}
+fi
+
+# We must decide this before testing the compiler.
+
+# Please allow this to default to yes, so that your users have more
+# chance of getting a useful stack trace if problems occur.
+
+{ echo "$as_me:$LINENO: checking whether to include debugging symbols" >&5
+echo $ECHO_N "checking whether to include debugging symbols... $ECHO_C" >&6; }
+# Check whether --enable-debug was given.
+if test "${enable_debug+set}" = set; then
+  enableval=$enable_debug;
+fi
+
+
+if test x"$enable_debug" = x"no"; then
+    { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
+    CFLAGS=${CFLAGS-"-O"}
+else
+    { echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
+    # leave CFLAGS alone; AC_PROG_CC will try to include -g if it can
+        fi
+
+
+# Check whether --enable-profile was given.
+if test "${enable_profile+set}" = set; then
+  enableval=$enable_profile;
+fi
+
+if test x"$enable_profile" = x"yes"; then
+	CFLAGS="$CFLAGS -pg"
+fi
+
+
+# Specifically, this turns on panic_action handling.
+# Check whether --enable-maintainer-mode was given.
+if test "${enable_maintainer_mode+set}" = set; then
+  enableval=$enable_maintainer_mode;
+fi
+
+if test x"$enable_maintainer_mode" = x"yes"; then
+	CFLAGS="$CFLAGS -DMAINTAINER_MODE"
+fi
+
+
+# This is needed for our included version of popt.  Kind of silly, but
+# I don't want our version too far out of sync.
+CFLAGS="$CFLAGS -DHAVE_CONFIG_H"
+
+# If GCC, turn on warnings.
+if test x"$GCC" = x"yes"; then
+	CFLAGS="$CFLAGS -Wall -W"
+fi
+
+
+# Check whether --with-included-popt was given.
+if test "${with_included_popt+set}" = set; then
+  withval=$with_included_popt;
+fi
+
+
+
+# Check whether --with-rsync-path was given.
+if test "${with_rsync_path+set}" = set; then
+  withval=$with_rsync_path;  RSYNC_PATH="$with_rsync_path"
+else
+   RSYNC_PATH="rsync"
+fi
+
+
+
+cat >>confdefs.h <<_ACEOF
+#define RSYNC_PATH "$RSYNC_PATH"
+_ACEOF
+
+
+
+# Check whether --with-rsyncd-conf was given.
+if test "${with_rsyncd_conf+set}" = set; then
+  withval=$with_rsyncd_conf;  if test ! -z "$with_rsyncd_conf" ; then
+		case $with_rsyncd_conf in
+			yes|no)
+				RSYNCD_SYSCONF="/etc/rsyncd.conf"
+				;;
+			/*)
+				RSYNCD_SYSCONF="$with_rsyncd_conf"
+				;;
+			*)
+                                { { echo "$as_me:$LINENO: error: You must specify an absolute path to --with-rsyncd-conf=PATH" >&5
 echo "$as_me: error: You must specify an absolute path to --with-rsyncd-conf=PATH" >&2;}
    { (exit 1); exit 1; }; }
 				;;
 		esac
 	else
 		RSYNCD_SYSCONF="/etc/rsyncd.conf"
 	fi
 else
    RSYNCD_SYSCONF="/etc/rsyncd.conf"
-fi;
+fi
+
 
 
 cat >>confdefs.h <<_ACEOF
 #define RSYNCD_SYSCONF "$RSYNCD_SYSCONF"
 _ACEOF
 
 
 
-# Check whether --with-rsh or --without-rsh was given.
+# Check whether --with-rsh was given.
 if test "${with_rsh+set}" = set; then
-  withval="$with_rsh"
+  withval=$with_rsh;
+fi
 
-fi;
 
 # Extract the first word of "remsh", so it can be a program name with args.
 set dummy remsh; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for $ac_word" >&5
+echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
 if test "${ac_cv_prog_HAVE_REMSH+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test -n "$HAVE_REMSH"; then
   ac_cv_prog_HAVE_REMSH="$HAVE_REMSH" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_HAVE_REMSH="1"
     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
   test -z "$ac_cv_prog_HAVE_REMSH" && ac_cv_prog_HAVE_REMSH="0"
 fi
 fi
 HAVE_REMSH=$ac_cv_prog_HAVE_REMSH
 if test -n "$HAVE_REMSH"; then
-  echo "$as_me:$LINENO: result: $HAVE_REMSH" >&5
-echo "${ECHO_T}$HAVE_REMSH" >&6
+  { echo "$as_me:$LINENO: result: $HAVE_REMSH" >&5
+echo "${ECHO_T}$HAVE_REMSH" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
+
 if test x$HAVE_REMSH = x1; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_REMSH 1
 _ACEOF
 
@@ -2867,23 +3940,33 @@
 
 cat >>confdefs.h <<_ACEOF
 #define RSYNC_RSH "$RSYNC_RSH"
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking the group for user \"nobody\"" >&5
-echo $ECHO_N "checking the group for user \"nobody\"... $ECHO_C" >&6
-if grep '^nobody:' /etc/group >/dev/null 2>&1; then
-    NOBODY_GROUP=nobody
-elif grep '^nogroup:' /etc/group >/dev/null 2>&1; then
-    NOBODY_GROUP=nogroup
-else
-    NOBODY_GROUP=nobody # test for others?
+
+# Check whether --with-nobody-group was given.
+if test "${with_nobody_group+set}" = set; then
+  withval=$with_nobody_group;  NOBODY_GROUP="$with_nobody_group"
+fi
+
+
+if test x"$with_nobody_group" = x; then
+    { echo "$as_me:$LINENO: checking the group for user \"nobody\"" >&5
+echo $ECHO_N "checking the group for user \"nobody\"... $ECHO_C" >&6; }
+    if grep '^nobody:' /etc/group >/dev/null 2>&1; then
+	NOBODY_GROUP=nobody
+    elif grep '^nogroup:' /etc/group >/dev/null 2>&1; then
+	NOBODY_GROUP=nogroup
+    else
+	NOBODY_GROUP=nobody # test for others?
+    fi
+    { echo "$as_me:$LINENO: result: $NOBODY_GROUP" >&5
+echo "${ECHO_T}$NOBODY_GROUP" >&6; }
 fi
-echo "$as_me:$LINENO: result: $NOBODY_GROUP" >&5
-echo "${ECHO_T}$NOBODY_GROUP" >&6
+
 
 cat >>confdefs.h <<_ACEOF
 #define NOBODY_USER "nobody"
 _ACEOF
 
 
@@ -2892,14 +3975,14 @@
 _ACEOF
 
 
 # arrgh. libc in some old debian version screwed up the largefile
 # stuff, getting byte range locking wrong
 
-echo "$as_me:$LINENO: checking for broken largefile support" >&5
-echo $ECHO_N "checking for broken largefile support... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for broken largefile support" >&5
+echo $ECHO_N "checking for broken largefile support... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_BROKEN_LARGEFILE+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_HAVE_BROKEN_LARGEFILE=cross
@@ -2942,46 +4025,57 @@
 	unlink(tpl);
 	exit(WEXITSTATUS(status));
 }
 
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_BROKEN_LARGEFILE=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_HAVE_BROKEN_LARGEFILE=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_BROKEN_LARGEFILE" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_BROKEN_LARGEFILE" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_BROKEN_LARGEFILE" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_BROKEN_LARGEFILE" >&6; }
 if test x"$rsync_cv_HAVE_BROKEN_LARGEFILE" != x"yes"; then
-   # Check whether --enable-largefile or --disable-largefile was given.
+   # Check whether --enable-largefile was given.
 if test "${enable_largefile+set}" = set; then
-  enableval="$enable_largefile"
+  enableval=$enable_largefile;
+fi
 
-fi;
 if test "$enable_largefile" != no; then
 
-  echo "$as_me:$LINENO: checking for special C compiler options needed for large files" >&5
-echo $ECHO_N "checking for special C compiler options needed for large files... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for special C compiler options needed for large files" >&5
+echo $ECHO_N "checking for special C compiler options needed for large files... $ECHO_C" >&6; }
 if test "${ac_cv_sys_largefile_CC+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_cv_sys_largefile_CC=no
      if test "$GCC" != yes; then
        ac_save_CC=$CC
@@ -3009,29 +4103,42 @@
 
   ;
   return 0;
 }
 _ACEOF
      	 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
@@ -3034,33 +4141,48 @@
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext
+
+rm -f core conftest.err conftest.$ac_objext
      	 CC="$CC -n32"
      	 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sys_largefile_CC=' -n32'; break
 else
   echo "$as_me: failed program was:" >&5
@@ -3063,28 +4185,30 @@
   (exit $ac_status); }; }; then
   ac_cv_sys_largefile_CC=' -n32'; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext
+
+rm -f core conftest.err conftest.$ac_objext
 	 break
        done
        CC=$ac_save_CC
        rm -f conftest.$ac_ext
     fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sys_largefile_CC" >&5
-echo "${ECHO_T}$ac_cv_sys_largefile_CC" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sys_largefile_CC" >&5
+echo "${ECHO_T}$ac_cv_sys_largefile_CC" >&6; }
   if test "$ac_cv_sys_largefile_CC" != no; then
     CC=$CC$ac_cv_sys_largefile_CC
   fi
 
-  echo "$as_me:$LINENO: checking for _FILE_OFFSET_BITS value needed for large files" >&5
-echo $ECHO_N "checking for _FILE_OFFSET_BITS value needed for large files... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for _FILE_OFFSET_BITS value needed for large files" >&5
+echo $ECHO_N "checking for _FILE_OFFSET_BITS value needed for large files... $ECHO_C" >&6; }
 if test "${ac_cv_sys_file_offset_bits+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   while :; do
   ac_cv_sys_file_offset_bits=no
   cat >conftest.$ac_ext <<_ACEOF
@@ -3108,29 +4232,42 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
@@ -3133,14 +4270,16 @@
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
@@ -3160,29 +4299,42 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sys_file_offset_bits=64; break
 else
   echo "$as_me: failed program was:" >&5
@@ -3185,29 +4337,31 @@
   (exit $ac_status); }; }; then
   ac_cv_sys_file_offset_bits=64; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   break
 done
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sys_file_offset_bits" >&5
-echo "${ECHO_T}$ac_cv_sys_file_offset_bits" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sys_file_offset_bits" >&5
+echo "${ECHO_T}$ac_cv_sys_file_offset_bits" >&6; }
 if test "$ac_cv_sys_file_offset_bits" != no; then
 
 cat >>confdefs.h <<_ACEOF
 #define _FILE_OFFSET_BITS $ac_cv_sys_file_offset_bits
 _ACEOF
 
 fi
 rm -f conftest*
-  echo "$as_me:$LINENO: checking for _LARGE_FILES value needed for large files" >&5
-echo $ECHO_N "checking for _LARGE_FILES value needed for large files... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for _LARGE_FILES value needed for large files" >&5
+echo $ECHO_N "checking for _LARGE_FILES value needed for large files... $ECHO_C" >&6; }
 if test "${ac_cv_sys_large_files+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   while :; do
   ac_cv_sys_large_files=no
   cat >conftest.$ac_ext <<_ACEOF
@@ -3231,29 +4385,42 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
@@ -3256,14 +4423,16 @@
   (exit $ac_status); }; }; then
   break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
@@ -3283,29 +4452,42 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sys_large_files=1; break
 else
   echo "$as_me: failed program was:" >&5
@@ -3308,19 +4490,21 @@
   (exit $ac_status); }; }; then
   ac_cv_sys_large_files=1; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   break
 done
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sys_large_files" >&5
-echo "${ECHO_T}$ac_cv_sys_large_files" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sys_large_files" >&5
+echo "${ECHO_T}$ac_cv_sys_large_files" >&6; }
 if test "$ac_cv_sys_large_files" != no; then
 
 cat >>confdefs.h <<_ACEOF
 #define _LARGE_FILES $ac_cv_sys_large_files
 _ACEOF
 
@@ -3331,20 +4515,20 @@
 fi
 
 ipv6type=unknown
 ipv6lib=none
 ipv6trylibc=yes
 
-# Check whether --enable-ipv6 or --disable-ipv6 was given.
+# Check whether --enable-ipv6 was given.
 if test "${enable_ipv6+set}" = set; then
-  enableval="$enable_ipv6"
+  enableval=$enable_ipv6;
+fi
 
-fi;
 if test x"$enable_ipv6" != x"no"; then
-	echo "$as_me:$LINENO: checking ipv6 stack type" >&5
-echo $ECHO_N "checking ipv6 stack type... $ECHO_C" >&6
+	{ echo "$as_me:$LINENO: checking ipv6 stack type" >&5
+echo $ECHO_N "checking ipv6 stack type... $ECHO_C" >&6; }
 	for i in inria kame linux-glibc linux-inet6 toshiba v6d zeta; do
 		case $i in
 		inria)
 			# http://www.kame.net/
 
 cat >conftest.$ac_ext <<_ACEOF
@@ -3522,172 +4706,424 @@
 			;;
 		esac
 		if test "$ipv6type" != "unknown"; then
 			break
 		fi
 	done
-	echo "$as_me:$LINENO: result: $ipv6type" >&5
-echo "${ECHO_T}$ipv6type" >&6
+	{ echo "$as_me:$LINENO: result: $ipv6type" >&5
+echo "${ECHO_T}$ipv6type" >&6; }
 
-	echo "$as_me:$LINENO: checking for library containing getaddrinfo" >&5
-echo $ECHO_N "checking for library containing getaddrinfo... $ECHO_C" >&6
+	{ echo "$as_me:$LINENO: checking for library containing getaddrinfo" >&5
+echo $ECHO_N "checking for library containing getaddrinfo... $ECHO_C" >&6; }
 if test "${ac_cv_search_getaddrinfo+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_func_search_save_LIBS=$LIBS
-ac_cv_search_getaddrinfo=no
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char getaddrinfo ();
 int
 main ()
 {
-getaddrinfo ();
+return getaddrinfo ();
   ;
   return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+for ac_lib in '' inet6; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_getaddrinfo="none required"
+  ac_cv_search_getaddrinfo=$ac_res
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-if test "$ac_cv_search_getaddrinfo" = no; then
-  for ac_lib in inet6; do
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-    cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
-char getaddrinfo ();
-int
-main ()
-{
-getaddrinfo ();
-  ;
-  return 0;
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext
+  if test "${ac_cv_search_getaddrinfo+set}" = set; then
+  break
+fi
+done
+if test "${ac_cv_search_getaddrinfo+set}" = set; then
+  :
+else
+  ac_cv_search_getaddrinfo=no
+fi
+rm conftest.$ac_ext
+LIBS=$ac_func_search_save_LIBS
+fi
+{ echo "$as_me:$LINENO: result: $ac_cv_search_getaddrinfo" >&5
+echo "${ECHO_T}$ac_cv_search_getaddrinfo" >&6; }
+ac_res=$ac_cv_search_getaddrinfo
+if test "$ac_res" != no; then
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+
+fi
+
+fi
+
+# Check whether --enable-locale was given.
+if test "${enable_locale+set}" = set; then
+  enableval=$enable_locale;
+fi
+
+
+
+if test x"$enable_locale" != x"no"; then
+	cat >>confdefs.h <<\_ACEOF
+#define CONFIG_LOCALE 1
+_ACEOF
+
+fi
+
+{ echo "$as_me:$LINENO: checking whether to call shutdown on all sockets" >&5
+echo $ECHO_N "checking whether to call shutdown on all sockets... $ECHO_C" >&6; }
+case $host_os in
+	*cygwin* ) { echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
+
+cat >>confdefs.h <<\_ACEOF
+#define SHUTDOWN_ALL_SOCKETS 1
+_ACEOF
+
+		   ;;
+	       * ) { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; };;
+esac
+
+{ echo "$as_me:$LINENO: checking for ANSI C header files" >&5
+echo $ECHO_N "checking for ANSI C header files... $ECHO_C" >&6; }
+if test "${ac_cv_header_stdc+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <stdlib.h>
+#include <stdarg.h>
+#include <string.h>
+#include <float.h>
+
+int
+main ()
+{
+
+  ;
+  return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_getaddrinfo="-l$ac_lib"
-break
+  ac_cv_header_stdc=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+	ac_cv_header_stdc=no
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-  done
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+
+if test $ac_cv_header_stdc = yes; then
+  # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <string.h>
+
+_ACEOF
+if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+  $EGREP "memchr" >/dev/null 2>&1; then
+  :
+else
+  ac_cv_header_stdc=no
 fi
-LIBS=$ac_func_search_save_LIBS
+rm -f conftest*
+
 fi
-echo "$as_me:$LINENO: result: $ac_cv_search_getaddrinfo" >&5
-echo "${ECHO_T}$ac_cv_search_getaddrinfo" >&6
-if test "$ac_cv_search_getaddrinfo" != no; then
-  test "$ac_cv_search_getaddrinfo" = "none required" || LIBS="$ac_cv_search_getaddrinfo $LIBS"
 
+if test $ac_cv_header_stdc = yes; then
+  # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <stdlib.h>
+
+_ACEOF
+if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+  $EGREP "free" >/dev/null 2>&1; then
+  :
+else
+  ac_cv_header_stdc=no
 fi
+rm -f conftest*
 
 fi
 
-# Check whether --enable-locale or --disable-locale was given.
-if test "${enable_locale+set}" = set; then
-  enableval="$enable_locale"
+if test $ac_cv_header_stdc = yes; then
+  # /bin/cc in Irix-4.0.5 gets non-ANSI ctype macros unless using -ansi.
+  if test "$cross_compiling" = yes; then
+  :
+else
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+#include <ctype.h>
+#include <stdlib.h>
+#if ((' ' & 0x0FF) == 0x020)
+# define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
+# define TOUPPER(c) (ISLOWER(c) ? 'A' + ((c) - 'a') : (c))
+#else
+# define ISLOWER(c) \
+		   (('a' <= (c) && (c) <= 'i') \
+		     || ('j' <= (c) && (c) <= 'r') \
+		     || ('s' <= (c) && (c) <= 'z'))
+# define TOUPPER(c) (ISLOWER(c) ? ((c) | 0x40) : (c))
+#endif
 
-fi;
+#define XOR(e, f) (((e) && !(f)) || (!(e) && (f)))
+int
+main ()
+{
+  int i;
+  for (i = 0; i < 256; i++)
+    if (XOR (islower (i), ISLOWER (i))
+	|| toupper (i) != TOUPPER (i))
+      return 2;
+  return 0;
+}
+_ACEOF
+rm -f conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  :
+else
+  echo "$as_me: program exited with status $ac_status" >&5
+echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
 
+( exit $ac_status )
+ac_cv_header_stdc=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+fi
 
-if test x"$enable_locale" != x"no"; then
-	cat >>confdefs.h <<\_ACEOF
-#define CONFIG_LOCALE 1
+
+fi
+fi
+{ echo "$as_me:$LINENO: result: $ac_cv_header_stdc" >&5
+echo "${ECHO_T}$ac_cv_header_stdc" >&6; }
+if test $ac_cv_header_stdc = yes; then
+
+cat >>confdefs.h <<\_ACEOF
+#define STDC_HEADERS 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking whether to call shutdown on all sockets" >&5
-echo $ECHO_N "checking whether to call shutdown on all sockets... $ECHO_C" >&6
-case $host_os in
-	*cygwin* ) echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+# On IRIX 5.3, sys/types and inttypes.h are conflicting.
 
-cat >>confdefs.h <<\_ACEOF
-#define SHUTDOWN_ALL_SOCKETS 1
+
+
+
+
+
+
+
+
+for ac_header in sys/types.h sys/stat.h stdlib.h string.h memory.h strings.h \
+		  inttypes.h stdint.h unistd.h
+do
+as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
+{ echo "$as_me:$LINENO: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
 _ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+$ac_includes_default
 
-		   ;;
-	       * ) echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6;;
+#include <$ac_header>
+_ACEOF
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; } &&
+	 { ac_try='test -s conftest.$ac_objext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
 esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  eval "$as_ac_Header=yes"
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	eval "$as_ac_Header=no"
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+ac_res=`eval echo '${'$as_ac_Header'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
+if test `eval echo '${'$as_ac_Header'}'` = yes; then
+  cat >>confdefs.h <<_ACEOF
+#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
+_ACEOF
+
+fi
 
-echo "$as_me:$LINENO: checking whether byte ordering is bigendian" >&5
-echo $ECHO_N "checking whether byte ordering is bigendian... $ECHO_C" >&6
+done
+
+
+{ echo "$as_me:$LINENO: checking whether byte ordering is bigendian" >&5
+echo $ECHO_N "checking whether byte ordering is bigendian... $ECHO_C" >&6; }
 if test "${ac_cv_c_bigendian+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   # See if sys/param.h defines the BYTE_ORDER macro.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -3698,38 +5134,52 @@
 #include <sys/types.h>
 #include <sys/param.h>
 
 int
 main ()
 {
-#if !BYTE_ORDER || !BIG_ENDIAN || !LITTLE_ENDIAN
+#if  ! (defined BYTE_ORDER && defined BIG_ENDIAN && defined LITTLE_ENDIAN \
+	&& BYTE_ORDER && BIG_ENDIAN && LITTLE_ENDIAN)
  bogus endian macros
 #endif
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   # It does; now see whether it defined to BIG_ENDIAN or not.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -3749,86 +5199,113 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_c_bigendian=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_c_bigendian=no
+	ac_cv_c_bigendian=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-# It does not; compile a test program.
+	# It does not; compile a test program.
 if test "$cross_compiling" = yes; then
   # try to guess the endianness by grepping values into an object file
   ac_cv_c_bigendian=unknown
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
-short ascii_mm[] = { 0x4249, 0x4765, 0x6E44, 0x6961, 0x6E53, 0x7953, 0 };
-short ascii_ii[] = { 0x694C, 0x5454, 0x656C, 0x6E45, 0x6944, 0x6E61, 0 };
+short int ascii_mm[] = { 0x4249, 0x4765, 0x6E44, 0x6961, 0x6E53, 0x7953, 0 };
+short int ascii_ii[] = { 0x694C, 0x5454, 0x656C, 0x6E45, 0x6944, 0x6E61, 0 };
 void _ascii () { char *s = (char *) ascii_mm; s = (char *) ascii_ii; }
-short ebcdic_ii[] = { 0x89D3, 0xE3E3, 0x8593, 0x95C5, 0x89C4, 0x9581, 0 };
-short ebcdic_mm[] = { 0xC2C9, 0xC785, 0x95C4, 0x8981, 0x95E2, 0xA8E2, 0 };
+short int ebcdic_ii[] = { 0x89D3, 0xE3E3, 0x8593, 0x95C5, 0x89C4, 0x9581, 0 };
+short int ebcdic_mm[] = { 0xC2C9, 0xC785, 0x95C4, 0x8981, 0x95E2, 0xA8E2, 0 };
 void _ebcdic () { char *s = (char *) ebcdic_mm; s = (char *) ebcdic_ii; }
 int
 main ()
 {
  _ascii (); _ebcdic ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   if grep BIGenDianSyS conftest.$ac_objext >/dev/null ; then
   ac_cv_c_bigendian=yes
 fi
@@ -3841,61 +5318,80 @@
   fi
 fi
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
+$ac_includes_default
 int
 main ()
 {
+
   /* Are we little or big endian?  From Harbison&Steele.  */
   union
   {
-    long l;
-    char c[sizeof (long)];
+    long int l;
+    char c[sizeof (long int)];
   } u;
   u.l = 1;
-  exit (u.c[sizeof (long) - 1] == 1);
+  return u.c[sizeof (long int) - 1] == 1;
+
+  ;
+  return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_c_bigendian=no
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 ac_cv_c_bigendian=yes
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_bigendian" >&5
-echo "${ECHO_T}$ac_cv_c_bigendian" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_c_bigendian" >&5
+echo "${ECHO_T}$ac_cv_c_bigendian" >&6; }
 case $ac_cv_c_bigendian in
   yes)
 
 cat >>confdefs.h <<\_ACEOF
 #define WORDS_BIGENDIAN 1
 _ACEOF
@@ -3915,15 +5411,15 @@
 
 
 
 ac_header_dirent=no
 for ac_hdr in dirent.h sys/ndir.h sys/dir.h ndir.h; do
   as_ac_Header=`echo "ac_cv_header_dirent_$ac_hdr" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_hdr that defines DIR" >&5
-echo $ECHO_N "checking for $ac_hdr that defines DIR... $ECHO_C" >&6
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_hdr that defines DIR" >&5
+echo $ECHO_N "checking for $ac_hdr that defines DIR... $ECHO_C" >&6; }
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3939,307 +5435,272 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_Header=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_Header=no"
+	eval "$as_ac_Header=no"
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+ac_res=`eval echo '${'$as_ac_Header'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_Header'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_hdr" | $as_tr_cpp` 1
 _ACEOF
 
 ac_header_dirent=$ac_hdr; break
 fi
 
 done
 # Two versions of opendir et al. are in -ldir and -lx on SCO Xenix.
 if test $ac_header_dirent = dirent.h; then
-  echo "$as_me:$LINENO: checking for library containing opendir" >&5
-echo $ECHO_N "checking for library containing opendir... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for library containing opendir" >&5
+echo $ECHO_N "checking for library containing opendir... $ECHO_C" >&6; }
 if test "${ac_cv_search_opendir+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_func_search_save_LIBS=$LIBS
-ac_cv_search_opendir=no
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char opendir ();
 int
 main ()
 {
-opendir ();
+return opendir ();
   ;
   return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+for ac_lib in '' dir; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_opendir="none required"
+  ac_cv_search_opendir=$ac_res
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-if test "$ac_cv_search_opendir" = no; then
-  for ac_lib in dir; do
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-    cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
-char opendir ();
-int
-main ()
-{
-opendir ();
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_search_opendir="-l$ac_lib"
-break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
+fi
 
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext
+  if test "${ac_cv_search_opendir+set}" = set; then
+  break
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-  done
+done
+if test "${ac_cv_search_opendir+set}" = set; then
+  :
+else
+  ac_cv_search_opendir=no
 fi
+rm conftest.$ac_ext
 LIBS=$ac_func_search_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_search_opendir" >&5
-echo "${ECHO_T}$ac_cv_search_opendir" >&6
-if test "$ac_cv_search_opendir" != no; then
-  test "$ac_cv_search_opendir" = "none required" || LIBS="$ac_cv_search_opendir $LIBS"
+{ echo "$as_me:$LINENO: result: $ac_cv_search_opendir" >&5
+echo "${ECHO_T}$ac_cv_search_opendir" >&6; }
+ac_res=$ac_cv_search_opendir
+if test "$ac_res" != no; then
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
 
 fi
 
 else
-  echo "$as_me:$LINENO: checking for library containing opendir" >&5
-echo $ECHO_N "checking for library containing opendir... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for library containing opendir" >&5
+echo $ECHO_N "checking for library containing opendir... $ECHO_C" >&6; }
 if test "${ac_cv_search_opendir+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_func_search_save_LIBS=$LIBS
-ac_cv_search_opendir=no
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char opendir ();
 int
 main ()
 {
-opendir ();
+return opendir ();
   ;
   return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+for ac_lib in '' x; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_opendir="none required"
+  ac_cv_search_opendir=$ac_res
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-if test "$ac_cv_search_opendir" = no; then
-  for ac_lib in x; do
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-    cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
-char opendir ();
-int
-main ()
-{
-opendir ();
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_search_opendir="-l$ac_lib"
-break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
+fi
 
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext
+  if test "${ac_cv_search_opendir+set}" = set; then
+  break
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-  done
+done
+if test "${ac_cv_search_opendir+set}" = set; then
+  :
+else
+  ac_cv_search_opendir=no
 fi
+rm conftest.$ac_ext
 LIBS=$ac_func_search_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_search_opendir" >&5
-echo "${ECHO_T}$ac_cv_search_opendir" >&6
-if test "$ac_cv_search_opendir" != no; then
-  test "$ac_cv_search_opendir" = "none required" || LIBS="$ac_cv_search_opendir $LIBS"
+{ echo "$as_me:$LINENO: result: $ac_cv_search_opendir" >&5
+echo "${ECHO_T}$ac_cv_search_opendir" >&6; }
+ac_res=$ac_cv_search_opendir
+if test "$ac_res" != no; then
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
 
 fi
 
 fi
 
-echo "$as_me:$LINENO: checking whether time.h and sys/time.h may both be included" >&5
-echo $ECHO_N "checking whether time.h and sys/time.h may both be included... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether time.h and sys/time.h may both be included" >&5
+echo $ECHO_N "checking whether time.h and sys/time.h may both be included... $ECHO_C" >&6; }
 if test "${ac_cv_header_time+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -4257,66 +5718,80 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_header_time=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_header_time=no
+	ac_cv_header_time=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_time" >&5
-echo "${ECHO_T}$ac_cv_header_time" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_time" >&5
+echo "${ECHO_T}$ac_cv_header_time" >&6; }
 if test $ac_cv_header_time = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define TIME_WITH_SYS_TIME 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for sys/wait.h that is POSIX.1 compatible" >&5
-echo $ECHO_N "checking for sys/wait.h that is POSIX.1 compatible... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for sys/wait.h that is POSIX.1 compatible" >&5
+echo $ECHO_N "checking for sys/wait.h that is POSIX.1 compatible... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_wait_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <sys/types.h>
 #include <sys/wait.h>
 #ifndef WEXITSTATUS
-# define WEXITSTATUS(stat_val) ((unsigned)(stat_val) >> 8)
+# define WEXITSTATUS(stat_val) ((unsigned int) (stat_val) >> 8)
 #endif
 #ifndef WIFEXITED
 # define WIFEXITED(stat_val) (((stat_val) & 255) == 0)
 #endif
 
 int
@@ -4327,287 +5802,65 @@
   s = WIFEXITED (s) ? WEXITSTATUS (s) : 1;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_header_sys_wait_h=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_header_sys_wait_h=no
+	ac_cv_header_sys_wait_h=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_wait_h" >&5
-echo "${ECHO_T}$ac_cv_header_sys_wait_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_wait_h" >&5
+echo "${ECHO_T}$ac_cv_header_sys_wait_h" >&6; }
 if test $ac_cv_header_sys_wait_h = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SYS_WAIT_H 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for ANSI C header files" >&5
-echo $ECHO_N "checking for ANSI C header files... $ECHO_C" >&6
-if test "${ac_cv_header_stdc+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-#include <stdlib.h>
-#include <stdarg.h>
-#include <string.h>
-#include <float.h>
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_header_stdc=yes
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-ac_cv_header_stdc=no
-fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-
-if test $ac_cv_header_stdc = yes; then
-  # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-#include <string.h>
-
-_ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "memchr" >/dev/null 2>&1; then
-  :
-else
-  ac_cv_header_stdc=no
-fi
-rm -f conftest*
-
-fi
-
-if test $ac_cv_header_stdc = yes; then
-  # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-#include <stdlib.h>
-
-_ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "free" >/dev/null 2>&1; then
-  :
-else
-  ac_cv_header_stdc=no
-fi
-rm -f conftest*
-
-fi
-
-if test $ac_cv_header_stdc = yes; then
-  # /bin/cc in Irix-4.0.5 gets non-ANSI ctype macros unless using -ansi.
-  if test "$cross_compiling" = yes; then
-  :
-else
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-#include <ctype.h>
-#if ((' ' & 0x0FF) == 0x020)
-# define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
-# define TOUPPER(c) (ISLOWER(c) ? 'A' + ((c) - 'a') : (c))
-#else
-# define ISLOWER(c) \
-		   (('a' <= (c) && (c) <= 'i') \
-		     || ('j' <= (c) && (c) <= 'r') \
-		     || ('s' <= (c) && (c) <= 'z'))
-# define TOUPPER(c) (ISLOWER(c) ? ((c) | 0x40) : (c))
-#endif
-
-#define XOR(e, f) (((e) && !(f)) || (!(e) && (f)))
-int
-main ()
-{
-  int i;
-  for (i = 0; i < 256; i++)
-    if (XOR (islower (i), ISLOWER (i))
-	|| toupper (i) != TOUPPER (i))
-      exit(2);
-  exit (0);
-}
-_ACEOF
-rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  :
-else
-  echo "$as_me: program exited with status $ac_status" >&5
-echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-( exit $ac_status )
-ac_cv_header_stdc=no
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
-fi
-fi
-fi
-echo "$as_me:$LINENO: result: $ac_cv_header_stdc" >&5
-echo "${ECHO_T}$ac_cv_header_stdc" >&6
-if test $ac_cv_header_stdc = yes; then
-
-cat >>confdefs.h <<\_ACEOF
-#define STDC_HEADERS 1
-_ACEOF
-
-fi
-
-# On IRIX 5.3, sys/types and inttypes.h are conflicting.
-
-
-
-
-
-
-
-
-
-for ac_header in sys/types.h sys/stat.h stdlib.h string.h memory.h strings.h \
-		  inttypes.h stdint.h unistd.h
-do
-as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_header" >&5
-echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-$ac_includes_default
-
-#include <$ac_header>
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  eval "$as_ac_Header=yes"
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-eval "$as_ac_Header=no"
-fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
-if test `eval echo '${'$as_ac_Header'}'` = yes; then
-  cat >>confdefs.h <<_ACEOF
-#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
-_ACEOF
-
-fi
-
-done
-
-
 
 
 
 
 
 
@@ -4640,78 +5893,98 @@
     unistd.h utime.h grp.h compat.h sys/param.h ctype.h sys/wait.h \
     sys/ioctl.h sys/filio.h string.h stdlib.h sys/socket.h sys/mode.h \
     sys/un.h glob.h mcheck.h arpa/inet.h arpa/nameser.h locale.h \
     netdb.h malloc.h float.h limits.h iconv.h libcharset.h langinfo.h
 do
 as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
-  echo "$as_me:$LINENO: checking for $ac_header" >&5
-echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
+  { echo "$as_me:$LINENO: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+ac_res=`eval echo '${'$as_ac_Header'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 else
   # Is the header compilable?
-echo "$as_me:$LINENO: checking $ac_header usability" >&5
-echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
+echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
 #include <$ac_header>
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_header_compiler=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_header_compiler=no
+	ac_header_compiler=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-echo "${ECHO_T}$ac_header_compiler" >&6
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
+echo "${ECHO_T}$ac_header_compiler" >&6; }
 
 # Is the header present?
-echo "$as_me:$LINENO: checking $ac_header presence" >&5
-echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
+echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <$ac_header>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -4729,15 +6002,16 @@
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   ac_header_preproc=no
 fi
+
 rm -f conftest.err conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-echo "${ECHO_T}$ac_header_preproc" >&6
+{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
+echo "${ECHO_T}$ac_header_preproc" >&6; }
 
 # So?  What about this header?
 case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
   yes:no: )
     { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
 echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -4755,44 +6029,38 @@
     { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
 echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
     { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
 echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
     { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
 echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
-    (
-      cat <<\_ASBOX
-## ------------------------------------------ ##
-## Report this to the AC_PACKAGE_NAME lists.  ##
-## ------------------------------------------ ##
-_ASBOX
-    ) |
-      sed "s/^/$as_me: WARNING:     /" >&2
+
     ;;
 esac
-echo "$as_me:$LINENO: checking for $ac_header" >&5
-echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   eval "$as_ac_Header=\$ac_header_preproc"
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+ac_res=`eval echo '${'$as_ac_Header'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 
 fi
 if test `eval echo '${'$as_ac_Header'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
 _ACEOF
 
 fi
 
 done
 
-echo "$as_me:$LINENO: checking whether sys/types.h defines makedev" >&5
-echo $ECHO_N "checking whether sys/types.h defines makedev... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether sys/types.h defines makedev" >&5
+echo $ECHO_N "checking whether sys/types.h defines makedev... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_types_h_makedev+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -4806,113 +6074,146 @@
 return makedev(0, 0);
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_header_sys_types_h_makedev=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_header_sys_types_h_makedev=no
+	ac_cv_header_sys_types_h_makedev=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_types_h_makedev" >&5
-echo "${ECHO_T}$ac_cv_header_sys_types_h_makedev" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_types_h_makedev" >&5
+echo "${ECHO_T}$ac_cv_header_sys_types_h_makedev" >&6; }
 
 if test $ac_cv_header_sys_types_h_makedev = no; then
 if test "${ac_cv_header_sys_mkdev_h+set}" = set; then
-  echo "$as_me:$LINENO: checking for sys/mkdev.h" >&5
-echo $ECHO_N "checking for sys/mkdev.h... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for sys/mkdev.h" >&5
+echo $ECHO_N "checking for sys/mkdev.h... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_mkdev_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_mkdev_h" >&5
-echo "${ECHO_T}$ac_cv_header_sys_mkdev_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_mkdev_h" >&5
+echo "${ECHO_T}$ac_cv_header_sys_mkdev_h" >&6; }
 else
   # Is the header compilable?
-echo "$as_me:$LINENO: checking sys/mkdev.h usability" >&5
-echo $ECHO_N "checking sys/mkdev.h usability... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking sys/mkdev.h usability" >&5
+echo $ECHO_N "checking sys/mkdev.h usability... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
 #include <sys/mkdev.h>
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_header_compiler=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_header_compiler=no
+	ac_header_compiler=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-echo "${ECHO_T}$ac_header_compiler" >&6
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
+echo "${ECHO_T}$ac_header_compiler" >&6; }
 
 # Is the header present?
-echo "$as_me:$LINENO: checking sys/mkdev.h presence" >&5
-echo $ECHO_N "checking sys/mkdev.h presence... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking sys/mkdev.h presence" >&5
+echo $ECHO_N "checking sys/mkdev.h presence... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <sys/mkdev.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -4930,15 +6231,16 @@
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   ac_header_preproc=no
 fi
+
 rm -f conftest.err conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-echo "${ECHO_T}$ac_header_preproc" >&6
+{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
+echo "${ECHO_T}$ac_header_preproc" >&6; }
 
 # So?  What about this header?
 case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
   yes:no: )
     { echo "$as_me:$LINENO: WARNING: sys/mkdev.h: accepted by the compiler, rejected by the preprocessor!" >&5
 echo "$as_me: WARNING: sys/mkdev.h: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -4956,31 +6258,24 @@
     { echo "$as_me:$LINENO: WARNING: sys/mkdev.h:     section \"Present But Cannot Be Compiled\"" >&5
 echo "$as_me: WARNING: sys/mkdev.h:     section \"Present But Cannot Be Compiled\"" >&2;}
     { echo "$as_me:$LINENO: WARNING: sys/mkdev.h: proceeding with the preprocessor's result" >&5
 echo "$as_me: WARNING: sys/mkdev.h: proceeding with the preprocessor's result" >&2;}
     { echo "$as_me:$LINENO: WARNING: sys/mkdev.h: in the future, the compiler will take precedence" >&5
 echo "$as_me: WARNING: sys/mkdev.h: in the future, the compiler will take precedence" >&2;}
-    (
-      cat <<\_ASBOX
-## ------------------------------------------ ##
-## Report this to the AC_PACKAGE_NAME lists.  ##
-## ------------------------------------------ ##
-_ASBOX
-    ) |
-      sed "s/^/$as_me: WARNING:     /" >&2
+
     ;;
 esac
-echo "$as_me:$LINENO: checking for sys/mkdev.h" >&5
-echo $ECHO_N "checking for sys/mkdev.h... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for sys/mkdev.h" >&5
+echo $ECHO_N "checking for sys/mkdev.h... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_mkdev_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_cv_header_sys_mkdev_h=$ac_header_preproc
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_mkdev_h" >&5
-echo "${ECHO_T}$ac_cv_header_sys_mkdev_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_mkdev_h" >&5
+echo "${ECHO_T}$ac_cv_header_sys_mkdev_h" >&6; }
 
 fi
 if test $ac_cv_header_sys_mkdev_h = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define MAJOR_IN_MKDEV 1
@@ -4989,77 +6284,96 @@
 fi
 
 
 
   if test $ac_cv_header_sys_mkdev_h = no; then
     if test "${ac_cv_header_sys_sysmacros_h+set}" = set; then
-  echo "$as_me:$LINENO: checking for sys/sysmacros.h" >&5
-echo $ECHO_N "checking for sys/sysmacros.h... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for sys/sysmacros.h" >&5
+echo $ECHO_N "checking for sys/sysmacros.h... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_sysmacros_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_sysmacros_h" >&5
-echo "${ECHO_T}$ac_cv_header_sys_sysmacros_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_sysmacros_h" >&5
+echo "${ECHO_T}$ac_cv_header_sys_sysmacros_h" >&6; }
 else
   # Is the header compilable?
-echo "$as_me:$LINENO: checking sys/sysmacros.h usability" >&5
-echo $ECHO_N "checking sys/sysmacros.h usability... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking sys/sysmacros.h usability" >&5
+echo $ECHO_N "checking sys/sysmacros.h usability... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
 #include <sys/sysmacros.h>
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_header_compiler=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_header_compiler=no
+	ac_header_compiler=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-echo "${ECHO_T}$ac_header_compiler" >&6
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
+echo "${ECHO_T}$ac_header_compiler" >&6; }
 
 # Is the header present?
-echo "$as_me:$LINENO: checking sys/sysmacros.h presence" >&5
-echo $ECHO_N "checking sys/sysmacros.h presence... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking sys/sysmacros.h presence" >&5
+echo $ECHO_N "checking sys/sysmacros.h presence... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <sys/sysmacros.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
@@ -5077,15 +6391,16 @@
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   ac_header_preproc=no
 fi
+
 rm -f conftest.err conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-echo "${ECHO_T}$ac_header_preproc" >&6
+{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
+echo "${ECHO_T}$ac_header_preproc" >&6; }
 
 # So?  What about this header?
 case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
   yes:no: )
     { echo "$as_me:$LINENO: WARNING: sys/sysmacros.h: accepted by the compiler, rejected by the preprocessor!" >&5
 echo "$as_me: WARNING: sys/sysmacros.h: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -5103,31 +6418,24 @@
     { echo "$as_me:$LINENO: WARNING: sys/sysmacros.h:     section \"Present But Cannot Be Compiled\"" >&5
 echo "$as_me: WARNING: sys/sysmacros.h:     section \"Present But Cannot Be Compiled\"" >&2;}
     { echo "$as_me:$LINENO: WARNING: sys/sysmacros.h: proceeding with the preprocessor's result" >&5
 echo "$as_me: WARNING: sys/sysmacros.h: proceeding with the preprocessor's result" >&2;}
     { echo "$as_me:$LINENO: WARNING: sys/sysmacros.h: in the future, the compiler will take precedence" >&5
 echo "$as_me: WARNING: sys/sysmacros.h: in the future, the compiler will take precedence" >&2;}
-    (
-      cat <<\_ASBOX
-## ------------------------------------------ ##
-## Report this to the AC_PACKAGE_NAME lists.  ##
-## ------------------------------------------ ##
-_ASBOX
-    ) |
-      sed "s/^/$as_me: WARNING:     /" >&2
+
     ;;
 esac
-echo "$as_me:$LINENO: checking for sys/sysmacros.h" >&5
-echo $ECHO_N "checking for sys/sysmacros.h... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for sys/sysmacros.h" >&5
+echo $ECHO_N "checking for sys/sysmacros.h... $ECHO_C" >&6; }
 if test "${ac_cv_header_sys_sysmacros_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_cv_header_sys_sysmacros_h=$ac_header_preproc
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_sys_sysmacros_h" >&5
-echo "${ECHO_T}$ac_cv_header_sys_sysmacros_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_header_sys_sysmacros_h" >&5
+echo "${ECHO_T}$ac_cv_header_sys_sysmacros_h" >&6; }
 
 fi
 if test $ac_cv_header_sys_sysmacros_h = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define MAJOR_IN_SYSMACROS 1
@@ -5137,2451 +6445,3172 @@
 
 
   fi
 fi
 
 
-echo "$as_me:$LINENO: checking for int" >&5
-echo $ECHO_N "checking for int... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking if makedev takes 3 args" >&5
+echo $ECHO_N "checking if makedev takes 3 args... $ECHO_C" >&6; }
+if test "${rsync_cv_MAKEDEV_TAKES_3_ARGS+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+
+if test "$cross_compiling" = yes; then
+  rsync_cv_MAKEDEV_TAKES_3_ARGS=no
+else
+  cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+#include <sys/types.h>
+#ifdef MAJOR_IN_MKDEV
+#include <sys/mkdev.h>
+# if !defined makedev && (defined mkdev || defined _WIN32 || defined __WIN32__)
+#  define makedev mkdev
+# endif
+#elif defined MAJOR_IN_SYSMACROS
+#include <sys/sysmacros.h>
+#endif
+
+int main(void)
+{
+	dev_t dev = makedev(0, 5, 7);
+	if (major(dev) != 5 || minor(dev) != 7)
+		exit(1);
+	return 0;
+}
+
+_ACEOF
+rm -f conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  rsync_cv_MAKEDEV_TAKES_3_ARGS=yes
+else
+  echo "$as_me: program exited with status $ac_status" >&5
+echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+( exit $ac_status )
+rsync_cv_MAKEDEV_TAKES_3_ARGS=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+fi
+
+
+fi
+{ echo "$as_me:$LINENO: result: $rsync_cv_MAKEDEV_TAKES_3_ARGS" >&5
+echo "${ECHO_T}$rsync_cv_MAKEDEV_TAKES_3_ARGS" >&6; }
+if test x"$rsync_cv_MAKEDEV_TAKES_3_ARGS" = x"yes"; then
+
+cat >>confdefs.h <<\_ACEOF
+#define MAKEDEV_TAKES_3_ARGS 1
+_ACEOF
+
+fi
+
+{ echo "$as_me:$LINENO: checking for int" >&5
+echo $ECHO_N "checking for int... $ECHO_C" >&6; }
 if test "${ac_cv_type_int+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef int ac__type_new_;
 int
 main ()
 {
-if ((int *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (int))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_int=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_int=no
+	ac_cv_type_int=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_int" >&5
-echo "${ECHO_T}$ac_cv_type_int" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_int" >&5
+echo "${ECHO_T}$ac_cv_type_int" >&6; }
 
-echo "$as_me:$LINENO: checking size of int" >&5
-echo $ECHO_N "checking size of int... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of int" >&5
+echo $ECHO_N "checking size of int... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_int+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_int" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef int ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (int))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef int ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (int))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef int ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (int))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef int ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (int))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef int ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (int))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_int=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (int), 77
+'') if test "$ac_cv_type_int" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (int)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (int), 77
+echo "$as_me: error: cannot compute sizeof (int)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_int=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (int)); }
-unsigned long ulongval () { return (long) (sizeof (int)); }
+	        typedef int ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (int))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (int))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (int))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_int=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (int), 77
+if test "$ac_cv_type_int" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (int)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (int), 77
+echo "$as_me: error: cannot compute sizeof (int)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_int=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_int=0
 fi
-fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_int" >&5
-echo "${ECHO_T}$ac_cv_sizeof_int" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_int" >&5
+echo "${ECHO_T}$ac_cv_sizeof_int" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_INT $ac_cv_sizeof_int
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for long" >&5
-echo $ECHO_N "checking for long... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for long" >&5
+echo $ECHO_N "checking for long... $ECHO_C" >&6; }
 if test "${ac_cv_type_long+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef long ac__type_new_;
 int
 main ()
 {
-if ((long *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (long))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_long=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_long=no
+	ac_cv_type_long=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_long" >&5
-echo "${ECHO_T}$ac_cv_type_long" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_long" >&5
+echo "${ECHO_T}$ac_cv_type_long" >&6; }
 
-echo "$as_me:$LINENO: checking size of long" >&5
-echo $ECHO_N "checking size of long... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of long" >&5
+echo $ECHO_N "checking size of long... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_long+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_long" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_long=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (long), 77
+'') if test "$ac_cv_type_long" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (long)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (long), 77
+echo "$as_me: error: cannot compute sizeof (long)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_long=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (long)); }
-unsigned long ulongval () { return (long) (sizeof (long)); }
+	        typedef long ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (long))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (long))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (long))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_long=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (long), 77
+if test "$ac_cv_type_long" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (long)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (long), 77
+echo "$as_me: error: cannot compute sizeof (long)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_long=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_long=0
-fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_long" >&5
-echo "${ECHO_T}$ac_cv_sizeof_long" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_long" >&5
+echo "${ECHO_T}$ac_cv_sizeof_long" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_LONG $ac_cv_sizeof_long
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for long long" >&5
-echo $ECHO_N "checking for long long... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for long long" >&5
+echo $ECHO_N "checking for long long... $ECHO_C" >&6; }
 if test "${ac_cv_type_long_long+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef long long ac__type_new_;
 int
 main ()
 {
-if ((long long *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (long long))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_long_long=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_long_long=no
+	ac_cv_type_long_long=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_long_long" >&5
-echo "${ECHO_T}$ac_cv_type_long_long" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_long_long" >&5
+echo "${ECHO_T}$ac_cv_type_long_long" >&6; }
 
-echo "$as_me:$LINENO: checking size of long long" >&5
-echo $ECHO_N "checking size of long long... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of long long" >&5
+echo $ECHO_N "checking size of long long... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_long_long+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_long_long" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long long))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long long))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long long))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long long))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef long long ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (long long))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_long_long=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (long long), 77
+'') if test "$ac_cv_type_long_long" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (long long)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (long long), 77
+echo "$as_me: error: cannot compute sizeof (long long)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_long_long=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (long long)); }
-unsigned long ulongval () { return (long) (sizeof (long long)); }
+	        typedef long long ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (long long))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (long long))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (long long))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_long_long=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (long long), 77
+if test "$ac_cv_type_long_long" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (long long)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (long long), 77
+echo "$as_me: error: cannot compute sizeof (long long)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_long_long=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_long_long=0
 fi
-fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_long_long" >&5
-echo "${ECHO_T}$ac_cv_sizeof_long_long" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_long_long" >&5
+echo "${ECHO_T}$ac_cv_sizeof_long_long" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_LONG_LONG $ac_cv_sizeof_long_long
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for short" >&5
-echo $ECHO_N "checking for short... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for short" >&5
+echo $ECHO_N "checking for short... $ECHO_C" >&6; }
 if test "${ac_cv_type_short+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef short ac__type_new_;
 int
 main ()
 {
-if ((short *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (short))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_short=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_short=no
+	ac_cv_type_short=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_short" >&5
-echo "${ECHO_T}$ac_cv_type_short" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_short" >&5
+echo "${ECHO_T}$ac_cv_type_short" >&6; }
 
-echo "$as_me:$LINENO: checking size of short" >&5
-echo $ECHO_N "checking size of short... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of short" >&5
+echo $ECHO_N "checking size of short... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_short+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_short" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef short ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (short))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef short ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (short))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef short ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (short))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef short ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (short))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef short ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (short))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_short=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (short), 77
+'') if test "$ac_cv_type_short" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (short)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (short), 77
+echo "$as_me: error: cannot compute sizeof (short)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_short=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (short)); }
-unsigned long ulongval () { return (long) (sizeof (short)); }
+	        typedef short ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (short))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (short))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (short))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_short=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (short), 77
+if test "$ac_cv_type_short" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (short)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (short), 77
+echo "$as_me: error: cannot compute sizeof (short)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_short=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_short=0
-fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_short" >&5
-echo "${ECHO_T}$ac_cv_sizeof_short" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_short" >&5
+echo "${ECHO_T}$ac_cv_sizeof_short" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_SHORT $ac_cv_sizeof_short
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for off_t" >&5
-echo $ECHO_N "checking for off_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for off_t" >&5
+echo $ECHO_N "checking for off_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_off_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef off_t ac__type_new_;
 int
 main ()
 {
-if ((off_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (off_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_off_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_off_t=no
+	ac_cv_type_off_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_off_t" >&5
-echo "${ECHO_T}$ac_cv_type_off_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_off_t" >&5
+echo "${ECHO_T}$ac_cv_type_off_t" >&6; }
 
-echo "$as_me:$LINENO: checking size of off_t" >&5
-echo $ECHO_N "checking size of off_t... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of off_t" >&5
+echo $ECHO_N "checking size of off_t... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_off_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_off_t" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off_t))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off_t))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off_t))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off_t))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off_t))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_off_t=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (off_t), 77
+'') if test "$ac_cv_type_off_t" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (off_t)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (off_t), 77
+echo "$as_me: error: cannot compute sizeof (off_t)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_off_t=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (off_t)); }
-unsigned long ulongval () { return (long) (sizeof (off_t)); }
+	        typedef off_t ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (off_t))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (off_t))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (off_t))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_off_t=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (off_t), 77
+if test "$ac_cv_type_off_t" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (off_t)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (off_t), 77
+echo "$as_me: error: cannot compute sizeof (off_t)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_off_t=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_off_t=0
 fi
-fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_off_t" >&5
-echo "${ECHO_T}$ac_cv_sizeof_off_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_off_t" >&5
+echo "${ECHO_T}$ac_cv_sizeof_off_t" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_OFF_T $ac_cv_sizeof_off_t
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for off64_t" >&5
-echo $ECHO_N "checking for off64_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for off64_t" >&5
+echo $ECHO_N "checking for off64_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_off64_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef off64_t ac__type_new_;
 int
 main ()
 {
-if ((off64_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (off64_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_off64_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_off64_t=no
+	ac_cv_type_off64_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_off64_t" >&5
-echo "${ECHO_T}$ac_cv_type_off64_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_off64_t" >&5
+echo "${ECHO_T}$ac_cv_type_off64_t" >&6; }
 
-echo "$as_me:$LINENO: checking size of off64_t" >&5
-echo $ECHO_N "checking size of off64_t... $ECHO_C" >&6
+# The cast to long int works around a bug in the HP C Compiler
+# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+# This bug is HP SR number 8606223364.
+{ echo "$as_me:$LINENO: checking size of off64_t" >&5
+echo $ECHO_N "checking size of off64_t... $ECHO_C" >&6; }
 if test "${ac_cv_sizeof_off64_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  if test "$ac_cv_type_off64_t" = yes; then
-  # The cast to unsigned long works around a bug in the HP C Compiler
-  # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-  # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-  # This bug is HP SR number 8606223364.
   if test "$cross_compiling" = yes; then
   # Depending upon the size, compute the lo and hi bounds.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off64_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off64_t))) >= 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=0 ac_mid=0
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off64_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off64_t))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr $ac_mid + 1`
-		    if test $ac_lo -le $ac_mid; then
-		      ac_lo= ac_hi=
-		      break
-		    fi
-		    ac_mid=`expr 2 '*' $ac_mid + 1`
+	ac_lo=`expr $ac_mid + 1`
+			if test $ac_lo -le $ac_mid; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off64_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off64_t))) < 0)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) < 0)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=-1 ac_mid=-1
   while :; do
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off64_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off64_t))) >= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) >= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_lo=$ac_mid; break
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_hi=`expr '(' $ac_mid ')' - 1`
-		       if test $ac_mid -le $ac_hi; then
-			 ac_lo= ac_hi=
-			 break
-		       fi
-		       ac_mid=`expr 2 '*' $ac_mid`
+	ac_hi=`expr '(' $ac_mid ')' - 1`
+			if test $ac_mid -le $ac_hi; then
+			  ac_lo= ac_hi=
+			  break
+			fi
+			ac_mid=`expr 2 '*' $ac_mid`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
   done
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo= ac_hi=
+	ac_lo= ac_hi=
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 # Binary search between lo and hi bounds.
 while test "x$ac_lo" != "x$ac_hi"; do
   ac_mid=`expr '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo`
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+	        typedef off64_t ac__type_sizeof_;
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(((long) (sizeof (off64_t))) <= $ac_mid)];
+static int test_array [1 - 2 * !(((long int) (sizeof (ac__type_sizeof_))) <= $ac_mid)];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_hi=$ac_mid
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_lo=`expr '(' $ac_mid ')' + 1`
+	ac_lo=`expr '(' $ac_mid ')' + 1`
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 done
 case $ac_lo in
 ?*) ac_cv_sizeof_off64_t=$ac_lo;;
-'') { { echo "$as_me:$LINENO: error: cannot compute sizeof (off64_t), 77
+'') if test "$ac_cv_type_off64_t" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (off64_t)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (off64_t), 77
+echo "$as_me: error: cannot compute sizeof (off64_t)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; } ;;
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_off64_t=0
+	       fi ;;
 esac
 else
-  if test "$cross_compiling" = yes; then
-  { { echo "$as_me:$LINENO: error: internal error: not reached in cross-compile" >&5
-echo "$as_me: error: internal error: not reached in cross-compile" >&2;}
-   { (exit 1); exit 1; }; }
-else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
-long longval () { return (long) (sizeof (off64_t)); }
-unsigned long ulongval () { return (long) (sizeof (off64_t)); }
+	        typedef off64_t ac__type_sizeof_;
+
+static long int longval () { return (long int) (sizeof (ac__type_sizeof_)); }
+static unsigned long int ulongval () { return (long int) (sizeof (ac__type_sizeof_)); }
 #include <stdio.h>
 #include <stdlib.h>
 int
 main ()
 {
 
   FILE *f = fopen ("conftest.val", "w");
   if (! f)
-    exit (1);
-  if (((long) (sizeof (off64_t))) < 0)
+    return 1;
+  if (((long int) (sizeof (ac__type_sizeof_))) < 0)
     {
-      long i = longval ();
-      if (i != ((long) (sizeof (off64_t))))
-	exit (1);
+      long int i = longval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%ld\n", i);
     }
   else
     {
-      unsigned long i = ulongval ();
-      if (i != ((long) (sizeof (off64_t))))
-	exit (1);
+      unsigned long int i = ulongval ();
+      if (i != ((long int) (sizeof (ac__type_sizeof_))))
+	return 1;
       fprintf (f, "%lu\n", i);
     }
-  exit (ferror (f) || fclose (f) != 0);
+  return ferror (f) || fclose (f) != 0;
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_sizeof_off64_t=`cat conftest.val`
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
-{ { echo "$as_me:$LINENO: error: cannot compute sizeof (off64_t), 77
+if test "$ac_cv_type_off64_t" = yes; then
+	         { { echo "$as_me:$LINENO: error: cannot compute sizeof (off64_t)
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute sizeof (off64_t), 77
+echo "$as_me: error: cannot compute sizeof (off64_t)
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
-fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+   { (exit 77); exit 77; }; }
+	       else
+	         ac_cv_sizeof_off64_t=0
+	       fi
 fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.val
-else
-  ac_cv_sizeof_off64_t=0
-fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_sizeof_off64_t" >&5
-echo "${ECHO_T}$ac_cv_sizeof_off64_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_sizeof_off64_t" >&5
+echo "${ECHO_T}$ac_cv_sizeof_off64_t" >&6; }
+
+
+
 cat >>confdefs.h <<_ACEOF
 #define SIZEOF_OFF64_T $ac_cv_sizeof_off64_t
 _ACEOF
 
 
 
-echo "$as_me:$LINENO: checking for inline" >&5
-echo $ECHO_N "checking for inline... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for inline" >&5
+echo $ECHO_N "checking for inline... $ECHO_C" >&6; }
 if test "${ac_cv_c_inline+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_cv_c_inline=no
 for ac_kw in inline __inline__ __inline; do
   cat >conftest.$ac_ext <<_ACEOF
@@ -7595,44 +9624,60 @@
 static $ac_kw foo_t static_foo () {return 0; }
 $ac_kw foo_t foo () {return 0; }
 #endif
 
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_c_inline=$ac_kw; break
+  ac_cv_c_inline=$ac_kw
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  test "$ac_cv_c_inline" != no && break
 done
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_inline" >&5
-echo "${ECHO_T}$ac_cv_c_inline" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_c_inline" >&5
+echo "${ECHO_T}$ac_cv_c_inline" >&6; }
 
 
 case $ac_cv_c_inline in
   inline | yes) ;;
   *)
     case $ac_cv_c_inline in
@@ -7644,148 +9689,193 @@
 #define inline $ac_val
 #endif
 _ACEOF
     ;;
 esac
 
-echo "$as_me:$LINENO: checking for working long double with more range or precision than double" >&5
-echo $ECHO_N "checking for working long double with more range or precision than double... $ECHO_C" >&6
-if test "${ac_cv_c_long_double+set}" = set; then
+
+
+  { echo "$as_me:$LINENO: checking for long double with more range or precision than double" >&5
+echo $ECHO_N "checking for long double with more range or precision than double... $ECHO_C" >&6; }
+if test "${ac_cv_type_long_double_wider+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <float.h>
-	  long double foo = 0.0;
+	    long double const a[] =
+	      {
+		 0.0L, DBL_MIN, DBL_MAX, DBL_EPSILON,
+		 LDBL_MIN, LDBL_MAX, LDBL_EPSILON
+	      };
+	    long double
+	    f (long double x)
+	    {
+	       return ((x + (unsigned long int) 10) * (-1 / x) + a[0]
+			+ (x ? f (x) : 'c'));
+	    }
+
 int
 main ()
 {
-static int test_array [1 - 2 * !(/* Using '|' rather than '||' catches a GCC 2.95.2 x86 bug.  */
-	  (DBL_MAX < LDBL_MAX) | (LDBL_EPSILON < DBL_EPSILON)
-	  | (DBL_MAX_EXP < LDBL_MAX_EXP) | (DBL_MANT_DIG < LDBL_MANT_DIG))];
+static int test_array [1 - 2 * !((0 < ((DBL_MAX_EXP < LDBL_MAX_EXP)
+		   + (DBL_MANT_DIG < LDBL_MANT_DIG)
+		   - (LDBL_MAX_EXP < DBL_MAX_EXP)
+		   - (LDBL_MANT_DIG < DBL_MANT_DIG)))
+	    && (int) LDBL_EPSILON == 0
+	  )];
 test_array [0] = 0
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_c_long_double=yes
+  ac_cv_type_long_double_wider=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_c_long_double=no
+	ac_cv_type_long_double_wider=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_long_double" >&5
-echo "${ECHO_T}$ac_cv_c_long_double" >&6
-if test $ac_cv_c_long_double = yes; then
+{ echo "$as_me:$LINENO: result: $ac_cv_type_long_double_wider" >&5
+echo "${ECHO_T}$ac_cv_type_long_double_wider" >&6; }
+  if test $ac_cv_type_long_double_wider = yes; then
+
+cat >>confdefs.h <<\_ACEOF
+#define HAVE_LONG_DOUBLE_WIDER 1
+_ACEOF
+
+  fi
+
+    ac_cv_c_long_double=$ac_cv_type_long_double_wider
+    if test $ac_cv_c_long_double = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_LONG_DOUBLE 1
 _ACEOF
 
-fi
+    fi
 
 
-echo "$as_me:$LINENO: checking return type of signal handlers" >&5
-echo $ECHO_N "checking return type of signal handlers... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking return type of signal handlers" >&5
+echo $ECHO_N "checking return type of signal handlers... $ECHO_C" >&6; }
 if test "${ac_cv_type_signal+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <sys/types.h>
 #include <signal.h>
-#ifdef signal
-# undef signal
-#endif
-#ifdef __cplusplus
-extern "C" void (*signal (int, void (*)(int)))(int);
-#else
-void (*signal ()) ();
-#endif
 
 int
 main ()
 {
-int i;
+return *(signal (0, 0)) (0) == 1;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_type_signal=void
+  ac_cv_type_signal=int
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_signal=int
+	ac_cv_type_signal=void
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_signal" >&5
-echo "${ECHO_T}$ac_cv_type_signal" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_signal" >&5
+echo "${ECHO_T}$ac_cv_type_signal" >&6; }
 
 cat >>confdefs.h <<_ACEOF
 #define RETSIGTYPE $ac_cv_type_signal
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for uid_t in sys/types.h" >&5
-echo $ECHO_N "checking for uid_t in sys/types.h... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for uid_t in sys/types.h" >&5
+echo $ECHO_N "checking for uid_t in sys/types.h... $ECHO_C" >&6; }
 if test "${ac_cv_type_uid_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -7801,14 +9891,14 @@
 else
   ac_cv_type_uid_t=no
 fi
 rm -f conftest*
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_uid_t" >&5
-echo "${ECHO_T}$ac_cv_type_uid_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_uid_t" >&5
+echo "${ECHO_T}$ac_cv_type_uid_t" >&6; }
 if test $ac_cv_type_uid_t = no; then
 
 cat >>confdefs.h <<\_ACEOF
 #define uid_t int
 _ACEOF
 
@@ -7816,274 +9906,334 @@
 cat >>confdefs.h <<\_ACEOF
 #define gid_t int
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for mode_t" >&5
-echo $ECHO_N "checking for mode_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for mode_t" >&5
+echo $ECHO_N "checking for mode_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_mode_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef mode_t ac__type_new_;
 int
 main ()
 {
-if ((mode_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (mode_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_mode_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_mode_t=no
+	ac_cv_type_mode_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_mode_t" >&5
-echo "${ECHO_T}$ac_cv_type_mode_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_mode_t" >&5
+echo "${ECHO_T}$ac_cv_type_mode_t" >&6; }
 if test $ac_cv_type_mode_t = yes; then
   :
 else
 
 cat >>confdefs.h <<_ACEOF
 #define mode_t int
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for off_t" >&5
-echo $ECHO_N "checking for off_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for off_t" >&5
+echo $ECHO_N "checking for off_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_off_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef off_t ac__type_new_;
 int
 main ()
 {
-if ((off_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (off_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_off_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_off_t=no
+	ac_cv_type_off_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_off_t" >&5
-echo "${ECHO_T}$ac_cv_type_off_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_off_t" >&5
+echo "${ECHO_T}$ac_cv_type_off_t" >&6; }
 if test $ac_cv_type_off_t = yes; then
   :
 else
 
 cat >>confdefs.h <<_ACEOF
-#define off_t long
+#define off_t long int
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for size_t" >&5
-echo $ECHO_N "checking for size_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for size_t" >&5
+echo $ECHO_N "checking for size_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_size_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef size_t ac__type_new_;
 int
 main ()
 {
-if ((size_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (size_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_size_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_size_t=no
+	ac_cv_type_size_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_size_t" >&5
-echo "${ECHO_T}$ac_cv_type_size_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_size_t" >&5
+echo "${ECHO_T}$ac_cv_type_size_t" >&6; }
 if test $ac_cv_type_size_t = yes; then
   :
 else
 
 cat >>confdefs.h <<_ACEOF
-#define size_t unsigned
+#define size_t unsigned int
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for pid_t" >&5
-echo $ECHO_N "checking for pid_t... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for pid_t" >&5
+echo $ECHO_N "checking for pid_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_pid_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
+typedef pid_t ac__type_new_;
 int
 main ()
 {
-if ((pid_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (pid_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_pid_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_pid_t=no
+	ac_cv_type_pid_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_pid_t" >&5
-echo "${ECHO_T}$ac_cv_type_pid_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_pid_t" >&5
+echo "${ECHO_T}$ac_cv_type_pid_t" >&6; }
 if test $ac_cv_type_pid_t = yes; then
   :
 else
 
 cat >>confdefs.h <<_ACEOF
 #define pid_t int
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking type of array argument to getgroups" >&5
-echo $ECHO_N "checking type of array argument to getgroups... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking type of array argument to getgroups" >&5
+echo $ECHO_N "checking type of array argument to getgroups... $ECHO_C" >&6; }
 if test "${ac_cv_type_getgroups+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test "$cross_compiling" = yes; then
   ac_cv_type_getgroups=cross
 else
@@ -8091,56 +10241,68 @@
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 /* Thanks to Mike Rendell for this test.  */
-#include <sys/types.h>
+$ac_includes_default
 #define NGID 256
 #undef MAX
 #define MAX(x, y) ((x) > (y) ? (x) : (y))
 
 int
 main ()
 {
   gid_t gidset[NGID];
   int i, n;
-  union { gid_t gval; long lval; }  val;
+  union { gid_t gval; long int lval; }  val;
 
   val.lval = -1;
   for (i = 0; i < NGID; i++)
     gidset[i] = val.gval;
   n = getgroups (sizeof (gidset) / MAX (sizeof (int), sizeof (gid_t)) - 1,
 		 gidset);
   /* Exit non-zero if getgroups seems to require an array of ints.  This
-     happens when gid_t is short but getgroups modifies an array of ints.  */
-  exit ((n > 0 && gidset[n] != val.gval) ? 1 : 0);
+     happens when gid_t is short int but getgroups modifies an array
+     of ints.  */
+  return n > 0 && gidset[n] != val.gval;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_getgroups=gid_t
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 ac_cv_type_getgroups=int
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 if test $ac_cv_type_getgroups = cross; then
         cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
@@ -8155,22 +10317,22 @@
   ac_cv_type_getgroups=int
 fi
 rm -f conftest*
 
 fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_getgroups" >&5
-echo "${ECHO_T}$ac_cv_type_getgroups" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_getgroups" >&5
+echo "${ECHO_T}$ac_cv_type_getgroups" >&6; }
 
 cat >>confdefs.h <<_ACEOF
 #define GETGROUPS_T $ac_cv_type_getgroups
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking for struct stat.st_rdev" >&5
-echo $ECHO_N "checking for struct stat.st_rdev... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for struct stat.st_rdev" >&5
+echo $ECHO_N "checking for struct stat.st_rdev... $ECHO_C" >&6; }
 if test "${ac_cv_member_struct_stat_st_rdev+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -8186,38 +10348,51 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_stat_st_rdev=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 $ac_includes_default
@@ -8229,119 +10404,149 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_stat_st_rdev=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_member_struct_stat_st_rdev=no
+	ac_cv_member_struct_stat_st_rdev=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_member_struct_stat_st_rdev" >&5
-echo "${ECHO_T}$ac_cv_member_struct_stat_st_rdev" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_member_struct_stat_st_rdev" >&5
+echo "${ECHO_T}$ac_cv_member_struct_stat_st_rdev" >&6; }
 if test $ac_cv_member_struct_stat_st_rdev = yes; then
 
 cat >>confdefs.h <<_ACEOF
 #define HAVE_STRUCT_STAT_ST_RDEV 1
 _ACEOF
 
 
 fi
 
 
 
-   echo "$as_me:$LINENO: checking for socklen_t" >&5
-echo $ECHO_N "checking for socklen_t... $ECHO_C" >&6
+   { echo "$as_me:$LINENO: checking for socklen_t" >&5
+echo $ECHO_N "checking for socklen_t... $ECHO_C" >&6; }
 if test "${ac_cv_type_socklen_t+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <sys/types.h>
 #include <sys/socket.h>
 
+typedef socklen_t ac__type_new_;
 int
 main ()
 {
-if ((socklen_t *) 0)
+if ((ac__type_new_ *) 0)
   return 0;
-if (sizeof (socklen_t))
+if (sizeof (ac__type_new_))
   return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_type_socklen_t=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_type_socklen_t=no
+	ac_cv_type_socklen_t=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_type_socklen_t" >&5
-echo "${ECHO_T}$ac_cv_type_socklen_t" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_type_socklen_t" >&5
+echo "${ECHO_T}$ac_cv_type_socklen_t" >&6; }
 if test $ac_cv_type_socklen_t = yes; then
   :
 else
 
-      echo "$as_me:$LINENO: checking for socklen_t equivalent" >&5
-echo $ECHO_N "checking for socklen_t equivalent... $ECHO_C" >&6
+      { echo "$as_me:$LINENO: checking for socklen_t equivalent" >&5
+echo $ECHO_N "checking for socklen_t equivalent... $ECHO_C" >&6; }
       if test "${rsync_cv_socklen_t_equiv+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
          # Systems have either "struct sockaddr *" or
          # "void *" as the second argument to getpeername
@@ -8369,29 +10574,42 @@
 
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
 
                   rsync_cv_socklen_t_equiv="$t"
                   break
@@ -8397,38 +10615,40 @@
                   break
 
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
             done
          done
 
          if test "x$rsync_cv_socklen_t_equiv" = x; then
             { { echo "$as_me:$LINENO: error: Cannot find a type to use in place of socklen_t" >&5
 echo "$as_me: error: Cannot find a type to use in place of socklen_t" >&2;}
    { (exit 1); exit 1; }; }
          fi
 
 fi
 
-      echo "$as_me:$LINENO: result: $rsync_cv_socklen_t_equiv" >&5
-echo "${ECHO_T}$rsync_cv_socklen_t_equiv" >&6
+      { echo "$as_me:$LINENO: result: $rsync_cv_socklen_t_equiv" >&5
+echo "${ECHO_T}$rsync_cv_socklen_t_equiv" >&6; }
 
 cat >>confdefs.h <<_ACEOF
 #define socklen_t $rsync_cv_socklen_t_equiv
 _ACEOF
 
 fi
 
 
 
-echo "$as_me:$LINENO: checking for errno in errno.h" >&5
-echo $ECHO_N "checking for errno in errno.h... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for errno in errno.h" >&5
+echo $ECHO_N "checking for errno in errno.h... $ECHO_C" >&6; }
 if test "${rsync_cv_errno+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
     cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -8443,43 +10663,57 @@
 int i = errno
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_errno=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-rsync_cv_have_errno_decl=no
+	rsync_cv_have_errno_decl=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_errno" >&5
-echo "${ECHO_T}$rsync_cv_errno" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_errno" >&5
+echo "${ECHO_T}$rsync_cv_errno" >&6; }
 if test x"$rsync_cv_errno" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_ERRNO_DECL 1
 _ACEOF
 
@@ -8494,15 +10728,15 @@
 # only looks in /etc/hosts), so we only look for -lsocket if we need
 # it.
 
 for ac_func in connect
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -8522,148 +10756,171 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
 done
 
 if test x"$ac_cv_func_connect" = x"no"; then
     case "$LIBS" in
     *-lnsl*) ;;
     *)
-echo "$as_me:$LINENO: checking for printf in -lnsl_s" >&5
-echo $ECHO_N "checking for printf in -lnsl_s... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for printf in -lnsl_s" >&5
+echo $ECHO_N "checking for printf in -lnsl_s... $ECHO_C" >&6; }
 if test "${ac_cv_lib_nsl_s_printf+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lnsl_s  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char printf ();
 int
 main ()
 {
-printf ();
+return printf ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_nsl_s_printf=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_nsl_s_printf=no
+	ac_cv_lib_nsl_s_printf=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_nsl_s_printf" >&5
-echo "${ECHO_T}$ac_cv_lib_nsl_s_printf" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_nsl_s_printf" >&5
+echo "${ECHO_T}$ac_cv_lib_nsl_s_printf" >&6; }
 if test $ac_cv_lib_nsl_s_printf = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBNSL_S 1
 _ACEOF
 
   LIBS="-lnsl_s $LIBS"
@@ -8671,75 +10928,89 @@
 fi
  ;;
     esac
     case "$LIBS" in
     *-lnsl*) ;;
     *)
-echo "$as_me:$LINENO: checking for printf in -lnsl" >&5
-echo $ECHO_N "checking for printf in -lnsl... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for printf in -lnsl" >&5
+echo $ECHO_N "checking for printf in -lnsl... $ECHO_C" >&6; }
 if test "${ac_cv_lib_nsl_printf+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lnsl  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char printf ();
 int
 main ()
 {
-printf ();
+return printf ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_nsl_printf=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_nsl_printf=no
+	ac_cv_lib_nsl_printf=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_nsl_printf" >&5
-echo "${ECHO_T}$ac_cv_lib_nsl_printf" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_nsl_printf" >&5
+echo "${ECHO_T}$ac_cv_lib_nsl_printf" >&6; }
 if test $ac_cv_lib_nsl_printf = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBNSL 1
 _ACEOF
 
   LIBS="-lnsl $LIBS"
@@ -8747,75 +11018,89 @@
 fi
  ;;
     esac
     case "$LIBS" in
     *-lsocket*) ;;
     *)
-echo "$as_me:$LINENO: checking for connect in -lsocket" >&5
-echo $ECHO_N "checking for connect in -lsocket... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for connect in -lsocket" >&5
+echo $ECHO_N "checking for connect in -lsocket... $ECHO_C" >&6; }
 if test "${ac_cv_lib_socket_connect+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lsocket  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char connect ();
 int
 main ()
 {
-connect ();
+return connect ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_socket_connect=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_socket_connect=no
+	ac_cv_lib_socket_connect=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_socket_connect" >&5
-echo "${ECHO_T}$ac_cv_lib_socket_connect" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_socket_connect" >&5
+echo "${ECHO_T}$ac_cv_lib_socket_connect" >&6; }
 if test $ac_cv_lib_socket_connect = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBSOCKET 1
 _ACEOF
 
   LIBS="-lsocket $LIBS"
@@ -8823,75 +11108,89 @@
 fi
  ;;
     esac
     case "$LIBS" in
     *-linet*) ;;
     *)
-echo "$as_me:$LINENO: checking for connect in -linet" >&5
-echo $ECHO_N "checking for connect in -linet... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for connect in -linet" >&5
+echo $ECHO_N "checking for connect in -linet... $ECHO_C" >&6; }
 if test "${ac_cv_lib_inet_connect+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-linet  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char connect ();
 int
 main ()
 {
-connect ();
+return connect ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_inet_connect=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_inet_connect=no
+	ac_cv_lib_inet_connect=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_inet_connect" >&5
-echo "${ECHO_T}$ac_cv_lib_inet_connect" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_inet_connect" >&5
+echo "${ECHO_T}$ac_cv_lib_inet_connect" >&6; }
 if test $ac_cv_lib_inet_connect = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBINET 1
 _ACEOF
 
   LIBS="-linet $LIBS"
@@ -8908,272 +11207,222 @@
 #define HAVE_CONNECT 1
 _ACEOF
 
     fi
 fi
 
-echo "$as_me:$LINENO: checking for library containing inet_ntop" >&5
-echo $ECHO_N "checking for library containing inet_ntop... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for library containing inet_ntop" >&5
+echo $ECHO_N "checking for library containing inet_ntop... $ECHO_C" >&6; }
 if test "${ac_cv_search_inet_ntop+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_func_search_save_LIBS=$LIBS
-ac_cv_search_inet_ntop=no
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char inet_ntop ();
 int
 main ()
 {
-inet_ntop ();
+return inet_ntop ();
   ;
   return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+for ac_lib in '' resolv; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_inet_ntop="none required"
+  ac_cv_search_inet_ntop=$ac_res
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-if test "$ac_cv_search_inet_ntop" = no; then
-  for ac_lib in resolv; do
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-    cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
-char inet_ntop ();
-int
-main ()
-{
-inet_ntop ();
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_search_inet_ntop="-l$ac_lib"
-break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
+fi
 
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext
+  if test "${ac_cv_search_inet_ntop+set}" = set; then
+  break
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-  done
+done
+if test "${ac_cv_search_inet_ntop+set}" = set; then
+  :
+else
+  ac_cv_search_inet_ntop=no
 fi
+rm conftest.$ac_ext
 LIBS=$ac_func_search_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_search_inet_ntop" >&5
-echo "${ECHO_T}$ac_cv_search_inet_ntop" >&6
-if test "$ac_cv_search_inet_ntop" != no; then
-  test "$ac_cv_search_inet_ntop" = "none required" || LIBS="$ac_cv_search_inet_ntop $LIBS"
+{ echo "$as_me:$LINENO: result: $ac_cv_search_inet_ntop" >&5
+echo "${ECHO_T}$ac_cv_search_inet_ntop" >&6; }
+ac_res=$ac_cv_search_inet_ntop
+if test "$ac_res" != no; then
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
 
 fi
 
 
 # Solaris and HP-UX weirdness:
 # Search for libiconv_open (not iconv_open) to discover if -liconv is needed!
-echo "$as_me:$LINENO: checking for library containing libiconv_open" >&5
-echo $ECHO_N "checking for library containing libiconv_open... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for library containing libiconv_open" >&5
+echo $ECHO_N "checking for library containing libiconv_open... $ECHO_C" >&6; }
 if test "${ac_cv_search_libiconv_open+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_func_search_save_LIBS=$LIBS
-ac_cv_search_libiconv_open=no
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char libiconv_open ();
 int
 main ()
 {
-libiconv_open ();
+return libiconv_open ();
   ;
   return 0;
 }
 _ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+for ac_lib in '' iconv; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  ac_cv_search_libiconv_open="none required"
+  ac_cv_search_libiconv_open=$ac_res
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-if test "$ac_cv_search_libiconv_open" = no; then
-  for ac_lib in iconv; do
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-    cat >conftest.$ac_ext <<_ACEOF
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
-char libiconv_open ();
-int
-main ()
-{
-libiconv_open ();
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
-  ac_status=$?
-  grep -v '^ *+' conftest.er1 >conftest.err
-  rm -f conftest.er1
-  cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; } &&
-	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_search_libiconv_open="-l$ac_lib"
-break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
+fi
 
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext
+  if test "${ac_cv_search_libiconv_open+set}" = set; then
+  break
 fi
-rm -f conftest.err conftest.$ac_objext \
-      conftest$ac_exeext conftest.$ac_ext
-  done
+done
+if test "${ac_cv_search_libiconv_open+set}" = set; then
+  :
+else
+  ac_cv_search_libiconv_open=no
 fi
+rm conftest.$ac_ext
 LIBS=$ac_func_search_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_search_libiconv_open" >&5
-echo "${ECHO_T}$ac_cv_search_libiconv_open" >&6
-if test "$ac_cv_search_libiconv_open" != no; then
-  test "$ac_cv_search_libiconv_open" = "none required" || LIBS="$ac_cv_search_libiconv_open $LIBS"
+{ echo "$as_me:$LINENO: result: $ac_cv_search_libiconv_open" >&5
+echo "${ECHO_T}$ac_cv_search_libiconv_open" >&6; }
+ac_res=$ac_cv_search_libiconv_open
+if test "$ac_res" != no; then
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
 
 fi
 
 
 
 
 for ac_func in inet_ntop
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -9193,97 +11442,104 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 else
-  case $LIBOBJS in
-    "lib/inet_ntop.$ac_objext"   | \
-  *" lib/inet_ntop.$ac_objext"   | \
-    "lib/inet_ntop.$ac_objext "* | \
+  case " $LIBOBJS " in
   *" lib/inet_ntop.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/inet_ntop.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/inet_ntop.$ac_objext"
+ ;;
 esac
 
 fi
 done
 
 
 for ac_func in inet_pton
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -9303,95 +11559,102 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 else
-  case $LIBOBJS in
-    "lib/inet_pton.$ac_objext"   | \
-  *" lib/inet_pton.$ac_objext"   | \
-    "lib/inet_pton.$ac_objext "* | \
+  case " $LIBOBJS " in
   *" lib/inet_pton.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/inet_pton.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/inet_pton.$ac_objext"
+ ;;
 esac
 
 fi
 done
 
 
 # Irix 6.5 has getaddrinfo but not the corresponding defines, so use
 #   builtin getaddrinfo if one of the defines don't exist
-echo "$as_me:$LINENO: checking whether defines needed by getaddrinfo exist" >&5
-echo $ECHO_N "checking whether defines needed by getaddrinfo exist... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether defines needed by getaddrinfo exist" >&5
+echo $ECHO_N "checking whether defines needed by getaddrinfo exist... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_GETADDR_DEFINES+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 			cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -9413,25 +11676,25 @@
 else
   rsync_cv_HAVE_GETADDR_DEFINES=no
 fi
 rm -f conftest*
 
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_GETADDR_DEFINES" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_GETADDR_DEFINES" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_GETADDR_DEFINES" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_GETADDR_DEFINES" >&6; }
 if test x"$rsync_cv_HAVE_GETADDR_DEFINES" = x"yes"; then
 	# Tru64 UNIX has getaddrinfo() but has it renamed in libc as
 	# something else so we must include <netdb.h> to get the
 	# redefinition.
 
 for ac_func in getaddrinfo
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -9451,81 +11714,90 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 else
-  echo "$as_me:$LINENO: checking for getaddrinfo by including <netdb.h>" >&5
-echo $ECHO_N "checking for getaddrinfo by including <netdb.h>... $ECHO_C" >&6
+  { echo "$as_me:$LINENO: checking for getaddrinfo by including <netdb.h>" >&5
+echo $ECHO_N "checking for getaddrinfo by including <netdb.h>... $ECHO_C" >&6; }
 		cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
@@ -9538,66 +11810,78 @@
 getaddrinfo(NULL, NULL, NULL, NULL);
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+  { echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_GETADDRINFO 1
 _ACEOF
 
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
-			case $LIBOBJS in
-    "lib/getaddrinfo.$ac_objext"   | \
-  *" lib/getaddrinfo.$ac_objext"   | \
-    "lib/getaddrinfo.$ac_objext "* | \
+	{ echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
+			case " $LIBOBJS " in
   *" lib/getaddrinfo.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/getaddrinfo.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/getaddrinfo.$ac_objext"
+ ;;
 esac
 
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
 done
 
 
 for ac_func in getnameinfo
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -9617,111 +11901,114 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 else
-  case $LIBOBJS in
-    "lib/getnameinfo.$ac_objext"   | \
-  *" lib/getnameinfo.$ac_objext"   | \
-    "lib/getnameinfo.$ac_objext "* | \
+  case " $LIBOBJS " in
   *" lib/getnameinfo.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/getnameinfo.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/getnameinfo.$ac_objext"
+ ;;
 esac
 
 fi
 done
 
 else
-	case $LIBOBJS in
-    "lib/getaddrinfo.$ac_objext"   | \
-  *" lib/getaddrinfo.$ac_objext"   | \
-    "lib/getaddrinfo.$ac_objext "* | \
+	case " $LIBOBJS " in
   *" lib/getaddrinfo.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/getaddrinfo.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/getaddrinfo.$ac_objext"
+ ;;
 esac
 
-	case $LIBOBJS in
-    "lib/getnameinfo.$ac_objext"   | \
-  *" lib/getnameinfo.$ac_objext"   | \
-    "lib/getnameinfo.$ac_objext "* | \
+	case " $LIBOBJS " in
   *" lib/getnameinfo.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lib/getnameinfo.$ac_objext" ;;
+  *) LIBOBJS="$LIBOBJS lib/getnameinfo.$ac_objext"
+ ;;
 esac
 
 fi
 
-echo "$as_me:$LINENO: checking for struct sockaddr.sa_len" >&5
-echo $ECHO_N "checking for struct sockaddr.sa_len... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for struct sockaddr.sa_len" >&5
+echo $ECHO_N "checking for struct sockaddr.sa_len... $ECHO_C" >&6; }
 if test "${ac_cv_member_struct_sockaddr_sa_len+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -9741,38 +12028,51 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_sa_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
@@ -9788,56 +12088,71 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_sa_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_member_struct_sockaddr_sa_len=no
+	ac_cv_member_struct_sockaddr_sa_len=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_sa_len" >&5
-echo "${ECHO_T}$ac_cv_member_struct_sockaddr_sa_len" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_sa_len" >&5
+echo "${ECHO_T}$ac_cv_member_struct_sockaddr_sa_len" >&6; }
 if test $ac_cv_member_struct_sockaddr_sa_len = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKADDR_LEN 1
 _ACEOF
 
 fi
 
 
-echo "$as_me:$LINENO: checking for struct sockaddr_in.sin_len" >&5
-echo $ECHO_N "checking for struct sockaddr_in.sin_len... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for struct sockaddr_in.sin_len" >&5
+echo $ECHO_N "checking for struct sockaddr_in.sin_len... $ECHO_C" >&6; }
 if test "${ac_cv_member_struct_sockaddr_in_sin_len+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -9858,38 +12173,51 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_in_sin_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
@@ -9906,56 +12234,71 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_in_sin_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_member_struct_sockaddr_in_sin_len=no
+	ac_cv_member_struct_sockaddr_in_sin_len=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_in_sin_len" >&5
-echo "${ECHO_T}$ac_cv_member_struct_sockaddr_in_sin_len" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_in_sin_len" >&5
+echo "${ECHO_T}$ac_cv_member_struct_sockaddr_in_sin_len" >&6; }
 if test $ac_cv_member_struct_sockaddr_in_sin_len = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKADDR_IN_LEN 1
 _ACEOF
 
 fi
 
 
-echo "$as_me:$LINENO: checking for struct sockaddr_un.sun_len" >&5
-echo $ECHO_N "checking for struct sockaddr_un.sun_len... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for struct sockaddr_un.sun_len" >&5
+echo $ECHO_N "checking for struct sockaddr_un.sun_len... $ECHO_C" >&6; }
 if test "${ac_cv_member_struct_sockaddr_un_sun_len+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -9976,38 +12319,51 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_un_sun_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
@@ -10024,56 +12380,71 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_un_sun_len=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_member_struct_sockaddr_un_sun_len=no
+	ac_cv_member_struct_sockaddr_un_sun_len=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_un_sun_len" >&5
-echo "${ECHO_T}$ac_cv_member_struct_sockaddr_un_sun_len" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_un_sun_len" >&5
+echo "${ECHO_T}$ac_cv_member_struct_sockaddr_un_sun_len" >&6; }
 if test $ac_cv_member_struct_sockaddr_un_sun_len = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKADDR_UN_LEN 1
 _ACEOF
 
 fi
 
 
-echo "$as_me:$LINENO: checking struct sockaddr_storage" >&5
-echo $ECHO_N "checking struct sockaddr_storage... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking struct sockaddr_storage" >&5
+echo $ECHO_N "checking struct sockaddr_storage... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
@@ -10085,50 +12456,64 @@
 struct sockaddr_storage x;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+  { echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKADDR_STORAGE 1
 _ACEOF
 
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+	{ echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
 
-echo "$as_me:$LINENO: checking for struct sockaddr_in6.sin6_scope_id" >&5
-echo $ECHO_N "checking for struct sockaddr_in6.sin6_scope_id... $ECHO_C" >&6
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+
+{ echo "$as_me:$LINENO: checking for struct sockaddr_in6.sin6_scope_id" >&5
+echo $ECHO_N "checking for struct sockaddr_in6.sin6_scope_id... $ECHO_C" >&6; }
 if test "${ac_cv_member_struct_sockaddr_in6_sin6_scope_id+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -10149,38 +12534,51 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_in6_sin6_scope_id=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-cat >conftest.$ac_ext <<_ACEOF
+	cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
@@ -10197,56 +12595,71 @@
 return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_member_struct_sockaddr_in6_sin6_scope_id=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_member_struct_sockaddr_in6_sin6_scope_id=no
+	ac_cv_member_struct_sockaddr_in6_sin6_scope_id=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_in6_sin6_scope_id" >&5
-echo "${ECHO_T}$ac_cv_member_struct_sockaddr_in6_sin6_scope_id" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_member_struct_sockaddr_in6_sin6_scope_id" >&5
+echo "${ECHO_T}$ac_cv_member_struct_sockaddr_in6_sin6_scope_id" >&6; }
 if test $ac_cv_member_struct_sockaddr_in6_sin6_scope_id = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKADDR_IN6_SCOPE_ID 1
 _ACEOF
 
 fi
 
 
-echo "$as_me:$LINENO: checking struct stat64" >&5
-echo $ECHO_N "checking struct stat64... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking struct stat64" >&5
+echo $ECHO_N "checking struct stat64... $ECHO_C" >&6; }
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
@@ -10272,57 +12685,71 @@
 struct stat64 st;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
-  echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+  { echo "$as_me:$LINENO: result: yes" >&5
+echo "${ECHO_T}yes" >&6; }
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_STRUCT_STAT64 1
 _ACEOF
 
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+	{ echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 
 # if we can't find strcasecmp, look in -lresolv (for Unixware at least)
 #
 
 for ac_func in strcasecmp
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -10342,160 +12769,183 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
 done
 
 if test x"$ac_cv_func_strcasecmp" = x"no"; then
 
-echo "$as_me:$LINENO: checking for strcasecmp in -lresolv" >&5
-echo $ECHO_N "checking for strcasecmp in -lresolv... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for strcasecmp in -lresolv" >&5
+echo $ECHO_N "checking for strcasecmp in -lresolv... $ECHO_C" >&6; }
 if test "${ac_cv_lib_resolv_strcasecmp+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lresolv  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char strcasecmp ();
 int
 main ()
 {
-strcasecmp ();
+return strcasecmp ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_resolv_strcasecmp=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_resolv_strcasecmp=no
+	ac_cv_lib_resolv_strcasecmp=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_resolv_strcasecmp" >&5
-echo "${ECHO_T}$ac_cv_lib_resolv_strcasecmp" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_resolv_strcasecmp" >&5
+echo "${ECHO_T}$ac_cv_lib_resolv_strcasecmp" >&6; }
 if test $ac_cv_lib_resolv_strcasecmp = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBRESOLV 1
 _ACEOF
 
   LIBS="-lresolv $LIBS"
 
 fi
 
 fi
 
 
-echo "$as_me:$LINENO: checking whether utime accepts a null argument" >&5
-echo $ECHO_N "checking whether utime accepts a null argument... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether utime accepts a null argument" >&5
+echo $ECHO_N "checking whether utime accepts a null argument... $ECHO_C" >&6; }
 if test "${ac_cv_func_utime_null+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   rm -f conftest.data; >conftest.data
 # Sequent interprets utime(file, 0) to mean use start of epoch.  Wrong.
 if test "$cross_compiling" = yes; then
@@ -10509,60 +12959,70 @@
 /* end confdefs.h.  */
 $ac_includes_default
 int
 main ()
 {
 struct stat s, t;
-  exit (!(stat ("conftest.data", &s) == 0
-	  && utime ("conftest.data", (long *)0) == 0
-	  && stat ("conftest.data", &t) == 0
-	  && t.st_mtime >= s.st_mtime
-	  && t.st_mtime - s.st_mtime < 120));
+  return ! (stat ("conftest.data", &s) == 0
+	    && utime ("conftest.data", 0) == 0
+	    && stat ("conftest.data", &t) == 0
+	    && t.st_mtime >= s.st_mtime
+	    && t.st_mtime - s.st_mtime < 120);
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_func_utime_null=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 ac_cv_func_utime_null=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
-rm -f core *.core
+
+
 fi
-echo "$as_me:$LINENO: result: $ac_cv_func_utime_null" >&5
-echo "${ECHO_T}$ac_cv_func_utime_null" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_func_utime_null" >&5
+echo "${ECHO_T}$ac_cv_func_utime_null" >&6; }
 if test $ac_cv_func_utime_null = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_UTIME_NULL 1
 _ACEOF
 
 fi
 rm -f conftest.data
 
 # The Ultrix 4.2 mips builtin alloca declared by alloca.h only works
 # for constant arguments.  Useless!
-echo "$as_me:$LINENO: checking for working alloca.h" >&5
-echo $ECHO_N "checking for working alloca.h... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for working alloca.h" >&5
+echo $ECHO_N "checking for working alloca.h... $ECHO_C" >&6; }
 if test "${ac_cv_working_alloca_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -10571,59 +13031,74 @@
 /* end confdefs.h.  */
 #include <alloca.h>
 int
 main ()
 {
 char *p = (char *) alloca (2 * sizeof (int));
+			  if (p) return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_working_alloca_h=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_working_alloca_h=no
+	ac_cv_working_alloca_h=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_working_alloca_h" >&5
-echo "${ECHO_T}$ac_cv_working_alloca_h" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_working_alloca_h" >&5
+echo "${ECHO_T}$ac_cv_working_alloca_h" >&6; }
 if test $ac_cv_working_alloca_h = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_ALLOCA_H 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for alloca" >&5
-echo $ECHO_N "checking for alloca... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for alloca" >&5
+echo $ECHO_N "checking for alloca... $ECHO_C" >&6; }
 if test "${ac_cv_func_alloca_works+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
@@ -10634,13 +13109,13 @@
 # define alloca __builtin_alloca
 #else
 # ifdef _MSC_VER
 #  include <malloc.h>
 #  define alloca _alloca
 # else
-#  if HAVE_ALLOCA_H
+#  ifdef HAVE_ALLOCA_H
 #   include <alloca.h>
 #  else
 #   ifdef _AIX
  #pragma alloca
 #   else
 #    ifndef alloca /* predefined by HP cc +Olibcalls */
@@ -10652,49 +13127,64 @@
 #endif
 
 int
 main ()
 {
 char *p = (char *) alloca (1);
+				    if (p) return 0;
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_func_alloca_works=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_func_alloca_works=no
+	ac_cv_func_alloca_works=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_func_alloca_works" >&5
-echo "${ECHO_T}$ac_cv_func_alloca_works" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_func_alloca_works" >&5
+echo "${ECHO_T}$ac_cv_func_alloca_works" >&6; }
 
 if test $ac_cv_func_alloca_works = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_ALLOCA 1
 _ACEOF
@@ -10702,31 +13192,31 @@
 else
   # The SVR3 libPW and SVR4 libucb both contain incompatible functions
 # that cause trouble.  Some versions do not even contain alloca or
 # contain a buggy version.  If you still want to use their alloca,
 # use ar to extract alloca.o from them instead of compiling alloca.c.
 
-ALLOCA=alloca.$ac_objext
+ALLOCA=\${LIBOBJDIR}alloca.$ac_objext
 
 cat >>confdefs.h <<\_ACEOF
 #define C_ALLOCA 1
 _ACEOF
 
 
-echo "$as_me:$LINENO: checking whether \`alloca.c' needs Cray hooks" >&5
-echo $ECHO_N "checking whether \`alloca.c' needs Cray hooks... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether \`alloca.c' needs Cray hooks" >&5
+echo $ECHO_N "checking whether \`alloca.c' needs Cray hooks... $ECHO_C" >&6; }
 if test "${ac_cv_os_cray+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
-#if defined(CRAY) && ! defined(CRAY2)
+#if defined CRAY && ! defined CRAY2
 webecray
 #else
 wenotbecray
 #endif
 
 _ACEOF
@@ -10736,20 +13226,20 @@
 else
   ac_cv_os_cray=no
 fi
 rm -f conftest*
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_os_cray" >&5
-echo "${ECHO_T}$ac_cv_os_cray" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_os_cray" >&5
+echo "${ECHO_T}$ac_cv_os_cray" >&6; }
 if test $ac_cv_os_cray = yes; then
   for ac_func in _getb67 GETB67 getb67; do
     as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -10769,99 +13259,109 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
 
 cat >>confdefs.h <<_ACEOF
 #define CRAY_STACKSEG_END $ac_func
 _ACEOF
 
     break
 fi
 
   done
 fi
 
-echo "$as_me:$LINENO: checking stack direction for C alloca" >&5
-echo $ECHO_N "checking stack direction for C alloca... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking stack direction for C alloca" >&5
+echo $ECHO_N "checking stack direction for C alloca... $ECHO_C" >&6; }
 if test "${ac_cv_c_stack_direction+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   if test "$cross_compiling" = yes; then
   ac_cv_c_stack_direction=0
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
+$ac_includes_default
 int
 find_stack_direction ()
 {
   static char *addr = 0;
   auto char dummy;
   if (addr == 0)
@@ -10873,40 +13373,51 @@
     return (&dummy > addr) ? 1 : -1;
 }
 
 int
 main ()
 {
-  exit (find_stack_direction () < 0);
+  return find_stack_direction () < 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_c_stack_direction=1
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 ac_cv_c_stack_direction=-1
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_stack_direction" >&5
-echo "${ECHO_T}$ac_cv_c_stack_direction" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_c_stack_direction" >&5
+echo "${ECHO_T}$ac_cv_c_stack_direction" >&6; }
 
 cat >>confdefs.h <<_ACEOF
 #define STACK_DIRECTION $ac_cv_c_stack_direction
 _ACEOF
 
 
@@ -10969,15 +13480,15 @@
     strlcat strlcpy strtol mallinfo getgroups setgroups geteuid getegid \
     setlocale setmode open64 lseek64 mkstemp64 mtrace va_copy __va_copy \
     strerror putenv iconv_open locale_charset nl_langinfo \
     sigaction sigprocmask
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -10997,73 +13508,82 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
@@ -11072,15 +13592,15 @@
 
 
 
 for ac_func in getpgrp tcgetpgrp
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_func" >&5
-echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-if eval "test \"\${$as_ac_var+set}\" = set"; then
+{ echo "$as_me:$LINENO: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
+if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -11100,84 +13620,93 @@
 #else
 # include <assert.h>
 #endif
 
 #undef $ac_func
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
-{
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char $ac_func ();
 /* The GNU C library defines this for functions which it implements
     to always fail with ENOSYS.  Some functions are actually named
     something starting with __ and the normal name is an alias.  */
-#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+#if defined __stub_$ac_func || defined __stub___$ac_func
 choke me
-#else
-char (*f) () = $ac_func;
-#endif
-#ifdef __cplusplus
-}
 #endif
 
 int
 main ()
 {
-return f != $ac_func;
+return $ac_func ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_var=no"
+	eval "$as_ac_var=no"
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+ac_res=`eval echo '${'$as_ac_var'}'`
+	       { echo "$as_me:$LINENO: result: $ac_res" >&5
+echo "${ECHO_T}$ac_res" >&6; }
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<_ACEOF
 #define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
 done
 
 if test $ac_cv_func_getpgrp = yes; then
-    echo "$as_me:$LINENO: checking whether getpgrp requires zero arguments" >&5
-echo $ECHO_N "checking whether getpgrp requires zero arguments... $ECHO_C" >&6
+    { echo "$as_me:$LINENO: checking whether getpgrp requires zero arguments" >&5
+echo $ECHO_N "checking whether getpgrp requires zero arguments... $ECHO_C" >&6; }
 if test "${ac_cv_func_getpgrp_void+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   # Use it with a single arg.
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -11192,56 +13721,70 @@
 getpgrp (0);
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_func_getpgrp_void=no
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_func_getpgrp_void=yes
+	ac_cv_func_getpgrp_void=yes
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_func_getpgrp_void" >&5
-echo "${ECHO_T}$ac_cv_func_getpgrp_void" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_func_getpgrp_void" >&5
+echo "${ECHO_T}$ac_cv_func_getpgrp_void" >&6; }
 if test $ac_cv_func_getpgrp_void = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define GETPGRP_VOID 1
 _ACEOF
 
 fi
 
 fi
 
-echo "$as_me:$LINENO: checking whether chown() modifies symlinks" >&5
-echo $ECHO_N "checking whether chown() modifies symlinks... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether chown() modifies symlinks" >&5
+echo $ECHO_N "checking whether chown() modifies symlinks... $ECHO_C" >&6; }
 if test "${rsync_cv_chown_modifies_symlink+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
   if test "$cross_compiling" = yes; then
   rsync_cv_chown_modifies_symlink=no
@@ -11264,46 +13807,57 @@
 	if (symlink("conftest.no-such", dangling_symlink) < 0) abort();
 	if (chown(dangling_symlink, getuid(), getgid()) < 0 && errno == ENOENT) exit(1);
 	exit(0);
     }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_chown_modifies_symlink=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_chown_modifies_symlink=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_chown_modifies_symlink" >&5
-echo "${ECHO_T}$rsync_cv_chown_modifies_symlink" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_chown_modifies_symlink" >&5
+echo "${ECHO_T}$rsync_cv_chown_modifies_symlink" >&6; }
 if test $rsync_cv_chown_modifies_symlink = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define CHOWN_MODIFIES_SYMLINK 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking whether link() can hard-link symlinks" >&5
-echo $ECHO_N "checking whether link() can hard-link symlinks... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether link() can hard-link symlinks" >&5
+echo $ECHO_N "checking whether link() can hard-link symlinks... $ECHO_C" >&6; }
 if test "${rsync_cv_can_hardlink_symlink+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
   if test "$cross_compiling" = yes; then
   rsync_cv_can_hardlink_symlink=no
@@ -11326,46 +13880,57 @@
 	if (symlink("conftest.no-such", FILENAME) < 0) abort();
 	if (link(FILENAME, FILENAME "2") < 0) exit(1);
 	exit(0);
     }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_can_hardlink_symlink=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_can_hardlink_symlink=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_can_hardlink_symlink" >&5
-echo "${ECHO_T}$rsync_cv_can_hardlink_symlink" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_can_hardlink_symlink" >&5
+echo "${ECHO_T}$rsync_cv_can_hardlink_symlink" >&6; }
 if test $rsync_cv_can_hardlink_symlink = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define CAN_HARDLINK_SYMLINK 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking whether link() can hard-link special files" >&5
-echo $ECHO_N "checking whether link() can hard-link special files... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether link() can hard-link special files" >&5
+echo $ECHO_N "checking whether link() can hard-link special files... $ECHO_C" >&6; }
 if test "${rsync_cv_can_hardlink_special+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
   if test "$cross_compiling" = yes; then
   rsync_cv_can_hardlink_special=no
@@ -11388,46 +13953,57 @@
 	if (mkfifo(FILENAME, 0777) < 0) abort();
 	if (link(FILENAME, FILENAME "2") < 0) exit(1);
 	exit(0);
     }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_can_hardlink_special=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_can_hardlink_special=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_can_hardlink_special" >&5
-echo "${ECHO_T}$rsync_cv_can_hardlink_special" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_can_hardlink_special" >&5
+echo "${ECHO_T}$rsync_cv_can_hardlink_special" >&6; }
 if test $rsync_cv_can_hardlink_special = yes; then
 
 cat >>confdefs.h <<\_ACEOF
 #define CAN_HARDLINK_SPECIAL 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for working socketpair" >&5
-echo $ECHO_N "checking for working socketpair... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for working socketpair" >&5
+echo $ECHO_N "checking for working socketpair... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_SOCKETPAIR+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_HAVE_SOCKETPAIR=cross
@@ -11445,109 +14021,134 @@
 main() {
        int fd[2];
        exit((socketpair(AF_UNIX, SOCK_STREAM, 0, fd) != -1) ? 0 : 1);
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_SOCKETPAIR=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_HAVE_SOCKETPAIR=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_SOCKETPAIR" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_SOCKETPAIR" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_SOCKETPAIR" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_SOCKETPAIR" >&6; }
 if test x"$rsync_cv_HAVE_SOCKETPAIR" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_SOCKETPAIR 1
 _ACEOF
 
 fi
 
 if test x"$with_included_popt" != x"yes"; then
 
-echo "$as_me:$LINENO: checking for poptGetContext in -lpopt" >&5
-echo $ECHO_N "checking for poptGetContext in -lpopt... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for poptGetContext in -lpopt" >&5
+echo $ECHO_N "checking for poptGetContext in -lpopt... $ECHO_C" >&6; }
 if test "${ac_cv_lib_popt_poptGetContext+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lpopt  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char poptGetContext ();
 int
 main ()
 {
-poptGetContext ();
+return poptGetContext ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>conftest.er1
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_popt_poptGetContext=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_popt_poptGetContext=no
+	ac_cv_lib_popt_poptGetContext=no
 fi
-rm -f conftest.err conftest.$ac_objext \
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
       conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_popt_poptGetContext" >&5
-echo "${ECHO_T}$ac_cv_lib_popt_poptGetContext" >&6
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_popt_poptGetContext" >&5
+echo "${ECHO_T}$ac_cv_lib_popt_poptGetContext" >&6; }
 if test $ac_cv_lib_popt_poptGetContext = yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBPOPT 1
 _ACEOF
 
   LIBS="-lpopt $LIBS"
@@ -11555,33 +14156,33 @@
 else
   with_included_popt=yes
 fi
 
 fi
 
-echo "$as_me:$LINENO: checking whether to use included libpopt" >&5
-echo $ECHO_N "checking whether to use included libpopt... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether to use included libpopt" >&5
+echo $ECHO_N "checking whether to use included libpopt... $ECHO_C" >&6; }
 if test x"$with_included_popt" = x"yes"; then
-    echo "$as_me:$LINENO: result: $srcdir/popt" >&5
-echo "${ECHO_T}$srcdir/popt" >&6
+    { echo "$as_me:$LINENO: result: $srcdir/popt" >&5
+echo "${ECHO_T}$srcdir/popt" >&6; }
     BUILD_POPT='$(popt_OBJS)'
     CFLAGS="$CFLAGS -I$srcdir/popt"
     if test x"$ALLOCA" != x
     then
 	# this can be removed when/if we add an included alloca.c;
 	#  see autoconf documentation on AC_FUNC_ALLOCA
 	{ echo "$as_me:$LINENO: WARNING: included libpopt will use malloc, not alloca (which wastes a small amount of memory)" >&5
 echo "$as_me: WARNING: included libpopt will use malloc, not alloca (which wastes a small amount of memory)" >&2;}
     fi
 else
-    echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+    { echo "$as_me:$LINENO: result: no" >&5
+echo "${ECHO_T}no" >&6; }
 fi
 
-echo "$as_me:$LINENO: checking for unsigned char" >&5
-echo $ECHO_N "checking for unsigned char... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for unsigned char" >&5
+echo $ECHO_N "checking for unsigned char... $ECHO_C" >&6; }
 if test "${rsync_cv_SIGNED_CHAR_OK+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -11596,53 +14197,67 @@
 signed char *s = ""
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_SIGNED_CHAR_OK=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-rsync_cv_SIGNED_CHAR_OK=no
+	rsync_cv_SIGNED_CHAR_OK=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_SIGNED_CHAR_OK" >&5
-echo "${ECHO_T}$rsync_cv_SIGNED_CHAR_OK" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_SIGNED_CHAR_OK" >&5
+echo "${ECHO_T}$rsync_cv_SIGNED_CHAR_OK" >&6; }
 if test x"$rsync_cv_SIGNED_CHAR_OK" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define SIGNED_CHAR_OK 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for broken readdir" >&5
-echo $ECHO_N "checking for broken readdir... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for broken readdir" >&5
+echo $ECHO_N "checking for broken readdir... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_BROKEN_READDIR+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_HAVE_BROKEN_READDIR=cross
@@ -11657,46 +14272,57 @@
 #include <dirent.h>
 main() { struct dirent *di; DIR *d = opendir("."); di = readdir(d);
 if (di && di->d_name[-2] == '.' && di->d_name[-1] == 0 &&
 di->d_name[0] == 0) exit(0); exit(1);}
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_BROKEN_READDIR=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_HAVE_BROKEN_READDIR=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_BROKEN_READDIR" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_BROKEN_READDIR" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_BROKEN_READDIR" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_BROKEN_READDIR" >&6; }
 if test x"$rsync_cv_HAVE_BROKEN_READDIR" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_BROKEN_READDIR 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for utimbuf" >&5
-echo $ECHO_N "checking for utimbuf... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for utimbuf" >&5
+echo $ECHO_N "checking for utimbuf... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_UTIMBUF+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -11712,53 +14338,67 @@
 struct utimbuf tbuf;  tbuf.actime = 0; tbuf.modtime = 1; exit(utime("foo.c",&tbuf));
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_UTIMBUF=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-rsync_cv_HAVE_UTIMBUF=no
+	rsync_cv_HAVE_UTIMBUF=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_UTIMBUF" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_UTIMBUF" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_UTIMBUF" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_UTIMBUF" >&6; }
 if test x"$rsync_cv_HAVE_UTIMBUF" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_UTIMBUF 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking if gettimeofday takes tz argument" >&5
-echo $ECHO_N "checking if gettimeofday takes tz argument... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking if gettimeofday takes tz argument" >&5
+echo $ECHO_N "checking if gettimeofday takes tz argument... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_GETTIMEOFDAY_TZ+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
@@ -11774,53 +14414,67 @@
 struct timeval tv; exit(gettimeofday(&tv, NULL));
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>conftest.er1
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } &&
-	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; } &&
 	 { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_GETTIMEOFDAY_TZ=yes
 else
   echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-rsync_cv_HAVE_GETTIMEOFDAY_TZ=no
+	rsync_cv_HAVE_GETTIMEOFDAY_TZ=no
 fi
-rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_GETTIMEOFDAY_TZ" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_GETTIMEOFDAY_TZ" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_GETTIMEOFDAY_TZ" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_GETTIMEOFDAY_TZ" >&6; }
 if test x"$rsync_cv_HAVE_GETTIMEOFDAY_TZ" != x"no"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_GETTIMEOFDAY_TZ 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking for C99 vsnprintf" >&5
-echo $ECHO_N "checking for C99 vsnprintf... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for C99 vsnprintf" >&5
+echo $ECHO_N "checking for C99 vsnprintf... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_C99_VSNPRINTF+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_HAVE_C99_VSNPRINTF=cross
@@ -11849,47 +14503,58 @@
        exit(0);
 }
 main() { foo("hello"); }
 
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_C99_VSNPRINTF=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_HAVE_C99_VSNPRINTF=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_C99_VSNPRINTF" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_C99_VSNPRINTF" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_C99_VSNPRINTF" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_C99_VSNPRINTF" >&6; }
 if test x"$rsync_cv_HAVE_C99_VSNPRINTF" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_C99_VSNPRINTF 1
 _ACEOF
 
 fi
 
 
-echo "$as_me:$LINENO: checking for secure mkstemp" >&5
-echo $ECHO_N "checking for secure mkstemp... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking for secure mkstemp" >&5
+echo $ECHO_N "checking for secure mkstemp... $ECHO_C" >&6; }
 if test "${rsync_cv_HAVE_SECURE_MKSTEMP+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_HAVE_SECURE_MKSTEMP=cross
@@ -11913,36 +14578,47 @@
   if (fstat(fd, &st) != 0) exit(1);
   if ((st.st_mode & 0777) != 0600) exit(1);
   exit(0);
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_HAVE_SECURE_MKSTEMP=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_HAVE_SECURE_MKSTEMP=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_HAVE_SECURE_MKSTEMP" >&5
-echo "${ECHO_T}$rsync_cv_HAVE_SECURE_MKSTEMP" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_HAVE_SECURE_MKSTEMP" >&5
+echo "${ECHO_T}$rsync_cv_HAVE_SECURE_MKSTEMP" >&6; }
 if test x"$rsync_cv_HAVE_SECURE_MKSTEMP" = x"yes"; then
     case $target_os in
     hpux*)
 				{ echo "$as_me:$LINENO: WARNING: Skipping broken HP-UX mkstemp() -- using mktemp() instead" >&5
 echo "$as_me: WARNING: Skipping broken HP-UX mkstemp() -- using mktemp() instead" >&2;}
 	;;
@@ -11954,14 +14630,14 @@
 
 	;;
     esac
 fi
 
 
-echo "$as_me:$LINENO: checking if mknod creates FIFOs" >&5
-echo $ECHO_N "checking if mknod creates FIFOs... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking if mknod creates FIFOs" >&5
+echo $ECHO_N "checking if mknod creates FIFOs... $ECHO_C" >&6; }
 if test "${rsync_cv_MKNOD_CREATES_FIFOS+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_MKNOD_CREATES_FIFOS=cross
@@ -11979,46 +14655,57 @@
 main() { int rc, ec; char *fn = "fifo-test";
 unlink(fn); rc = mknod(fn,S_IFIFO,0600); ec = errno; unlink(fn);
 if (rc) {printf("(%d %d) ",rc,ec); return ec;}
 return 0;}
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_MKNOD_CREATES_FIFOS=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_MKNOD_CREATES_FIFOS=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_MKNOD_CREATES_FIFOS" >&5
-echo "${ECHO_T}$rsync_cv_MKNOD_CREATES_FIFOS" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_MKNOD_CREATES_FIFOS" >&5
+echo "${ECHO_T}$rsync_cv_MKNOD_CREATES_FIFOS" >&6; }
 if test x"$rsync_cv_MKNOD_CREATES_FIFOS" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define MKNOD_CREATES_FIFOS 1
 _ACEOF
 
 fi
 
-echo "$as_me:$LINENO: checking if mknod creates sockets" >&5
-echo $ECHO_N "checking if mknod creates sockets... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking if mknod creates sockets" >&5
+echo $ECHO_N "checking if mknod creates sockets... $ECHO_C" >&6; }
 if test "${rsync_cv_MKNOD_CREATES_SOCKETS+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 if test "$cross_compiling" = yes; then
   rsync_cv_MKNOD_CREATES_SOCKETS=cross
@@ -12036,49 +14723,60 @@
 main() { int rc, ec; char *fn = "sock-test";
 unlink(fn); rc = mknod(fn,S_IFSOCK,0600); ec = errno; unlink(fn);
 if (rc) {printf("(%d %d) ",rc,ec); return ec;}
 return 0;}
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
   echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   rsync_cv_MKNOD_CREATES_SOCKETS=yes
 else
   echo "$as_me: program exited with status $ac_status" >&5
 echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 rsync_cv_MKNOD_CREATES_SOCKETS=no
 fi
-rm -f core *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_MKNOD_CREATES_SOCKETS" >&5
-echo "${ECHO_T}$rsync_cv_MKNOD_CREATES_SOCKETS" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_MKNOD_CREATES_SOCKETS" >&5
+echo "${ECHO_T}$rsync_cv_MKNOD_CREATES_SOCKETS" >&6; }
 if test x"$rsync_cv_MKNOD_CREATES_SOCKETS" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define MKNOD_CREATES_SOCKETS 1
 _ACEOF
 
 fi
 
 #
 # The following test was mostly taken from the tcl/tk plus patches
 #
-echo "$as_me:$LINENO: checking whether -c -o works" >&5
-echo $ECHO_N "checking whether -c -o works... $ECHO_C" >&6
+{ echo "$as_me:$LINENO: checking whether -c -o works" >&5
+echo $ECHO_N "checking whether -c -o works... $ECHO_C" >&6; }
 if test "${rsync_cv_DASHC_WORKS_WITH_DASHO+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 rm -rf conftest*
 cat > conftest.$ac_ext <<EOF
@@ -12090,14 +14788,14 @@
 else
     rsync_cv_DASHC_WORKS_WITH_DASHO=no
 fi
 rm -rf conftest*
 
 fi
-echo "$as_me:$LINENO: result: $rsync_cv_DASHC_WORKS_WITH_DASHO" >&5
-echo "${ECHO_T}$rsync_cv_DASHC_WORKS_WITH_DASHO" >&6
+{ echo "$as_me:$LINENO: result: $rsync_cv_DASHC_WORKS_WITH_DASHO" >&5
+echo "${ECHO_T}$rsync_cv_DASHC_WORKS_WITH_DASHO" >&6; }
 if test x"$rsync_cv_DASHC_WORKS_WITH_DASHO" = x"yes"; then
     OBJ_SAVE="#"
     OBJ_RESTORE="#"
     CC_SHOBJ_FLAG='-o $@'
 else
     OBJ_SAVE='	@b=`basename $@ .o`;rm -f $$b.o.sav;if test -f $$b.o; then mv $$b.o $$b.o.sav;fi;'
@@ -12107,13 +14805,13 @@
 
 
 
 
 
 
-                                                  ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
+ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
 
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
 # tests run on this system so they can be shared between configure
 # scripts and configure runs, see configure's option --config-cache.
 # It is not useful on other systems.  If it contains results you don't
@@ -12127,79 +14825,84 @@
 # following values.
 
 _ACEOF
 
 # The following way of writing the cache mishandles newlines in values,
 # but we know of no workaround that is simple, portable, and efficient.
-# So, don't put newlines in cache variables' values.
+# So, we kill variables containing newlines.
 # Ultrix sh set writes to stderr and can't be redirected directly,
 # and sets the high bit in the cache file unless we assign to the vars.
-{
+(
+  for ac_var in `(set) 2>&1 | sed -n 's/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'`; do
+    eval ac_val=\$$ac_var
+    case $ac_val in #(
+    *${as_nl}*)
+      case $ac_var in #(
+      *_cv_*) { echo "$as_me:$LINENO: WARNING: Cache variable $ac_var contains a newline." >&5
+echo "$as_me: WARNING: Cache variable $ac_var contains a newline." >&2;} ;;
+      esac
+      case $ac_var in #(
+      _ | IFS | as_nl) ;; #(
+      *) $as_unset $ac_var ;;
+      esac ;;
+    esac
+  done
+
   (set) 2>&1 |
-    case `(ac_space=' '; set | grep ac_space) 2>&1` in
-    *ac_space=\ *)
+    case $as_nl`(ac_space=' '; set) 2>&1` in #(
+    *${as_nl}ac_space=\ *)
       # `set' does not quote correctly, so add quotes (double-quote
       # substitution turns \\\\ into \\, and sed turns \\ into \).
       sed -n \
 	"s/'/'\\\\''/g;
 	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\\2'/p"
-      ;;
+      ;; #(
     *)
       # `set' quotes correctly as required by POSIX, so do not add quotes.
-      sed -n \
-	"s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1=\\2/p"
+      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
       ;;
-    esac;
-} |
+    esac |
+    sort
+) |
   sed '
+     /^ac_cv_env_/b end
      t clear
-     : clear
+     :clear
      s/^\([^=]*\)=\(.*[{}].*\)$/test "${\1+set}" = set || &/
      t end
-     /^ac_cv_env/!s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
-     : end' >>confcache
-if diff $cache_file confcache >/dev/null 2>&1; then :; else
-  if test -w $cache_file; then
-    test "x$cache_file" != "x/dev/null" && echo "updating cache $cache_file"
+     s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
+     :end' >>confcache
+if diff "$cache_file" confcache >/dev/null 2>&1; then :; else
+  if test -w "$cache_file"; then
+    test "x$cache_file" != "x/dev/null" &&
+      { echo "$as_me:$LINENO: updating cache $cache_file" >&5
+echo "$as_me: updating cache $cache_file" >&6;}
     cat confcache >$cache_file
   else
-    echo "not updating unwritable cache $cache_file"
+    { echo "$as_me:$LINENO: not updating unwritable cache $cache_file" >&5
+echo "$as_me: not updating unwritable cache $cache_file" >&6;}
   fi
 fi
 rm -f confcache
 
 test "x$prefix" = xNONE && prefix=$ac_default_prefix
 # Let make expand exec_prefix.
 test "x$exec_prefix" = xNONE && exec_prefix='${prefix}'
 
-# VPATH may cause trouble with some makes, so we remove $(srcdir),
-# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
-# trailing colons and then remove the whole line if VPATH becomes empty
-# (actually we leave an empty line to preserve line numbers).
-if test "x$srcdir" = x.; then
-  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
-s/:*\$(srcdir):*/:/;
-s/:*\${srcdir}:*/:/;
-s/:*@srcdir@:*/:/;
-s/^\([^=]*=[	 ]*\):*/\1/;
-s/:*$//;
-s/^[^=]*=[	 ]*$//;
-}'
-fi
-
 DEFS=-DHAVE_CONFIG_H
 
 ac_libobjs=
 ac_ltlibobjs=
 for ac_i in : $LIBOBJS; do test "x$ac_i" = x: && continue
   # 1. Remove the extension, and $U if already installed.
-  ac_i=`echo "$ac_i" |
-	 sed 's/\$U\././;s/\.o$//;s/\.obj$//'`
-  # 2. Add them.
-  ac_libobjs="$ac_libobjs $ac_i\$U.$ac_objext"
-  ac_ltlibobjs="$ac_ltlibobjs $ac_i"'$U.lo'
+  ac_script='s/\$U\././;s/\.o$//;s/\.obj$//'
+  ac_i=`echo "$ac_i" | sed "$ac_script"`
+  # 2. Prepend LIBOBJDIR.  When used with automake>=1.10 LIBOBJDIR
+  #    will be set to the directory where LIBOBJS objects are built.
+  ac_libobjs="$ac_libobjs \${LIBOBJDIR}$ac_i\$U.$ac_objext"
+  ac_ltlibobjs="$ac_ltlibobjs \${LIBOBJDIR}$ac_i"'$U.lo'
 done
 LIBOBJS=$ac_libobjs
 
 LTLIBOBJS=$ac_ltlibobjs
 
 
@@ -12231,27 +14934,86 @@
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
   emulate sh
   NULLCMD=:
   # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
   # is contrary to our usage.  Disable this feature.
   alias -g '${1+"$@"}'='"$@"'
-elif test -n "${BASH_VERSION+set}" && (set -o posix) >/dev/null 2>&1; then
-  set -o posix
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in *posix*) set -o posix;; esac
 fi
+BIN_SH=xpg4; export BIN_SH # for Tru64
 DUALCASE=1; export DUALCASE # for MKS sh
 
+
+# PATH needs CR
+# Avoid depending upon Character Ranges.
+as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+as_cr_digits='0123456789'
+as_cr_alnum=$as_cr_Letters$as_cr_digits
+
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
+
 # Support unset when possible.
 if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
   as_unset=unset
 else
   as_unset=false
 fi
 
 
+# IFS
+# We need space, tab and new line, in precisely that order.  Quoting is
+# there to prevent editors from complaining about space-tab.
+# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+# splitting by setting IFS to empty value.)
+as_nl='
+'
+IFS=" ""	$as_nl"
+
+# Find who we are.  Look in the path if we contain no directory separator.
+case $0 in
+  *[\\/]* ) as_myself=$0 ;;
+  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+done
+IFS=$as_save_IFS
+
+     ;;
+esac
+# We did not find ourselves, most probably we were run as `sh COMMAND'
+# in which case we are not to be found in the path.
+if test "x$as_myself" = x; then
+  as_myself=$0
+fi
+if test ! -f "$as_myself"; then
+  echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+  { (exit 1); exit 1; }
+fi
+
 # Work around bugs in pre-3.0 UWIN ksh.
-$as_unset ENV MAIL MAILPATH
+for as_var in ENV MAIL MAILPATH
+do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+done
 PS1='$ '
 PS2='> '
 PS4='+ '
 
 # NLS nuisances.
 for as_var in \
@@ -12259,257 +15021,203 @@
   LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER \
   LC_TELEPHONE LC_TIME
 do
   if (set +x; test -z "`(eval $as_var=C; export $as_var) 2>&1`"); then
     eval $as_var=C; export $as_var
   else
-    $as_unset $as_var
+    ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
   fi
 done
 
 # Required to use basename.
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
-if (basename /) >/dev/null 2>&1 && test "X`basename / 2>&1`" = "X/"; then
+if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
   as_basename=basename
-else
-  as_basename=false
-fi
-
-
-# Name of the executable.
-as_me=`$as_basename "$0" ||
-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
-	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)$' \| \
-	 .     : '\(.\)' 2>/dev/null ||
-echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{ s//\1/; q; }
-  	  /^X\/\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\/\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-
-
-# PATH needs CR, and LINENO needs CR and PATH.
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
-
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+else
+  as_basename=false
 fi
 
 
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2"  || {
-  # Find who we are.  Look in the path if we contain no path at all
-  # relative or not.
-  case $0 in
-    *[\\/]* ) as_myself=$0 ;;
-    *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-done
+# Name of the executable.
+as_me=`$as_basename -- "$0" ||
+$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
+	 X"$0" : 'X\(//\)$' \| \
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+echo X/"$0" |
+    sed '/^.*\/\([^/][^/]*\)\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+
+# CDPATH.
+$as_unset CDPATH
+
+
 
-       ;;
-  esac
-  # We did not find ourselves, most probably we were run as `sh COMMAND'
-  # in which case we are not to be found in the path.
-  if test "x$as_myself" = x; then
-    as_myself=$0
-  fi
-  if test ! -f "$as_myself"; then
-    { { echo "$as_me:$LINENO: error: cannot find myself; rerun with an absolute path" >&5
-echo "$as_me: error: cannot find myself; rerun with an absolute path" >&2;}
-   { (exit 1); exit 1; }; }
-  fi
-  case $CONFIG_SHELL in
-  '')
-    as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for as_base in sh bash ksh sh5; do
-	 case $as_dir in
-	 /*)
-	   if ("$as_dir/$as_base" -c '
   as_lineno_1=$LINENO
   as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
   test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2" ') 2>/dev/null; then
-	     $as_unset BASH_ENV || test "${BASH_ENV+set}" != set || { BASH_ENV=; export BASH_ENV; }
-	     $as_unset ENV || test "${ENV+set}" != set || { ENV=; export ENV; }
-	     CONFIG_SHELL=$as_dir/$as_base
-	     export CONFIG_SHELL
-	     exec "$CONFIG_SHELL" "$0" ${1+"$@"}
-	   fi;;
-	 esac
-       done
-done
-;;
-  esac
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2" || {
 
   # Create $as_me.lineno as a copy of $as_myself, but with $LINENO
   # uniformly replaced by the line number.  The first 'sed' inserts a
-  # line-number line before each line; the second 'sed' does the real
-  # work.  The second script uses 'N' to pair each line-number line
-  # with the numbered line, and appends trailing '-' during
-  # substitution so that $LINENO is not a special case at line end.
+  # line-number line after each line using $LINENO; the second 'sed'
+  # does the real work.  The second script uses 'N' to pair each
+  # line-number line with the line containing $LINENO, and appends
+  # trailing '-' during substitution so that $LINENO is not a special
+  # case at line end.
   # (Raja R Harinath suggested sed '=', and Paul Eggert wrote the
-  # second 'sed' script.  Blame Lee E. McMahon for sed's syntax.  :-)
-  sed '=' <$as_myself |
+  # scripts with optimization help from Paolo Bonzini.  Blame Lee
+  # E. McMahon (1931-1989) for sed's syntax.  :-)
+  sed -n '
+    p
+    /[$]LINENO/=
+  ' <$as_myself |
     sed '
+      s/[$]LINENO.*/&-/
+      t lineno
+      b
+      :lineno
       N
-      s,$,-,
-      : loop
-      s,^\(['$as_cr_digits']*\)\(.*\)[$]LINENO\([^'$as_cr_alnum'_]\),\1\2\1\3,
+      :loop
+      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
       t loop
-      s,-$,,
-      s,^['$as_cr_digits']*\n,,
+      s/-\n.*//
     ' >$as_me.lineno &&
-  chmod +x $as_me.lineno ||
-    { { echo "$as_me:$LINENO: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&5
-echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2;}
+  chmod +x "$as_me.lineno" ||
+    { echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2
    { (exit 1); exit 1; }; }
 
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
-  # original and so on.  Autoconf is especially sensible to this).
-  . ./$as_me.lineno
+  # original and so on.  Autoconf is especially sensitive to this).
+  . "./$as_me.lineno"
   # Exit status is that of the last command.
   exit
 }
 
 
-case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
-  *c*,-n*) ECHO_N= ECHO_C='
-' ECHO_T='	' ;;
-  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
-  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
+if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+  as_dirname=dirname
+else
+  as_dirname=false
+fi
+
+ECHO_C= ECHO_N= ECHO_T=
+case `echo -n x` in
+-n*)
+  case `echo 'x\c'` in
+  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+  *)   ECHO_C='\c';;
+  esac;;
+*)
+  ECHO_N='-n';;
 esac
 
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
 rm -f conf$$ conf$$.exe conf$$.file
+if test -d conf$$.dir; then
+  rm -f conf$$.dir/conf$$.file
+else
+  rm -f conf$$.dir
+  mkdir conf$$.dir
+fi
 echo >conf$$.file
 if ln -s conf$$.file conf$$ 2>/dev/null; then
-  # We could just check for DJGPP; but this test a) works b) is more generic
-  # and c) will remain valid once DJGPP supports symlinks (DJGPP 2.04).
-  if test -f conf$$.exe; then
-    # Don't use ln at all; we don't have any links
+  as_ln_s='ln -s'
+  # ... but there are two gotchas:
+  # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+  # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+  # In both cases, we have to default to `cp -p'.
+  ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
     as_ln_s='cp -p'
-  else
-    as_ln_s='ln -s'
-  fi
 elif ln conf$$.file conf$$ 2>/dev/null; then
   as_ln_s=ln
 else
   as_ln_s='cp -p'
 fi
-rm -f conf$$ conf$$.exe conf$$.file
+rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+rmdir conf$$.dir 2>/dev/null
 
 if mkdir -p . 2>/dev/null; then
   as_mkdir_p=:
 else
   test -d ./-p && rmdir ./-p
   as_mkdir_p=false
 fi
 
-as_executable_p="test -f"
+# Find out whether ``test -x'' works.  Don't use a zero-byte file, as
+# systems may use methods other than mode bits to determine executability.
+cat >conf$$.file <<_ASEOF
+#! /bin/sh
+exit 0
+_ASEOF
+chmod +x conf$$.file
+if test -x conf$$.file >/dev/null 2>&1; then
+  as_executable_p="test -x"
+else
+  as_executable_p=:
+fi
+rm -f conf$$.file
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
 
 # Sed expression to map a string onto a valid variable name.
 as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
 
 
-# IFS
-# We need space, tab and new line, in precisely that order.
-as_nl='
-'
-IFS=" 	$as_nl"
-
-# CDPATH.
-$as_unset CDPATH
-
 exec 6>&1
 
-# Open the log real soon, to keep \$[0] and so on meaningful, and to
+# Save the log message, to keep $[0] and so on meaningful, and to
 # report actual input values of CONFIG_FILES etc. instead of their
-# values after options handling.  Logging --version etc. is OK.
-exec 5>>config.log
-{
-  echo
-  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
-## Running $as_me. ##
-_ASBOX
-} >&5
-cat >&5 <<_CSEOF
-
+# values after options handling.
+ac_log="
 This file was extended by $as_me, which was
-generated by GNU Autoconf 2.59.  Invocation command line was
+generated by GNU Autoconf 2.60a.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
   CONFIG_LINKS    = $CONFIG_LINKS
   CONFIG_COMMANDS = $CONFIG_COMMANDS
   $ $0 $@
 
-_CSEOF
-echo "on `(hostname || uname -n) 2>/dev/null | sed 1q`" >&5
-echo >&5
+on `(hostname || uname -n) 2>/dev/null | sed 1q`
+"
+
 _ACEOF
 
+cat >>$CONFIG_STATUS <<_ACEOF
 # Files that config.status was made for.
-if test -n "$ac_config_files"; then
-  echo "config_files=\"$ac_config_files\"" >>$CONFIG_STATUS
-fi
+config_files="$ac_config_files"
+config_headers="$ac_config_headers"
 
-if test -n "$ac_config_headers"; then
-  echo "config_headers=\"$ac_config_headers\"" >>$CONFIG_STATUS
-fi
-
-if test -n "$ac_config_links"; then
-  echo "config_links=\"$ac_config_links\"" >>$CONFIG_STATUS
-fi
-
-if test -n "$ac_config_commands"; then
-  echo "config_commands=\"$ac_config_commands\"" >>$CONFIG_STATUS
-fi
+_ACEOF
 
 cat >>$CONFIG_STATUS <<\_ACEOF
-
 ac_cs_usage="\
 \`$as_me' instantiates files from templates according to the
 current configuration.
 
 Usage: $0 [OPTIONS] [FILE]...
 
@@ -12511,13 +15219,13 @@
 \`$as_me' instantiates files from templates according to the
 current configuration.
 
 Usage: $0 [OPTIONS] [FILE]...
 
   -h, --help       print this help, then exit
-  -V, --version    print version number, then exit
+  -V, --version    print version number and configuration settings, then exit
   -q, --quiet      do not print progress messages
   -d, --debug      don't remove temporary files
       --recheck    update $as_me by reconfiguring in the same conditions
   --file=FILE[:TEMPLATE]
 		   instantiate the configuration file FILE
   --header=FILE[:TEMPLATE]
@@ -12527,89 +15235,82 @@
 $config_files
 
 Configuration headers:
 $config_headers
 
 Report bugs to <bug-autoconf@gnu.org>."
-_ACEOF
 
+_ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF
 ac_cs_version="\\
 config.status
-configured by $0, generated by GNU Autoconf 2.59,
-  with options \\"`echo "$ac_configure_args" | sed 's/[\\""\`\$]/\\\\&/g'`\\"
+configured by $0, generated by GNU Autoconf 2.60a,
+  with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
 
-Copyright (C) 2003 Free Software Foundation, Inc.
+Copyright (C) 2006 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
-srcdir=$srcdir
-INSTALL="$INSTALL"
+
+ac_pwd='$ac_pwd'
+srcdir='$srcdir'
+INSTALL='$INSTALL'
 _ACEOF
 
 cat >>$CONFIG_STATUS <<\_ACEOF
 # If no file are specified by the user, then we need to provide default
 # value.  By we need to know if files were specified by the user.
 ac_need_defaults=:
 while test $# != 0
 do
   case $1 in
   --*=*)
-    ac_option=`expr "x$1" : 'x\([^=]*\)='`
-    ac_optarg=`expr "x$1" : 'x[^=]*=\(.*\)'`
+    ac_option=`expr "X$1" : 'X\([^=]*\)='`
+    ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
     ac_shift=:
     ;;
-  -*)
+  *)
     ac_option=$1
     ac_optarg=$2
     ac_shift=shift
     ;;
-  *) # This is not an option, so the user has probably given explicit
-     # arguments.
-     ac_option=$1
-     ac_need_defaults=false;;
   esac
 
   case $ac_option in
   # Handling of the options.
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
   -recheck | --recheck | --rechec | --reche | --rech | --rec | --re | --r)
     ac_cs_recheck=: ;;
-  --version | --vers* | -V )
-    echo "$ac_cs_version"; exit 0 ;;
-  --he | --h)
-    # Conflict between --help and --header
-    { { echo "$as_me:$LINENO: error: ambiguous option: $1
-Try \`$0 --help' for more information." >&5
-echo "$as_me: error: ambiguous option: $1
-Try \`$0 --help' for more information." >&2;}
-   { (exit 1); exit 1; }; };;
-  --help | --hel | -h )
-    echo "$ac_cs_usage"; exit 0 ;;
-  --debug | --d* | -d )
+  --version | --versio | --versi | --vers | --ver | --ve | --v | -V )
+    echo "$ac_cs_version"; exit ;;
+  --debug | --debu | --deb | --de | --d | -d )
     debug=: ;;
   --file | --fil | --fi | --f )
     $ac_shift
     CONFIG_FILES="$CONFIG_FILES $ac_optarg"
     ac_need_defaults=false;;
   --header | --heade | --head | --hea )
     $ac_shift
     CONFIG_HEADERS="$CONFIG_HEADERS $ac_optarg"
     ac_need_defaults=false;;
+  --he | --h)
+    # Conflict between --help and --header
+    { echo "$as_me: error: ambiguous option: $1
+Try \`$0 --help' for more information." >&2
+   { (exit 1); exit 1; }; };;
+  --help | --hel | -h )
+    echo "$ac_cs_usage"; exit ;;
   -q | -quiet | --quiet | --quie | --qui | --qu | --q \
   | -silent | --silent | --silen | --sile | --sil | --si | --s)
     ac_cs_silent=: ;;
 
   # This is an error.
-  -*) { { echo "$as_me:$LINENO: error: unrecognized option: $1
-Try \`$0 --help' for more information." >&5
-echo "$as_me: error: unrecognized option: $1
-Try \`$0 --help' for more information." >&2;}
+  -*) { echo "$as_me: error: unrecognized option: $1
+Try \`$0 --help' for more information." >&2
    { (exit 1); exit 1; }; } ;;
 
-  *) ac_config_targets="$ac_config_targets $1" ;;
+  *) ac_config_targets="$ac_config_targets $1"
+     ac_need_defaults=false ;;
 
   esac
   shift
 done
 
 ac_configure_extra_args=
@@ -12619,33 +15320,46 @@
   ac_configure_extra_args="$ac_configure_extra_args --silent"
 fi
 
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF
 if \$ac_cs_recheck; then
-  echo "running $SHELL $0 " $ac_configure_args \$ac_configure_extra_args " --no-create --no-recursion" >&6
-  exec $SHELL $0 $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  echo "running CONFIG_SHELL=$SHELL $SHELL $0 "$ac_configure_args \$ac_configure_extra_args " --no-create --no-recursion" >&6
+  CONFIG_SHELL=$SHELL
+  export CONFIG_SHELL
+  exec $SHELL "$0"$ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
 fi
 
 _ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF
+exec 5>>config.log
+{
+  echo
+  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
+## Running $as_me. ##
+_ASBOX
+  echo "$ac_log"
+} >&5
 
-
-
-
+_ACEOF
+cat >>$CONFIG_STATUS <<_ACEOF
+_ACEOF
 
 cat >>$CONFIG_STATUS <<\_ACEOF
+
+# Handling of arguments.
 for ac_config_target in $ac_config_targets
 do
-  case "$ac_config_target" in
-  # Handling of arguments.
-  "Makefile" ) CONFIG_FILES="$CONFIG_FILES Makefile" ;;
-  "lib/dummy" ) CONFIG_FILES="$CONFIG_FILES lib/dummy" ;;
-  "zlib/dummy" ) CONFIG_FILES="$CONFIG_FILES zlib/dummy" ;;
-  "popt/dummy" ) CONFIG_FILES="$CONFIG_FILES popt/dummy" ;;
-  "shconfig" ) CONFIG_FILES="$CONFIG_FILES shconfig" ;;
-  "config.h" ) CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
+  case $ac_config_target in
+    "config.h") CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
+    "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
+    "lib/dummy") CONFIG_FILES="$CONFIG_FILES lib/dummy" ;;
+    "zlib/dummy") CONFIG_FILES="$CONFIG_FILES zlib/dummy" ;;
+    "popt/dummy") CONFIG_FILES="$CONFIG_FILES popt/dummy" ;;
+    "shconfig") CONFIG_FILES="$CONFIG_FILES shconfig" ;;
+
   *) { { echo "$as_me:$LINENO: error: invalid argument: $ac_config_target" >&5
 echo "$as_me: error: invalid argument: $ac_config_target" >&2;}
    { (exit 1); exit 1; }; };;
   esac
 done
 
@@ -12656,577 +15371,529 @@
 if $ac_need_defaults; then
   test "${CONFIG_FILES+set}" = set || CONFIG_FILES=$config_files
   test "${CONFIG_HEADERS+set}" = set || CONFIG_HEADERS=$config_headers
 fi
 
 # Have a temporary directory for convenience.  Make it in the build tree
-# simply because there is no reason to put it here, and in addition,
+# simply because there is no reason against having it here, and in addition,
 # creating and moving files from /tmp can sometimes cause problems.
-# Create a temporary directory, and hook for its removal unless debugging.
+# Hook for its removal unless debugging.
+# Note that there is a small window in which the directory will not be cleaned:
+# after its creation but before its name has been assigned to `$tmp'.
 $debug ||
 {
-  trap 'exit_status=$?; rm -rf $tmp && exit $exit_status' 0
+  tmp=
+  trap 'exit_status=$?
+  { test -z "$tmp" || test ! -d "$tmp" || rm -fr "$tmp"; } && exit $exit_status
+' 0
   trap '{ (exit 1); exit 1; }' 1 2 13 15
 }
-
 # Create a (secure) tmp directory for tmp files.
 
 {
-  tmp=`(umask 077 && mktemp -d -q "./confstatXXXXXX") 2>/dev/null` &&
+  tmp=`(umask 077 && mktemp -d "./confXXXXXX") 2>/dev/null` &&
   test -n "$tmp" && test -d "$tmp"
 }  ||
 {
-  tmp=./confstat$$-$RANDOM
-  (umask 077 && mkdir $tmp)
+  tmp=./conf$$-$RANDOM
+  (umask 077 && mkdir "$tmp")
 } ||
 {
    echo "$me: cannot create a temporary directory in ." >&2
    { (exit 1); exit 1; }
 }
 
-_ACEOF
-
-cat >>$CONFIG_STATUS <<_ACEOF
-
 #
-# CONFIG_FILES section.
+# Set up the sed scripts for CONFIG_FILES section.
 #
 
 # No need to generate the scripts if there are no CONFIG_FILES.
 # This happens for instance when ./config.status config.h
-if test -n "\$CONFIG_FILES"; then
-  # Protect against being on the right side of a sed subst in config.status.
-  sed 's/,@/@@/; s/@,/@@/; s/,;t t\$/@;t t/; /@;t t\$/s/[\\\\&,]/\\\\&/g;
-   s/@@/,@/; s/@@/@,/; s/@;t t\$/,;t t/' >\$tmp/subs.sed <<\\CEOF
-s,@SHELL@,$SHELL,;t t
-s,@PATH_SEPARATOR@,$PATH_SEPARATOR,;t t
-s,@PACKAGE_NAME@,$PACKAGE_NAME,;t t
-s,@PACKAGE_TARNAME@,$PACKAGE_TARNAME,;t t
-s,@PACKAGE_VERSION@,$PACKAGE_VERSION,;t t
-s,@PACKAGE_STRING@,$PACKAGE_STRING,;t t
-s,@PACKAGE_BUGREPORT@,$PACKAGE_BUGREPORT,;t t
-s,@exec_prefix@,$exec_prefix,;t t
-s,@prefix@,$prefix,;t t
-s,@program_transform_name@,$program_transform_name,;t t
-s,@bindir@,$bindir,;t t
-s,@sbindir@,$sbindir,;t t
-s,@libexecdir@,$libexecdir,;t t
-s,@datadir@,$datadir,;t t
-s,@sysconfdir@,$sysconfdir,;t t
-s,@sharedstatedir@,$sharedstatedir,;t t
-s,@localstatedir@,$localstatedir,;t t
-s,@libdir@,$libdir,;t t
-s,@includedir@,$includedir,;t t
-s,@oldincludedir@,$oldincludedir,;t t
-s,@infodir@,$infodir,;t t
-s,@mandir@,$mandir,;t t
-s,@build_alias@,$build_alias,;t t
-s,@host_alias@,$host_alias,;t t
-s,@target_alias@,$target_alias,;t t
-s,@DEFS@,$DEFS,;t t
-s,@ECHO_C@,$ECHO_C,;t t
-s,@ECHO_N@,$ECHO_N,;t t
-s,@ECHO_T@,$ECHO_T,;t t
-s,@LIBS@,$LIBS,;t t
-s,@RSYNC_VERSION@,$RSYNC_VERSION,;t t
-s,@build@,$build,;t t
-s,@build_cpu@,$build_cpu,;t t
-s,@build_vendor@,$build_vendor,;t t
-s,@build_os@,$build_os,;t t
-s,@host@,$host,;t t
-s,@host_cpu@,$host_cpu,;t t
-s,@host_vendor@,$host_vendor,;t t
-s,@host_os@,$host_os,;t t
-s,@target@,$target,;t t
-s,@target_cpu@,$target_cpu,;t t
-s,@target_vendor@,$target_vendor,;t t
-s,@target_os@,$target_os,;t t
-s,@CC@,$CC,;t t
-s,@CFLAGS@,$CFLAGS,;t t
-s,@LDFLAGS@,$LDFLAGS,;t t
-s,@CPPFLAGS@,$CPPFLAGS,;t t
-s,@ac_ct_CC@,$ac_ct_CC,;t t
-s,@EXEEXT@,$EXEEXT,;t t
-s,@OBJEXT@,$OBJEXT,;t t
-s,@CPP@,$CPP,;t t
-s,@EGREP@,$EGREP,;t t
-s,@INSTALL_PROGRAM@,$INSTALL_PROGRAM,;t t
-s,@INSTALL_SCRIPT@,$INSTALL_SCRIPT,;t t
-s,@INSTALL_DATA@,$INSTALL_DATA,;t t
-s,@HAVE_REMSH@,$HAVE_REMSH,;t t
-s,@LIBOBJS@,$LIBOBJS,;t t
-s,@ALLOCA@,$ALLOCA,;t t
-s,@OBJ_SAVE@,$OBJ_SAVE,;t t
-s,@OBJ_RESTORE@,$OBJ_RESTORE,;t t
-s,@CC_SHOBJ_FLAG@,$CC_SHOBJ_FLAG,;t t
-s,@BUILD_POPT@,$BUILD_POPT,;t t
-s,@LTLIBOBJS@,$LTLIBOBJS,;t t
-CEOF
-
-_ACEOF
-
-  cat >>$CONFIG_STATUS <<\_ACEOF
-  # Split the substitutions into bite-sized pieces for seds with
-  # small command number limits, like on Digital OSF/1 and HP-UX.
-  ac_max_sed_lines=48
-  ac_sed_frag=1 # Number of current file.
-  ac_beg=1 # First line for current file.
-  ac_end=$ac_max_sed_lines # Line after last line for current file.
-  ac_more_lines=:
-  ac_sed_cmds=
-  while $ac_more_lines; do
-    if test $ac_beg -gt 1; then
-      sed "1,${ac_beg}d; ${ac_end}q" $tmp/subs.sed >$tmp/subs.frag
-    else
-      sed "${ac_end}q" $tmp/subs.sed >$tmp/subs.frag
-    fi
-    if test ! -s $tmp/subs.frag; then
-      ac_more_lines=false
-    else
-      # The purpose of the label and of the branching condition is to
-      # speed up the sed processing (if there are no `@' at all, there
-      # is no need to browse any of the substitutions).
-      # These are the two extra sed commands mentioned above.
-      (echo ':t
-  /@[a-zA-Z_][a-zA-Z_0-9]*@/!b' && cat $tmp/subs.frag) >$tmp/subs-$ac_sed_frag.sed
-      if test -z "$ac_sed_cmds"; then
-	ac_sed_cmds="sed -f $tmp/subs-$ac_sed_frag.sed"
-      else
-	ac_sed_cmds="$ac_sed_cmds | sed -f $tmp/subs-$ac_sed_frag.sed"
-      fi
-      ac_sed_frag=`expr $ac_sed_frag + 1`
-      ac_beg=$ac_end
-      ac_end=`expr $ac_end + $ac_max_sed_lines`
-    fi
-  done
-  if test -z "$ac_sed_cmds"; then
-    ac_sed_cmds=cat
+if test -n "$CONFIG_FILES"; then
+
+_ACEOF
+
+
+
+ac_delim='%!_!# '
+for ac_last_try in false false false false false :; do
+  cat >conf$$subs.sed <<_ACEOF
+SHELL!$SHELL$ac_delim
+PATH_SEPARATOR!$PATH_SEPARATOR$ac_delim
+PACKAGE_NAME!$PACKAGE_NAME$ac_delim
+PACKAGE_TARNAME!$PACKAGE_TARNAME$ac_delim
+PACKAGE_VERSION!$PACKAGE_VERSION$ac_delim
+PACKAGE_STRING!$PACKAGE_STRING$ac_delim
+PACKAGE_BUGREPORT!$PACKAGE_BUGREPORT$ac_delim
+exec_prefix!$exec_prefix$ac_delim
+prefix!$prefix$ac_delim
+program_transform_name!$program_transform_name$ac_delim
+bindir!$bindir$ac_delim
+sbindir!$sbindir$ac_delim
+libexecdir!$libexecdir$ac_delim
+datarootdir!$datarootdir$ac_delim
+datadir!$datadir$ac_delim
+sysconfdir!$sysconfdir$ac_delim
+sharedstatedir!$sharedstatedir$ac_delim
+localstatedir!$localstatedir$ac_delim
+includedir!$includedir$ac_delim
+oldincludedir!$oldincludedir$ac_delim
+docdir!$docdir$ac_delim
+infodir!$infodir$ac_delim
+htmldir!$htmldir$ac_delim
+dvidir!$dvidir$ac_delim
+pdfdir!$pdfdir$ac_delim
+psdir!$psdir$ac_delim
+libdir!$libdir$ac_delim
+localedir!$localedir$ac_delim
+mandir!$mandir$ac_delim
+DEFS!$DEFS$ac_delim
+ECHO_C!$ECHO_C$ac_delim
+ECHO_N!$ECHO_N$ac_delim
+ECHO_T!$ECHO_T$ac_delim
+LIBS!$LIBS$ac_delim
+build_alias!$build_alias$ac_delim
+host_alias!$host_alias$ac_delim
+target_alias!$target_alias$ac_delim
+RSYNC_VERSION!$RSYNC_VERSION$ac_delim
+build!$build$ac_delim
+build_cpu!$build_cpu$ac_delim
+build_vendor!$build_vendor$ac_delim
+build_os!$build_os$ac_delim
+host!$host$ac_delim
+host_cpu!$host_cpu$ac_delim
+host_vendor!$host_vendor$ac_delim
+host_os!$host_os$ac_delim
+target!$target$ac_delim
+target_cpu!$target_cpu$ac_delim
+target_vendor!$target_vendor$ac_delim
+target_os!$target_os$ac_delim
+CC!$CC$ac_delim
+CFLAGS!$CFLAGS$ac_delim
+LDFLAGS!$LDFLAGS$ac_delim
+CPPFLAGS!$CPPFLAGS$ac_delim
+ac_ct_CC!$ac_ct_CC$ac_delim
+EXEEXT!$EXEEXT$ac_delim
+OBJEXT!$OBJEXT$ac_delim
+CPP!$CPP$ac_delim
+GREP!$GREP$ac_delim
+EGREP!$EGREP$ac_delim
+INSTALL_PROGRAM!$INSTALL_PROGRAM$ac_delim
+INSTALL_SCRIPT!$INSTALL_SCRIPT$ac_delim
+INSTALL_DATA!$INSTALL_DATA$ac_delim
+HAVE_REMSH!$HAVE_REMSH$ac_delim
+LIBOBJS!$LIBOBJS$ac_delim
+ALLOCA!$ALLOCA$ac_delim
+OBJ_SAVE!$OBJ_SAVE$ac_delim
+OBJ_RESTORE!$OBJ_RESTORE$ac_delim
+CC_SHOBJ_FLAG!$CC_SHOBJ_FLAG$ac_delim
+BUILD_POPT!$BUILD_POPT$ac_delim
+LTLIBOBJS!$LTLIBOBJS$ac_delim
+_ACEOF
+
+  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 71; then
+    break
+  elif $ac_last_try; then
+    { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
+echo "$as_me: error: could not make $CONFIG_STATUS" >&2;}
+   { (exit 1); exit 1; }; }
+  else
+    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
   fi
-fi # test -n "$CONFIG_FILES"
+done
 
+ac_eof=`sed -n '/^CEOF[0-9]*$/s/CEOF/0/p' conf$$subs.sed`
+if test -n "$ac_eof"; then
+  ac_eof=`echo "$ac_eof" | sort -nru | sed 1q`
+  ac_eof=`expr $ac_eof + 1`
+fi
+
+cat >>$CONFIG_STATUS <<_ACEOF
+cat >"\$tmp/subs-1.sed" <<\CEOF$ac_eof
+/@[a-zA-Z_][a-zA-Z_0-9]*@/!b end
+_ACEOF
+sed '
+s/[,\\&]/\\&/g; s/@/@|#_!!_#|/g
+s/^/s,@/; s/!/@,|#_!!_#|/
+:n
+t n
+s/'"$ac_delim"'$/,g/; t
+s/$/\\/; p
+N; s/^.*\n//; s/[,\\&]/\\&/g; s/@/@|#_!!_#|/g; b n
+' >>$CONFIG_STATUS <conf$$subs.sed
+rm -f conf$$subs.sed
+cat >>$CONFIG_STATUS <<_ACEOF
+:end
+s/|#_!!_#|//g
+CEOF$ac_eof
 _ACEOF
+
+
+# VPATH may cause trouble with some makes, so we remove $(srcdir),
+# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
+# trailing colons and then remove the whole line if VPATH becomes empty
+# (actually we leave an empty line to preserve line numbers).
+if test "x$srcdir" = x.; then
+  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
+s/:*\$(srcdir):*/:/
+s/:*\${srcdir}:*/:/
+s/:*@srcdir@:*/:/
+s/^\([^=]*=[	 ]*\):*/\1/
+s/:*$//
+s/^[^=]*=[	 ]*$//
+}'
+fi
+
 cat >>$CONFIG_STATUS <<\_ACEOF
-for ac_file in : $CONFIG_FILES; do test "x$ac_file" = x: && continue
-  # Support "outfile[:infile[:infile...]]", defaulting infile="outfile.in".
-  case $ac_file in
-  - | *:- | *:-:* ) # input from stdin
-	cat >$tmp/stdin
-	ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-	ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  *:* ) ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-	ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  * )   ac_file_in=$ac_file.in ;;
+fi # test -n "$CONFIG_FILES"
+
+
+for ac_tag in  :F $CONFIG_FILES  :H $CONFIG_HEADERS
+do
+  case $ac_tag in
+  :[FHLC]) ac_mode=$ac_tag; continue;;
+  esac
+  case $ac_mode$ac_tag in
+  :[FHL]*:*);;
+  :L* | :C*:*) { { echo "$as_me:$LINENO: error: Invalid tag $ac_tag." >&5
+echo "$as_me: error: Invalid tag $ac_tag." >&2;}
+   { (exit 1); exit 1; }; };;
+  :[FH]-) ac_tag=-:-;;
+  :[FH]*) ac_tag=$ac_tag:$ac_tag.in;;
+  esac
+  ac_save_IFS=$IFS
+  IFS=:
+  set x $ac_tag
+  IFS=$ac_save_IFS
+  shift
+  ac_file=$1
+  shift
+
+  case $ac_mode in
+  :L) ac_source=$1;;
+  :[FH])
+    ac_file_inputs=
+    for ac_f
+    do
+      case $ac_f in
+      -) ac_f="$tmp/stdin";;
+      *) # Look for the file first in the build tree, then in the source tree
+	 # (if the path is not absolute).  The absolute path cannot be DOS-style,
+	 # because $ac_f cannot contain `:'.
+	 test -f "$ac_f" ||
+	   case $ac_f in
+	   [\\/$]*) false;;
+	   *) test -f "$srcdir/$ac_f" && ac_f="$srcdir/$ac_f";;
+	   esac ||
+	   { { echo "$as_me:$LINENO: error: cannot find input file: $ac_f" >&5
+echo "$as_me: error: cannot find input file: $ac_f" >&2;}
+   { (exit 1); exit 1; }; };;
+      esac
+      ac_file_inputs="$ac_file_inputs $ac_f"
+    done
+
+    # Let's still pretend it is `configure' which instantiates (i.e., don't
+    # use $as_me), people would be surprised to read:
+    #    /* config.h.  Generated by config.status.  */
+    configure_input="Generated from "`IFS=:
+	  echo $* | sed 's|^[^:]*/||;s|:[^:]*/|, |g'`" by configure."
+    if test x"$ac_file" != x-; then
+      configure_input="$ac_file.  $configure_input"
+      { echo "$as_me:$LINENO: creating $ac_file" >&5
+echo "$as_me: creating $ac_file" >&6;}
+    fi
+
+    case $ac_tag in
+    *:-:* | *:-) cat >"$tmp/stdin";;
+    esac
+    ;;
   esac
 
-  # Compute @srcdir@, @top_srcdir@, and @INSTALL@ for subdirectories.
-  ac_dir=`(dirname "$ac_file") 2>/dev/null ||
+  ac_dir=`$as_dirname -- "$ac_file" ||
 $as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
 	 X"$ac_file" : 'X\(//\)[^/]' \| \
 	 X"$ac_file" : 'X\(//\)$' \| \
-	 X"$ac_file" : 'X\(/\)' \| \
-	 .     : '\(.\)' 2>/dev/null ||
+	 X"$ac_file" : 'X\(/\)' \| . 2>/dev/null ||
 echo X"$ac_file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
   	  s/.*/./; q'`
-  { if $as_mkdir_p; then
-    mkdir -p "$ac_dir"
-  else
-    as_dir="$ac_dir"
+  { as_dir="$ac_dir"
+  case $as_dir in #(
+  -*) as_dir=./$as_dir;;
+  esac
+  test -d "$as_dir" || { $as_mkdir_p && mkdir -p "$as_dir"; } || {
     as_dirs=
-    while test ! -d "$as_dir"; do
-      as_dirs="$as_dir $as_dirs"
-      as_dir=`(dirname "$as_dir") 2>/dev/null ||
+    while :; do
+      case $as_dir in #(
+      *\'*) as_qdir=`echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #(
+      *) as_qdir=$as_dir;;
+      esac
+      as_dirs="'$as_qdir' $as_dirs"
+      as_dir=`$as_dirname -- "$as_dir" ||
 $as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
 	 X"$as_dir" : 'X\(//\)[^/]' \| \
 	 X"$as_dir" : 'X\(//\)$' \| \
-	 X"$as_dir" : 'X\(/\)' \| \
-	 .     : '\(.\)' 2>/dev/null ||
+	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
 echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
   	  s/.*/./; q'`
+      test -d "$as_dir" && break
     done
-    test ! -n "$as_dirs" || mkdir $as_dirs
-  fi || { { echo "$as_me:$LINENO: error: cannot create directory \"$ac_dir\"" >&5
-echo "$as_me: error: cannot create directory \"$ac_dir\"" >&2;}
+    test -z "$as_dirs" || eval "mkdir $as_dirs"
+  } || test -d "$as_dir" || { { echo "$as_me:$LINENO: error: cannot create directory $as_dir" >&5
+echo "$as_me: error: cannot create directory $as_dir" >&2;}
    { (exit 1); exit 1; }; }; }
-
   ac_builddir=.
 
-if test "$ac_dir" != .; then
+case "$ac_dir" in
+.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+*)
   ac_dir_suffix=/`echo "$ac_dir" | sed 's,^\.[\\/],,'`
-  # A "../" for each directory in $ac_dir_suffix.
-  ac_top_builddir=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,../,g'`
-else
-  ac_dir_suffix= ac_top_builddir=
-fi
+  # A ".." for each directory in $ac_dir_suffix.
+  ac_top_builddir_sub=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,/..,g;s,/,,'`
+  case $ac_top_builddir_sub in
+  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+  esac ;;
+esac
+ac_abs_top_builddir=$ac_pwd
+ac_abs_builddir=$ac_pwd$ac_dir_suffix
+# for backward compatibility:
+ac_top_builddir=$ac_top_build_prefix
 
 case $srcdir in
-  .)  # No --srcdir option.  We are building in place.
+  .)  # We are building in place.
     ac_srcdir=.
-    if test -z "$ac_top_builddir"; then
-       ac_top_srcdir=.
-    else
-       ac_top_srcdir=`echo $ac_top_builddir | sed 's,/$,,'`
-    fi ;;
-  [\\/]* | ?:[\\/]* )  # Absolute path.
+    ac_top_srcdir=$ac_top_builddir_sub
+    ac_abs_top_srcdir=$ac_pwd ;;
+  [\\/]* | ?:[\\/]* )  # Absolute name.
     ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir ;;
-  *) # Relative path.
-    ac_srcdir=$ac_top_builddir$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_builddir$srcdir ;;
+    ac_top_srcdir=$srcdir
+    ac_abs_top_srcdir=$srcdir ;;
+  *) # Relative name.
+    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+    ac_top_srcdir=$ac_top_build_prefix$srcdir
+    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
 esac
+ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
 
-# Do not use `cd foo && pwd` to compute absolute paths, because
-# the directories may not exist.
-case `pwd` in
-.) ac_abs_builddir="$ac_dir";;
-*)
-  case "$ac_dir" in
-  .) ac_abs_builddir=`pwd`;;
-  [\\/]* | ?:[\\/]* ) ac_abs_builddir="$ac_dir";;
-  *) ac_abs_builddir=`pwd`/"$ac_dir";;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_top_builddir=${ac_top_builddir}.;;
-*)
-  case ${ac_top_builddir}. in
-  .) ac_abs_top_builddir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_top_builddir=${ac_top_builddir}.;;
-  *) ac_abs_top_builddir=$ac_abs_builddir/${ac_top_builddir}.;;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_srcdir=$ac_srcdir;;
-*)
-  case $ac_srcdir in
-  .) ac_abs_srcdir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_srcdir=$ac_srcdir;;
-  *) ac_abs_srcdir=$ac_abs_builddir/$ac_srcdir;;
-  esac;;
-esac
-case $ac_abs_builddir in
-.) ac_abs_top_srcdir=$ac_top_srcdir;;
-*)
-  case $ac_top_srcdir in
-  .) ac_abs_top_srcdir=$ac_abs_builddir;;
-  [\\/]* | ?:[\\/]* ) ac_abs_top_srcdir=$ac_top_srcdir;;
-  *) ac_abs_top_srcdir=$ac_abs_builddir/$ac_top_srcdir;;
-  esac;;
-esac
 
+  case $ac_mode in
+  :F)
+  #
+  # CONFIG_FILE
+  #
 
   case $INSTALL in
   [\\/$]* | ?:[\\/]* ) ac_INSTALL=$INSTALL ;;
-  *) ac_INSTALL=$ac_top_builddir$INSTALL ;;
+  *) ac_INSTALL=$ac_top_build_prefix$INSTALL ;;
   esac
+_ACEOF
 
-  # Let's still pretend it is `configure' which instantiates (i.e., don't
-  # use $as_me), people would be surprised to read:
-  #    /* config.h.  Generated by config.status.  */
-  if test x"$ac_file" = x-; then
-    configure_input=
-  else
-    configure_input="$ac_file.  "
-  fi
-  configure_input=$configure_input"Generated from `echo $ac_file_in |
-				     sed 's,.*/,,'` by configure."
-
-  # First look for the input files in the build tree, otherwise in the
-  # src tree.
-  ac_file_inputs=`IFS=:
-    for f in $ac_file_in; do
-      case $f in
-      -) echo $tmp/stdin ;;
-      [\\/$]*)
-	 # Absolute (can't be DOS-style, as IFS=:)
-	 test -f "$f" || { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-	 echo "$f";;
-      *) # Relative
-	 if test -f "$f"; then
-	   # Build tree
-	   echo "$f"
-	 elif test -f "$srcdir/$f"; then
-	   # Source tree
-	   echo "$srcdir/$f"
-	 else
-	   # /dev/null tree
-	   { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-	 fi;;
-      esac
-    done` || { (exit 1); exit 1; }
-
-  if test x"$ac_file" != x-; then
-    { echo "$as_me:$LINENO: creating $ac_file" >&5
-echo "$as_me: creating $ac_file" >&6;}
-    rm -f "$ac_file"
-  fi
+cat >>$CONFIG_STATUS <<\_ACEOF
+# If the template does not know about datarootdir, expand it.
+# FIXME: This hack should be removed a few years after 2.60.
+ac_datarootdir_hack=; ac_datarootdir_seen=
+
+case `sed -n '/datarootdir/ {
+  p
+  q
+}
+/@datadir@/p
+/@docdir@/p
+/@infodir@/p
+/@localedir@/p
+/@mandir@/p
+' $ac_file_inputs` in
+*datarootdir*) ac_datarootdir_seen=yes;;
+*@datadir@*|*@docdir@*|*@infodir@*|*@localedir@*|*@mandir@*)
+  { echo "$as_me:$LINENO: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&5
+echo "$as_me: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&2;}
+_ACEOF
+cat >>$CONFIG_STATUS <<_ACEOF
+  ac_datarootdir_hack='
+  s&@datadir@&$datadir&g
+  s&@docdir@&$docdir&g
+  s&@infodir@&$infodir&g
+  s&@localedir@&$localedir&g
+  s&@mandir@&$mandir&g
+    s&\\\${datarootdir}&$datarootdir&g' ;;
+esac
 _ACEOF
+
+# Neutralize VPATH when `$srcdir' = `.'.
+# Shell code in configure.ac might set extrasub.
+# FIXME: do we really want to maintain this feature?
 cat >>$CONFIG_STATUS <<_ACEOF
   sed "$ac_vpsub
 $extrasub
 _ACEOF
 cat >>$CONFIG_STATUS <<\_ACEOF
 :t
 /@[a-zA-Z_][a-zA-Z_0-9]*@/!b
-s,@configure_input@,$configure_input,;t t
-s,@srcdir@,$ac_srcdir,;t t
-s,@abs_srcdir@,$ac_abs_srcdir,;t t
-s,@top_srcdir@,$ac_top_srcdir,;t t
-s,@abs_top_srcdir@,$ac_abs_top_srcdir,;t t
-s,@builddir@,$ac_builddir,;t t
-s,@abs_builddir@,$ac_abs_builddir,;t t
-s,@top_builddir@,$ac_top_builddir,;t t
-s,@abs_top_builddir@,$ac_abs_top_builddir,;t t
-s,@INSTALL@,$ac_INSTALL,;t t
-" $ac_file_inputs | (eval "$ac_sed_cmds") >$tmp/out
-  rm -f $tmp/stdin
-  if test x"$ac_file" != x-; then
-    mv $tmp/out $ac_file
-  else
-    cat $tmp/out
-    rm -f $tmp/out
-  fi
-
-done
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
-
-#
-# CONFIG_HEADER section.
-#
+s&@configure_input@&$configure_input&;t t
+s&@top_builddir@&$ac_top_builddir_sub&;t t
+s&@srcdir@&$ac_srcdir&;t t
+s&@abs_srcdir@&$ac_abs_srcdir&;t t
+s&@top_srcdir@&$ac_top_srcdir&;t t
+s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
+s&@builddir@&$ac_builddir&;t t
+s&@abs_builddir@&$ac_abs_builddir&;t t
+s&@abs_top_builddir@&$ac_abs_top_builddir&;t t
+s&@INSTALL@&$ac_INSTALL&;t t
+$ac_datarootdir_hack
+" $ac_file_inputs | sed -f "$tmp/subs-1.sed" >$tmp/out
+
+test -z "$ac_datarootdir_hack$ac_datarootdir_seen" &&
+  { ac_out=`sed -n '/\${datarootdir}/p' "$tmp/out"`; test -n "$ac_out"; } &&
+  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' "$tmp/out"`; test -z "$ac_out"; } &&
+  { echo "$as_me:$LINENO: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+which seems to be undefined.  Please make sure it is defined." >&5
+echo "$as_me: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+which seems to be undefined.  Please make sure it is defined." >&2;}
 
-# These sed commands are passed to sed as "A NAME B NAME C VALUE D", where
-# NAME is the cpp macro being defined and VALUE is the value it is being given.
-#
-# ac_d sets the value in "#define NAME VALUE" lines.
-ac_dA='s,^\([	 ]*\)#\([	 ]*define[	 ][	 ]*\)'
-ac_dB='[	 ].*$,\1#\2'
-ac_dC=' '
-ac_dD=',;t'
-# ac_u turns "#undef NAME" without trailing blanks into "#define NAME VALUE".
-ac_uA='s,^\([	 ]*\)#\([	 ]*\)undef\([	 ][	 ]*\)'
-ac_uB='$,\1#\2define\3'
-ac_uC=' '
-ac_uD=',;t'
-
-for ac_file in : $CONFIG_HEADERS; do test "x$ac_file" = x: && continue
-  # Support "outfile[:infile[:infile...]]", defaulting infile="outfile.in".
+  rm -f "$tmp/stdin"
   case $ac_file in
-  - | *:- | *:-:* ) # input from stdin
-	cat >$tmp/stdin
-	ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-	ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  *:* ) ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-	ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  * )   ac_file_in=$ac_file.in ;;
+  -) cat "$tmp/out"; rm -f "$tmp/out";;
+  *) rm -f "$ac_file"; mv "$tmp/out" $ac_file;;
   esac
+ ;;
+  :H)
+  #
+  # CONFIG_HEADER
+  #
+_ACEOF
+
+# Transform confdefs.h into a sed script `conftest.defines', that
+# substitutes the proper values into config.h.in to produce config.h.
+rm -f conftest.defines conftest.tail
+# First, append a space to every undef/define line, to ease matching.
+echo 's/$/ /' >conftest.defines
+# Then, protect against being on the right side of a sed subst, or in
+# an unquoted here document, in config.status.  If some macros were
+# called several times there might be several #defines for the same
+# symbol, which is useless.  But do not sort them, since the last
+# AC_DEFINE must be honored.
+ac_word_re=[_$as_cr_Letters][_$as_cr_alnum]*
+# These sed commands are passed to sed as "A NAME B PARAMS C VALUE D", where
+# NAME is the cpp macro being defined, VALUE is the value it is being given.
+# PARAMS is the parameter list in the macro definition--in most cases, it's
+# just an empty string.
+ac_dA='s,^\\([	 #]*\\)[^	 ]*\\([	 ]*'
+ac_dB='\\)[	 (].*,\\1define\\2'
+ac_dC=' '
+ac_dD=' ,'
 
-  test x"$ac_file" != x- && { echo "$as_me:$LINENO: creating $ac_file" >&5
-echo "$as_me: creating $ac_file" >&6;}
-
-  # First look for the input files in the build tree, otherwise in the
-  # src tree.
-  ac_file_inputs=`IFS=:
-    for f in $ac_file_in; do
-      case $f in
-      -) echo $tmp/stdin ;;
-      [\\/$]*)
-	 # Absolute (can't be DOS-style, as IFS=:)
-	 test -f "$f" || { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-	 # Do quote $f, to prevent DOS paths from being IFS'd.
-	 echo "$f";;
-      *) # Relative
-	 if test -f "$f"; then
-	   # Build tree
-	   echo "$f"
-	 elif test -f "$srcdir/$f"; then
-	   # Source tree
-	   echo "$srcdir/$f"
-	 else
-	   # /dev/null tree
-	   { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-	 fi;;
-      esac
-    done` || { (exit 1); exit 1; }
-  # Remove the trailing spaces.
-  sed 's/[	 ]*$//' $ac_file_inputs >$tmp/in
-
-_ACEOF
-
-# Transform confdefs.h into two sed scripts, `conftest.defines' and
-# `conftest.undefs', that substitutes the proper values into
-# config.h.in to produce config.h.  The first handles `#define'
-# templates, and the second `#undef' templates.
-# And first: Protect against being on the right side of a sed subst in
-# config.status.  Protect against being in an unquoted here document
-# in config.status.
-rm -f conftest.defines conftest.undefs
-# Using a here document instead of a string reduces the quoting nightmare.
-# Putting comments in sed scripts is not portable.
-#
-# `end' is used to avoid that the second main sed command (meant for
-# 0-ary CPP macros) applies to n-ary macro definitions.
-# See the Autoconf documentation for `clear'.
-cat >confdef2sed.sed <<\_ACEOF
-s/[\\&,]/\\&/g
-s,[\\$`],\\&,g
-t clear
-: clear
-s,^[	 ]*#[	 ]*define[	 ][	 ]*\([^	 (][^	 (]*\)\(([^)]*)\)[	 ]*\(.*\)$,${ac_dA}\1${ac_dB}\1\2${ac_dC}\3${ac_dD},gp
-t end
-s,^[	 ]*#[	 ]*define[	 ][	 ]*\([^	 ][^	 ]*\)[	 ]*\(.*\)$,${ac_dA}\1${ac_dB}\1${ac_dC}\2${ac_dD},gp
-: end
-_ACEOF
-# If some macros were called several times there might be several times
-# the same #defines, which is useless.  Nevertheless, we may not want to
-# sort them, since we want the *last* AC-DEFINE to be honored.
-uniq confdefs.h | sed -n -f confdef2sed.sed >conftest.defines
-sed 's/ac_d/ac_u/g' conftest.defines >conftest.undefs
-rm -f confdef2sed.sed
+uniq confdefs.h |
+  sed -n '
+	t rset
+	:rset
+	s/^[	 ]*#[	 ]*define[	 ][	 ]*//
+	t ok
+	d
+	:ok
+	s/[\\&,]/\\&/g
+	s/^\('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/ '"$ac_dA"'\1'"$ac_dB"'\2'"${ac_dC}"'\3'"$ac_dD"'/p
+	s/^\('"$ac_word_re"'\)[	 ]*\(.*\)/'"$ac_dA"'\1'"$ac_dB$ac_dC"'\2'"$ac_dD"'/p
+  ' >>conftest.defines
 
-# This sed command replaces #undef with comments.  This is necessary, for
+# Remove the space that was appended to ease matching.
+# Then replace #undef with comments.  This is necessary, for
 # example, in the case of _POSIX_SOURCE, which is predefined and required
 # on some systems where configure will not decide to define it.
-cat >>conftest.undefs <<\_ACEOF
-s,^[	 ]*#[	 ]*undef[	 ][	 ]*[a-zA-Z_][a-zA-Z_0-9]*,/* & */,
-_ACEOF
+# (The regexp can be short, since the line contains either #define or #undef.)
+echo 's/ $//
+s,^[	 #]*u.*,/* & */,' >>conftest.defines
+
+# Break up conftest.defines:
+ac_max_sed_lines=50
+
+# First sed command is:	 sed -f defines.sed $ac_file_inputs >"$tmp/out1"
+# Second one is:	 sed -f defines.sed "$tmp/out1" >"$tmp/out2"
+# Third one will be:	 sed -f defines.sed "$tmp/out2" >"$tmp/out1"
+# et cetera.
+ac_in='$ac_file_inputs'
+ac_out='"$tmp/out1"'
+ac_nxt='"$tmp/out2"'
 
-# Break up conftest.defines because some shells have a limit on the size
-# of here documents, and old seds have small limits too (100 cmds).
-echo '  # Handle all the #define templates only if necessary.' >>$CONFIG_STATUS
-echo '  if grep "^[	 ]*#[	 ]*define" $tmp/in >/dev/null; then' >>$CONFIG_STATUS
-echo '  # If there are no defines, we may have an empty if/fi' >>$CONFIG_STATUS
-echo '  :' >>$CONFIG_STATUS
-rm -f conftest.tail
-while grep . conftest.defines >/dev/null
-do
-  # Write a limited-size here document to $tmp/defines.sed.
-  echo '  cat >$tmp/defines.sed <<CEOF' >>$CONFIG_STATUS
-  # Speed up: don't consider the non `#define' lines.
-  echo '/^[	 ]*#[	 ]*define/!b' >>$CONFIG_STATUS
-  # Work around the forget-to-reset-the-flag bug.
-  echo 't clr' >>$CONFIG_STATUS
-  echo ': clr' >>$CONFIG_STATUS
-  sed ${ac_max_here_lines}q conftest.defines >>$CONFIG_STATUS
+while :
+do
+  # Write a here document:
+    cat >>$CONFIG_STATUS <<_ACEOF
+    # First, check the format of the line:
+    cat >"\$tmp/defines.sed" <<\\CEOF
+/^[	 ]*#[	 ]*undef[	 ][	 ]*$ac_word_re[	 ]*\$/b def
+/^[	 ]*#[	 ]*define[	 ][	 ]*$ac_word_re[(	 ]/b def
+b
+:def
+_ACEOF
+  sed ${ac_max_sed_lines}q conftest.defines >>$CONFIG_STATUS
   echo 'CEOF
-  sed -f $tmp/defines.sed $tmp/in >$tmp/out
-  rm -f $tmp/in
-  mv $tmp/out $tmp/in
-' >>$CONFIG_STATUS
-  sed 1,${ac_max_here_lines}d conftest.defines >conftest.tail
+    sed -f "$tmp/defines.sed"' "$ac_in >$ac_out" >>$CONFIG_STATUS
+  ac_in=$ac_out; ac_out=$ac_nxt; ac_nxt=$ac_in
+  sed 1,${ac_max_sed_lines}d conftest.defines >conftest.tail
+  grep . conftest.tail >/dev/null || break
   rm -f conftest.defines
   mv conftest.tail conftest.defines
 done
-rm -f conftest.defines
-echo '  fi # grep' >>$CONFIG_STATUS
-echo >>$CONFIG_STATUS
-
-# Break up conftest.undefs because some shells have a limit on the size
-# of here documents, and old seds have small limits too (100 cmds).
-echo '  # Handle all the #undef templates' >>$CONFIG_STATUS
-rm -f conftest.tail
-while grep . conftest.undefs >/dev/null
-do
-  # Write a limited-size here document to $tmp/undefs.sed.
-  echo '  cat >$tmp/undefs.sed <<CEOF' >>$CONFIG_STATUS
-  # Speed up: don't consider the non `#undef'
-  echo '/^[	 ]*#[	 ]*undef/!b' >>$CONFIG_STATUS
-  # Work around the forget-to-reset-the-flag bug.
-  echo 't clr' >>$CONFIG_STATUS
-  echo ': clr' >>$CONFIG_STATUS
-  sed ${ac_max_here_lines}q conftest.undefs >>$CONFIG_STATUS
-  echo 'CEOF
-  sed -f $tmp/undefs.sed $tmp/in >$tmp/out
-  rm -f $tmp/in
-  mv $tmp/out $tmp/in
-' >>$CONFIG_STATUS
-  sed 1,${ac_max_here_lines}d conftest.undefs >conftest.tail
-  rm -f conftest.undefs
-  mv conftest.tail conftest.undefs
-done
-rm -f conftest.undefs
+rm -f conftest.defines conftest.tail
 
+echo "ac_result=$ac_in" >>$CONFIG_STATUS
 cat >>$CONFIG_STATUS <<\_ACEOF
-  # Let's still pretend it is `configure' which instantiates (i.e., don't
-  # use $as_me), people would be surprised to read:
-  #    /* config.h.  Generated by config.status.  */
-  if test x"$ac_file" = x-; then
-    echo "/* Generated by configure.  */" >$tmp/config.h
-  else
-    echo "/* $ac_file.  Generated by configure.  */" >$tmp/config.h
-  fi
-  cat $tmp/in >>$tmp/config.h
-  rm -f $tmp/in
   if test x"$ac_file" != x-; then
-    if diff $ac_file $tmp/config.h >/dev/null 2>&1; then
+    echo "/* $configure_input  */" >"$tmp/config.h"
+    cat "$ac_result" >>"$tmp/config.h"
+    if diff $ac_file "$tmp/config.h" >/dev/null 2>&1; then
       { echo "$as_me:$LINENO: $ac_file is unchanged" >&5
 echo "$as_me: $ac_file is unchanged" >&6;}
     else
-      ac_dir=`(dirname "$ac_file") 2>/dev/null ||
-$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$ac_file" : 'X\(//\)[^/]' \| \
-	 X"$ac_file" : 'X\(//\)$' \| \
-	 X"$ac_file" : 'X\(/\)' \| \
-	 .     : '\(.\)' 2>/dev/null ||
-echo X"$ac_file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-      { if $as_mkdir_p; then
-    mkdir -p "$ac_dir"
-  else
-    as_dir="$ac_dir"
-    as_dirs=
-    while test ! -d "$as_dir"; do
-      as_dirs="$as_dir $as_dirs"
-      as_dir=`(dirname "$as_dir") 2>/dev/null ||
-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$as_dir" : 'X\(//\)[^/]' \| \
-	 X"$as_dir" : 'X\(//\)$' \| \
-	 X"$as_dir" : 'X\(/\)' \| \
-	 .     : '\(.\)' 2>/dev/null ||
-echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-    done
-    test ! -n "$as_dirs" || mkdir $as_dirs
-  fi || { { echo "$as_me:$LINENO: error: cannot create directory \"$ac_dir\"" >&5
-echo "$as_me: error: cannot create directory \"$ac_dir\"" >&2;}
-   { (exit 1); exit 1; }; }; }
-
       rm -f $ac_file
-      mv $tmp/config.h $ac_file
+      mv "$tmp/config.h" $ac_file
     fi
   else
-    cat $tmp/config.h
-    rm -f $tmp/config.h
+    echo "/* $configure_input  */"
+    cat "$ac_result"
   fi
-done
-_ACEOF
+  rm -f "$tmp/out12"
+ ;;
+
+
+  esac
+
+done # for ac_tag
 
-cat >>$CONFIG_STATUS <<\_ACEOF
 
 { (exit 0); exit 0; }
 _ACEOF
 chmod +x $CONFIG_STATUS
 ac_clean_files=$ac_clean_files_save
 
@@ -13250,12 +15917,12 @@
   # Use ||, not &&, to avoid exiting from the if with $? = 1, which
   # would make configure fail if this is the last instruction.
   $ac_cs_success || { (exit 1); exit 1; }
 fi
 
 
-echo "$as_me:$LINENO: result: " >&5
-echo "${ECHO_T}" >&6
-echo "$as_me:$LINENO: result:     rsync ${RSYNC_VERSION} configuration successful" >&5
-echo "${ECHO_T}    rsync ${RSYNC_VERSION} configuration successful" >&6
-echo "$as_me:$LINENO: result: " >&5
-echo "${ECHO_T}" >&6
+{ echo "$as_me:$LINENO: result: " >&5
+echo "${ECHO_T}" >&6; }
+{ echo "$as_me:$LINENO: result:     rsync ${RSYNC_VERSION} configuration successful" >&5
+echo "${ECHO_T}    rsync ${RSYNC_VERSION} configuration successful" >&6; }
+{ echo "$as_me:$LINENO: result: " >&5
+echo "${ECHO_T}" >&6; }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/configure.in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/configure.in
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/configure.in	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/configure.in	2006-11-07 12:39:47.000000000 +0800
@@ -2,13 +2,13 @@
 
 AC_INIT()
 AC_CONFIG_SRCDIR([byteorder.h])
 AC_CONFIG_HEADER(config.h)
 AC_PREREQ(2.59)
 
-RSYNC_VERSION=2.6.8
+RSYNC_VERSION=2.6.9
 AC_SUBST(RSYNC_VERSION)
 AC_MSG_NOTICE([Configuring rsync $RSYNC_VERSION])
 
 AC_DEFINE_UNQUOTED(RSYNC_VERSION, ["$RSYNC_VERSION"], [rsync release version])
 
 LDFLAGS=${LDFLAGS-""}
@@ -120,21 +120,29 @@
 	RSYNC_RSH="$with_rsh"
 else
 	RSYNC_RSH="ssh"
 fi
 AC_DEFINE_UNQUOTED(RSYNC_RSH, "$RSYNC_RSH", [default -e command])
 
-AC_MSG_CHECKING([the group for user "nobody"])
-if grep '^nobody:' /etc/group >/dev/null 2>&1; then
-    NOBODY_GROUP=nobody
-elif grep '^nogroup:' /etc/group >/dev/null 2>&1; then
-    NOBODY_GROUP=nogroup
-else
-    NOBODY_GROUP=nobody # test for others?
+AC_ARG_WITH(nobody-group,
+    AC_HELP_STRING([--with-nobody-group=GROUP],
+		   [set the default unprivileged group (default nobody or nogroup)]),
+    [ NOBODY_GROUP="$with_nobody_group" ])
+
+if test x"$with_nobody_group" = x; then
+    AC_MSG_CHECKING([the group for user "nobody"])
+    if grep '^nobody:' /etc/group >/dev/null 2>&1; then
+	NOBODY_GROUP=nobody
+    elif grep '^nogroup:' /etc/group >/dev/null 2>&1; then
+	NOBODY_GROUP=nogroup
+    else
+	NOBODY_GROUP=nobody # test for others?
+    fi
+    AC_MSG_RESULT($NOBODY_GROUP)
 fi
-AC_MSG_RESULT($NOBODY_GROUP)
+
 AC_DEFINE_UNQUOTED(NOBODY_USER, "nobody", [unprivileged user--e.g. nobody])
 AC_DEFINE_UNQUOTED(NOBODY_GROUP, "$NOBODY_GROUP", [unprivileged group for unprivileged user])
 
 # arrgh. libc in some old debian version screwed up the largefile
 # stuff, getting byte range locking wrong
 AC_CACHE_CHECK([for broken largefile support],rsync_cv_HAVE_BROKEN_LARGEFILE,[
@@ -299,12 +307,37 @@
     unistd.h utime.h grp.h compat.h sys/param.h ctype.h sys/wait.h \
     sys/ioctl.h sys/filio.h string.h stdlib.h sys/socket.h sys/mode.h \
     sys/un.h glob.h mcheck.h arpa/inet.h arpa/nameser.h locale.h \
     netdb.h malloc.h float.h limits.h iconv.h libcharset.h langinfo.h)
 AC_HEADER_MAJOR
 
+AC_CACHE_CHECK([if makedev takes 3 args],rsync_cv_MAKEDEV_TAKES_3_ARGS,[
+AC_TRY_RUN([
+#include <sys/types.h>
+#ifdef MAJOR_IN_MKDEV
+#include <sys/mkdev.h>
+# if !defined makedev && (defined mkdev || defined _WIN32 || defined __WIN32__)
+#  define makedev mkdev
+# endif
+#elif defined MAJOR_IN_SYSMACROS
+#include <sys/sysmacros.h>
+#endif
+
+int main(void)
+{
+	dev_t dev = makedev(0, 5, 7);
+	if (major(dev) != 5 || minor(dev) != 7)
+		exit(1);
+	return 0;
+}
+],
+rsync_cv_MAKEDEV_TAKES_3_ARGS=yes,rsync_cv_MAKEDEV_TAKES_3_ARGS=no,rsync_cv_MAKEDEV_TAKES_3_ARGS=no)])
+if test x"$rsync_cv_MAKEDEV_TAKES_3_ARGS" = x"yes"; then
+   AC_DEFINE(MAKEDEV_TAKES_3_ARGS, 1, [Define to 1 if makedev() takes 3 args])
+fi
+
 AC_CHECK_SIZEOF(int)
 AC_CHECK_SIZEOF(long)
 AC_CHECK_SIZEOF(long long)
 AC_CHECK_SIZEOF(short)
 AC_CHECK_SIZEOF(off_t)
 AC_CHECK_SIZEOF(off64_t)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/connection.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/connection.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/connection.c	1998-07-17 13:37:19.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/connection.c	2006-04-26 07:51:12.000000000 +0800
@@ -1,28 +1,28 @@
-/* 
-   Copyright (C) Andrew Tridgell 1998
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * Support the max connections option.
+ *
+ * Copyright (C) 1998 Andrew Tridgell
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
-/* support the max connections option */
 #include "rsync.h"
 
-
 /****************************************************************************
 simple routine to do connection counting
 ****************************************************************************/
 int claim_connection(char *fname,int max_connections)
 {
 	int fd, i;
@@ -36,13 +36,13 @@
 		return 0;
 	}
 
 	/* find a free spot */
 	for (i=0;i<max_connections;i++) {
 		if (lock_range(fd, i*4, 4)) return 1;
-	}		
+	}
 
 	/* only interested in open failures */
 	errno = 0;
 
 	close(fd);
 	return 0;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/COPYING /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/COPYING
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/COPYING	2005-04-17 16:25:50.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/COPYING	2006-04-26 07:51:12.000000000 +0800
@@ -1,11 +1,11 @@
 		    GNU GENERAL PUBLIC LICENSE
 		       Version 2, June 1991
 
  Copyright (C) 1989, 1991 Free Software Foundation, Inc.
-                       59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+     51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  Everyone is permitted to copy and distribute verbatim copies
  of this license document, but changing it is not allowed.
 
 			    Preamble
 
   The licenses for most software are designed to take away your
@@ -310,13 +310,13 @@
 
 Also add information on how to contact you by electronic and paper mail.
 
 If the program is interactive, make it output a short notice like this
 when it starts in an interactive mode:
 
-    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision version 69, Copyright (C) year  name of author
     Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
     This is free software, and you are welcome to redistribute it
     under certain conditions; type `show c' for details.
 
 The hypothetical commands `show w' and `show c' should show the appropriate
 parts of the General Public License.  Of course, the commands you use may
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/errcode.h /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/errcode.h
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/errcode.h	2005-12-17 07:48:28.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/errcode.h	2006-04-26 07:51:12.000000000 +0800
@@ -1,30 +1,30 @@
-/* -*- c-file-style: "linux"; -*-
-   
-   Copyright (C) 1998-2000 by Andrew Tridgell
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
 /*
- * error codes returned by rsync.  If you change these, please also update the
- * string mappings in log.c and the EXIT VALUES in rsync.yo
+ * Error codes returned by rsync.
+ *
+ * Copyright (C) 1998-2000 Andrew Tridgell
+ * Copyright (C) 2003, 2005 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
+/* If you change these, please also update the string mappings in log.c and
+ * the EXIT VALUES in rsync.yo. */
+
 #define RERR_OK         0
 #define RERR_SYNTAX     1       /* syntax or usage error */
 #define RERR_PROTOCOL   2       /* protocol incompatibility */
 #define RERR_FILESELECT 3       /* errors selecting input/output files, dirs */
 #define RERR_UNSUPPORTED 4      /* requested action not supported */
 #define RERR_STARTCLIENT 5      /* error starting client-server protocol */
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/exclude.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/exclude.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/exclude.c	2006-03-29 07:09:07.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/exclude.c	2006-10-13 14:24:24.000000000 +0800
@@ -1,32 +1,29 @@
-/* -*- c-file-style: "linux" -*-
+/*
+ * The filter include/exclude routines.
  *
- * Copyright (C) 1996-2001 by Andrew Tridgell <tridge@samba.org>
- * Copyright (C) 1996 by Paul Mackerras
- * Copyright (C) 2002 by Martin Pool
+ * Copyright (C) 1996-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/* a lot of this stuff was originally derived from GNU tar, although
-   it has now changed so much that it is hard to tell :) */
-
-/* include/exclude cluestick added by Martin Pool <mbp@samba.org> */
-
 #include "rsync.h"
 
 extern int verbose;
 extern int am_server;
 extern int am_sender;
 extern int eol_nulls;
@@ -298,35 +295,34 @@
 		/* null-terminate the name if it isn't already */
 		if (len_ptr && merge_file[*len_ptr]) {
 			char *to = fn == buf ? tmpbuf : buf;
 			strlcpy(to, merge_file, *len_ptr + 1);
 			merge_file = to;
 		}
-		if (!sanitize_path(fn, merge_file, r, dirbuf_depth)) {
+		if (!sanitize_path(fn, merge_file, r, dirbuf_depth, NULL)) {
 			rprintf(FERROR, "merge-file name overflows: %s\n",
 				merge_file);
 			return NULL;
 		}
+		fn_len = strlen(fn);
 	} else {
 		strlcpy(fn, merge_file, len_ptr ? *len_ptr + 1 : MAXPATHLEN);
-		clean_fname(fn, 1);
+		fn_len = clean_fname(fn, 1);
 	}
-	
-	fn_len = strlen(fn);
-	if (fn == buf)
-		goto done;
 
-	if (dirbuf_len + fn_len >= MAXPATHLEN) {
-		rprintf(FERROR, "merge-file name overflows: %s\n", fn);
-		return NULL;
+	/* If the name isn't in buf yet, it's wasn't absolute. */
+	if (fn != buf) {
+		if (dirbuf_len + fn_len >= MAXPATHLEN) {
+			rprintf(FERROR, "merge-file name overflows: %s\n", fn);
+			return NULL;
+		}
+		memcpy(buf, dirbuf + prefix_skip, dirbuf_len - prefix_skip);
+		memcpy(buf + dirbuf_len - prefix_skip, fn, fn_len + 1);
+		fn_len = clean_fname(buf, 1);
 	}
-	memcpy(buf, dirbuf + prefix_skip, dirbuf_len - prefix_skip);
-	memcpy(buf + dirbuf_len - prefix_skip, fn, fn_len + 1);
-	fn_len = clean_fname(buf, 1);
 
-    done:
 	if (len_ptr)
 		*len_ptr = fn_len;
 	return buf;
 }
 
 /* Sets the dirbuf and dirbuf_len values. */
@@ -500,12 +496,14 @@
 {
 	int slash_handling, str_cnt = 0, anchored_match = 0;
 	int ret_match = ex->match_flags & MATCHFLG_NEGATE ? 0 : 1;
 	char *p, *pattern = ex->pattern;
 	const char *strings[16]; /* more than enough */
 
+	if (*name == '/')
+		name++;
 	if (!*name)
 		return 0;
 
 	if (!ex->u.slash_cnt && !(ex->match_flags & MATCHFLG_WILD2)) {
 		/* If the pattern does not have any slashes AND it does
 		 * not have a "**" (which could match a slash), then we
@@ -531,14 +529,12 @@
 		return !ret_match;
 	strings[str_cnt] = NULL;
 
 	if (*pattern == '/') {
 		anchored_match = 1;
 		pattern++;
-		if (strings[0][0] == '/')
-			strings[0]++;
 	}
 
 	if (!anchored_match && ex->u.slash_cnt
 	    && !(ex->match_flags & MATCHFLG_WILD2)) {
 		/* A non-anchored match with an infix slash and no "**"
 		 * needs to match the last slash_cnt+1 name elements. */
@@ -557,13 +553,13 @@
 		if (wildmatch_array(pattern, strings, slash_handling))
 			return ret_match;
 	} else if (str_cnt > 1) {
 		if (litmatch_array(pattern, strings, slash_handling))
 			return ret_match;
 	} else if (anchored_match) {
-		if (strcmp(strings[0], pattern) == 0)
+		if (strcmp(name, pattern) == 0)
 			return ret_match;
 	} else {
 		int l1 = strlen(name);
 		int l2 = strlen(pattern);
 		if (l2 <= l1 &&
 		    strcmp(name+(l1-l2),pattern) == 0 &&
@@ -847,27 +843,36 @@
 			new_mflags &= ~MATCHFLG_CLEAR_LIST;
 	} else if (!len && !(new_mflags & MATCHFLG_CVS_IGNORE)) {
 		rprintf(FERROR, "unexpected end of filter rule: %s\n", p);
 		exit_cleanup(RERR_SYNTAX);
 	}
 
+	/* --delete-excluded turns an un-modified include/exclude into a
+	 * sender-side rule.  We also affect per-dir merge files that take
+	 * no prefixes as a simple optimization. */
+	if (delete_excluded
+	 && !(new_mflags & (MATCHFLG_RECEIVER_SIDE|MATCHFLG_SENDER_SIDE))
+	 && (!(new_mflags & MATCHFLG_PERDIR_MERGE)
+	  || new_mflags & MATCHFLG_NO_PREFIXES))
+		new_mflags |= MATCHFLG_SENDER_SIDE;
+
 	*len_ptr = len;
 	*mflags_ptr = new_mflags;
 	return (const char *)s;
 }
 
 
-static char default_cvsignore[] = 
+static char default_cvsignore[] =
 	/* These default ignored items come from the CVS manual. */
 	"RCS SCCS CVS CVS.adm RCSLOG cvslog.* tags TAGS"
 	" .make.state .nse_depinfo *~ #* .#* ,* _$* *$"
 	" *.old *.bak *.BAK *.orig *.rej .del-*"
 	" *.a *.olb *.o *.obj *.so *.exe"
 	" *.Z *.elc *.ln core"
 	/* The rest we added to suit ourself. */
-	" .svn/";
+	" .svn/ .bzr/";
 
 static void get_cvs_excludes(uint32 mflags)
 {
 	char *p, fname[MAXPATHLEN];
 	static int initialized = 0;
 
@@ -898,18 +903,20 @@
 	while (1) {
 		/* Remember that the returned string is NOT '\0' terminated! */
 		cp = parse_rule_tok(pattern, mflags, xflags,
 				    &pat_len, &new_mflags);
 		if (!cp)
 			break;
+
+		pattern = cp + pat_len;
+
 		if (pat_len >= MAXPATHLEN) {
-			rprintf(FERROR, "discarding over-long filter: %s\n",
-				cp);
+			rprintf(FERROR, "discarding over-long filter: %.*s\n",
+				(int)pat_len, cp);
 			continue;
 		}
-		pattern = cp + pat_len;
 
 		if (new_mflags & MATCHFLG_CLEAR_LIST) {
 			if (verbose > 2) {
 				rprintf(FINFO,
 					"[%s] clearing filter list%s\n",
 					who_am_i(), listp->debug_type);
@@ -923,17 +930,15 @@
 			if (!pat_len) {
 				cp = ".cvsignore";
 				pat_len = 10;
 			}
 			len = pat_len;
 			if (new_mflags & MATCHFLG_EXCLUDE_SELF) {
-				const char *name = strrchr(cp, '/');
-				if (name)
-					len -= ++name - cp;
-				else
-					name = cp;
+				const char *name = cp + len;
+				while (name > cp && name[-1] != '/') name--;
+				len -= name - cp;
 				add_rule(listp, name, len, 0, 0);
 				new_mflags &= ~MATCHFLG_EXCLUDE_SELF;
 				len = pat_len;
 			}
 			if (new_mflags & MATCHFLG_PERDIR_MERGE) {
 				if (parent_dirscan) {
@@ -1098,17 +1103,26 @@
 
 	for (ent = flp->head; ent; ent = ent->next) {
 		unsigned int len, plen, dlen;
 		int elide = 0;
 		char *p;
 
+		/* Note we need to check delete_excluded here in addition to
+		 * the code in parse_rule_tok() because some rules may have
+		 * been added before we found the --delete-excluded option.
+		 * We must also elide any CVS merge-file rules to avoid a
+		 * backward compatibility problem, and we elide any no-prefix
+		 * merge files as an optimization (since they can only have
+		 * include/exclude rules). */
 		if (ent->match_flags & MATCHFLG_SENDER_SIDE)
 			elide = am_sender ? 1 : -1;
 		if (ent->match_flags & MATCHFLG_RECEIVER_SIDE)
 			elide = elide ? 0 : am_sender ? -1 : 1;
-		else if (delete_excluded && !elide)
+		else if (delete_excluded && !elide
+		 && (!(ent->match_flags & MATCHFLG_PERDIR_MERGE)
+		  || ent->match_flags & MATCHFLG_NO_PREFIXES))
 			elide = am_sender ? 1 : -1;
 		if (elide < 0) {
 			if (prev)
 				prev->next = ent->next;
 			else
 				flp->head = ent->next;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/fileio.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/fileio.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/fileio.c	2006-04-09 00:37:50.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/fileio.c	2006-04-26 07:51:13.000000000 +0800
@@ -1,28 +1,28 @@
 /*
-   Copyright (C) Andrew Tridgell 1998
-   Copyright (C) 2002 by Martin Pool
+ * File IO utilities used in rsync.
+ *
+ * Copyright (C) 1998 Andrew Tridgell
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/*
-  File IO utilities used in rsync
-  */
 #include "rsync.h"
 
 #ifndef ENODATA
 #define ENODATA EAGAIN
 #endif
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/flist.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/flist.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/flist.c	2006-04-22 00:36:30.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/flist.c	2006-10-14 09:17:36.000000000 +0800
@@ -1,32 +1,28 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/** @file flist.c
- * Generate and receive file lists
+ * Generate and receive file lists.
  *
- * @sa http://lists.samba.org/pipermail/rsync/2000-June/002351.html
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2002, 2003, 2004, 2005, 2006 Wayne Davison
  *
- **/
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int list_only;
 extern int am_root;
@@ -91,21 +87,21 @@
 {
 	return verbose && xfer_dirs && !am_server;
 }
 
 static void start_filelist_progress(char *kind)
 {
-	rprintf(FINFO, "%s ... ", kind);
+	rprintf(FCLIENT, "%s ... ", kind);
 	if (verbose > 1 || do_progress)
-		rprintf(FINFO, "\n");
+		rprintf(FCLIENT, "\n");
 	rflush(FINFO);
 }
 
 static void emit_filelist_progress(int count)
 {
-	rprintf(FINFO, " %d files...\r", count);
+	rprintf(FCLIENT, " %d files...\r", count);
 }
 
 static void maybe_emit_filelist_progress(int count)
 {
 	if (do_progress && show_filelist_p() && (count % 100) == 0)
 		emit_filelist_progress(count);
@@ -150,67 +146,59 @@
 			permbuf,
 			(double)f->length, timestring(f->modtime),
 			f_name(f, NULL));
 	}
 }
 
-/**
- * Stat either a symlink or its referent, depending on the settings of
- * copy_links, copy_unsafe_links, etc.
- *
- * @retval -1 on error
- *
- * @retval 0 for success
+/* Stat either a symlink or its referent, depending on the settings of
+ * copy_links, copy_unsafe_links, etc.  Returns -1 on error, 0 on success.
  *
- * @post If @p path is a symlink, then @p linkbuf (of size @c
- * MAXPATHLEN) contains the symlink target.
+ * If path is the name of a symlink, then the linkbuf buffer (which must hold
+ * MAXPATHLEN chars) will be set to the symlink's target string.
  *
- * @post @p buffer contains information about the link or the
- * referrent as appropriate, if they exist.
- **/
-static int readlink_stat(const char *path, STRUCT_STAT *buffer, char *linkbuf)
+ * The stat structure pointed to by stp will contain information about the
+ * link or the referent as appropriate, if they exist. */
+static int readlink_stat(const char *path, STRUCT_STAT *stp, char *linkbuf)
 {
 #ifdef SUPPORT_LINKS
-	if (copy_links)
-		return do_stat(path, buffer);
-	if (link_stat(path, buffer, copy_dirlinks) < 0)
+	if (link_stat(path, stp, copy_dirlinks) < 0)
 		return -1;
-	if (S_ISLNK(buffer->st_mode)) {
-		int l = readlink((char *)path, linkbuf, MAXPATHLEN - 1);
-		if (l == -1)
+	if (S_ISLNK(stp->st_mode)) {
+		int llen = readlink(path, linkbuf, MAXPATHLEN - 1);
+		if (llen < 0)
 			return -1;
-		linkbuf[l] = 0;
+		linkbuf[llen] = '\0';
 		if (copy_unsafe_links && unsafe_symlink(linkbuf, path)) {
 			if (verbose > 1) {
 				rprintf(FINFO,"copying unsafe symlink \"%s\" -> \"%s\"\n",
 					path, linkbuf);
 			}
-			return do_stat(path, buffer);
+			return do_stat(path, stp);
 		}
 	}
 	return 0;
 #else
-	return do_stat(path, buffer);
+	return do_stat(path, stp);
 #endif
 }
 
-int link_stat(const char *path, STRUCT_STAT *buffer, int follow_dirlinks)
+int link_stat(const char *path, STRUCT_STAT *stp, int follow_dirlinks)
 {
 #ifdef SUPPORT_LINKS
 	if (copy_links)
-		return do_stat(path, buffer);
-	if (do_lstat(path, buffer) < 0)
+		return do_stat(path, stp);
+	if (do_lstat(path, stp) < 0)
 		return -1;
-	if (follow_dirlinks && S_ISLNK(buffer->st_mode)) {
+	if (follow_dirlinks && S_ISLNK(stp->st_mode)) {
 		STRUCT_STAT st;
 		if (do_stat(path, &st) == 0 && S_ISDIR(st.st_mode))
-			*buffer = st;
+			*stp = st;
 	}
 	return 0;
 #else
-	return do_stat(path, buffer);
+	return do_stat(path, stp);
 #endif
 }
 
 /* This function is used to check if a file should be included/excluded
  * from the list of files based on its name and type etc.  The value of
  * filter_level is set to either SERVER_FILTERS or ALL_FILTERS. */
@@ -242,23 +230,27 @@
 	return 0;
 }
 
 static int to_wire_mode(mode_t mode)
 {
 #ifdef SUPPORT_LINKS
-	if (S_ISLNK(mode) && (_S_IFLNK != 0120000))
+#if _S_IFLNK != 0120000
+	if (S_ISLNK(mode))
 		return (mode & ~(_S_IFMT)) | 0120000;
 #endif
-	return (int)mode;
+#endif
+	return mode;
 }
 
 static mode_t from_wire_mode(int mode)
 {
-	if ((mode & (_S_IFMT)) == 0120000 && (_S_IFLNK != 0120000))
+#if _S_IFLNK != 0120000
+	if ((mode & (_S_IFMT)) == 0120000)
 		return (mode & ~(_S_IFMT)) | _S_IFLNK;
-	return (mode_t)mode;
+#endif
+	return mode;
 }
 
 static void send_directory(int f, struct file_list *flist,
 			   char *fbuf, int len);
 
 static char *flist_dir;
@@ -291,13 +283,13 @@
 		flist->malloced = flist->count;
 
 	new_ptr = realloc_array(flist->files, struct file_struct *,
 				flist->malloced);
 
 	if (verbose >= 2 && flist->malloced != FLIST_START) {
-		rprintf(FINFO, "[%s] expand file_list to %.0f bytes, did%s move\n",
+		rprintf(FCLIENT, "[%s] expand file_list to %.0f bytes, did%s move\n",
 		    who_am_i(),
 		    (double)sizeof flist->files[0] * flist->malloced,
 		    (new_ptr == flist->files) ? " not" : "");
 	}
 
 	flist->files = new_ptr;
@@ -323,13 +315,13 @@
 	if (f < 0)
 		return;
 
 	if (!file) {
 		write_byte(f, 0);
 		modtime = 0, mode = 0;
-		dev = 0, rdev = makedev(0, 0);
+		dev = 0, rdev = MAKEDEV(0, 0);
 		rdev_major = 0;
 		uid = 0, gid = 0;
 		*lastname = '\0';
 		return;
 	}
 
@@ -355,13 +347,13 @@
 			else
 				rdev_major = major(rdev);
 			if ((uint32)minor(rdev) <= 0xFFu)
 				flags |= XMIT_RDEV_MINOR_IS_SMALL;
 		}
 	} else if (protocol_version < 28)
-		rdev = makedev(0, 0);
+		rdev = MAKEDEV(0, 0);
 	if (file->uid == uid)
 		flags |= XMIT_SAME_UID;
 	else
 		uid = file->uid;
 	if (file->gid == gid)
 		flags |= XMIT_SAME_GID;
@@ -455,13 +447,13 @@
 		write_int(f, len);
 		write_buf(f, file->u.link, len);
 	}
 #endif
 
 #ifdef SUPPORT_HARD_LINKS
-	if (flags & XMIT_HAS_IDEV_DATA) {
+	if (file->link_u.idev) {
 		if (protocol_version < 26) {
 			/* 32-bit dev_t and ino_t */
 			write_int(f, dev);
 			write_int(f, file->F_INODE);
 		} else {
 			/* 64-bit dev_t and ino_t */
@@ -506,13 +498,13 @@
 	OFF_T file_length;
 	char *basename, *dirname, *bp;
 	struct file_struct *file;
 
 	if (!flist) {
 		modtime = 0, mode = 0;
-		dev = 0, rdev = makedev(0, 0);
+		dev = 0, rdev = MAKEDEV(0, 0);
 		rdev_major = 0;
 		uid = 0, gid = 0;
 		*lastname = '\0';
 		lastdir_len = -1;
 		in_del_hier = 0;
 		return NULL;
@@ -539,13 +531,13 @@
 
 	strlcpy(lastname, thisname, MAXPATHLEN);
 
 	clean_fname(thisname, 0);
 
 	if (sanitize_paths)
-		sanitize_path(thisname, thisname, "", 0);
+		sanitize_path(thisname, thisname, "", 0, NULL);
 
 	if ((basename = strrchr(thisname, '/')) != NULL) {
 		dirname_len = ++basename - thisname; /* counts future '\0' */
 		if (lastdir_len == dirname_len - 1
 		    && strncmp(thisname, lastdir, lastdir_len) == 0) {
 			dirname = lastdir;
@@ -583,16 +575,16 @@
 			if (!(flags & XMIT_SAME_RDEV_MAJOR))
 				rdev_major = read_int(f);
 			if (flags & XMIT_RDEV_MINOR_IS_SMALL)
 				rdev_minor = read_byte(f);
 			else
 				rdev_minor = read_int(f);
-			rdev = makedev(rdev_major, rdev_minor);
+			rdev = MAKEDEV(rdev_major, rdev_minor);
 		}
 	} else if (protocol_version < 28)
-		rdev = makedev(0, 0);
+		rdev = MAKEDEV(0, 0);
 
 #ifdef SUPPORT_LINKS
 	if (preserve_links && S_ISLNK(mode)) {
 		linkname_len = read_int(f) + 1; /* count the '\0' */
 		if (linkname_len <= 0 || linkname_len > MAXPATHLEN) {
 			rprintf(FERROR, "overflow: linkname_len=%d\n",
@@ -665,13 +657,13 @@
 
 #ifdef SUPPORT_LINKS
 	if (linkname_len) {
 		file->u.link = bp;
 		read_sbuf(f, bp, linkname_len - 1);
 		if (sanitize_paths)
-			sanitize_path(bp, bp, "", lastdir_depth);
+			sanitize_path(bp, bp, "", lastdir_depth, NULL);
 		bp += linkname_len;
 	}
 #endif
 
 #ifdef SUPPORT_HARD_LINKS
 	if (preserve_hard_links && protocol_version < 28 && S_ISREG(mode))
@@ -746,19 +738,20 @@
 	    >= sizeof thisname - flist_dir_len) {
 		rprintf(FINFO, "skipping overly long name: %s\n", fname);
 		return NULL;
 	}
 	clean_fname(thisname, 0);
 	if (sanitize_paths)
-		sanitize_path(thisname, thisname, "", 0);
+		sanitize_path(thisname, thisname, "", 0, NULL);
 
 	memset(sum, 0, SUM_LENGTH);
 
-	if (stp && S_ISDIR(stp->st_mode))
+	if (stp && S_ISDIR(stp->st_mode)) {
 		st = *stp; /* Needed for "symlink/." with --relative. */
-	else if (readlink_stat(thisname, &st, linkname) != 0) {
+		*linkname = '\0'; /* make IBM code checker happy */
+	} else if (readlink_stat(thisname, &st, linkname) != 0) {
 		int save_errno = errno;
 		/* See if file is excluded before reporting an error. */
 		if (filter_level != NO_FILTERS
 		    && is_excluded(thisname, 0, filter_level))
 			return NULL;
 		if (save_errno == ENOENT) {
@@ -850,13 +843,13 @@
 #endif
 
 	sum_len = always_checksum && am_sender && S_ISREG(st.st_mode)
 	        ? MD4_SUM_LENGTH : 0;
 
 	alloc_len = file_struct_len + dirname_len + basename_len
-	    + linkname_len + sum_len;
+		  + linkname_len + sum_len;
 	if (flist)
 		bp = pool_alloc(flist->file_pool, alloc_len, "make_file");
 	else {
 		if (!(bp = new_array(char, alloc_len)))
 			out_of_memory("make_file");
 	}
@@ -1069,23 +1062,24 @@
 	char lastpath[MAXPATHLEN] = "";
 	struct file_list *flist;
 	struct timeval start_tv, end_tv;
 	int64 start_write;
 	int use_ff_fd = 0;
 
+	rprintf(FLOG, "building file list\n");
 	if (show_filelist_p())
 		start_filelist_progress("building file list");
 
 	start_write = stats.total_written;
 	gettimeofday(&start_tv, NULL);
 
 	flist = flist_new(WITH_HLINK, "send_file_list");
 
 	io_start_buffering_out();
 	if (filesfrom_fd >= 0) {
-		if (argv[0] && !push_dir(argv[0])) {
+		if (argv[0] && !push_dir(argv[0], 0)) {
 			rsyserr(FERROR, errno, "push_dir %s failed",
 				full_fname(argv[0]));
 			exit_cleanup(RERR_FILESELECT);
 		}
 		use_ff_fd = 1;
 	}
@@ -1095,19 +1089,19 @@
 		char *fn;
 		int is_dot_dir;
 
 		if (use_ff_fd) {
 			if (read_filesfrom_line(filesfrom_fd, fbuf) == 0)
 				break;
-			sanitize_path(fbuf, fbuf, "", 0);
+			sanitize_path(fbuf, fbuf, "", 0, NULL);
 		} else {
 			if (argc-- == 0)
 				break;
 			strlcpy(fbuf, *argv++, MAXPATHLEN);
 			if (sanitize_paths)
-				sanitize_path(fbuf, fbuf, "", 0);
+				sanitize_path(fbuf, fbuf, "", 0, NULL);
 		}
 
 		len = strlen(fbuf);
 		if (relative_paths) {
 			/* We clean up fbuf below. */
 			is_dot_dir = 0;
@@ -1189,12 +1183,14 @@
 						len++;
 						break;
 					}
 				} else
 					break;
 			}
+			if (len == 1 && fn[0] == '/')
+				fn[len++] = '.';
 			fn[len] = '\0';
 			/* Reject a ".." dir in the active part of the path. */
 			for (p = fn; (p = strstr(p, "..")) != NULL; p += 2) {
 				if ((p[2] == '/' || p[2] == '\0')
 				 && (p == fn || p[-1] == '/')) {
 					rprintf(FERROR,
@@ -1213,13 +1209,13 @@
 		if (dir && *dir) {
 			static char *lastdir;
 			static int lastdir_len;
 
 			strlcpy(olddir, curr_dir, sizeof olddir);
 
-			if (!push_dir(dir)) {
+			if (!push_dir(dir, 0)) {
 				io_error |= IOERR_GENERAL;
 				rsyserr(FERROR, errno, "push_dir %s failed",
 					full_fname(dir));
 				continue;
 			}
 
@@ -1335,12 +1331,13 @@
 struct file_list *recv_file_list(int f)
 {
 	struct file_list *flist;
 	unsigned short flags;
 	int64 start_read;
 
+	rprintf(FLOG, "receiving file list\n");
 	if (show_filelist_p())
 		start_filelist_progress("receiving file list");
 
 	start_read = stats.total_read;
 
 	flist = flist_new(WITH_HLINK, "recv_file_list");
@@ -1697,21 +1694,21 @@
 	const char *who = who_am_i();
 	int i;
 
 	for (i = 0; i < flist->count; i++) {
 		file = flist->files[i];
 		if ((am_root || am_sender) && preserve_uid)
-			sprintf(uidbuf, " uid=%ld", (long)file->uid);
+			snprintf(uidbuf, sizeof uidbuf, " uid=%ld", (long)file->uid);
 		else
 			*uidbuf = '\0';
 		if (preserve_gid && file->gid != GID_NONE)
-			sprintf(gidbuf, " gid=%ld", (long)file->gid);
+			snprintf(gidbuf, sizeof gidbuf, " gid=%ld", (long)file->gid);
 		else
 			*gidbuf = '\0';
 		if (!am_sender)
-			sprintf(depthbuf, "%d", file->dir.depth);
+			snprintf(depthbuf, sizeof depthbuf, "%d", file->dir.depth);
 		rprintf(FINFO, "[%s] i=%d %s %s%s%s%s mode=0%o len=%.0f%s%s flags=%x\n",
 			who, i, am_sender ? NS(file->dir.root) : depthbuf,
 			file->dirname ? file->dirname : "",
 			file->dirname ? "/" : "", NS(file->basename),
 			S_ISDIR(file->mode) ? "/" : "", (int)file->mode,
 			(double)file->length, uidbuf, gidbuf, file->flags);
@@ -1762,16 +1759,12 @@
 		if (type1 == t_PATH && *c1 == '.' && !c1[1]) {
 			type1 = t_ITEM;
 			state1 = s_TRAILING;
 			c1 = (uchar*)"";
 		} else
 			state1 = s_BASE;
-	} else if (!*c1) {
-		type1 = t_path;
-		state1 = s_SLASH;
-		c1 = (uchar*)"/";
 	} else {
 		type1 = t_path;
 		state1 = s_DIR;
 	}
 	if (!c2) {
 		type2 = S_ISDIR(f2->mode) ? t_path : t_ITEM;
@@ -1779,27 +1772,21 @@
 		if (type2 == t_PATH && *c2 == '.' && !c2[1]) {
 			type2 = t_ITEM;
 			state2 = s_TRAILING;
 			c2 = (uchar*)"";
 		} else
 			state2 = s_BASE;
-	} else if (!*c2) {
-		type2 = t_path;
-		state2 = s_SLASH;
-		c2 = (uchar*)"/";
 	} else {
 		type2 = t_path;
 		state2 = s_DIR;
 	}
 
 	if (type1 != type2)
 		return type1 == t_PATH ? 1 : -1;
 
-	while (1) {
-		if ((dif = (int)*c1++ - (int)*c2++) != 0)
-			break;
+	do {
 		if (!*c1) {
 			switch (state1) {
 			case s_DIR:
 				state1 = s_SLASH;
 				c1 = (uchar*)"/";
 				break;
@@ -1856,13 +1843,13 @@
 				type2 = t_ITEM;
 				break;
 			}
 			if (type1 != type2)
 				return type1 == t_PATH ? 1 : -1;
 		}
-	}
+	} while ((dif = (int)*c1++ - (int)*c2++) == 0);
 
 	return dif;
 }
 
 /* Return a copy of the full filename of a flist entry, using the indicated
  * buffer or one of 5 static buffers if fbuf is NULL.  No size-checking is
@@ -1883,15 +1870,15 @@
 	}
 
 	if (f->dirname) {
 		int len = strlen(f->dirname);
 		memcpy(fbuf, f->dirname, len);
 		fbuf[len] = '/';
-		strcpy(fbuf + len + 1, f->basename);
+		strlcpy(fbuf + len + 1, f->basename, MAXPATHLEN - (len + 1));
 	} else
-		strcpy(fbuf, f->basename);
+		strlcpy(fbuf, f->basename, MAXPATHLEN);
 
 	return fbuf;
 }
 
 /* Do a non-recursive scan of the named directory, possibly ignoring all
  * exclude rules except for the daemon's.  If "dlen" is >=0, it is the length
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/generator.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/generator.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/generator.c	2006-04-18 14:38:58.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/generator.c	2006-10-23 06:36:36.000000000 +0800
@@ -1,41 +1,40 @@
-/* -*- c-file-style: "linux" -*-
-
-   rsync -- fast file replication program
-
-   Copyright (C) 1996-2000 by Andrew Tridgell
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * Routines that are exclusive to the generator process.
+ *
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int dry_run;
 extern int do_xfers;
-extern int log_format_has_i;
-extern int daemon_log_format_has_i;
+extern int stdout_format_has_i;
+extern int logfile_format_has_i;
 extern int am_root;
 extern int am_server;
 extern int am_daemon;
 extern int do_progress;
-extern int recurse;
 extern int relative_paths;
 extern int implied_dirs;
 extern int keep_dirlinks;
 extern int preserve_links;
 extern int preserve_devices;
 extern int preserve_specials;
@@ -48,13 +47,13 @@
 extern int delete_mode;
 extern int delete_before;
 extern int delete_during;
 extern int delete_after;
 extern int module_id;
 extern int ignore_errors;
-extern int remove_sent_files;
+extern int remove_source_files;
 extern int delay_updates;
 extern int update_only;
 extern int ignore_existing;
 extern int ignore_non_existing;
 extern int inplace;
 extern int append_mode;
@@ -76,12 +75,13 @@
 extern char *basis_dir[];
 extern int compare_dest;
 extern int copy_dest;
 extern int link_dest;
 extern int whole_file;
 extern int list_only;
+extern int new_root_dir;
 extern int read_batch;
 extern int safe_symlinks;
 extern long block_size; /* "long" because popt can't set an int32. */
 extern int max_delete;
 extern int force_delete;
 extern int one_file_system;
@@ -288,14 +288,14 @@
 static void do_delete_pass(struct file_list *flist)
 {
 	char fbuf[MAXPATHLEN];
 	STRUCT_STAT st;
 	int j;
 
-	if (dry_run > 1 /* destination doesn't exist yet */
-	 || list_only)
+	/* dry_run is incremented when the destination doesn't exist yet. */
+	if (dry_run > 1 || list_only)
 		return;
 
 	for (j = 0; j < flist->count; j++) {
 		struct file_struct *file = flist->files[j];
 
 		if (!(file->flags & FLAG_DEL_HERE))
@@ -355,23 +355,25 @@
 			iflags |= ITEM_REPORT_GROUP;
 	} else
 		iflags |= ITEM_IS_NEW;
 
 	iflags &= 0xffff;
 	if ((iflags & SIGNIFICANT_ITEM_FLAGS || verbose > 1
-	  || log_format_has_i > 1 || (xname && *xname)) && !read_batch) {
+	  || stdout_format_has_i > 1 || (xname && *xname)) && !read_batch) {
 		if (protocol_version >= 29) {
 			if (ndx >= 0)
 				write_int(sock_f_out, ndx);
 			write_shortint(sock_f_out, iflags);
 			if (iflags & ITEM_BASIS_TYPE_FOLLOWS)
 				write_byte(sock_f_out, fnamecmp_type);
 			if (iflags & ITEM_XNAME_FOLLOWS)
 				write_vstring(sock_f_out, xname, strlen(xname));
-		} else if (ndx >= 0)
-			log_item(file, &stats, iflags, xname);
+		} else if (ndx >= 0) {
+			enum logcode code = logfile_format_has_i ? FINFO : FCLIENT;
+			log_item(code, file, &stats, iflags, xname);
+		}
 	}
 }
 
 
 /* Perform our quick-check heuristic for determining if a file is unchanged. */
 int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st)
@@ -448,13 +450,13 @@
 		s2length = SUM_LENGTH;
 	} else {
 		int32 c;
 		int64 l;
 		int b = BLOCKSUM_BIAS;
 		for (l = len; l >>= 1; b += 2) {}
-		for (c = blength; c >>= 1 && b; b--) {}
+		for (c = blength; (c >>= 1) && b; b--) {}
 		/* add a bit, subtract rollsum, round up. */
 		s2length = (b + 1 - 32 + 7) / 8; /* --optimize in compiler-- */
 		s2length = MAX(s2length, csum_length);
 		s2length = MIN(s2length, SUM_LENGTH);
 	}
 
@@ -625,13 +627,13 @@
 			best_match = j;
 			match_level = 2;
 			/* FALL THROUGH */
 		case 2:
 			if (!unchanged_attrs(file, stp))
 				continue;
-			if ((always_checksum || ignore_times)
+			if (always_checksum && preserve_times
 			 && cmp_time(stp->st_mtime, file->modtime))
 				continue;
 			best_match = j;
 			match_level = 3;
 			break;
 		}
@@ -642,35 +644,37 @@
 		return -1;
 
 	if (j != best_match) {
 		j = best_match;
 		pathjoin(cmpbuf, MAXPATHLEN, basis_dir[j], fname);
 		if (link_stat(cmpbuf, stp, 0) < 0)
-			match_level = 0;
+			return -1;
 	}
 
-#ifdef HAVE_LINK
 	if (match_level == 3 && !copy_dest) {
+#ifdef SUPPORT_HARD_LINKS
 		if (link_dest) {
 			if (hard_link_one(file, ndx, fname, 0, stp,
 					  cmpbuf, 1,
 					  itemizing && verbose > 1,
 					  code) < 0)
 				goto try_a_copy;
-			if (preserve_hard_links && file->link_u.links)
+			if (preserve_hard_links && file->link_u.links) {
+				if (dry_run)
+					file->link_u.links->link_dest_used = j + 1;
 				hard_link_cluster(file, ndx, itemizing, code);
-		} else if (itemizing)
+			}
+		} else
+#endif
+		if (itemizing)
 			itemize(file, ndx, 0, stp, 0, 0, NULL);
 		if (verbose > 1 && maybe_ATTRS_REPORT) {
-			code = daemon_log_format_has_i || dry_run
-			     ? FCLIENT : FINFO;
-			rprintf(code, "%s is uptodate\n", fname);
+			rprintf(FCLIENT, "%s is uptodate\n", fname);
 		}
 		return -2;
 	}
-#endif
 
 	if (match_level >= 2) {
 	  try_a_copy: /* Copy the file locally. */
 		if (copy_file(cmpbuf, fname, file->mode) < 0) {
 			if (verbose) {
 				rsyserr(FINFO, errno, "copy_file %s => %s",
@@ -681,14 +685,13 @@
 		if (itemizing)
 			itemize(file, ndx, 0, stp, ITEM_LOCAL_CHANGE, 0, NULL);
 		set_file_attrs(fname, file, NULL, 0);
 		if (maybe_ATTRS_REPORT
 		 && ((!itemizing && verbose && match_level == 2)
 		  || (verbose > 1 && match_level == 3))) {
-			code = daemon_log_format_has_i || dry_run
-			     ? FCLIENT : FINFO;
+			code = match_level == 3 ? FCLIENT : FINFO;
 			rprintf(code, "%s%s\n", fname,
 				match_level == 3 ? " is uptodate" : "");
 		}
 		if (preserve_hard_links && file->link_u.links)
 			hard_link_cluster(file, ndx, itemizing, code);
 		return -2;
@@ -728,15 +731,16 @@
 		} else if (IS_DEVICE(file->mode)) {
 			if (!IS_DEVICE(st.st_mode) || st.st_rdev != file->u.rdev)
 				continue;
 		} else {
 			rprintf(FERROR,
 				"internal: try_dests_non() called with invalid mode (%o)\n",
-				file->mode);
+				(int)file->mode);
 			exit_cleanup(RERR_UNSUPPORTED);
 		}
+#ifdef SUPPORT_HARD_LINKS
 		if (link_dest
 #ifndef CAN_HARDLINK_SYMLINK
 		 && !S_ISLNK(file->mode)
 #endif
 #ifndef CAN_HARDLINK_SPECIAL
 		 && !IS_SPECIAL(file->mode) && !IS_DEVICE(file->mode)
@@ -748,22 +752,21 @@
 					fnamebuf, fname);
 				break;
 			}
 			if (preserve_hard_links && file->link_u.links)
 				hard_link_cluster(file, ndx, itemizing, code);
 		}
-		if (itemizing && log_format_has_i && verbose > 1) {
+#endif
+		if (itemizing && stdout_format_has_i && verbose > 1) {
 			int changes = compare_dest ? 0 : ITEM_LOCAL_CHANGE
 				    + (link_dest ? ITEM_XNAME_FOLLOWS : 0);
 			char *lp = link_dest ? "" : NULL;
 			itemize(file, ndx, 0, &st, changes, 0, lp);
 		}
 		if (verbose > 1 && maybe_ATTRS_REPORT) {
-			code = daemon_log_format_has_i || dry_run
-			     ? FCLIENT : FINFO;
-			rprintf(code, "%s is uptodate\n", fname);
+			rprintf(FCLIENT, "%s is uptodate\n", fname);
 		}
 		return -2;
 	} while (basis_dir[++i] != NULL);
 
 	return -1;
 }
@@ -804,13 +807,14 @@
 	if (!fname) {
 		if (fuzzy_dirlist) {
 			flist_free(fuzzy_dirlist);
 			fuzzy_dirlist = NULL;
 		}
 		if (missing_below >= 0) {
-			dry_run--;
+			if (dry_run)
+				dry_run--;
 			missing_below = -1;
 		}
 		parent_dirname = "";
 		return;
 	}
 
@@ -834,15 +838,19 @@
 					fname);
 			}
 			return;
 		}
 	}
 
-	if (missing_below >= 0 && file->dir.depth <= missing_below) {
-		dry_run--;
-		missing_below = -1;
+	if (missing_below >= 0) {
+		if (file->dir.depth <= missing_below) {
+			if (dry_run)
+				dry_run--;
+			missing_below = -1;
+		} else if (!dry_run)
+			return;
 	}
 	if (dry_run > 1) {
 		statret = -1;
 		stat_errno = ENOENT;
 	} else {
 		char *dn = file->dirname ? file->dirname : ".";
@@ -903,26 +911,40 @@
 		}
 		if (dry_run && statret != 0 && missing_below < 0) {
 			missing_below = file->dir.depth;
 			dry_run++;
 		}
 		if (itemizing && f_out != -1) {
-			itemize(file, ndx, statret, &st,
-				statret ? ITEM_LOCAL_CHANGE : 0, 0, NULL);
+			int sr = statret;
+			if (new_root_dir) {
+				if (*fname == '.' && fname[1] == '\0')
+					sr = -1;
+				new_root_dir = 0;
+			}
+			itemize(file, ndx, sr, &st,
+				sr ? ITEM_LOCAL_CHANGE : 0, 0, NULL);
 		}
 		if (statret != 0 && do_mkdir(fname,file->mode) < 0 && errno != EEXIST) {
 			if (!relative_paths || errno != ENOENT
 			    || create_directory_path(fname) < 0
 			    || (do_mkdir(fname, file->mode) < 0 && errno != EEXIST)) {
 				rsyserr(FERROR, errno,
 					"recv_generator: mkdir %s failed",
 					full_fname(fname));
+				file->flags |= FLAG_MISSING;
+				if (ndx+1 < the_file_list->count
+				 && the_file_list->files[ndx+1]->dir.depth > file->dir.depth) {
+					rprintf(FERROR,
+					    "*** Skipping everything below this failed directory ***\n");
+					missing_below = file->dir.depth;
+				}
+				return;
 			}
 		}
 		if (set_file_attrs(fname, file, statret ? NULL : &st, 0)
-		    && verbose && code && f_out != -1)
+		    && verbose && code != FNONE && f_out != -1)
 			rprintf(code, "%s/\n", fname);
 		if (delete_during && f_out != -1 && !phase && dry_run < 2
 		    && (file->flags & FLAG_DEL_HERE))
 			delete_in_dir(the_file_list, fname, file, &st);
 		return;
 	}
@@ -964,12 +986,14 @@
 					if (preserve_hard_links
 					    && file->link_u.links) {
 						hard_link_cluster(file, ndx,
 								  itemizing,
 								  code);
 					}
+					if (remove_source_files == 1)
+						goto return_with_success;
 					return;
 				}
 			}
 			/* Not the right symlink (or not a symlink), so
 			 * delete it. */
 			if (delete_item(fname, st.st_mode, del_opts) < 0)
@@ -983,13 +1007,14 @@
 				if (link_dest) {
 					/* Resort to --copy-dest behavior. */
 				} else
 #endif
 				if (!copy_dest)
 					return;
-				itemizing = code = 0;
+				itemizing = 0;
+				code = FNONE;
 			}
 		}
 		if (preserve_hard_links && file->link_u.links
 		    && hard_link_check(file, ndx, fname, -1, &st,
 				       itemizing, code, HL_SKIP))
 			return;
@@ -999,23 +1024,23 @@
 		} else {
 			set_file_attrs(fname, file, NULL, 0);
 			if (itemizing) {
 				itemize(file, ndx, statret, &st,
 					ITEM_LOCAL_CHANGE, 0, NULL);
 			}
-			if (code && verbose) {
+			if (code != FNONE && verbose) {
 				rprintf(code, "%s -> %s\n", fname,
 					file->u.link);
 			}
-			if (remove_sent_files && !dry_run) {
-				char numbuf[4];
-				SIVAL(numbuf, 0, ndx);
-				send_msg(MSG_SUCCESS, numbuf, 4);
-			}
 			if (preserve_hard_links && file->link_u.links)
 				hard_link_cluster(file, ndx, itemizing, code);
+			/* This does not check remove_source_files == 1
+			 * because this is one of the items that the old
+			 * --remove-sent-files option would remove. */
+			if (remove_source_files)
+				goto return_with_success;
 		}
 #endif
 		return;
 	}
 
 	if ((am_root && preserve_devices && IS_DEVICE(file->mode))
@@ -1027,13 +1052,14 @@
 				if (link_dest) {
 					/* Resort to --copy-dest behavior. */
 				} else
 #endif
 				if (!copy_dest)
 					return;
-				itemizing = code = 0;
+				itemizing = 0;
+				code = FNONE;
 			}
 		}
 		if (statret != 0
 		 || (st.st_mode & ~CHMOD_BITS) != (file->mode & ~CHMOD_BITS)
 		 || st.st_rdev != file->u.rdev) {
 			if (statret == 0
@@ -1057,25 +1083,29 @@
 			} else {
 				set_file_attrs(fname, file, NULL, 0);
 				if (itemizing) {
 					itemize(file, ndx, statret, &st,
 						ITEM_LOCAL_CHANGE, 0, NULL);
 				}
-				if (code && verbose)
+				if (code != FNONE && verbose)
 					rprintf(code, "%s\n", fname);
 				if (preserve_hard_links && file->link_u.links) {
 					hard_link_cluster(file, ndx,
 							  itemizing, code);
 				}
+				if (remove_source_files == 1)
+					goto return_with_success;
 			}
 		} else {
 			if (itemizing)
 				itemize(file, ndx, statret, &st, 0, 0, NULL);
 			set_file_attrs(fname, file, &st, maybe_ATTRS_REPORT);
 			if (preserve_hard_links && file->link_u.links)
 				hard_link_cluster(file, ndx, itemizing, code);
+			if (remove_source_files == 1)
+				goto return_with_success;
 		}
 		return;
 	}
 
 	if (!S_ISREG(file->mode)) {
 		if (the_file_list->count == 1)
@@ -1124,15 +1154,18 @@
 		stat_errno = ENOENT;
 	}
 
 	if (statret != 0 && basis_dir[0] != NULL) {
 		int j = try_dests_reg(file, fname, ndx, fnamecmpbuf, &st,
 				      itemizing, maybe_ATTRS_REPORT, code);
-		if (j == -2)
+		if (j == -2) {
+			if (remove_source_files == 1)
+				goto return_with_success;
 			return;
-		if (j != -1) {
+		}
+		if (j >= 0) {
 			fnamecmp = fnamecmpbuf;
 			fnamecmp_type = j;
 			statret = 0;
 		}
 	}
 
@@ -1191,12 +1224,20 @@
 			itemize(file, ndx, real_ret, &real_st,
 				0, 0, NULL);
 		}
 		set_file_attrs(fname, file, &st, maybe_ATTRS_REPORT);
 		if (preserve_hard_links && file->link_u.links)
 			hard_link_cluster(file, ndx, itemizing, code);
+		if (remove_source_files != 1)
+			return;
+	  return_with_success:
+		if (!dry_run) {
+			char numbuf[4];
+			SIVAL(numbuf, 0, ndx);
+			send_msg(MSG_SUCCESS, numbuf, 4);
+		}
 		return;
 	}
 
   prepare_to_open:
 	if (partialptr) {
 		st = partial_st;
@@ -1263,14 +1304,14 @@
 	}
 
 	if (verbose > 2)
 		rprintf(FINFO, "generating and sending sums for %d\n", ndx);
 
   notify_others:
-	if (remove_sent_files && !delay_updates && !phase)
-	    increment_active_files(ndx, itemizing, code);
+	if (remove_source_files && !delay_updates && !phase)
+		increment_active_files(ndx, itemizing, code);
 	write_int(f_out, ndx);
 	if (itemizing) {
 		int iflags = ITEM_TRANSFER;
 		if (always_checksum)
 			iflags |= ITEM_REPORT_CHECKSUM;
 		if (fnamecmp_type != FNAMECMP_FNAME)
@@ -1323,22 +1364,22 @@
 	int save_do_progress = do_progress;
 	int save_make_backups = make_backups;
 	int dir_tweaking = !(list_only || local_name || dry_run);
 
 	if (protocol_version >= 29) {
 		itemizing = 1;
-		maybe_ATTRS_REPORT = log_format_has_i ? 0 : ATTRS_REPORT;
-		code = daemon_log_format_has_i ? 0 : FLOG;
+		maybe_ATTRS_REPORT = stdout_format_has_i ? 0 : ATTRS_REPORT;
+		code = logfile_format_has_i ? FNONE : FLOG;
 	} else if (am_daemon) {
-		itemizing = daemon_log_format_has_i && do_xfers;
+		itemizing = logfile_format_has_i && do_xfers;
 		maybe_ATTRS_REPORT = ATTRS_REPORT;
 		code = itemizing || !do_xfers ? FCLIENT : FINFO;
 	} else if (!am_server) {
-		itemizing = log_format_has_i;
-		maybe_ATTRS_REPORT = log_format_has_i ? 0 : ATTRS_REPORT;
-		code = itemizing ? 0 : FINFO;
+		itemizing = stdout_format_has_i;
+		maybe_ATTRS_REPORT = stdout_format_has_i ? 0 : ATTRS_REPORT;
+		code = itemizing ? FNONE : FINFO;
 	} else {
 		itemizing = 0;
 		maybe_ATTRS_REPORT = ATTRS_REPORT;
 		code = FINFO;
 	}
 
@@ -1473,12 +1514,22 @@
 			struct file_struct *file = flist->files[i];
 
 			if (!file->basename || !S_ISDIR(file->mode))
 				continue;
 			if (!need_retouch_dir_times && file->mode & S_IWUSR)
 				continue;
+			if (file->flags & FLAG_MISSING) {
+				int missing = file->dir.depth;
+				while (++i < flist->count) {
+					file = flist->files[i];
+					if (file->dir.depth <= missing)
+						break;
+				}
+				i--;
+				continue;
+			}
 			recv_generator(f_name(file, NULL), file, i, itemizing,
 				       maybe_ATTRS_REPORT, code, -1);
 			if (allowed_lull && !(++j % lull_mod))
 				maybe_send_keepalive();
 			else if (!(j % 200))
 				maybe_flush_socket();
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/getgroups.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/getgroups.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/getgroups.c	2005-02-14 08:53:43.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/getgroups.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,31 +1,27 @@
 /*
- * Copyright (C) 2002 by Martin Pool
- * 
+ * Print out the gids of all groups for the current user.  This is like
+ * `id -G` on Linux, but it's too hard to find a portable equivalent.
+ *
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003, 2004 Wayne Davison
+ *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
- * 
+ *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
- * 
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- */
-
-/**
- * @file getgroups.c
  *
- * Print out the gids of all groups for the current user.  This is
- * like `id -G` on Linux, but it's too hard to find a portable
- * equivalent.
- **/
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 int
 main(UNUSED(int argc), UNUSED(char *argv[]))
 {
@@ -60,9 +56,9 @@
 			gid_in_list = 1;
 	}
 	/* The default gid might not be in the list on some systems. */
 	if (!gid_in_list)
 		printf("%lu", (unsigned long)gid);
 	printf("\n");
-		
+
 	return 0;
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/hlink.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/hlink.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/hlink.c	2006-02-25 00:43:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/hlink.c	2006-10-18 02:49:04.000000000 +0800
@@ -1,32 +1,37 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Routines to support hard-linking.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
+extern int do_xfers;
 extern int link_dest;
 extern int make_backups;
-extern int log_format_has_i;
+extern int remove_source_files;
+extern int stdout_format_has_i;
 extern char *basis_dir[];
 extern struct file_list *the_file_list;
 
 #ifdef SUPPORT_HARD_LINKS
 
 #define SKIPPED_LINK (-1)
@@ -47,20 +52,20 @@
 	if (f1->F_INODE != f2->F_INODE)
 		return (int) (f1->F_INODE > f2->F_INODE ? 1 : -1);
 
 	return f_name_cmp(f1, f2);
 }
 
-static int *hlink_list;
-static int hlink_count;
+static int32 *hlink_list;
+static int32 hlink_count;
 
 /* Analyze the data in the hlink_list[], remove items that aren't multiply
  * linked, and replace the dev+inode data with the hlindex+next linked list. */
 static void link_idev_data(void)
 {
-	int cur, from, to, start;
+	int32 cur, from, to, start;
 
 	alloc_pool_t hlink_pool;
 	alloc_pool_t idev_pool = the_file_list->hlink_pool;
 
 	hlink_pool = pool_create(128 * 1024, sizeof (struct hlink),
 	    out_of_memory, POOL_INTERN);
@@ -75,36 +80,38 @@
 			pool_free(idev_pool, 0, FPTR(cur)->link_u.idev);
 			FPTR(cur)->link_u.links = pool_talloc(hlink_pool,
 			    struct hlink, 1, "hlink_list");
 
 			FPTR(cur)->F_HLINDEX = to;
 			FPTR(cur)->F_NEXT = hlink_list[++from];
+			FPTR(cur)->link_u.links->link_dest_used = 0;
 		}
 		pool_free(idev_pool, 0, FPTR(cur)->link_u.idev);
 		if (from > start) {
 			int head = hlink_list[start];
 			FPTR(cur)->link_u.links = pool_talloc(hlink_pool,
 			    struct hlink, 1, "hlink_list");
 
 			FPTR(head)->flags |= FLAG_HLINK_TOL;
 			FPTR(cur)->F_HLINDEX = to;
 			FPTR(cur)->F_NEXT = head;
 			FPTR(cur)->flags |= FLAG_HLINK_EOL;
+			FPTR(cur)->link_u.links->link_dest_used = 0;
 			hlink_list[to++] = head;
 		} else
 			FPTR(cur)->link_u.links = NULL;
 	}
 
 	if (!to) {
 		free(hlink_list);
 		hlink_list = NULL;
 		pool_destroy(hlink_pool);
 		hlink_pool = NULL;
 	} else {
 		hlink_count = to;
-		hlink_list = realloc_array(hlink_list, int, hlink_count);
+		hlink_list = realloc_array(hlink_list, int32, hlink_count);
 		if (!hlink_list)
 			out_of_memory("init_hard_links");
 	}
 	the_file_list->hlink_pool = hlink_pool;
 	pool_destroy(idev_pool);
 }
@@ -115,13 +122,13 @@
 #ifdef SUPPORT_HARD_LINKS
 	int i;
 
 	if (hlink_list)
 		free(hlink_list);
 
-	if (!(hlink_list = new_array(int, the_file_list->count)))
+	if (!(hlink_list = new_array(int32, the_file_list->count)))
 		out_of_memory("init_hard_links");
 
 	hlink_count = 0;
 	for (i = 0; i < the_file_list->count; i++) {
 		if (FPTR(i)->link_u.idev)
 			hlink_list[hlink_count++] = i;
@@ -177,19 +184,25 @@
 	if (skip && !(file->flags & FLAG_HLINK_EOL))
 		head = hlink_list[file->F_HLINDEX] = file->F_NEXT;
 	else
 		head = hlink_list[file->F_HLINDEX];
 	if (ndx != head) {
 		struct file_struct *head_file = FPTR(head);
-		if (!log_format_has_i && verbose > 1) {
+		if (!stdout_format_has_i && verbose > 1) {
 			rprintf(FINFO, "\"%s\" is a hard link\n",
 				f_name(file, NULL));
 		}
 		if (head_file->F_HLINDEX == FINISHED_LINK) {
 			STRUCT_STAT st2, st3;
-			char *toname = f_name(head_file, NULL);
+			char toname[MAXPATHLEN];
+			int ldu = head_file->link_u.links->link_dest_used;
+			if (ldu) {
+				pathjoin(toname, MAXPATHLEN, basis_dir[ldu-1],
+					 f_name(head_file, NULL));
+			} else
+				f_name(head_file, toname);
 			if (link_stat(toname, &st2, 0) < 0) {
 				rsyserr(FERROR, errno, "stat %s failed",
 					full_fname(toname));
 				return -1;
 			}
 			if (statret < 0 && basis_dir[0] != NULL) {
@@ -202,26 +215,33 @@
 					if (link_dest) {
 						if (st2.st_dev != st3.st_dev
 						 || st2.st_ino != st3.st_ino)
 							continue;
 						statret = 1;
 						st = &st3;
-						if (verbose < 2 || !log_format_has_i)
-							itemizing = code = 0;
+						if (verbose < 2 || !stdout_format_has_i) {
+							itemizing = 0;
+							code = FNONE;
+						}
 						break;
 					}
 					if (!unchanged_file(cmpbuf, file, &st3))
 						continue;
 					statret = 1;
 					st = &st3;
 					if (unchanged_attrs(file, &st3))
 						break;
 				} while (basis_dir[++j] != NULL);
 			}
 			maybe_hard_link(file, ndx, fname, statret, st,
 					toname, &st2, itemizing, code);
+			if (remove_source_files == 1 && do_xfers) {
+				char numbuf[4];
+				SIVAL(numbuf, 0, ndx);
+				send_msg(MSG_SUCCESS, numbuf, 4);
+			}
 			file->F_HLINDEX = FINISHED_LINK;
 		} else
 			file->F_HLINDEX = SKIPPED_LINK;
 		return 1;
 	}
 #endif
@@ -247,13 +267,13 @@
 
 	if (itemizing) {
 		itemize(file, ndx, statret, st,
 			ITEM_LOCAL_CHANGE | ITEM_XNAME_FOLLOWS, 0,
 			terse ? "" : toname);
 	}
-	if (code && verbose && !terse)
+	if (code != FNONE && verbose && !terse)
 		rprintf(code, "%s => %s\n", fname, toname);
 	return 0;
 }
 #endif
 
 
@@ -281,10 +301,15 @@
 		if (file->F_HLINDEX != SKIPPED_LINK)
 			continue;
 		hlink2 = f_name(file, NULL);
 		statret = link_stat(hlink2, &st2, 0);
 		maybe_hard_link(file, ndx, hlink2, statret, &st2,
 				hlink1, &st1, itemizing, code);
+		if (remove_source_files == 1 && do_xfers) {
+			char numbuf[4];
+			SIVAL(numbuf, 0, ndx);
+			send_msg(MSG_SUCCESS, numbuf, 4);
+		}
 		file->F_HLINDEX = FINISHED_LINK;
 	} while (!(file->flags & FLAG_HLINK_EOL));
 #endif
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/io.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/io.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/io.c	2006-04-22 00:40:19.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/io.c	2006-10-01 06:11:20.000000000 +0800
@@ -1,41 +1,35 @@
-/* -*- c-file-style: "linux" -*-
+/*
+ * Socket and pipe I/O utilities used in rsync.
  *
- * Copyright (C) 1996-2001 by Andrew Tridgell
- * Copyright (C) Paul Mackerras 1996
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1996-2001 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/**
- * @file io.c
- *
- * Socket and pipe I/O utilities used in rsync.
- *
- * rsync provides its own multiplexing system, which is used to send
- * stderr and stdout over a single socket.  We need this because
- * stdout normally carries the binary data stream, and stderr all our
- * error messages.
+/* Rsync provides its own multiplexing system, which is used to send
+ * stderr and stdout over a single socket.
  *
  * For historical reasons this is off during the start of the
  * connection, but it's switched on quite early using
- * io_start_multiplex_out() and io_start_multiplex_in().
- **/
+ * io_start_multiplex_out() and io_start_multiplex_in(). */
 
 #include "rsync.h"
 
 /** If no timeout is specified then use a 60 second select timeout */
 #define SELECT_TIMEOUT 60
 
@@ -49,13 +43,13 @@
 extern int am_generator;
 extern int eol_nulls;
 extern int read_batch;
 extern int csum_length;
 extern int checksum_seed;
 extern int protocol_version;
-extern int remove_sent_files;
+extern int remove_source_files;
 extern int preserve_hard_links;
 extern char *filesfrom_host;
 extern struct stats stats;
 extern struct file_list *the_file_list;
 
 const char phase_unknown[] = "unknown";
@@ -260,39 +254,33 @@
 	case MSG_REDO:
 		if (len != 4 || !am_generator) {
 			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 			exit_cleanup(RERR_STREAMIO);
 		}
 		read_loop(fd, buf, 4);
-		if (remove_sent_files)
+		if (remove_source_files)
 			decrement_active_files(IVAL(buf,0));
 		flist_ndx_push(&redo_list, IVAL(buf,0));
 		break;
 	case MSG_DELETED:
 		if (len >= (int)sizeof buf || !am_generator) {
 			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 			exit_cleanup(RERR_STREAMIO);
 		}
 		read_loop(fd, buf, len);
-		if (defer_forwarding_messages)
-			msg_list_add(&msg2sndr, MSG_DELETED, buf, len);
-		else
-			io_multiplex_write(MSG_DELETED, buf, len);
+		send_msg(MSG_DELETED, buf, len);
 		break;
 	case MSG_SUCCESS:
 		if (len != 4 || !am_generator) {
 			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 			exit_cleanup(RERR_STREAMIO);
 		}
 		read_loop(fd, buf, len);
-		if (remove_sent_files) {
+		if (remove_source_files) {
 			decrement_active_files(IVAL(buf,0));
-			if (defer_forwarding_messages)
-				msg_list_add(&msg2sndr, MSG_SUCCESS, buf, len);
-			else
-				io_multiplex_write(MSG_SUCCESS, buf, len);
+			send_msg(MSG_SUCCESS, buf, len);
 		}
 		if (preserve_hard_links)
 			flist_ndx_push(&hlink_list, IVAL(buf,0));
 		break;
 	case MSG_SOCKERR:
 		if (!am_generator) {
@@ -306,16 +294,13 @@
 	case MSG_LOG:
 		while (len) {
 			n = len;
 			if (n >= sizeof buf)
 				n = sizeof buf - 1;
 			read_loop(fd, buf, n);
-			if (am_generator && am_server && defer_forwarding_messages)
-				msg_list_add(&msg2sndr, tag, buf, n);
-			else
-				rwrite((enum logcode)tag, buf, n);
+			rwrite(tag, buf, n);
 			len -= n;
 		}
 		break;
 	default:
 		rprintf(FERROR, "unknown message %d:%d [%s]\n",
 			tag, len, who_am_i());
@@ -323,13 +308,13 @@
 	}
 
 	msg_fd_in = fd;
 }
 
 /* This is used by the generator to limit how many file transfers can
- * be active at once when --remove-sent-files is specified.  Without
+ * be active at once when --remove-source-files is specified.  Without
  * this, sender-side deletions were mostly happening at the end. */
 void increment_active_files(int ndx, int itemizing, enum logcode code)
 {
 	/* TODO: tune these limits? */
 	while (active_filecnt >= (active_bytecnt >= 128*1024 ? 10 : 50)) {
 		if (hlink_list.head)
@@ -383,20 +368,25 @@
 			written = 0;
 		}
 	}
 	return 1;
 }
 
-void send_msg(enum msgcode code, char *buf, int len)
+int send_msg(enum msgcode code, char *buf, int len)
 {
 	if (msg_fd_out < 0) {
-		io_multiplex_write(code, buf, len);
-		return;
+		if (!defer_forwarding_messages)
+			return io_multiplex_write(code, buf, len);
+		if (!io_multiplexing_out)
+			return 0;
+		msg_list_add(&msg2sndr, code, buf, len);
+		return 1;
 	}
 	msg_list_add(&msg2genr, code, buf, len);
 	msg2genr_flush(NORMAL_FLUSH);
+	return 1;
 }
 
 int get_redo_num(int itemizing, enum logcode code)
 {
 	while (1) {
 		if (hlink_list.head)
@@ -640,19 +630,25 @@
 	s = fname;
 	while (1) {
 		cnt = read(fd, &ch, 1);
 		if (cnt < 0 && (errno == EWOULDBLOCK
 		  || errno == EINTR || errno == EAGAIN)) {
 			struct timeval tv;
-			fd_set fds;
-			FD_ZERO(&fds);
-			FD_SET(fd, &fds);
+			fd_set r_fds, e_fds;
+			FD_ZERO(&r_fds);
+			FD_SET(fd, &r_fds);
+			FD_ZERO(&e_fds);
+			FD_SET(fd, &e_fds);
 			tv.tv_sec = select_timeout;
 			tv.tv_usec = 0;
-			if (!select(fd+1, &fds, NULL, NULL, &tv))
+			if (!select(fd+1, &r_fds, NULL, &e_fds, &tv))
 				check_timeout();
+			if (FD_ISSET(fd, &e_fds)) {
+				rsyserr(FINFO, errno,
+					"select exception on fd %d", fd);
+			}
 			continue;
 		}
 		if (cnt != 1)
 			break;
 		if (nulls? !ch : (ch == '\r' || ch == '\n')) {
 			/* Skip empty lines if reading locally. */
@@ -998,22 +994,22 @@
  * We therefore keep track of the bytes we've written over time and only
  * sleep when the accumulated delay is at least 1 tenth of a second.
  **/
 static void sleep_for_bwlimit(int bytes_written)
 {
 	static struct timeval prior_tv;
-	static long total_written = 0; 
+	static long total_written = 0;
 	struct timeval tv, start_tv;
 	long elapsed_usec, sleep_usec;
 
 #define ONE_SEC	1000000L /* # of microseconds in a second */
 
 	if (!bwlimit_writemax)
 		return;
 
-	total_written += bytes_written; 
+	total_written += bytes_written;
 
 	gettimeofday(&start_tv, NULL);
 	if (prior_tv.tv_sec) {
 		elapsed_usec = (start_tv.tv_sec - prior_tv.tv_sec) * ONE_SEC
 			     + (start_tv.tv_usec - prior_tv.tv_usec);
 		total_written -= elapsed_usec * bwlimit / (ONE_SEC/1024);
@@ -1043,47 +1039,54 @@
  *
  * This function underlies the multiplexing system.  The body of the
  * application never calls this function directly. */
 static void writefd_unbuffered(int fd,char *buf,size_t len)
 {
 	size_t n, total = 0;
-	fd_set w_fds, r_fds;
+	fd_set w_fds, r_fds, e_fds;
 	int maxfd, count, cnt, using_r_fds;
 	int defer_save = defer_forwarding_messages;
 	struct timeval tv;
 
 	no_flush++;
 
 	while (total < len) {
 		FD_ZERO(&w_fds);
-		FD_SET(fd,&w_fds);
+		FD_SET(fd, &w_fds);
+		FD_ZERO(&e_fds);
+		FD_SET(fd, &e_fds);
 		maxfd = fd;
 
 		if (msg_fd_in >= 0) {
 			FD_ZERO(&r_fds);
-			FD_SET(msg_fd_in,&r_fds);
+			FD_SET(msg_fd_in, &r_fds);
 			if (msg_fd_in > maxfd)
 				maxfd = msg_fd_in;
 			using_r_fds = 1;
 		} else
 			using_r_fds = 0;
 
 		tv.tv_sec = select_timeout;
 		tv.tv_usec = 0;
 
 		errno = 0;
 		count = select(maxfd + 1, using_r_fds ? &r_fds : NULL,
-			       &w_fds, NULL, &tv);
+			       &w_fds, &e_fds, &tv);
 
 		if (count <= 0) {
 			if (count < 0 && errno == EBADF)
 				exit_cleanup(RERR_SOCKETIO);
 			check_timeout();
 			continue;
 		}
 
+		if (FD_ISSET(fd, &e_fds)) {
+			rsyserr(FINFO, errno,
+				"select exception on fd %d", fd);
+		}
+
 		if (using_r_fds && FD_ISSET(msg_fd_in, &r_fds))
 			read_msg_fd();
 
 		if (!FD_ISSET(fd, &w_fds))
 			continue;
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/compat.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/compat.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/compat.c	2006-04-14 00:52:15.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/compat.c	2006-10-14 07:17:37.000000000 +0800
@@ -1,45 +1,38 @@
-/* 
-   Copyright (C) Andrew Tridgell 1998
-   Copyright (C) 2002 by Martin Pool
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/**
- * @file compat.c
+/*
+ * Reimplementations of standard functions for platforms that don't have them.
  *
- * Reimplementations of standard functions for platforms that don't
- * have them.
- **/
-
-
+ * Copyright (C) 1998 Andrew Tridgell
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
-
 #ifndef HAVE_STRDUP
  char *strdup(char *s)
 {
-  int l = strlen(s) + 1;
-  char *ret = (char *)malloc(l);
-  if (ret)
-    strcpy(ret,s);
-  return ret;
+	int len = strlen(s) + 1;
+	char *ret = (char *)malloc(len);
+	if (ret)
+		memcpy(ret, s, len);
+	return ret;
 }
 #endif
 
 #ifndef HAVE_GETCWD
  char *getcwd(char *buf, int size)
 {
@@ -83,13 +76,13 @@
 #endif
 
 #ifndef HAVE_STRPBRK
 /**
  * Find the first ocurrence in @p s of any character in @p accept.
  *
- * Derived from glibc 
+ * Derived from glibc
  **/
  char *strpbrk(const char *s, const char *accept)
 {
 	while (*s != '\0')  {
 		const char *a = accept;
 		while (*a != '\0') {
@@ -102,13 +95,13 @@
 }
 #endif
 
 
 #ifndef HAVE_STRLCPY
 /**
- * Like strncpy but does not 0 fill the buffer and always null 
+ * Like strncpy but does not 0 fill the buffer and always null
  * terminates.
  *
  * @param bufsize is the size of the destination buffer.
  *
  * @return index of the terminating byte.
  **/
@@ -125,13 +118,13 @@
 	return ret;
 }
 #endif
 
 #ifndef HAVE_STRLCAT
 /**
- * Like strncat() but does not 0 fill the buffer and always null 
+ * Like strncat() but does not 0 fill the buffer and always null
  * terminates.
  *
  * @param bufsize length of the buffer, which should be one more than
  * the maximum resulting string length.
  **/
  size_t strlcat(char *d, const char *s, size_t bufsize)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/getaddrinfo.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/getaddrinfo.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/getaddrinfo.c	2005-02-14 08:53:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/getaddrinfo.c	2006-10-28 05:14:28.000000000 +0800
@@ -1,10 +1,10 @@
 /*
  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
  *
- * Changes Copyright (C) 2001 by Martin Pool <mbp@samba.org>
+ * Changes Copyright (C) 2001 Martin Pool <mbp@samba.org>
  * 
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
@@ -61,19 +61,21 @@
 #ifdef NO_ADDRESS
 #define NO_DATA NO_ADDRESS
 #endif
 #endif /* ndef NO_DATA */
 
 static const char in_addrany[] = { 0, 0, 0, 0 };
+static const char in_loopback[] = { 127, 0, 0, 1 }; 
+#ifdef INET6
 static const char in6_addrany[] = {
 	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
 };
-static const char in_loopback[] = { 127, 0, 0, 1 }; 
 static const char in6_loopback[] = {
 	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1
 };
+#endif
 
 struct sockinet {
 	u_char	si_len;
 	u_char	si_family;
 	u_short	si_port;
 };
@@ -134,14 +136,15 @@
 	"resolved protocol is unknown.",		/* EAI_PROTOCOL   */
 	"unknown error.", 				/* EAI_MAX        */
 };
 
 #define GET_CANONNAME(ai, str) \
 if (pai->ai_flags & AI_CANONNAME) {\
-	if (((ai)->ai_canonname = (char *)malloc(strlen(str) + 1)) != NULL) {\
-		strcpy((ai)->ai_canonname, (str));\
+	int name_size = strlen(str) + 1;\
+	if (((ai)->ai_canonname = (char *)malloc(name_size)) != NULL) {\
+		memcpy((ai)->ai_canonname, (str), name_size);\
 	} else {\
 		error = EAI_MEMORY;\
 		goto free;\
 	}\
 }
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/getnameinfo.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/getnameinfo.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/getnameinfo.c	2005-02-14 08:53:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/getnameinfo.c	2006-11-04 15:22:00.000000000 +0800
@@ -1,10 +1,10 @@
 /*
  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
  *
- * Changes Copyright (C) 2001 by Martin Pool <mbp@samba.org>
+ * Changes Copyright (C) 2001 Martin Pool <mbp@samba.org>
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
@@ -88,15 +88,14 @@
 	u_short port;
 	int family, i;
 	char *addr, *p;
 	u_long v4a;
 #ifdef INET6
 	u_char pfx;
-#endif
 	int h_error;
-	char numserv[512];
+#endif
 	char numaddr[512];
 
 	if (sa == NULL)
 		return ENI_NOSOCKET;
 
 #ifdef HAVE_SOCKADDR_LEN
@@ -109,30 +108,28 @@
 			afd = &afdl[i];
 			goto found;
 		}
 	return ENI_FAMILY;
 	
  found:
-	if (salen != afd->a_socklen) return ENI_SALEN;
+	if (salen != (size_t)afd->a_socklen)
+		return ENI_SALEN;
 	
 	port = ((struct sockinet *)sa)->si_port; /* network byte order */
 	addr = (char *)sa + afd->a_off;
 
 	if (serv == NULL || servlen == 0) {
 		/* what we should do? */
 	} else if (flags & NI_NUMERICSERV) {
-		snprintf(numserv, sizeof(numserv), "%d", ntohs(port));
-		if (strlen(numserv) > servlen)
+		if ((size_t)snprintf(serv, servlen+1, "%d", ntohs(port)) > servlen)
 			return ENI_MEMORY;
-		strcpy(serv, numserv);
 	} else {
 		sp = getservbyport(port, (flags & NI_DGRAM) ? "udp" : "tcp");
 		if (sp) {
-			if (strlen(sp->s_name) > servlen)
+			if (strlcpy(serv, sp->s_name, servlen + 1) > servlen)
 				return ENI_MEMORY;
-			strcpy(serv, sp->s_name);
 		} else
 			return ENI_NOSERVNAME;
 	}
 
 	switch (sa->sa_family) {
 	case AF_INET:
@@ -153,44 +150,41 @@
 	}
 	if (host == NULL || hostlen == 0) {
 		/* what should we do? */
 	} else if (flags & NI_NUMERICHOST) {
 		if (!inet_ntop(afd->a_af, addr, numaddr, sizeof(numaddr)))
 			return ENI_SYSTEM;
-		if (strlen(numaddr) > hostlen)
+		if (strlcpy(host, numaddr, hostlen + 1) > hostlen)
 			return ENI_MEMORY;
-		strcpy(host, numaddr);
 	} else {
 #ifdef INET6
 		hp = getipnodebyaddr(addr, afd->a_addrlen, afd->a_af, &h_error);
 #else
 		hp = gethostbyaddr(addr, afd->a_addrlen, afd->a_af);
-		h_error = h_errno;
+		/*h_error = h_errno;*/
 #endif
 
 		if (hp) {
 			if (flags & NI_NOFQDN) {
 				p = strchr(hp->h_name, '.');
 				if (p) *p = '\0';
 			}
-			if (strlen(hp->h_name) > hostlen) {
+			if (strlcpy(host, hp->h_name, hostlen + 1) > hostlen) {
 #ifdef INET6
 				freehostent(hp);
 #endif
 				return ENI_MEMORY;
 			}
-			strcpy(host, hp->h_name);
 #ifdef INET6
 			freehostent(hp);
 #endif
 		} else {
 			if (flags & NI_NAMEREQD)
 				return ENI_NOHOSTNAME;
 			if (!inet_ntop(afd->a_af, addr, numaddr, sizeof(numaddr)))
 				return ENI_NOHOSTNAME;
-			if (strlen(numaddr) > hostlen)
+			if (strlcpy(host, numaddr, hostlen + 1) > hostlen)
 				return ENI_MEMORY;
-			strcpy(host, numaddr);
 		}
 	}
 	return SUCCESS;
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/inet_ntop.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/inet_ntop.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/inet_ntop.c	2001-11-28 09:29:41.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/inet_ntop.c	2006-10-17 02:11:24.000000000 +0800
@@ -72,19 +72,20 @@
  */
 static const char *
 inet_ntop4(const unsigned char *src, char *dst, size_t size)
 {
 	static const char *fmt = "%u.%u.%u.%u";
 	char tmp[sizeof "255.255.255.255"];
+	size_t len;
 
-	if ((size_t)sprintf(tmp, fmt, src[0], src[1], src[2], src[3]) >= size)
-	{
+	len = snprintf(tmp, sizeof tmp, fmt, src[0], src[1], src[2], src[3]);
+	if (len >= size) {
 		errno = ENOSPC;
 		return (NULL);
 	}
-	strcpy(dst, tmp);
+	memcpy(dst, tmp, len + 1);
 
 	return (dst);
 }
 
 /* const char *
  * isc_inet_ntop6(src, dst, size)
@@ -103,13 +104,13 @@
 	 * Keep this in mind if you think this function should have been coded
 	 * to use pointer overlays.  All the world's not a VAX.
 	 */
 	char tmp[sizeof "ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"], *tp;
 	struct { int base, len; } best, cur;
 	unsigned int words[NS_IN6ADDRSZ / NS_INT16SZ];
-	int i;
+	int i, inc;
 
 	/*
 	 * Preprocess:
 	 *	Copy the input (bytewise) array into a wordwise array.
 	 *	Find the longest run of 0x00's in src[] for :: shorthanding.
 	 */
@@ -154,19 +155,20 @@
 		/* Are we following an initial run of 0x00s or any real hex? */
 		if (i != 0)
 			*tp++ = ':';
 		/* Is this address an encapsulated IPv4? */
 		if (i == 6 && best.base == 0 &&
 		    (best.len == 6 || (best.len == 5 && words[5] == 0xffff))) {
-			if (!inet_ntop4(src+12, tp,
-					sizeof tmp - (tp - tmp)))
+			if (!inet_ntop4(src+12, tp, sizeof tmp - (tp - tmp)))
 				return (NULL);
 			tp += strlen(tp);
 			break;
 		}
-		tp += sprintf(tp, "%x", words[i]);
+		inc = snprintf(tp, 5, "%x", words[i]);
+		assert(inc < 5);
+		tp += inc;
 	}
 	/* Was it a trailing run of 0x00's? */
 	if (best.base != -1 && (best.base + best.len) ==
 	    (NS_IN6ADDRSZ / NS_INT16SZ))
 		*tp++ = ':';
 	*tp++ = '\0';
@@ -175,10 +177,10 @@
 	 * Check for overflow, copy, and we're done.
 	 */
 	if ((size_t)(tp - tmp) > size) {
 		errno = ENOSPC;
 		return (NULL);
 	}
-	strcpy(dst, tmp);
+	memcpy(dst, tmp, tp - tmp);
 	return (dst);
 }
 #endif /* AF_INET6 */
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/mdfour.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/mdfour.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/mdfour.c	2005-01-11 04:52:08.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/mdfour.c	2006-04-26 07:51:16.000000000 +0800
@@ -1,33 +1,34 @@
 /* 
-   Unix SMB/Netbios implementation.
-   Version 1.9.
-   a implementation of MD4 designed for use in the SMB authentication protocol
-   Copyright (C) Andrew Tridgell 1997-1998.
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Unix SMB/Netbios implementation.
+ * Version 1.9.
+ * An implementation of MD4 designed for use in the SMB authentication protocol.
+ *
+ * Copyright (C) 1997-1998 Andrew Tridgell
+ * Copyright (C) 2005 Wayne Davison
+ * 
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 /* NOTE: This code makes no attempt to be fast! 
-
-   It assumes that a int is at least 32 bits long
-*/
+ *
+ * It assumes that a int is at least 32 bits long. */
 
 static struct mdfour *m;
 
 #define MASK32 (0xffffffff)
 
 #define F(X,Y,Z) ((((X)&(Y)) | ((~(X))&(Z))))
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/mdfour.h /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/mdfour.h
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/mdfour.h	2003-04-10 09:50:12.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/mdfour.h	2006-04-26 07:51:16.000000000 +0800
@@ -1,26 +1,27 @@
 /* 
-   Unix SMB/Netbios implementation.
-   Version 1.9.
-   a implementation of MD4 designed for use in the SMB authentication protocol
-   Copyright (C) Andrew Tridgell 1997-1998.
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Unix SMB/Netbios implementation.
+ * Version 1.9.
+ * An implementation of MD4 designed for use in the SMB authentication protocol.
+ *
+ * Copyright (C) 1997-1998 Andrew Tridgell
+ * 
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 struct mdfour {
 	uint32 A, B, C, D;
 	uint32 totalN;          /* bit count, lower 32 bits */
 	uint32 totalN2;         /* bit count, upper 32 bits */
 };
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/permstring.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/permstring.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/permstring.c	2006-01-30 08:39:59.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/permstring.c	2006-10-14 07:17:34.000000000 +0800
@@ -1,62 +1,66 @@
-/* 
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2001 by Martin Pool <mbp@samba.org>
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * A single utility routine.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
-/**
- * Produce a string representation of Unix mode bits like that used by
- * ls(1).
- *
- * @param buf buffer of at least 11 characters
- **/
+/* Produce a string representation of Unix mode bits like that used by ls(1).
+ * The "buf" buffer must be at least 11 characters. */
 void permstring(char *perms, mode_t mode)
 {
 	static const char *perm_map = "rwxrwxrwx";
 	int i;
 
-	strcpy(perms, "----------");
-	
-	for (i=0;i<9;i++) {
-		if (mode & (1<<i)) perms[9-i] = perm_map[8-i];
+	strlcpy(perms, "----------", 11);
+
+	for (i = 0; i < 9; i++) {
+		if (mode & (1 << i))
+			perms[9-i] = perm_map[8-i];
 	}
 
 	/* Handle setuid/sticky bits.  You might think the indices are
 	 * off by one, but remember there's a type char at the
 	 * start.  */
 	if (mode & S_ISUID)
 		perms[3] = (mode & S_IXUSR) ? 's' : 'S';
 
 	if (mode & S_ISGID)
 		perms[6] = (mode & S_IXGRP) ? 's' : 'S';
-	
+
 #ifdef S_ISVTX
 	if (mode & S_ISVTX)
 		perms[9] = (mode & S_IXOTH) ? 't' : 'T';
 #endif
-		
-	if (S_ISLNK(mode)) perms[0] = 'l';
-	if (S_ISDIR(mode)) perms[0] = 'd';
-	if (S_ISBLK(mode)) perms[0] = 'b';
-	if (S_ISCHR(mode)) perms[0] = 'c';
-	if (S_ISSOCK(mode)) perms[0] = 's';
-	if (S_ISFIFO(mode)) perms[0] = 'p';
-}
 
-	
+	if (S_ISDIR(mode))
+		perms[0] = 'd';
+	else if (S_ISLNK(mode))
+		perms[0] = 'l';
+	else if (S_ISBLK(mode))
+		perms[0] = 'b';
+	else if (S_ISCHR(mode))
+		perms[0] = 'c';
+	else if (S_ISSOCK(mode))
+		perms[0] = 's';
+	else if (S_ISFIFO(mode))
+		perms[0] = 'p';
+}
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/pool_alloc.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/pool_alloc.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/lib/pool_alloc.c	2005-11-15 05:24:30.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/lib/pool_alloc.c	2006-10-14 07:17:34.000000000 +0800
@@ -269,12 +269,12 @@
 		return;
 
 	write(fd, "\n", 1);
 
 	if (pool->live)
 		FDEXTSTAT(pool->live);
-	strcpy(buf, "   FREE    BOUND\n");
+	strlcpy(buf, "   FREE    BOUND\n", sizeof buf);
 	write(fd, buf, strlen(buf));
 
 	for (cur = pool->free; cur; cur = cur->next)
 		FDEXTSTAT(cur);
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/loadparm.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/loadparm.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/loadparm.c	2006-04-06 15:28:22.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/loadparm.c	2006-10-13 14:49:44.000000000 +0800
@@ -1,29 +1,29 @@
 /* This is based on loadparm.c from Samba, written by Andrew Tridgell
    and Karl Auer */
 
-/* some fixes
+/*
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
  *
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/*
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/* some fixes
+ *
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ */
 
 /*
  *  Load parameters.
  *
  *  This module provides suitable callback functions for the params
  *  module. It builds the internal table of service details which is
@@ -54,12 +54,16 @@
 #define PTR_DIFF(p1,p2) ((ptrdiff_t)(((char *)(p1)) - (char *)(p2)))
 #define strequal(a,b) (strcasecmp(a,b)==0)
 #define BOOLSTR(b) ((b) ? "Yes" : "No")
 typedef char pstring[1024];
 #define pstrcpy(a,b) strlcpy(a,b,sizeof(pstring))
 
+#ifndef LOG_DAEMON
+#define LOG_DAEMON 0
+#endif
+
 /* the following are used by loadparm for option lists */
 typedef enum
 {
 	P_BOOL,P_BOOLREV,P_CHAR,P_INTEGER,P_OCTAL,
 	P_PATH,P_STRING,P_GSTRING,P_ENUM,P_SEP
 } parm_type;
@@ -96,19 +100,17 @@
 /*
  * This structure describes global (ie., server-wide) parameters.
  */
 typedef struct
 {
 	char *bind_address;
-	char *log_file;
 	char *motd_file;
 	char *pid_file;
 	char *socket_options;
 
 	int rsync_port;
-	int syslog_facility;
 } global;
 
 static global Globals;
 
 
 /*
@@ -128,12 +130,13 @@
 	char *hosts_allow;
 	char *hosts_deny;
 	char *include;
 	char *include_from;
 	char *incoming_chmod;
 	char *lock_file;
+	char *log_file;
 	char *log_format;
 	char *name;
 	char *outgoing_chmod;
 	char *path;
 	char *postxfer_exec;
 	char *prexfer_exec;
@@ -141,12 +144,13 @@
 	char *secrets_file;
 	char *temp_dir;
 	char *uid;
 
 	int max_connections;
 	int max_verbosity;
+	int syslog_facility;
 	int timeout;
 
 	BOOL ignore_errors;
 	BOOL ignore_nonreadable;
 	BOOL list;
 	BOOL read_only;
@@ -173,12 +177,13 @@
  /* hosts_allow; */		NULL,
  /* hosts_deny; */		NULL,
  /* include; */			NULL,
  /* include_from; */		NULL,
  /* incoming_chmod; */		NULL,
  /* lock_file; */		DEFAULT_LOCK_FILE,
+ /* log_file; */		NULL,
  /* log_format; */		"%o %h [%a] %m (%u) %f %l",
  /* name; */			NULL,
  /* outgoing_chmod; */		NULL,
  /* path; */			NULL,
  /* postxfer_exec; */		NULL,
  /* prexfer_exec; */		NULL,
@@ -186,12 +191,13 @@
  /* secrets_file; */		NULL,
  /* temp_dir; */ 		NULL,
  /* uid; */			NOBODY_USER,
 
  /* max_connections; */		0,
  /* max_verbosity; */		1,
+ /* syslog_facility; */		LOG_DAEMON,
  /* timeout; */			0,
 
  /* ignore_errors; */		False,
  /* ignore_nonreadable; */	False,
  /* list; */			True,
  /* read_only; */		True,
@@ -279,18 +285,16 @@
 
 
 /* note that we do not initialise the defaults union - it is not allowed in ANSI C */
 static struct parm_struct parm_table[] =
 {
  {"address",           P_STRING, P_GLOBAL,&Globals.bind_address,       NULL,0},
- {"log file",          P_STRING, P_GLOBAL,&Globals.log_file,           NULL,0},
  {"motd file",         P_STRING, P_GLOBAL,&Globals.motd_file,          NULL,0},
  {"pid file",          P_STRING, P_GLOBAL,&Globals.pid_file,           NULL,0},
  {"port",              P_INTEGER,P_GLOBAL,&Globals.rsync_port,         NULL,0},
  {"socket options",    P_STRING, P_GLOBAL,&Globals.socket_options,     NULL,0},
- {"syslog facility",   P_ENUM,   P_GLOBAL,&Globals.syslog_facility,enum_facilities,0},
 
  {"auth users",        P_STRING, P_LOCAL, &sDefault.auth_users,        NULL,0},
  {"comment",           P_STRING, P_LOCAL, &sDefault.comment,           NULL,0},
  {"dont compress",     P_STRING, P_LOCAL, &sDefault.dont_compress,     NULL,0},
  {"exclude from",      P_STRING, P_LOCAL, &sDefault.exclude_from,      NULL,0},
  {"exclude",           P_STRING, P_LOCAL, &sDefault.exclude,           NULL,0},
@@ -302,12 +306,13 @@
  {"ignore nonreadable",P_BOOL,   P_LOCAL, &sDefault.ignore_nonreadable,NULL,0},
  {"include from",      P_STRING, P_LOCAL, &sDefault.include_from,      NULL,0},
  {"include",           P_STRING, P_LOCAL, &sDefault.include,           NULL,0},
  {"incoming chmod",    P_STRING, P_LOCAL, &sDefault.incoming_chmod,    NULL,0},
  {"list",              P_BOOL,   P_LOCAL, &sDefault.list,              NULL,0},
  {"lock file",         P_STRING, P_LOCAL, &sDefault.lock_file,         NULL,0},
+ {"log file",          P_STRING, P_LOCAL, &sDefault.log_file,          NULL,0},
  {"log format",        P_STRING, P_LOCAL, &sDefault.log_format,        NULL,0},
  {"max connections",   P_INTEGER,P_LOCAL, &sDefault.max_connections,   NULL,0},
  {"max verbosity",     P_INTEGER,P_LOCAL, &sDefault.max_verbosity,     NULL,0},
  {"name",              P_STRING, P_LOCAL, &sDefault.name,              NULL,0},
  {"outgoing chmod",    P_STRING, P_LOCAL, &sDefault.outgoing_chmod,    NULL,0},
  {"path",              P_PATH,   P_LOCAL, &sDefault.path,              NULL,0},
@@ -316,35 +321,33 @@
  {"pre-xfer exec",     P_STRING, P_LOCAL, &sDefault.prexfer_exec,      NULL,0},
 #endif
  {"read only",         P_BOOL,   P_LOCAL, &sDefault.read_only,         NULL,0},
  {"refuse options",    P_STRING, P_LOCAL, &sDefault.refuse_options,    NULL,0},
  {"secrets file",      P_STRING, P_LOCAL, &sDefault.secrets_file,      NULL,0},
  {"strict modes",      P_BOOL,   P_LOCAL, &sDefault.strict_modes,      NULL,0},
+ {"syslog facility",   P_ENUM,   P_LOCAL, &sDefault.syslog_facility,enum_facilities,0},
  {"temp dir",          P_PATH,   P_LOCAL, &sDefault.temp_dir,          NULL,0},
  {"timeout",           P_INTEGER,P_LOCAL, &sDefault.timeout,           NULL,0},
  {"transfer logging",  P_BOOL,   P_LOCAL, &sDefault.transfer_logging,  NULL,0},
  {"uid",               P_STRING, P_LOCAL, &sDefault.uid,               NULL,0},
  {"use chroot",        P_BOOL,   P_LOCAL, &sDefault.use_chroot,        NULL,0},
  {"write only",        P_BOOL,   P_LOCAL, &sDefault.write_only,        NULL,0},
  {NULL,                P_BOOL,   P_NONE,  NULL,                        NULL,0}
 };
 
 
 /***************************************************************************
-Initialise the global parameter structure.
+* Initialise the global parameter structure.
 ***************************************************************************/
 static void init_globals(void)
 {
 	memset(&Globals, 0, sizeof Globals);
-#ifdef LOG_DAEMON
-	Globals.syslog_facility = LOG_DAEMON;
-#endif
 }
 
 /***************************************************************************
-Initialise the sDefault parameter structure.
+* Initialise the sDefault parameter structure.
 ***************************************************************************/
 static void init_locals(void)
 {
 }
 
 
@@ -370,19 +373,17 @@
  char fn_name(int i) {return(LP_SNUM_OK(i)? pSERVICE(i)->val : sDefault.val);}
 #define FN_LOCAL_INTEGER(fn_name,val) \
  int fn_name(int i) {return(LP_SNUM_OK(i)? pSERVICE(i)->val : sDefault.val);}
 
 
 FN_GLOBAL_STRING(lp_bind_address, &Globals.bind_address)
-FN_GLOBAL_STRING(lp_log_file, &Globals.log_file)
 FN_GLOBAL_STRING(lp_motd_file, &Globals.motd_file)
 FN_GLOBAL_STRING(lp_pid_file, &Globals.pid_file)
 FN_GLOBAL_STRING(lp_socket_options, &Globals.socket_options)
 
 FN_GLOBAL_INTEGER(lp_rsync_port, &Globals.rsync_port)
-FN_GLOBAL_INTEGER(lp_syslog_facility, &Globals.syslog_facility)
 
 FN_LOCAL_STRING(lp_auth_users, auth_users)
 FN_LOCAL_STRING(lp_comment, comment)
 FN_LOCAL_STRING(lp_dont_compress, dont_compress)
 FN_LOCAL_STRING(lp_exclude, exclude)
 FN_LOCAL_STRING(lp_exclude_from, exclude_from)
@@ -391,20 +392,22 @@
 FN_LOCAL_STRING(lp_hosts_allow, hosts_allow)
 FN_LOCAL_STRING(lp_hosts_deny, hosts_deny)
 FN_LOCAL_STRING(lp_include, include)
 FN_LOCAL_STRING(lp_include_from, include_from)
 FN_LOCAL_STRING(lp_incoming_chmod, incoming_chmod)
 FN_LOCAL_STRING(lp_lock_file, lock_file)
+FN_LOCAL_STRING(lp_log_file, log_file)
 FN_LOCAL_STRING(lp_log_format, log_format)
 FN_LOCAL_STRING(lp_name, name)
 FN_LOCAL_STRING(lp_outgoing_chmod, outgoing_chmod)
 FN_LOCAL_STRING(lp_path, path)
 FN_LOCAL_STRING(lp_postxfer_exec, postxfer_exec)
 FN_LOCAL_STRING(lp_prexfer_exec, prexfer_exec)
 FN_LOCAL_STRING(lp_refuse_options, refuse_options)
 FN_LOCAL_STRING(lp_secrets_file, secrets_file)
+FN_LOCAL_INTEGER(lp_syslog_facility, syslog_facility)
 FN_LOCAL_STRING(lp_temp_dir, temp_dir)
 FN_LOCAL_STRING(lp_uid, uid)
 
 FN_LOCAL_INTEGER(lp_max_connections, max_connections)
 FN_LOCAL_INTEGER(lp_max_verbosity, max_verbosity)
 FN_LOCAL_INTEGER(lp_timeout, timeout)
@@ -426,13 +429,13 @@
 static void   copy_service(service *pserviceDest, service *pserviceSource);
 static BOOL   do_parameter(char *parmname, char *parmvalue);
 static BOOL   do_section(char *sectionname);
 
 
 /***************************************************************************
-initialise a service to the defaults
+* initialise a service to the defaults
 ***************************************************************************/
 static void init_service(service *pservice)
 {
 	memset((char *)pservice,0,sizeof(service));
 	copy_service(pservice,&sDefault);
 }
@@ -460,14 +463,14 @@
 	if (!*s)
 		exit_cleanup(RERR_MALLOC);
 }
 
 
 /***************************************************************************
-add a new service to the services array initialising it with the given
-service
+* add a new service to the services array initialising it with the given
+* service
 ***************************************************************************/
 static int add_a_service(service *pservice, char *name)
 {
   int i;
   service tservice;
   int num_to_alloc = iNumServices+1;
@@ -500,13 +503,13 @@
     string_set(&iSERVICE(i).name,name);
 
   return(i);
 }
 
 /***************************************************************************
-Do a case-insensitive, whitespace-ignoring string compare.
+* Do a case-insensitive, whitespace-ignoring string compare.
 ***************************************************************************/
 static int strwicmp(char *psz1, char *psz2)
 {
    /* if BOTH strings are NULL, return TRUE, if ONE is NULL return */
    /* appropriate value. */
    if (psz1 == psz2)
@@ -532,14 +535,14 @@
       psz2++;
    }
    return (*psz1 - *psz2);
 }
 
 /***************************************************************************
-Map a parameter's string representation to something we can use.
-Returns False if the parameter string is not recognised, else TRUE.
+* Map a parameter's string representation to something we can use.
+* Returns False if the parameter string is not recognised, else TRUE.
 ***************************************************************************/
 static int map_parameter(char *parmname)
 {
    int iIndex;
 
    if (*parmname == '-')
@@ -552,15 +555,15 @@
    rprintf(FERROR, "Unknown Parameter encountered: \"%s\"\n", parmname);
    return(-1);
 }
 
 
 /***************************************************************************
-Set a boolean variable from the text value stored in the passed string.
-Returns True in success, False if the passed string does not correctly
-represent a boolean.
+* Set a boolean variable from the text value stored in the passed string.
+* Returns True in success, False if the passed string does not correctly
+* represent a boolean.
 ***************************************************************************/
 static BOOL set_boolean(BOOL *pb, char *parmvalue)
 {
    BOOL bRetval;
 
    bRetval = True;
@@ -580,13 +583,13 @@
          bRetval = False;
       }
    return (bRetval);
 }
 
 /***************************************************************************
-Find a service by name. Otherwise works like get_service.
+* Find a service by name. Otherwise works like get_service.
 ***************************************************************************/
 static int getservicebyname(char *name, service *pserviceDest)
 {
    int iService;
 
    for (iService = iNumServices - 1; iService >= 0; iService--)
@@ -600,14 +603,13 @@
    return (iService);
 }
 
 
 
 /***************************************************************************
-Copy a service structure to another
-
+* Copy a service structure to another
 ***************************************************************************/
 static void copy_service(service *pserviceDest,
                          service *pserviceSource)
 {
   int i;
 
@@ -646,14 +648,14 @@
 	  }
       }
 }
 
 
 /***************************************************************************
-Process a parameter for a particular service number. If snum < 0
-then assume we are in the globals
+* Process a parameter for a particular service number. If snum < 0
+* then assume we are in the globals
 ***************************************************************************/
 static BOOL lp_do_parameter(int snum, char *parmname, char *parmvalue)
 {
    int parmnum, i;
    void *parm_ptr=NULL; /* where we are going to store the result */
    void *def_ptr=NULL;
@@ -738,23 +740,23 @@
      }
 
    return(True);
 }
 
 /***************************************************************************
-Process a parameter.
+* Process a parameter.
 ***************************************************************************/
 static BOOL do_parameter(char *parmname, char *parmvalue)
 {
    return lp_do_parameter(bInGlobalSection?-2:iServiceIndex, parmname, parmvalue);
 }
 
 /***************************************************************************
-Process a new section (service). At this stage all sections are services.
-Later we'll have special sections that permit server parameters to be set.
-Returns True on success, False on failure.
+* Process a new section (service). At this stage all sections are services.
+* Later we'll have special sections that permit server parameters to be set.
+* Returns True on success, False on failure.
 ***************************************************************************/
 static BOOL do_section(char *sectionname)
 {
    BOOL bRetval;
    BOOL isglobal = (strwicmp(sectionname, GLOBAL_NAME) == 0);
    bRetval = False;
@@ -793,14 +795,14 @@
 
    return (bRetval);
 }
 
 
 /***************************************************************************
-Load the services array from the services file. Return True on success,
-False on failure.
+* Load the services array from the services file. Return True on success,
+* False on failure.
 ***************************************************************************/
 BOOL lp_load(char *pszFname, int globals_only)
 {
 	extern int am_server;
 	extern int am_root;
 	pstring n2;
@@ -825,24 +827,24 @@
 
 	return (bRetval);
 }
 
 
 /***************************************************************************
-return the max number of services
+* return the max number of services
 ***************************************************************************/
 int lp_numservices(void)
 {
   return(iNumServices);
 }
 
 /***************************************************************************
-Return the number of the service with the given name, or -1 if it doesn't
-exist. Note that this is a DIFFERENT ANIMAL from the internal function
-getservicebyname()! This works ONLY if all services have been loaded, and
-does not copy the found service.
+* Return the number of the service with the given name, or -1 if it doesn't
+* exist. Note that this is a DIFFERENT ANIMAL from the internal function
+* getservicebyname()! This works ONLY if all services have been loaded, and
+* does not copy the found service.
 ***************************************************************************/
 int lp_number(char *name)
 {
    int iService;
 
    for (iService = iNumServices - 1; iService >= 0; iService--)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/log.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/log.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/log.c	2006-04-09 00:04:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/log.c	2006-10-15 02:51:21.000000000 +0800
@@ -1,33 +1,28 @@
-/* -*- c-file-style: "linux"; -*-
-
-   Copyright (C) 1998-2001 by Andrew Tridgell <tridge@samba.org>
-   Copyright (C) 2000-2001 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
 /*
-  Logging and utility functions.
-  tridge, May 1998
+ * Logging and utility functions.
+ *
+ * Copyright (C) 1998-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 2000-2001 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
-  Mapping to human-readable messages added by Martin Pool
-  <mbp@samba.org>, Oct 2000.
-  */
 #include "rsync.h"
 #if defined HAVE_ICONV_OPEN && defined HAVE_ICONV_H
 #include <iconv.h>
 #endif
 
 extern int verbose;
@@ -39,26 +34,30 @@
 extern int quiet;
 extern int module_id;
 extern int msg_fd_out;
 extern int allow_8bit_chars;
 extern int protocol_version;
 extern int preserve_times;
-extern int log_format_has_i;
-extern int log_format_has_o_or_i;
-extern int daemon_log_format_has_o_or_i;
+extern int stdout_format_has_i;
+extern int stdout_format_has_o_or_i;
+extern int logfile_format_has_i;
+extern int logfile_format_has_o_or_i;
 extern mode_t orig_umask;
 extern char *auth_user;
-extern char *log_format;
+extern char *stdout_format;
+extern char *logfile_format;
+extern char *logfile_name;
 #if defined HAVE_ICONV_OPEN && defined HAVE_ICONV_H
 extern iconv_t ic_chck;
 #endif
+extern char curr_dir[];
+extern unsigned int module_dirlen;
 
 static int log_initialised;
 static int logfile_was_closed;
-static char *logfname;
-static FILE *logfile;
+static FILE *logfile_fp;
 struct stats stats;
 
 int log_got_error = 0;
 
 struct {
         int code;
@@ -106,16 +104,16 @@
 }
 
 static void logit(int priority, char *buf)
 {
 	if (logfile_was_closed)
 		logfile_reopen();
-	if (logfile) {
-		fprintf(logfile,"%s [%d] %s",
+	if (logfile_fp) {
+		fprintf(logfile_fp, "%s [%d] %s",
 			timestring(time(NULL)), (int)getpid(), buf);
-		fflush(logfile);
+		fflush(logfile_fp);
 	} else {
 		syslog(priority, "%s", buf);
 	}
 }
 
 static void syslog_init()
@@ -129,65 +127,79 @@
 
 #ifdef LOG_NDELAY
 	options |= LOG_NDELAY;
 #endif
 
 #ifdef LOG_DAEMON
-	openlog("rsyncd", options, lp_syslog_facility());
+	openlog("rsyncd", options, lp_syslog_facility(module_id));
 #else
 	openlog("rsyncd", options);
 #endif
 
 #ifndef LOG_NDELAY
 	logit(LOG_INFO, "rsyncd started\n");
 #endif
 }
 
 static void logfile_open(void)
 {
 	mode_t old_umask = umask(022 | orig_umask);
-	logfile = fopen(logfname, "a");
+	logfile_fp = fopen(logfile_name, "a");
 	umask(old_umask);
-	if (!logfile) {
+	if (!logfile_fp) {
 		int fopen_errno = errno;
 		/* Rsync falls back to using syslog on failure. */
 		syslog_init();
 		rsyserr(FERROR, fopen_errno,
-			"failed to open log-file %s", logfname);
+			"failed to open log-file %s", logfile_name);
 		rprintf(FINFO, "Ignoring \"log file\" setting.\n");
 	}
 }
 
-void log_init(void)
+void log_init(int restart)
 {
-	time_t t;
-
-	if (log_initialised)
-		return;
-	log_initialised = 1;
+	if (log_initialised) {
+		if (!restart)
+			return;
+		if (strcmp(logfile_name, lp_log_file(module_id)) != 0) {
+			if (logfile_fp) {
+				fclose(logfile_fp);
+				logfile_fp = NULL;
+			} else
+				closelog();
+			logfile_name = NULL;
+		} else if (*logfile_name)
+			return; /* unchanged, non-empty "log file" names */
+		else if (lp_syslog_facility(-1) != lp_syslog_facility(module_id))
+			closelog();
+		else
+			return; /* unchanged syslog settings */
+	} else
+		log_initialised = 1;
 
-	/* this looks pointless, but it is needed in order for the
+	/* This looks pointless, but it is needed in order for the
 	 * C library on some systems to fetch the timezone info
-	 * before the chroot */
-	t = time(NULL);
-	localtime(&t);
-
-	/* optionally use a log file instead of syslog */
-	logfname = lp_log_file();
-	if (logfname && *logfname)
+	 * before the chroot. */
+	timestring(time(NULL));
+
+	/* Optionally use a log file instead of syslog.  (Non-daemon
+	 * rsyncs will have already set logfile_name, as needed.) */
+	if (am_daemon && !logfile_name)
+		logfile_name = lp_log_file(module_id);
+	if (logfile_name && *logfile_name)
 		logfile_open();
 	else
 		syslog_init();
 }
 
 void logfile_close(void)
 {
-	if (logfile) {
+	if (logfile_fp) {
 		logfile_was_closed = 1;
-		fclose(logfile);
-		logfile = NULL;
+		fclose(logfile_fp);
+		logfile_fp = NULL;
 	}
 }
 
 void logfile_reopen(void)
 {
 	if (logfile_was_closed) {
@@ -226,70 +238,61 @@
 	int trailing_CR_or_NL;
 	FILE *f = NULL;
 
 	if (len < 0)
 		exit_cleanup(RERR_MESSAGEIO);
 
-	if (quiet && code == FINFO)
-		return;
-
 	if (am_server && msg_fd_out >= 0) {
 		/* Pass the message to our sibling. */
 		send_msg((enum msgcode)code, buf, len);
 		return;
 	}
 
 	if (code == FSOCKERR) /* This gets simplified for a non-sibling. */
 		code = FERROR;
 
 	if (code == FCLIENT)
 		code = FINFO;
-	else if (am_daemon) {
+	else if (am_daemon || logfile_name) {
 		static int in_block;
 		char msg[2048];
 		int priority = code == FERROR ? LOG_WARNING : LOG_INFO;
 
 		if (in_block)
 			return;
 		in_block = 1;
 		if (!log_initialised)
-			log_init();
+			log_init(0);
 		strlcpy(msg, buf, MIN((int)sizeof msg, len + 1));
 		logit(priority, msg);
 		in_block = 0;
 
-		if (code == FLOG || !am_server)
+		if (code == FLOG || (am_daemon && !am_server))
 			return;
 	} else if (code == FLOG)
 		return;
 
+	if (quiet && code != FERROR)
+		return;
+
 	if (am_server) {
 		/* Pass the message to the non-server side. */
-		if (io_multiplex_write((enum msgcode)code, buf, len))
+		if (send_msg((enum msgcode)code, buf, len))
 			return;
 		if (am_daemon) {
 			/* TODO: can we send the error to the user somehow? */
 			return;
 		}
 	}
 
 	switch (code) {
 	case FERROR:
 		log_got_error = 1;
 		f = stderr;
-		goto pre_scan;
-	case FINFO:
-		f = am_server ? stderr : stdout;
-	pre_scan:
-		while (len > 1 && *buf == '\n') {
-			fputc(*buf, f);
-			buf++;
-			len--;
-		}
 		break;
-	case FNAME:
+	case FINFO:
 		f = am_server ? stderr : stdout;
 		break;
 	default:
 		exit_cleanup(RERR_MESSAGEIO);
 	}
 
@@ -379,13 +382,13 @@
 void rsyserr(enum logcode code, int errcode, const char *format, ...)
 {
 	va_list ap;
 	char buf[BIGPATHBUFLEN];
 	size_t len;
 
-	strcpy(buf, RSYNC_NAME ": ");
+	strlcpy(buf, RSYNC_NAME ": ", sizeof buf);
 	len = (sizeof RSYNC_NAME ": ") - 1;
 
 	va_start(ap, format);
 	len += vsnprintf(buf + len, sizeof buf - len, format, ap);
 	va_end(ap);
 
@@ -400,37 +403,24 @@
 }
 
 void rflush(enum logcode code)
 {
 	FILE *f = NULL;
 
-	if (am_daemon) {
-		return;
-	}
-
-	if (code == FLOG) {
+	if (am_daemon || code == FLOG)
 		return;
-	}
 
-	if (code == FERROR) {
+	if (code == FERROR || am_server)
 		f = stderr;
-	}
-
-	if (code == FINFO) {
-		if (am_server)
-			f = stderr;
-		else
-			f = stdout;
-	}
+	else
+		f = stdout;
 
-	if (!f) exit_cleanup(RERR_MESSAGEIO);
 	fflush(f);
 }
 
-/* a generic logging routine for send/recv, with parameter
- * substitiution */
+/* A generic logging routine for send/recv, with parameter substitiution. */
 static void log_formatted(enum logcode code, char *format, char *op,
 			  struct file_struct *file, struct stats *initial_stats,
 			  int iflags, char *hlink)
 {
 	char buf[MAXPATHLEN+1024], buf2[MAXPATHLEN], fmt[32];
 	char *p, *s, *n;
@@ -521,12 +511,20 @@
 					 file->dir.root, n);
 				clean_fname(buf2, 0);
 				if (fmt[1])
 					strlcpy(n, buf2, MAXPATHLEN);
 				else
 					n = buf2;
+			} else if (*n != '/') {
+				pathjoin(buf2, sizeof buf2,
+					 curr_dir + module_dirlen, n);
+				clean_fname(buf2, 0);
+				if (fmt[1])
+					strlcpy(n, buf2, MAXPATHLEN);
+				else
+					n = buf2;
 			} else
 				clean_fname(n, 0);
 			if (*n == '/')
 				n++;
 			break;
 		case 'n':
@@ -534,21 +532,21 @@
 			if (S_ISDIR(file->mode))
 				strlcat(n, "/", MAXPATHLEN);
 			break;
 		case 'L':
 			if (hlink && *hlink) {
 				n = hlink;
-				strcpy(buf2, " => ");
+				strlcpy(buf2, " => ", sizeof buf2);
 			} else if (S_ISLNK(file->mode) && file->u.link) {
 				n = file->u.link;
-				strcpy(buf2, " -> ");
+				strlcpy(buf2, " -> ", sizeof buf2);
 			} else {
 				n = "";
 				if (!fmt[1])
 					break;
-				strcpy(buf2, "    ");
+				strlcpy(buf2, "    ", sizeof buf2);
 			}
 			strlcat(fmt, "s", sizeof fmt);
 			snprintf(buf2 + 4, sizeof buf2 - 4, fmt, n);
 			n = buf2;
 			break;
 		case 'm':
@@ -686,67 +684,73 @@
 		if (*p == esc)
 			return 1;
 	}
 	return 0;
 }
 
-/* log the transfer of a file */
-void log_item(struct file_struct *file, struct stats *initial_stats,
-	      int iflags, char *hlink)
+/* Log the transfer of a file.  If the code is FCLIENT, the output just goes
+ * to stdout.  If it is FLOG, it just goes to the log file.  Otherwise we
+ * output to both. */
+void log_item(enum logcode code, struct file_struct *file,
+	      struct stats *initial_stats, int iflags, char *hlink)
 {
 	char *s_or_r = am_sender ? "send" : "recv";
 
-	if (lp_transfer_logging(module_id)) {
-		log_formatted(FLOG, lp_log_format(module_id), s_or_r,
+	if (code != FLOG && stdout_format && !am_server) {
+		log_formatted(FCLIENT, stdout_format, s_or_r,
 			      file, initial_stats, iflags, hlink);
-	} else if (log_format && !am_server) {
-		log_formatted(FNAME, log_format, s_or_r,
+	}
+	if (code != FCLIENT && logfile_format && *logfile_format) {
+		log_formatted(FLOG, logfile_format, s_or_r,
 			      file, initial_stats, iflags, hlink);
 	}
 }
 
 void maybe_log_item(struct file_struct *file, int iflags, int itemizing,
 		    char *buf)
 {
 	int significant_flags = iflags & SIGNIFICANT_ITEM_FLAGS;
 	int see_item = itemizing && (significant_flags || *buf
-		|| log_format_has_i > 1 || (verbose > 1 && log_format_has_i));
+		|| stdout_format_has_i > 1 || (verbose > 1 && stdout_format_has_i));
 	int local_change = iflags & ITEM_LOCAL_CHANGE && significant_flags;
 	if (am_server) {
-		if (am_daemon && !dry_run && see_item)
-			log_item(file, &stats, iflags, buf);
+		if (logfile_name && !dry_run && see_item
+		 && (significant_flags || logfile_format_has_i))
+			log_item(FLOG, file, &stats, iflags, buf);
 	} else if (see_item || local_change || *buf
-	    || (S_ISDIR(file->mode) && significant_flags))
-		log_item(file, &stats, iflags, buf);
+	    || (S_ISDIR(file->mode) && significant_flags)) {
+		enum logcode code = significant_flags || logfile_format_has_i ? FINFO : FCLIENT;
+		log_item(code, file, &stats, iflags, buf);
+	}
 }
 
 void log_delete(char *fname, int mode)
 {
 	static struct file_struct file;
 	int len = strlen(fname);
 	char *fmt;
 
 	file.mode = mode;
 	file.basename = fname;
 
-	if (!verbose && !log_format)
+	if (!verbose && !stdout_format)
 		;
 	else if (am_server && protocol_version >= 29 && len < MAXPATHLEN) {
 		if (S_ISDIR(mode))
 			len++; /* directories include trailing null */
 		send_msg(MSG_DELETED, fname, len);
 	} else {
-		fmt = log_format_has_o_or_i ? log_format : "deleting %n";
+		fmt = stdout_format_has_o_or_i ? stdout_format : "deleting %n";
 		log_formatted(FCLIENT, fmt, "del.", &file, &stats,
 			      ITEM_DELETED, NULL);
 	}
 
-	if (!am_daemon || dry_run || !lp_transfer_logging(module_id))
+	if (!logfile_name || dry_run || !logfile_format)
 		return;
 
-	fmt = daemon_log_format_has_o_or_i ? lp_log_format(module_id) : "deleting %n";
+	fmt = logfile_format_has_o_or_i ? logfile_format : "deleting %n";
 	log_formatted(FLOG, fmt, "del.", &file, &stats, ITEM_DELETED, NULL);
 }
 
 /*
  * Called when the transfer is interrupted for some reason.
  *
@@ -766,13 +770,13 @@
 		name = rerr_name(code);
 		if (!name)
 			name = "unexplained error";
 
 		/* VANISHED is not an error, only a warning */
 		if (code == RERR_VANISHED) {
-			rprintf(FINFO, "rsync warning: %s (code %d) at %s(%d) [%s=%s]\n", 
+			rprintf(FINFO, "rsync warning: %s (code %d) at %s(%d) [%s=%s]\n",
 				name, code, file, line, who_am_i(), RSYNC_VERSION);
 		} else {
 			rprintf(FERROR, "rsync error: %s (code %d) at %s(%d) [%s=%s]\n",
 				name, code, file, line, who_am_i(), RSYNC_VERSION);
 		}
 	}
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/main.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/main.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/main.c	2006-03-02 11:53:42.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/main.c	2006-10-14 07:46:32.000000000 +0800
@@ -1,26 +1,28 @@
-/* -*- c-file-style: "linux" -*-
-
-   Copyright (C) 1996-2001 by Andrew Tridgell <tridge@samba.org>
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * The startup routines, including main(), for rsync.
+ *
+ * Copyright (C) 1996-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 #if defined CONFIG_LOCALE && defined HAVE_LOCALE_H
 #include <locale.h>
 #endif
 
@@ -30,13 +32,13 @@
 extern int am_root;
 extern int am_server;
 extern int am_sender;
 extern int am_generator;
 extern int am_daemon;
 extern int blocking_io;
-extern int remove_sent_files;
+extern int remove_source_files;
 extern int daemon_over_rsh;
 extern int need_messages_from_generator;
 extern int kluge_around_eof;
 extern int do_stats;
 extern int log_got_error;
 extern int module_id;
@@ -44,27 +46,36 @@
 extern int copy_dirlinks;
 extern int keep_dirlinks;
 extern int preserve_hard_links;
 extern int protocol_version;
 extern int recurse;
 extern int relative_paths;
+extern int sanitize_paths;
+extern int curr_dir_depth;
+extern int curr_dir_len;
+extern int module_id;
 extern int rsync_port;
 extern int whole_file;
 extern int read_batch;
 extern int write_batch;
 extern int batch_fd;
 extern int batch_gen_fd;
 extern int filesfrom_fd;
 extern pid_t cleanup_child_pid;
 extern struct stats stats;
 extern char *filesfrom_host;
+extern char *partial_dir;
+extern char *basis_dir[];
 extern char *rsync_path;
 extern char *shell_cmd;
 extern char *batch_name;
+extern char curr_dir[MAXPATHLEN];
+extern struct filter_list_struct server_filter_list;
 
 int local_server = 0;
+int new_root_dir = 0;
 mode_t orig_umask = 0;
 struct file_list *the_file_list;
 
 /* There's probably never more than at most 2 outstanding child processes,
  * but set it higher, just in case. */
 #define MAXCHILDPROCS 7
@@ -165,13 +176,12 @@
 	}
 
 	if (am_generator)
 		return;
 
 	if (am_daemon) {
-		log_exit(0, __FILE__, __LINE__);
 		if (f == -1 || !am_sender)
 			return;
 	}
 
 	if (am_server) {
 		if (am_sender) {
@@ -186,13 +196,13 @@
 		return;
 	}
 
 	/* this is the client */
 
 	if (f < 0 && !am_sender) /* e.g. when we got an empty file list. */
-		; 
+		;
 	else if (!am_sender) {
 		/* Read the first two in opposite order because the meaning of
 		 * read/write swaps when switching from sender to receiver. */
 		total_written = read_longint(f);
 		total_read = read_longint(f);
 		stats.total_size = read_longint(f);
@@ -213,13 +223,14 @@
 	}
 }
 
 static void output_summary(void)
 {
 	if (do_stats) {
-		rprintf(FINFO,"\nNumber of files: %d\n", stats.num_files);
+		rprintf(FCLIENT, "\n");
+		rprintf(FINFO,"Number of files: %d\n", stats.num_files);
 		rprintf(FINFO,"Number of files transferred: %d\n",
 			stats.num_transferred_files);
 		rprintf(FINFO,"Total file size: %s bytes\n",
 			human_num(stats.total_size));
 		rprintf(FINFO,"Total transferred file size: %s bytes\n",
 			human_num(stats.total_transferred_size));
@@ -240,14 +251,15 @@
 			human_num(total_written));
 		rprintf(FINFO,"Total bytes received: %s\n",
 			human_num(total_read));
 	}
 
 	if (verbose || do_stats) {
+		rprintf(FCLIENT, "\n");
 		rprintf(FINFO,
-			"\nsent %s bytes  received %s bytes  %s bytes/sec\n",
+			"sent %s bytes  received %s bytes  %s bytes/sec\n",
 			human_num(total_written), human_num(total_read),
 			human_dnum((total_written + total_read)/(0.5 + (endtime - starttime)), 2));
 		rprintf(FINFO, "total size is %s  speedup is %.2f\n",
 			human_num(stats.total_size),
 			(double)stats.total_size / (total_written+total_read));
 	}
@@ -264,13 +276,14 @@
 {
 #ifdef HAVE_MALLINFO
 	struct mallinfo mi;
 
 	mi = mallinfo();
 
-	rprintf(FINFO, "\n" RSYNC_NAME "[%d] (%s%s%s) heap statistics:\n",
+	rprintf(FCLIENT, "\n");
+	rprintf(FINFO, RSYNC_NAME "[%d] (%s%s%s) heap statistics:\n",
 		getpid(), am_server ? "server " : "",
 		am_daemon ? "daemon " : "", who_am_i());
 	rprintf(FINFO, "  arena:     %10ld   (bytes from sbrk)\n",
 		(long)mi.arena);
 	rprintf(FINFO, "  ordblks:   %10ld   (chunks not in use)\n",
 		(long)mi.ordblks);
@@ -400,14 +413,14 @@
 		args[argc++] = path;
 
 	args[argc] = NULL;
 
 	if (verbose > 3) {
 		for (i = 0; i < argc; i++)
-			rprintf(FINFO, "cmd[%d]=%s ", i, args[i]);
-		rprintf(FINFO, "\n");
+			rprintf(FCLIENT, "cmd[%d]=%s ", i, args[i]);
+		rprintf(FCLIENT, "\n");
 	}
 
 	if (read_batch) {
 		int from_gen_pipe[2];
 		if (fd_pair(from_gen_pipe) < 0) {
 			rsyserr(FERROR, errno, "pipe");
@@ -442,35 +455,35 @@
  * placing them according to their names in the file-list.
  *
  * 2. it receives a single file and saves it using the name in the
  * destination path instead of its file-list name.  This requires a
  * "local name" for writing out the destination file.
  *
- * So, our task is to figure out what mode/local-name we need and return
- * either a NULL for mode 1, or the local-name for mode 2.  We also
- * change directory if there are any path components in dest_path. */
+ * So, our task is to figure out what mode/local-name we need.
+ * For mode 1, we change into the destination directory and return NULL.
+ * For mode 2, we change into the directory containing the destination
+ * file (if we aren't already there) and return the local-name. */
 static char *get_local_name(struct file_list *flist, char *dest_path)
 {
 	STRUCT_STAT st;
+	int statret;
 	char *cp;
 
 	if (verbose > 2) {
 		rprintf(FINFO, "get_local_name count=%d %s\n",
 			flist->count, NS(dest_path));
 	}
 
 	if (!dest_path || list_only)
 		return NULL;
 
-	/* If the destination path refers to an existing directory, enter
-	 * it and use mode 1.  If there is something other than a directory
-	 * at the destination path, we must be transferring one file
-	 * (anything at the destination will be overwritten). */
-	if (do_stat(dest_path, &st) == 0) {
+	/* See what currently exists at the destination. */
+	if ((statret = do_stat(dest_path, &st)) == 0) {
+		/* If the destination is a dir, enter it and use mode 1. */
 		if (S_ISDIR(st.st_mode)) {
-			if (!push_dir(dest_path)) {
+			if (!push_dir(dest_path, 0)) {
 				rsyserr(FERROR, errno, "push_dir#1 %s failed",
 					full_fname(dest_path));
 				exit_cleanup(RERR_FILESELECT);
 			}
 			return NULL;
 		}
@@ -485,44 +498,51 @@
 			rprintf(FERROR,
 				"ERROR: cannot overwrite non-directory"
 				" with a directory\n");
 			exit_cleanup(RERR_FILESELECT);
 		}
 	} else if (errno != ENOENT) {
-		rsyserr(FERROR, errno, "cannot stat destination %s",
+		/* If we don't know what's at the destination, fail. */
+		rsyserr(FERROR, errno, "ERROR: cannot stat destination %s",
 			full_fname(dest_path));
 		exit_cleanup(RERR_FILESELECT);
 	}
 
 	cp = strrchr(dest_path, '/');
 
-	/* If the destination path ends in a slash or we are transferring
-	 * multiple files, create a directory at the destination path,
-	 * enter the new directory, and use mode 1. */
+	/* If we need a destination directory because the transfer is not
+	 * of a single non-directory or the user has requested one via a
+	 * destination path ending in a slash, create one and use mode 1. */
 	if (flist->count > 1 || (cp && !cp[1])) {
 		/* Lop off the final slash (if any). */
 		if (cp && !cp[1])
 			*cp = '\0';
 
+		if (statret == 0) {
+			rprintf(FERROR,
+			    "ERROR: destination path is not a directory\n");
+			exit_cleanup(RERR_SYNTAX);
+		}
+
 		if (mkdir_defmode(dest_path) != 0) {
 			rsyserr(FERROR, errno, "mkdir %s failed",
 				full_fname(dest_path));
 			exit_cleanup(RERR_FILEIO);
 		}
 
+		new_root_dir = 1;
+
 		if (verbose)
 			rprintf(FINFO, "created directory %s\n", dest_path);
 
 		if (dry_run) {
-			/* Indicate that the destination directory doesn't
-			 * really exist and return mode 1. */
+			/* Indicate that dest dir doesn't really exist. */
 			dry_run++;
-			return NULL;
 		}
 
-		if (!push_dir(dest_path)) {
+		if (!push_dir(dest_path, dry_run > 1)) {
 			rsyserr(FERROR, errno, "push_dir#2 %s failed",
 				full_fname(dest_path));
 			exit_cleanup(RERR_FILESELECT);
 		}
 
 		return NULL;
@@ -536,22 +556,54 @@
 		return dest_path;
 
 	if (cp == dest_path)
 		dest_path = "/";
 
 	*cp = '\0';
-	if (!push_dir(dest_path)) {
+	if (!push_dir(dest_path, 0)) {
 		rsyserr(FERROR, errno, "push_dir#3 %s failed",
 			full_fname(dest_path));
 		exit_cleanup(RERR_FILESELECT);
 	}
 	*cp = '/';
 
 	return cp + 1;
 }
 
+/* Call this if the destination dir (which is assumed to be in curr_dir)
+ * does not yet exist and we can't create it due to being in dry-run
+ * mode.  We'll fix dirs that can be relative to the non-existent dir. */
+static void fix_basis_dirs(void)
+{
+	char **dir, *new, *slash;
+	int len;
+
+	if (dry_run <= 1)
+		return;
+
+	slash = strrchr(curr_dir, '/');
+
+	for (dir = basis_dir; *dir; dir++) {
+		if (**dir == '/')
+			continue;
+		len = curr_dir_len + 1 + strlen(*dir) + 1;
+		if (!(new = new_array(char, len)))
+			out_of_memory("fix_basis_dirs");
+		if (slash && strncmp(*dir, "../", 3) == 0) {
+		    /* We want to remove only one leading "../" prefix for
+		     * the directory we couldn't create in dry-run mode:
+		     * this ensures that any other ".." references get
+		     * evaluated the same as they would for a live copy. */
+		    *slash = '\0';
+		    pathjoin(new, len, curr_dir, *dir + 3);
+		    *slash = '/';
+		} else
+		    pathjoin(new, len, curr_dir, *dir);
+		*dir = new;
+	}
+}
 
 /* This is only called by the sender. */
 static void read_final_goodbye(int f_in, int f_out)
 {
 	int i;
 
@@ -586,23 +638,26 @@
 
 	if (am_daemon && lp_write_only(module_id)) {
 		rprintf(FERROR, "ERROR: module is write only\n");
 		exit_cleanup(RERR_SYNTAX);
 		return;
 	}
-	if (am_daemon && lp_read_only(module_id) && remove_sent_files) {
+	if (am_daemon && lp_read_only(module_id) && remove_source_files) {
 		rprintf(FERROR,
-		    "ERROR: --remove-sent-files cannot be used with a read-only module\n");
+		    "ERROR: --remove-%s-files cannot be used with a read-only module\n",
+		    remove_source_files == 1 ? "source" : "sent");
 		exit_cleanup(RERR_SYNTAX);
 		return;
 	}
 
-	if (!relative_paths && !push_dir(dir)) {
-		rsyserr(FERROR, errno, "push_dir#3 %s failed",
-			full_fname(dir));
-		exit_cleanup(RERR_FILESELECT);
+	if (!relative_paths) {
+		if (!push_dir(dir, 0)) {
+			rsyserr(FERROR, errno, "push_dir#3 %s failed",
+				full_fname(dir));
+			exit_cleanup(RERR_FILESELECT);
+		}
 	}
 	argc--;
 	argv++;
 
 	if (argc == 0 && (recurse || list_only)) {
 		argc = 1;
@@ -749,13 +804,13 @@
 	}
 
 	if (argc > 0) {
 		dir = argv[0];
 		argc--;
 		argv++;
-		if (!am_daemon && !push_dir(dir)) {
+		if (!am_daemon && !push_dir(dir, 0)) {
 			rsyserr(FERROR, errno, "push_dir#4 %s failed",
 				full_fname(dir));
 			exit_cleanup(RERR_FILESELECT);
 		}
 	}
 
@@ -780,12 +835,42 @@
 	}
 	the_file_list = flist;
 
 	if (argc > 0)
 		local_name = get_local_name(flist,argv[0]);
 
+	/* Now that we know what our destination directory turned out to be,
+	 * we can sanitize the --link-/copy-/compare-dest args correctly. */
+	if (sanitize_paths) {
+		char **dir;
+		for (dir = basis_dir; *dir; dir++) {
+			*dir = sanitize_path(NULL, *dir, NULL, curr_dir_depth, NULL);
+		}
+		if (partial_dir) {
+			partial_dir = sanitize_path(NULL, partial_dir, NULL, curr_dir_depth, NULL);
+		}
+	}
+	fix_basis_dirs();
+
+	if (server_filter_list.head) {
+		char **dir;
+		struct filter_list_struct *elp = &server_filter_list;
+
+		for (dir = basis_dir; *dir; dir++) {
+			if (check_filter(elp, *dir, 1) < 0)
+				goto options_rejected;
+		}
+		if (partial_dir && *partial_dir == '/'
+		 && check_filter(elp, partial_dir, 1) < 0) {
+		    options_rejected:
+			rprintf(FERROR,
+				"Your options have been rejected by the server.\n");
+			exit_cleanup(RERR_SYNTAX);
+		}
+	}
+
 	exit_code = do_recv(f_in,f_out,flist,local_name);
 	exit_cleanup(exit_code);
 }
 
 
 int child_main(int argc, char *argv[])
@@ -910,12 +995,14 @@
 	flist = recv_file_list(f_in);
 	the_file_list = flist;
 
 	if (flist && flist->count > 0) {
 		local_name = get_local_name(flist, argv[0]);
 
+		fix_basis_dirs();
+
 		exit_code2 = do_recv(f_in, f_out, flist, local_name);
 	} else {
 		handle_stats(-1);
 		output_summary();
 	}
 
@@ -1168,14 +1255,14 @@
  **/
 static RETSIGTYPE rsync_panic_handler(UNUSED(int whatsig))
 {
 	char cmd_buf[300];
 	int ret;
 
-	sprintf(cmd_buf, get_panic_action(),
-		getpid(), getpid());
+	snprintf(cmd_buf, sizeof cmd_buf, get_panic_action(),
+		 getpid(), getpid());
 
 	/* Unless we failed to execute gdb, we allow the process to
 	 * continue.  I'm not sure if that's right. */
 	ret = system(cmd_buf);
 	if (ret)
 		_exit(ret);
@@ -1246,13 +1333,13 @@
 #endif
 
 	/* Initialize push_dir here because on some old systems getcwd
 	 * (implemented by forking "pwd" and reading its output) doesn't
 	 * work when there are other child processes.  Also, on all systems
 	 * that implement getcwd that way "pwd" can't be found after chroot. */
-	push_dir(NULL);
+	push_dir(NULL, 0);
 
 	init_flist();
 
 	if ((write_batch || read_batch) && !am_server) {
 		if (write_batch)
 			write_batch_shell_file(orig_argc, orig_argv, argc);
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/Makefile.in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/Makefile.in
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/Makefile.in	2006-04-18 01:37:13.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/Makefile.in	2006-10-24 23:09:57.000000000 +0800
@@ -1,10 +1,11 @@
 # Makefile for rsync. This is processed by configure to produce the final
 # Makefile
 
 prefix=@prefix@
+datarootdir=@datarootdir@
 exec_prefix=@exec_prefix@
 bindir=@bindir@
 mandir=@mandir@
 
 LIBS=@LIBS@
 CC=@CC@
@@ -139,13 +140,13 @@
 
 # We try to run the scripts with POSIX mode on, in the hope that will
 # catch Bash-isms earlier even if we're running on GNU.  Of course, we
 # might lose in the future where POSIX diverges from old sh.
 
 check: all $(CHECK_PROGS)
-	POSIXLY_CORRECT=1 TOOLDIR=`pwd` rsync_bin=`pwd`/rsync$(EXEEXT) srcdir="$(srcdir)" $(srcdir)/runtests.sh
+	rsync_bin=`pwd`/rsync$(EXEEXT) $(srcdir)/runtests.sh
 
 wildtest.o: wildtest.c lib/wildmatch.c rsync.h
 wildtest$(EXEEXT): wildtest.o lib/compat.o
 	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ wildtest.o lib/compat.o @BUILD_POPT@ $(LIBS)
 
 # This does *not* depend on building or installing: you can use it to
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/match.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/match.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/match.c	2006-03-01 05:48:15.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/match.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,24 +1,27 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Block matching used by the file-transfer code.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int do_progress;
 extern int checksum_seed;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/mkproto.awk /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/mkproto.awk
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/mkproto.awk	2006-02-02 10:29:30.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/mkproto.awk	2006-10-13 14:50:56.000000000 +0800
@@ -51,21 +51,20 @@
 
 /^FN_GLOBAL_INT/ {
   split($0,a,"[,()]")
   printf "int %s(void);\n", a[2]
 }
 
-/^static|^extern/ || !/^[a-zA-Z]/ || /[;]/ {
+/^static|^extern/ || /[;]/ {
   next;
 }
 
-!/^OFF_T|^size_t|^off_t|^pid_t|^unsigned|^mode_t|^DIR|^user|^int|^char|^uint|^uchar|^short|^struct|^BOOL|^void|^time|^const|^RETSIGTYPE/ {
+!/^[A-Za-z][A-Za-z0-9_]* / {
   next;
 }
 
-
 /[(].*[)][ \t]*$/ {
     printf "%s;\n",$0;
     next;
 }
 
 /[(]/ {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/NEWS /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/NEWS
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/NEWS	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/NEWS	2006-11-07 12:39:47.000000000 +0800
@@ -1,67 +1,158 @@
-NEWS for rsync 2.6.8 (22 Apr 2006)
+NEWS for rsync 2.6.9 (6 Nov 2006)
 Protocol: 29 (unchanged)
-Changes since 2.6.7:
+Changes since 2.6.8:
 
   BUG FIXES:
 
-    - Fixed a bug in the exclude code where an anchored exclude without any
-      wildcards fails to match an absolute source arg, but only when --relative
-      is in effect.
-
-    - Improved the I/O code for the generator to fix a potential hang when the
-      receiver gets an EOF on the socket but the generator's select() call
-      never indicates that the socket is writable for it to be notified about
-      the EOF.  (This can happen when using stunnel).
-
-    - Fixed a problem with the file-reading code where a failed read (such as
-      that caused by a bad sector) would not advance the file's read-position
-      beyond the failed read's data.
-
-    - Fixed a logging bug where the "log file" directive was not being honored
-      in a single-use daemon (one spawned by a remote-shell connection or by
-      init).
-
-    - If rsync cannot honor the --delete option, we output an error and exit
-      instead of silently ignoring the option.
-
-    - Fixed a bug in the --link-dest code that prevented special files (such as
-      fifos) from being linked.
-
-    - The ability to hard-link symlinks and special files is now determined at
-      configure time instead of at runtime.  This fixes a bug with --link-dest
-      creating a hard-link to a symlink's referent on a BSD system.
+    - If rsync is interrupted via a handled signal (such as SIGINT), it will
+      once again clean-up its temp file from the destination dir.
 
-  ENHANCEMENTS:
-
-    - In daemon mode, if rsync fails to bind to the requested port, the
-      error(s) returned by socket() and/or bind() are now logged.
-
-    - When we output a fatal error, we now output the version of rsync in the
-      message.
+    - Fixed an overzealous sanitizing bug in the handling of the --link-dest,
+      --copy-dest, and --compare-dest options to a daemon without chroot: if
+      the copy's destination dir is deeper than the top of the module's path,
+      these options now accept a safe number of parent-dir (../) references
+      (since these options are relative to the destination dir).  The old code
+      incorrectly chopped off all "../" prefixes for these options, no matter
+      how deep the destination directory was in the module's hierarchy.
+
+    - Fixed a bug where a deferred info/error/log message could get sent
+      directly to the sender instead of being handled by rwrite() in the
+      generator.  This fixes an "unexpected tag 3" fatal error, and should
+      also fix a potential problem where a deferred info/error message from
+      the receiver might bypass the log file and get sent only to the client
+      process.  (These problems could only affect an rsync daemon that was
+      receiving files.)
+
+    - Fixed a bug when --inplace was combined with a --*-dest option and we
+      update a file's data using an alternate basis file.  The code now
+      notices that it needs to copy the matching data from the basis file
+      instead of (wrongly) assuming that it was already present in the file.
+
+    - Fixed a bug where using --dry-run with a --*-dest option with a path
+      relative to a directory that does not yet exist:  the affected option
+      gets its proper path value so that the output of the dry-run is right.
+
+    - Fixed a bug in the %f logfile escape when receiving files: the
+      destination path is now included in the output (e.g. you can now tell
+      when a user specifies a subdir inside a module).
+
+    - If the receiving side fails to create a directory, it will now skip
+      trying to update everything that is inside that directory.
+
+    - If --link-dest is specified with --checksum but without --times, rsync
+      will now allow a hard-link to be created to a matching link-dest file
+      even when the file's modify-time doesn't match the server's file.
+
+    - The daemon now calls more timezone-using functions prior to doing a
+      chroot.  This should help some C libraries to generate proper timestamps
+      from inside a chrooted daemon (and to not try to access /etc/timezone
+      over and over again).
+
+    - Fixed a bug in the handling of an absolute --partial-dir=ABS_PATH option:
+      it now deletes an alternate basis file from the partial-dir that was used
+      to successfully update a destination file.
+
+    - Fixed a bug in the handling of --delete-excluded when using a per-dir
+      merge file:  the merge file is now honored on the receiving side, and
+      only its unqualified include/exclude commands are ignored (just as is
+      done for global include/excludes).
+
+    - Fixed a recent bug where --delete was not working when transferring from
+      the root (/) of the filesystem with --relative enabled.
+
+    - Fixed a recent bug where an --exclude='*' could affect the root (/) of
+      the filesystem with --relative enabled.
+
+    - When --inplace creates a file, it is now created with owner read/write
+      permissions (0600) instead of no permissions at all.  This avoids a
+      problem continuing a transfer that was interrupted (since --inplace
+      will not update a file that has no write permissions).
+
+    - If either --remove-source-files or --remove-sent-files is enabled and we
+      are unable to remove the source file, rsync now outputs an error.
+
+    - Fixed a bug in the daemon's "incoming chmod" rule:  newly-created
+      directories no longer get the 'F' (file) rules applied to them.
+
+    - Fixed an infinite loop bug when a filter rule was rejected due to being
+      overly long.
+
+    - When the server receives a --partial-dir option from the client, it no
+      longer runs the client-side code that adds an assumed filter rule (since
+      the client will be sending us the rules in the usual manner, and they
+      may have chosen to override the auto-added rule).
 
-    - Improved the documentation for the --owner and --group options.
+  ENHANCEMENTS:
 
-    - The rsyncstats script in "support" has an improved line-parsing regex
-      that is easier to read and also makes it to parse syslog-generated lines.
+    - Added the --log-file=FILE and --log-file-format=FORMAT options.  These
+      can be used to tell any rsync to output what it is doing to a log file.
+      They work with a client rsync, a non-daemon server rsync (see the man
+      page for instructions), and also allows the overriding of rsyncd.conf
+      settings when starting a daemon.
+
+    - The --log-format option was renamed to be --out-format to avoid confusing
+      it with affecting the log-file output.  (The old option remains as an
+      alias for the new to preserve backward compatibility.)
+
+    - Made "log file" and "syslog facility" settable on a per-module basis in
+      the daemon's config file.
+
+    - Added the --remove-source-files option as a replacement for the (now
+      deprecated) --remove-sent-files option.  This new option removes all
+      non-dirs from the source directories, even if the file was already
+      up-to-date.  This fixes a problem where interrupting an rsync that
+      was using --remove-sent-files and restarting it could leave behind
+      a file that the earlier rsync synchronized, but didn't get to remove.
+      (The deprecated --remove-sent-files is still understood for now, and
+      still behaves in the same way as before.)
+
+    - Added the option --no-motd to suppress the message-of-the-day output
+      from a daemon when doing a copy.  (See the manpage for a caveat.)
+
+    - Added a new environment variable to the pre-/post-xfer exec commands (in
+      the daemon's config file):  RSYNC_PID.  This value will be the same in
+      both the pre- and post-xfer commands, so it can be used if the pre-xfer
+      command wants to cache some arg/request info for the post-xfer command.
+
+  INTERNAL:
+
+    - Did a code audit using IBM's code-checker program and made several
+      changes, including: replacing most of the strcpy() and sprintf()
+      calls with strlcpy(), snprintf(), and memcpy(), adding a 0-value to
+      an enum that had been intermingling a literal 0 with the defined enum
+      values, silencing some uninitialized memory checks, marking some
+      functions with a "noreturn" attribute, and changing an "if" that
+      could never succeed on some platforms into a pre-processor directive
+      that conditionally compiles the code.
+
+    - Fixed a potential bug in f_name_cmp() when both the args are a
+      top-level "." dir (which doesn't happen in normal operations).
+
+    - Changed exit_cleanup() so that it can never return instead of exit.
+      The old code might return if it found the exit_cleanup() function
+      was being called recursively.  The new code is segmented so that
+      any recursive calls move on to the next step of the exit-processing.
 
-    - A new script in "support": file-attr-restore, can be used to restore the
-      attributes of a file-set (the permissions, ownership, and group info)
-      taken from the cached output of a "find ARG... -ls" command.
+    - The macro WIFEXITED(stat) will now be defined if the OS didn't already
+      define it.
 
   DEVELOPER RELATED:
 
-    - Removed the unused function write_int_named(), the unused variable
-      io_read_phase, and the rarely used variable io_write_phase.  This also
-      elides the confusing 'phase "unknown"' part of one error message.
-
-    - Removed two unused configure checks and two related (also unused)
-      compatibility functions.
+    - The acls.diff and xattrs.diff patches have received a bunch of work to
+      make them much closer to being acceptable in the main distribution.
+      The xattrs patch also has some preliminary Mac OS X compatibility code
+      that allows Macs and non-macs to exchange extended attributes.
+
+    - A new diff in the patches dir, fake-root.diff, allows rsync to
+      maintain a backup hierarchy with full owner, group, and device info
+      without actually running as root.  It does this using a special
+      extended attribute, so it depends on xattrs.diff (which depends on
+      acls.diff).
 
-    - The xattrs.diff patch received a security fix that prevents a potential
-      buffer overflow in the receive_xattr() code.
+    - The rsync.yo and rsyncd.conf.yo files have been updated to work
+      better with the latest yodl 2.x releases.
 
-    - The acls.diff patch has been improved quite a bit, with more to come.
+    - Updated config.guess and config.sub to their 2006-02-23 version.
 
-    - A new patch was added: log-file.diff.  This contains an early version of
-      a future option, --log-file=FILE, that will allow any rsync to log its
-      actions to a file (something that only a daemon supports at present).
+    - Updated various files to include the latest FSF address and to have
+      consistent opening comments.
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/OLDNEWS /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/OLDNEWS
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/OLDNEWS	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/OLDNEWS	2006-11-07 12:39:47.000000000 +0800
@@ -1,6 +1,75 @@
+NEWS for rsync 2.6.8 (22 Apr 2006)
+Protocol: 29 (unchanged)
+Changes since 2.6.7:
+
+  BUG FIXES:
+
+    - Fixed a bug in the exclude code where an anchored exclude without any
+      wildcards fails to match an absolute source arg, but only when --relative
+      is in effect.
+
+    - Improved the I/O code for the generator to fix a potential hang when the
+      receiver gets an EOF on the socket but the generator's select() call
+      never indicates that the socket is writable for it to be notified about
+      the EOF.  (This can happen when using stunnel).
+
+    - Fixed a problem with the file-reading code where a failed read (such as
+      that caused by a bad sector) would not advance the file's read-position
+      beyond the failed read's data.
+
+    - Fixed a logging bug where the "log file" directive was not being honored
+      in a single-use daemon (one spawned by a remote-shell connection or by
+      init).
+
+    - If rsync cannot honor the --delete option, we output an error and exit
+      instead of silently ignoring the option.
+
+    - Fixed a bug in the --link-dest code that prevented special files (such as
+      fifos) from being linked.
+
+    - The ability to hard-link symlinks and special files is now determined at
+      configure time instead of at runtime.  This fixes a bug with --link-dest
+      creating a hard-link to a symlink's referent on a BSD system.
+
+  ENHANCEMENTS:
+
+    - In daemon mode, if rsync fails to bind to the requested port, the
+      error(s) returned by socket() and/or bind() are now logged.
+
+    - When we output a fatal error, we now output the version of rsync in the
+      message.
+
+    - Improved the documentation for the --owner and --group options.
+
+    - The rsyncstats script in "support" has an improved line-parsing regex
+      that is easier to read and also makes it to parse syslog-generated lines.
+
+    - A new script in "support": file-attr-restore, can be used to restore the
+      attributes of a file-set (the permissions, ownership, and group info)
+      taken from the cached output of a "find ARG... -ls" command.
+
+  DEVELOPER RELATED:
+
+    - Removed the unused function write_int_named(), the unused variable
+      io_read_phase, and the rarely used variable io_write_phase.  This also
+      elides the confusing 'phase "unknown"' part of one error message.
+
+    - Removed two unused configure checks and two related (also unused)
+      compatibility functions.
+
+    - The xattrs.diff patch received a security fix that prevents a potential
+      buffer overflow in the receive_xattr() code.
+
+    - The acls.diff patch has been improved quite a bit, with more to come.
+
+    - A new patch was added: log-file.diff.  This contains an early version of
+      a future option, --log-file=FILE, that will allow any rsync to log its
+      actions to a file (something that only a daemon supports at present).
+
+
 NEWS for rsync 2.6.7 (11 Mar 2006)
 Protocol: 29 (unchanged)
 Changes since 2.6.6:
 
   OUTPUT CHANGES:
 
@@ -1618,13 +1687,13 @@
 
     * The --delete-after option now implies --delete.  (Wayne Davison)
 
     * The --suffix option can now be used with --backup-dir.  (Michael
       Zimmerman)
 
-    * Combining "::" syntax with the -rsh/-e option now uses the
+    * Combining "::" syntax with the --rsh/-e option now uses the
       specified remote-shell as a transport to talk to a (newly-spawned)
       server-daemon.  This allows someone to use daemon features, such
       as modules, over a secure protocol, such as ssh.  (JD Paul)
 
     * The rsync:// syntax for daemon connections is now accepted in the
       destination field.
@@ -2010,12 +2079,13 @@
     * The existing test.sh script by Phil Hands has been merged into a
       test framework that works from both "make check" and the Samba
       build farm.
 
 Partial Protocol History
 	RELEASE DATE	VER.	DATE OF COMMIT*	PROTOCOL
+	06 Nov 2006	2.6.9			29
 	22 Apr 2006	2.6.8			29
 	11 Mar 2006	2.6.7			29
 	28 Jul 2005	2.6.6			29
 	01 Jun 2005	2.6.5			29
 	30 Mar 2005	2.6.4	17 Jan 2005	29
 	30 Sep 2004	2.6.3			28
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/options.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/options.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/options.c	2006-03-29 07:09:36.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/options.c	2006-10-24 08:36:38.000000000 +0800
@@ -1,24 +1,26 @@
-/*  -*- c-file-style: "linux" -*-
+/*
+ * Command-line (and received via daemon-socket) option parsing.
  *
- * Copyright (C) 1998-2001 by Andrew Tridgell <tridge@samba.org>
- * Copyright (C) 2000, 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1998-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 2000, 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2002, 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
 #include "rsync.h"
 #include <popt.h>
 #include "zlib/zlib.h"
 
@@ -60,13 +62,13 @@
 int ignore_times = 0;
 int delete_mode = 0;
 int delete_during = 0;
 int delete_before = 0;
 int delete_after = 0;
 int delete_excluded = 0;
-int remove_sent_files = 0;
+int remove_source_files = 0;
 int one_file_system = 0;
 int protocol_version = PROTOCOL_VERSION;
 int sparse_files = 0;
 int do_compression = 0;
 int def_compress_level = Z_DEFAULT_COMPRESSION;
 int am_root = 0;
@@ -142,13 +144,15 @@
 char *backup_suffix = NULL;
 char *tmpdir = NULL;
 char *partial_dir = NULL;
 char *basis_dir[MAX_BASIS_DIRS+1];
 char *config_file = NULL;
 char *shell_cmd = NULL;
-char *log_format = NULL;
+char *logfile_name = NULL;
+char *logfile_format = NULL;
+char *stdout_format = NULL;
 char *password_file = NULL;
 char *rsync_path = RSYNC_PATH;
 char *backup_dir = NULL;
 char backup_dir_buf[MAXPATHLEN];
 char *sockopts = NULL;
 int rsync_port = 0;
@@ -157,15 +161,18 @@
 int link_dest = 0;
 int basis_dir_cnt = 0;
 char *dest_option = NULL;
 
 int verbose = 0;
 int quiet = 0;
+int output_motd = 1;
 int log_before_transfer = 0;
-int log_format_has_i = 0;
-int log_format_has_o_or_i = 0;
+int stdout_format_has_i = 0;
+int stdout_format_has_o_or_i = 0;
+int logfile_format_has_i = 0;
+int logfile_format_has_o_or_i = 0;
 int always_checksum = 0;
 int list_only = 0;
 
 #define MAX_BATCH_NAME_LEN 256	/* Must be less than MAXPATHLEN-13 */
 char *batch_name = NULL;
 
@@ -243,37 +250,42 @@
 	if (sizeof (int64) != SIZEOF_INT64) {
 		rprintf(f,
 			"WARNING: size mismatch in SIZEOF_INT64 define (%d != %d)\n",
 			(int) SIZEOF_INT64, (int) sizeof (int64));
 	}
 
-	rprintf(f,"\nrsync comes with ABSOLUTELY NO WARRANTY.  This is free software, and you\n");
+	rprintf(f,"\n");
+	rprintf(f,"rsync comes with ABSOLUTELY NO WARRANTY.  This is free software, and you\n");
 	rprintf(f,"are welcome to redistribute it under certain conditions.  See the GNU\n");
 	rprintf(f,"General Public Licence for details.\n");
 }
 
 
 void usage(enum logcode F)
 {
   print_rsync_version(F);
 
-  rprintf(F,"\nrsync is a file transfer program capable of efficient remote update\n");
+  rprintf(F,"\n");
+  rprintf(F,"rsync is a file transfer program capable of efficient remote update\n");
   rprintf(F,"via a fast differencing algorithm.\n");
 
-  rprintf(F,"\nUsage: rsync [OPTION]... SRC [SRC]... DEST\n");
+  rprintf(F,"\n");
+  rprintf(F,"Usage: rsync [OPTION]... SRC [SRC]... DEST\n");
   rprintf(F,"  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST\n");
   rprintf(F,"  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST\n");
   rprintf(F,"  or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST\n");
   rprintf(F,"  or   rsync [OPTION]... [USER@]HOST:SRC [DEST]\n");
   rprintf(F,"  or   rsync [OPTION]... [USER@]HOST::SRC [DEST]\n");
   rprintf(F,"  or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]\n");
   rprintf(F,"The ':' usages connect via remote shell, while '::' & 'rsync://' usages connect\n");
   rprintf(F,"to an rsync daemon, and require SRC or DEST to start with a module name.\n");
-  rprintf(F,"\nOptions\n");
+  rprintf(F,"\n");
+  rprintf(F,"Options\n");
   rprintf(F," -v, --verbose               increase verbosity\n");
   rprintf(F," -q, --quiet                 suppress non-error messages\n");
+  rprintf(F,"     --no-motd               suppress daemon-mode MOTD (see manpage caveat)\n");
   rprintf(F," -c, --checksum              skip based on checksum, not mod-time & size\n");
   rprintf(F," -a, --archive               archive mode; same as -rlptgoD (no -H)\n");
   rprintf(F,"     --no-OPTION             turn off an implied OPTION (e.g. --no-D)\n");
   rprintf(F," -r, --recursive             recurse into directories\n");
   rprintf(F," -R, --relative              use relative path names\n");
   rprintf(F,"     --no-implied-dirs       don't send implied dirs with --relative\n");
@@ -290,13 +302,13 @@
   rprintf(F,"     --safe-links            ignore symlinks that point outside the source tree\n");
   rprintf(F," -k, --copy-dirlinks         transform symlink to a dir into referent dir\n");
   rprintf(F," -K, --keep-dirlinks         treat symlinked dir on receiver as dir\n");
   rprintf(F," -H, --hard-links            preserve hard links\n");
   rprintf(F," -p, --perms                 preserve permissions\n");
   rprintf(F," -E, --executability         preserve the file's executability\n");
-  rprintf(F,"     --chmod=CHMOD           change destination permissions\n");
+  rprintf(F,"     --chmod=CHMOD           affect file and/or directory permissions\n");
   rprintf(F," -o, --owner                 preserve owner (super-user only)\n");
   rprintf(F," -g, --group                 preserve group\n");
   rprintf(F,"     --devices               preserve device files (super-user only)\n");
   rprintf(F,"     --specials              preserve special files\n");
   rprintf(F," -D                          same as --devices --specials\n");
   rprintf(F," -t, --times                 preserve times\n");
@@ -306,21 +318,21 @@
   rprintf(F," -n, --dry-run               show what would have been transferred\n");
   rprintf(F," -W, --whole-file            copy files whole (without rsync algorithm)\n");
   rprintf(F," -x, --one-file-system       don't cross filesystem boundaries\n");
   rprintf(F," -B, --block-size=SIZE       force a fixed checksum block-size\n");
   rprintf(F," -e, --rsh=COMMAND           specify the remote shell to use\n");
   rprintf(F,"     --rsync-path=PROGRAM    specify the rsync to run on the remote machine\n");
-  rprintf(F,"     --existing              ignore non-existing files on receiving side\n");
-  rprintf(F,"     --ignore-existing       ignore files that already exist on receiving side\n");
-  rprintf(F,"     --remove-sent-files     sent files/symlinks are removed from sending side\n");
+  rprintf(F,"     --existing              skip creating new files on receiver\n");
+  rprintf(F,"     --ignore-existing       skip updating files that already exist on receiver\n");
+  rprintf(F,"     --remove-source-files   sender removes synchronized files (non-dirs)\n");
   rprintf(F,"     --del                   an alias for --delete-during\n");
-  rprintf(F,"     --delete                delete files that don't exist on the sending side\n");
+  rprintf(F,"     --delete                delete extraneous files from destination dirs\n");
   rprintf(F,"     --delete-before         receiver deletes before transfer (default)\n");
   rprintf(F,"     --delete-during         receiver deletes during transfer, not before\n");
   rprintf(F,"     --delete-after          receiver deletes after transfer, not before\n");
-  rprintf(F,"     --delete-excluded       also delete excluded files on the receiving side\n");
+  rprintf(F,"     --delete-excluded       also delete excluded files from destination dirs\n");
   rprintf(F,"     --ignore-errors         delete even if there are I/O errors\n");
   rprintf(F,"     --force                 force deletion of directories even if not empty\n");
   rprintf(F,"     --max-delete=NUM        don't delete more than NUM files\n");
   rprintf(F,"     --max-size=SIZE         don't transfer any file larger than SIZE\n");
   rprintf(F,"     --min-size=SIZE         don't transfer any file smaller than SIZE\n");
   rprintf(F,"     --partial               keep partially transferred files\n");
@@ -356,13 +368,15 @@
   rprintf(F,"     --stats                 give some file-transfer stats\n");
   rprintf(F," -8, --8-bit-output          leave high-bit chars unescaped in output\n");
   rprintf(F," -h, --human-readable        output numbers in a human-readable format\n");
   rprintf(F,"     --progress              show progress during transfer\n");
   rprintf(F," -P                          same as --partial --progress\n");
   rprintf(F," -i, --itemize-changes       output a change-summary for all updates\n");
-  rprintf(F,"     --log-format=FORMAT     output filenames using the specified format\n");
+  rprintf(F,"     --out-format=FORMAT     output updates using the specified FORMAT\n");
+  rprintf(F,"     --log-file=FILE         log what we're doing to the specified FILE\n");
+  rprintf(F,"     --log-file-format=FMT   log updates using the specified FMT\n");
   rprintf(F,"     --password-file=FILE    read password from FILE\n");
   rprintf(F,"     --list-only             list the files instead of copying them\n");
   rprintf(F,"     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second\n");
   rprintf(F,"     --write-batch=FILE      write a batched update to FILE\n");
   rprintf(F,"     --only-write-batch=FILE like --write-batch but w/o updating destination\n");
   rprintf(F,"     --read-batch=FILE       read a batched update from FILE\n");
@@ -371,13 +385,14 @@
   rprintf(F," -4, --ipv4                  prefer IPv4\n");
   rprintf(F," -6, --ipv6                  prefer IPv6\n");
 #endif
   rprintf(F,"     --version               print version number\n");
   rprintf(F,"(-h) --help                  show this help (-h works with no other options)\n");
 
-  rprintf(F,"\nUse \"rsync --daemon --help\" to see the daemon-mode command-line options.\n");
+  rprintf(F,"\n");
+  rprintf(F,"Use \"rsync --daemon --help\" to see the daemon-mode command-line options.\n");
   rprintf(F,"Please see the rsync(1) and rsyncd.conf(5) man pages for full documentation.\n");
   rprintf(F,"See http://rsync.samba.org/ for updates, bug reports, and answers\n");
 }
 
 enum {OPT_VERSION = 1000, OPT_DAEMON, OPT_SENDER, OPT_EXCLUDE, OPT_EXCLUDE_FROM,
       OPT_FILTER, OPT_COMPARE_DEST, OPT_COPY_DEST, OPT_LINK_DEST, OPT_HELP,
@@ -391,12 +406,14 @@
   {"help",             0,  POPT_ARG_NONE,   0, OPT_HELP, 0, 0 },
   {"version",          0,  POPT_ARG_NONE,   0, OPT_VERSION, 0, 0},
   {"verbose",         'v', POPT_ARG_NONE,   0, 'v', 0, 0 },
   {"no-verbose",       0,  POPT_ARG_VAL,    &verbose, 0, 0, 0 },
   {"no-v",             0,  POPT_ARG_VAL,    &verbose, 0, 0, 0 },
   {"quiet",           'q', POPT_ARG_NONE,   0, 'q', 0, 0 },
+  {"motd",             0,  POPT_ARG_VAL,    &output_motd, 1, 0, 0 },
+  {"no-motd",          0,  POPT_ARG_VAL,    &output_motd, 0, 0, 0 },
   {"stats",            0,  POPT_ARG_NONE,   &do_stats, 0, 0, 0 },
   {"human-readable",  'h', POPT_ARG_NONE,   0, 'h', 0, 0},
   {"dry-run",         'n', POPT_ARG_NONE,   &dry_run, 0, 0, 0 },
   {"archive",         'a', POPT_ARG_NONE,   0, 'a', 0, 0 },
   {"recursive",       'r', POPT_ARG_VAL,    &recurse, 2, 0, 0 },
   {"no-recursive",     0,  POPT_ARG_VAL,    &recurse, 0, 0, 0 },
@@ -459,13 +476,14 @@
   {"del",              0,  POPT_ARG_NONE,   &delete_during, 0, 0, 0 },
   {"delete",           0,  POPT_ARG_NONE,   &delete_mode, 0, 0, 0 },
   {"delete-before",    0,  POPT_ARG_VAL,    &delete_before, 2, 0, 0 },
   {"delete-during",    0,  POPT_ARG_NONE,   &delete_during, 0, 0, 0 },
   {"delete-after",     0,  POPT_ARG_NONE,   &delete_after, 0, 0, 0 },
   {"delete-excluded",  0,  POPT_ARG_NONE,   &delete_excluded, 0, 0, 0 },
-  {"remove-sent-files",0,  POPT_ARG_NONE,   &remove_sent_files, 0, 0, 0 },
+  {"remove-sent-files",0,  POPT_ARG_VAL,    &remove_source_files, 2, 0, 0 }, /* deprecated */
+  {"remove-source-files",0,POPT_ARG_VAL,    &remove_source_files, 1, 0, 0 },
   {"force",            0,  POPT_ARG_NONE,   &force_delete, 0, 0, 0 },
   {"ignore-errors",    0,  POPT_ARG_NONE,   &ignore_errors, 0, 0, 0 },
   {"max-delete",       0,  POPT_ARG_INT,    &max_delete, 0, 0, 0 },
   {0,                 'F', POPT_ARG_NONE,   0, 'F', 0, 0 },
   {"filter",          'f', POPT_ARG_STRING, 0, OPT_FILTER, 0, 0 },
   {"exclude",          0,  POPT_ARG_STRING, 0, OPT_EXCLUDE, 0, 0 },
@@ -489,13 +507,16 @@
   {"no-progress",      0,  POPT_ARG_VAL,    &do_progress, 0, 0, 0 },
   {"partial",          0,  POPT_ARG_VAL,    &keep_partial, 1, 0, 0 },
   {"no-partial",       0,  POPT_ARG_VAL,    &keep_partial, 0, 0, 0 },
   {"partial-dir",      0,  POPT_ARG_STRING, &partial_dir, 0, 0, 0 },
   {"delay-updates",    0,  POPT_ARG_NONE,   &delay_updates, 0, 0, 0 },
   {"prune-empty-dirs",'m', POPT_ARG_NONE,   &prune_empty_dirs, 0, 0, 0 },
-  {"log-format",       0,  POPT_ARG_STRING, &log_format, 0, 0, 0 },
+  {"log-file",         0,  POPT_ARG_STRING, &logfile_name, 0, 0, 0 },
+  {"log-file-format",  0,  POPT_ARG_STRING, &logfile_format, 0, 0, 0 },
+  {"out-format",       0,  POPT_ARG_STRING, &stdout_format, 0, 0, 0 },
+  {"log-format",       0,  POPT_ARG_STRING, &stdout_format, 0, 0, 0 }, /* DEPRECATED */
   {"itemize-changes", 'i', POPT_ARG_NONE,   0, 'i', 0, 0 },
   {"bwlimit",          0,  POPT_ARG_INT,    &bwlimit, 0, 0, 0 },
   {"backup",          'b', POPT_ARG_NONE,   &make_backups, 0, 0, 0 },
   {"backup-dir",       0,  POPT_ARG_STRING, &backup_dir, 0, 0, 0 },
   {"suffix",           0,  POPT_ARG_STRING, &backup_suffix, 0, 0, 0 },
   {"list-only",        0,  POPT_ARG_VAL,    &list_only, 2, 0, 0 },
@@ -533,27 +554,31 @@
 };
 
 static void daemon_usage(enum logcode F)
 {
   print_rsync_version(F);
 
-  rprintf(F,"\nUsage: rsync --daemon [OPTION]...\n");
+  rprintf(F,"\n");
+  rprintf(F,"Usage: rsync --daemon [OPTION]...\n");
   rprintf(F,"     --address=ADDRESS       bind to the specified address\n");
   rprintf(F,"     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second\n");
   rprintf(F,"     --config=FILE           specify alternate rsyncd.conf file\n");
   rprintf(F,"     --no-detach             do not detach from the parent\n");
   rprintf(F,"     --port=PORT             listen on alternate port number\n");
+  rprintf(F,"     --log-file=FILE         override the \"log file\" setting\n");
+  rprintf(F,"     --log-file-format=FMT   override the \"log format\" setting\n");
   rprintf(F,"     --sockopts=OPTIONS      specify custom TCP options\n");
   rprintf(F," -v, --verbose               increase verbosity\n");
 #ifdef INET6
   rprintf(F," -4, --ipv4                  prefer IPv4\n");
   rprintf(F," -6, --ipv6                  prefer IPv6\n");
 #endif
   rprintf(F,"     --help                  show this help screen\n");
 
-  rprintf(F,"\nIf you were not trying to invoke rsync as a daemon, avoid using any of the\n");
+  rprintf(F,"\n");
+  rprintf(F,"If you were not trying to invoke rsync as a daemon, avoid using any of the\n");
   rprintf(F,"daemon-specific rsync options.  See also the rsyncd.conf(5) man page.\n");
 }
 
 static struct poptOption long_daemon_options[] = {
   /* longName, shortName, argInfo, argPtr, value, descrip, argDesc */
   {"address",          0,  POPT_ARG_STRING, &bind_address, 0, 0, 0 },
@@ -562,12 +587,14 @@
   {"daemon",           0,  POPT_ARG_NONE,   &daemon_opt, 0, 0, 0 },
 #ifdef INET6
   {"ipv4",            '4', POPT_ARG_VAL,    &default_af_hint, AF_INET, 0, 0 },
   {"ipv6",            '6', POPT_ARG_VAL,    &default_af_hint, AF_INET6, 0, 0 },
 #endif
   {"detach",           0,  POPT_ARG_VAL,    &no_detach, 0, 0, 0 },
+  {"log-file",         0,  POPT_ARG_STRING, &logfile_name, 0, 0, 0 },
+  {"log-file-format",  0,  POPT_ARG_STRING, &logfile_format, 0, 0, 0 },
   {"no-detach",        0,  POPT_ARG_VAL,    &no_detach, 1, 0, 0 },
   {"port",             0,  POPT_ARG_INT,    &rsync_port, 0, 0, 0 },
   {"sockopts",         0,  POPT_ARG_STRING, &sockopts, 0, 0, 0 },
   {"protocol",         0,  POPT_ARG_INT,    &protocol_version, 0, 0, 0 },
   {"server",           0,  POPT_ARG_NONE,   &am_server, 0, 0, 0 },
   {"temp-dir",        'T', POPT_ARG_STRING, &tmpdir, 0, 0, 0 },
@@ -587,14 +614,15 @@
  * connection attempt (which requires parsing the options), and then
  * show the error later on.
  **/
 void option_error(void)
 {
 	if (!err_buf[0]) {
-		strcpy(err_buf, "Error parsing options: "
-		    "option may be supported on client but not on server?\n");
+		strlcpy(err_buf, "Error parsing options: option may "
+			"be supported on client but not on server?\n",
+			sizeof err_buf);
 	}
 
 	rprintf(FERROR, RSYNC_NAME ": %s", err_buf);
 	msleep(20);
 }
 
@@ -662,23 +690,12 @@
 		}
 		if (!cp)
 			break;
 		*cp = ' ';
 		bp = cp + 1;
 	}
-
-	for (op = long_options; ; op++) {
-		*shortname = op->shortName;
-		if (!op->longName && !*shortname)
-			break;
-		if (op->val == OPT_DAEMON) {
-			if (op->argInfo == POPT_ARG_VAL)
-				op->argInfo = POPT_ARG_NONE;
-			op->val = (op - long_options) + OPT_REFUSED_BASE;
-		}
-	}
 }
 
 
 static int count_args(const char **argv)
 {
 	int i = 0;
@@ -777,12 +794,14 @@
 	char *ref = lp_refuse_options(module_id);
 	const char *arg;
 	poptContext pc;
 
 	if (ref && *ref)
 		set_refuse_options(ref);
+	if (am_daemon)
+		set_refuse_options("log-file*");
 
 	/* TODO: Call poptReadDefaultConfig; handle errors. */
 
 	/* The context leaks in case of an error, but if there's a
 	 * problem we always exit anyhow. */
 	pc = poptGetContext(RSYNC_NAME, *argc, *argv, long_options, 0);
@@ -815,13 +834,15 @@
 			}
 			am_sender = 1;
 			break;
 
 		case OPT_DAEMON:
 			if (am_daemon) {
-				strcpy(err_buf, "Attempt to hack rsync thwarted!\n");
+				strlcpy(err_buf,
+					"Attempt to hack rsync thwarted!\n",
+					sizeof err_buf);
 				return 0;
 			}
 			poptFreeContext(pc);
 			pc = poptGetContext(RSYNC_NAME, *argc, *argv,
 					    long_daemon_options, 0);
 			while ((opt = poptGetNextOpt(pc)) != -1) {
@@ -886,20 +907,23 @@
 			break;
 
 		case OPT_EXCLUDE_FROM:
 		case OPT_INCLUDE_FROM:
 			arg = poptGetOptArg(pc);
 			if (sanitize_paths)
-				arg = sanitize_path(NULL, arg, NULL, 0);
+				arg = sanitize_path(NULL, arg, NULL, 0, NULL);
 			if (server_filter_list.head) {
-				char *cp = (char *)arg;
+				char *cp = strdup(arg);
+				if (!cp)
+					out_of_memory("parse_arguments");
 				if (!*cp)
 					goto options_rejected;
 				clean_fname(cp, 1);
 				if (check_filter(&server_filter_list, cp, 0) < 0)
 					goto options_rejected;
+				free(cp);
 			}
 			parse_filter_file(&filter_list, arg,
 				opt == OPT_INCLUDE_FROM ? MATCHFLG_INCLUDE : 0,
 				XFLG_FATAL_ERRORS | XFLG_OLD_PREFIXES);
 			break;
 
@@ -1017,13 +1041,13 @@
 					min_size_arg);
 				return 0;
 			}
 			break;
 
 		case OPT_LINK_DEST:
-#ifdef HAVE_LINK
+#ifdef SUPPORT_HARD_LINKS
 			link_dest = 1;
 			dest_option = "--link-dest";
 			goto set_dest_dir;
 #else
 			snprintf(err_buf, sizeof err_buf,
 				 "hard links are not supported on this %s\n",
@@ -1043,16 +1067,15 @@
 			if (basis_dir_cnt >= MAX_BASIS_DIRS) {
 				snprintf(err_buf, sizeof err_buf,
 					"ERROR: at most %d %s args may be specified\n",
 					MAX_BASIS_DIRS, dest_option);
 				return 0;
 			}
-			arg = poptGetOptArg(pc);
-			if (sanitize_paths)
-				arg = sanitize_path(NULL, arg, NULL, 0);
-			basis_dir[basis_dir_cnt++] = (char *)arg;
+			/* We defer sanitizing this arg until we know what
+			 * our destination directory is going to be. */
+			basis_dir[basis_dir_cnt++] = (char *)poptGetOptArg(pc);
 			break;
 
 		case OPT_CHMOD:
 			arg = poptGetOptArg(pc);
 			if (!parse_chmod(arg, &chmod_modes)) {
 				snprintf(err_buf, sizeof err_buf,
@@ -1184,14 +1207,14 @@
 
 	if (delete_mode && refused_delete) {
 		create_refuse_error(refused_delete);
 		return 0;
 	}
 
-	if (remove_sent_files) {
-		/* We only want to infer this refusal of --remove-sent-files
+	if (remove_source_files) {
+		/* We only want to infer this refusal of --remove-source-files
 		 * via the refusal of "delete", not any of the "delete-FOO"
 		 * options. */
 		if (refused_delete && am_sender) {
 			create_refuse_error(refused_delete);
 			return 0;
 		}
@@ -1201,42 +1224,27 @@
 	*argv = poptGetArgs(pc);
 	*argc = count_args(*argv);
 
 	if (sanitize_paths) {
 		int i;
 		for (i = *argc; i-- > 0; )
-			(*argv)[i] = sanitize_path(NULL, (*argv)[i], "", 0);
+			(*argv)[i] = sanitize_path(NULL, (*argv)[i], "", 0, NULL);
 		if (tmpdir)
-			tmpdir = sanitize_path(NULL, tmpdir, NULL, 0);
-		if (partial_dir)
-			partial_dir = sanitize_path(NULL, partial_dir, NULL, 0);
+			tmpdir = sanitize_path(NULL, tmpdir, NULL, 0, NULL);
 		if (backup_dir)
-			backup_dir = sanitize_path(NULL, backup_dir, NULL, 0);
+			backup_dir = sanitize_path(NULL, backup_dir, NULL, 0, NULL);
 	}
 	if (server_filter_list.head && !am_sender) {
 		struct filter_list_struct *elp = &server_filter_list;
-		int i;
 		if (tmpdir) {
 			if (!*tmpdir)
 				goto options_rejected;
 			clean_fname(tmpdir, 1);
 			if (check_filter(elp, tmpdir, 1) < 0)
 				goto options_rejected;
 		}
-		if (partial_dir && *partial_dir) {
-			clean_fname(partial_dir, 1);
-			if (check_filter(elp, partial_dir, 1) < 0)
-				goto options_rejected;
-		}
-		for (i = 0; i < basis_dir_cnt; i++) {
-			if (!*basis_dir[i])
-				goto options_rejected;
-			clean_fname(basis_dir[i], 1);
-			if (check_filter(elp, basis_dir[i], 1) < 0)
-				goto options_rejected;
-		}
 		if (backup_dir) {
 			if (!*backup_dir)
 				goto options_rejected;
 			clean_fname(backup_dir, 1);
 			if (check_filter(elp, backup_dir, 1) < 0) {
 			    options_rejected:
@@ -1279,40 +1287,54 @@
 			"P *%s", backup_suffix);
 		parse_rule(&filter_list, backup_dir_buf, 0, 0);
 	}
 	if (make_backups && !backup_dir)
 		omit_dir_times = 1;
 
-	if (log_format) {
-		if (am_server && log_format_has(log_format, 'I'))
-			log_format_has_i = 2;
-		else if (log_format_has(log_format, 'i'))
-			log_format_has_i = itemize_changes | 1;
-		if (!log_format_has(log_format, 'b')
-		 && !log_format_has(log_format, 'c'))
+	if (stdout_format) {
+		if (am_server && log_format_has(stdout_format, 'I'))
+			stdout_format_has_i = 2;
+		else if (log_format_has(stdout_format, 'i'))
+			stdout_format_has_i = itemize_changes | 1;
+		if (!log_format_has(stdout_format, 'b')
+		 && !log_format_has(stdout_format, 'c'))
 			log_before_transfer = !am_server;
 	} else if (itemize_changes) {
-		log_format = "%i %n%L";
-		log_format_has_i = itemize_changes;
+		stdout_format = "%i %n%L";
+		stdout_format_has_i = itemize_changes;
 		log_before_transfer = !am_server;
 	}
 
 	if (do_progress && !verbose && !log_before_transfer && !am_server)
 		verbose = 1;
 
 	if (dry_run)
 		do_xfers = 0;
 
 	set_io_timeout(io_timeout);
 
-	if (verbose && !log_format) {
-		log_format = "%n%L";
+	if (verbose && !stdout_format) {
+		stdout_format = "%n%L";
 		log_before_transfer = !am_server;
 	}
-	if (log_format_has_i || log_format_has(log_format, 'o'))
-		log_format_has_o_or_i = 1;
+	if (stdout_format_has_i || log_format_has(stdout_format, 'o'))
+		stdout_format_has_o_or_i = 1;
+
+	if (logfile_name && !am_daemon) {
+		if (!logfile_format) {
+			logfile_format = "%i %n%L";
+			logfile_format_has_i = logfile_format_has_o_or_i = 1;
+		} else {
+			if (log_format_has(logfile_format, 'i'))
+				logfile_format_has_i = 1;
+			if (logfile_format_has_i || log_format_has(logfile_format, 'o'))
+				logfile_format_has_o_or_i = 1;
+		}
+		log_init(0);
+	} else if (!am_daemon)
+		logfile_format = NULL;
 
 	if (daemon_bwlimit && (!bwlimit || bwlimit > daemon_bwlimit))
 		bwlimit = daemon_bwlimit;
 	if (bwlimit) {
 		bwlimit_writemax = (size_t)bwlimit * 128;
 		if (bwlimit_writemax < 512)
@@ -1373,13 +1395,13 @@
 		}
 		if (partial_dir) {
 			if (*partial_dir)
 				clean_fname(partial_dir, 1);
 			if (!*partial_dir || strcmp(partial_dir, ".") == 0)
 				partial_dir = NULL;
-			else if (*partial_dir != '/') {
+			else if (*partial_dir != '/' && !am_server) {
 				parse_rule(&filter_list, partial_dir,
 				    MATCHFLG_NO_PREFIXES|MATCHFLG_DIRECTORY, 0);
 			}
 			if (!partial_dir && refused_partial) {
 				create_refuse_error(refused_partial);
 				return 0;
@@ -1411,13 +1433,13 @@
 				snprintf(err_buf, sizeof err_buf,
 					"Invalid --files-from remote filename\n");
 				return 0;
 			}
 		} else {
 			if (sanitize_paths)
-				files_from = sanitize_path(NULL, files_from, NULL, 0);
+				files_from = sanitize_path(NULL, files_from, NULL, 0, NULL);
 			if (server_filter_list.head) {
 				if (!*files_from)
 					goto options_rejected;
 				clean_fname(files_from, 1);
 				if (check_filter(&server_filter_list, files_from, 0) < 0)
 					goto options_rejected;
@@ -1481,13 +1503,13 @@
 	if (update_only)
 		argstr[x++] = 'u';
 	if (!do_xfers) /* Note: NOT "dry_run"! */
 		argstr[x++] = 'n';
 	if (preserve_links)
 		argstr[x++] = 'l';
-	if (xfer_dirs > (recurse || !delete_mode || !am_sender))
+	if (xfer_dirs > (recurse || !delete_mode || !am_sender ? 1 : 0))
 		argstr[x++] = 'd';
 	if (am_sender) {
 		if (keep_dirlinks)
 			argstr[x++] = 'K';
 		if (prune_empty_dirs)
 			argstr[x++] = 'm';
@@ -1571,18 +1593,19 @@
 			args[ac++] = "--no-specials"; /* -D is already set. */
 	} else if (preserve_specials)
 		args[ac++] = "--specials";
 
 	/* The server side doesn't use our log-format, but in certain
 	 * circumstances they need to know a little about the option. */
-	if (log_format && am_sender) {
-		if (log_format_has_i > 1)
+	if (stdout_format && am_sender) {
+		/* Use --log-format, not --out-format, for compatibility. */
+		if (stdout_format_has_i > 1)
 			args[ac++] = "--log-format=%i%I";
-		else if (log_format_has_i)
+		else if (stdout_format_has_i)
 			args[ac++] = "--log-format=%i";
-		else if (log_format_has_o_or_i)
+		else if (stdout_format_has_o_or_i)
 			args[ac++] = "--log-format=%o";
 		else if (!verbose)
 			args[ac++] = "--log-format=X";
 	}
 
 	if (block_size) {
@@ -1732,13 +1755,15 @@
 	if (relative_paths && !implied_dirs && !am_sender)
 		args[ac++] = "--no-implied-dirs";
 
 	if (fuzzy_basis && am_sender)
 		args[ac++] = "--fuzzy";
 
-	if (remove_sent_files)
+	if (remove_source_files == 1)
+		args[ac++] = "--remove-source-files";
+	else if (remove_source_files)
 		args[ac++] = "--remove-sent-files";
 
 	*argc = ac;
 	return;
 
     oom:
@@ -1753,16 +1778,16 @@
  * be an IPv6 literal address enclosed in '[' and ']' (such as "[::1]" or
  * "[::ffff:127.0.0.1]") which is returned without the '[' and ']'. */
 char *check_for_hostspec(char *s, char **host_ptr, int *port_ptr)
 {
 	char *p;
 	int not_host;
+	int hostlen;
 
 	if (port_ptr && strncasecmp(URL_PREFIX, s, strlen(URL_PREFIX)) == 0) {
 		char *path;
-		int hostlen;
 		s += strlen(URL_PREFIX);
 		if ((p = strchr(s, '/')) != NULL) {
 			hostlen = p - s;
 			path = p + 1;
 		} else {
 			hostlen = strlen(s);
@@ -1785,30 +1810,32 @@
 		strlcpy(*host_ptr, s, hostlen + 1);
 		return path;
 	}
 
 	if (*s == '[' && (p = strchr(s, ']')) != NULL && p[1] == ':') {
 		s++;
+		hostlen = p - s;
 		*p = '\0';
 		not_host = strchr(s, '/') || !strchr(s, ':');
 		*p = ']';
 		if (not_host)
 			return NULL;
 		p++;
 	} else {
 		if (!(p = strchr(s, ':')))
 			return NULL;
+		hostlen = p - s;
 		*p = '\0';
 		not_host = strchr(s, '/') != NULL;
 		*p = ':';
 		if (not_host)
 			return NULL;
 	}
 
-	*host_ptr = new_array(char, p - s + 1);
-	strlcpy(*host_ptr, s, p - s + 1);
+	*host_ptr = new_array(char, hostlen + 1);
+	strlcpy(*host_ptr, s, hostlen + 1);
 
 	if (p[1] == ':') {
 		if (port_ptr && !*port_ptr)
 			*port_ptr = RSYNC_PORT;
 		return p + 2;
 	}
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/lsb/rsync.spec /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/lsb/rsync.spec
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/lsb/rsync.spec	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/lsb/rsync.spec	2006-11-07 12:39:47.000000000 +0800
@@ -1,9 +1,9 @@
 Summary: A program for synchronizing files over a network.
 Name: rsync
-Version: 2.6.8
+Version: 2.6.9
 Release: 1
 Group: Applications/Internet
 Source:	ftp://rsync.samba.org/pub/rsync/rsync-%{version}.tar.gz
 URL: http://rsync.samba.org/
 
 Prefix: %{_prefix}
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/nightly-rsync /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/nightly-rsync
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/nightly-rsync	2006-04-09 00:36:57.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/nightly-rsync	2006-10-18 13:14:10.000000000 +0800
@@ -15,12 +15,13 @@
 use Date::Format;
 
 # Choose any dir where a pristine rsync has been checked out of CVS.
 our $unpacked = $ENV{HOME} . '/release/nightly';
 # Where the local copy of /home/ftp/pub/rsync/nightly should be updated.
 our $nightly = $ENV{HOME} . '/samba-rsync-ftp/nightly';
+our $nightly_symlink = "$nightly/rsync-HEAD.tar.gz";
 
 our($cvs_update, $make_tar, $upload, $help_opt);
 &Getopt::Long::Configure('bundling');
 &usage if !&GetOptions(
     'cvs-update|c' => \$cvs_update,
     'make-tar|t' => \$make_tar,
@@ -66,12 +67,14 @@
     open(TAR, '|-', "fakeroot tar --files-from=- --no-recursion --mode=g-w -czf $nightly/$name.tar.gz $name") or die $!;
     foreach (@files) {
 	print TAR "$name/$_\n";
     }
     close TAR;
     rename($name, $unpacked) or die $!;
+    unlink($nightly_symlink);
+    symlink("$name.tar.gz", $nightly_symlink);
 }
 
 chdir($nightly) or die $!;
 
 foreach my $fn (qw( rsync.yo rsyncd.conf.yo )) {
     my $html_fn = $fn;
@@ -94,14 +97,17 @@
 }
 
 system "find . -name 'rsync-HEAD-*' -daystart -mtime +14 | xargs rm -f";
 system 'ls -ltr';
 
 if ($upload) {
-    $ENV{RSYNC_PARTIAL_DIR} = ''; # The rsync on samba.org is OLD.
-    system "rsync -aviHP --delete-after . samba.org:/home/ftp/pub/rsync/nightly";
+    my $opt = '';
+    if (defined $ENV{RSYNC_PARTIAL_DIR}) {
+	$opt = " -f 'R $ENV{RSYNC_PARTIAL_DIR}'";
+    }
+    system "rsync$opt -aviHP --delete-after . samba.org:/home/ftp/pub/rsync/nightly";
 }
 
 exit;
 
 sub usage
 {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/release-rsync /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/release-rsync
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/packaging/release-rsync	2006-04-18 14:43:17.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/packaging/release-rsync	2006-10-25 00:17:31.000000000 +0800
@@ -152,31 +152,35 @@
 }
 foreach my $fn (@tweak_files) {
     open(IN, '<', $fn) or die $!;
     undef $/; $_ = <IN>; $/ = "\n";
     close IN;
     if ($fn =~ /configure/) {
-	s/^RSYNC_VERSION.*/RSYNC_VERSION=$version/m;
+	s/^RSYNC_VERSION=.*/RSYNC_VERSION=$version/m;
     } elsif ($fn =~ /\.spec/) {
 	s/^(Version:) .*/$1 $version/m;
 	s/^(Release:) .*/$1 $release/m;
     } elsif ($fn =~ /\.yo/) {
 	s/^(manpage\([^)]+\)\(\d+\)\()[^)]+(\).*)/$1$today$2/m;
 	s/^(This man ?page is current for version) \S+ (of rsync)/$1 $version $2/m;
+    } elsif ($fn eq 'NEWS') {
+	s/^(NEWS for rsync \Q$version\E) \(UNRELEASED\)\s*\n/$1 ($today)\n/mi
+	    or die "Couldn't update NEWS file with release date!\n";
+    } elsif ($fn eq 'OLDNEWS') {
+	s/^\t\S\S\s\S\S\S\s\d\d\d\d(\t\Q$version\E)/\t$ztoday$1/m
+	    or die "Couldn't update OLDNEWS file with release date!\n";
     } else {
-	s/^(NEWS for rsync \Q$version\E) \(UNRELEASED\)\s*\n/$1 ($today)\n/m;
-	s/^\t\S\S\s\S\S\S\s\d\d\d\d(\t\Q$version\E)/\t$ztoday$1/m;
+	die "Unrecognized file in \@tweak_files: $fn\n";
     }
     open(OUT, '>', $fn) or die $!;
     print OUT $_;
     close OUT;
 }
 
-system "yodl2man -o rsync.1 rsync.yo";
-system "yodl2man -o rsyncd.conf.5 rsyncd.conf.yo";
-#system "perl -pi -e \"s/\\\\\\'/\\\\&'/g\" rsync.1 rsyncd.conf.5";
+system "yodl2man -o rsync.1 rsync.yo; ./tweak_manpage_dashes rsync.1";
+system "yodl2man -o rsyncd.conf.5 rsyncd.conf.yo; ./tweak_manpage_dashes rsyncd.conf.5";
 
 mkdir('patches/tmp') or die $!;
 system "rsync -a --exclude=patches/ --exclude-from=.cvsignore . patches/tmp/cvsdir/";
 
 print "\n", $break, $note, $break;
 system "patches/verify-patches -n -an$f_opt";
@@ -211,13 +215,13 @@
 my $diff_file = "$dest/$diff_name";
 
 print $break, <<EOT;
 
 About to do the following in the samba-rsync-ftp dir:
     - move the old tar/diff files into the appropriate old-* dirs
-    - copy the moved tar/diff files on samba.org$skipping
+    - hard-link the moved tar/diff files on samba.org$skipping
     - create release tar, "$tar_name"
     - create release diffs, "$diff_name"
     - update README, *NEWS, TODO, and cvs.log
     - update rsync*.html man pages
     - gpg-sign the release files$skipping
 
@@ -237,44 +241,39 @@
 
     print "Shuffling old files ...\n";
 
     # We need to run this regardless of $lastversion's "pre"ness.
     my @moved_files;
     foreach my $fn (glob('rsync*pre*.tar.gz*'), glob('rsync*pre*-NEWS')) {
-	my $new_fn = "old-previews/$fn";
-	rename($fn, $new_fn) or die $!;
-	push(@moved_files, $new_fn);
+	link($fn, "old-previews/$fn") or die $!;
+	push(@moved_files, $fn);
     }
 
     if ($version !~ /pre/) {
 	foreach my $fn (glob('rsync*.tar.gz*'), glob('rsync*-NEWS')) {
 	    next if $fn =~ /^rsync.*pre/;
-	    my $new_fn = "old-versions/$fn";
-	    rename($fn, $new_fn) or die $!;
-	    push(@moved_files, $new_fn);
+	    link($fn, "old-versions/$fn") or die $!;
+	    push(@moved_files, $fn);
+	}
+
+	foreach my $fn (glob('rsync*pre*.diffs.gz*')) {
+	    unlink($fn);
 	}
 
 	foreach my $fn (glob('rsync*.diffs.gz*')) {
-	    next if $fn =~ /^rsync.*pre/;
-	    my $new_fn = "old-patches/$fn";
-	    rename($fn, $new_fn) or die $!;
-	    push(@moved_files, $new_fn);
+	    link($fn, "old-patches/$fn") or die $!;
+	    push(@moved_files, $fn);
 	}
     }
 
     # Optimize our future upload (in the absence of --detect-renamed) by
-    # copying the above moved files on the remote server.
+    # using rsync to hard-link the above files on samba.org.
     if ($live) {
-	my $remote_cmd = '';
-	foreach (@moved_files) {
-	    my($path, $fn) = m#(.*)/([^/]+)$#;
-	    $remote_cmd .= "cp -p /home/ftp/pub/rsync/{$fn,$path};";
-	}
-	system "ssh samba.org '$remote_cmd'";
+	system "rsync -avHOC --include='rsync*.gz*' --include='old-*/' --exclude='*' . samba.org:/home/ftp/pub/rsync";
     }
-    foreach (glob("rsync*pre*.diffs.gz*")) {
+    foreach (@moved_files) {
 	unlink($_);
     }
 
     chdir($releasedir) or die $!;
 }
 
@@ -289,13 +288,13 @@
 print "Creating $diff_file ...\n";
 system "rm -rf rsync-$version rsync-$lastversion";
 system "tar xzf $tar_file; tar xzf $diffdir/rsync-$lastversion.tar.gz";
 ## TWEAK THE VERSIONS AS DESIRED HERE ##
 #mkdir("rsync-$lastversion/support", 0755) or die $!;
 #rename("rsync-$lastversion/rsyncstats", "rsync-$lastversion/support/rsyncstats");
-unlink("rsync-$lastversion/.ignore");
+#unlink("rsync-$lastversion/.ignore");
 ## END ##
 system "diff -urN --exclude=patches rsync-$lastversion rsync-$version| gzip -9 >$diff_file";
 
 print "Updating the other files in $dest ...\n";
 system "rsync -a rsync-$version/{README,NEWS,OLDNEWS,TODO} $dest";
 unlink("$dest/rsync-$version-NEWS");
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/params.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/params.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/params.c	2006-04-02 23:02:02.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/params.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,25 +1,26 @@
-/*
-  This modules is based on the params.c module from Samba, written by Karl Auer
-  and much modifed by Christopher Hertel.
+/* This modules is based on the params.c module from Samba, written by Karl Auer
+   and much modifed by Christopher Hertel. */
 
+/*
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- *
- * -------------------------------------------------------------------------- **
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+/* -------------------------------------------------------------------------- **
  *
  * Module name: params
  *
  * -------------------------------------------------------------------------- **
  *
  *  This module performs lexical analysis and initial parsing of a
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/acls.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/acls.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/acls.diff	2006-04-22 23:40:13.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/acls.diff	2006-11-07 12:41:54.000000000 +0800
@@ -1,26 +1,19 @@
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/acls.diff
     ./prepare-source
     ./configure --enable-acl-support
     make
 
 See the --acls (-A) option in the revised man page for a note on using this
 latest ACL-enabling patch to send files to an older ACL-enabled rsync.
 
-TODO items:
-
-- The -i option does not yet itemize changes in ACL information.
-
-- The --link-dest option might link together two files that differ just
-  in their ACL info, and if that happens the file in the --link-dest dir
-  would get its ACLs updated.
-
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -25,15 +25,15 @@ VERSION=@VERSION@
+@@ -26,15 +26,15 @@ VERSION=@VERSION@
  .SUFFIXES:
  .SUFFIXES: .c .o
  
 -HEADERS=byteorder.h config.h errcode.h proto.h rsync.h lib/pool_alloc.h
 +HEADERS=byteorder.h config.h errcode.h proto.h rsync.h smb_acls.h lib/pool_alloc.h
  LIBOBJ=lib/wildmatch.o lib/compat.o lib/snprintf.o lib/mdfour.o \
@@ -35,222 +28,324 @@
 +	fileio.o batch.o clientname.o chmod.o acls.o
  OBJS3=progress.o pipe.o
  DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o
  popt_OBJS=popt/findme.o  popt/popt.o  popt/poptconfig.o \
 --- old/acls.c
 +++ new/acls.c
-@@ -0,0 +1,1293 @@
-+/* -*- c-file-style: "linux" -*-
-+   Copyright (C) Andrew Tridgell 1996
-+   Copyright (C) Paul Mackerras 1996
-+   Copyright (C) Matt McCutchen 2006
-+   Copyright (C) Wayne Davison 2006
-+
-+   This program is free software; you can redistribute it and/or modify
-+   it under the terms of the GNU General Public License as published by
-+   the Free Software Foundation; either version 2 of the License, or
-+   (at your option) any later version.
-+
-+   This program is distributed in the hope that it will be useful,
-+   but WITHOUT ANY WARRANTY; without even the implied warranty of
-+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-+   GNU General Public License for more details.
-+
-+   You should have received a copy of the GNU General Public License
-+   along with this program; if not, write to the Free Software
-+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-+*/
-+
-+/* handle passing ACLs between systems */
+@@ -0,0 +1,1098 @@
++/*
++ * Handle passing Access Control Lists between systems.
++ *
++ * Copyright (C) 1996 Andrew Tridgell
++ * Copyright (C) 1996 Paul Mackerras
++ * Copyright (C) 2006 Wayne Davison
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License along
++ * with this program; if not, write to the Free Software Foundation, Inc.,
++ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
++ */
 +
 +#include "rsync.h"
 +#include "lib/sysacls.h"
 +
 +#ifdef SUPPORT_ACLS
 +
-+extern int am_root;
 +extern int dry_run;
++extern int read_only;
++extern int list_only;
 +extern int orig_umask;
 +extern int preserve_acls;
++extern unsigned int file_struct_len;
++
++/* === ACL structures === */
 +
 +typedef struct {
 +	id_t id;
 +	uchar access;
 +} id_access;
 +
 +typedef struct {
-+	size_t count;
-+	size_t malloced;
 +	id_access *idas;
-+} ida_list;
++	int count;
++} ida_entries;
 +
-+#define ACL_NO_ENTRY ((uchar)0x80)
-+typedef struct {
-+	ida_list users;
-+	ida_list groups;
-+	/* These will be ACL_NO_ENTRY if there's no such entry. */
++#define NO_ENTRY ((uchar)0x80)
++typedef struct rsync_acl {
++	ida_entries users;
++	ida_entries groups;
++	/* These will be NO_ENTRY if there's no such entry. */
 +	uchar user_obj;
 +	uchar group_obj;
 +	uchar mask;
 +	uchar other;
 +} rsync_acl;
 +
-+static const rsync_acl rsync_acl_initializer = {
-+	{0, 0, NULL}, {0, 0, NULL},
-+	ACL_NO_ENTRY, ACL_NO_ENTRY, ACL_NO_ENTRY, ACL_NO_ENTRY
++typedef struct {
++	rsync_acl racl;
++	SMB_ACL_T sacl;
++} acl_duo;
++
++static const rsync_acl empty_rsync_acl = {
++	{NULL, 0}, {NULL, 0}, NO_ENTRY, NO_ENTRY, NO_ENTRY, NO_ENTRY
 +};
 +
++static item_list access_acl_list = EMPTY_ITEM_LIST;
++static item_list default_acl_list = EMPTY_ITEM_LIST;
++
++/* === Calculations on ACL types === */
++
++static const char *str_acl_type(SMB_ACL_TYPE_T type)
++{
++	return type == SMB_ACL_TYPE_ACCESS ? "SMB_ACL_TYPE_ACCESS"
++	     : type == SMB_ACL_TYPE_DEFAULT ? "SMB_ACL_TYPE_DEFAULT"
++	     : "unknown SMB_ACL_TYPE_T";
++}
++
 +#define OTHER_TYPE(t) (SMB_ACL_TYPE_ACCESS+SMB_ACL_TYPE_DEFAULT-(t))
 +#define BUMP_TYPE(t) ((t = OTHER_TYPE(t)) == SMB_ACL_TYPE_DEFAULT)
 +
-+/* a few useful calculations */
-+
 +static int count_racl_entries(const rsync_acl *racl)
 +{
 +	return racl->users.count + racl->groups.count
-+	     + (racl->user_obj != ACL_NO_ENTRY)
-+	     + (racl->group_obj != ACL_NO_ENTRY)
-+	     + (racl->mask != ACL_NO_ENTRY)
-+	     + (racl->other != ACL_NO_ENTRY);
++	     + (racl->user_obj != NO_ENTRY)
++	     + (racl->group_obj != NO_ENTRY)
++	     + (racl->mask != NO_ENTRY)
++	     + (racl->other != NO_ENTRY);
 +}
 +
 +static int calc_sacl_entries(const rsync_acl *racl)
 +{
++	/* A System ACL always gets user/group/other permission entries. */
 +	return racl->users.count + racl->groups.count
 +#ifdef ACLS_NEED_MASK
 +	     + 4;
 +#else
-+	     + (racl->mask != ACL_NO_ENTRY) + 3;
++	     + (racl->mask != NO_ENTRY) + 3;
 +#endif
 +}
 +
++/* Extracts and returns the permission bits from the ACL.  This cannot be
++ * called on an rsync_acl that has NO_ENTRY in any spot but the mask. */
 +static int rsync_acl_get_perms(const rsync_acl *racl)
 +{
-+	/* Note that (ACL_NO_ENTRY & 7) is 0. */
-+	return ((racl->user_obj & 7) << 6)
-+	     + (((racl->mask != ACL_NO_ENTRY ? racl->mask : racl->group_obj) & 7) << 3)
-+	     + (racl->other & 7);
++	return (racl->user_obj << 6)
++	     + ((racl->mask != NO_ENTRY ? racl->mask : racl->group_obj) << 3)
++	     + racl->other;
 +}
 +
++/* Removes the permission-bit entries from the ACL because these
++ * can be reconstructed from the file's mode. */
 +static void rsync_acl_strip_perms(rsync_acl *racl)
 +{
-+	racl->user_obj = ACL_NO_ENTRY;
-+	if (racl->mask == ACL_NO_ENTRY)
-+		racl->group_obj = ACL_NO_ENTRY;
-+	else
-+		racl->mask = ACL_NO_ENTRY;
-+	racl->other = ACL_NO_ENTRY;
++	racl->user_obj = NO_ENTRY;
++	if (racl->mask == NO_ENTRY)
++		racl->group_obj = NO_ENTRY;
++	else {
++		if (racl->group_obj == racl->mask)
++			racl->group_obj = NO_ENTRY;
++		racl->mask = NO_ENTRY;
++	}
++	racl->other = NO_ENTRY;
 +}
 +
-+static void expand_ida_list(ida_list *idal)
++/* Given an empty rsync_acl, fake up the permission bits. */
++static void rsync_acl_fake_perms(rsync_acl *racl, mode_t mode)
 +{
-+	/* First time through, 0 <= 0, so list is expanded. */
-+	if (idal->malloced <= idal->count) {
-+		id_access *new_ptr;
-+		size_t new_size = idal->malloced + 10;
-+		new_ptr = realloc_array(idal->idas, id_access, new_size);
-+		if (verbose >= 4) {
-+			rprintf(FINFO, "expand rsync_acl to %.0f bytes, did%s move\n",
-+				(double) new_size * sizeof idal->idas[0],
-+				idal->idas ? "" : " not");
-+		}
++	racl->user_obj = (mode >> 6) & 7;
++	racl->group_obj = (mode >> 3) & 7;
++	racl->other = mode & 7;
++}
 +
-+		idal->idas = new_ptr;
-+		idal->malloced = new_size;
++/* === Rsync ACL functions === */
 +
-+		if (!idal->idas)
-+			out_of_memory("expand_ida_list");
++static BOOL ida_entries_equal(const ida_entries *ial1, const ida_entries *ial2)
++{
++	id_access *ida1, *ida2;
++	int count = ial1->count;
++	if (count != ial2->count)
++		return False;
++	ida1 = ial1->idas;
++	ida2 = ial2->idas;
++	for (; count--; ida1++, ida2++) {
++		if (ida1->access != ida2->access || ida1->id != ida2->id)
++			return False;
 +	}
++	return True;
 +}
 +
-+static void ida_list_free(ida_list *idal)
++static BOOL rsync_acl_equal(const rsync_acl *racl1, const rsync_acl *racl2)
 +{
-+	free(idal->idas);
-+	idal->idas = NULL;
-+	idal->count = 0;
-+	idal->malloced = 0;
++	return racl1->user_obj == racl2->user_obj
++	    && racl1->group_obj == racl2->group_obj
++	    && racl1->mask == racl2->mask
++	    && racl1->other == racl2->other
++	    && ida_entries_equal(&racl1->users, &racl2->users)
++	    && ida_entries_equal(&racl1->groups, &racl2->groups);
++}
++
++/* Are the extended (non-permission-bit) entries equal?  If so, the rest of
++ * the ACL will be handled by the normal mode-preservation code.  This is
++ * only meaningful for access ACLs!  Note: the 1st arg is a fully-populated
++ * rsync_acl, but the 2nd parameter can be a condensed rsync_acl, which means
++ * that it might have several of its permission objects set to NO_ENTRY. */
++static BOOL rsync_acl_equal_enough(const rsync_acl *racl1,
++				   const rsync_acl *racl2, mode_t m)
++{
++	if ((racl1->mask ^ racl2->mask) & NO_ENTRY)
++		return False; /* One has a mask and the other doesn't */
++
++	/* When there's a mask, the group_obj becomes an extended entry. */
++	if (racl1->mask != NO_ENTRY) {
++		/* A condensed rsync_acl with a mask can only have no
++		 * group_obj when it was identical to the mask.  This
++		 * means that it was also identical to the group attrs
++		 * from the mode. */
++		if (racl2->group_obj == NO_ENTRY) {
++			if (racl1->group_obj != ((m >> 3) & 7))
++				return False;
++		} else if (racl1->group_obj != racl2->group_obj)
++			return False;
++	}
++	return ida_entries_equal(&racl1->users, &racl2->users)
++	    && ida_entries_equal(&racl1->groups, &racl2->groups);
 +}
 +
 +static void rsync_acl_free(rsync_acl *racl)
 +{
-+	ida_list_free(&racl->users);
-+	ida_list_free(&racl->groups);
++	if (racl->users.idas)
++		free(racl->users.idas);
++	if (racl->groups.idas)
++		free(racl->groups.idas);
++	*racl = empty_rsync_acl;
++}
++
++void free_acl(statx *sxp)
++{
++	if (sxp->acc_acl) {
++		rsync_acl_free(sxp->acc_acl);
++		free(sxp->acc_acl);
++		sxp->acc_acl = NULL;
++	}
++	if (sxp->def_acl) {
++		rsync_acl_free(sxp->def_acl);
++		free(sxp->def_acl);
++		sxp->def_acl = NULL;
++	}
 +}
 +
 +static int id_access_sorter(const void *r1, const void *r2)
 +{
 +	id_access *ida1 = (id_access *)r1;
 +	id_access *ida2 = (id_access *)r2;
 +	id_t rid1 = ida1->id, rid2 = ida2->id;
 +	return rid1 == rid2 ? 0 : rid1 < rid2 ? -1 : 1;
 +}
 +
-+static void sort_ida_list(ida_list *idal)
++static void sort_ida_entries(ida_entries *idal)
 +{
 +	if (!idal->count)
 +		return;
-+	qsort((void **)idal->idas, idal->count, sizeof idal->idas[0],
-+	      &id_access_sorter);
++	qsort(idal->idas, idal->count, sizeof idal->idas[0], id_access_sorter);
 +}
 +
++/* Transfer the count id_access items out of the temp_ida_list into either
++ * the users or groups ida_entries list in racl. */
++static void save_idas(item_list *temp_ida_list, rsync_acl *racl, SMB_ACL_TAG_T type)
++{
++	id_access *idas;
++	ida_entries *ent;
++
++	if (temp_ida_list->count) {
++		int cnt = temp_ida_list->count;
++		id_access *temp_idas = temp_ida_list->items;
++		if (!(idas = new_array(id_access, cnt)))
++			out_of_memory("save_idas");
++		memcpy(idas, temp_idas, cnt * sizeof *temp_idas);
++	} else
++		idas = NULL;
++
++	ent = type == SMB_ACL_USER ? &racl->users : &racl->groups;
++
++	if (ent->count) {
++		rprintf(FERROR, "save_idas: disjoint list found for type %d\n", type);
++		exit_cleanup(RERR_UNSUPPORTED);
++	}
++	ent->count = temp_ida_list->count;
++	ent->idas = idas;
++
++	/* Truncate the temporary list now that its idas have been saved. */
++	temp_ida_list->count = 0;
++}
++
++/* === System ACLs === */
++
++/* Unpack system ACL -> rsync ACL verbatim.  Return whether we succeeded. */
 +static BOOL unpack_smb_acl(rsync_acl *racl, SMB_ACL_T sacl)
 +{
++	static item_list temp_ida_list = EMPTY_ITEM_LIST;
++	SMB_ACL_TAG_T prior_list_type = 0;
 +	SMB_ACL_ENTRY_T entry;
 +	const char *errfun;
 +	int rc;
 +
-+	*racl = rsync_acl_initializer;
 +	errfun = "sys_acl_get_entry";
 +	for (rc = sys_acl_get_entry(sacl, SMB_ACL_FIRST_ENTRY, &entry);
 +	     rc == 1;
 +	     rc = sys_acl_get_entry(sacl, SMB_ACL_NEXT_ENTRY, &entry)) {
 +		SMB_ACL_TAG_T tag_type;
 +		SMB_ACL_PERMSET_T permset;
 +		uchar access;
 +		void *qualifier;
 +		id_access *ida;
-+		ida_list *idal;
 +		if ((rc = sys_acl_get_tag_type(entry, &tag_type))) {
 +			errfun = "sys_acl_get_tag_type";
 +			break;
 +		}
 +		if ((rc = sys_acl_get_permset(entry, &permset))) {
 +			errfun = "sys_acl_get_tag_type";
 +			break;
 +		}
 +		access = (sys_acl_get_perm(permset, SMB_ACL_READ) ? 4 : 0)
 +		       | (sys_acl_get_perm(permset, SMB_ACL_WRITE) ? 2 : 0)
 +		       | (sys_acl_get_perm(permset, SMB_ACL_EXECUTE) ? 1 : 0);
-+		/* continue == done with entry; break == store in given idal */
++		/* continue == done with entry; break == store in temporary ida list */
 +		switch (tag_type) {
 +		case SMB_ACL_USER_OBJ:
-+			if (racl->user_obj == ACL_NO_ENTRY)
++			if (racl->user_obj == NO_ENTRY)
 +				racl->user_obj = access;
 +			else
 +				rprintf(FINFO, "unpack_smb_acl: warning: duplicate USER_OBJ entry ignored\n");
 +			continue;
 +		case SMB_ACL_USER:
-+			idal = &racl->users;
 +			break;
 +		case SMB_ACL_GROUP_OBJ:
-+			if (racl->group_obj == ACL_NO_ENTRY)
++			if (racl->group_obj == NO_ENTRY)
 +				racl->group_obj = access;
 +			else
 +				rprintf(FINFO, "unpack_smb_acl: warning: duplicate GROUP_OBJ entry ignored\n");
 +			continue;
 +		case SMB_ACL_GROUP:
-+			idal = &racl->groups;
 +			break;
 +		case SMB_ACL_MASK:
-+			if (racl->mask == ACL_NO_ENTRY)
++			if (racl->mask == NO_ENTRY)
 +				racl->mask = access;
 +			else
 +				rprintf(FINFO, "unpack_smb_acl: warning: duplicate MASK entry ignored\n");
 +			continue;
 +		case SMB_ACL_OTHER:
-+			if (racl->other == ACL_NO_ENTRY)
++			if (racl->other == NO_ENTRY)
 +				racl->other = access;
 +			else
 +				rprintf(FINFO, "unpack_smb_acl: warning: duplicate OTHER entry ignored\n");
 +			continue;
 +		default:
 +			rprintf(FINFO, "unpack_smb_acl: warning: entry with unrecognized tag type ignored\n");
@@ -258,372 +353,59 @@
 +		}
 +		if (!(qualifier = sys_acl_get_qualifier(entry))) {
 +			errfun = "sys_acl_get_tag_type";
 +			rc = EINVAL;
 +			break;
 +		}
-+		expand_ida_list(idal);
-+		ida = &idal->idas[idal->count++];
++		if (tag_type != prior_list_type) {
++			if (prior_list_type)
++				save_idas(&temp_ida_list, racl, prior_list_type);
++			prior_list_type = tag_type;
++		}
++		ida = EXPAND_ITEM_LIST(&temp_ida_list, id_access, -10);
 +		ida->id = *((id_t *)qualifier);
 +		ida->access = access;
 +		sys_acl_free_qualifier(qualifier, tag_type);
 +	}
 +	if (rc) {
-+		rprintf(FERROR, "unpack_smb_acl: %s(): %s\n",
-+			errfun, strerror(errno));
++		rsyserr(FERROR, errno, "unpack_smb_acl: %s()", errfun);
 +		rsync_acl_free(racl);
 +		return False;
 +	}
++	if (prior_list_type)
++		save_idas(&temp_ida_list, racl, prior_list_type);
 +
-+	sort_ida_list(&racl->users);
-+	sort_ida_list(&racl->groups);
-+
-+	return True;
-+}
-+
-+static BOOL ida_lists_equal(const ida_list *ial1, const ida_list *ial2)
-+{
-+	id_access *ida1, *ida2;
-+	size_t count = ial1->count;
-+	if (count != ial2->count)
-+		return False;
-+	ida1 = ial1->idas;
-+	ida2 = ial2->idas;
-+	for (; count--; ida1++, ida2++) {
-+		if (ida1->access != ida2->access || ida1->id != ida2->id)
-+			return False;
-+	}
-+	return True;
-+}
-+
-+static BOOL rsync_acls_equal(const rsync_acl *racl1, const rsync_acl *racl2)
-+{
-+	return (racl1->user_obj == racl2->user_obj
-+	     && racl1->group_obj == racl2->group_obj
-+	     && racl1->mask == racl2->mask
-+	     && racl1->other == racl2->other
-+	     && ida_lists_equal(&racl1->users, &racl2->users)
-+	     && ida_lists_equal(&racl1->groups, &racl2->groups));
-+}
-+
-+static BOOL rsync_acl_extended_parts_equal(const rsync_acl *racl1, const rsync_acl *racl2)
-+{
-+	/* We ignore any differences that chmod() can take care of. */
-+	if ((racl1->mask ^ racl2->mask) & ACL_NO_ENTRY)
-+		return False;
-+	if (racl1->mask != ACL_NO_ENTRY && racl1->group_obj != racl2->group_obj)
-+		return False;
-+	return ida_lists_equal(&racl1->users, &racl2->users)
-+	    && ida_lists_equal(&racl1->groups, &racl2->groups);
-+}
-+
-+typedef struct {
-+	size_t count;
-+	size_t malloced;
-+	rsync_acl *racls;
-+} rsync_acl_list;
-+
-+static rsync_acl_list _rsync_acl_lists[] = {
-+	{ 0, 0, NULL }, /* SMB_ACL_TYPE_ACCESS */
-+	{ 0, 0, NULL }  /* SMB_ACL_TYPE_DEFAULT */
-+};
-+
-+static inline rsync_acl_list *rsync_acl_lists(SMB_ACL_TYPE_T type)
-+{
-+	return &_rsync_acl_lists[type != SMB_ACL_TYPE_ACCESS];
-+}
-+
-+static void expand_rsync_acl_list(rsync_acl_list *racl_list)
-+{
-+	/* First time through, 0 <= 0, so list is expanded. */
-+	if (racl_list->malloced <= racl_list->count) {
-+		rsync_acl *new_ptr;
-+		size_t new_size;
-+		if (racl_list->malloced < 1000)
-+			new_size = racl_list->malloced + 1000;
-+		else
-+			new_size = racl_list->malloced * 2;
-+		new_ptr = realloc_array(racl_list->racls, rsync_acl, new_size);
-+		if (verbose >= 3) {
-+			rprintf(FINFO, "expand_rsync_acl_list to %.0f bytes, did%s move\n",
-+				(double) new_size * sizeof racl_list->racls[0],
-+				racl_list->racls ? "" : " not");
-+		}
-+
-+		racl_list->racls = new_ptr;
-+		racl_list->malloced = new_size;
-+
-+		if (!racl_list->racls)
-+			out_of_memory("expand_rsync_acl_list");
-+	}
-+}
-+
-+static int find_matching_rsync_acl(SMB_ACL_TYPE_T type,
-+				   const rsync_acl_list *racl_list,
-+				   const rsync_acl *racl)
-+{
-+	static int access_match = -1, default_match = -1;
-+	int *match = type == SMB_ACL_TYPE_ACCESS ? &access_match : &default_match;
-+	size_t count = racl_list->count;
-+
-+	/* If this is the first time through or we didn't match the last
-+	 * time, then start at the end of the list, which should be the
-+	 * best place to start hunting. */
-+	if (*match == -1)
-+		*match = racl_list->count - 1;
-+	while (count--) {
-+		if (rsync_acls_equal(&racl_list->racls[*match], racl))
-+			return *match;
-+		if (!(*match)--)
-+			*match = racl_list->count - 1;
-+	}
-+
-+	*match = -1;
-+	return *match;
-+}
++	sort_ida_entries(&racl->users);
++	sort_ida_entries(&racl->groups);
 +
-+/* The general strategy with the tag_type <-> character mapping is that
-+ * lowercase implies that no qualifier follows, where uppercase does.
-+ * A similar idiom for the acl type (access or default) itself, but
-+ * lowercase in this instance means there's no ACL following, so the
-+ * ACL is a repeat, so the receiver should reuse the last of the same
-+ * type ACL. */
-+static void send_ida_list(int f, const ida_list *idal, char tag_char)
-+{
-+	id_access *ida;
-+	size_t count = idal->count;
-+	for (ida = idal->idas; count--; ida++) {
-+		write_byte(f, tag_char);
-+		write_byte(f, ida->access);
-+		write_int(f, ida->id);
-+		/* FIXME: sorta wasteful: we should maybe buffer as
-+		 * many ids as max(ACL_USER + ACL_GROUP) objects to
-+		 * keep from making so many calls. */
-+		if (tag_char == 'U')
-+			add_uid(ida->id);
-+		else
-+			add_gid(ida->id);
-+	}
-+}
-+
-+static void send_rsync_acl(int f, const rsync_acl *racl)
-+{
-+	size_t count = count_racl_entries(racl);
-+	write_int(f, count);
-+	if (racl->user_obj != ACL_NO_ENTRY) {
-+		write_byte(f, 'u');
-+		write_byte(f, racl->user_obj);
-+	}
-+	send_ida_list(f, &racl->users, 'U');
-+	if (racl->group_obj != ACL_NO_ENTRY) {
-+		write_byte(f, 'g');
-+		write_byte(f, racl->group_obj);
-+	}
-+	send_ida_list(f, &racl->groups, 'G');
-+	if (racl->mask != ACL_NO_ENTRY) {
-+		write_byte(f, 'm');
-+		write_byte(f, racl->mask);
-+	}
-+	if (racl->other != ACL_NO_ENTRY) {
-+		write_byte(f, 'o');
-+		write_byte(f, racl->other);
-+	}
-+}
-+
-+static rsync_acl _curr_rsync_acls[2];
-+
-+static const char *str_acl_type(SMB_ACL_TYPE_T type)
-+{
-+	return type == SMB_ACL_TYPE_ACCESS ? "SMB_ACL_TYPE_ACCESS"
-+	     : type == SMB_ACL_TYPE_DEFAULT ? "SMB_ACL_TYPE_DEFAULT"
-+	     : "unknown SMB_ACL_TYPE_T";
-+}
-+
-+/* Generate the ACL(s) for this flist entry;
-+ * ACL(s) are either sent or cleaned-up by send_acl() below. */
-+int make_acl(const struct file_struct *file, const char *fname)
-+{
-+	SMB_ACL_TYPE_T type;
-+	rsync_acl *curr_racl;
-+
-+	if (S_ISLNK(file->mode))
-+		return 1;
-+
-+	curr_racl = &_curr_rsync_acls[0];
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		SMB_ACL_T sacl;
-+		BOOL ok;
-+		if ((sacl = sys_acl_get_file(fname, type)) != 0) {
-+			ok = unpack_smb_acl(curr_racl, sacl);
-+			sys_acl_free_acl(sacl);
-+			if (!ok)
-+				return -1;
-+			/* Avoid sending a redundant group/mask value. */
-+			if (curr_racl->group_obj == curr_racl->mask
-+			 && (preserve_acls == 1
-+			  || (!curr_racl->users.count
-+			   && !curr_racl->groups.count)))
-+				curr_racl->mask = ACL_NO_ENTRY;
-+			/* Strip access ACLs of permission-bit entries. */
-+			if (type == SMB_ACL_TYPE_ACCESS && preserve_acls == 1)
-+				rsync_acl_strip_perms(curr_racl);
-+		} else if (errno == ENOTSUP) {
-+			/* ACLs are not supported. Leave list empty. */
-+			*curr_racl = rsync_acl_initializer;
-+		} else {
-+			rprintf(FERROR, "send_acl: sys_acl_get_file(%s, %s): %s\n",
-+				fname, str_acl_type(type), strerror(errno));
-+			return -1;
-+		}
-+		curr_racl++;
-+	} while (BUMP_TYPE(type) && S_ISDIR(file->mode));
-+
-+	return 0;
-+}
-+
-+/* Send the make_acl()-generated ACLs for this flist entry,
-+ * or clean up after an flist entry that's not being sent (f == -1). */
-+void send_acl(const struct file_struct *file, int f)
-+{
-+	SMB_ACL_TYPE_T type;
-+	rsync_acl *curr_racl;
-+
-+	if (S_ISLNK(file->mode))
-+		return;
-+
-+	curr_racl = &_curr_rsync_acls[0];
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		int index;
-+		rsync_acl_list *racl_list = rsync_acl_lists(type);
-+		if (f == -1) {
-+			rsync_acl_free(curr_racl);
-+			continue;
-+		}
-+		if ((index = find_matching_rsync_acl(type, racl_list, curr_racl))
-+		    != -1) {
-+			write_byte(f, type == SMB_ACL_TYPE_ACCESS ? 'a' : 'd');
-+			write_int(f, index);
-+			rsync_acl_free(curr_racl);
-+		} else {
-+			write_byte(f, type == SMB_ACL_TYPE_ACCESS ? 'A' : 'D');
-+			send_rsync_acl(f, curr_racl);
-+			expand_rsync_acl_list(racl_list);
-+			racl_list->racls[racl_list->count++] = *curr_racl;
-+		}
-+		curr_racl++;
-+	} while (BUMP_TYPE(type) && S_ISDIR(file->mode));
-+}
-+
-+/* The below stuff is only used by the receiver: */
-+
-+/* structure to hold index to rsync_acl_list member corresponding to
-+ * flist->files[i] */
-+
-+typedef struct {
-+	const struct file_struct *file;
-+	int aclidx;
-+} file_acl_index;
-+
-+typedef struct {
-+	size_t count;
-+	size_t malloced;
-+	file_acl_index *fais;
-+} file_acl_index_list;
-+
-+static file_acl_index_list _file_acl_index_lists[] = {
-+	{0, 0, NULL }, /* SMB_ACL_TYPE_ACCESS */
-+	{0, 0, NULL }  /* SMB_ACL_TYPE_DEFAULT */
-+};
-+
-+static inline file_acl_index_list *file_acl_index_lists(SMB_ACL_TYPE_T type)
-+{
-+	return &_file_acl_index_lists[type != SMB_ACL_TYPE_ACCESS];
-+}
-+
-+static void expand_file_acl_index_list(file_acl_index_list *flst)
-+{
-+	/* First time through, 0 <= 0, so list is expanded. */
-+	if (flst->malloced <= flst->count) {
-+		file_acl_index *new_ptr;
-+		size_t new_size;
-+
-+		if (flst->malloced < 1000)
-+			new_size = flst->malloced + 1000;
-+		else
-+			new_size = flst->malloced * 2;
-+		new_ptr = realloc_array(flst->fais, file_acl_index, new_size);
-+		if (verbose >= 3) {
-+			rprintf(FINFO, "expand_file_acl_index_list to %.0f bytes, did%s move\n",
-+				(double) new_size * sizeof flst->fais[0],
-+				flst->fais ? "" : " not");
-+		}
-+
-+		flst->fais = new_ptr;
-+		flst->malloced = new_size;
-+
-+		if (!flst->fais)
-+			out_of_memory("expand_file_acl_index_list");
++#ifdef ACLS_NEED_MASK
++	if (!racl->users.count && !racl->groups.count && racl->mask != NO_ENTRY) {
++		/* Throw away a superfluous mask, but mask off the
++		 * group perms with it first. */
++		racl->group_obj &= racl->mask;
++		racl->mask = NO_ENTRY;
 +	}
-+}
-+
-+/* lists to hold the SMB_ACL_Ts corresponding to the rsync_acl_list entries */
-+
-+typedef struct {
-+	size_t count;
-+	size_t malloced;
-+	SMB_ACL_T *sacls;
-+} smb_acl_list;
-+
-+static smb_acl_list _smb_acl_lists[] = {
-+	{ 0, 0, NULL }, /* SMB_ACL_TYPE_ACCESS */
-+	{ 0, 0, NULL }  /* SMB_ACL_TYPE_DEFAULT */
-+};
++#endif
 +
-+static inline smb_acl_list *smb_acl_lists(SMB_ACL_TYPE_T type)
-+{
-+	return &_smb_acl_lists[type != SMB_ACL_TYPE_ACCESS];
++	return True;
 +}
 +
-+static void expand_smb_acl_list(smb_acl_list *sacl_list)
-+{
-+	/* First time through, 0 <= 0, so list is expanded. */
-+	if (sacl_list->malloced <= sacl_list->count) {
-+		SMB_ACL_T *new_ptr;
-+		size_t new_size;
-+		if (sacl_list->malloced < 1000)
-+			new_size = sacl_list->malloced + 1000;
-+		else
-+			new_size = sacl_list->malloced * 2;
-+		new_ptr = realloc_array(sacl_list->sacls, SMB_ACL_T, new_size);
-+		if (verbose >= 3) {
-+			rprintf(FINFO, "expand_smb_acl_list to %.0f bytes, did%s move\n",
-+				(double) new_size * sizeof sacl_list->sacls[0],
-+				sacl_list->sacls ? "" : " not");
-+		}
-+
-+		sacl_list->sacls = new_ptr;
-+		sacl_list->malloced = new_size;
-+
-+		if (!sacl_list->sacls)
-+			out_of_memory("expand_smb_acl_list");
-+	}
-+}
++/* Synactic sugar for system calls */
 +
 +#define CALL_OR_ERROR(func,args,str) \
 +	do { \
 +		if (func args) { \
 +			errfun = str; \
 +			goto error_exit; \
 +		} \
 +	} while (0)
 +
 +#define COE(func,args) CALL_OR_ERROR(func,args,#func)
 +#define COE2(func,args) CALL_OR_ERROR(func,args,NULL)
 +
++/* Store the permissions in the system ACL entry. */
 +static int store_access_in_entry(uchar access, SMB_ACL_ENTRY_T entry)
 +{
 +	const char *errfun = NULL;
 +	SMB_ACL_PERMSET_T permset;
 +
 +	COE( sys_acl_get_permset,(entry, &permset) );
@@ -636,169 +418,268 @@
 +		COE( sys_acl_add_perm,(permset, SMB_ACL_EXECUTE) );
 +	COE( sys_acl_set_permset,(entry, permset) );
 +
 +	return 0;
 +
 +  error_exit:
-+	rprintf(FERROR, "store_access_in_entry %s(): %s\n", errfun,
-+		strerror(errno));
++	rsyserr(FERROR, errno, "store_access_in_entry %s()", errfun);
 +	return -1;
 +}
 +
-+/* build an SMB_ACL_T corresponding to an rsync_acl */
++/* Pack rsync ACL -> system ACL verbatim.  Return whether we succeeded. */
 +static BOOL pack_smb_acl(SMB_ACL_T *smb_acl, const rsync_acl *racl)
 +{
++#ifdef ACLS_NEED_MASK
++	uchar mask_bits;
++#endif
 +	size_t count;
 +	id_access *ida;
 +	const char *errfun = NULL;
 +	SMB_ACL_ENTRY_T entry;
 +
 +	if (!(*smb_acl = sys_acl_init(calc_sacl_entries(racl)))) {
-+		rprintf(FERROR, "pack_smb_acl: sys_acl_init(): %s\n",
-+			strerror(errno));
++		rsyserr(FERROR, errno, "pack_smb_acl: sys_acl_init()");
 +		return False;
 +	}
 +
 +	COE( sys_acl_create_entry,(smb_acl, &entry) );
 +	COE( sys_acl_set_tag_type,(entry, SMB_ACL_USER_OBJ) );
 +	COE2( store_access_in_entry,(racl->user_obj & 7, entry) );
 +
-+	for (ida = racl->users.idas, count = racl->users.count;
-+	     count--; ida++) {
++	for (ida = racl->users.idas, count = racl->users.count; count--; ida++) {
 +		COE( sys_acl_create_entry,(smb_acl, &entry) );
 +		COE( sys_acl_set_tag_type,(entry, SMB_ACL_USER) );
 +		COE( sys_acl_set_qualifier,(entry, (void*)&ida->id) );
 +		COE2( store_access_in_entry,(ida->access, entry) );
 +	}
 +
 +	COE( sys_acl_create_entry,(smb_acl, &entry) );
 +	COE( sys_acl_set_tag_type,(entry, SMB_ACL_GROUP_OBJ) );
 +	COE2( store_access_in_entry,(racl->group_obj & 7, entry) );
 +
-+	for (ida = racl->groups.idas, count = racl->groups.count;
-+	     count--; ida++) {
++	for (ida = racl->groups.idas, count = racl->groups.count; count--; ida++) {
 +		COE( sys_acl_create_entry,(smb_acl, &entry) );
 +		COE( sys_acl_set_tag_type,(entry, SMB_ACL_GROUP) );
 +		COE( sys_acl_set_qualifier,(entry, (void*)&ida->id) );
 +		COE2( store_access_in_entry,(ida->access, entry) );
 +	}
-+#ifndef ACLS_NEED_MASK
-+	if (racl->mask != ACL_NO_ENTRY) {
-+#endif
++
++#ifdef ACLS_NEED_MASK
++	mask_bits = racl->mask == NO_ENTRY ? racl->group_obj & 7 : racl->mask;
++	COE( sys_acl_create_entry,(smb_acl, &entry) );
++	COE( sys_acl_set_tag_type,(entry, SMB_ACL_MASK) );
++	COE2( store_access_in_entry,(mask_bits, entry) );
++#else
++	if (racl->mask != NO_ENTRY) {
 +		COE( sys_acl_create_entry,(smb_acl, &entry) );
 +		COE( sys_acl_set_tag_type,(entry, SMB_ACL_MASK) );
 +		COE2( store_access_in_entry,(racl->mask, entry) );
-+#ifndef ACLS_NEED_MASK
 +	}
 +#endif
 +
 +	COE( sys_acl_create_entry,(smb_acl, &entry) );
 +	COE( sys_acl_set_tag_type,(entry, SMB_ACL_OTHER) );
 +	COE2( store_access_in_entry,(racl->other & 7, entry) );
 +
 +#ifdef DEBUG
 +	if (sys_acl_valid(*smb_acl) < 0)
-+		rprintf(FINFO, "pack_smb_acl: warning: system says the ACL I packed is invalid\n");
++		rprintf(FERROR, "pack_smb_acl: warning: system says the ACL I packed is invalid\n");
 +#endif
 +
 +	return True;
 +
 +  error_exit:
 +	if (errfun) {
-+		rprintf(FERROR, "pack_smb_acl %s(): %s\n", errfun,
-+			strerror(errno));
++		rsyserr(FERROR, errno, "pack_smb_acl %s()", errfun);
 +	}
 +	sys_acl_free_acl(*smb_acl);
 +	return False;
 +}
 +
-+static mode_t change_sacl_perms(SMB_ACL_T sacl, rsync_acl *racl, mode_t old_mode, mode_t mode)
++static int find_matching_rsync_acl(SMB_ACL_TYPE_T type,
++				   const item_list *racl_list,
++				   const rsync_acl *racl)
 +{
-+	SMB_ACL_ENTRY_T entry;
-+	const char *errfun;
-+	int rc;
++	static int access_match = -1, default_match = -1;
++	int *match = type == SMB_ACL_TYPE_ACCESS ? &access_match : &default_match;
++	size_t count = racl_list->count;
 +
-+	if (S_ISDIR(mode)) {
-+		/* If the sticky bit is going on, it's not safe to allow all
-+		 * the new ACLs to go into effect before it gets set. */
-+#ifdef SMB_ACL_LOSES_SPECIAL_MODE_BITS
-+		if (mode & S_ISVTX)
-+			mode &= ~0077;
-+#else
-+		if (mode & S_ISVTX && !(old_mode & S_ISVTX))
-+			mode &= ~0077;
-+	} else {
-+		/* If setuid or setgid is going off, it's not safe to allow all
-+		 * the new ACLs to go into effect before they get cleared. */
-+		if ((old_mode & S_ISUID && !(mode & S_ISUID))
-+		 || (old_mode & S_ISGID && !(mode & S_ISGID)))
-+			mode &= ~0077;
-+#endif
++	/* If this is the first time through or we didn't match the last
++	 * time, then start at the end of the list, which should be the
++	 * best place to start hunting. */
++	if (*match == -1)
++		*match = racl_list->count - 1;
++	while (count--) {
++		rsync_acl *base = racl_list->items;
++		if (rsync_acl_equal(base + *match, racl))
++			return *match;
++		if (!(*match)--)
++			*match = racl_list->count - 1;
 +	}
 +
-+	errfun = "sys_acl_get_entry";
-+	for (rc = sys_acl_get_entry(sacl, SMB_ACL_FIRST_ENTRY, &entry);
-+	     rc == 1;
-+	     rc = sys_acl_get_entry(sacl, SMB_ACL_NEXT_ENTRY, &entry)) {
-+		SMB_ACL_TAG_T tag_type;
-+		if ((rc = sys_acl_get_tag_type(entry, &tag_type))) {
-+			errfun = "sys_acl_get_tag_type";
-+			break;
-+		}
-+		switch (tag_type) {
-+		case SMB_ACL_USER_OBJ:
-+			COE2( store_access_in_entry,((mode >> 6) & 7, entry) );
-+			break;
-+		case SMB_ACL_GROUP_OBJ:
-+			/* group is only empty when identical to group perms. */
-+			if (racl->group_obj != ACL_NO_ENTRY)
-+				break;
-+			COE2( store_access_in_entry,((mode >> 3) & 7, entry) );
-+			break;
-+		case SMB_ACL_MASK:
-+#ifndef ACLS_NEED_MASK
-+			/* mask is only empty when we don't need it. */
-+			if (racl->mask == ACL_NO_ENTRY)
-+				break;
-+#endif
-+			COE2( store_access_in_entry,((mode >> 3) & 7, entry) );
-+			break;
-+		case SMB_ACL_OTHER:
-+			COE2( store_access_in_entry,(mode & 7, entry) );
-+			break;
++	*match = -1;
++	return *match;
++}
++
++/* Return the Access Control List for the given filename. */
++int get_acl(const char *fname, statx *sxp)
++{
++	SMB_ACL_TYPE_T type;
++
++	if (S_ISLNK(sxp->st.st_mode))
++		return 0;
++
++	type = SMB_ACL_TYPE_ACCESS;
++	do {
++		SMB_ACL_T sacl = sys_acl_get_file(fname, type);
++		rsync_acl *racl = new(rsync_acl);
++
++		if (!racl)
++			out_of_memory("get_acl");
++		*racl = empty_rsync_acl;
++		if (type == SMB_ACL_TYPE_ACCESS)
++			sxp->acc_acl = racl;
++		else
++			sxp->def_acl = racl;
++
++		if (sacl) {
++			BOOL ok = unpack_smb_acl(racl, sacl);
++
++			sys_acl_free_acl(sacl);
++			if (!ok) {
++				free_acl(sxp);
++				return -1;
++			}
++		} else if (errno == ENOTSUP) {
++			/* ACLs are not supported, so pretend we have a basic ACL. */
++			if (type == SMB_ACL_TYPE_ACCESS)
++				rsync_acl_fake_perms(racl, sxp->st.st_mode);
++		} else {
++			rsyserr(FERROR, errno, "get_acl: sys_acl_get_file(%s, %s)",
++				fname, str_acl_type(type));
++			free_acl(sxp);
++			return -1;
 +		}
++	} while (BUMP_TYPE(type) && S_ISDIR(sxp->st.st_mode));
++
++	return 0;
++}
++
++/* === Send functions === */
++
++/* The general strategy with the tag_type <-> character mapping is that
++ * lowercase implies that no qualifier follows, where uppercase does.
++ * A similar idiom for the ACL type (access or default) itself, but
++ * lowercase in this instance means there's no ACL following, so the
++ * ACL is a repeat, so the receiver should reuse the last of the same
++ * type ACL. */
++
++/* Send the ida list over the file descriptor. */
++static void send_ida_entries(int f, const ida_entries *idal, char tag_char)
++{
++	id_access *ida;
++	size_t count = idal->count;
++	for (ida = idal->idas; count--; ida++) {
++		write_byte(f, tag_char);
++		write_byte(f, ida->access);
++		write_int(f, ida->id);
++		/* FIXME: sorta wasteful: we should maybe buffer as
++		 * many ids as max(ACL_USER + ACL_GROUP) objects to
++		 * keep from making so many calls. */
++		if (tag_char == 'U')
++			add_uid(ida->id);
++		else
++			add_gid(ida->id);
 +	}
-+	if (rc) {
-+	  error_exit:
-+		if (errfun) {
-+			rprintf(FERROR, "change_sacl_perms: %s(): %s\n",
-+				errfun, strerror(errno));
-+		}
-+		return ~0u;
++}
++
++/* Send an rsync ACL over the file descriptor. */
++static void send_rsync_acl(int f, const rsync_acl *racl)
++{
++	size_t count = count_racl_entries(racl);
++	write_int(f, count);
++	if (racl->user_obj != NO_ENTRY) {
++		write_byte(f, 'u');
++		write_byte(f, racl->user_obj);
 +	}
++	send_ida_entries(f, &racl->users, 'U');
++	if (racl->group_obj != NO_ENTRY) {
++		write_byte(f, 'g');
++		write_byte(f, racl->group_obj);
++	}
++	send_ida_entries(f, &racl->groups, 'G');
++	if (racl->mask != NO_ENTRY) {
++		write_byte(f, 'm');
++		write_byte(f, racl->mask);
++	}
++	if (racl->other != NO_ENTRY) {
++		write_byte(f, 'o');
++		write_byte(f, racl->other);
++	}
++}
 +
-+#ifdef SMB_ACL_LOSES_SPECIAL_MODE_BITS
-+	/* Ensure that chmod() will be called to restore any lost setid bits. */
-+	if (old_mode & (S_ISUID | S_ISGID | S_ISVTX)
-+	 && (old_mode & CHMOD_BITS) == (mode & CHMOD_BITS))
-+		old_mode &= ~(S_ISUID | S_ISGID | S_ISVTX);
-+#endif
++/* Send the ACL from the statx structure down the indicated file descriptor.
++ * This also frees the ACL data. */
++void send_acl(statx *sxp, int f)
++{
++	SMB_ACL_TYPE_T type;
++	rsync_acl *racl, *new_racl;
++	item_list *racl_list;
++	int ndx;
 +
-+	/* Return the mode of the file on disk, as we will set them. */
-+	return (old_mode & ~ACCESSPERMS) | (mode & ACCESSPERMS);
++	if (S_ISLNK(sxp->st.st_mode))
++		return;
++
++	type = SMB_ACL_TYPE_ACCESS;
++	racl = sxp->acc_acl;
++	racl_list = &access_acl_list;
++	do {
++		if (!racl) {
++			racl = new(rsync_acl);
++			if (!racl)
++				out_of_memory("send_acl");
++			*racl = empty_rsync_acl;
++			if (type == SMB_ACL_TYPE_ACCESS) {
++				rsync_acl_fake_perms(racl, sxp->st.st_mode);
++				sxp->acc_acl = racl;
++			} else
++				sxp->def_acl = racl;
++		}
++
++		/* Avoid sending values that can be inferred from other data,
++		 * but only when preserve_acls == 1 (it is 2 when we must be
++		 * backward compatible with older acls.diff versions). */
++		if (type == SMB_ACL_TYPE_ACCESS && preserve_acls == 1)
++			rsync_acl_strip_perms(racl);
++		if ((ndx = find_matching_rsync_acl(type, racl_list, racl)) != -1) {
++			write_byte(f, type == SMB_ACL_TYPE_ACCESS ? 'a' : 'd');
++			write_int(f, ndx);
++		} else {
++			new_racl = EXPAND_ITEM_LIST(racl_list, rsync_acl, 1000);
++			write_byte(f, type == SMB_ACL_TYPE_ACCESS ? 'A' : 'D');
++			send_rsync_acl(f, racl);
++			*new_racl = *racl;
++			*racl = empty_rsync_acl;
++		}
++		racl = sxp->def_acl;
++		racl_list = &default_acl_list;
++	} while (BUMP_TYPE(type) && S_ISDIR(sxp->st.st_mode));
++
++	free_acl(sxp);
 +}
 +
++/* === Receive functions === */
++
 +static void receive_rsync_acl(rsync_acl *racl, int f, SMB_ACL_TYPE_T type)
 +{
++	static item_list temp_ida_list = EMPTY_ITEM_LIST;
++	SMB_ACL_TAG_T tag_type = 0, prior_list_type = 0;
 +	uchar computed_mask_bits = 0;
-+	ida_list *idal = NULL;
 +	id_access *ida;
 +	size_t count;
 +
-+	*racl = rsync_acl_initializer;
-+
 +	if (!(count = read_int(f)))
 +		return;
 +
 +	while (count--) {
 +		char tag = read_byte(f);
 +		uchar access = read_byte(f);
@@ -806,456 +687,371 @@
 +			rprintf(FERROR, "receive_rsync_acl: bogus permset %o\n",
 +				access);
 +			exit_cleanup(RERR_STREAMIO);
 +		}
 +		switch (tag) {
 +		case 'u':
-+			if (racl->user_obj != ACL_NO_ENTRY) {
++			if (racl->user_obj != NO_ENTRY) {
 +				rprintf(FERROR, "receive_rsync_acl: error: duplicate USER_OBJ entry\n");
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +			racl->user_obj = access;
 +			continue;
 +		case 'U':
-+			idal = &racl->users;
++			tag_type = SMB_ACL_USER;
 +			break;
 +		case 'g':
-+			if (racl->group_obj != ACL_NO_ENTRY) {
++			if (racl->group_obj != NO_ENTRY) {
 +				rprintf(FERROR, "receive_rsync_acl: error: duplicate GROUP_OBJ entry\n");
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +			racl->group_obj = access;
 +			continue;
 +		case 'G':
-+			idal = &racl->groups;
++			tag_type = SMB_ACL_GROUP;
 +			break;
 +		case 'm':
-+			if (racl->mask != ACL_NO_ENTRY) {
++			if (racl->mask != NO_ENTRY) {
 +				rprintf(FERROR, "receive_rsync_acl: error: duplicate MASK entry\n");
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +			racl->mask = access;
 +			continue;
 +		case 'o':
-+			if (racl->other != ACL_NO_ENTRY) {
++			if (racl->other != NO_ENTRY) {
 +				rprintf(FERROR, "receive_rsync_acl: error: duplicate OTHER entry\n");
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +			racl->other = access;
 +			continue;
 +		default:
 +			rprintf(FERROR, "receive_rsync_acl: unknown tag %c\n",
 +				tag);
 +			exit_cleanup(RERR_STREAMIO);
 +		}
-+		expand_ida_list(idal);
-+		ida = &idal->idas[idal->count++];
++		if (tag_type != prior_list_type) {
++			if (prior_list_type)
++				save_idas(&temp_ida_list, racl, prior_list_type);
++			prior_list_type = tag_type;
++		}
++		ida = EXPAND_ITEM_LIST(&temp_ida_list, id_access, -10);
 +		ida->access = access;
 +		ida->id = read_int(f);
 +		computed_mask_bits |= access;
 +	}
++	if (prior_list_type)
++		save_idas(&temp_ida_list, racl, prior_list_type);
 +
 +	if (type == SMB_ACL_TYPE_DEFAULT) {
 +		/* Ensure that these are never unset. */
-+		if (racl->user_obj == ACL_NO_ENTRY)
++		if (racl->user_obj == NO_ENTRY)
 +			racl->user_obj = 7;
-+		if (racl->group_obj == ACL_NO_ENTRY)
++		if (racl->group_obj == NO_ENTRY)
 +			racl->group_obj = 0;
-+		if (racl->other == ACL_NO_ENTRY)
++		if (racl->other == NO_ENTRY)
 +			racl->other = 0;
 +	}
-+#ifndef ACLS_NEED_MASK
++
 +	if (!racl->users.count && !racl->groups.count) {
-+		/* If we, a system without ACLS_NEED_MASK, received a
-+		 * superfluous mask, throw it away. */
-+		if (racl->mask != ACL_NO_ENTRY) {
-+			/* mask off group perms with it first */
-+			racl->group_obj &= racl->mask | ACL_NO_ENTRY;
-+			racl->mask = ACL_NO_ENTRY;
++		/* If we received a superfluous mask, throw it away. */
++		if (racl->mask != NO_ENTRY) {
++			/* Mask off the group perms with it first. */
++			racl->group_obj &= racl->mask | NO_ENTRY;
++			racl->mask = NO_ENTRY;
 +		}
-+	} else
-+#endif
-+	if (racl->mask == ACL_NO_ENTRY) /* Always non-empty when needed. */
++	} else if (racl->mask == NO_ENTRY) /* Must be non-empty with lists. */
 +		racl->mask = computed_mask_bits | (racl->group_obj & 7);
 +}
 +
-+/* receive and build the rsync_acl_lists */
++/* Receive the ACL info the sender has included for this file-list entry. */
 +void receive_acl(struct file_struct *file, int f)
 +{
 +	SMB_ACL_TYPE_T type;
-+	char *fname;
++	item_list *racl_list;
++	char *ndx_ptr;
 +
 +	if (S_ISLNK(file->mode))
 +		return;
 +
-+	fname = f_name(file, NULL);
 +	type = SMB_ACL_TYPE_ACCESS;
++	racl_list = &access_acl_list;
++	ndx_ptr = (char*)file + file_struct_len;
 +	do {
-+		char tag;
-+		file_acl_index_list *flst = file_acl_index_lists(type);
-+
-+		expand_file_acl_index_list(flst);
++		char tag = read_byte(f);
++		int ndx;
 +
-+		tag = read_byte(f);
 +		if (tag == 'A' || tag == 'a') {
 +			if (type != SMB_ACL_TYPE_ACCESS) {
 +				rprintf(FERROR, "receive_acl %s: duplicate access ACL\n",
-+					fname);
++					f_name(file, NULL));
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +		} else if (tag == 'D' || tag == 'd') {
 +			if (type == SMB_ACL_TYPE_ACCESS) {
 +				rprintf(FERROR, "receive_acl %s: expecting access ACL; got default\n",
-+					fname);
++					f_name(file, NULL));
 +				exit_cleanup(RERR_STREAMIO);
 +			}
 +		} else {
 +			rprintf(FERROR, "receive_acl %s: unknown ACL type tag: %c\n",
-+				fname, tag);
++				f_name(file, NULL), tag);
 +			exit_cleanup(RERR_STREAMIO);
 +		}
 +		if (tag == 'A' || tag == 'D') {
-+			rsync_acl racl;
-+			rsync_acl_list *racl_list = rsync_acl_lists(type);
-+			smb_acl_list *sacl_list = smb_acl_lists(type);
-+			flst->fais[flst->count].aclidx = racl_list->count;
-+			flst->fais[flst->count++].file = file;
-+			receive_rsync_acl(&racl, f, type);
-+			expand_rsync_acl_list(racl_list);
-+			racl_list->racls[racl_list->count++] = racl;
-+			expand_smb_acl_list(sacl_list);
-+			sacl_list->sacls[sacl_list->count++] = NULL;
++			acl_duo *duo_item;
++			ndx = racl_list->count;
++			duo_item = EXPAND_ITEM_LIST(racl_list, acl_duo, 1000);
++			duo_item->racl = empty_rsync_acl;
++			receive_rsync_acl(&duo_item->racl, f, type);
++			duo_item->sacl = NULL;
 +		} else {
-+			int index = read_int(f);
-+			rsync_acl_list *racl_list = rsync_acl_lists(type);
-+			if ((size_t) index >= racl_list->count) {
++			ndx = read_int(f);
++			if (ndx < 0 || (size_t)ndx >= racl_list->count) {
 +				rprintf(FERROR, "receive_acl %s: %s ACL index %d out of range\n",
-+					fname,
-+					str_acl_type(type),
-+					index);
++					f_name(file, NULL), str_acl_type(type), ndx);
 +				exit_cleanup(RERR_STREAMIO);
 +			}
-+			flst->fais[flst->count].aclidx = index;
-+			flst->fais[flst->count++].file = file;
 +		}
++		SIVAL(ndx_ptr, 0, ndx);
++		racl_list = &default_acl_list;
++		ndx_ptr += 4;
 +	} while (BUMP_TYPE(type) && S_ISDIR(file->mode));
 +}
 +
-+static int file_acl_index_list_sorter(const void *f1, const void *f2)
-+{
-+	const file_acl_index *fileaclidx1 = (const file_acl_index *)f1;
-+	const file_acl_index *fileaclidx2 = (const file_acl_index *)f2;
-+	return fileaclidx1->file == fileaclidx2->file ? 0
-+	     : fileaclidx1->file < fileaclidx2->file ? -1 : 1;
-+}
-+
-+void sort_file_acl_index_lists()
++/* Turn the ACL data in statx into cached ACL data, setting the index
++ * values in the file struct. */
++void cache_acl(struct file_struct *file, statx *sxp)
 +{
 +	SMB_ACL_TYPE_T type;
++	rsync_acl *racl;
++	item_list *racl_list;
++	char *ndx_ptr;
++	int ndx;
 +
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		file_acl_index_list *flst = file_acl_index_lists(type);
-+
-+		if (!flst->count)
-+			continue;
-+
-+		qsort(flst->fais, flst->count, sizeof flst->fais[0],
-+		      &file_acl_index_list_sorter);
-+	} while (BUMP_TYPE(type));
-+}
-+
-+static int find_file_acl_index(const file_acl_index_list *flst,
-+			       const struct file_struct *file)
-+{
-+	int low = 0, high = flst->count;
-+	const struct file_struct *file_mid;
-+
-+	if (!high--)
-+		return -1;
-+	do {
-+		int mid = (high + low) / 2;
-+		file_mid = flst->fais[mid].file;
-+		if (file_mid == file)
-+			return flst->fais[mid].aclidx;
-+		if (file_mid > file)
-+			high = mid - 1;
-+		else
-+			low = mid + 1;
-+	} while (low < high);
-+	if (low == high) {
-+		file_mid = flst->fais[low].file;
-+		if (file_mid == file)
-+			return flst->fais[low].aclidx;
-+	}
-+	rprintf(FERROR,
-+		"find_file_acl_index: can't find entry for file in list\n");
-+	exit_cleanup(RERR_STREAMIO);
-+	return -1;
-+}
-+
-+/* for duplicating ACLs on backups when using backup_dir */
-+int dup_acl(const char *orig, const char *bak, mode_t mode)
-+{
-+	SMB_ACL_TYPE_T type;
-+	int ret = 0;
++	if (S_ISLNK(file->mode))
++		return;
 +
 +	type = SMB_ACL_TYPE_ACCESS;
++	racl = sxp->acc_acl;
++	racl_list = &access_acl_list;
++	ndx_ptr = (char*)file + file_struct_len;
 +	do {
-+		SMB_ACL_T sacl_orig, sacl_bak;
-+		rsync_acl racl_orig, racl_bak;
-+		if (!(sacl_orig = sys_acl_get_file(orig, type))) {
-+			rprintf(FERROR, "dup_acl: sys_acl_get_file(%s, %s): %s\n",
-+				orig, str_acl_type(type), strerror(errno));
-+			ret = -1;
-+			continue;
-+		}
-+		if (!(sacl_bak = sys_acl_get_file(orig, type))) {
-+			rprintf(FERROR, "dup_acl: sys_acl_get_file(%s, %s): %s. ignoring\n",
-+				bak, str_acl_type(type), strerror(errno));
-+			ret = -1;
-+			/* try to forge on through */
-+		}
-+		if (!unpack_smb_acl(&racl_orig, sacl_orig)) {
-+			ret = -1;
-+			goto out_with_sacls;
-+		}
-+		if (sacl_bak) {
-+			if (!unpack_smb_acl(&racl_bak, sacl_bak)) {
-+				ret = -1;
-+				goto out_with_one_racl;
-+			}
-+			if (rsync_acls_equal(&racl_orig, &racl_bak))
-+				goto out_with_all;
-+		} else {
-+			; /* presume they're unequal */
-+		}
-+		if (type == SMB_ACL_TYPE_DEFAULT
-+		 && racl_orig.user_obj == ACL_NO_ENTRY) {
-+			if (sys_acl_delete_def_file(bak) < 0) {
-+				rprintf(FERROR, "dup_acl: sys_acl_delete_def_file(%s): %s\n",
-+					bak, strerror(errno));
-+				ret = -1;
-+			}
-+		} else if (sys_acl_set_file(bak, type, sacl_bak) < 0) {
-+			rprintf(FERROR, "dup_acl: sys_acl_set_file(%s, %s): %s\n",
-+				bak, str_acl_type(type), strerror(errno));
-+			ret = -1;
-+		}
-+		out_with_all:
-+			if (sacl_bak)
-+				rsync_acl_free(&racl_bak);
-+		out_with_one_racl:
-+			rsync_acl_free(&racl_orig);
-+		out_with_sacls:
-+			if (sacl_bak)
-+				sys_acl_free_acl(sacl_bak);
-+		/* out_with_one_sacl: */
-+			if (sacl_orig)
-+				sys_acl_free_acl(sacl_orig);
-+	} while (BUMP_TYPE(type) && S_ISDIR(mode));
++		if (!racl)
++			ndx = -1;
++		else if ((ndx = find_matching_rsync_acl(type, racl_list, racl)) == -1) {
++			acl_duo *new_duo;
++			ndx = racl_list->count;
++			new_duo = EXPAND_ITEM_LIST(racl_list, acl_duo, 1000);
++			new_duo->racl = *racl;
++			new_duo->sacl = NULL;
++			*racl = empty_rsync_acl;
++		}
++		SIVAL(ndx_ptr, 0, ndx);
++		racl = sxp->def_acl;
++		racl_list = &default_acl_list;
++		ndx_ptr += 4;
++	} while (BUMP_TYPE(type) && S_ISDIR(sxp->st.st_mode));
 +
-+	return ret;
++	free_acl(sxp);
 +}
 +
-+/* Stuff for redirecting calls to set_acl() from set_file_attrs()
-+ * for keep_backup(). */
-+static const struct file_struct *backup_orig_file = NULL;
-+static const char null_string[] = "";
-+static const char *backup_orig_fname = null_string;
-+static const char *backup_dest_fname = null_string;
-+static SMB_ACL_T _backup_sacl[] = { NULL, NULL };
-+
-+void push_keep_backup_acl(const struct file_struct *file,
-+			  const char *orig, const char *dest)
++static mode_t change_sacl_perms(SMB_ACL_T sacl, rsync_acl *racl, mode_t old_mode, mode_t mode)
 +{
-+	SMB_ACL_TYPE_T type;
-+	SMB_ACL_T *sacl;
++	SMB_ACL_ENTRY_T entry;
++	const char *errfun;
++	int rc;
 +
-+	backup_orig_file = file;
-+	backup_orig_fname = orig;
-+	backup_dest_fname = dest;
++	if (S_ISDIR(mode)) {
++		/* If the sticky bit is going on, it's not safe to allow all
++		 * the new ACL to go into effect before it gets set. */
++#ifdef SMB_ACL_LOSES_SPECIAL_MODE_BITS
++		if (mode & S_ISVTX)
++			mode &= ~0077;
++#else
++		if (mode & S_ISVTX && !(old_mode & S_ISVTX))
++			mode &= ~0077;
++	} else {
++		/* If setuid or setgid is going off, it's not safe to allow all
++		 * the new ACL to go into effect before they get cleared. */
++		if ((old_mode & S_ISUID && !(mode & S_ISUID))
++		 || (old_mode & S_ISGID && !(mode & S_ISGID)))
++			mode &= ~0077;
++#endif
++	}
 +
-+	sacl = &_backup_sacl[0];
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		if (type == SMB_ACL_TYPE_DEFAULT && !S_ISDIR(file->mode)) {
-+			*sacl = NULL;
++	errfun = "sys_acl_get_entry";
++	for (rc = sys_acl_get_entry(sacl, SMB_ACL_FIRST_ENTRY, &entry);
++	     rc == 1;
++	     rc = sys_acl_get_entry(sacl, SMB_ACL_NEXT_ENTRY, &entry)) {
++		SMB_ACL_TAG_T tag_type;
++		if ((rc = sys_acl_get_tag_type(entry, &tag_type))) {
++			errfun = "sys_acl_get_tag_type";
++			break;
++		}
++		switch (tag_type) {
++		case SMB_ACL_USER_OBJ:
++			COE2( store_access_in_entry,((mode >> 6) & 7, entry) );
++			break;
++		case SMB_ACL_GROUP_OBJ:
++			/* group is only empty when identical to group perms. */
++			if (racl->group_obj != NO_ENTRY)
++				break;
++			COE2( store_access_in_entry,((mode >> 3) & 7, entry) );
++			break;
++		case SMB_ACL_MASK:
++#ifndef ACLS_NEED_MASK
++			/* mask is only empty when we don't need it. */
++			if (racl->mask == NO_ENTRY)
++				break;
++#endif
++			COE2( store_access_in_entry,((mode >> 3) & 7, entry) );
++			break;
++		case SMB_ACL_OTHER:
++			COE2( store_access_in_entry,(mode & 7, entry) );
 +			break;
 +		}
-+		if (!(*sacl = sys_acl_get_file(orig, type))) {
-+			rprintf(FERROR,
-+				"push_keep_backup_acl: sys_acl_get_file(%s, %s): %s\n",
-+				orig, str_acl_type(type),
-+				strerror(errno));
-+		}
-+	} while (BUMP_TYPE(type));
-+}
-+
-+static int set_keep_backup_acl()
-+{
-+	SMB_ACL_TYPE_T type;
-+	SMB_ACL_T *sacl;
-+	int ret = 0;
-+
-+	sacl = &_backup_sacl[0];
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		if (*sacl
-+		 && sys_acl_set_file(backup_dest_fname, type, *sacl) < 0) {
-+			rprintf(FERROR,
-+				"push_keep_backup_acl: sys_acl_get_file(%s, %s): %s\n",
-+				backup_dest_fname,
-+				str_acl_type(type),
-+				strerror(errno));
-+			ret = -1;
++	}
++	if (rc) {
++	  error_exit:
++		if (errfun) {
++			rsyserr(FERROR, errno, "change_sacl_perms: %s()",
++				errfun);
 +		}
-+	} while (BUMP_TYPE(type));
-+
-+	return ret;
-+}
-+
-+void cleanup_keep_backup_acl()
-+{
-+	SMB_ACL_TYPE_T type;
-+	SMB_ACL_T *sacl;
++		return (mode_t)~0;
++	}
 +
-+	backup_orig_file = NULL;
-+	backup_orig_fname = null_string;
-+	backup_dest_fname = null_string;
++#ifdef SMB_ACL_LOSES_SPECIAL_MODE_BITS
++	/* Ensure that chmod() will be called to restore any lost setid bits. */
++	if (old_mode & (S_ISUID | S_ISGID | S_ISVTX)
++	 && (old_mode & CHMOD_BITS) == (mode & CHMOD_BITS))
++		old_mode &= ~(S_ISUID | S_ISGID | S_ISVTX);
++#endif
 +
-+	sacl = &_backup_sacl[0];
-+	type = SMB_ACL_TYPE_ACCESS;
-+	do {
-+		if (*sacl) {
-+			sys_acl_free_acl(*sacl);
-+			*sacl = NULL;
-+		}
-+	} while (BUMP_TYPE(type));
++	/* Return the mode of the file on disk, as we will set them. */
++	return (old_mode & ~ACCESSPERMS) | (mode & ACCESSPERMS);
 +}
 +
-+/* set ACL on rsync-ed or keep_backup-ed file
++/* Set ACL on indicated filename.
 + *
-+ * This sets extended access ACL entries and default ACLs.  If convenient,
-+ * it sets permission bits along with the access ACLs and signals having
-+ * done so by modifying mode_p, which should point into the stat buffer.
++ * This sets extended access ACL entries and default ACL.  If convenient,
++ * it sets permission bits along with the access ACL and signals having
++ * done so by modifying sxp->st.st_mode.
 + *
-+ * returns: 1 for unchanged, 0 for changed, -1 for failed
-+ * Pass NULL for mode_p to get the return code without changing anything. */
-+int set_acl(const char *fname, const struct file_struct *file, mode_t *mode_p)
++ * Returns 1 for unchanged, 0 for changed, -1 for failed.  Call this
++ * with fname set to NULL to just check if the ACL is unchanged. */
++int set_acl(const char *fname, const struct file_struct *file, statx *sxp)
 +{
 +	int unchanged = 1;
 +	SMB_ACL_TYPE_T type;
++	char *ndx_ptr;
++
++	if (!dry_run && (read_only || list_only)) {
++		errno = EROFS;
++		return -1;
++	}
 +
 +	if (S_ISLNK(file->mode))
 +		return 1;
 +
-+	if (file == backup_orig_file) {
-+		if (!strcmp(fname, backup_dest_fname))
-+			return set_keep_backup_acl();
-+	}
 +	type = SMB_ACL_TYPE_ACCESS;
++	ndx_ptr = (char*)file + file_struct_len;
 +	do {
-+		BOOL ok;
-+		SMB_ACL_T sacl_orig, *sacl_new;
-+		rsync_acl racl_orig, *racl_new;
-+		int aclidx = find_file_acl_index(file_acl_index_lists(type), file);
-+
-+		racl_new = &(rsync_acl_lists(type)->racls[aclidx]);
-+		sacl_new = &(smb_acl_lists(type)->sacls[aclidx]);
-+		sacl_orig = sys_acl_get_file(fname, type);
-+		if (!sacl_orig) {
-+			rprintf(FERROR, "set_acl: sys_acl_get_file(%s, %s): %s\n",
-+				fname, str_acl_type(type), strerror(errno));
-+			unchanged = -1;
-+			continue;
-+		}
-+		ok = unpack_smb_acl(&racl_orig, sacl_orig);
-+		sys_acl_free_acl(sacl_orig);
-+		if (!ok) {
-+			unchanged = -1;
-+			continue;
++		acl_duo *duo_item;
++		BOOL eq;
++		int32 ndx = IVAL(ndx_ptr, 0);
++
++		ndx_ptr += 4;
++
++		if (type == SMB_ACL_TYPE_ACCESS) {
++			if (ndx < 0 || (size_t)ndx >= access_acl_list.count)
++				continue;
++			duo_item = access_acl_list.items;
++			duo_item += ndx;
++			eq = sxp->acc_acl
++			    && rsync_acl_equal_enough(sxp->acc_acl, &duo_item->racl, file->mode);
++		} else {
++			if (ndx < 0 || (size_t)ndx >= default_acl_list.count)
++				continue;
++			duo_item = default_acl_list.items;
++			duo_item += ndx;
++			eq = sxp->def_acl
++			    && rsync_acl_equal(sxp->def_acl, &duo_item->racl);
 +		}
-+		if (type == SMB_ACL_TYPE_ACCESS)
-+			ok = rsync_acl_extended_parts_equal(&racl_orig, racl_new);
-+		else
-+			ok = rsync_acls_equal(&racl_orig, racl_new);
-+		rsync_acl_free(&racl_orig);
-+		if (ok)
++		if (eq)
 +			continue;
-+		if (!dry_run && mode_p) {
++		if (!dry_run && fname) {
 +			if (type == SMB_ACL_TYPE_DEFAULT
-+			 && racl_new->user_obj == ACL_NO_ENTRY) {
++			 && duo_item->racl.user_obj == NO_ENTRY) {
 +				if (sys_acl_delete_def_file(fname) < 0) {
-+					rprintf(FERROR, "set_acl: sys_acl_delete_def_file(%s): %s\n",
-+						fname, strerror(errno));
++					rsyserr(FERROR, errno, "set_acl: sys_acl_delete_def_file(%s)",
++						fname);
 +					unchanged = -1;
 +					continue;
 +				}
 +			} else {
-+				mode_t cur_mode = *mode_p;
-+				if (!*sacl_new
-+				 && !pack_smb_acl(sacl_new, racl_new)) {
++				mode_t cur_mode = sxp->st.st_mode;
++				if (!duo_item->sacl
++				 && !pack_smb_acl(&duo_item->sacl, &duo_item->racl)) {
 +					unchanged = -1;
 +					continue;
 +				}
 +				if (type == SMB_ACL_TYPE_ACCESS) {
-+					cur_mode = change_sacl_perms(*sacl_new, racl_new,
++					cur_mode = change_sacl_perms(duo_item->sacl, &duo_item->racl,
 +								     cur_mode, file->mode);
-+					if (cur_mode == ~0u)
++					if (cur_mode == (mode_t)~0)
 +						continue;
 +				}
-+				if (sys_acl_set_file(fname, type, *sacl_new) < 0) {
-+					rprintf(FERROR, "set_acl: sys_acl_set_file(%s, %s): %s\n",
-+						fname, str_acl_type(type),
-+						strerror(errno));
++				if (sys_acl_set_file(fname, type, duo_item->sacl) < 0) {
++					rsyserr(FERROR, errno, "set_acl: sys_acl_set_file(%s, %s)",
++						fname, str_acl_type(type));
 +					unchanged = -1;
 +					continue;
 +				}
 +				if (type == SMB_ACL_TYPE_ACCESS)
-+					*mode_p = cur_mode;
++					sxp->st.st_mode = cur_mode;
 +			}
 +		}
 +		if (unchanged == 1)
 +			unchanged = 0;
 +	} while (BUMP_TYPE(type) && S_ISDIR(file->mode));
 +
 +	return unchanged;
 +}
 +
-+/* Enumeration functions for uid mapping: */
++/* === Enumeration functions for uid mapping === */
 +
 +/* Context -- one and only one.  Should be cycled through once on uid
 + * mapping and once on gid mapping. */
-+static rsync_acl_list *_enum_racl_lists[] = {
-+	&_rsync_acl_lists[0], &_rsync_acl_lists[1], NULL
++static item_list *_enum_racl_lists[] = {
++	&access_acl_list, &default_acl_list, NULL
 +};
 +
-+static rsync_acl_list **enum_racl_list = &_enum_racl_lists[0];
++static item_list **enum_racl_list = &_enum_racl_lists[0];
++static int enum_ida_index = 0;
 +static size_t enum_racl_index = 0;
-+static size_t enum_ida_index = 0;
 +
-+/* This returns the next tag_type id from the given acl for the next entry,
++/* This returns the next tag_type id from the given ACL for the next entry,
 + * or it returns 0 if there are no more tag_type ids in the acl. */
 +static id_t *next_ace_id(SMB_ACL_TAG_T tag_type, const rsync_acl *racl)
 +{
-+	const ida_list *idal = tag_type == SMB_ACL_USER ? &racl->users : &racl->groups;
++	const ida_entries *idal = tag_type == SMB_ACL_USER ? &racl->users : &racl->groups;
 +	if (enum_ida_index < idal->count) {
 +		id_access *ida = &idal->idas[enum_ida_index++];
 +		return &ida->id;
 +	}
 +	enum_ida_index = 0;
 +	return NULL;
 +}
 +
-+static id_t *next_acl_id(SMB_ACL_TAG_T tag_type, const rsync_acl_list *racl_list)
++static id_t *next_acl_id(SMB_ACL_TAG_T tag_type, const item_list *racl_list)
 +{
 +	for (; enum_racl_index < racl_list->count; enum_racl_index++) {
-+		rsync_acl *racl = &racl_list->racls[enum_racl_index];
-+		id_t *id = next_ace_id(tag_type, racl);
-+		if (id)
++		id_t *id;
++		acl_duo *duo_item = racl_list->items;
++		duo_item += enum_racl_index;
++		if ((id = next_ace_id(tag_type, &duo_item->racl)) != NULL)
 +			return id;
 +	}
 +	enum_racl_index = 0;
 +	return NULL;
 +}
 +
@@ -1277,12 +1073,13 @@
 +
 +id_t *next_acl_gid()
 +{
 +	return next_acl_list_id(SMB_ACL_GROUP);
 +}
 +
++/* This is used by dest_mode(). */
 +int default_perms_for_dir(const char *dir)
 +{
 +	rsync_acl racl;
 +	SMB_ACL_T sacl;
 +	BOOL ok;
 +	int perms;
@@ -1310,94 +1107,143 @@
 +				dir, str_acl_type(SMB_ACL_TYPE_DEFAULT), strerror(errno));
 +		}
 +		return perms;
 +	}
 +
 +	/* Convert it. */
++	racl = empty_rsync_acl;
 +	ok = unpack_smb_acl(&racl, sacl);
 +	sys_acl_free_acl(sacl);
 +	if (!ok) {
 +		rprintf(FERROR, "default_perms_for_dir: unpack_smb_acl failed, falling back on umask\n");
 +		return perms;
 +	}
 +
 +	/* Apply the permission-bit entries of the default ACL, if any. */
-+	if (racl.user_obj != ACL_NO_ENTRY) {
++	if (racl.user_obj != NO_ENTRY) {
 +		perms = rsync_acl_get_perms(&racl);
 +		if (verbose > 2)
 +			rprintf(FINFO, "got ACL-based default perms %o for directory %s\n", perms, dir);
 +	}
 +
 +	rsync_acl_free(&racl);
 +	return perms;
 +}
 +
 +#endif /* SUPPORT_ACLS */
 --- old/backup.c
 +++ new/backup.c
-@@ -28,6 +28,7 @@ extern char *backup_suffix;
+@@ -29,6 +29,7 @@ extern char *backup_suffix;
  extern char *backup_dir;
  
  extern int am_root;
 +extern int preserve_acls;
  extern int preserve_devices;
  extern int preserve_specials;
  extern int preserve_links;
-@@ -132,6 +133,10 @@ static int make_bak_dir(char *fullpath)
+@@ -94,7 +95,8 @@ path
+ ****************************************************************************/
+ static int make_bak_dir(char *fullpath)
+ {
+-	STRUCT_STAT st;
++	statx sx;
++	struct file_struct *file;
+ 	char *rel = fullpath + backup_dir_len;
+ 	char *end = rel + strlen(rel);
+ 	char *p = end;
+@@ -126,13 +128,24 @@ static int make_bak_dir(char *fullpath)
+ 		if (p >= rel) {
+ 			/* Try to transfer the directory settings of the
+ 			 * actual dir that the files are coming from. */
+-			if (do_stat(rel, &st) < 0) {
++			if (do_stat(rel, &sx.st) < 0) {
+ 				rsyserr(FERROR, errno,
+ 					"make_bak_dir stat %s failed",
+ 					full_fname(rel));
  			} else {
- 				do_lchown(fullpath, st.st_uid, st.st_gid);
- 				do_chmod(fullpath, st.st_mode);
+-				do_lchown(fullpath, st.st_uid, st.st_gid);
+-				do_chmod(fullpath, st.st_mode);
++#ifdef SUPPORT_ACLS
++				sx.acc_acl = sx.def_acl = NULL;
++#endif
++				if (!(file = make_file(rel, NULL, NULL, 0, NO_FILTERS)))
++					continue;
 +#ifdef SUPPORT_ACLS
-+				if (preserve_acls)
-+					dup_acl(end, fullpath, st.st_mode);
++				if (preserve_acls) {
++					get_acl(rel, &sx);
++					cache_acl(file, &sx);
++				}
 +#endif
++				set_file_attrs(fullpath, file, NULL, 0);
++				free(file);
  			}
  		}
  		*p = '/';
-@@ -185,6 +190,11 @@ static int keep_backup(char *fname)
+@@ -170,15 +183,18 @@ static int robust_move(char *src, char *
+  * We will move the file to be deleted into a parallel directory tree. */
+ static int keep_backup(char *fname)
+ {
+-	STRUCT_STAT st;
++	statx sx;
+ 	struct file_struct *file;
+ 	char *buf;
+ 	int kept = 0;
+ 	int ret_code;
+ 
+ 	/* return if no file to keep */
+-	if (do_lstat(fname, &st) < 0)
++	if (do_lstat(fname, &sx.st) < 0)
+ 		return 1;
++#ifdef SUPPORT_ACLS
++	sx.acc_acl = sx.def_acl = NULL;
++#endif
+ 
+ 	if (!(file = make_file(fname, NULL, NULL, 0, NO_FILTERS)))
+ 		return 1; /* the file could have disappeared */
+@@ -186,6 +202,13 @@ static int keep_backup(char *fname)
  	if (!(buf = get_backup_name(fname)))
  		return 0;
  
 +#ifdef SUPPORT_ACLS
-+	if (preserve_acls)
-+		push_keep_backup_acl(file, fname, buf);
++	if (preserve_acls) {
++		get_acl(fname, &sx);
++		cache_acl(file, &sx);
++	}
 +#endif
 +
  	/* Check to see if this is a device file, or link */
  	if ((am_root && preserve_devices && IS_DEVICE(file->mode))
  	 || (preserve_specials && IS_SPECIAL(file->mode))) {
-@@ -260,6 +270,10 @@ static int keep_backup(char *fname)
- 		}
- 	}
- 	set_file_attrs(buf, file, NULL, 0);
-+#ifdef SUPPORT_ACLS
-+	if (preserve_acls)
-+		cleanup_keep_backup_acl();
-+#endif
- 	free(file);
- 
- 	if (verbose > 1) {
+@@ -254,7 +277,7 @@ static int keep_backup(char *fname)
+ 		if (robust_move(fname, buf) != 0) {
+ 			rsyserr(FERROR, errno, "keep_backup failed: %s -> \"%s\"",
+ 				full_fname(fname), buf);
+-		} else if (st.st_nlink > 1) {
++		} else if (sx.st.st_nlink > 1) {
+ 			/* If someone has hard-linked the file into the backup
+ 			 * dir, rename() might return success but do nothing! */
+ 			robust_unlink(fname); /* Just in case... */
 --- old/configure.in
 +++ new/configure.in
-@@ -482,6 +482,11 @@ if test x"$ac_cv_func_strcasecmp" = x"no
+@@ -515,6 +515,11 @@ if test x"$ac_cv_func_strcasecmp" = x"no
      AC_CHECK_LIB(resolv, strcasecmp)
  fi
  
 +AC_CHECK_FUNCS(aclsort)
 +if test x"$ac_cv_func_aclsort" = x"no"; then
 +    AC_CHECK_LIB(sec, aclsort)
 +fi
 +
  dnl At the moment we don't test for a broken memcmp(), because all we
  dnl need to do is test for equality, not comparison, and it seems that
  dnl every platform has a memcmp that can do at least that.
-@@ -746,6 +751,78 @@ AC_SUBST(OBJ_RESTORE)
+@@ -779,6 +784,78 @@ AC_SUBST(OBJ_RESTORE)
  AC_SUBST(CC_SHOBJ_FLAG)
  AC_SUBST(BUILD_POPT)
  
-+AC_CHECK_HEADERS(sys/acl.h)
++AC_CHECK_HEADERS(sys/acl.h acl/libacl.h)
 +AC_CHECK_FUNCS(_acl __acl _facl __facl)
 +#################################################
 +# check for ACL support
 +
 +AC_MSG_CHECKING(whether to support ACLs)
 +AC_ARG_ENABLE(acl-support,
@@ -1468,141 +1314,941 @@
 +
  AC_CONFIG_FILES([Makefile lib/dummy zlib/dummy popt/dummy shconfig])
  AC_OUTPUT
  
 --- old/flist.c
 +++ new/flist.c
-@@ -44,6 +44,7 @@ extern int filesfrom_fd;
+@@ -40,6 +40,7 @@ extern int filesfrom_fd;
  extern int one_file_system;
  extern int copy_dirlinks;
  extern int keep_dirlinks;
 +extern int preserve_acls;
  extern int preserve_links;
  extern int preserve_hard_links;
  extern int preserve_devices;
-@@ -965,6 +966,11 @@ static struct file_struct *send_file_nam
+@@ -133,6 +134,8 @@ static void list_file_entry(struct file_
+ 
+ 	permstring(permbuf, f->mode);
+ 
++	/* TODO: indicate '+' if the entry has an ACL. */
++
+ #ifdef SUPPORT_LINKS
+ 	if (preserve_links && S_ISLNK(f->mode)) {
+ 		rprintf(FINFO, "%s %11.0f %s %s -> %s\n",
+@@ -495,6 +498,9 @@ static struct file_struct *receive_file_
+ 	char thisname[MAXPATHLEN];
+ 	unsigned int l1 = 0, l2 = 0;
+ 	int alloc_len, basename_len, dirname_len, linkname_len, sum_len;
++#ifdef SUPPORT_ACLS
++	int xtra_len;
++#endif
+ 	OFF_T file_length;
+ 	char *basename, *dirname, *bp;
+ 	struct file_struct *file;
+@@ -598,13 +604,27 @@ static struct file_struct *receive_file_
+ 
+ 	sum_len = always_checksum && S_ISREG(mode) ? MD4_SUM_LENGTH : 0;
+ 
++#ifdef SUPPORT_ACLS
++	/* We need one or two index int32s when we're preserving ACLs. */
++	if (preserve_acls)
++		xtra_len = (S_ISDIR(mode) ? 2 : 1) * 4;
++	else
++		xtra_len = 0;
++#endif
++
+ 	alloc_len = file_struct_len + dirname_len + basename_len
++#ifdef SUPPORT_ACLS
++		  + xtra_len
++#endif
+ 		  + linkname_len + sum_len;
+ 	bp = pool_alloc(flist->file_pool, alloc_len, "receive_file_entry");
+ 
+ 	file = (struct file_struct *)bp;
+ 	memset(bp, 0, file_struct_len);
+ 	bp += file_struct_len;
++#ifdef SUPPORT_ACLS
++	bp += xtra_len;
++#endif
+ 
+ 	file->modtime = modtime;
+ 	file->length = file_length;
+@@ -699,6 +719,11 @@ static struct file_struct *receive_file_
+ 		read_buf(f, sum, checksum_len);
+ 	}
+ 
++#ifdef SUPPORT_ACLS
++	if (preserve_acls)
++		receive_acl(file, f);
++#endif
++
+ 	return file;
+ }
+ 
+@@ -949,6 +974,9 @@ static struct file_struct *send_file_nam
+ 					  unsigned short flags)
+ {
+ 	struct file_struct *file;
++#ifdef SUPPORT_ACLS
++	statx sx;
++#endif
+ 
+ 	file = make_file(fname, flist, stp, flags,
+ 			 f == -2 ? SERVER_FILTERS : ALL_FILTERS);
+@@ -958,6 +986,15 @@ static struct file_struct *send_file_nam
  	if (chmod_modes && !S_ISLNK(file->mode))
  		file->mode = tweak_mode(file->mode, chmod_modes);
  
-+#ifdef SUPPORT_ACLS
-+	if (preserve_acls && make_acl(file, fname) < 0)
-+		return NULL;
-+#endif
-+
- 	maybe_emit_filelist_progress(flist->count + flist_count_offset);
++#ifdef SUPPORT_ACLS
++	if (preserve_acls) {
++		sx.st.st_mode = file->mode;
++		sx.acc_acl = sx.def_acl = NULL;
++		if (get_acl(fname, &sx) < 0)
++			return NULL;
++	}
++#endif
++
+ 	maybe_emit_filelist_progress(flist->count + flist_count_offset);
+ 
+ 	flist_expand(flist);
+@@ -965,6 +1002,15 @@ static struct file_struct *send_file_nam
+ 	if (file->basename[0]) {
+ 		flist->files[flist->count++] = file;
+ 		send_file_entry(file, f);
++#ifdef SUPPORT_ACLS
++		if (preserve_acls)
++			send_acl(&sx, f);
++#endif
++	} else {
++#ifdef SUPPORT_ACLS
++		if (preserve_acls)
++			free_acl(&sx);
++#endif
+ 	}
+ 	return file;
+ }
+--- old/generator.c
++++ new/generator.c
+@@ -35,6 +35,7 @@ extern int do_progress;
+ extern int relative_paths;
+ extern int implied_dirs;
+ extern int keep_dirlinks;
++extern int preserve_acls;
+ extern int preserve_links;
+ extern int preserve_devices;
+ extern int preserve_specials;
+@@ -85,6 +86,7 @@ extern long block_size; /* "long" becaus
+ extern int max_delete;
+ extern int force_delete;
+ extern int one_file_system;
++extern mode_t orig_umask;
+ extern struct stats stats;
+ extern dev_t filesystem_dev;
+ extern char *backup_dir;
+@@ -317,22 +319,27 @@ static void do_delete_pass(struct file_l
+ 		rprintf(FINFO, "                    \r");
+ }
+ 
+-int unchanged_attrs(struct file_struct *file, STRUCT_STAT *st)
++int unchanged_attrs(struct file_struct *file, statx *sxp)
+ {
+ 	if (preserve_perms
+-	 && (st->st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS))
++	 && (sxp->st.st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS))
+ 		return 0;
+ 
+-	if (am_root && preserve_uid && st->st_uid != file->uid)
++	if (am_root && preserve_uid && sxp->st.st_uid != file->uid)
+ 		return 0;
+ 
+-	if (preserve_gid && file->gid != GID_NONE && st->st_gid != file->gid)
++	if (preserve_gid && file->gid != GID_NONE && sxp->st.st_gid != file->gid)
++		return 0;
++
++#ifdef SUPPORT_ACLS
++	if (preserve_acls && set_acl(NULL, file, sxp) == 0)
+ 		return 0;
++#endif
+ 
+ 	return 1;
+ }
+ 
+-void itemize(struct file_struct *file, int ndx, int statret, STRUCT_STAT *st,
++void itemize(struct file_struct *file, int ndx, int statret, statx *sxp,
+ 	     int32 iflags, uchar fnamecmp_type, char *xname)
+ {
+ 	if (statret >= 0) { /* A from-dest-dir statret can == 1! */
+@@ -340,19 +347,23 @@ void itemize(struct file_struct *file, i
+ 		    : S_ISDIR(file->mode) ? !omit_dir_times
+ 		    : !S_ISLNK(file->mode);
+ 
+-		if (S_ISREG(file->mode) && file->length != st->st_size)
++		if (S_ISREG(file->mode) && file->length != sxp->st.st_size)
+ 			iflags |= ITEM_REPORT_SIZE;
+ 		if ((iflags & (ITEM_TRANSFER|ITEM_LOCAL_CHANGE) && !keep_time
+ 		     && (!(iflags & ITEM_XNAME_FOLLOWS) || *xname))
+-		    || (keep_time && cmp_time(file->modtime, st->st_mtime) != 0))
++		    || (keep_time && cmp_time(file->modtime, sxp->st.st_mtime) != 0))
+ 			iflags |= ITEM_REPORT_TIME;
+-		if ((file->mode & CHMOD_BITS) != (st->st_mode & CHMOD_BITS))
++		if ((file->mode & CHMOD_BITS) != (sxp->st.st_mode & CHMOD_BITS))
+ 			iflags |= ITEM_REPORT_PERMS;
+-		if (preserve_uid && am_root && file->uid != st->st_uid)
++		if (preserve_uid && am_root && file->uid != sxp->st.st_uid)
+ 			iflags |= ITEM_REPORT_OWNER;
+ 		if (preserve_gid && file->gid != GID_NONE
+-		    && st->st_gid != file->gid)
++		    && sxp->st.st_gid != file->gid)
+ 			iflags |= ITEM_REPORT_GROUP;
++#ifdef SUPPORT_ACLS
++		if (preserve_acls && set_acl(NULL, file, sxp) == 0)
++			iflags |= ITEM_REPORT_ACL;
++#endif
+ 	} else
+ 		iflags |= ITEM_IS_NEW;
+ 
+@@ -605,7 +616,7 @@ void check_for_finished_hlinks(int itemi
+  * handling the file, -1 if no dest-linking occurred, or a non-negative
+  * value if we found an alternate basis file. */
+ static int try_dests_reg(struct file_struct *file, char *fname, int ndx,
+-			 char *cmpbuf, STRUCT_STAT *stp, int itemizing,
++			 char *cmpbuf, statx *sxp, int itemizing,
+ 			 int maybe_ATTRS_REPORT, enum logcode code)
+ {
+ 	int best_match = -1;
+@@ -614,7 +625,7 @@ static int try_dests_reg(struct file_str
+ 
+ 	do {
+ 		pathjoin(cmpbuf, MAXPATHLEN, basis_dir[j], fname);
+-		if (link_stat(cmpbuf, stp, 0) < 0 || !S_ISREG(stp->st_mode))
++		if (link_stat(cmpbuf, &sxp->st, 0) < 0 || !S_ISREG(sxp->st.st_mode))
+ 			continue;
+ 		switch (match_level) {
+ 		case 0:
+@@ -622,16 +633,20 @@ static int try_dests_reg(struct file_str
+ 			match_level = 1;
+ 			/* FALL THROUGH */
+ 		case 1:
+-			if (!unchanged_file(cmpbuf, file, stp))
++			if (!unchanged_file(cmpbuf, file, &sxp->st))
+ 				continue;
+ 			best_match = j;
+ 			match_level = 2;
+ 			/* FALL THROUGH */
+ 		case 2:
+-			if (!unchanged_attrs(file, stp))
++#ifdef SUPPORT_ACLS
++			if (preserve_acls)
++				get_acl(cmpbuf, sxp);
++#endif
++			if (!unchanged_attrs(file, sxp))
+ 				continue;
+ 			if (always_checksum && preserve_times
+-			 && cmp_time(stp->st_mtime, file->modtime))
++			 && cmp_time(sxp->st.st_mtime, file->modtime))
+ 				continue;
+ 			best_match = j;
+ 			match_level = 3;
+@@ -646,14 +661,14 @@ static int try_dests_reg(struct file_str
+ 	if (j != best_match) {
+ 		j = best_match;
+ 		pathjoin(cmpbuf, MAXPATHLEN, basis_dir[j], fname);
+-		if (link_stat(cmpbuf, stp, 0) < 0)
++		if (link_stat(cmpbuf, &sxp->st, 0) < 0)
+ 			return -1;
+ 	}
+ 
+ 	if (match_level == 3 && !copy_dest) {
+ #ifdef SUPPORT_HARD_LINKS
+ 		if (link_dest) {
+-			if (hard_link_one(file, ndx, fname, 0, stp,
++			if (hard_link_one(file, ndx, fname, 0, sxp,
+ 					  cmpbuf, 1,
+ 					  itemizing && verbose > 1,
+ 					  code) < 0)
+@@ -665,8 +680,13 @@ static int try_dests_reg(struct file_str
+ 			}
+ 		} else
+ #endif
+-		if (itemizing)
+-			itemize(file, ndx, 0, stp, 0, 0, NULL);
++		if (itemizing) {
++#ifdef SUPPORT_ACLS
++			if (preserve_acls && !ACL_READY(*sxp))
++				get_acl(fname, sxp);
++#endif
++			itemize(file, ndx, 0, sxp, 0, 0, NULL);
++		}
+ 		if (verbose > 1 && maybe_ATTRS_REPORT) {
+ 			rprintf(FCLIENT, "%s is uptodate\n", fname);
+ 		}
+@@ -682,8 +702,13 @@ static int try_dests_reg(struct file_str
+ 			}
+ 			return -1;
+ 		}
+-		if (itemizing)
+-			itemize(file, ndx, 0, stp, ITEM_LOCAL_CHANGE, 0, NULL);
++		if (itemizing) {
++#ifdef SUPPORT_ACLS
++			if (preserve_acls && !ACL_READY(*sxp))
++				get_acl(fname, sxp);
++#endif
++			itemize(file, ndx, 0, sxp, ITEM_LOCAL_CHANGE, 0, NULL);
++		}
+ 		set_file_attrs(fname, file, NULL, 0);
+ 		if (maybe_ATTRS_REPORT
+ 		 && ((!itemizing && verbose && match_level == 2)
+@@ -707,13 +732,18 @@ static int try_dests_non(struct file_str
+ 			 enum logcode code)
+ {
+ 	char fnamebuf[MAXPATHLEN];
+-	STRUCT_STAT st;
++	statx sx;
+ 	int i = 0;
+ 
+ 	do {
+ 		pathjoin(fnamebuf, MAXPATHLEN, basis_dir[i], fname);
+-		if (link_stat(fnamebuf, &st, 0) < 0 || S_ISDIR(st.st_mode)
+-		 || !unchanged_attrs(file, &st))
++		if (link_stat(fnamebuf, &sx.st, 0) < 0 || S_ISDIR(sx.st.st_mode))
++			continue;
++#ifdef SUPPORT_ACLS
++		if (preserve_acls)
++			get_acl(fnamebuf, &sx);
++#endif
++		if (!unchanged_attrs(file, &sx))
+ 			continue;
+ 		if (S_ISLNK(file->mode)) {
+ #ifdef SUPPORT_LINKS
+@@ -726,10 +756,10 @@ static int try_dests_non(struct file_str
+ #endif
+ 				continue;
+ 		} else if (IS_SPECIAL(file->mode)) {
+-			if (!IS_SPECIAL(st.st_mode) || st.st_rdev != file->u.rdev)
++			if (!IS_SPECIAL(sx.st.st_mode) || sx.st.st_rdev != file->u.rdev)
+ 				continue;
+ 		} else if (IS_DEVICE(file->mode)) {
+-			if (!IS_DEVICE(st.st_mode) || st.st_rdev != file->u.rdev)
++			if (!IS_DEVICE(sx.st.st_mode) || sx.st.st_rdev != file->u.rdev)
+ 				continue;
+ 		} else {
+ 			rprintf(FERROR,
+@@ -760,7 +790,15 @@ static int try_dests_non(struct file_str
+ 			int changes = compare_dest ? 0 : ITEM_LOCAL_CHANGE
+ 				    + (link_dest ? ITEM_XNAME_FOLLOWS : 0);
+ 			char *lp = link_dest ? "" : NULL;
+-			itemize(file, ndx, 0, &st, changes, 0, lp);
++#ifdef SUPPORT_ACLS
++			if (preserve_acls)
++				get_acl(fname, &sx);
++#endif
++			itemize(file, ndx, 0, &sx, changes, 0, lp);
++#ifdef SUPPORT_ACLS
++			if (preserve_acls)
++				free_acl(&sx);
++#endif
+ 		}
+ 		if (verbose > 1 && maybe_ATTRS_REPORT) {
+ 			rprintf(FCLIENT, "%s is uptodate\n", fname);
+@@ -772,6 +810,7 @@ static int try_dests_non(struct file_str
+ }
+ 
+ static int phase = 0;
++static int dflt_perms;
+ 
+ /* Acts on the_file_list->file's ndx'th item, whose name is fname.  If a dir,
+  * make sure it exists, and has the right permissions/timestamp info.  For
+@@ -793,7 +832,8 @@ static void recv_generator(char *fname, 
+ 	static int need_fuzzy_dirlist = 0;
+ 	struct file_struct *fuzzy_file = NULL;
+ 	int fd = -1, f_copy = -1;
+-	STRUCT_STAT st, real_st, partial_st;
++	statx sx, real_sx;
++	STRUCT_STAT partial_st;
+ 	struct file_struct *back_file = NULL;
+ 	int statret, real_ret, stat_errno;
+ 	char *fnamecmp, *partialptr, *backupptr = NULL;
+@@ -849,6 +889,9 @@ static void recv_generator(char *fname, 
+ 		} else if (!dry_run)
+ 			return;
+ 	}
++#ifdef SUPPORT_ACLS
++	sx.acc_acl = sx.def_acl = NULL;
++#endif
+ 	if (dry_run > 1) {
+ 		statret = -1;
+ 		stat_errno = ENOENT;
+@@ -856,7 +899,7 @@ static void recv_generator(char *fname, 
+ 		char *dn = file->dirname ? file->dirname : ".";
+ 		if (parent_dirname != dn && strcmp(parent_dirname, dn) != 0) {
+ 			if (relative_paths && !implied_dirs
+-			 && do_stat(dn, &st) < 0
++			 && do_stat(dn, &sx.st) < 0
+ 			 && create_directory_path(fname) < 0) {
+ 				rsyserr(FERROR, errno,
+ 					"recv_generator: mkdir %s failed",
+@@ -868,6 +911,10 @@ static void recv_generator(char *fname, 
+ 			}
+ 			if (fuzzy_basis)
+ 				need_fuzzy_dirlist = 1;
++#ifdef SUPPORT_ACLS
++			if (!preserve_perms)
++				dflt_perms = default_perms_for_dir(dn);
++#endif
+ 		}
+ 		parent_dirname = dn;
+ 
+@@ -876,7 +923,7 @@ static void recv_generator(char *fname, 
+ 			need_fuzzy_dirlist = 0;
+ 		}
+ 
+-		statret = link_stat(fname, &st,
++		statret = link_stat(fname, &sx.st,
+ 				    keep_dirlinks && S_ISDIR(file->mode));
+ 		stat_errno = errno;
+ 	}
+@@ -894,8 +941,9 @@ static void recv_generator(char *fname, 
+ 	 * mode based on the local permissions and some heuristics. */
+ 	if (!preserve_perms) {
+ 		int exists = statret == 0
+-			  && S_ISDIR(st.st_mode) == S_ISDIR(file->mode);
+-		file->mode = dest_mode(file->mode, st.st_mode, exists);
++			  && S_ISDIR(sx.st.st_mode) == S_ISDIR(file->mode);
++		file->mode = dest_mode(file->mode, sx.st.st_mode, dflt_perms,
++				       exists);
+ 	}
+ 
+ 	if (S_ISDIR(file->mode)) {
+@@ -904,8 +952,8 @@ static void recv_generator(char *fname, 
+ 		 * file of that name and it is *not* a directory, then
+ 		 * we need to delete it.  If it doesn't exist, then
+ 		 * (perhaps recursively) create it. */
+-		if (statret == 0 && !S_ISDIR(st.st_mode)) {
+-			if (delete_item(fname, st.st_mode, del_opts) < 0)
++		if (statret == 0 && !S_ISDIR(sx.st.st_mode)) {
++			if (delete_item(fname, sx.st.st_mode, del_opts) < 0)
+ 				return;
+ 			statret = -1;
+ 		}
+@@ -920,7 +968,11 @@ static void recv_generator(char *fname, 
+ 					sr = -1;
+ 				new_root_dir = 0;
+ 			}
+-			itemize(file, ndx, sr, &st,
++#ifdef SUPPORT_ACLS
++			if (preserve_acls && sr == 0)
++				get_acl(fname, &sx);
++#endif
++			itemize(file, ndx, sr, &sx,
+ 				sr ? ITEM_LOCAL_CHANGE : 0, 0, NULL);
+ 		}
+ 		if (statret != 0 && do_mkdir(fname,file->mode) < 0 && errno != EEXIST) {
+@@ -940,19 +992,19 @@ static void recv_generator(char *fname, 
+ 				return;
+ 			}
+ 		}
+-		if (set_file_attrs(fname, file, statret ? NULL : &st, 0)
++		if (set_file_attrs(fname, file, statret ? NULL : &sx, 0)
+ 		    && verbose && code != FNONE && f_out != -1)
+ 			rprintf(code, "%s/\n", fname);
+ 		if (delete_during && f_out != -1 && !phase && dry_run < 2
+ 		    && (file->flags & FLAG_DEL_HERE))
+-			delete_in_dir(the_file_list, fname, file, &st);
+-		return;
++			delete_in_dir(the_file_list, fname, file, &sx.st);
++		goto cleanup;
+ 	}
+ 
+ 	if (preserve_hard_links && file->link_u.links
+-	    && hard_link_check(file, ndx, fname, statret, &st,
++	    && hard_link_check(file, ndx, fname, statret, &sx,
+ 			       itemizing, code, HL_CHECK_MASTER))
+-		return;
++		goto cleanup;
+ 
+ 	if (preserve_links && S_ISLNK(file->mode)) {
+ #ifdef SUPPORT_LINKS
+@@ -970,7 +1022,7 @@ static void recv_generator(char *fname, 
+ 			char lnk[MAXPATHLEN];
+ 			int len;
+ 
+-			if (!S_ISDIR(st.st_mode)
++			if (!S_ISDIR(sx.st.st_mode)
+ 			    && (len = readlink(fname, lnk, MAXPATHLEN-1)) > 0) {
+ 				lnk[len] = 0;
+ 				/* A link already pointing to the
+@@ -978,10 +1030,10 @@ static void recv_generator(char *fname, 
+ 				 * required. */
+ 				if (strcmp(lnk, file->u.link) == 0) {
+ 					if (itemizing) {
+-						itemize(file, ndx, 0, &st, 0,
++						itemize(file, ndx, 0, &sx, 0,
+ 							0, NULL);
+ 					}
+-					set_file_attrs(fname, file, &st,
++					set_file_attrs(fname, file, &sx,
+ 						       maybe_ATTRS_REPORT);
+ 					if (preserve_hard_links
+ 					    && file->link_u.links) {
+@@ -996,9 +1048,9 @@ static void recv_generator(char *fname, 
+ 			}
+ 			/* Not the right symlink (or not a symlink), so
+ 			 * delete it. */
+-			if (delete_item(fname, st.st_mode, del_opts) < 0)
++			if (delete_item(fname, sx.st.st_mode, del_opts) < 0)
+ 				return;
+-			if (!S_ISLNK(st.st_mode))
++			if (!S_ISLNK(sx.st.st_mode))
+ 				statret = -1;
+ 		} else if (basis_dir[0] != NULL) {
+ 			if (try_dests_non(file, fname, ndx, itemizing,
+@@ -1015,7 +1067,7 @@ static void recv_generator(char *fname, 
+ 			}
+ 		}
+ 		if (preserve_hard_links && file->link_u.links
+-		    && hard_link_check(file, ndx, fname, -1, &st,
++		    && hard_link_check(file, ndx, fname, -1, &sx,
+ 				       itemizing, code, HL_SKIP))
+ 			return;
+ 		if (do_symlink(file->u.link,fname) != 0) {
+@@ -1024,7 +1076,7 @@ static void recv_generator(char *fname, 
+ 		} else {
+ 			set_file_attrs(fname, file, NULL, 0);
+ 			if (itemizing) {
+-				itemize(file, ndx, statret, &st,
++				itemize(file, ndx, statret, &sx,
+ 					ITEM_LOCAL_CHANGE, 0, NULL);
+ 			}
+ 			if (code != FNONE && verbose) {
+@@ -1059,18 +1111,22 @@ static void recv_generator(char *fname, 
+ 				code = FNONE;
+ 			}
+ 		}
++#ifdef SUPPORT_ACLS
++		if (preserve_acls && statret == 0)
++			get_acl(fname, &sx);
++#endif
+ 		if (statret != 0
+-		 || (st.st_mode & ~CHMOD_BITS) != (file->mode & ~CHMOD_BITS)
+-		 || st.st_rdev != file->u.rdev) {
++		 || (sx.st.st_mode & ~CHMOD_BITS) != (file->mode & ~CHMOD_BITS)
++		 || sx.st.st_rdev != file->u.rdev) {
+ 			if (statret == 0
+-			 && delete_item(fname, st.st_mode, del_opts) < 0)
+-				return;
++			 && delete_item(fname, sx.st.st_mode, del_opts) < 0)
++				goto cleanup;
+ 			if (preserve_hard_links && file->link_u.links
+-			    && hard_link_check(file, ndx, fname, -1, &st,
++			    && hard_link_check(file, ndx, fname, -1, &sx,
+ 					       itemizing, code, HL_SKIP))
+-				return;
+-			if ((IS_DEVICE(file->mode) && !IS_DEVICE(st.st_mode))
+-			 || (IS_SPECIAL(file->mode) && !IS_SPECIAL(st.st_mode)))
++				goto cleanup;
++			if ((IS_DEVICE(file->mode) && !IS_DEVICE(sx.st.st_mode))
++			 || (IS_SPECIAL(file->mode) && !IS_SPECIAL(sx.st.st_mode)))
+ 				statret = -1;
+ 			if (verbose > 2) {
+ 				rprintf(FINFO,"mknod(%s,0%o,0x%x)\n",
+@@ -1083,7 +1139,7 @@ static void recv_generator(char *fname, 
+ 			} else {
+ 				set_file_attrs(fname, file, NULL, 0);
+ 				if (itemizing) {
+-					itemize(file, ndx, statret, &st,
++					itemize(file, ndx, statret, &sx,
+ 						ITEM_LOCAL_CHANGE, 0, NULL);
+ 				}
+ 				if (code != FNONE && verbose)
+@@ -1097,14 +1153,14 @@ static void recv_generator(char *fname, 
+ 			}
+ 		} else {
+ 			if (itemizing)
+-				itemize(file, ndx, statret, &st, 0, 0, NULL);
+-			set_file_attrs(fname, file, &st, maybe_ATTRS_REPORT);
++				itemize(file, ndx, statret, &sx, 0, 0, NULL);
++			set_file_attrs(fname, file, &sx, maybe_ATTRS_REPORT);
+ 			if (preserve_hard_links && file->link_u.links)
+ 				hard_link_cluster(file, ndx, itemizing, code);
+ 			if (remove_source_files == 1)
+ 				goto return_with_success;
+ 		}
+-		return;
++		goto cleanup;
+ 	}
+ 
+ 	if (!S_ISREG(file->mode)) {
+@@ -1138,7 +1194,7 @@ static void recv_generator(char *fname, 
+ 	}
+ 
+ 	if (update_only && statret == 0
+-	    && cmp_time(st.st_mtime, file->modtime) > 0) {
++	    && cmp_time(sx.st.st_mtime, file->modtime) > 0) {
+ 		if (verbose > 1)
+ 			rprintf(FINFO, "%s is newer\n", fname);
+ 		return;
+@@ -1147,20 +1203,20 @@ static void recv_generator(char *fname, 
+ 	fnamecmp = fname;
+ 	fnamecmp_type = FNAMECMP_FNAME;
+ 
+-	if (statret == 0 && !S_ISREG(st.st_mode)) {
+-		if (delete_item(fname, st.st_mode, del_opts) != 0)
++	if (statret == 0 && !S_ISREG(sx.st.st_mode)) {
++		if (delete_item(fname, sx.st.st_mode, del_opts) != 0)
+ 			return;
+ 		statret = -1;
+ 		stat_errno = ENOENT;
+ 	}
+ 
+ 	if (statret != 0 && basis_dir[0] != NULL) {
+-		int j = try_dests_reg(file, fname, ndx, fnamecmpbuf, &st,
++		int j = try_dests_reg(file, fname, ndx, fnamecmpbuf, &sx,
+ 				      itemizing, maybe_ATTRS_REPORT, code);
+ 		if (j == -2) {
+ 			if (remove_source_files == 1)
+ 				goto return_with_success;
+-			return;
++			goto cleanup;
+ 		}
+ 		if (j >= 0) {
+ 			fnamecmp = fnamecmpbuf;
+@@ -1170,7 +1226,7 @@ static void recv_generator(char *fname, 
+ 	}
+ 
+ 	real_ret = statret;
+-	real_st = st;
++	real_sx = sx;
+ 
+ 	if (partial_dir && (partialptr = partial_dir_fname(fname)) != NULL
+ 	    && link_stat(partialptr, &partial_st, 0) == 0
+@@ -1189,7 +1245,7 @@ static void recv_generator(char *fname, 
+ 				rprintf(FINFO, "fuzzy basis selected for %s: %s\n",
+ 					fname, fnamecmpbuf);
+ 			}
+-			st.st_size = fuzzy_file->length;
++			sx.st.st_size = fuzzy_file->length;
+ 			statret = 0;
+ 			fnamecmp = fnamecmpbuf;
+ 			fnamecmp_type = FNAMECMP_FUZZY;
+@@ -1198,7 +1254,7 @@ static void recv_generator(char *fname, 
+ 
+ 	if (statret != 0) {
+ 		if (preserve_hard_links && file->link_u.links
+-		    && hard_link_check(file, ndx, fname, statret, &st,
++		    && hard_link_check(file, ndx, fname, statret, &sx,
+ 				       itemizing, code, HL_SKIP))
+ 			return;
+ 		if (stat_errno == ENOENT)
+@@ -1208,39 +1264,52 @@ static void recv_generator(char *fname, 
+ 		return;
+ 	}
+ 
+-	if (append_mode && st.st_size > file->length)
++	if (append_mode && sx.st.st_size > file->length)
+ 		return;
  
- 	flist_expand(flist);
-@@ -972,6 +978,16 @@ static struct file_struct *send_file_nam
- 	if (file->basename[0]) {
- 		flist->files[flist->count++] = file;
- 		send_file_entry(file, f);
+ 	if (fnamecmp_type <= FNAMECMP_BASIS_DIR_HIGH)
+ 		;
+ 	else if (fnamecmp_type == FNAMECMP_FUZZY)
+ 		;
+-	else if (unchanged_file(fnamecmp, file, &st)) {
++	else if (unchanged_file(fnamecmp, file, &sx.st)) {
+ 		if (partialptr) {
+ 			do_unlink(partialptr);
+ 			handle_partial_dir(partialptr, PDIR_DELETE);
+ 		}
+ 		if (itemizing) {
+-			itemize(file, ndx, real_ret, &real_st,
 +#ifdef SUPPORT_ACLS
-+		if (preserve_acls)
-+			send_acl(file, f);
++			if (preserve_acls && real_ret == 0)
++				get_acl(fnamecmp, &real_sx);
 +#endif
-+	} else {
++			itemize(file, ndx, real_ret, &real_sx,
+ 				0, 0, NULL);
 +#ifdef SUPPORT_ACLS
-+		/* Cleanup unsent ACL(s). */
-+		if (preserve_acls)
-+			send_acl(file, -1);
++			if (preserve_acls) {
++				if (fnamecmp_type == FNAMECMP_FNAME) {
++					sx.acc_acl = real_sx.acc_acl;
++					sx.def_acl = real_sx.def_acl;
++				} else
++					free_acl(&real_sx);
++			}
 +#endif
+ 		}
+-		set_file_attrs(fname, file, &st, maybe_ATTRS_REPORT);
++		set_file_attrs(fname, file, &sx, maybe_ATTRS_REPORT);
+ 		if (preserve_hard_links && file->link_u.links)
+ 			hard_link_cluster(file, ndx, itemizing, code);
+ 		if (remove_source_files != 1)
+-			return;
++			goto cleanup;
+ 	  return_with_success:
+ 		if (!dry_run) {
+ 			char numbuf[4];
+ 			SIVAL(numbuf, 0, ndx);
+ 			send_msg(MSG_SUCCESS, numbuf, 4);
+ 		}
+-		return;
++		goto cleanup;
  	}
- 	return file;
- }
-@@ -1360,6 +1376,11 @@ struct file_list *recv_file_list(int f)
- 			flags |= read_byte(f) << 8;
- 		file = receive_file_entry(flist, flags, f);
  
+   prepare_to_open:
+ 	if (partialptr) {
+-		st = partial_st;
++		sx.st = partial_st;
+ 		fnamecmp = partialptr;
+ 		fnamecmp_type = FNAMECMP_PARTIAL_DIR;
+ 		statret = 0;
+@@ -1264,17 +1333,21 @@ static void recv_generator(char *fname, 
+ 	  pretend_missing:
+ 		/* pretend the file didn't exist */
+ 		if (preserve_hard_links && file->link_u.links
+-		    && hard_link_check(file, ndx, fname, statret, &st,
++		    && hard_link_check(file, ndx, fname, statret, &sx,
+ 				       itemizing, code, HL_SKIP))
+-			return;
++			goto cleanup;
+ 		statret = real_ret = -1;
 +#ifdef SUPPORT_ACLS
-+		if (preserve_acls)
-+			receive_acl(file, f);
++		if (preserve_acls && ACL_READY(sx))
++			free_acl(&sx);
 +#endif
-+
- 		if (S_ISREG(file->mode) || S_ISLNK(file->mode))
- 			stats.total_size += file->length;
+ 		goto notify_others;
+ 	}
  
-@@ -1382,6 +1403,11 @@ struct file_list *recv_file_list(int f)
+ 	if (inplace && make_backups && fnamecmp_type == FNAMECMP_FNAME) {
+ 		if (!(backupptr = get_backup_name(fname))) {
+ 			close(fd);
+-			return;
++			goto cleanup;
+ 		}
+ 		if (!(back_file = make_file(fname, NULL, NULL, 0, NO_FILTERS))) {
+ 			close(fd);
+@@ -1285,7 +1358,7 @@ static void recv_generator(char *fname, 
+ 				full_fname(backupptr));
+ 			free(back_file);
+ 			close(fd);
+-			return;
++			goto cleanup;
+ 		}
+ 		if ((f_copy = do_open(backupptr,
+ 		    O_WRONLY | O_CREAT | O_TRUNC | O_EXCL, 0600)) < 0) {
+@@ -1293,14 +1366,14 @@ static void recv_generator(char *fname, 
+ 				full_fname(backupptr));
+ 			free(back_file);
+ 			close(fd);
+-			return;
++			goto cleanup;
+ 		}
+ 		fnamecmp_type = FNAMECMP_BACKUP;
+ 	}
  
- 	clean_flist(flist, relative_paths, 1);
+ 	if (verbose > 3) {
+ 		rprintf(FINFO, "gen mapped %s of size %.0f\n",
+-			fnamecmp, (double)st.st_size);
++			fnamecmp, (double)sx.st.st_size);
+ 	}
  
+ 	if (verbose > 2)
+@@ -1318,24 +1391,32 @@ static void recv_generator(char *fname, 
+ 			iflags |= ITEM_BASIS_TYPE_FOLLOWS;
+ 		if (fnamecmp_type == FNAMECMP_FUZZY)
+ 			iflags |= ITEM_XNAME_FOLLOWS;
+-		itemize(file, -1, real_ret, &real_st, iflags, fnamecmp_type,
 +#ifdef SUPPORT_ACLS
-+	if (preserve_acls)
-+		sort_file_acl_index_lists();
++		if (preserve_acls && real_ret == 0)
++			get_acl(fnamecmp, &real_sx);
 +#endif
-+
- 	if (f >= 0) {
- 		recv_uid_list(f, flist);
- 
---- old/generator.c
-+++ new/generator.c
-@@ -85,6 +85,7 @@ extern long block_size; /* "long" becaus
- extern int max_delete;
- extern int force_delete;
- extern int one_file_system;
-+extern mode_t orig_umask;
- extern struct stats stats;
- extern dev_t filesystem_dev;
- extern char *backup_dir;
-@@ -319,6 +320,8 @@ static void do_delete_pass(struct file_l
++		itemize(file, -1, real_ret, &real_sx, iflags, fnamecmp_type,
+ 			fuzzy_file ? fuzzy_file->basename : NULL);
++#ifdef SUPPORT_ACLS
++		if (preserve_acls)
++			free_acl(&real_sx);
++#endif
+ 	}
  
- int unchanged_attrs(struct file_struct *file, STRUCT_STAT *st)
- {
-+	/* FIXME: Flag ACL changes. */
-+
- 	if (preserve_perms
- 	 && (st->st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS))
- 		return 0;
-@@ -353,6 +356,7 @@ void itemize(struct file_struct *file, i
- 		if (preserve_gid && file->gid != GID_NONE
- 		    && st->st_gid != file->gid)
- 			iflags |= ITEM_REPORT_GROUP;
-+		/* FIXME: Itemize ACL changes.  ITEM_REPORT_XATTR? */
- 	} else
- 		iflags |= ITEM_IS_NEW;
+ 	if (!do_xfers) {
+ 		if (preserve_hard_links && file->link_u.links)
+ 			hard_link_cluster(file, ndx, itemizing, code);
+-		return;
++		goto cleanup;
+ 	}
+ 	if (read_batch)
+-		return;
++		goto cleanup;
+ 
+ 	if (statret != 0 || whole_file) {
+ 		write_sum_head(f_out, NULL);
+-		return;
++		goto cleanup;
+ 	}
  
-@@ -769,6 +773,7 @@ static int try_dests_non(struct file_str
- }
+-	generate_and_send_sums(fd, st.st_size, f_out, f_copy);
++	generate_and_send_sums(fd, sx.st.st_size, f_out, f_copy);
  
- static int phase = 0;
-+static int dflt_perms;
+ 	if (f_copy >= 0) {
+ 		close(f_copy);
+@@ -1348,6 +1429,13 @@ static void recv_generator(char *fname, 
+ 	}
  
- /* Acts on the_file_list->file's ndx'th item, whose name is fname.  If a dir,
-  * make sure it exists, and has the right permissions/timestamp info.  For
-@@ -860,6 +865,10 @@ static void recv_generator(char *fname, 
- 			}
- 			if (fuzzy_basis)
- 				need_fuzzy_dirlist = 1;
+ 	close(fd);
++
++  cleanup:
 +#ifdef SUPPORT_ACLS
-+			if (!preserve_perms)
-+				dflt_perms = default_perms_for_dir(dn);
++	if (preserve_acls)
++		free_acl(&sx);
 +#endif
- 		}
- 		parent_dirname = dn;
- 
-@@ -887,7 +896,8 @@ static void recv_generator(char *fname, 
- 	if (!preserve_perms) {
- 		int exists = statret == 0
- 			  && S_ISDIR(st.st_mode) == S_ISDIR(file->mode);
--		file->mode = dest_mode(file->mode, st.st_mode, exists);
-+		file->mode = dest_mode(file->mode, st.st_mode, dflt_perms,
-+				       exists);
- 	}
++	return;
+ }
  
- 	if (S_ISDIR(file->mode)) {
-@@ -1366,6 +1376,8 @@ void generate_files(int f_out, struct fi
+ void generate_files(int f_out, struct file_list *flist, char *local_name)
+@@ -1407,6 +1495,8 @@ void generate_files(int f_out, struct fi
  	 * notice that and let us know via the redo pipe (or its closing). */
  	ignore_timeout = 1;
  
 +	dflt_perms = (ACCESSPERMS & ~orig_umask);
 +
  	for (i = 0; i < flist->count; i++) {
  		struct file_struct *file = flist->files[i];
  
+--- old/hlink.c
++++ new/hlink.c
+@@ -26,6 +26,7 @@
+ extern int verbose;
+ extern int do_xfers;
+ extern int link_dest;
++extern int preserve_acls;
+ extern int make_backups;
+ extern int remove_source_files;
+ extern int stdout_format_has_i;
+@@ -147,15 +148,19 @@ void init_hard_links(void)
+ 
+ #ifdef SUPPORT_HARD_LINKS
+ static int maybe_hard_link(struct file_struct *file, int ndx,
+-			   char *fname, int statret, STRUCT_STAT *st,
++			   char *fname, int statret, statx *sxp,
+ 			   char *toname, STRUCT_STAT *to_st,
+ 			   int itemizing, enum logcode code)
+ {
+ 	if (statret == 0) {
+-		if (st->st_dev == to_st->st_dev
+-		 && st->st_ino == to_st->st_ino) {
++		if (sxp->st.st_dev == to_st->st_dev
++		 && sxp->st.st_ino == to_st->st_ino) {
+ 			if (itemizing) {
+-				itemize(file, ndx, statret, st,
++#ifdef SUPPORT_ACLS
++				if (preserve_acls && !ACL_READY(*sxp))
++					get_acl(fname, sxp);
++#endif
++				itemize(file, ndx, statret, sxp,
+ 					ITEM_LOCAL_CHANGE | ITEM_XNAME_FOLLOWS,
+ 					0, "");
+ 			}
+@@ -170,13 +175,13 @@ static int maybe_hard_link(struct file_s
+ 			return -1;
+ 		}
+ 	}
+-	return hard_link_one(file, ndx, fname, statret, st, toname,
++	return hard_link_one(file, ndx, fname, statret, sxp, toname,
+ 			     0, itemizing, code);
+ }
+ #endif
+ 
+ int hard_link_check(struct file_struct *file, int ndx, char *fname,
+-		    int statret, STRUCT_STAT *st, int itemizing,
++		    int statret, statx *sxp, int itemizing,
+ 		    enum logcode code, int skip)
+ {
+ #ifdef SUPPORT_HARD_LINKS
+@@ -217,7 +222,7 @@ int hard_link_check(struct file_struct *
+ 						 || st2.st_ino != st3.st_ino)
+ 							continue;
+ 						statret = 1;
+-						st = &st3;
++						sxp->st = st3;
+ 						if (verbose < 2 || !stdout_format_has_i) {
+ 							itemizing = 0;
+ 							code = FNONE;
+@@ -227,12 +232,16 @@ int hard_link_check(struct file_struct *
+ 					if (!unchanged_file(cmpbuf, file, &st3))
+ 						continue;
+ 					statret = 1;
+-					st = &st3;
+-					if (unchanged_attrs(file, &st3))
++					sxp->st = st3;
++#ifdef SUPPORT_ACLS
++					if (preserve_acls)
++						get_acl(cmpbuf, sxp);
++#endif
++					if (unchanged_attrs(file, sxp))
+ 						break;
+ 				} while (basis_dir[++j] != NULL);
+ 			}
+-			maybe_hard_link(file, ndx, fname, statret, st,
++			maybe_hard_link(file, ndx, fname, statret, sxp,
+ 					toname, &st2, itemizing, code);
+ 			if (remove_source_files == 1 && do_xfers) {
+ 				char numbuf[4];
+@@ -250,7 +259,7 @@ int hard_link_check(struct file_struct *
+ 
+ #ifdef SUPPORT_HARD_LINKS
+ int hard_link_one(struct file_struct *file, int ndx, char *fname,
+-		  int statret, STRUCT_STAT *st, char *toname, int terse,
++		  int statret, statx *sxp, char *toname, int terse,
+ 		  int itemizing, enum logcode code)
+ {
+ 	if (do_link(toname, fname)) {
+@@ -266,7 +275,11 @@ int hard_link_one(struct file_struct *fi
+ 	}
+ 
+ 	if (itemizing) {
+-		itemize(file, ndx, statret, st,
++#ifdef SUPPORT_ACLS
++		if (preserve_acls && statret == 0 && !ACL_READY(*sxp))
++			get_acl(fname, sxp);
++#endif
++		itemize(file, ndx, statret, sxp,
+ 			ITEM_LOCAL_CHANGE | ITEM_XNAME_FOLLOWS, 0,
+ 			terse ? "" : toname);
+ 	}
+@@ -283,11 +296,12 @@ void hard_link_cluster(struct file_struc
+ #ifdef SUPPORT_HARD_LINKS
+ 	char hlink1[MAXPATHLEN];
+ 	char *hlink2;
+-	STRUCT_STAT st1, st2;
++	statx sx;
++	STRUCT_STAT st;
+ 	int statret, ndx = master;
+ 
+ 	file->F_HLINDEX = FINISHED_LINK;
+-	if (link_stat(f_name(file, hlink1), &st1, 0) < 0)
++	if (link_stat(f_name(file, hlink1), &st, 0) < 0)
+ 		return;
+ 	if (!(file->flags & FLAG_HLINK_TOL)) {
+ 		while (!(file->flags & FLAG_HLINK_EOL)) {
+@@ -301,9 +315,13 @@ void hard_link_cluster(struct file_struc
+ 		if (file->F_HLINDEX != SKIPPED_LINK)
+ 			continue;
+ 		hlink2 = f_name(file, NULL);
+-		statret = link_stat(hlink2, &st2, 0);
+-		maybe_hard_link(file, ndx, hlink2, statret, &st2,
+-				hlink1, &st1, itemizing, code);
++		statret = link_stat(hlink2, &sx.st, 0);
++		maybe_hard_link(file, ndx, hlink2, statret, &sx,
++				hlink1, &st, itemizing, code);
++#ifdef SUPPORT_ACLS
++		if (preserve_acls)
++			free_acl(&sx);
++#endif
+ 		if (remove_source_files == 1 && do_xfers) {
+ 			char numbuf[4];
+ 			SIVAL(numbuf, 0, ndx);
 --- old/lib/sysacls.c
 +++ new/lib/sysacls.c
-@@ -0,0 +1,3240 @@
+@@ -0,0 +1,3251 @@
 +/* 
 +   Unix SMB/CIFS implementation.
 +   Samba system utilities for ACL support.
 +   Copyright (C) Jeremy Allison 2000.
 +   
 +   This program is free software; you can redistribute it and/or modify
@@ -1620,13 +2266,20 @@
 +   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 +*/
 +
 +#include "rsync.h"
 +#include "sysacls.h" /****** ADDED ******/
 +
++#ifdef SUPPORT_ACLS
++
 +/****** EXTRAS -- THESE ITEMS ARE NOT FROM THE SAMBA SOURCE ******/
++#ifdef DEBUG
++#undef DEBUG
++#endif
++#define DEBUG(x,y)
++
 +void SAFE_FREE(void *mem)
 +{
 +	if (mem)
 +		free(mem);
 +}
 +
@@ -3896,14 +4549,16 @@
 +	struct acl_entry_link *acl_entry_link_head;
 +	int i;
 +	int rc = 0;
 +	uid_t user_id;
 +
 +	/* AIX has no DEFAULT */
-+	if  ( type == SMB_ACL_TYPE_DEFAULT )
++	if  ( type == SMB_ACL_TYPE_DEFAULT ) {
++		errno = ENOTSUP;
 +		return NULL;
++	}
 +
 +	/* Get the acl using statacl */
 + 
 +	DEBUG(10,("Entering sys_acl_get_file\n"));
 +	DEBUG(10,("path_p is %s\n",path_p));
 +
@@ -4837,15 +5492,27 @@
 +	if (err == ENOTSUP) {
 +		return 1;
 +	}
 +#endif
 +	return 0;
 +}
++
++#endif /* SUPPORT_ACLS */
 --- old/lib/sysacls.h
 +++ new/lib/sysacls.h
-@@ -0,0 +1,28 @@
+@@ -0,0 +1,40 @@
++#ifdef SUPPORT_ACLS
++
++#ifdef HAVE_SYS_ACL_H
++#include <sys/acl.h>
++#endif
++#ifdef HAVE_ACL_LIBACL_H
++#include <acl/libacl.h>
++#endif
++#include "smb_acls.h"
++
 +#define SMB_MALLOC(cnt) new_array(char, cnt)
 +#define SMB_MALLOC_P(obj) new_array(obj, 1)
 +#define SMB_MALLOC_ARRAY(obj, cnt) new_array(obj, cnt)
 +#define SMB_REALLOC(mem, cnt) realloc_array(mem, char, cnt)
 +#define slprintf snprintf
 +
@@ -4868,85 +5535,112 @@
 +int sys_acl_set_file(const char *name, SMB_ACL_TYPE_T acltype, SMB_ACL_T theacl);
 +int sys_acl_set_fd(int fd, SMB_ACL_T theacl);
 +int sys_acl_delete_def_file(const char *name);
 +int sys_acl_free_text(char *text);
 +int sys_acl_free_acl(SMB_ACL_T the_acl);
 +int sys_acl_free_qualifier(void *qual, SMB_ACL_TAG_T tagtype);
---- old/mkproto.awk
-+++ new/mkproto.awk
-@@ -58,7 +58,7 @@ BEGIN {
-   next;
- }
- 
--!/^OFF_T|^size_t|^off_t|^pid_t|^unsigned|^mode_t|^DIR|^user|^int|^char|^uint|^uchar|^short|^struct|^BOOL|^void|^time|^const|^RETSIGTYPE/ {
-+!/^OFF_T|^size_t|^off_t|^pid_t|^id_t|^unsigned|^mode_t|^DIR|^user|^int|^char|^uint|^uchar|^short|^struct|^BOOL|^void|^time|^const|^RETSIGTYPE/ {
-   next;
- }
++
++#endif /* SUPPORT_ACLS */
+--- old/log.c
++++ new/log.c
+@@ -606,8 +606,10 @@ static void log_formatted(enum logcode c
+ 			n[5] = !(iflags & ITEM_REPORT_PERMS) ? '.' : 'p';
+ 			n[6] = !(iflags & ITEM_REPORT_OWNER) ? '.' : 'o';
+ 			n[7] = !(iflags & ITEM_REPORT_GROUP) ? '.' : 'g';
+-			n[8] = '.';
+-			n[9] = '\0';
++			n[8] = !(iflags & ITEM_REPORT_ATIME) ? '.' : 'u';
++			n[9] = !(iflags & ITEM_REPORT_ACL) ? '.' : 'a';
++			n[10] = !(iflags & ITEM_REPORT_XATTR) ? '.' : 'x';
++			n[11] = '\0';
  
+ 			if (iflags & (ITEM_IS_NEW|ITEM_MISSING_DATA)) {
+ 				char ch = iflags & ITEM_IS_NEW ? '+' : '?';
 --- old/options.c
 +++ new/options.c
-@@ -45,6 +45,7 @@ int copy_dirlinks = 0;
+@@ -47,6 +47,7 @@ int copy_dirlinks = 0;
  int copy_links = 0;
  int preserve_links = 0;
  int preserve_hard_links = 0;
 +int preserve_acls = 0;
  int preserve_perms = 0;
  int preserve_executability = 0;
  int preserve_devices = 0;
-@@ -192,6 +193,7 @@ static void print_rsync_version(enum log
+@@ -199,6 +200,7 @@ static void print_rsync_version(enum log
  	char const *got_socketpair = "no ";
  	char const *have_inplace = "no ";
  	char const *hardlinks = "no ";
 +	char const *acls = "no ";
  	char const *links = "no ";
  	char const *ipv6 = "no ";
  	STRUCT_STAT *dumstat;
-@@ -208,6 +210,10 @@ static void print_rsync_version(enum log
+@@ -215,6 +217,10 @@ static void print_rsync_version(enum log
  	hardlinks = "";
  #endif
  
 +#ifdef SUPPORT_ACLS
 +	acls = "";
 +#endif
 +
  #ifdef SUPPORT_LINKS
  	links = "";
  #endif
-@@ -221,9 +227,9 @@ static void print_rsync_version(enum log
+@@ -227,17 +233,16 @@ static void print_rsync_version(enum log
+ 		RSYNC_NAME, RSYNC_VERSION, PROTOCOL_VERSION);
  	rprintf(f, "Copyright (C) 1996-2006 by Andrew Tridgell, Wayne Davison, and others.\n");
  	rprintf(f, "<http://rsync.samba.org/>\n");
- 	rprintf(f, "Capabilities: %d-bit files, %ssocketpairs, "
+-	rprintf(f, "Capabilities: %d-bit files, %ssocketpairs, "
 -		"%shard links, %ssymlinks, batchfiles,\n",
-+		"%shard links, %sACLs, %ssymlinks, batchfiles,\n",
- 		(int) (sizeof (OFF_T) * 8),
+-		(int) (sizeof (OFF_T) * 8),
 -		got_socketpair, hardlinks, links);
-+		got_socketpair, hardlinks, acls, links);
++	rprintf(f, "Capabilities: %d-bit files, %ssocketpairs, %shard links, %ssymlinks,\n",
++		(int) (sizeof (OFF_T) * 8), got_socketpair, hardlinks, links);
++
++	rprintf(f, "              batchfiles, %sinplace, %sIPv6, %sACLs,\n",
++		have_inplace, ipv6, acls);
  
  	/* Note that this field may not have type ino_t.  It depends
  	 * on the complicated interaction between largefile feature
-@@ -293,6 +299,9 @@ void usage(enum logcode F)
-   rprintf(F," -H, --hard-links            preserve hard links\n");
+ 	 * macros. */
+-	rprintf(f, "              %sinplace, %sIPv6, "
+-		"%d-bit system inums, %d-bit internal inums\n",
+-		have_inplace, ipv6,
++	rprintf(f, "              %d-bit system inums, %d-bit internal inums\n",
+ 		(int) (sizeof dumstat->st_ino * 8),
+ 		(int) (sizeof (int64) * 8));
+ #ifdef MAINTAINER_MODE
+@@ -284,7 +289,7 @@ void usage(enum logcode F)
+   rprintf(F," -q, --quiet                 suppress non-error messages\n");
+   rprintf(F,"     --no-motd               suppress daemon-mode MOTD (see manpage caveat)\n");
+   rprintf(F," -c, --checksum              skip based on checksum, not mod-time & size\n");
+-  rprintf(F," -a, --archive               archive mode; same as -rlptgoD (no -H)\n");
++  rprintf(F," -a, --archive               archive mode; same as -rlptgoD (no -H, -A)\n");
+   rprintf(F,"     --no-OPTION             turn off an implied OPTION (e.g. --no-D)\n");
+   rprintf(F," -r, --recursive             recurse into directories\n");
+   rprintf(F," -R, --relative              use relative path names\n");
+@@ -306,6 +311,9 @@ void usage(enum logcode F)
    rprintf(F," -p, --perms                 preserve permissions\n");
    rprintf(F," -E, --executability         preserve the file's executability\n");
+   rprintf(F,"     --chmod=CHMOD           affect file and/or directory permissions\n");
 +#ifdef SUPPORT_ACLS
 +  rprintf(F," -A, --acls                  preserve ACLs (implies --perms)\n");
 +#endif
-   rprintf(F,"     --chmod=CHMOD           change destination permissions\n");
    rprintf(F," -o, --owner                 preserve owner (super-user only)\n");
    rprintf(F," -g, --group                 preserve group\n");
-@@ -408,6 +417,9 @@ static struct poptOption long_options[] 
+   rprintf(F,"     --devices               preserve device files (super-user only)\n");
+@@ -425,6 +433,9 @@ static struct poptOption long_options[] 
    {"no-perms",         0,  POPT_ARG_VAL,    &preserve_perms, 0, 0, 0 },
    {"no-p",             0,  POPT_ARG_VAL,    &preserve_perms, 0, 0, 0 },
    {"executability",   'E', POPT_ARG_NONE,   &preserve_executability, 0, 0, 0 },
 +  {"acls",            'A', POPT_ARG_NONE,   0, 'A', 0, 0 },
 +  {"no-acls",          0,  POPT_ARG_VAL,    &preserve_acls, 0, 0, 0 },
 +  {"no-A",             0,  POPT_ARG_VAL,    &preserve_acls, 0, 0, 0 },
    {"times",           't', POPT_ARG_VAL,    &preserve_times, 1, 0, 0 },
    {"no-times",         0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
    {"no-t",             0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
-@@ -1066,6 +1078,24 @@ int parse_arguments(int *argc, const cha
+@@ -1089,6 +1100,24 @@ int parse_arguments(int *argc, const cha
  			usage(FINFO);
  			exit_cleanup(0);
  
 +		case 'A':
 +#ifdef SUPPORT_ACLS
 +			preserve_acls++;
@@ -4965,45 +5659,45 @@
 +#endif
 +
 +
  		default:
  			/* A large opt value means that set_refuse_options()
  			 * turned this option off. */
-@@ -1508,6 +1538,10 @@ void server_options(char **args,int *arg
+@@ -1530,6 +1559,10 @@ void server_options(char **args,int *arg
  
  	if (preserve_hard_links)
  		argstr[x++] = 'H';
 +#ifdef SUPPORT_ACLS
 +	if (preserve_acls)
 +		argstr[x++] = 'A';
 +#endif
  	if (preserve_uid)
  		argstr[x++] = 'o';
  	if (preserve_gid)
 --- old/receiver.c
 +++ new/receiver.c
-@@ -46,6 +46,7 @@ extern int keep_partial;
+@@ -47,6 +47,7 @@ extern int keep_partial;
  extern int checksum_seed;
  extern int inplace;
  extern int delay_updates;
 +extern mode_t orig_umask;
  extern struct stats stats;
- extern char *log_format;
+ extern char *stdout_format;
  extern char *tmpdir;
-@@ -344,6 +345,10 @@ int recv_files(int f_in, struct file_lis
- 	int itemizing = am_daemon ? daemon_log_format_has_i
- 		      : !am_server && log_format_has_i;
+@@ -350,6 +351,10 @@ int recv_files(int f_in, struct file_lis
+ 	int itemizing = am_server ? logfile_format_has_i : stdout_format_has_i;
+ 	enum logcode log_code = log_before_transfer ? FLOG : FINFO;
  	int max_phase = protocol_version >= 29 ? 2 : 1;
 +	int dflt_perms = (ACCESSPERMS & ~orig_umask);
 +#ifdef SUPPORT_ACLS
 +	char *parent_dirname = "";
 +#endif
  	int i, recv_ok;
  
  	if (verbose > 2)
-@@ -541,7 +546,16 @@ int recv_files(int f_in, struct file_lis
+@@ -553,7 +558,16 @@ int recv_files(int f_in, struct file_lis
  		 * mode based on the local permissions and some heuristics. */
  		if (!preserve_perms) {
  			int exists = fd1 != -1;
 -			file->mode = dest_mode(file->mode, st.st_mode, exists);
 +#ifdef SUPPORT_ACLS
 +			char *dn = file->dirname ? file->dirname : ".";
@@ -5014,105 +5708,285 @@
 +			}
 +#endif
 +			file->mode = dest_mode(file->mode, st.st_mode,
 +					       dflt_perms, exists);
  		}
  
- 		/* We now check to see if we are writing file "inplace" */
+ 		/* We now check to see if we are writing the file "inplace" */
 --- old/rsync.c
 +++ new/rsync.c
-@@ -33,6 +33,7 @@
+@@ -32,6 +32,7 @@
+ 
  extern int verbose;
  extern int dry_run;
- extern int daemon_log_format_has_i;
 +extern int preserve_acls;
  extern int preserve_perms;
  extern int preserve_executability;
  extern int preserve_times;
-@@ -101,7 +102,8 @@ void free_sums(struct sum_struct *s)
+@@ -47,7 +48,6 @@ extern int preserve_gid;
+ extern int inplace;
+ extern int keep_dirlinks;
+ extern int make_backups;
+-extern mode_t orig_umask;
+ extern struct stats stats;
+ extern struct chmod_mode_struct *daemon_chmod_modes;
+ 
+@@ -100,7 +100,8 @@ void free_sums(struct sum_struct *s)
  
  /* This is only called when we aren't preserving permissions.  Figure out what
   * the permissions should be and return them merged back into the mode. */
--mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int exists)
-+mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int dflt_perms,
+-mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int exists)
++mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int dflt_perms,
 +		 int exists)
  {
+ 	int new_mode;
  	/* If the file already exists, we'll return the local permissions,
- 	 * possibly tweaked by the --executability option. */
-@@ -116,7 +118,7 @@ mode_t dest_mode(mode_t flist_mode, mode
- 				cur_mode |= (cur_mode & 0444) >> 2;
+@@ -117,56 +118,65 @@ mode_t dest_mode(mode_t flist_mode, mode
+ 				new_mode |= (new_mode & 0444) >> 2;
+ 		}
+ 	} else {
+-		/* Apply the umask and turn off special permissions. */
+-		new_mode = flist_mode & (~CHMOD_BITS | (ACCESSPERMS & ~orig_umask));
++		/* Apply destination default permissions and turn
++		 * off special permissions. */
++		new_mode = flist_mode & (~CHMOD_BITS | dflt_perms);
+ 	}
+ 	return new_mode;
+ }
+ 
+-int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
++int set_file_attrs(char *fname, struct file_struct *file, statx *sxp,
+ 		   int flags)
+ {
+ 	int updated = 0;
+-	STRUCT_STAT st2;
++	statx sx2;
+ 	int change_uid, change_gid;
+ 	mode_t new_mode = file->mode;
+ 
+-	if (!st) {
++	if (!sxp) {
+ 		if (dry_run)
+ 			return 1;
+-		if (link_stat(fname, &st2, 0) < 0) {
++		if (link_stat(fname, &sx2.st, 0) < 0) {
+ 			rsyserr(FERROR, errno, "stat %s failed",
+ 				full_fname(fname));
+ 			return 0;
+ 		}
+-		st = &st2;
++#ifdef SUPPORT_ACLS
++		sx2.acc_acl = sx2.def_acl = NULL;
++#endif
+ 		if (!preserve_perms && S_ISDIR(new_mode)
+-		 && st->st_mode & S_ISGID) {
++		 && sx2.st.st_mode & S_ISGID) {
+ 			/* We just created this directory and its setgid
+ 			 * bit is on, so make sure it stays on. */
+ 			new_mode |= S_ISGID;
+ 		}
++		sxp = &sx2;
+ 	}
+ 
+-	if (!preserve_times || (S_ISDIR(st->st_mode) && omit_dir_times))
++#ifdef SUPPORT_ACLS
++	if (preserve_acls && !ACL_READY(*sxp))
++		get_acl(fname, sxp);
++#endif
++
++	if (!preserve_times || (S_ISDIR(sxp->st.st_mode) && omit_dir_times))
+ 		flags |= ATTRS_SKIP_MTIME;
+ 	if (!(flags & ATTRS_SKIP_MTIME)
+-	    && cmp_time(st->st_mtime, file->modtime) != 0) {
+-		int ret = set_modtime(fname, file->modtime, st->st_mode);
++	    && cmp_time(sxp->st.st_mtime, file->modtime) != 0) {
++		int ret = set_modtime(fname, file->modtime, sxp->st.st_mode);
+ 		if (ret < 0) {
+ 			rsyserr(FERROR, errno, "failed to set times on %s",
+ 				full_fname(fname));
+-			return 0;
++			goto cleanup;
+ 		}
+ 		if (ret == 0) /* ret == 1 if symlink could not be set */
+ 			updated = 1;
+ 	}
+ 
+-	change_uid = am_root && preserve_uid && st->st_uid != file->uid;
++	change_uid = am_root && preserve_uid && sxp->st.st_uid != file->uid;
+ 	change_gid = preserve_gid && file->gid != GID_NONE
+-		&& st->st_gid != file->gid;
++		&& sxp->st.st_gid != file->gid;
+ #if !defined HAVE_LCHOWN && !defined CHOWN_MODIFIES_SYMLINK
+-	if (S_ISLNK(st->st_mode))
++	if (S_ISLNK(sxp->st.st_mode))
+ 		;
+ 	else
+ #endif
+@@ -176,45 +186,57 @@ int set_file_attrs(char *fname, struct f
+ 				rprintf(FINFO,
+ 					"set uid of %s from %ld to %ld\n",
+ 					fname,
+-					(long)st->st_uid, (long)file->uid);
++					(long)sxp->st.st_uid, (long)file->uid);
+ 			}
+ 			if (change_gid) {
+ 				rprintf(FINFO,
+ 					"set gid of %s from %ld to %ld\n",
+ 					fname,
+-					(long)st->st_gid, (long)file->gid);
++					(long)sxp->st.st_gid, (long)file->gid);
+ 			}
+ 		}
+ 		if (do_lchown(fname,
+-		    change_uid ? file->uid : st->st_uid,
+-		    change_gid ? file->gid : st->st_gid) != 0) {
++		    change_uid ? file->uid : sxp->st.st_uid,
++		    change_gid ? file->gid : sxp->st.st_gid) != 0) {
+ 			/* shouldn't have attempted to change uid or gid
+ 			 * unless have the privilege */
+ 			rsyserr(FERROR, errno, "%s %s failed",
+ 			    change_uid ? "chown" : "chgrp",
+ 			    full_fname(fname));
+-			return 0;
++			goto cleanup;
+ 		}
+ 		/* a lchown had been done - we have to re-stat if the
+ 		 * destination had the setuid or setgid bits set due
+ 		 * to the side effect of the chown call */
+-		if (st->st_mode & (S_ISUID | S_ISGID)) {
+-			link_stat(fname, st,
+-				  keep_dirlinks && S_ISDIR(st->st_mode));
++		if (sxp->st.st_mode & (S_ISUID | S_ISGID)) {
++			link_stat(fname, &sxp->st,
++				  keep_dirlinks && S_ISDIR(sxp->st.st_mode));
  		}
- 	} else
--		cur_mode = flist_mode & ACCESSPERMS & ~orig_umask;
-+		cur_mode = flist_mode & ACCESSPERMS & dflt_perms;
- 	if (daemon_chmod_modes && !S_ISLNK(flist_mode))
- 		cur_mode = tweak_mode(cur_mode, daemon_chmod_modes);
- 	return (flist_mode & ~CHMOD_BITS) | (cur_mode & CHMOD_BITS);
-@@ -203,6 +205,17 @@ int set_file_attrs(char *fname, struct f
  		updated = 1;
  	}
  
+ 	if (daemon_chmod_modes && !S_ISLNK(new_mode))
+ 		new_mode = tweak_mode(new_mode, daemon_chmod_modes);
++
 +#ifdef SUPPORT_ACLS
 +	/* It's OK to call set_acl() now, even for a dir, as the generator
 +	 * will enable owner-writability using chmod, if necessary.
 +	 * 
-+	 * If set_acl changes permission bits in the process of setting
-+	 * an access ACL, it changes st->st_mode so we know whether we
-+	 * need to chmod. */
-+	if (preserve_acls && set_acl(fname, file, &st->st_mode) == 0)
++	 * If set_acl() changes permission bits in the process of setting
++	 * an access ACL, it changes sxp->st.st_mode so we know whether we
++	 * need to chmod(). */
++	if (preserve_acls && set_acl(fname, file, sxp) == 0)
 +		updated = 1;
 +#endif
 +
  #ifdef HAVE_CHMOD
- 	if ((st->st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS)) {
- 		int ret = do_chmod(fname, file->mode);
+-	if ((st->st_mode & CHMOD_BITS) != (new_mode & CHMOD_BITS)) {
++	if ((sxp->st.st_mode & CHMOD_BITS) != (new_mode & CHMOD_BITS)) {
+ 		int ret = do_chmod(fname, new_mode);
+ 		if (ret < 0) {
+ 			rsyserr(FERROR, errno,
+ 				"failed to set permissions on %s",
+ 				full_fname(fname));
+-			return 0;
++			goto cleanup;
+ 		}
+ 		if (ret == 0) /* ret == 1 if symlink could not be set */
+ 			updated = 1;
+@@ -227,6 +249,11 @@ int set_file_attrs(char *fname, struct f
+ 		else
+ 			rprintf(FCLIENT, "%s is uptodate\n", fname);
+ 	}
++  cleanup:
++#ifdef SUPPORT_ACLS
++	if (preserve_acls && sxp == &sx2)
++		free_acl(&sx2);
++#endif
+ 	return updated;
+ }
+ 
 --- old/rsync.h
 +++ new/rsync.h
-@@ -660,6 +660,20 @@ struct chmod_mode_struct;
- 
- #define UNUSED(x) x __attribute__((__unused__))
+@@ -492,6 +492,14 @@ struct idev {
+ #define IN_LOOPBACKNET 127
+ #endif
  
-+#if HAVE_POSIX_ACLS|HAVE_UNIXWARE_ACLS|HAVE_SOLARIS_ACLS|\
-+    HAVE_HPUX_ACLS|HAVE_IRIX_ACLS|HAVE_AIX_ACLS|HAVE_TRU64_ACLS
++#ifndef HAVE_NO_ACLS
 +#define SUPPORT_ACLS 1
 +#endif
 +
 +#if HAVE_UNIXWARE_ACLS|HAVE_SOLARIS_ACLS|HAVE_HPUX_ACLS
 +#define ACLS_NEED_MASK 1
 +#endif
 +
-+#if defined SUPPORT_ACLS && defined HAVE_SYS_ACL_H
-+#include <sys/acl.h>
+ #define GID_NONE ((gid_t)-1)
+ 
+ #define HL_CHECK_MASTER	0
+@@ -653,6 +661,17 @@ struct stats {
+ 
+ struct chmod_mode_struct;
+ 
++#define EMPTY_ITEM_LIST {NULL, 0, 0}
++
++typedef struct {
++	void *items;
++	size_t count;
++	size_t malloced;
++} item_list;
++
++#define EXPAND_ITEM_LIST(lp, type, incr) \
++	(type*)expand_item_list(lp, sizeof (type), #type, incr)
++
+ #include "byteorder.h"
+ #include "lib/mdfour.h"
+ #include "lib/wildmatch.h"
+@@ -669,6 +688,16 @@ struct chmod_mode_struct;
+ #define UNUSED(x) x __attribute__((__unused__))
+ #define NORETURN __attribute__((__noreturn__))
+ 
++typedef struct {
++    STRUCT_STAT st;
++#ifdef SUPPORT_ACLS
++    struct rsync_acl *acc_acl; /* access ACL */
++    struct rsync_acl *def_acl; /* default ACL */
 +#endif
-+#include "smb_acls.h"
++} statx;
++
++#define ACL_READY(sx) ((sx).acc_acl != NULL)
 +
  #include "proto.h"
  
  /* We have replacement versions of these if they're missing. */
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -321,6 +321,7 @@ to the detailed description below for a 
-  -H, --hard-links            preserve hard links
+@@ -301,7 +301,7 @@ to the detailed description below for a 
+  -q, --quiet                 suppress non-error messages
+      --no-motd               suppress daemon-mode MOTD (see caveat)
+  -c, --checksum              skip based on checksum, not mod-time & size
+- -a, --archive               archive mode; same as -rlptgoD (no -H)
++ -a, --archive               archive mode; same as -rlptgoD (no -H, -A)
+      --no-OPTION             turn off an implied OPTION (e.g. --no-D)
+  -r, --recursive             recurse into directories
+  -R, --relative              use relative path names
+@@ -323,6 +323,7 @@ to the detailed description below for a 
   -p, --perms                 preserve permissions
   -E, --executability         preserve executability
+      --chmod=CHMOD           affect file and/or directory permissions
 + -A, --acls                  preserve ACLs (implies -p) [non-standard]
-      --chmod=CHMOD           change destination permissions
   -o, --owner                 preserve owner (super-user only)
   -g, --group                 preserve group
-@@ -742,7 +743,9 @@ quote(itemize(
+      --devices               preserve device files (super-user only)
+@@ -753,7 +754,9 @@ quote(itemization(
    permissions, though the bf(--executability) option might change just
    the execute permission for the file.
    it() New files get their "normal" permission bits set to the source
 -  file's permissions masked with the receiving end's umask setting, and
 +  file's permissions masked with the receiving directory's default
 +  permissions (either the receiving process's umask, or the permissions
 +  specified via the destination directory's default ACL), and
    their special permission bits disabled except in the case where a new
    directory inherits a setgid bit from its parent directory.
  ))
-@@ -773,9 +776,11 @@ The preservation of the destination's se
+@@ -784,9 +787,11 @@ The preservation of the destination's se
  directories when bf(--perms) is off was added in rsync 2.6.7.  Older rsync
  versions erroneously preserved the three special permission bits for
  newly-created files when bf(--perms) was off, while overriding the
 -destination's setgid bit setting on a newly-created directory.  (Keep in
 -mind that it is the version of the receiving rsync that affects this
 -behavior.)
@@ -5121,13 +5995,13 @@
 +non-ACL-enabled) rsyncs use the umask even if default ACLs are present.
 +(Keep in mind that it is the version of the receiving rsync that affects
 +these behaviors.)
  
  dit(bf(-E, --executability)) This option causes rsync to preserve the
  executability (or non-executability) of regular files when bf(--perms) is
-@@ -793,6 +798,15 @@ quote(itemize(
+@@ -804,6 +809,15 @@ quote(itemization(
  
  If bf(--perms) is enabled, this option is ignored.
  
 +dit(bf(-A, --acls)) This option causes rsync to update the destination
 +ACLs to be the same as the source ACLs.  This nonstandard option only
 +works if the remote rsync also supports it.  bf(--acls) implies bf(--perms).
@@ -5137,12 +6011,36 @@
 +rsync unless you double the bf(--acls) option (e.g. bf(-AA)).  This
 +doubling is not needed when pulling files from an older rsync.
 +
  dit(bf(--chmod)) This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
  transfer.  The resulting value is treated as though it was the permissions
+@@ -1389,8 +1403,8 @@ if the receiving rsync is at least versi
+ with older versions of rsync, but that also turns on the output of other
+ verbose messages).
+ 
+-The "%i" escape has a cryptic output that is 9 letters long.  The general
+-format is like the string bf(YXcstpogz), where bf(Y) is replaced by the
++The "%i" escape has a cryptic output that is 11 letters long.  The general
++format is like the string bf(YXcstpoguax), where bf(Y) is replaced by the
+ type of update being done, bf(X) is replaced by the file-type, and the
+ other letters represent attributes that may be output if they are being
+ modified.
+@@ -1439,7 +1453,11 @@ quote(itemization(
+   sender's value (requires bf(--owner) and super-user privileges).
+   it() A bf(g) means the group is different and is being updated to the
+   sender's value (requires bf(--group) and the authority to set the group).
+-  it() The bf(z) slot is reserved for future use.
++  it() The bf(u) slot is reserved for reporting update (access) time changes
++  (a feature that is not yet released).
++  it() The bf(a) means that the ACL information changed.
++  it() The bf(x) slot is reserved for reporting extended attribute changes
++  (a feature that is not yet released).
+ ))
+ 
+ One other output is possible:  when deleting files, the "%i" will output
 --- old/smb_acls.h
 +++ new/smb_acls.h
 @@ -0,0 +1,281 @@
 +/* 
 +   Unix SMB/Netbios implementation.
 +   Version 2.2.x
@@ -5526,59 +6424,342 @@
 +testit noda2 '' rw-rw-rw- rwxrwxrwx
 +umask 0022
 +testit noda3 '' rw-r--r-- rwxr-xr-x
 +
 +# Hooray
 +exit 0
+--- old/testsuite/devices.test
++++ new/testsuite/devices.test
+@@ -42,14 +42,14 @@ touch -r "$fromdir/block" "$fromdir/bloc
+ $RSYNC -ai "$fromdir/block" "$todir/block2" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cD+++++++ block
++cD+++++++++ block
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 1 failed"
+ 
+ $RSYNC -ai "$fromdir/block2" "$todir/block" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cD+++++++ block2
++cD+++++++++ block2
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 2 failed"
+ 
+@@ -58,7 +58,7 @@ sleep 1
+ $RSYNC -Di "$fromdir/block3" "$todir/block" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cD..T.... block3
++cD..T...... block3
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 3 failed"
+ 
+@@ -66,15 +66,15 @@ $RSYNC -aiHvv "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ filter_outfile
+ cat <<EOT >"$chkfile"
+-.d..t.... ./
+-cD..t.... block
+-cD....... block2
+-cD+++++++ block3
+-hD+++++++ block2.5 => block3
+-cD+++++++ char
+-cD+++++++ char2
+-cD+++++++ char3
+-cS+++++++ fifo
++.d..t...... ./
++cD..t...... block
++cD......... block2
++cD+++++++++ block3
++hD+++++++++ block2.5 => block3
++cD+++++++++ char
++cD+++++++++ char2
++cD+++++++++ char3
++cS+++++++++ fifo
+ EOT
+ if test ! -b "$fromdir/block2.5"; then
+     sed -e '/block2\.5/d' \
+--- old/testsuite/itemize.test
++++ new/testsuite/itemize.test
+@@ -29,15 +29,15 @@ ln "$fromdir/foo/config1" "$fromdir/foo/
+ $RSYNC -iplr "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+->f+++++++ bar/baz/rsync
+-cd+++++++ foo/
+->f+++++++ foo/config1
+->f+++++++ foo/config2
+->f+++++++ foo/extra
+-cL+++++++ foo/sym -> ../bar/baz/rsync
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++>f+++++++++ bar/baz/rsync
++cd+++++++++ foo/
++>f+++++++++ foo/config1
++>f+++++++++ foo/config2
++>f+++++++++ foo/extra
++cL+++++++++ foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 1 failed"
+ 
+@@ -49,10 +49,10 @@ chmod 601 "$fromdir/foo/config2"
+ $RSYNC -iplrH "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+->f..T.... bar/baz/rsync
+->f..T.... foo/config1
+->f.sTp... foo/config2
+-hf..T.... foo/extra => foo/config1
++>f..T...... bar/baz/rsync
++>f..T...... foo/config1
++>f.sTp..... foo/config2
++hf..T...... foo/extra => foo/config1
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 2 failed"
+ 
+@@ -69,11 +69,11 @@ chmod 777 "$todir/bar/baz/rsync"
+ $RSYNC -iplrtc "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-.f..tp... bar/baz/rsync
+-.d..t.... foo/
+-.f..t.... foo/config1
+->fcstp... foo/config2
+-cL..T.... foo/sym -> ../bar/baz/rsync
++.f..tp..... bar/baz/rsync
++.d..t...... foo/
++.f..t...... foo/config1
++>fcstp..... foo/config2
++cL..T...... foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 3 failed"
+ 
+@@ -98,15 +98,15 @@ $RSYNC -ivvplrtH "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ filter_outfile
+ cat <<EOT >"$chkfile"
+-.d        ./
+-.d        bar/
+-.d        bar/baz/
+-.f...p... bar/baz/rsync
+-.d        foo/
+-.f        foo/config1
+->f..t.... foo/config2
+-hf        foo/extra
+-.L        foo/sym -> ../bar/baz/rsync
++.d          ./
++.d          bar/
++.d          bar/baz/
++.f...p..... bar/baz/rsync
++.d          foo/
++.f          foo/config1
++>f..t...... foo/config2
++hf          foo/extra
++.L          foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 5 failed"
+ 
+@@ -125,8 +125,8 @@ touch "$todir/foo/config2"
+ $RSYNC -iplrtH "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-.f...p... foo/config1
+->f..t.... foo/config2
++.f...p..... foo/config1
++>f..t...... foo/config2
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 7 failed"
+ 
+@@ -135,15 +135,15 @@ $RSYNC -ivvplrtH --copy-dest=../ld "$fro
+     | tee "$outfile"
+ filter_outfile
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-cf        bar/baz/rsync
+-cd+++++++ foo/
+-cf        foo/config1
+-cf        foo/config2
+-hf        foo/extra => foo/config1
+-cL..T.... foo/sym -> ../bar/baz/rsync
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++cf          bar/baz/rsync
++cd+++++++++ foo/
++cf          foo/config1
++cf          foo/config2
++hf          foo/extra => foo/config1
++cL..T...... foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 8 failed"
+ 
+@@ -151,11 +151,11 @@ rm -rf "$todir"
+ $RSYNC -iplrtH --copy-dest=../ld "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-cd+++++++ foo/
+-hf        foo/extra => foo/config1
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++cd+++++++++ foo/
++hf          foo/extra => foo/config1
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 9 failed"
+ 
+@@ -182,15 +182,15 @@ $RSYNC -ivvplrtH --link-dest="$lddir" "$
+     | tee "$outfile"
+ filter_outfile
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-hf        bar/baz/rsync
+-cd+++++++ foo/
+-hf        foo/config1
+-hf        foo/config2
+-hf        foo/extra => foo/config1
+-hL        foo/sym -> ../bar/baz/rsync
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++hf          bar/baz/rsync
++cd+++++++++ foo/
++hf          foo/config1
++hf          foo/config2
++hf          foo/extra => foo/config1
++hL          foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 11 failed"
+ 
+@@ -198,10 +198,10 @@ rm -rf "$todir"
+ $RSYNC -iplrtH --dry-run --link-dest=../ld "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-cd+++++++ foo/
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++cd+++++++++ foo/
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 12 failed"
+ 
+@@ -209,10 +209,10 @@ rm -rf "$todir"
+ $RSYNC -iplrtH --link-dest=../ld "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-cd+++++++ foo/
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++cd+++++++++ foo/
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 13 failed"
+ 
+@@ -240,14 +240,14 @@ filter_outfile
+ # TODO fix really-old problem when combining -H with --compare-dest:
+ # missing output for foo/extra hard-link (and it might not be updated)!
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-.f        bar/baz/rsync
+-cd+++++++ foo/
+-.f        foo/config1
+-.f        foo/config2
+-.L        foo/sym -> ../bar/baz/rsync
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++.f          bar/baz/rsync
++cd+++++++++ foo/
++.f          foo/config1
++.f          foo/config2
++.L          foo/sym -> ../bar/baz/rsync
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 15 failed"
+ 
+@@ -255,10 +255,10 @@ rm -rf "$todir"
+ $RSYNC -iplrtH --compare-dest="$lddir" "$fromdir/" "$todir/" \
+     | tee "$outfile"
+ cat <<EOT >"$chkfile"
+-cd+++++++ ./
+-cd+++++++ bar/
+-cd+++++++ bar/baz/
+-cd+++++++ foo/
++cd+++++++++ ./
++cd+++++++++ bar/
++cd+++++++++ bar/baz/
++cd+++++++++ foo/
+ EOT
+ diff $diffopt "$chkfile" "$outfile" || test_fail "test 16 failed"
+ 
 --- old/uidlist.c
 +++ new/uidlist.c
-@@ -34,6 +34,7 @@
+@@ -35,6 +35,7 @@
  extern int verbose;
  extern int preserve_uid;
  extern int preserve_gid;
 +extern int preserve_acls;
  extern int numeric_ids;
  extern int am_root;
  
-@@ -274,7 +275,7 @@ void send_uid_list(int f)
+@@ -273,7 +274,7 @@ void send_uid_list(int f)
  	if (numeric_ids)
  		return;
  
 -	if (preserve_uid) {
 +	if (preserve_uid || preserve_acls) {
  		int len;
  		/* we send sequences of uid/byte-length/name */
  		for (list = uidlist; list; list = list->next) {
-@@ -291,7 +292,7 @@ void send_uid_list(int f)
+@@ -290,7 +291,7 @@ void send_uid_list(int f)
  		write_int(f, 0);
  	}
  
 -	if (preserve_gid) {
 +	if (preserve_gid || preserve_acls) {
  		int len;
  		for (list = gidlist; list; list = list->next) {
  			if (!list->name)
-@@ -312,7 +313,7 @@ void recv_uid_list(int f, struct file_li
+@@ -311,7 +312,7 @@ void recv_uid_list(int f, struct file_li
  	int id, i;
  	char *name;
  
 -	if (preserve_uid && !numeric_ids) {
 +	if ((preserve_uid || preserve_acls) && !numeric_ids) {
  		/* read the uid list */
  		while ((id = read_int(f)) != 0) {
  			int len = read_byte(f);
-@@ -324,7 +325,7 @@ void recv_uid_list(int f, struct file_li
+@@ -323,7 +324,7 @@ void recv_uid_list(int f, struct file_li
  		}
  	}
  
 -	if (preserve_gid && !numeric_ids) {
 +	if ((preserve_gid || preserve_acls) && !numeric_ids) {
  		/* read the gid list */
  		while ((id = read_int(f)) != 0) {
  			int len = read_byte(f);
-@@ -336,6 +337,16 @@ void recv_uid_list(int f, struct file_li
+@@ -335,6 +336,16 @@ void recv_uid_list(int f, struct file_li
  		}
  	}
  
 +#ifdef SUPPORT_ACLS
 +	if (preserve_acls && !numeric_ids) {
 +		id_t *id;
@@ -5589,63 +6770,126 @@
 +	}
 +#endif
 +
  	/* Now convert all the uids/gids from sender values to our values. */
  	if (am_root && preserve_uid && !numeric_ids) {
  		for (i = 0; i < flist->count; i++)
+--- old/util.c
++++ new/util.c
+@@ -1468,3 +1468,31 @@ int bitbag_next_bit(struct bitbag *bb, i
+ 
+ 	return -1;
+ }
++
++void *expand_item_list(item_list *lp, size_t item_size,
++		       const char *desc, int incr)
++{
++	/* First time through, 0 <= 0, so list is expanded. */
++	if (lp->malloced <= lp->count) {
++		void *new_ptr;
++		size_t new_size = lp->malloced;
++		if (incr < 0)
++			new_size -= incr; /* increase slowly */
++		else if (new_size < (size_t)incr)
++			new_size += incr;
++		else
++			new_size *= 2;
++		new_ptr = realloc_array(lp->items, char, new_size * item_size);
++		if (verbose >= 4) {
++			rprintf(FINFO, "[%s] expand %s to %.0f bytes, did%s move\n",
++				who_am_i(), desc, (double)new_size * item_size,
++				new_ptr == lp->items ? " not" : "");
++		}
++		if (!new_ptr)
++			out_of_memory("expand_item_list");
++
++		lp->items = new_ptr;
++		lp->malloced = new_size;
++	}
++	return (char*)lp->items + (lp->count++ * item_size);
++}
 --- old/proto.h
 +++ new/proto.h
-@@ -1,6 +1,18 @@
+@@ -1,6 +1,15 @@
  /* This file is automatically generated with "make proto". DO NOT EDIT */
  
  int allow_access(char *addr, char *host, char *allow_list, char *deny_list);
-+int make_acl(const struct file_struct *file, const char *fname);
-+void send_acl(const struct file_struct *file, int f);
++void free_acl(statx *sxp);
++int get_acl(const char *fname, statx *sxp);
++void send_acl(statx *sxp, int f);
 +void receive_acl(struct file_struct *file, int f);
-+void sort_file_acl_index_lists();
-+int dup_acl(const char *orig, const char *bak, mode_t mode);
-+void push_keep_backup_acl(const struct file_struct *file,
-+			  const char *orig, const char *dest);
-+void cleanup_keep_backup_acl();
-+int set_acl(const char *fname, const struct file_struct *file, mode_t *mode_p);
++void cache_acl(struct file_struct *file, statx *sxp);
++int set_acl(const char *fname, const struct file_struct *file, statx *sxp);
 +id_t *next_acl_uid();
 +id_t *next_acl_gid();
 +int default_perms_for_dir(const char *dir);
  void base64_encode(char *buf, int len, char *out, int pad);
  char *auth_server(int f_in, int f_out, int module, char *host, char *addr,
  		  char *leader);
-@@ -223,7 +235,8 @@ void show_progress(OFF_T ofs, OFF_T size
+@@ -83,18 +92,18 @@ int f_name_cmp(struct file_struct *f1, s
+ char *f_name(struct file_struct *f, char *fbuf);
+ struct file_list *get_dirlist(char *dirname, int dlen,
+ 			      int ignore_filter_rules);
+-int unchanged_attrs(struct file_struct *file, STRUCT_STAT *st);
+-void itemize(struct file_struct *file, int ndx, int statret, STRUCT_STAT *st,
++int unchanged_attrs(struct file_struct *file, statx *sxp);
++void itemize(struct file_struct *file, int ndx, int statret, statx *sxp,
+ 	     int32 iflags, uchar fnamecmp_type, char *xname);
+ int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st);
+ void check_for_finished_hlinks(int itemizing, enum logcode code);
+ void generate_files(int f_out, struct file_list *flist, char *local_name);
+ void init_hard_links(void);
+ int hard_link_check(struct file_struct *file, int ndx, char *fname,
+-		    int statret, STRUCT_STAT *st, int itemizing,
++		    int statret, statx *sxp, int itemizing,
+ 		    enum logcode code, int skip);
+ int hard_link_one(struct file_struct *file, int ndx, char *fname,
+-		  int statret, STRUCT_STAT *st, char *toname, int terse,
++		  int statret, statx *sxp, char *toname, int terse,
+ 		  int itemizing, enum logcode code);
+ void hard_link_cluster(struct file_struct *file, int master, int itemizing,
+ 		       enum logcode code);
+@@ -223,8 +232,9 @@ void show_progress(OFF_T ofs, OFF_T size
  int recv_files(int f_in, struct file_list *flist, char *local_name);
  void setup_iconv();
  void free_sums(struct sum_struct *s);
--mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int exists);
-+mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int dflt_perms,
+-mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int exists);
+-int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
++mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int dflt_perms,
 +		 int exists);
- int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
++int set_file_attrs(char *fname, struct file_struct *file, statx *sxp,
  		   int flags);
  RETSIGTYPE sig_int(UNUSED(int val));
+ void finish_transfer(char *fname, char *fnametmp, char *partialptr,
+@@ -320,4 +330,6 @@ void bitbag_set_bit(struct bitbag *bb, i
+ void bitbag_clear_bit(struct bitbag *bb, int ndx);
+ int bitbag_check_bit(struct bitbag *bb, int ndx);
+ int bitbag_next_bit(struct bitbag *bb, int after);
++void *expand_item_list(item_list *lp, size_t item_size,
++		       const char *desc, int incr);
+ int sys_gettimeofday(struct timeval *tv);
 --- old/configure
 +++ new/configure
-@@ -852,6 +852,7 @@ Optional Features:
+@@ -1258,6 +1258,7 @@ Optional Features:
    --disable-largefile     omit support for large files
    --disable-ipv6          don't even try to use IPv6
    --disable-locale        turn off locale features
 +  --enable-acl-support    Include ACL support (default=no)
  
  Optional Packages:
    --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-@@ -10491,6 +10492,183 @@ fi
+@@ -12941,6 +12942,206 @@ fi
  fi
  
  
 +for ac_func in aclsort
 +do
 +as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-+echo "$as_me:$LINENO: checking for $ac_func" >&5
-+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_var+set}\" = set"; then
++{ echo "$as_me:$LINENO: checking for $ac_func" >&5
++echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
++if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
@@ -5665,235 +6909,279 @@
 +#else
 +# include <assert.h>
 +#endif
 +
 +#undef $ac_func
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
-+{
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char $ac_func ();
 +/* The GNU C library defines this for functions which it implements
 +    to always fail with ENOSYS.  Some functions are actually named
 +    something starting with __ and the normal name is an alias.  */
-+#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
++#if defined __stub_$ac_func || defined __stub___$ac_func
 +choke me
-+#else
-+char (*f) () = $ac_func;
-+#endif
-+#ifdef __cplusplus
-+}
 +#endif
 +
 +int
 +main ()
 +{
-+return f != $ac_func;
++return $ac_func ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  eval "$as_ac_var=yes"
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+eval "$as_ac_var=no"
++	eval "$as_ac_var=no"
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
++ac_res=`eval echo '${'$as_ac_var'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +if test `eval echo '${'$as_ac_var'}'` = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 +_ACEOF
 +
 +fi
 +done
 +
 +if test x"$ac_cv_func_aclsort" = x"no"; then
 +
-+echo "$as_me:$LINENO: checking for aclsort in -lsec" >&5
-+echo $ECHO_N "checking for aclsort in -lsec... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking for aclsort in -lsec" >&5
++echo $ECHO_N "checking for aclsort in -lsec... $ECHO_C" >&6; }
 +if test "${ac_cv_lib_sec_aclsort+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_check_lib_save_LIBS=$LIBS
 +LIBS="-lsec  $LIBS"
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char aclsort ();
 +int
 +main ()
 +{
-+aclsort ();
++return aclsort ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_cv_lib_sec_aclsort=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_cv_lib_sec_aclsort=no
++	ac_cv_lib_sec_aclsort=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +LIBS=$ac_check_lib_save_LIBS
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_lib_sec_aclsort" >&5
-+echo "${ECHO_T}$ac_cv_lib_sec_aclsort" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_lib_sec_aclsort" >&5
++echo "${ECHO_T}$ac_cv_lib_sec_aclsort" >&6; }
 +if test $ac_cv_lib_sec_aclsort = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define HAVE_LIBSEC 1
 +_ACEOF
 +
 +  LIBS="-lsec $LIBS"
 +
 +fi
 +
 +fi
 +
 +
- echo "$as_me:$LINENO: checking whether utime accepts a null argument" >&5
- echo $ECHO_N "checking whether utime accepts a null argument... $ECHO_C" >&6
+ { echo "$as_me:$LINENO: checking whether utime accepts a null argument" >&5
+ echo $ECHO_N "checking whether utime accepts a null argument... $ECHO_C" >&6; }
  if test "${ac_cv_func_utime_null+set}" = set; then
-@@ -12110,6 +12288,558 @@ fi
+@@ -14808,6 +15009,625 @@ fi
  
  
  
 +
-+for ac_header in sys/acl.h
++
++for ac_header in sys/acl.h acl/libacl.h
 +do
 +as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
-+  echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  { echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +else
 +  # Is the header compilable?
-+echo "$as_me:$LINENO: checking $ac_header usability" >&5
-+echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
++echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +$ac_includes_default
 +#include <$ac_header>
 +_ACEOF
 +rm -f conftest.$ac_objext
-+if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-+  (eval $ac_compile) 2>conftest.er1
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest.$ac_objext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_header_compiler=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_header_compiler=no
++	ac_header_compiler=no
 +fi
-+rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-+echo "${ECHO_T}$ac_header_compiler" >&6
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
 +
 +# Is the header present?
-+echo "$as_me:$LINENO: checking $ac_header presence" >&5
-+echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
++echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +#include <$ac_header>
 +_ACEOF
-+if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } >/dev/null; then
@@ -5911,15 +7199,16 @@
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
 +  ac_header_preproc=no
 +fi
++
 +rm -f conftest.err conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-+echo "${ECHO_T}$ac_header_preproc" >&6
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
 +
 +# So?  What about this header?
 +case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
 +  yes:no: )
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
 +echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -5937,31 +7226,25 @@
 +    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
 +echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
 +echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
 +echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
-+    (
-+      cat <<\_ASBOX
-+## ------------------------------------------ ##
-+## Report this to the AC_PACKAGE_NAME lists.  ##
-+## ------------------------------------------ ##
-+_ASBOX
-+    ) |
-+      sed "s/^/$as_me: WARNING:     /" >&2
++
 +    ;;
 +esac
-+echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++{ echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  eval "$as_ac_Header=\$ac_header_preproc"
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +
 +fi
 +if test `eval echo '${'$as_ac_Header'}'` = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
 +_ACEOF
@@ -5974,15 +7257,15 @@
 +
 +
 +
 +for ac_func in _acl __acl _facl __facl
 +do
 +as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-+echo "$as_me:$LINENO: checking for $ac_func" >&5
-+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_var+set}\" = set"; then
++{ echo "$as_me:$LINENO: checking for $ac_func" >&5
++echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6; }
++if { as_var=$as_ac_var; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
@@ -6002,226 +7285,248 @@
 +#else
 +# include <assert.h>
 +#endif
 +
 +#undef $ac_func
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
-+{
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char $ac_func ();
 +/* The GNU C library defines this for functions which it implements
 +    to always fail with ENOSYS.  Some functions are actually named
 +    something starting with __ and the normal name is an alias.  */
-+#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
++#if defined __stub_$ac_func || defined __stub___$ac_func
 +choke me
-+#else
-+char (*f) () = $ac_func;
-+#endif
-+#ifdef __cplusplus
-+}
 +#endif
 +
 +int
 +main ()
 +{
-+return f != $ac_func;
++return $ac_func ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  eval "$as_ac_var=yes"
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+eval "$as_ac_var=no"
++	eval "$as_ac_var=no"
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_var'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
++ac_res=`eval echo '${'$as_ac_var'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +if test `eval echo '${'$as_ac_var'}'` = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
 +_ACEOF
 +
 +fi
 +done
 +
 +#################################################
 +# check for ACL support
 +
-+echo "$as_me:$LINENO: checking whether to support ACLs" >&5
-+echo $ECHO_N "checking whether to support ACLs... $ECHO_C" >&6
-+# Check whether --enable-acl-support or --disable-acl-support was given.
++{ echo "$as_me:$LINENO: checking whether to support ACLs" >&5
++echo $ECHO_N "checking whether to support ACLs... $ECHO_C" >&6; }
++# Check whether --enable-acl-support was given.
 +if test "${enable_acl_support+set}" = set; then
-+  enableval="$enable_acl_support"
-+   case "$enableval" in
++  enableval=$enable_acl_support;  case "$enableval" in
 +  yes)
 +
 +		case "$host_os" in
 +		*sysv5*)
-+			echo "$as_me:$LINENO: result: Using UnixWare ACLs" >&5
-+echo "${ECHO_T}Using UnixWare ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using UnixWare ACLs" >&5
++echo "${ECHO_T}Using UnixWare ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_UNIXWARE_ACLS 1
 +_ACEOF
 +
 +			;;
 +		*solaris*|*cygwin*)
-+			echo "$as_me:$LINENO: result: Using solaris ACLs" >&5
-+echo "${ECHO_T}Using solaris ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using solaris ACLs" >&5
++echo "${ECHO_T}Using solaris ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_SOLARIS_ACLS 1
 +_ACEOF
 +
 +			;;
 +		*hpux*)
-+			echo "$as_me:$LINENO: result: Using HPUX ACLs" >&5
-+echo "${ECHO_T}Using HPUX ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using HPUX ACLs" >&5
++echo "${ECHO_T}Using HPUX ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_HPUX_ACLS 1
 +_ACEOF
 +
 +			;;
 +		*irix*)
-+			echo "$as_me:$LINENO: result: Using IRIX ACLs" >&5
-+echo "${ECHO_T}Using IRIX ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using IRIX ACLs" >&5
++echo "${ECHO_T}Using IRIX ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_IRIX_ACLS 1
 +_ACEOF
 +
 +			;;
 +		*aix*)
-+			echo "$as_me:$LINENO: result: Using AIX ACLs" >&5
-+echo "${ECHO_T}Using AIX ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using AIX ACLs" >&5
++echo "${ECHO_T}Using AIX ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_AIX_ACLS 1
 +_ACEOF
 +
 +			;;
 +		*osf*)
-+			echo "$as_me:$LINENO: result: Using Tru64 ACLs" >&5
-+echo "${ECHO_T}Using Tru64 ACLs" >&6
++			{ echo "$as_me:$LINENO: result: Using Tru64 ACLs" >&5
++echo "${ECHO_T}Using Tru64 ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_TRU64_ACLS 1
 +_ACEOF
 +
 +			LIBS="$LIBS -lpacl"
 +			;;
 +		*)
-+		    echo "$as_me:$LINENO: result: ACLs requested -- running tests" >&5
-+echo "${ECHO_T}ACLs requested -- running tests" >&6
++		    { echo "$as_me:$LINENO: result: ACLs requested -- running tests" >&5
++echo "${ECHO_T}ACLs requested -- running tests" >&6; }
 +
-+echo "$as_me:$LINENO: checking for acl_get_file in -lacl" >&5
-+echo $ECHO_N "checking for acl_get_file in -lacl... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking for acl_get_file in -lacl" >&5
++echo $ECHO_N "checking for acl_get_file in -lacl... $ECHO_C" >&6; }
 +if test "${ac_cv_lib_acl_acl_get_file+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_check_lib_save_LIBS=$LIBS
 +LIBS="-lacl  $LIBS"
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char acl_get_file ();
 +int
 +main ()
 +{
-+acl_get_file ();
++return acl_get_file ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_cv_lib_acl_acl_get_file=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_cv_lib_acl_acl_get_file=no
++	ac_cv_lib_acl_acl_get_file=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +LIBS=$ac_check_lib_save_LIBS
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_lib_acl_acl_get_file" >&5
-+echo "${ECHO_T}$ac_cv_lib_acl_acl_get_file" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_lib_acl_acl_get_file" >&5
++echo "${ECHO_T}$ac_cv_lib_acl_acl_get_file" >&6; }
 +if test $ac_cv_lib_acl_acl_get_file = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define HAVE_LIBACL 1
 +_ACEOF
 +
 +  LIBS="-lacl $LIBS"
 +
 +fi
 +
-+			echo "$as_me:$LINENO: checking for ACL support" >&5
-+echo $ECHO_N "checking for ACL support... $ECHO_C" >&6
++			{ echo "$as_me:$LINENO: checking for ACL support" >&5
++echo $ECHO_N "checking for ACL support... $ECHO_C" >&6; }
 +if test "${samba_cv_HAVE_POSIX_ACLS+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +
 +			cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
@@ -6237,56 +7542,70 @@
 + acl_t acl; int entry_id; acl_entry_t *entry_p; return acl_get_entry( acl, entry_id, entry_p);
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  samba_cv_HAVE_POSIX_ACLS=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+samba_cv_HAVE_POSIX_ACLS=no
++	samba_cv_HAVE_POSIX_ACLS=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +fi
-+echo "$as_me:$LINENO: result: $samba_cv_HAVE_POSIX_ACLS" >&5
-+echo "${ECHO_T}$samba_cv_HAVE_POSIX_ACLS" >&6
-+			echo "$as_me:$LINENO: checking ACL test results" >&5
-+echo $ECHO_N "checking ACL test results... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: result: $samba_cv_HAVE_POSIX_ACLS" >&5
++echo "${ECHO_T}$samba_cv_HAVE_POSIX_ACLS" >&6; }
++			{ echo "$as_me:$LINENO: checking ACL test results" >&5
++echo $ECHO_N "checking ACL test results... $ECHO_C" >&6; }
 +			if test x"$samba_cv_HAVE_POSIX_ACLS" = x"yes"; then
-+			    echo "$as_me:$LINENO: result: Using posix ACLs" >&5
-+echo "${ECHO_T}Using posix ACLs" >&6
++			    { echo "$as_me:$LINENO: result: Using posix ACLs" >&5
++echo "${ECHO_T}Using posix ACLs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_POSIX_ACLS 1
 +_ACEOF
 +
-+			    echo "$as_me:$LINENO: checking for acl_get_perm_np" >&5
-+echo $ECHO_N "checking for acl_get_perm_np... $ECHO_C" >&6
++			    { echo "$as_me:$LINENO: checking for acl_get_perm_np" >&5
++echo $ECHO_N "checking for acl_get_perm_np... $ECHO_C" >&6; }
 +if test "${samba_cv_HAVE_ACL_GET_PERM_NP+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +
 +				cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
@@ -6302,44 +7621,58 @@
 + acl_permset_t permset_d; acl_perm_t perm; return acl_get_perm_np( permset_d, perm);
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  samba_cv_HAVE_ACL_GET_PERM_NP=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+samba_cv_HAVE_ACL_GET_PERM_NP=no
++	samba_cv_HAVE_ACL_GET_PERM_NP=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +fi
-+echo "$as_me:$LINENO: result: $samba_cv_HAVE_ACL_GET_PERM_NP" >&5
-+echo "${ECHO_T}$samba_cv_HAVE_ACL_GET_PERM_NP" >&6
++{ echo "$as_me:$LINENO: result: $samba_cv_HAVE_ACL_GET_PERM_NP" >&5
++echo "${ECHO_T}$samba_cv_HAVE_ACL_GET_PERM_NP" >&6; }
 +			    if test x"$samba_cv_HAVE_ACL_GET_PERM_NP" = x"yes"; then
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_ACL_GET_PERM_NP 1
 +_ACEOF
 +
@@ -6350,14 +7683,14 @@
 +   { (exit 1); exit 1; }; }
 +			fi
 +			;;
 +		esac
 +		;;
 +  *)
-+    echo "$as_me:$LINENO: result: no" >&5
-+echo "${ECHO_T}no" >&6
++    { echo "$as_me:$LINENO: result: no" >&5
++echo "${ECHO_T}no" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_NO_ACLS 1
 +_ACEOF
 +
 +    ;;
@@ -6365,79 +7698,83 @@
 +else
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_NO_ACLS 1
 +_ACEOF
 +
-+  echo "$as_me:$LINENO: result: no" >&5
-+echo "${ECHO_T}no" >&6
++  { echo "$as_me:$LINENO: result: no" >&5
++echo "${ECHO_T}no" >&6; }
++
++fi
 +
-+fi;
 +
-                                                   ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
+ ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
  
  cat >confcache <<\_ACEOF
 --- old/config.h.in
 +++ new/config.h.in
-@@ -27,6 +27,15 @@
+@@ -27,6 +27,18 @@
  /* Define to 1 if the `getpgrp' function requires zero arguments. */
  #undef GETPGRP_VOID
  
 +/* Define to 1 if you have the `aclsort' function. */
 +#undef HAVE_ACLSORT
 +
 +/* true if you have acl_get_perm_np */
 +#undef HAVE_ACL_GET_PERM_NP
 +
++/* Define to 1 if you have the <acl/libacl.h> header file. */
++#undef HAVE_ACL_LIBACL_H
++
 +/* true if you have AIX ACLs */
 +#undef HAVE_AIX_ACLS
 +
  /* Define to 1 if you have `alloca', as a function or macro. */
  #undef HAVE_ALLOCA
  
-@@ -119,6 +128,9 @@
+@@ -119,6 +131,9 @@
  /* Define to 1 if you have the <grp.h> header file. */
  #undef HAVE_GRP_H
  
 +/* true if you have HPUX ACLs */
 +#undef HAVE_HPUX_ACLS
 +
  /* Define to 1 if you have the <iconv.h> header file. */
  #undef HAVE_ICONV_H
  
-@@ -134,6 +146,9 @@
+@@ -134,6 +149,9 @@
  /* Define to 1 if you have the <inttypes.h> header file. */
  #undef HAVE_INTTYPES_H
  
 +/* true if you have IRIX ACLs */
 +#undef HAVE_IRIX_ACLS
 +
  /* Define to 1 if you have the <langinfo.h> header file. */
  #undef HAVE_LANGINFO_H
  
-@@ -143,6 +158,9 @@
+@@ -143,6 +161,9 @@
  /* Define to 1 if you have the `lchown' function. */
  #undef HAVE_LCHOWN
  
 +/* Define to 1 if you have the `acl' library (-lacl). */
 +#undef HAVE_LIBACL
 +
  /* Define to 1 if you have the <libcharset.h> header file. */
  #undef HAVE_LIBCHARSET_H
  
-@@ -161,6 +179,9 @@
+@@ -161,6 +182,9 @@
  /* Define to 1 if you have the `resolv' library (-lresolv). */
  #undef HAVE_LIBRESOLV
  
 +/* Define to 1 if you have the `sec' library (-lsec). */
 +#undef HAVE_LIBSEC
 +
  /* Define to 1 if you have the `socket' library (-lsocket). */
  #undef HAVE_LIBSOCKET
  
-@@ -222,9 +243,15 @@
+@@ -226,9 +250,15 @@
  /* Define to 1 if you have the `nl_langinfo' function. */
  #undef HAVE_NL_LANGINFO
  
 +/* true if you don't have ACLs */
 +#undef HAVE_NO_ACLS
 +
@@ -6447,33 +7784,33 @@
 +/* true if you have posix ACLs */
 +#undef HAVE_POSIX_ACLS
 +
  /* Define to 1 if you have the `putenv' function. */
  #undef HAVE_PUTENV
  
-@@ -276,6 +303,9 @@
+@@ -280,6 +310,9 @@
  /* Define to 1 if you have the "socketpair" function */
  #undef HAVE_SOCKETPAIR
  
 +/* true if you have solaris ACLs */
 +#undef HAVE_SOLARIS_ACLS
 +
  /* Define to 1 if you have the <stdint.h> header file. */
  #undef HAVE_STDINT_H
  
-@@ -321,6 +351,9 @@
+@@ -325,6 +358,9 @@
  /* Define to 1 if `st_rdev' is member of `struct stat'. */
  #undef HAVE_STRUCT_STAT_ST_RDEV
  
 +/* Define to 1 if you have the <sys/acl.h> header file. */
 +#undef HAVE_SYS_ACL_H
 +
  /* Define to 1 if you have the <sys/dir.h> header file, and it defines `DIR'.
     */
  #undef HAVE_SYS_DIR_H
-@@ -371,9 +404,15 @@
+@@ -375,9 +411,15 @@
  /* Define to 1 if you have the `tcgetpgrp' function. */
  #undef HAVE_TCGETPGRP
  
 +/* true if you have Tru64 ACLs */
 +#undef HAVE_TRU64_ACLS
 +
@@ -6483,13 +7820,13 @@
 +/* true if you have UnixWare ACLs */
 +#undef HAVE_UNIXWARE_ACLS
 +
  /* Define to 1 if you have the "struct utimbuf" type */
  #undef HAVE_UTIMBUF
  
-@@ -404,6 +443,18 @@
+@@ -408,6 +450,18 @@
  /* Define to 1 if you have the `waitpid' function. */
  #undef HAVE_WAITPID
  
 +/* Define to 1 if you have the `_acl' function. */
 +#undef HAVE__ACL
 +
@@ -6504,57 +7841,92 @@
 +
  /* Define to 1 if you have the `__va_copy' function. */
  #undef HAVE___VA_COPY
  
 --- old/rsync.1
 +++ new/rsync.1
-@@ -377,6 +377,7 @@ to the detailed description below for a 
-  -H, --hard-links            preserve hard links
-  -p, --perms                 preserve permissions
-  -E, --executability         preserve executability
-+ -A, --acls                  preserve ACLs (implies -p) [non-standard]
-      --chmod=CHMOD           change destination permissions
-  -o, --owner                 preserve owner (super-user only)
-  -g, --group                 preserve group
-@@ -845,7 +846,9 @@ permissions, though the \fB--executabili
+@@ -367,7 +367,7 @@ to the detailed description below for a 
+  \-q, \-\-quiet                 suppress non-error messages
+      \-\-no\-motd               suppress daemon-mode MOTD (see caveat)
+  \-c, \-\-checksum              skip based on checksum, not mod-time & size
+- \-a, \-\-archive               archive mode; same as \-rlptgoD (no \-H)
++ \-a, \-\-archive               archive mode; same as \-rlptgoD (no \-H, \-A)
+      \-\-no\-OPTION             turn off an implied OPTION (e\&.g\&. \-\-no\-D)
+  \-r, \-\-recursive             recurse into directories
+  \-R, \-\-relative              use relative path names
+@@ -389,6 +389,7 @@ to the detailed description below for a 
+  \-p, \-\-perms                 preserve permissions
+  \-E, \-\-executability         preserve executability
+      \-\-chmod=CHMOD           affect file and/or directory permissions
++ \-A, \-\-acls                  preserve ACLs (implies \-p) [non-standard]
+  \-o, \-\-owner                 preserve owner (super-user only)
+  \-g, \-\-group                 preserve group
+      \-\-devices               preserve device files (super-user only)
+@@ -870,7 +871,9 @@ permissions, though the \fB\-\-executabi
  the execute permission for the file\&.
  .IP o 
  New files get their "normal" permission bits set to the source
 -file\&'s permissions masked with the receiving end\&'s umask setting, and
 +file\&'s permissions masked with the receiving directory\&'s default
 +permissions (either the receiving process\&'s umask, or the permissions
 +specified via the destination directory\&'s default ACL), and
  their special permission bits disabled except in the case where a new
  directory inherits a setgid bit from its parent directory\&.
- .RE 
-@@ -880,9 +883,11 @@ The preservation of the destination\&'s 
- directories when \fB--perms\fP is off was added in rsync 2\&.6\&.7\&.  Older rsync
+ .RE
+@@ -908,9 +911,11 @@ The preservation of the destination\&'s 
+ directories when \fB\-\-perms\fP is off was added in rsync 2\&.6\&.7\&.  Older rsync
  versions erroneously preserved the three special permission bits for
- newly-created files when \fB--perms\fP was off, while overriding the
+ newly-created files when \fB\-\-perms\fP was off, while overriding the
 -destination\&'s setgid bit setting on a newly-created directory\&.  (Keep in
 -mind that it is the version of the receiving rsync that affects this
 -behavior\&.)
 +destination\&'s setgid bit setting on a newly-created directory\&.  Default ACL
 +observance was added to the ACL patch for rsync 2\&.6\&.7, so older (or
 +non-ACL-enabled) rsyncs use the umask even if default ACLs are present\&.
 +(Keep in mind that it is the version of the receiving rsync that affects
 +these behaviors\&.)
  .IP 
- .IP "\fB-E, --executability\fP" 
+ .IP "\fB\-E, \-\-executability\fP"
  This option causes rsync to preserve the
-@@ -903,6 +908,16 @@ has a corresponding \&'r\&' permission e
+@@ -932,6 +937,16 @@ has a corresponding \&'r\&' permission e
  .IP 
- If \fB--perms\fP is enabled, this option is ignored\&.
+ If \fB\-\-perms\fP is enabled, this option is ignored\&.
  .IP 
-+.IP "\fB-A, --acls\fP" 
++.IP "\fB\-A, \-\-acls\fP"
 +This option causes rsync to update the destination
 +ACLs to be the same as the source ACLs\&.  This nonstandard option only
-+works if the remote rsync also supports it\&.  \fB--acls\fP implies \fB--perms\fP\&.
++works if the remote rsync also supports it\&.  \fB\-\-acls\fP implies \fB\-\-perms\fP\&.
 +.IP 
 +Note also that an optimization of the ACL-sending protocol used by this
 +version makes it incompatible with sending files to an older ACL-enabled
-+rsync unless you double the \fB--acls\fP option (e\&.g\&. \fB-AA\fP)\&.  This
++rsync unless you double the \fB\-\-acls\fP option (e\&.g\&. \fB\-AA\fP)\&.  This
 +doubling is not needed when pulling files from an older rsync\&.
 +.IP 
- .IP "\fB--chmod\fP" 
+ .IP "\fB\-\-chmod\fP"
  This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
+@@ -1605,8 +1620,8 @@ if the receiving rsync is at least versi
+ with older versions of rsync, but that also turns on the output of other
+ verbose messages)\&.
+ .IP 
+-The "%i" escape has a cryptic output that is 9 letters long\&.  The general
+-format is like the string \fBYXcstpogz\fP, where \fBY\fP is replaced by the
++The "%i" escape has a cryptic output that is 11 letters long\&.  The general
++format is like the string \fBYXcstpoguax\fP, where \fBY\fP is replaced by the
+ type of update being done, \fBX\fP is replaced by the file-type, and the
+ other letters represent attributes that may be output if they are being
+ modified\&.
+@@ -1668,7 +1683,13 @@ sender\&'s value (requires \fB\-\-owner\
+ A \fBg\fP means the group is different and is being updated to the
+ sender\&'s value (requires \fB\-\-group\fP and the authority to set the group)\&.
+ .IP o 
+-The \fBz\fP slot is reserved for future use\&.
++The \fBu\fP slot is reserved for reporting update (access) time changes
++(a feature that is not yet released)\&.
++.IP o 
++The \fBa\fP means that the ACL information changed\&.
++.IP o 
++The \fBx\fP slot is reserved for reporting extended attribute changes
++(a feature that is not yet released)\&.
+ .RE
+ 
+ .IP 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/adaptec_acl_mods.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/adaptec_acl_mods.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/adaptec_acl_mods.diff	2006-03-22 17:24:41.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/adaptec_acl_mods.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,11 +1,10 @@
-Depends-On-Patch: acls.diff
-
-After applying the above patch and this one, run these commands for a
-successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/acls.diff
+    patch -p1 <patches/adaptec_acl_mods.diff
     ./prepare-source
     ./configure --enable-acl-support
     make
 
 Philip Lowman wrote:
 > Attached is a small patch which is meant to be applied to a copy of
@@ -28,95 +27,89 @@
 though I don't know if there might be some bits lost in the current
 algorithm when using the file's mode bits to reconstruct a stripped ACL
 entry.
 
 --- old/acls.c
 +++ new/acls.c
-@@ -84,10 +84,10 @@ static int calc_sacl_entries(const rsync
- 
- static int rsync_acl_get_perms(const rsync_acl *racl)
- {
--	/* Note that (ACL_NO_ENTRY & 7) is 0. */
--	return ((racl->user_obj & 7) << 6)
--	     + (((racl->mask != ACL_NO_ENTRY ? racl->mask : racl->group_obj) & 7) << 3)
--	     + (racl->other & 7);
-+	/* Note that (ACL_NO_ENTRY & 077) is 0. */
-+	return ((racl->user_obj & 077) << 6)
-+	     + (((racl->mask != ACL_NO_ENTRY ? racl->mask : racl->group_obj) & 077) << 3)
-+	     + (racl->other & 077);
- }
- 
- static void rsync_acl_strip_perms(rsync_acl *racl)
-@@ -178,6 +178,9 @@ static BOOL unpack_smb_acl(rsync_acl *ra
+@@ -282,6 +282,9 @@ static BOOL unpack_smb_acl(rsync_acl *ra
  		}
  		access = (sys_acl_get_perm(permset, SMB_ACL_READ) ? 4 : 0)
  		       | (sys_acl_get_perm(permset, SMB_ACL_WRITE) ? 2 : 0)
 +		       | (sys_acl_get_perm(permset, SMB_ACL_DELETE) ? 8 : 0)
 +		       | (sys_acl_get_perm(permset, SMB_ACL_CHMOD) ? 16 : 0)
 +		       | (sys_acl_get_perm(permset, SMB_ACL_CHOWN) ? 32 : 0)
  		       | (sys_acl_get_perm(permset, SMB_ACL_EXECUTE) ? 1 : 0);
- 		/* continue == done with entry; break == store in given idal */
+ 		/* continue == done with entry; break == store in temporary ida list */
  		switch (tag_type) {
-@@ -587,6 +590,12 @@ static int store_access_in_entry(uchar a
+@@ -376,6 +379,12 @@ static int store_access_in_entry(uchar a
  
  	COE( sys_acl_get_permset,(entry, &permset) );
  	COE( sys_acl_clear_perms,(permset) );
 +	if (access & 32)
 +		COE( sys_acl_add_perm(permset, SMB_ACL_CHOWN) );
 +	if (access & 16)
 +		COE( sys_acl_add_perm(permset, SMB_ACL_CHMOD) );
 +	if (access & 8)
 +		COE( sys_acl_add_perm(permset, SMB_ACL_DELETE) );
  	if (access & 4)
  		COE( sys_acl_add_perm,(permset, SMB_ACL_READ) );
  	if (access & 2)
-@@ -619,7 +628,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
+@@ -409,7 +418,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
  
  	COE( sys_acl_create_entry,(smb_acl, &entry) );
  	COE( sys_acl_set_tag_type,(entry, SMB_ACL_USER_OBJ) );
 -	COE2( store_access_in_entry,(racl->user_obj & 7, entry) );
 +	COE2( store_access_in_entry,(racl->user_obj & 077, entry) );
  
- 	for (ida = racl->users.idas, count = racl->users.count;
- 	     count--; ida++) {
-@@ -631,7 +640,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
+ 	for (ida = racl->users.idas, count = racl->users.count; count--; ida++) {
+ 		COE( sys_acl_create_entry,(smb_acl, &entry) );
+@@ -420,7 +429,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
  
  	COE( sys_acl_create_entry,(smb_acl, &entry) );
  	COE( sys_acl_set_tag_type,(entry, SMB_ACL_GROUP_OBJ) );
 -	COE2( store_access_in_entry,(racl->group_obj & 7, entry) );
 +	COE2( store_access_in_entry,(racl->group_obj & 077, entry) );
  
- 	for (ida = racl->groups.idas, count = racl->groups.count;
- 	     count--; ida++) {
-@@ -652,7 +661,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
+ 	for (ida = racl->groups.idas, count = racl->groups.count; count--; ida++) {
+ 		COE( sys_acl_create_entry,(smb_acl, &entry) );
+@@ -430,7 +439,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
+ 	}
+ 
+ #ifdef ACLS_NEED_MASK
+-	mask_bits = racl->mask == NO_ENTRY ? racl->group_obj & 7 : racl->mask;
++	mask_bits = racl->mask == NO_ENTRY ? racl->group_obj & 077 : racl->mask;
+ 	COE( sys_acl_create_entry,(smb_acl, &entry) );
+ 	COE( sys_acl_set_tag_type,(entry, SMB_ACL_MASK) );
+ 	COE2( store_access_in_entry,(mask_bits, entry) );
+@@ -444,7 +453,7 @@ static BOOL pack_smb_acl(SMB_ACL_T *smb_
  
  	COE( sys_acl_create_entry,(smb_acl, &entry) );
  	COE( sys_acl_set_tag_type,(entry, SMB_ACL_OTHER) );
 -	COE2( store_access_in_entry,(racl->other & 7, entry) );
 +	COE2( store_access_in_entry,(racl->other & 077, entry) );
  
  #ifdef DEBUG
  	if (sys_acl_valid(*smb_acl) < 0)
-@@ -761,7 +770,7 @@ static void receive_rsync_acl(rsync_acl 
+@@ -649,7 +658,7 @@ static void receive_rsync_acl(rsync_acl 
  	while (count--) {
  		char tag = read_byte(f);
  		uchar access = read_byte(f);
 -		if (access & ~ (4 | 2 | 1)) {
 +		if (access & ~(32 | 16 | 8 | 4 | 2 | 1)) {
  			rprintf(FERROR, "receive_rsync_acl: bogus permset %o\n",
  				access);
  			exit_cleanup(RERR_STREAMIO);
-@@ -834,7 +843,7 @@ static void receive_rsync_acl(rsync_acl 
- 	} else
- #endif
- 	if (racl->mask == ACL_NO_ENTRY) /* Always non-empty when needed. */
+@@ -725,7 +734,7 @@ static void receive_rsync_acl(rsync_acl 
+ 			racl->mask = NO_ENTRY;
+ 		}
+ 	} else if (racl->mask == NO_ENTRY) /* Must be non-empty with lists. */
 -		racl->mask = computed_mask_bits | (racl->group_obj & 7);
 +		racl->mask = computed_mask_bits | (racl->group_obj & 077);
  }
  
- /* receive and build the rsync_acl_lists */
+ /* Receive the ACL info the sender has included for this file-list entry. */
 --- old/smb_acls.h
 +++ new/smb_acls.h
 @@ -33,6 +33,11 @@
  #define SMB_ACL_READ		ACL_READ
  #define SMB_ACL_WRITE		ACL_WRITE
  #define SMB_ACL_EXECUTE		ACL_EXECUTE
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/atimes.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/atimes.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/atimes.diff	2006-04-22 23:40:38.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/atimes.diff	2006-11-07 12:42:15.000000000 +0800
@@ -1,24 +1,25 @@
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/atimes.diff
     ./prepare-source
     ./configure                      (optional if already run)
     make
 
 
 --- old/flist.c
 +++ new/flist.c
-@@ -50,6 +50,7 @@ extern int preserve_devices;
+@@ -46,6 +46,7 @@ extern int preserve_devices;
  extern int preserve_specials;
  extern int preserve_uid;
  extern int preserve_gid;
 +extern int preserve_atimes;
  extern int relative_paths;
  extern int implied_dirs;
  extern int prune_empty_dirs;
-@@ -83,7 +84,13 @@ void init_flist(void)
+@@ -79,7 +80,13 @@ void init_flist(void)
  	struct file_struct f;
  
  	/* Figure out how big the file_struct is without trailing padding */
 -	file_struct_len = offsetof(struct file_struct, flags) + sizeof f.flags;
 +	if (preserve_atimes)
 +		file_struct_len = offsetof(struct file_struct, fl4g5);
@@ -27,13 +28,13 @@
 +	/* The "flags" uchar is no longer accessed directly, so I
 +	 * mangled the name to fl4g5 as a reminder. */
 +	file_struct_len += sizeof f.fl4g5;
  	checksum_len = protocol_version < 21 ? 2 : MD4_SUM_LENGTH;
  }
  
-@@ -139,16 +146,18 @@ static void list_file_entry(struct file_
+@@ -135,16 +142,18 @@ static void list_file_entry(struct file_
  
  #ifdef SUPPORT_LINKS
  	if (preserve_links && S_ISLNK(f->mode)) {
 -		rprintf(FINFO, "%s %11.0f %s %s -> %s\n",
 +		rprintf(FINFO, "%s %11.0f %s %s %s -> %s\n",
  			permbuf,
@@ -48,96 +49,96 @@
  			permbuf,
  			(double)f->length, timestring(f->modtime),
 +			preserve_atimes ? timestring(f->atime) : "",
  			f_name(f, NULL));
  	}
  }
-@@ -310,6 +319,7 @@ static void send_file_entry(struct file_
+@@ -302,6 +311,7 @@ static void send_file_entry(struct file_
  {
  	unsigned short flags;
  	static time_t modtime;
 +	static time_t atime;
  	static mode_t mode;
  	static int64 dev;
  	static dev_t rdev;
-@@ -325,7 +335,7 @@ static void send_file_entry(struct file_
+@@ -317,7 +327,7 @@ static void send_file_entry(struct file_
  
  	if (!file) {
  		write_byte(f, 0);
 -		modtime = 0, mode = 0;
 +		modtime = 0, atime = 0, mode = 0;
- 		dev = 0, rdev = makedev(0, 0);
+ 		dev = 0, rdev = MAKEDEV(0, 0);
  		rdev_major = 0;
  		uid = 0, gid = 0;
-@@ -335,7 +345,7 @@ static void send_file_entry(struct file_
+@@ -327,7 +337,7 @@ static void send_file_entry(struct file_
  
  	f_name(file, fname);
  
 -	flags = file->flags & XMIT_TOP_DIR;
 +	flags = FFLAGS(file) & XMIT_TOP_DIR;
  
  	if (file->mode == mode)
  		flags |= XMIT_SAME_MODE;
-@@ -371,6 +381,12 @@ static void send_file_entry(struct file_
+@@ -363,6 +373,12 @@ static void send_file_entry(struct file_
  		flags |= XMIT_SAME_TIME;
  	else
  		modtime = file->modtime;
 +	if (preserve_atimes && !S_ISDIR(mode)) {
 +		if (file->atime == atime)
 +			flags |= XMIT_SAME_ATIME;
 +		else
 +			atime = file->atime;
 +	}
  
  #ifdef SUPPORT_HARD_LINKS
  	if (file->link_u.idev) {
-@@ -424,6 +440,8 @@ static void send_file_entry(struct file_
+@@ -416,6 +432,8 @@ static void send_file_entry(struct file_
  		write_int(f, modtime);
  	if (!(flags & XMIT_SAME_MODE))
  		write_int(f, to_wire_mode(mode));
 +	if (preserve_atimes && !S_ISDIR(mode) && !(flags & XMIT_SAME_ATIME))
 +		write_int(f, atime);
  	if (preserve_uid && !(flags & XMIT_SAME_UID)) {
  		if (!numeric_ids)
  			add_uid(uid);
-@@ -490,6 +508,7 @@ static struct file_struct *receive_file_
+@@ -482,6 +500,7 @@ static struct file_struct *receive_file_
  					      unsigned short flags, int f)
  {
  	static time_t modtime;
 +	static time_t atime;
  	static mode_t mode;
  	static int64 dev;
  	static dev_t rdev;
-@@ -508,7 +527,7 @@ static struct file_struct *receive_file_
+@@ -500,7 +519,7 @@ static struct file_struct *receive_file_
  	struct file_struct *file;
  
  	if (!flist) {
 -		modtime = 0, mode = 0;
 +		modtime = 0, atime = 0, mode = 0;
- 		dev = 0, rdev = makedev(0, 0);
+ 		dev = 0, rdev = MAKEDEV(0, 0);
  		rdev_major = 0;
  		uid = 0, gid = 0;
-@@ -564,6 +583,8 @@ static struct file_struct *receive_file_
+@@ -556,6 +575,8 @@ static struct file_struct *receive_file_
  		modtime = (time_t)read_int(f);
  	if (!(flags & XMIT_SAME_MODE))
  		mode = from_wire_mode(read_int(f));
 +	if (preserve_atimes && !S_ISDIR(mode) && !(flags & XMIT_SAME_ATIME))
 +		atime = (time_t)read_int(f);
  
  	if (chmod_modes && !S_ISLNK(mode))
  		mode = tweak_mode(mode, chmod_modes);
-@@ -619,6 +640,8 @@ static struct file_struct *receive_file_
+@@ -611,6 +632,8 @@ static struct file_struct *receive_file_
  	file->mode = mode;
  	file->uid = uid;
  	file->gid = gid;
 +	if (preserve_atimes)
 +		file->atime = atime;
  
  	if (dirname_len) {
  		file->dirname = lastdir = bp;
-@@ -644,12 +667,12 @@ static struct file_struct *receive_file_
+@@ -636,12 +659,12 @@ static struct file_struct *receive_file_
  			    && lastname[del_hier_name_len-1] == '.'
  			    && lastname[del_hier_name_len-2] == '/')
  				del_hier_name_len -= 2;
 -			file->flags |= FLAG_TOP_DIR | FLAG_DEL_HERE;
 +			FFLAGS(file) |= FLAG_TOP_DIR | FLAG_DEL_HERE;
  		} else if (in_del_hier) {
@@ -146,13 +147,13 @@
  			  && lastname[del_hier_name_len] == '/'))
 -				file->flags |= FLAG_DEL_HERE;
 +				FFLAGS(file) |= FLAG_DEL_HERE;
  			else
  				in_del_hier = 0;
  		}
-@@ -865,12 +888,14 @@ struct file_struct *make_file(char *fnam
+@@ -858,12 +881,14 @@ struct file_struct *make_file(char *fnam
  	memset(bp, 0, file_struct_len);
  	bp += file_struct_len;
  
 -	file->flags = flags;
 +	FFLAGS(file) = flags;
  	file->modtime = st.st_mtime;
@@ -162,45 +163,45 @@
  	file->gid = st.st_gid;
 +	if (preserve_atimes)
 +		file->atime = st.st_atime;
  
  #ifdef SUPPORT_HARD_LINKS
  	if (flist && flist->hlink_pool) {
-@@ -983,7 +1008,7 @@ static void send_if_directory(int f, str
+@@ -976,7 +1001,7 @@ static void send_if_directory(int f, str
  	char is_dot_dir = fbuf[ol-1] == '.' && (ol == 1 || fbuf[ol-2] == '/');
  
  	if (S_ISDIR(file->mode)
 -	    && !(file->flags & FLAG_MOUNT_POINT) && f_name(file, fbuf)) {
 +	    && !(FFLAGS(file) & FLAG_MOUNT_POINT) && f_name(file, fbuf)) {
  		void *save_filters;
  		unsigned int len = strlen(fbuf);
  		if (len > 1 && fbuf[len-1] == '/')
-@@ -1589,8 +1614,9 @@ static void clean_flist(struct file_list
+@@ -1586,8 +1611,9 @@ static void clean_flist(struct file_list
  			}
  			/* Make sure we don't lose track of a user-specified
  			 * top directory. */
 -			flist->files[keep]->flags |= flist->files[drop]->flags
 -						   & (FLAG_TOP_DIR|FLAG_DEL_HERE);
 +			FFLAGS(flist->files[keep])
 +			    |= FFLAGS(flist->files[drop])
 +			     & (FLAG_TOP_DIR|FLAG_DEL_HERE);
  
  			clear_file(flist->files[drop], flist);
  
-@@ -1714,7 +1740,7 @@ static void output_flist(struct file_lis
+@@ -1711,7 +1737,7 @@ static void output_flist(struct file_lis
  			file->dirname ? file->dirname : "",
  			file->dirname ? "/" : "", NS(file->basename),
  			S_ISDIR(file->mode) ? "/" : "", (int)file->mode,
 -			(double)file->length, uidbuf, gidbuf, file->flags);
 +			(double)file->length, uidbuf, gidbuf, FFLAGS(file));
  	}
  }
  
 --- old/generator.c
 +++ new/generator.c
-@@ -44,6 +44,7 @@ extern int preserve_perms;
+@@ -43,6 +43,7 @@ extern int preserve_perms;
  extern int preserve_uid;
  extern int preserve_gid;
  extern int preserve_times;
 +extern int preserve_atimes;
  extern int omit_dir_times;
  extern int delete_mode;
@@ -261,179 +262,197 @@
 +		if (preserve_atimes && !S_ISDIR(file->mode) && !S_ISLNK(file->mode)
 +		 && cmp_time(file->atime, st->st_atime) != 0)
 +			iflags |= ITEM_REPORT_ATIME;
  		if ((file->mode & CHMOD_BITS) != (st->st_mode & CHMOD_BITS))
  			iflags |= ITEM_REPORT_PERMS;
  		if (preserve_uid && am_root && file->uid != st->st_uid)
-@@ -547,7 +552,7 @@ static int find_fuzzy(struct file_struct
+@@ -549,7 +554,7 @@ static int find_fuzzy(struct file_struct
  		uint32 dist;
  
  		if (!S_ISREG(fp->mode) || !fp->length
 -		    || fp->flags & FLAG_NO_FUZZY)
 +		    || FFLAGS(fp) & FLAG_NO_FUZZY)
  			continue;
  
  		name = fp->basename;
-@@ -656,6 +661,8 @@ static int try_dests_reg(struct file_str
+@@ -658,6 +663,8 @@ static int try_dests_reg(struct file_str
  					  itemizing && verbose > 1,
  					  code) < 0)
  				goto try_a_copy;
 +			if (preserve_atimes)
 +				set_file_attrs(fname, file, stp, 0);
- 			if (preserve_hard_links && file->link_u.links)
- 				hard_link_cluster(file, ndx, itemizing, code);
- 		} else if (itemizing)
-@@ -922,7 +929,7 @@ static void recv_generator(char *fname, 
- 		    && verbose && code && f_out != -1)
+ 			if (preserve_hard_links && file->link_u.links) {
+ 				if (dry_run)
+ 					file->link_u.links->link_dest_used = j + 1;
+@@ -930,7 +937,7 @@ static void recv_generator(char *fname, 
+ 				rsyserr(FERROR, errno,
+ 					"recv_generator: mkdir %s failed",
+ 					full_fname(fname));
+-				file->flags |= FLAG_MISSING;
++				FFLAGS(file) |= FLAG_MISSING;
+ 				if (ndx+1 < the_file_list->count
+ 				 && the_file_list->files[ndx+1]->dir.depth > file->dir.depth) {
+ 					rprintf(FERROR,
+@@ -944,7 +951,7 @@ static void recv_generator(char *fname, 
+ 		    && verbose && code != FNONE && f_out != -1)
  			rprintf(code, "%s/\n", fname);
  		if (delete_during && f_out != -1 && !phase && dry_run < 2
 -		    && (file->flags & FLAG_DEL_HERE))
 +		    && (FFLAGS(file) & FLAG_DEL_HERE))
  			delete_in_dir(the_file_list, fname, file, &st);
  		return;
  	}
-@@ -1211,7 +1218,7 @@ static void recv_generator(char *fname, 
+@@ -1252,7 +1259,7 @@ static void recv_generator(char *fname, 
  	if (fuzzy_dirlist) {
  		int j = flist_find(fuzzy_dirlist, file);
  		if (j >= 0) /* don't use changing file as future fuzzy basis */
 -			fuzzy_dirlist->files[j]->flags |= FLAG_NO_FUZZY;
 +			FFLAGS(fuzzy_dirlist->files[j]) |= FLAG_NO_FUZZY;
  	}
  
  	/* open the file */
+@@ -1517,7 +1524,7 @@ void generate_files(int f_out, struct fi
+ 				continue;
+ 			if (!need_retouch_dir_times && file->mode & S_IWUSR)
+ 				continue;
+-			if (file->flags & FLAG_MISSING) {
++			if (FFLAGS(file) & FLAG_MISSING) {
+ 				int missing = file->dir.depth;
+ 				while (++i < flist->count) {
+ 					file = flist->files[i];
 --- old/hlink.c
 +++ new/hlink.c
-@@ -25,6 +25,7 @@ extern int link_dest;
- extern int make_backups;
- extern int log_format_has_i;
+@@ -30,6 +30,7 @@ extern int make_backups;
+ extern int remove_source_files;
+ extern int stdout_format_has_i;
  extern char *basis_dir[];
 +extern unsigned int file_struct_len;
  extern struct file_list *the_file_list;
  
  #ifdef SUPPORT_HARD_LINKS
-@@ -85,10 +86,10 @@ static void link_idev_data(void)
+@@ -91,10 +92,10 @@ static void link_idev_data(void)
  			FPTR(cur)->link_u.links = pool_talloc(hlink_pool,
  			    struct hlink, 1, "hlink_list");
  
 -			FPTR(head)->flags |= FLAG_HLINK_TOL;
 +			FFLAGS(FPTR(head)) |= FLAG_HLINK_TOL;
  			FPTR(cur)->F_HLINDEX = to;
  			FPTR(cur)->F_NEXT = head;
 -			FPTR(cur)->flags |= FLAG_HLINK_EOL;
 +			FFLAGS(FPTR(cur)) |= FLAG_HLINK_EOL;
+ 			FPTR(cur)->link_u.links->link_dest_used = 0;
  			hlink_list[to++] = head;
  		} else
- 			FPTR(cur)->link_u.links = NULL;
-@@ -174,7 +175,7 @@ int hard_link_check(struct file_struct *
+@@ -181,7 +182,7 @@ int hard_link_check(struct file_struct *
  {
  #ifdef SUPPORT_HARD_LINKS
  	int head;
 -	if (skip && !(file->flags & FLAG_HLINK_EOL))
 +	if (skip && !(FFLAGS(file) & FLAG_HLINK_EOL))
  		head = hlink_list[file->F_HLINDEX] = file->F_NEXT;
  	else
  		head = hlink_list[file->F_HLINDEX];
-@@ -269,8 +270,8 @@ void hard_link_cluster(struct file_struc
+@@ -289,8 +290,8 @@ void hard_link_cluster(struct file_struc
  	file->F_HLINDEX = FINISHED_LINK;
  	if (link_stat(f_name(file, hlink1), &st1, 0) < 0)
  		return;
 -	if (!(file->flags & FLAG_HLINK_TOL)) {
 -		while (!(file->flags & FLAG_HLINK_EOL)) {
 +	if (!(FFLAGS(file) & FLAG_HLINK_TOL)) {
 +		while (!(FFLAGS(file) & FLAG_HLINK_EOL)) {
  			ndx = file->F_NEXT;
  			file = FPTR(ndx);
  		}
-@@ -285,6 +286,6 @@ void hard_link_cluster(struct file_struc
- 		maybe_hard_link(file, ndx, hlink2, statret, &st2,
- 				hlink1, &st1, itemizing, code);
+@@ -310,6 +311,6 @@ void hard_link_cluster(struct file_struc
+ 			send_msg(MSG_SUCCESS, numbuf, 4);
+ 		}
  		file->F_HLINDEX = FINISHED_LINK;
 -	} while (!(file->flags & FLAG_HLINK_EOL));
 +	} while (!(FFLAGS(file) & FLAG_HLINK_EOL));
  #endif
  }
 --- old/log.c
 +++ new/log.c
-@@ -42,6 +42,7 @@ extern int msg_fd_out;
+@@ -37,6 +37,7 @@ extern int msg_fd_out;
  extern int allow_8bit_chars;
  extern int protocol_version;
  extern int preserve_times;
 +extern int preserve_atimes;
- extern int log_format_has_i;
- extern int log_format_has_o_or_i;
- extern int daemon_log_format_has_o_or_i;
-@@ -608,7 +609,8 @@ static void log_formatted(enum logcode c
+ extern int stdout_format_has_i;
+ extern int stdout_format_has_o_or_i;
+ extern int logfile_format_has_i;
+@@ -606,7 +607,8 @@ static void log_formatted(enum logcode c
  			n[5] = !(iflags & ITEM_REPORT_PERMS) ? '.' : 'p';
  			n[6] = !(iflags & ITEM_REPORT_OWNER) ? '.' : 'o';
  			n[7] = !(iflags & ITEM_REPORT_GROUP) ? '.' : 'g';
 -			n[8] = '.';
 +			n[8] = !(iflags & ITEM_REPORT_ATIME) ? '.'
 +			     : S_ISLNK(file->mode) ? 'U' : 'u';
  			n[9] = '\0';
  
  			if (iflags & (ITEM_IS_NEW|ITEM_MISSING_DATA)) {
 --- old/options.c
 +++ new/options.c
-@@ -53,6 +53,7 @@ int preserve_uid = 0;
+@@ -55,6 +55,7 @@ int preserve_uid = 0;
  int preserve_gid = 0;
  int preserve_times = 0;
  int omit_dir_times = 0;
 +int preserve_atimes = 0;
  int update_only = 0;
  int cvs_exclude = 0;
  int dry_run = 0;
-@@ -299,8 +300,9 @@ void usage(enum logcode F)
+@@ -311,8 +312,9 @@ void usage(enum logcode F)
    rprintf(F,"     --devices               preserve device files (super-user only)\n");
    rprintf(F,"     --specials              preserve special files\n");
    rprintf(F," -D                          same as --devices --specials\n");
 -  rprintf(F," -t, --times                 preserve times\n");
 -  rprintf(F," -O, --omit-dir-times        omit directories when preserving times\n");
 +  rprintf(F," -t, --times                 preserve modify times\n");
 +  rprintf(F," -O, --omit-dir-times        omit directories when preserving modify times\n");
 +  rprintf(F," -U, --atimes                preserve access (use) times\n");
    rprintf(F,"     --super                 receiver attempts super-user activities\n");
    rprintf(F," -S, --sparse                handle sparse files efficiently\n");
    rprintf(F," -n, --dry-run               show what would have been transferred\n");
-@@ -411,6 +413,9 @@ static struct poptOption long_options[] 
+@@ -428,6 +430,9 @@ static struct poptOption long_options[] 
    {"times",           't', POPT_ARG_VAL,    &preserve_times, 1, 0, 0 },
    {"no-times",         0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
    {"no-t",             0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
 +  {"atimes",          'U', POPT_ARG_VAL,    &preserve_atimes, 1, 0, 0 },
 +  {"no-atimes",        0,  POPT_ARG_VAL,    &preserve_atimes, 0, 0, 0 },
 +  {"no-k",             0,  POPT_ARG_VAL,    &preserve_atimes, 0, 0, 0 },
    {"omit-dir-times",  'O', POPT_ARG_VAL,    &omit_dir_times, 2, 0, 0 },
    {"modify-window",    0,  POPT_ARG_INT,    &modify_window, OPT_MODIFY_WINDOW, 0, 0 },
    {"super",            0,  POPT_ARG_VAL,    &am_root, 2, 0, 0 },
-@@ -1516,6 +1521,8 @@ void server_options(char **args,int *arg
+@@ -1538,6 +1543,8 @@ void server_options(char **args,int *arg
  		argstr[x++] = 'D';
  	if (preserve_times)
  		argstr[x++] = 't';
 +	if (preserve_atimes)
 +		argstr[x++] = 'U';
  	if (preserve_perms)
  		argstr[x++] = 'p';
  	else if (preserve_executability && am_sender)
 --- old/rsync.c
 +++ new/rsync.c
-@@ -35,6 +35,7 @@ extern int dry_run;
- extern int daemon_log_format_has_i;
+@@ -34,6 +34,7 @@ extern int verbose;
+ extern int dry_run;
  extern int preserve_perms;
  extern int preserve_executability;
 +extern int preserve_atimes;
  extern int preserve_times;
  extern int omit_dir_times;
  extern int am_root;
-@@ -128,6 +129,7 @@ int set_file_attrs(char *fname, struct f
+@@ -129,6 +130,7 @@ int set_file_attrs(char *fname, struct f
  	int updated = 0;
  	STRUCT_STAT st2;
  	int change_uid, change_gid;
 +	time_t atime, mtime;
+ 	mode_t new_mode = file->mode;
  
  	if (!st) {
- 		if (dry_run)
-@@ -146,18 +148,33 @@ int set_file_attrs(char *fname, struct f
+@@ -148,18 +150,33 @@ int set_file_attrs(char *fname, struct f
  		}
  	}
  
 +	/* This code must be the first update in the function due to
 +	 * how it uses the "updated" variable. */
  	if (!preserve_times || (S_ISDIR(st->st_mode) && omit_dir_times))
@@ -474,21 +493,21 @@
  #define XMIT_SAME_DEV (1<<10)
  #define XMIT_RDEV_MINOR_IS_SMALL (1<<11)
 +#define XMIT_SAME_ATIME (1<<12)
  
  /* These flags are used in the live flist data. */
  
-@@ -119,6 +120,7 @@
+@@ -120,6 +121,7 @@
  
  #define ATTRS_REPORT		(1<<0)
  #define ATTRS_SKIP_MTIME	(1<<1)
 +#define ATTRS_SKIP_ATIME	(1<<2)
  
  #define FULL_FLUSH	1
  #define NORMAL_FLUSH	0
-@@ -522,9 +524,12 @@ struct file_struct {
+@@ -530,9 +532,12 @@ struct file_struct {
  	uid_t uid;
  	gid_t gid;
  	mode_t mode;
 -	uchar flags;	/* this item MUST remain last */
 +	time_t atime;   /* this MUST be second to last */
 +	uchar fl4g5;	/* this item MUST remain last */
@@ -498,56 +517,56 @@
 +
  /*
   * Start the flist array at FLIST_START entries and grow it
   * by doubling until FLIST_LINEAR then grow by FLIST_LINEAR
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -327,8 +327,9 @@ to the detailed description below for a 
+@@ -328,8 +328,9 @@ to the detailed description below for a 
       --devices               preserve device files (super-user only)
       --specials              preserve special files
   -D                          same as --devices --specials
 - -t, --times                 preserve times
 - -O, --omit-dir-times        omit directories when preserving times
 + -t, --times                 preserve modify times
 + -O, --omit-dir-times        omit directories when preserving mod-times
 + -U, --atimes                preserve access (use) times
       --super                 receiver attempts super-user activities
   -S, --sparse                handle sparse files efficiently
   -n, --dry-run               show what would have been transferred
-@@ -858,6 +859,12 @@ it is preserving modification times (see
+@@ -869,6 +870,12 @@ it is preserving modification times (see
  the directories on the receiving side, it is a good idea to use bf(-O).
  This option is inferred if you use bf(--backup) without bf(--backup-dir).
  
 +dit(bf(-U, --atimes)) This tells rsync to set the access (use) times of the
 +destination files to the same value as the source files.  Note that the
 +reading of the source file may update the atime of the source files, so
 +repeated rsync runs with --atimes may be needed if you want to force the
 +access-time values to be 100% identical on the two systems.
 +
  dit(bf(--super)) This tells the receiving side to attempt super-user
  activities even if the receiving rsync wasn't run by the super-user.  These
  activities include: preserving users via the bf(--owner) option, preserving
-@@ -1373,7 +1380,7 @@ with older versions of rsync, but that a
+@@ -1390,7 +1397,7 @@ with older versions of rsync, but that a
  verbose messages).
  
  The "%i" escape has a cryptic output that is 9 letters long.  The general
 -format is like the string bf(YXcstpogz), where bf(Y) is replaced by the
 +format is like the string bf(YXcstpogu), where bf(Y) is replaced by the
  type of update being done, bf(X) is replaced by the file-type, and the
  other letters represent attributes that may be output if they are being
  modified.
-@@ -1413,7 +1420,7 @@ quote(itemize(
+@@ -1430,7 +1437,7 @@ quote(itemization(
    by the file transfer.
    it() A bf(t) means the modification time is different and is being updated
    to the sender's value (requires bf(--times)).  An alternate value of bf(T)
 -  means that the time will be set to the transfer time, which happens
 +  means that the modify time will be set to the transfer time, which happens
    anytime a symlink is transferred, or when a file or device is transferred
    without bf(--times).
    it() A bf(p) means the permissions are different and are being updated to
-@@ -1422,7 +1429,10 @@ quote(itemize(
+@@ -1439,7 +1446,10 @@ quote(itemization(
    sender's value (requires bf(--owner) and super-user privileges).
    it() A bf(g) means the group is different and is being updated to the
    sender's value (requires bf(--group) and the authority to set the group).
 -  it() The bf(z) slot is reserved for future use.
 +  it() A bf(u) means the access (use) time is different and is being updated to
 +  the sender's value (requires bf(--atimes)).  An alternate value of bf(U)
@@ -555,30 +574,21 @@
 +  when a symlink or directory is updated.
  ))
  
  One other output is possible:  when deleting files, the "%i" will output
 --- old/sender.c
 +++ new/sender.c
-@@ -38,6 +38,7 @@ extern int do_progress;
+@@ -41,6 +41,7 @@ extern int do_progress;
  extern int inplace;
  extern int batch_fd;
  extern int write_batch;
 +extern unsigned int file_struct_len;
  extern struct stats stats;
  extern struct file_list *the_file_list;
- extern char *log_format;
-@@ -126,7 +127,7 @@ void successful_send(int ndx)
- 
- 	file = the_file_list->files[ndx];
- 	/* The generator might tell us about symlinks we didn't send. */
--	if (!(file->flags & FLAG_SENT) && !S_ISLNK(file->mode))
-+	if (!(FFLAGS(file) & FLAG_SENT) && !S_ISLNK(file->mode))
- 		return;
- 	if (file->dir.root) {
- 		offset = stringjoin(fname, sizeof fname,
-@@ -370,7 +371,7 @@ void send_files(struct file_list *flist,
+ extern char *stdout_format;
+@@ -373,7 +374,7 @@ void send_files(struct file_list *flist,
  			rprintf(FINFO, "sender finished %s\n", fname);
  
  		/* Flag that we actually sent this entry. */
 -		file->flags |= FLAG_SENT;
 +		FFLAGS(file) |= FLAG_SENT;
  	}
@@ -642,119 +652,123 @@
 -    ( cd "$2" && rsync_ls_lR . ) > "$tmpdir/ls-from"
      ( cd "$3" && rsync_ls_lR . ) > "$tmpdir/ls-to"
      diff $diffopt "$tmpdir/ls-from" "$tmpdir/ls-to" || failed=YES
  
 --- old/tls.c
 +++ new/tls.c
-@@ -39,6 +39,7 @@
- 
+@@ -34,6 +34,7 @@
+  * change. */
  
  #include "rsync.h"
 +#include "popt.h"
  
  #define PROGRAM "tls"
  
-@@ -48,6 +49,7 @@ int read_only = 1;
+@@ -43,6 +44,8 @@ int read_only = 1;
  int list_only = 0;
  int preserve_perms = 0;
  
 +static int display_atime = 0;
- 
++ 
  static void failed(char const *what, char const *where)
  {
-@@ -56,14 +58,29 @@ static void failed(char const *what, cha
+ 	fprintf(stderr, PROGRAM ": %s %s: %s\n",
+@@ -50,12 +53,29 @@ static void failed(char const *what, cha
  	exit(1);
  }
  
-+static void storetime(char *dest, time_t t)
++static void storetime(char *dest, time_t t, size_t destsize)
 +{
 +	if (t) {
 +		struct tm *mt = gmtime(&t);
- 
-+		sprintf(dest, "%04d-%02d-%02d %02d:%02d:%02d ",
++
++		snprintf(dest, destsize,
++			"%04d-%02d-%02d %02d:%02d:%02d ",
 +			(int)mt->tm_year + 1900,
 +			(int)mt->tm_mon + 1,
 +			(int)mt->tm_mday,
 +			(int)mt->tm_hour,
 +			(int)mt->tm_min,
 +			(int)mt->tm_sec);
-+	} else {
-+		strcpy(dest, "                    ");
-+	}
-+}	
- 
++	} else
++		strlcpy(dest, "                    ", destsize);
++}
++
  static void list_file(const char *fname)
  {
  	STRUCT_STAT buf;
  	char permbuf[PERMSTRING_SIZE];
 -	struct tm *mt;
 -	char datebuf[50];
 +	char mtimebuf[50];
 +	char atimebuf[50];
  	char linkbuf[4096];
  
  	if (do_lstat(fname, &buf) < 0)
-@@ -96,19 +113,8 @@ static void list_file(const char *fname)
+@@ -88,19 +108,8 @@ static void list_file(const char *fname)
  
  	permstring(permbuf, buf.st_mode);
  
 -	if (buf.st_mtime) {
 -		mt = gmtime(&buf.st_mtime);
 -
--		sprintf(datebuf, "%04d-%02d-%02d %02d:%02d:%02d",
+-		snprintf(datebuf, sizeof datebuf,
+-			"%04d-%02d-%02d %02d:%02d:%02d",
 -			(int)mt->tm_year + 1900,
 -			(int)mt->tm_mon + 1,
 -			(int)mt->tm_mday,
 -			(int)mt->tm_hour,
 -			(int)mt->tm_min,
 -			(int)mt->tm_sec);
--	} else {
--		strcpy(datebuf, "                   ");
--	}
-+	storetime(mtimebuf, buf.st_mtime);
-+	storetime(atimebuf, buf.st_atime);
+-	} else
+-		strlcpy(datebuf, "                   ", sizeof datebuf);
++	storetime(mtimebuf, buf.st_mtime, sizeof mtimebuf);
++	storetime(atimebuf, buf.st_atime, sizeof atimebuf);
  
  	/* TODO: Perhaps escape special characters in fname? */
  
-@@ -119,24 +125,55 @@ static void list_file(const char *fname)
+@@ -111,23 +120,55 @@ static void list_file(const char *fname)
  		    (long)minor(buf.st_rdev));
  	} else /* NB: use double for size since it might not fit in a long. */
  		printf("%12.0f", (double)buf.st_size);
 -	printf(" %6ld.%-6ld %6ld %s %s%s\n",
 +	printf(" %6ld.%-6ld %6ld %s%s%s%s\n",
  	       (long)buf.st_uid, (long)buf.st_gid, (long)buf.st_nlink,
 -	       datebuf, fname, linkbuf);
 + 	       mtimebuf, display_atime && !S_ISDIR(buf.st_mode) ? atimebuf : "",
 +	       fname, linkbuf);
- }
- 
++}
++
 +static struct poptOption long_options[] = {
 +  /* longName, shortName, argInfo, argPtr, value, descrip, argDesc */
 +  {"atime",           'u', POPT_ARG_NONE,   &display_atime, 0,   0, 0},
 +  {"help",            'h', POPT_ARG_NONE,   0,              'h', 0, 0},
 +  {0,0,0,0,0,0,0}
 +};
 +
 +static void tls_usage(int ret)
 +{
 +	fprintf(stderr, "usage: " PROGRAM " [--atime | -u] DIR ...\n"
 +	    "Trivial file listing program for portably checking rsync\n");
 +	exit(ret);
-+}
+ }
  
  int
  main(int argc, char *argv[])
  {
 -	if (argc < 2) {
 -		fprintf(stderr, "usage: " PROGRAM " DIR ...\n"
 -			"Trivial file listing program for portably checking rsync\n");
 -		return 1;
+-	}
 +	poptContext pc;
 +	const char **extra_args;
 +	int opt;
-+
+ 
+-	for (argv++; *argv; argv++) {
+-		list_file(*argv);
 +	pc = poptGetContext(PROGRAM, argc, (const char **)argv,
 +			    long_options, 0);
 +	while ((opt = poptGetNextOpt(pc)) != -1) {
 +		switch (opt) {
 +		case 'h':
 +			tls_usage(0);
@@ -764,37 +778,34 @@
 +				poptBadOption(pc, POPT_BADOPTION_NOALIAS),
 +				poptStrerror(opt));
 +			tls_usage(1);
 +		}
  	}
  
--	for (argv++; *argv; argv++) {
--		list_file(*argv);
--	}
 +	extra_args = poptGetArgs(pc);
 +	if (*extra_args == NULL)
 +		tls_usage(1);
 +
 +	for (; *extra_args; extra_args++)
 +		list_file(*extra_args);
 +	poptFreeContext(pc);
- 
++
  	return 0;
  }
 --- old/util.c
 +++ new/util.c
-@@ -126,7 +126,7 @@ void overflow_exit(char *str)
+@@ -121,7 +121,7 @@ NORETURN void overflow_exit(char *str)
  	exit_cleanup(RERR_MALLOC);
  }
  
 -int set_modtime(char *fname, time_t modtime, mode_t mode)
 +int set_times(char *fname, time_t modtime, time_t atime, mode_t mode)
  {
  #if !defined HAVE_LUTIMES || !defined HAVE_UTIMES
  	if (S_ISLNK(mode))
-@@ -134,9 +134,13 @@ int set_modtime(char *fname, time_t modt
+@@ -129,9 +129,13 @@ int set_modtime(char *fname, time_t modt
  #endif
  
  	if (verbose > 2) {
 -		rprintf(FINFO, "set modtime of %s to (%ld) %s",
 +		char mtimebuf[200];
 +
@@ -804,22 +815,22 @@
  			fname, (long)modtime,
 -			asctime(localtime(&modtime)));
 +			mtimebuf, (long)atime, timestring(atime));
  	}
  
  	if (dry_run)
-@@ -145,7 +149,7 @@ int set_modtime(char *fname, time_t modt
+@@ -140,7 +144,7 @@ int set_modtime(char *fname, time_t modt
  	{
  #ifdef HAVE_UTIMES
  		struct timeval t[2];
 -		t[0].tv_sec = time(NULL);
 +		t[0].tv_sec = atime;
  		t[0].tv_usec = 0;
  		t[1].tv_sec = modtime;
  		t[1].tv_usec = 0;
-@@ -156,12 +160,12 @@ int set_modtime(char *fname, time_t modt
+@@ -151,12 +155,12 @@ int set_modtime(char *fname, time_t modt
  		return utimes(fname, t);
  #elif defined HAVE_UTIMBUF
  		struct utimbuf tbuf;
 -		tbuf.actime = time(NULL);
 +		tbuf.actime = atime;
  		tbuf.modtime = modtime;
@@ -832,71 +843,71 @@
  		return utime(fname,t);
  #else
 --- old/proto.h
 +++ new/proto.h
 @@ -278,7 +278,7 @@ int fd_pair(int fd[2]);
  void print_child_argv(char **cmd);
- void out_of_memory(char *str);
- void overflow_exit(char *str);
+ NORETURN void out_of_memory(char *str);
+ NORETURN void overflow_exit(char *str);
 -int set_modtime(char *fname, time_t modtime, mode_t mode);
 +int set_times(char *fname, time_t modtime, time_t atime, mode_t mode);
  int mkdir_defmode(char *fname);
  int create_directory_path(char *fname);
  int full_write(int desc, char *ptr, size_t len);
 --- old/rsync.1
 +++ new/rsync.1
-@@ -383,8 +383,9 @@ to the detailed description below for a 
-      --devices               preserve device files (super-user only)
-      --specials              preserve special files
-  -D                          same as --devices --specials
-- -t, --times                 preserve times
-- -O, --omit-dir-times        omit directories when preserving times
-+ -t, --times                 preserve modify times
-+ -O, --omit-dir-times        omit directories when preserving mod-times
-+ -U, --atimes                preserve access (use) times
-      --super                 receiver attempts super-user activities
-  -S, --sparse                handle sparse files efficiently
-  -n, --dry-run               show what would have been transferred
-@@ -978,6 +979,13 @@ it is preserving modification times (see
- the directories on the receiving side, it is a good idea to use \fB-O\fP\&.
- This option is inferred if you use \fB--backup\fP without \fB--backup-dir\fP\&.
+@@ -394,8 +394,9 @@ to the detailed description below for a 
+      \-\-devices               preserve device files (super-user only)
+      \-\-specials              preserve special files
+  \-D                          same as \-\-devices \-\-specials
+- \-t, \-\-times                 preserve times
+- \-O, \-\-omit\-dir\-times        omit directories when preserving times
++ \-t, \-\-times                 preserve modify times
++ \-O, \-\-omit\-dir\-times        omit directories when preserving mod-times
++ \-U, \-\-atimes                preserve access (use) times
+      \-\-super                 receiver attempts super-user activities
+  \-S, \-\-sparse                handle sparse files efficiently
+  \-n, \-\-dry\-run               show what would have been transferred
+@@ -1008,6 +1009,13 @@ it is preserving modification times (see
+ the directories on the receiving side, it is a good idea to use \fB\-O\fP\&.
+ This option is inferred if you use \fB\-\-backup\fP without \fB\-\-backup\-dir\fP\&.
  .IP 
-+.IP "\fB-U, --atimes\fP" 
++.IP "\fB\-U, \-\-atimes\fP"
 +This tells rsync to set the access (use) times of the
 +destination files to the same value as the source files\&.  Note that the
 +reading of the source file may update the atime of the source files, so
-+repeated rsync runs with --atimes may be needed if you want to force the
++repeated rsync runs with \-\-atimes may be needed if you want to force the
 +access-time values to be 100% identical on the two systems\&.
 +.IP 
- .IP "\fB--super\fP" 
+ .IP "\fB\-\-super\fP"
  This tells the receiving side to attempt super-user
  activities even if the receiving rsync wasn\&'t run by the super-user\&.  These
-@@ -1559,7 +1567,7 @@ with older versions of rsync, but that a
+@@ -1606,7 +1614,7 @@ with older versions of rsync, but that a
  verbose messages)\&.
  .IP 
  The "%i" escape has a cryptic output that is 9 letters long\&.  The general
 -format is like the string \fBYXcstpogz\fP, where \fBY\fP is replaced by the
 +format is like the string \fBYXcstpogu\fP, where \fBY\fP is replaced by the
  type of update being done, \fBX\fP is replaced by the file-type, and the
  other letters represent attributes that may be output if they are being
  modified\&.
-@@ -1607,7 +1615,7 @@ by the file transfer\&.
+@@ -1655,7 +1663,7 @@ by the file transfer\&.
  .IP o 
  A \fBt\fP means the modification time is different and is being updated
- to the sender\&'s value (requires \fB--times\fP)\&.  An alternate value of \fBT\fP
+ to the sender\&'s value (requires \fB\-\-times\fP)\&.  An alternate value of \fBT\fP
 -means that the time will be set to the transfer time, which happens
 +means that the modify time will be set to the transfer time, which happens
  anytime a symlink is transferred, or when a file or device is transferred
- without \fB--times\fP\&.
+ without \fB\-\-times\fP\&.
  .IP o 
-@@ -1620,7 +1628,10 @@ sender\&'s value (requires \fB--owner\fP
+@@ -1668,7 +1676,10 @@ sender\&'s value (requires \fB\-\-owner\
  A \fBg\fP means the group is different and is being updated to the
- sender\&'s value (requires \fB--group\fP and the authority to set the group)\&.
+ sender\&'s value (requires \fB\-\-group\fP and the authority to set the group)\&.
  .IP o 
 -The \fBz\fP slot is reserved for future use\&.
 +A \fBu\fP means the access (use) time is different and is being updated to
-+the sender\&'s value (requires \fB--atimes\fP)\&.  An alternate value of \fBU\fP
++the sender\&'s value (requires \fB\-\-atimes\fP)\&.  An alternate value of \fBU\fP
 +means that the access time will be set to the transfer time, which happens
 +when a symlink or directory is updated\&.
- .RE 
+ .RE
+ 
  .IP 
- One other output is possible:  when deleting files, the "%i" will output
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/backup-dir-dels.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/backup-dir-dels.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/backup-dir-dels.diff	2006-04-22 23:40:45.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/backup-dir-dels.diff	2006-11-07 12:42:15.000000000 +0800
@@ -10,15 +10,21 @@
 The default behaviour if one or both of the options are not specified
 is the previous behaviour, both backups use the same directory or
 suffix.
 
 Marc St-Onge
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/backup-dir-dels.diff
+    ./configure                                 (optional if already run)
+    make
+
 --- old/backup.c
 +++ new/backup.c
-@@ -22,10 +22,15 @@
+@@ -23,10 +23,15 @@
  
  extern int verbose;
  extern int backup_dir_len;
 +extern int backup_dir_dels_len;
  extern unsigned int backup_dir_remainder;
 +extern unsigned int backup_dir_dels_remainder;
@@ -28,22 +34,22 @@
 +extern char *backup_suffix_dels;
  extern char *backup_dir;
 +extern char *backup_dir_dels;
  
  extern int am_root;
  extern int preserve_devices;
-@@ -33,6 +38,8 @@ extern int preserve_specials;
+@@ -34,6 +39,8 @@ extern int preserve_specials;
  extern int preserve_links;
  extern int safe_symlinks;
  
 +static int deleting;
 +
  /* make a complete pathname for backup file */
  char *get_backup_name(char *fname)
  {
-@@ -50,11 +57,28 @@ char *get_backup_name(char *fname)
+@@ -51,11 +58,28 @@ char *get_backup_name(char *fname)
  	return NULL;
  }
  
 +static char *get_delete_name(char *fname)
 +{
 +	if (backup_dir_dels) {
@@ -67,33 +73,33 @@
 -	char *fnamebak = get_backup_name(fname);
 +	char *fnamebak = deleting ? get_delete_name(fname)
 +				  : get_backup_name(fname);
  
  	if (!fnamebak)
  		return 0;
-@@ -94,7 +118,8 @@ path
+@@ -95,7 +119,8 @@ path
  static int make_bak_dir(char *fullpath)
  {
  	STRUCT_STAT st;
 -	char *rel = fullpath + backup_dir_len;
 +	int dir_len = deleting ? backup_dir_dels_len : backup_dir_len;
 +	char *rel = fullpath + dir_len;
  	char *end = rel + strlen(rel);
  	char *p = end;
  
-@@ -182,7 +207,8 @@ static int keep_backup(char *fname)
+@@ -183,7 +208,8 @@ static int keep_backup(char *fname)
  	if (!(file = make_file(fname, NULL, NULL, 0, NO_FILTERS)))
  		return 1; /* the file could have disappeared */
  
 -	if (!(buf = get_backup_name(fname)))
 +	buf = deleting ? get_delete_name(fname) : get_backup_name(fname);
 +	if (!buf)
  		return 0;
  
  	/* Check to see if this is a device file, or link */
-@@ -277,3 +303,13 @@ int make_backup(char *fname)
+@@ -278,3 +304,13 @@ int make_backup(char *fname)
  		return keep_backup(fname);
  	return make_simple_backup(fname);
  }
 +
 +/* backup switch routine called only when backing-up removed file */
 +int safe_delete(char *fname)
@@ -154,13 +160,13 @@
 +		ok = safe_delete(fname);
  	else
  		ok = do_rmdir(fname) == 0;
  	if (ok) {
 --- old/options.c
 +++ new/options.c
-@@ -136,10 +136,14 @@ int no_detach
+@@ -138,10 +138,14 @@ int no_detach
  int write_batch = 0;
  int read_batch = 0;
  int backup_dir_len = 0;
 +int backup_dir_dels_len = 0;	
  int backup_suffix_len;
 +int backup_suffix_dels_len;
@@ -169,51 +175,51 @@
  
  char *backup_suffix = NULL;
 +char *backup_suffix_dels = NULL;
  char *tmpdir = NULL;
  char *partial_dir = NULL;
  char *basis_dir[MAX_BASIS_DIRS+1];
-@@ -149,7 +153,9 @@ char *log_format = NULL;
+@@ -153,7 +157,9 @@ char *stdout_format = NULL;
  char *password_file = NULL;
  char *rsync_path = RSYNC_PATH;
  char *backup_dir = NULL;
 +char *backup_dir_dels = NULL;
  char backup_dir_buf[MAXPATHLEN];
 +char backup_dir_dels_buf[MAXPATHLEN];
  char *sockopts = NULL;
  int rsync_port = 0;
  int compare_dest = 0;
-@@ -280,6 +286,8 @@ void usage(enum logcode F)
+@@ -292,6 +298,8 @@ void usage(enum logcode F)
    rprintf(F," -b, --backup                make backups (see --suffix & --backup-dir)\n");
    rprintf(F,"     --backup-dir=DIR        make backups into hierarchy based in DIR\n");
    rprintf(F,"     --suffix=SUFFIX         set backup suffix (default %s w/o --backup-dir)\n",BACKUP_SUFFIX);
 +  rprintf(F,"     --backup-dir-dels       make backups of removed files into current dir\n");
 +  rprintf(F,"     --suffix-dels=SUFFIX    set removed-files suffix (defaults to --suffix)\n");
    rprintf(F," -u, --update                skip files that are newer on the receiver\n");
    rprintf(F,"     --inplace               update destination files in-place (SEE MAN PAGE)\n");
    rprintf(F,"     --append                append data onto shorter files\n");
-@@ -497,7 +505,9 @@ static struct poptOption long_options[] 
+@@ -518,7 +526,9 @@ static struct poptOption long_options[] 
    {"bwlimit",          0,  POPT_ARG_INT,    &bwlimit, 0, 0, 0 },
    {"backup",          'b', POPT_ARG_NONE,   &make_backups, 0, 0, 0 },
    {"backup-dir",       0,  POPT_ARG_STRING, &backup_dir, 0, 0, 0 },
 +  {"backup-dir-dels",  0,  POPT_ARG_STRING, &backup_dir_dels, 0, 0, 0 },
    {"suffix",           0,  POPT_ARG_STRING, &backup_suffix, 0, 0, 0 },
 +  {"suffix-dels",      0,  POPT_ARG_STRING, &backup_suffix_dels, 0, 0, 0 },
    {"list-only",        0,  POPT_ARG_VAL,    &list_only, 2, 0, 0 },
    {"read-batch",       0,  POPT_ARG_STRING, &batch_name, OPT_READ_BATCH, 0, 0 },
    {"write-batch",      0,  POPT_ARG_STRING, &batch_name, OPT_WRITE_BATCH, 0, 0 },
-@@ -1211,6 +1221,8 @@ int parse_arguments(int *argc, const cha
- 			partial_dir = sanitize_path(NULL, partial_dir, NULL, 0);
+@@ -1232,6 +1242,8 @@ int parse_arguments(int *argc, const cha
+ 			tmpdir = sanitize_path(NULL, tmpdir, NULL, 0, NULL);
  		if (backup_dir)
- 			backup_dir = sanitize_path(NULL, backup_dir, NULL, 0);
-+		if (backup_dir_dels)							
-+			backup_dir_dels = sanitize_path(NULL, backup_dir_dels, NULL, 0);
+ 			backup_dir = sanitize_path(NULL, backup_dir, NULL, 0, NULL);
++		if (backup_dir_dels)
++			backup_dir_dels = sanitize_path(NULL, backup_dir_dels, NULL, 0, NULL);
  	}
  	if (server_filter_list.head && !am_sender) {
  		struct filter_list_struct *elp = &server_filter_list;
-@@ -1245,6 +1257,14 @@ int parse_arguments(int *argc, const cha
+@@ -1253,6 +1265,14 @@ int parse_arguments(int *argc, const cha
  				return 0;
  			}
  		}
 +		/* Clean backup_dir_dels same as for backup_dir */
 +		if (backup_dir_dels) {
 +			if (!*backup_dir_dels)
@@ -222,13 +228,13 @@
 +			if (check_filter(elp, backup_dir_dels, 1) < 0)
 +				goto options_rejected;
 +		}
  	}
  
  	if (!backup_suffix)
-@@ -1256,6 +1276,16 @@ int parse_arguments(int *argc, const cha
+@@ -1264,6 +1284,16 @@ int parse_arguments(int *argc, const cha
  			backup_suffix);
  		return 0;
  	}
 +	/* if backup_suffix_dels not supplied, default to backup_suffix */
 +	if (!backup_suffix_dels)
 +		backup_suffix_dels = backup_dir_dels ? "" : backup_suffix;
@@ -239,13 +245,13 @@
 +			backup_suffix_dels);	
 +		return 0;
 +	}
  	if (backup_dir) {
  		backup_dir_len = strlcpy(backup_dir_buf, backup_dir, sizeof backup_dir_buf);
  		backup_dir_remainder = sizeof backup_dir_buf - backup_dir_len;
-@@ -1279,6 +1309,31 @@ int parse_arguments(int *argc, const cha
+@@ -1287,6 +1317,31 @@ int parse_arguments(int *argc, const cha
  			"P *%s", backup_suffix);
  		parse_rule(&filter_list, backup_dir_buf, 0, 0);
  	}
 +	/* If backup_dir_dels not supplied default to backup_dir if it has been supplied */
 +	if (backup_dir && !backup_dir_dels) {
 +		backup_dir_dels = backup_dir;
@@ -271,24 +277,24 @@
 +			"--suffix-dels cannot be a null string without --backup-dir-dels\n");
 +		return 0;
 +	}
  	if (make_backups && !backup_dir)
  		omit_dir_times = 1;
  
-@@ -1623,6 +1678,10 @@ void server_options(char **args,int *arg
+@@ -1646,6 +1701,10 @@ void server_options(char **args,int *arg
  		args[ac++] = "--backup-dir";
  		args[ac++] = backup_dir;
  	}
 +	if (backup_dir_dels && backup_dir_dels != backup_dir) {
 +		args[ac++] = "--backup-dir-dels";
 +		args[ac++] = backup_dir_dels;
 +	}
  
  	/* Only send --suffix if it specifies a non-default value. */
  	if (strcmp(backup_suffix, backup_dir ? "" : BACKUP_SUFFIX) != 0) {
-@@ -1631,7 +1690,13 @@ void server_options(char **args,int *arg
+@@ -1654,7 +1713,13 @@ void server_options(char **args,int *arg
  			goto oom;
  		args[ac++] = arg;
  	}
 -
 +	/* Only send --suffix-dels if it specifies a non-default value. */
 +	if (strcmp(backup_suffix_dels, backup_dir_dels ? "" : BACKUP_SUFFIX) != 0) {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/catch_crash_signals.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/catch_crash_signals.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/catch_crash_signals.diff	2006-04-22 23:40:51.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/catch_crash_signals.diff	2006-11-02 05:33:37.000000000 +0800
@@ -16,12 +16,18 @@
 > By the way. When I terminate rsync in daemon mode by pressing Control-C,
 > it writes an error to log. May be this is not an error but info or notice?
 
 I'm not sure I like this, but if you run into the cygwin problem, this might
 prove helpful.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/catch_crash_signals.diff
+    ./configure                                  (optional if already run)
+    make
+
 --- old/errcode.h
 +++ new/errcode.h
 @@ -47,6 +47,8 @@
  
  #define RERR_TIMEOUT    30      /* timeout in data send/receive */
  
@@ -29,36 +35,36 @@
 +
  /* Although it doesn't seem to be specified anywhere,
   * ssh and the shell seem to return these values:
   *
 --- old/log.c
 +++ new/log.c
-@@ -78,6 +78,7 @@ struct {
+@@ -77,6 +77,7 @@ struct {
  	{ RERR_TERMINATED , "sibling process terminated abnormally" },
  	{ RERR_SIGNAL1    , "received SIGUSR1" },
  	{ RERR_SIGNAL     , "received SIGINT, SIGTERM, or SIGHUP" },
 +	{ RERR_WECRASHED  , "rsync caught a CRASH-causing signal" },
  	{ RERR_WAITCHILD  , "waitpid() failed" },
  	{ RERR_MALLOC     , "error allocating core memory buffers" },
  	{ RERR_PARTIAL    , "some files could not be transferred" },
 --- old/main.c
 +++ new/main.c
-@@ -138,8 +138,11 @@ static void wait_process_with_flush(pid_
+@@ -149,8 +149,11 @@ static void wait_process_with_flush(pid_
  			*exit_code_ptr = RERR_TERMINATED;
  		else
  			*exit_code_ptr = RERR_WAITCHILD;
 -	} else
 +	} else {
  		*exit_code_ptr = WEXITSTATUS(status);
 +		if (*exit_code_ptr == RERR_WECRASHED)
 +			*exit_code_ptr = RERR_CRASHED;
 +	}
  }
  
  /* This function gets called from all 3 processes.  We want the client side
-@@ -1124,6 +1127,14 @@ RETSIGTYPE remember_children(UNUSED(int 
+@@ -1211,6 +1214,14 @@ RETSIGTYPE remember_children(UNUSED(int 
  				break;
  			}
  		}
 +		if (WIFSIGNALED(status)) {
 +			rprintf(FLOG,
 +				"rsync error: (1) Child proccess has unexpectedly died with signal %d\n",
@@ -67,26 +73,26 @@
 +			rprintf(FLOG,
 +				"rsync error: (1) Child proccess has CRASHED.\n");
 +		}
  	}
  #endif
  #ifndef HAVE_SIGACTION
-@@ -1182,6 +1193,12 @@ static RETSIGTYPE rsync_panic_handler(UN
+@@ -1269,6 +1280,12 @@ static RETSIGTYPE rsync_panic_handler(UN
  }
  #endif
  
 +static RETSIGTYPE rsync_crash_handler(UNUSED(int whatsig))
 +{
 +	log_exit(RERR_WECRASHED, __FILE__, __LINE__);
 +	logfile_close();
 +	_exit(RERR_WECRASHED);
 +}
  
  int main(int argc,char *argv[])
  {
-@@ -1204,6 +1221,11 @@ int main(int argc,char *argv[])
+@@ -1291,6 +1308,11 @@ int main(int argc,char *argv[])
  	SIGACTMASK(SIGFPE, rsync_panic_handler);
  	SIGACTMASK(SIGABRT, rsync_panic_handler);
  	SIGACTMASK(SIGBUS, rsync_panic_handler);
 +#else
 +	SIGACTMASK(SIGSEGV, rsync_crash_handler);
 +	SIGACTMASK(SIGFPE, rsync_crash_handler);
@@ -94,13 +100,13 @@
 +	SIGACTMASK(SIGBUS, rsync_crash_handler);
  #endif
  
  	starttime = time(NULL);
 --- old/socket.c
 +++ new/socket.c
-@@ -459,7 +459,17 @@ int is_a_socket(int fd)
+@@ -454,7 +454,17 @@ int is_a_socket(int fd)
  static RETSIGTYPE sigchld_handler(UNUSED(int val))
  {
  #ifdef WNOHANG
 -	while (waitpid(-1, NULL, WNOHANG) > 0) {}
 +	int status;
 +	while (waitpid(-1, &status, WNOHANG) > 0) {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/cvs-entries.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/cvs-entries.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/cvs-entries.diff	2006-04-22 23:40:58.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/cvs-entries.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,22 +1,28 @@
 This patch causes the --cvs-exclude option to prefix the names listed
 in each dir's CVS/Entries file as per-dir includes before the dir's list
 of excludes taken from the .cvsignore file.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/cvs-entries.diff
+    ./configure                                 (optional if already run)
+    make
+
 --- old/exclude.c
 +++ new/exclude.c
-@@ -219,6 +219,8 @@ static void add_rule(struct filter_list_
+@@ -216,6 +216,8 @@ static void add_rule(struct filter_list_
  		if (!(lp = new_array(struct filter_list_struct, 1)))
  			out_of_memory("add_rule");
  		lp->head = lp->tail = NULL;
 +		if (mflags & MATCHFLG_CVS_IGNORE)
 +			cp = "CVS";
  		if (asprintf(&lp->debug_type, " [per-dir %s]", cp) < 0)
  			out_of_memory("add_rule");
  		ret->u.mergelist = lp;
-@@ -452,6 +454,14 @@ void *push_local_filters(const char *dir
+@@ -448,6 +450,14 @@ void *push_local_filters(const char *dir
  				set_filter_dir(dir, dirlen);
  		}
  
 +		if (ex->match_flags & MATCHFLG_CVS_IGNORE
 +		    && strlcpy(dirbuf + dirbuf_len, "CVS/Entries",
 +			MAXPATHLEN - dirbuf_len) < MAXPATHLEN - dirbuf_len) {
@@ -25,21 +31,21 @@
 +				      MATCHFLG_NO_PREFIXES | MATCHFLG_INCLUDE,
 +				      XFLG_CVS_ENTRIES);
 +		}
  		if (strlcpy(dirbuf + dirbuf_len, ex->pattern,
  		    MAXPATHLEN - dirbuf_len) < MAXPATHLEN - dirbuf_len) {
  			parse_filter_file(lp, dirbuf, ex->match_flags,
-@@ -968,6 +978,7 @@ void parse_filter_file(struct filter_lis
+@@ -973,6 +983,7 @@ void parse_filter_file(struct filter_lis
  	char line[BIGPATHBUFLEN];
  	char *eob = line + sizeof line - 1;
  	int word_split = mflags & MATCHFLG_WORD_SPLIT;
 +	int slash_parse = xflags & XFLG_CVS_ENTRIES ? 1 : 0;
  
  	if (!fname || !*fname)
  		return;
-@@ -1014,6 +1025,24 @@ void parse_filter_file(struct filter_lis
+@@ -1019,6 +1030,24 @@ void parse_filter_file(struct filter_lis
  				}
  				break;
  			}
 +			switch (slash_parse) { /* CVS/Entries parsing: */
 +			case 1: /* Ignore starting chars until first slash. */
 +				if (ch == '/')
@@ -58,13 +64,13 @@
 +				}
 +				continue;
 +			}
  			if (word_split && isspace(ch))
  				break;
  			if (eol_nulls? !ch : (ch == '\n' || ch == '\r'))
-@@ -1023,13 +1052,15 @@ void parse_filter_file(struct filter_lis
+@@ -1028,13 +1057,15 @@ void parse_filter_file(struct filter_lis
  			else
  				overflow = 1;
  		}
 +	  end_the_line:
  		if (overflow) {
  			rprintf(FERROR, "discarding over-long filter: %s...\n", line);
@@ -77,13 +83,13 @@
 +			   || (*line != ';' && *line != '#')))
  			parse_rule(listp, line, mflags, xflags);
  		if (ch == EOF)
  			break;
 --- old/rsync.h
 +++ new/rsync.h
-@@ -116,6 +116,7 @@
+@@ -117,6 +117,7 @@
  #define XFLG_OLD_PREFIXES	(1<<1)
  #define XFLG_ANCHORED2ABS	(1<<2)
  #define XFLG_ABS_IF_SLASH	(1<<3)
 +#define XFLG_CVS_ENTRIES	(1<<4)
  
  #define ATTRS_REPORT		(1<<0)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/date-only.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/date-only.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/date-only.diff	2006-04-22 23:41:11.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/date-only.diff	2006-11-07 12:42:21.000000000 +0800
@@ -1,89 +1,88 @@
-Greetings, and thanks for all of your work on the wonderful rsync!
+Jeremy Bornstein wrote:
 
 I recently had the need to transfer files only with different mod
 dates (and to *not* transfer them based on file size differences).
 This is because I'm backing up files remotely on an untrusted machine,
 so I'm encrypting them with gpg before transfer.  I discovered that
 rsync didn't already have a --date-only flag, so I added one and am
 enclosing the diffs in case you (as I hope) decide to include this
 option in future releases.
 
-Again, thanks!
+To use this patch, run these commands for a successful build:
 
-Best Regards,
-Jeremy Bornstein
-
-[Patched update to have context and apply to latest CVS source.]
+    patch -p1 <patches/date-only.diff
+    ./configure                                 (optional if already run)
+    make
 
 --- old/generator.c
 +++ new/generator.c
-@@ -61,6 +61,7 @@ extern int append_mode;
+@@ -60,6 +60,7 @@ extern int append_mode;
  extern int make_backups;
  extern int csum_length;
  extern int ignore_times;
 +extern int date_only;
  extern int size_only;
  extern OFF_T max_size;
  extern OFF_T min_size;
-@@ -376,6 +377,8 @@ void itemize(struct file_struct *file, i
+@@ -378,6 +379,8 @@ void itemize(struct file_struct *file, i
  /* Perform our quick-check heuristic for determining if a file is unchanged. */
  int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st)
  {
 +	if (date_only)
 +		return cmp_time(st->st_mtime, file->modtime) == 0;
  	if (st->st_size != file->length)
  		return 0;
  
 --- old/options.c
 +++ new/options.c
-@@ -97,6 +97,7 @@ int keep_partial = 0;
+@@ -99,6 +99,7 @@ int keep_partial = 0;
  int safe_symlinks = 0;
  int copy_unsafe_links = 0;
  int size_only = 0;
 +int date_only = 0;
  int daemon_bwlimit = 0;
  int bwlimit = 0;
  int fuzzy_basis = 0;
-@@ -331,6 +332,7 @@ void usage(enum logcode F)
+@@ -343,6 +344,7 @@ void usage(enum logcode F)
    rprintf(F,"     --timeout=TIME          set I/O timeout in seconds\n");
    rprintf(F," -I, --ignore-times          don't skip files that match in size and mod-time\n");
    rprintf(F,"     --size-only             skip files that match in size\n");
 +  rprintf(F,"     --date-only             skip files that match in mod-time\n");
    rprintf(F,"     --modify-window=NUM     compare mod-times with reduced accuracy\n");
    rprintf(F," -T, --temp-dir=DIR          create temporary files in directory DIR\n");
    rprintf(F," -y, --fuzzy                 find similar file for basis if no dest file\n");
-@@ -446,6 +448,7 @@ static struct poptOption long_options[] 
+@@ -463,6 +465,7 @@ static struct poptOption long_options[] 
    {"chmod",            0,  POPT_ARG_STRING, 0, OPT_CHMOD, 0, 0 },
    {"ignore-times",    'I', POPT_ARG_NONE,   &ignore_times, 0, 0, 0 },
    {"size-only",        0,  POPT_ARG_NONE,   &size_only, 0, 0, 0 },
 +  {"date-only",        0,  POPT_ARG_NONE,   &date_only, 0, 0, 0 },
    {"one-file-system", 'x', POPT_ARG_NONE,   0, 'x', 0, 0 },
    {"update",          'u', POPT_ARG_NONE,   &update_only, 0, 0, 0 },
    {"existing",         0,  POPT_ARG_NONE,   &ignore_non_existing, 0, 0, 0 },
-@@ -1653,6 +1656,9 @@ void server_options(char **args,int *arg
+@@ -1676,6 +1679,9 @@ void server_options(char **args,int *arg
  			args[ac++] = "--size-only";
  	}
  
 +	if (date_only)
 +		args[ac++] = "--date-only";
 +
  	if (modify_window_set) {
  		if (asprintf(&arg, "--modify-window=%d", modify_window) < 0)
  			goto oom;
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -359,6 +359,7 @@ to the detailed description below for a 
+@@ -360,6 +360,7 @@ to the detailed description below for a 
       --timeout=TIME          set I/O timeout in seconds
   -I, --ignore-times          don't skip files that match size and time
       --size-only             skip files that match in size
 +     --date-only             skip files that match in mod-time
       --modify-window=NUM     compare mod-times with reduced accuracy
   -T, --temp-dir=DIR          create temporary files in directory DIR
   -y, --fuzzy                 find similar file for basis if no dest file
-@@ -466,6 +467,12 @@ regardless of timestamp. This is useful 
+@@ -477,6 +478,12 @@ regardless of timestamp. This is useful 
  after using another mirroring system which may not preserve timestamps
  exactly.
  
 +dit(bf(--date-only)) Normally rsync will skip any files that are
 +already the same size and have the same modification time-stamp. With the
 +--date-only option, files will be skipped if they have the same
@@ -92,28 +91,28 @@
 +
  dit(bf(--modify-window)) When comparing two timestamps, rsync treats the
  timestamps as being equal if they differ by no more than the modify-window
  value.  This is normally 0 (for an exact match), but you may find it useful
 --- old/rsync.1
 +++ new/rsync.1
-@@ -415,6 +415,7 @@ to the detailed description below for a 
-      --timeout=TIME          set I/O timeout in seconds
-  -I, --ignore-times          don\&'t skip files that match size and time
-      --size-only             skip files that match in size
-+     --date-only             skip files that match in mod-time
-      --modify-window=NUM     compare mod-times with reduced accuracy
-  -T, --temp-dir=DIR          create temporary files in directory DIR
-  -y, --fuzzy                 find similar file for basis if no dest file
-@@ -536,6 +537,13 @@ regardless of timestamp\&. This is usefu
+@@ -426,6 +426,7 @@ to the detailed description below for a 
+      \-\-timeout=TIME          set I/O timeout in seconds
+  \-I, \-\-ignore\-times          don\&'t skip files that match size and time
+      \-\-size\-only             skip files that match in size
++     \-\-date\-only             skip files that match in mod-time
+      \-\-modify\-window=NUM     compare mod-times with reduced accuracy
+  \-T, \-\-temp\-dir=DIR          create temporary files in directory DIR
+  \-y, \-\-fuzzy                 find similar file for basis if no dest file
+@@ -556,6 +557,13 @@ regardless of timestamp\&. This is usefu
  after using another mirroring system which may not preserve timestamps
  exactly\&.
  .IP 
-+.IP "\fB--date-only\fP" 
++.IP "\fB\-\-date\-only\fP"
 +Normally rsync will skip any files that are
 +already the same size and have the same modification time-stamp\&. With the
-+--date-only option, files will be skipped if they have the same
++\-\-date\-only option, files will be skipped if they have the same
 +timestamp, regardless of size\&. This may be useful when the remote
 +files have passed through a size-changing filter, e\&.g\&. for encryption\&.
 +.IP 
- .IP "\fB--modify-window\fP" 
+ .IP "\fB\-\-modify\-window\fP"
  When comparing two timestamps, rsync treats the
  timestamps as being equal if they differ by no more than the modify-window
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/detect-renamed.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/detect-renamed.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/detect-renamed.diff	2006-04-22 23:41:20.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/detect-renamed.diff	2006-11-07 12:42:25.000000000 +0800
@@ -16,46 +16,46 @@
 I chose to hard-link the alternate-basis files into a ".~tmp~" subdir that
 takes advantage of rsync's pre-existing partial-dir logic.  This uses less
 memory than trying to keep track of the matches internally, and also allows
 any deletions or file-updates to occur normally without interfering with
 these alternate-basis discoveries.
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
-    ./prepare-source
-    ./configure                      (optional if already run)
+    patch -p1 <patches/detect-renamed.diff
+    ./configure                                 (optional if already run)
     make
 
 TODO:
 
   We need to never return a match from fattr_find() that has a basis
   file.  This will ensure that we don't try to give a renamed file to
   a file that can't use it, while missing out on giving it to a file
   that could use it.
 
 --- old/flist.c
 +++ new/flist.c
-@@ -55,6 +55,7 @@ extern int implied_dirs;
+@@ -51,6 +51,7 @@ extern int implied_dirs;
  extern int prune_empty_dirs;
  extern int copy_links;
  extern int copy_unsafe_links;
 +extern int detect_renamed;
  extern int protocol_version;
  extern int sanitize_paths;
  extern struct stats stats;
-@@ -72,6 +73,8 @@ int checksum_len;
+@@ -68,6 +69,8 @@ int checksum_len;
  dev_t filesystem_dev; /* used to implement -x */
  unsigned int file_struct_len;
  
 +struct file_list the_fattr_list;
 +
  static char empty_sum[MD4_SUM_LENGTH];
  static int flist_count_offset;
  
-@@ -258,6 +261,44 @@ static mode_t from_wire_mode(int mode)
- 	return (mode_t)mode;
+@@ -250,6 +253,44 @@ static mode_t from_wire_mode(int mode)
+ 	return mode;
  }
  
 +static int fattr_compare(struct file_struct **file1, struct file_struct **file2)
 +{
 +	struct file_struct *f1 = *file1;
 +	struct file_struct *f2 = *file2;
@@ -93,13 +93,13 @@
 +	return u_strcmp(f1->dirname, f2->dirname);
 +}
 +
  static void send_directory(int f, struct file_list *flist,
  			   char *fbuf, int len);
  
-@@ -1382,6 +1423,25 @@ struct file_list *recv_file_list(int f)
+@@ -1379,6 +1420,25 @@ struct file_list *recv_file_list(int f)
  
  	clean_flist(flist, relative_paths, 1);
  
 +	if (detect_renamed) {
 +		int j = flist->count;
 +		the_fattr_list.count = j;
@@ -121,20 +121,20 @@
 +
  	if (f >= 0) {
  		recv_uid_list(f, flist);
  
 --- old/generator.c
 +++ new/generator.c
-@@ -77,6 +77,7 @@ extern char *basis_dir[];
+@@ -76,6 +76,7 @@ extern char *basis_dir[];
  extern int compare_dest;
  extern int copy_dest;
  extern int link_dest;
 +extern int detect_renamed;
  extern int whole_file;
  extern int list_only;
- extern int read_batch;
+ extern int new_root_dir;
 @@ -91,12 +92,15 @@ extern char *backup_dir;
  extern char *backup_suffix;
  extern int backup_suffix_len;
  extern struct file_list *the_file_list;
 +extern struct file_list the_fattr_list;
  extern struct filter_list_struct server_filter_list;
@@ -410,22 +410,22 @@
  	}
 -	delete_in_dir(NULL, NULL, NULL, NULL);
 +	delete_in_dir(NULL, NULL, NULL, NULL, 0);
  
  	if (do_progress && !am_server)
  		rprintf(FINFO, "                    \r");
-@@ -768,6 +909,7 @@ static int try_dests_non(struct file_str
+@@ -771,6 +912,7 @@ static int try_dests_non(struct file_str
  	return -1;
  }
  
 +static struct bitbag *delayed_bits = NULL;
  static int phase = 0;
  
  /* Acts on the_file_list->file's ndx'th item, whose name is fname.  If a dir,
-@@ -922,8 +1064,12 @@ static void recv_generator(char *fname, 
- 		    && verbose && code && f_out != -1)
+@@ -944,8 +1086,12 @@ static void recv_generator(char *fname, 
+ 		    && verbose && code != FNONE && f_out != -1)
  			rprintf(code, "%s/\n", fname);
  		if (delete_during && f_out != -1 && !phase && dry_run < 2
 -		    && (file->flags & FLAG_DEL_HERE))
 -			delete_in_dir(the_file_list, fname, file, &st);
 +		    && (file->flags & FLAG_DEL_HERE)) {
 +			if (detect_renamed && statret != 0)
@@ -433,13 +433,13 @@
 +			delete_in_dir(the_file_list, fname, file, &st,
 +				      delete_during < 0 ? DEL_NO_DELETIONS : 0);
 +		}
  		return;
  	}
  
-@@ -1168,8 +1314,14 @@ static void recv_generator(char *fname, 
+@@ -1201,8 +1347,14 @@ static void recv_generator(char *fname, 
  		    && hard_link_check(file, ndx, fname, statret, &st,
  				       itemizing, code, HL_SKIP))
  			return;
 -		if (stat_errno == ENOENT)
 +		if (stat_errno == ENOENT) {
 +			if (detect_renamed && unexplored_dirs > 0
@@ -449,13 +449,13 @@
 +			}
  			goto notify_others;
 +		}
  		rsyserr(FERROR, stat_errno, "recv_generator: failed to stat %s",
  			full_fname(fname));
  		return;
-@@ -1347,11 +1499,17 @@ void generate_files(int f_out, struct fi
+@@ -1388,11 +1540,17 @@ void generate_files(int f_out, struct fi
  			(long)getpid(), flist->count);
  	}
  
 +	if (detect_renamed) {
 +		delayed_bits = bitbag_create(flist->count);
 +		if (!delete_before && !delete_during)
@@ -468,13 +468,13 @@
  
 -	if (append_mode || whole_file < 0)
 +	if (append_mode || detect_renamed || whole_file < 0)
  		whole_file = 0;
  	if (verbose >= 2) {
  		rprintf(FINFO, "delta-transmission %s\n",
-@@ -1406,7 +1564,23 @@ void generate_files(int f_out, struct fi
+@@ -1447,7 +1605,23 @@ void generate_files(int f_out, struct fi
  	}
  	recv_generator(NULL, NULL, 0, 0, 0, code, -1);
  	if (delete_during)
 -		delete_in_dir(NULL, NULL, NULL, NULL);
 +		delete_in_dir(NULL, NULL, NULL, NULL, 0);
 +
@@ -495,73 +495,73 @@
 +	}
  
  	phase++;
  	csum_length = SUM_LENGTH;
 --- old/options.c
 +++ new/options.c
-@@ -76,6 +76,7 @@ int am_generator = 0;
+@@ -78,6 +78,7 @@ int am_generator = 0;
  int am_starting_up = 1;
  int relative_paths = -1;
  int implied_dirs = 1;
 +int detect_renamed = 0;
  int numeric_ids = 0;
  int allow_8bit_chars = 0;
  int force_delete = 0;
-@@ -334,6 +335,7 @@ void usage(enum logcode F)
+@@ -346,6 +347,7 @@ void usage(enum logcode F)
    rprintf(F,"     --modify-window=NUM     compare mod-times with reduced accuracy\n");
    rprintf(F," -T, --temp-dir=DIR          create temporary files in directory DIR\n");
    rprintf(F," -y, --fuzzy                 find similar file for basis if no dest file\n");
 +  rprintf(F,"     --detect-renamed        try to find renamed files to speed up the transfer\n");
    rprintf(F,"     --compare-dest=DIR      also compare destination files relative to DIR\n");
    rprintf(F,"     --copy-dest=DIR         ... and include copies of unchanged files\n");
    rprintf(F,"     --link-dest=DIR         hardlink to files in DIR when unchanged\n");
-@@ -481,6 +483,7 @@ static struct poptOption long_options[] 
+@@ -499,6 +501,7 @@ static struct poptOption long_options[] 
    {"compare-dest",     0,  POPT_ARG_STRING, 0, OPT_COMPARE_DEST, 0, 0 },
    {"copy-dest",        0,  POPT_ARG_STRING, 0, OPT_COPY_DEST, 0, 0 },
    {"link-dest",        0,  POPT_ARG_STRING, 0, OPT_LINK_DEST, 0, 0 },
 +  {"detect-renamed",   0,  POPT_ARG_NONE,   &detect_renamed, 0, 0, 0 },
    {"fuzzy",           'y', POPT_ARG_NONE,   &fuzzy_basis, 0, 0, 0 },
    {"compress",        'z', POPT_ARG_NONE,   0, 'z', 0, 0 },
    {"compress-level",   0,  POPT_ARG_INT,    &def_compress_level, 'z', 0, 0 },
-@@ -1340,7 +1343,7 @@ int parse_arguments(int *argc, const cha
+@@ -1362,7 +1365,7 @@ int parse_arguments(int *argc, const cha
  		inplace = 1;
  	}
  
 -	if (delay_updates && !partial_dir)
 +	if ((delay_updates || detect_renamed) && !partial_dir)
  		partial_dir = tmp_partialdir;
  
  	if (inplace) {
-@@ -1349,6 +1352,7 @@ int parse_arguments(int *argc, const cha
+@@ -1371,6 +1374,7 @@ int parse_arguments(int *argc, const cha
  			snprintf(err_buf, sizeof err_buf,
  				 "--%s cannot be used with --%s\n",
  				 append_mode ? "append" : "inplace",
 +				 detect_renamed ? "detect-renamed" :
  				 delay_updates ? "delay-updates" : "partial-dir");
  			return 0;
  		}
-@@ -1651,6 +1655,8 @@ void server_options(char **args,int *arg
+@@ -1674,6 +1678,8 @@ void server_options(char **args,int *arg
  			args[ac++] = "--super";
  		if (size_only)
  			args[ac++] = "--size-only";
 +		if (detect_renamed)
 +			args[ac++] = "--detect-renamed";
  	}
  
  	if (modify_window_set) {
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -362,6 +362,7 @@ to the detailed description below for a 
+@@ -363,6 +363,7 @@ to the detailed description below for a 
       --modify-window=NUM     compare mod-times with reduced accuracy
   -T, --temp-dir=DIR          create temporary files in directory DIR
   -y, --fuzzy                 find similar file for basis if no dest file
 +     --detect-renamed        try to find renamed files to speed the xfer
       --compare-dest=DIR      also compare received files relative to DIR
       --copy-dest=DIR         ... and include copies of unchanged files
       --link-dest=DIR         hardlink to files in DIR when unchanged
-@@ -1247,6 +1248,15 @@ Note that the use of the bf(--delete) op
+@@ -1259,6 +1260,15 @@ Note that the use of the bf(--delete) op
  fuzzy-match files, so either use bf(--delete-after) or specify some
  filename exclusions if you need to prevent this.
  
 +dit(bf(--detect-renamed)) This option tells rsync to scan the receiving
 +side for files that have been renamed, and to use any that are found as
 +alternate basis files to help speed up the transfer.
@@ -573,13 +573,13 @@
 +
  dit(bf(--compare-dest=DIR)) This option instructs rsync to use em(DIR) on
  the destination machine as an additional hierarchy to compare destination
  files against doing transfers (if the files are missing in the destination
 --- old/util.c
 +++ new/util.c
-@@ -1013,6 +1013,32 @@ int handle_partial_dir(const char *fname
+@@ -1025,6 +1025,32 @@ int handle_partial_dir(const char *fname
  	return 1;
  }
  
 +/* We need to supply our own strcmp function for file list comparisons
 + * to ensure that signed/unsigned usage is consistent between machines. */
 +int u_strcmp(const char *p1, const char *p2)
@@ -608,42 +608,42 @@
 +
  /**
   * Determine if a symlink points outside the current directory tree.
   * This is considered "unsafe" because e.g. when mirroring somebody
 --- old/proto.h
 +++ new/proto.h
-@@ -303,6 +303,8 @@ int pop_dir(char *dir);
+@@ -304,6 +304,8 @@ int pop_dir(char *dir);
  char *full_fname(const char *fn);
  char *partial_dir_fname(const char *fname);
  int handle_partial_dir(const char *fname, int create);
 +int u_strcmp(const char *p1, const char *p2);
 +int u_memcmp(const void *p1, const void *p2, size_t len);
  int unsafe_symlink(const char *dest, const char *src);
  char *human_num(int64 num);
  char *human_dnum(double dnum, int decimal_digits);
 --- old/rsync.1
 +++ new/rsync.1
-@@ -418,6 +418,7 @@ to the detailed description below for a 
-      --modify-window=NUM     compare mod-times with reduced accuracy
-  -T, --temp-dir=DIR          create temporary files in directory DIR
-  -y, --fuzzy                 find similar file for basis if no dest file
-+     --detect-renamed        try to find renamed files to speed the xfer
-      --compare-dest=DIR      also compare received files relative to DIR
-      --copy-dest=DIR         \&.\&.\&. and include copies of unchanged files
-      --link-dest=DIR         hardlink to files in DIR when unchanged
-@@ -1419,6 +1420,16 @@ Note that the use of the \fB--delete\fP 
- fuzzy-match files, so either use \fB--delete-after\fP or specify some
+@@ -429,6 +429,7 @@ to the detailed description below for a 
+      \-\-modify\-window=NUM     compare mod-times with reduced accuracy
+  \-T, \-\-temp\-dir=DIR          create temporary files in directory DIR
+  \-y, \-\-fuzzy                 find similar file for basis if no dest file
++     \-\-detect\-renamed        try to find renamed files to speed the xfer
+      \-\-compare\-dest=DIR      also compare received files relative to DIR
+      \-\-copy\-dest=DIR         \&.\&.\&. and include copies of unchanged files
+      \-\-link\-dest=DIR         hardlink to files in DIR when unchanged
+@@ -1458,6 +1459,16 @@ Note that the use of the \fB\-\-delete\f
+ fuzzy-match files, so either use \fB\-\-delete\-after\fP or specify some
  filename exclusions if you need to prevent this\&.
  .IP 
-+.IP "\fB--detect-renamed\fP" 
++.IP "\fB\-\-detect\-renamed\fP"
 +This option tells rsync to scan the receiving
 +side for files that have been renamed, and to use any that are found as
 +alternate basis files to help speed up the transfer\&.
 +By default, alternate-basis files are hard-linked into a directory named
 +"\&.~tmp~" in each file\&'s destination directory, but if you\&'ve specified
-+the \fB--partial-dir\fP option, that directory will be used instead\&.  These
++the \fB\-\-partial\-dir\fP option, that directory will be used instead\&.  These
 +potential alternate-basis files will be removed as the transfer progresses\&.
-+This option conflicts with \fB--inplace\fP and \fB--append\fP\&.
++This option conflicts with \fB\-\-inplace\fP and \fB\-\-append\fP\&.
 +.IP 
- .IP "\fB--compare-dest=DIR\fP" 
+ .IP "\fB\-\-compare\-dest=DIR\fP"
  This option instructs rsync to use \fIDIR\fP on
  the destination machine as an additional hierarchy to compare destination
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches: downdate.diff
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/dynamic_hash.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/dynamic_hash.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/dynamic_hash.diff	2006-03-07 15:40:53.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/dynamic_hash.diff	2006-11-02 05:33:37.000000000 +0800
@@ -5,15 +5,21 @@
 down the code for normal file sizes (e.g. 4 CPU seconds slower on a Pentium
 III when copying a 65 MB file without very much matching data).
 
 This was updated for the latest codebase from a patch written by Shachar
 Shemesh.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/dynamic_hash.diff
+    ./configure                                 (optional if already run)
+    make
+
 --- old/match.c
 +++ new/match.c
-@@ -37,24 +37,31 @@ static int total_matches;
+@@ -40,24 +40,31 @@ static int total_matches;
  
  extern struct stats stats;
  
 -#define TABLESIZE (1<<16)
 -
 +static uint32 tablesize;
@@ -46,13 +52,13 @@
  
 -	memset(hash_table, 0xFF, TABLESIZE * sizeof hash_table[0]);
 +	memset(hash_table, 0xFF, tablesize * sizeof hash_table[0]);
  
  	for (i = 0; i < s->count; i++) {
  		uint32 t = SUM2HASH(s->sums[i].sum1);
-@@ -162,11 +169,11 @@ static void hash_search(int f,struct sum
+@@ -165,11 +172,11 @@ static void hash_search(int f,struct sum
  				(double)offset, s2 & 0xFFFF, s1 & 0xFFFF);
  		}
  
 -		i = hash_table[SUM2HASH2(s1,s2)];
 +		sum = (s1 & 0xffff) | (s2 << 16);
 +		i = hash_table[SUM2HASH(sum)];
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/early-checksum.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/early-checksum.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/early-checksum.diff	2006-04-22 23:52:02.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/early-checksum.diff	2006-11-07 12:42:27.000000000 +0800
@@ -5,23 +5,29 @@
 the receiver can then happen in parallel instead of having the reciever
 to its checksum pass during its normal find-the-different-files pass.
 
 I have benchmarked this a little, and it appears to slow things down
 for a local copy, so the old algorithm is used for local copies.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/early-checksum.diff
+    ./configure                                 (optional if already run)
+    make
+
 --- old/flist.c
 +++ new/flist.c
-@@ -35,6 +35,7 @@ extern int am_daemon;
+@@ -31,6 +31,7 @@ extern int am_daemon;
  extern int am_sender;
  extern int do_progress;
  extern int always_checksum;
 +extern int pre_checksum;
  extern int module_id;
  extern int ignore_errors;
  extern int numeric_ids;
-@@ -705,6 +706,16 @@ static struct file_struct *receive_file_
+@@ -697,6 +698,16 @@ static struct file_struct *receive_file_
  			sum = empty_sum;
  		}
  		read_buf(f, sum, checksum_len);
 +		if (pre_checksum) {
 +			char sum2[MD4_SUM_LENGTH];
 +			STRUCT_STAT st;
@@ -34,132 +40,132 @@
 +		}
  	}
  
  	return file;
 --- old/generator.c
 +++ new/generator.c
-@@ -71,6 +71,7 @@ extern int ignore_timeout;
+@@ -70,6 +70,7 @@ extern int ignore_timeout;
  extern int protocol_version;
  extern int fuzzy_basis;
  extern int always_checksum;
 +extern int pre_checksum;
  extern int checksum_len;
  extern char *partial_dir;
  extern char *basis_dir[];
-@@ -374,7 +375,8 @@ void itemize(struct file_struct *file, i
+@@ -376,7 +377,8 @@ void itemize(struct file_struct *file, i
  
  
  /* Perform our quick-check heuristic for determining if a file is unchanged. */
 -int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st)
 +int unchanged_file(char *fn, int fnamecmp_type, struct file_struct *file,
 +		   STRUCT_STAT *st)
  {
  	if (st->st_size != file->length)
  		return 0;
-@@ -383,6 +385,8 @@ int unchanged_file(char *fn, struct file
+@@ -385,6 +387,8 @@ int unchanged_file(char *fn, struct file
  	   of the file time to determine whether to sync */
  	if (always_checksum && S_ISREG(st->st_mode)) {
  		char sum[MD4_SUM_LENGTH];
 +		if (pre_checksum && fnamecmp_type == FNAMECMP_FNAME)
 +			return !(file->flags & FLAG_SUM_DIFFERS);
  		file_checksum(fn, sum, st->st_size);
  		return memcmp(sum, file->u.sum, checksum_len) == 0;
  	}
-@@ -620,7 +624,7 @@ static int try_dests_reg(struct file_str
+@@ -622,7 +626,7 @@ static int try_dests_reg(struct file_str
  			match_level = 1;
  			/* FALL THROUGH */
  		case 1:
 -			if (!unchanged_file(cmpbuf, file, stp))
 +			if (!unchanged_file(cmpbuf, 0, file, stp))
  				continue;
  			best_match = j;
  			match_level = 2;
-@@ -1182,7 +1186,7 @@ static void recv_generator(char *fname, 
+@@ -1215,7 +1219,7 @@ static void recv_generator(char *fname, 
  		;
  	else if (fnamecmp_type == FNAMECMP_FUZZY)
  		;
 -	else if (unchanged_file(fnamecmp, file, &st)) {
 +	else if (unchanged_file(fnamecmp, fnamecmp_type, file, &st)) {
  		if (partialptr) {
  			do_unlink(partialptr);
  			handle_partial_dir(partialptr, PDIR_DELETE);
 --- old/hlink.c
 +++ new/hlink.c
-@@ -209,7 +209,7 @@ int hard_link_check(struct file_struct *
- 							itemizing = code = 0;
+@@ -224,7 +224,7 @@ int hard_link_check(struct file_struct *
+ 						}
  						break;
  					}
 -					if (!unchanged_file(cmpbuf, file, &st3))
 +					if (!unchanged_file(cmpbuf, 0, file, &st3))
  						continue;
  					statret = 1;
  					st = &st3;
 --- old/main.c
 +++ new/main.c
-@@ -45,6 +45,7 @@ extern int copy_dirlinks;
+@@ -47,6 +47,7 @@ extern int copy_dirlinks;
  extern int keep_dirlinks;
  extern int preserve_hard_links;
  extern int protocol_version;
 +extern int always_checksum;
  extern int recurse;
  extern int relative_paths;
- extern int rsync_port;
-@@ -60,7 +61,9 @@ extern char *filesfrom_host;
- extern char *rsync_path;
- extern char *shell_cmd;
- extern char *batch_name;
-+extern char curr_dir[MAXPATHLEN];
+ extern int sanitize_paths;
+@@ -71,6 +72,9 @@ extern char *batch_name;
+ extern char curr_dir[MAXPATHLEN];
+ extern struct filter_list_struct server_filter_list;
  
++extern char curr_dir[MAXPATHLEN];
++
 +int pre_checksum = 0;
  int local_server = 0;
+ int new_root_dir = 0;
  mode_t orig_umask = 0;
- struct file_list *the_file_list;
-@@ -729,6 +732,7 @@ static void do_server_recv(int f_in, int
+@@ -784,6 +788,7 @@ static void do_server_recv(int f_in, int
  	struct file_list *flist;
  	char *local_name = NULL;
  	char *dir = NULL;
 +	char olddir[sizeof curr_dir];
  	int save_verbose = verbose;
  
  	if (filesfrom_fd >= 0) {
-@@ -772,6 +776,10 @@ static void do_server_recv(int f_in, int
+@@ -827,6 +832,10 @@ static void do_server_recv(int f_in, int
  		filesfrom_fd = -1;
  	}
  
 +	strlcpy(olddir, curr_dir, sizeof olddir);
 +	if (always_checksum && !local_server && argc > 0)
-+		pre_checksum = push_dir(argv[0]);
++		pre_checksum = push_dir(argv[0], 0);
 +
  	flist = recv_file_list(f_in);
  	verbose = save_verbose;
  	if (!flist) {
-@@ -780,6 +788,9 @@ static void do_server_recv(int f_in, int
+@@ -835,6 +844,9 @@ static void do_server_recv(int f_in, int
  	}
  	the_file_list = flist;
  
 +	if (pre_checksum)
 +		pop_dir(olddir);
 +
  	if (argc > 0)
  		local_name = get_local_name(flist,argv[0]);
  
-@@ -831,6 +842,7 @@ int client_run(int f_in, int f_out, pid_
+@@ -916,6 +928,7 @@ int client_run(int f_in, int f_out, pid_
  {
  	struct file_list *flist = NULL;
  	int exit_code = 0, exit_code2 = 0;
 +	char olddir[sizeof curr_dir];
  	char *local_name = NULL;
  
  	cleanup_child_pid = pid;
-@@ -905,11 +917,18 @@ int client_run(int f_in, int f_out, pid_
+@@ -990,11 +1003,18 @@ int client_run(int f_in, int f_out, pid_
  		filesfrom_fd = -1;
  	}
  
 +	strlcpy(olddir, curr_dir, sizeof olddir);
 +	if (always_checksum && !local_server)
-+		pre_checksum = push_dir(argv[0]);
++		pre_checksum = push_dir(argv[0], 0);
 +
  	if (write_batch && !am_server)
  		start_write_batch(f_in);
  	flist = recv_file_list(f_in);
  	the_file_list = flist;
  
@@ -168,17 +174,17 @@
 +
  	if (flist && flist->count > 0) {
  		local_name = get_local_name(flist, argv[0]);
  
 --- old/rsync.h
 +++ new/rsync.h
-@@ -64,6 +64,7 @@
- #define FLAG_DEL_HERE (1<<3)	/* receiver/generator */
+@@ -65,6 +65,7 @@
  #define FLAG_HLINK_TOL (1<<4)	/* receiver/generator */
  #define FLAG_NO_FUZZY (1<<5)	/* generator */
-+#define FLAG_SUM_DIFFERS (1<<6)	/* receiver/generator */
+ #define FLAG_MISSING (1<<6)	/* generator */
++#define FLAG_SUM_DIFFERS (1<<7)	/* receiver/generator */
  
  /* update this if you make incompatible changes */
  #define PROTOCOL_VERSION 29
 --- old/proto.h
 +++ new/proto.h
 @@ -86,7 +86,8 @@ struct file_list *get_dirlist(char *dirn
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches: fake-super.diff
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/flags.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/flags.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/flags.diff	2006-04-22 23:52:13.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/flags.diff	2006-11-07 12:42:58.000000000 +0800
@@ -1,77 +1,82 @@
 This patch provides --flags, which preserves the st_flags field.
-Modified from a patch that was written by Rolf Grossmann:
+Modified from a patch that was written by Rolf Grossmann.
 
-    http://www.progtech.net/rsync.flags-patch
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/flags.diff
+    ./prepare-source
+    ./configure
+    make
 
 --- old/configure.in
 +++ new/configure.in
-@@ -494,7 +494,7 @@ AC_CHECK_FUNCS(waitpid wait4 getcwd strd
+@@ -527,7 +527,7 @@ AC_CHECK_FUNCS(waitpid wait4 getcwd strd
      memmove lchown vsnprintf snprintf vasprintf asprintf setsid glob strpbrk \
      strlcat strlcpy strtol mallinfo getgroups setgroups geteuid getegid \
      setlocale setmode open64 lseek64 mkstemp64 mtrace va_copy __va_copy \
 -    strerror putenv iconv_open locale_charset nl_langinfo \
 +    chflags strerror putenv iconv_open locale_charset nl_langinfo \
      sigaction sigprocmask)
  
  AC_CHECK_FUNCS(getpgrp tcgetpgrp)
 --- old/flist.c
 +++ new/flist.c
-@@ -48,6 +48,7 @@ extern int preserve_links;
+@@ -44,6 +44,7 @@ extern int preserve_links;
  extern int preserve_hard_links;
  extern int preserve_devices;
  extern int preserve_specials;
 +extern int preserve_flags;
  extern int preserve_uid;
  extern int preserve_gid;
  extern int relative_paths;
-@@ -311,6 +312,9 @@ static void send_file_entry(struct file_
+@@ -303,6 +304,9 @@ static void send_file_entry(struct file_
  	unsigned short flags;
  	static time_t modtime;
  	static mode_t mode;
 +#ifdef SUPPORT_FLAGS
 +	static uint32 fileflags;
 +#endif
  	static int64 dev;
  	static dev_t rdev;
  	static uint32 rdev_major;
-@@ -341,6 +345,12 @@ static void send_file_entry(struct file_
+@@ -333,6 +337,12 @@ static void send_file_entry(struct file_
  		flags |= XMIT_SAME_MODE;
  	else
  		mode = file->mode;
 +#ifdef SUPPORT_FLAGS
 + 	if (file->fileflags == fileflags)
 +		flags |= XMIT_SAME_FLAGS;
 +	else
 +		fileflags = file->fileflags;
 +#endif
  	if ((preserve_devices && IS_DEVICE(mode))
  	 || (preserve_specials && IS_SPECIAL(mode))) {
  		if (protocol_version < 28) {
-@@ -424,6 +434,10 @@ static void send_file_entry(struct file_
+@@ -416,6 +426,10 @@ static void send_file_entry(struct file_
  		write_int(f, modtime);
  	if (!(flags & XMIT_SAME_MODE))
  		write_int(f, to_wire_mode(mode));
 +#ifdef SUPPORT_FLAGS
 + 	if (preserve_flags && !(flags & XMIT_SAME_FLAGS))
 +		write_int(f, (int)fileflags);
 +#endif
  	if (preserve_uid && !(flags & XMIT_SAME_UID)) {
  		if (!numeric_ids)
  			add_uid(uid);
-@@ -491,6 +505,9 @@ static struct file_struct *receive_file_
+@@ -483,6 +497,9 @@ static struct file_struct *receive_file_
  {
  	static time_t modtime;
  	static mode_t mode;
 +#ifdef SUPPORT_FLAGS
 + 	static uint32 fileflags;
 +#endif
  	static int64 dev;
  	static dev_t rdev;
  	static uint32 rdev_major;
-@@ -564,9 +581,12 @@ static struct file_struct *receive_file_
+@@ -556,9 +573,12 @@ static struct file_struct *receive_file_
  		modtime = (time_t)read_int(f);
  	if (!(flags & XMIT_SAME_MODE))
  		mode = from_wire_mode(read_int(f));
 -
  	if (chmod_modes && !S_ISLNK(mode))
  		mode = tweak_mode(mode, chmod_modes);
@@ -79,123 +84,199 @@
 + 	if (preserve_flags && !(flags & XMIT_SAME_FLAGS))
 +		fileflags = (uint32)read_int(f);
 +#endif
  
  	if (preserve_uid && !(flags & XMIT_SAME_UID))
  		uid = (uid_t)read_int(f);
-@@ -617,6 +637,9 @@ static struct file_struct *receive_file_
+@@ -609,6 +629,9 @@ static struct file_struct *receive_file_
  	file->modtime = modtime;
  	file->length = file_length;
  	file->mode = mode;
 +#ifdef SUPPORT_FLAGS
 +	file->fileflags = fileflags;
 +#endif
  	file->uid = uid;
  	file->gid = gid;
  
-@@ -869,6 +892,9 @@ struct file_struct *make_file(char *fnam
+@@ -862,6 +885,9 @@ struct file_struct *make_file(char *fnam
  	file->modtime = st.st_mtime;
  	file->length = st.st_size;
  	file->mode = st.st_mode;
 +#ifdef SUPPORT_FLAGS
 +	file->fileflags = st.st_flags;
 +#endif
  	file->uid = st.st_uid;
  	file->gid = st.st_gid;
  
 --- old/generator.c
 +++ new/generator.c
-@@ -124,6 +124,9 @@ static int delete_item(char *fname, int 
+@@ -99,6 +99,12 @@ static int deletion_count = 0; /* used t
+ #define DEL_FORCE_RECURSE	(1<<1) /* recurse even w/o --force */
+ #define DEL_TERSE		(1<<3)
+ 
++#ifdef SUPPORT_FLAGS
++#define FILEFLAGS(ff) ff
++#else
++#define FILEFLAGS(ff) 0
++#endif
++
+ 
+ static int is_backup_file(char *fn)
+ {
+@@ -113,7 +119,7 @@ static int is_backup_file(char *fn)
+  * Note that fname must point to a MAXPATHLEN buffer if the mode indicates it's
+  * a directory! (The buffer is used for recursion, but returned unchanged.)
+  */
+-static int delete_item(char *fname, int mode, int flags)
++static int delete_item(char *fname, int mode, uint32 fileflags, int flags)
+ {
+ 	struct file_list *dirlist;
+ 	int j, dlen, zap_dir, ok;
+@@ -124,6 +130,9 @@ static int delete_item(char *fname, int 
  	if (!S_ISDIR(mode)) {
  		if (max_delete && ++deletion_count > max_delete)
  			return 0;
 +#ifdef SUPPORT_FLAGS
-+		make_mutable(fname);
++		make_mutable(fname, mode, fileflags);
 +#endif
  		if (make_backups && (backup_dir || !is_backup_file(fname)))
  			ok = make_backup(fname);
  		else
-@@ -148,10 +151,17 @@ static int delete_item(char *fname, int 
+@@ -148,10 +157,17 @@ static int delete_item(char *fname, int 
  		ok = 0;
  		errno = ENOTEMPTY;
  	} else if (make_backups && !backup_dir && !is_backup_file(fname)
 -	    && !(flags & DEL_FORCE_RECURSE))
 +	    && !(flags & DEL_FORCE_RECURSE)) {
 +#ifdef SUPPORT_FLAGS
-+		make_mutable(fname);
++		make_mutable(fname, mode, fileflags);
 +#endif
  		ok = make_backup(fname);
 -	else
 +	} else {
 +#ifdef SUPPORT_FLAGS
-+		make_mutable(fname);
++		make_mutable(fname, mode, fileflags);
 +#endif
  		ok = do_rmdir(fname) == 0;
 +	}
  	if (ok) {
  		if (!(flags & DEL_TERSE))
  			log_delete(fname, mode);
+@@ -186,7 +202,7 @@ static int delete_item(char *fname, int 
+ 			continue;
+ 
+ 		strlcpy(p, fp->basename, remainder);
+-		delete_item(fname, fp->mode, flags & ~DEL_TERSE);
++		delete_item(fname, fp->mode, FILEFLAGS(fp->fileflags), flags & ~DEL_TERSE);
+ 	}
+ 	flist_free(dirlist);
+ 
+@@ -276,7 +292,7 @@ static void delete_in_dir(struct file_li
+ 			continue;
+ 		if (flist_find(flist, fp) < 0) {
+ 			f_name(fp, delbuf);
+-			delete_item(delbuf, fp->mode, DEL_FORCE_RECURSE);
++			delete_item(delbuf, fp->mode, FILEFLAGS(fp->fileflags), DEL_FORCE_RECURSE);
+ 		}
+ 	}
+ 
+@@ -905,7 +921,7 @@ static void recv_generator(char *fname, 
+ 		 * we need to delete it.  If it doesn't exist, then
+ 		 * (perhaps recursively) create it. */
+ 		if (statret == 0 && !S_ISDIR(st.st_mode)) {
+-			if (delete_item(fname, st.st_mode, del_opts) < 0)
++			if (delete_item(fname, st.st_mode, FILEFLAGS(st.st_flags), del_opts) < 0)
+ 				return;
+ 			statret = -1;
+ 		}
+@@ -996,7 +1012,7 @@ static void recv_generator(char *fname, 
+ 			}
+ 			/* Not the right symlink (or not a symlink), so
+ 			 * delete it. */
+-			if (delete_item(fname, st.st_mode, del_opts) < 0)
++			if (delete_item(fname, st.st_mode, FILEFLAGS(st.st_flags), del_opts) < 0)
+ 				return;
+ 			if (!S_ISLNK(st.st_mode))
+ 				statret = -1;
+@@ -1063,7 +1079,7 @@ static void recv_generator(char *fname, 
+ 		 || (st.st_mode & ~CHMOD_BITS) != (file->mode & ~CHMOD_BITS)
+ 		 || st.st_rdev != file->u.rdev) {
+ 			if (statret == 0
+-			 && delete_item(fname, st.st_mode, del_opts) < 0)
++			 && delete_item(fname, st.st_mode, FILEFLAGS(st.st_flags), del_opts) < 0)
+ 				return;
+ 			if (preserve_hard_links && file->link_u.links
+ 			    && hard_link_check(file, ndx, fname, -1, &st,
+@@ -1148,7 +1164,7 @@ static void recv_generator(char *fname, 
+ 	fnamecmp_type = FNAMECMP_FNAME;
+ 
+ 	if (statret == 0 && !S_ISREG(st.st_mode)) {
+-		if (delete_item(fname, st.st_mode, del_opts) != 0)
++		if (delete_item(fname, st.st_mode, FILEFLAGS(st.st_flags), del_opts) != 0)
+ 			return;
+ 		statret = -1;
+ 		stat_errno = ENOENT;
 --- old/options.c
 +++ new/options.c
-@@ -46,6 +46,7 @@ int copy_links = 0;
+@@ -48,6 +48,7 @@ int copy_links = 0;
  int preserve_links = 0;
  int preserve_hard_links = 0;
  int preserve_perms = 0;
 +int preserve_flags = 0;
  int preserve_executability = 0;
  int preserve_devices = 0;
  int preserve_specials = 0;
-@@ -194,6 +195,7 @@ static void print_rsync_version(enum log
+@@ -201,6 +202,7 @@ static void print_rsync_version(enum log
  	char const *hardlinks = "no ";
  	char const *links = "no ";
  	char const *ipv6 = "no ";
 + 	char const *flags = "no ";
  	STRUCT_STAT *dumstat;
  
  #ifdef HAVE_SOCKETPAIR
-@@ -216,6 +218,10 @@ static void print_rsync_version(enum log
+@@ -223,6 +225,10 @@ static void print_rsync_version(enum log
  	ipv6 = "";
  #endif
  
 +#ifdef SUPPORT_FLAGS
 +	flags = "";
 +#endif
 +
  	rprintf(f, "%s  version %s  protocol version %d\n",
  		RSYNC_NAME, RSYNC_VERSION, PROTOCOL_VERSION);
  	rprintf(f, "Copyright (C) 1996-2006 by Andrew Tridgell, Wayne Davison, and others.\n");
-@@ -228,9 +234,9 @@ static void print_rsync_version(enum log
+@@ -235,9 +241,9 @@ static void print_rsync_version(enum log
  	/* Note that this field may not have type ino_t.  It depends
  	 * on the complicated interaction between largefile feature
  	 * macros. */
 -	rprintf(f, "              %sinplace, %sIPv6, "
 +	rprintf(f, "              %sinplace, %sIPv6, %sfile flags, "
  		"%d-bit system inums, %d-bit internal inums\n",
 -		have_inplace, ipv6,
 +		have_inplace, ipv6, flags,
  		(int) (sizeof dumstat->st_ino * 8),
  		(int) (sizeof (int64) * 8));
  #ifdef MAINTAINER_MODE
-@@ -292,6 +298,7 @@ void usage(enum logcode F)
+@@ -304,6 +310,7 @@ void usage(enum logcode F)
    rprintf(F," -K, --keep-dirlinks         treat symlinked dir on receiver as dir\n");
    rprintf(F," -H, --hard-links            preserve hard links\n");
    rprintf(F," -p, --perms                 preserve permissions\n");
 +  rprintf(F,"     --flags                 preserve file flags\n");
    rprintf(F," -E, --executability         preserve the file's executability\n");
-   rprintf(F,"     --chmod=CHMOD           change destination permissions\n");
+   rprintf(F,"     --chmod=CHMOD           affect file and/or directory permissions\n");
    rprintf(F," -o, --owner                 preserve owner (super-user only)\n");
-@@ -407,6 +414,8 @@ static struct poptOption long_options[] 
+@@ -424,6 +431,8 @@ static struct poptOption long_options[] 
    {"perms",           'p', POPT_ARG_VAL,    &preserve_perms, 1, 0, 0 },
    {"no-perms",         0,  POPT_ARG_VAL,    &preserve_perms, 0, 0, 0 },
    {"no-p",             0,  POPT_ARG_VAL,    &preserve_perms, 0, 0, 0 },
 +  {"flags",            0,  POPT_ARG_VAL,    &preserve_flags, 1, 0, 0 },
 +  {"no-flags",         0,  POPT_ARG_VAL,    &preserve_flags, 0, 0, 0 },
    {"executability",   'E', POPT_ARG_NONE,   &preserve_executability, 0, 0, 0 },
    {"times",           't', POPT_ARG_VAL,    &preserve_times, 1, 0, 0 },
    {"no-times",         0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
-@@ -1105,6 +1114,15 @@ int parse_arguments(int *argc, const cha
+@@ -1128,6 +1137,15 @@ int parse_arguments(int *argc, const cha
  	}
  #endif
  
 +#ifndef SUPPORT_FLAGS
 +	if (preserve_flags) {
 +		snprintf(err_buf, sizeof err_buf,
@@ -205,160 +286,184 @@
 +	}
 +#endif
 +
  	if (write_batch && read_batch) {
  		snprintf(err_buf, sizeof err_buf,
  			"--write-batch and --read-batch can not be used together\n");
-@@ -1559,6 +1577,9 @@ void server_options(char **args,int *arg
+@@ -1581,6 +1599,9 @@ void server_options(char **args,int *arg
  	if (xfer_dirs && !recurse && delete_mode && am_sender)
  		args[ac++] = "--no-r";
  
 +	if (preserve_flags)
 +		args[ac++] = "--flags";
 +
  	if (do_compression && def_compress_level != Z_DEFAULT_COMPRESSION) {
  		if (asprintf(&arg, "--compress-level=%d", def_compress_level) < 0)
  			goto oom;
 --- old/rsync.c
 +++ new/rsync.c
-@@ -34,6 +34,7 @@ extern int verbose;
+@@ -30,9 +30,12 @@
+ #include <langinfo.h>
+ #endif
+ 
++#define NOCHANGE_FLAGS (UF_IMMUTABLE|UF_APPEND|UF_NOUNLINK|SF_IMMUTABLE|SF_APPEND|SF_NOUNLINK)
++
+ extern int verbose;
  extern int dry_run;
- extern int daemon_log_format_has_i;
  extern int preserve_perms;
 +extern int preserve_flags;
  extern int preserve_executability;
  extern int preserve_times;
  extern int omit_dir_times;
-@@ -217,6 +218,19 @@ int set_file_attrs(char *fname, struct f
+@@ -123,6 +126,41 @@ mode_t dest_mode(mode_t flist_mode, mode
+ 	return new_mode;
+ }
+ 
++#ifdef SUPPORT_FLAGS
++/* Set a file's st_flags. */
++static int set_fileflags(const char *fname, uint32 fileflags)
++{
++	if (do_chflags(fname, fileflags) != 0) {
++		rsyserr(FERROR, errno,
++			"failed to set file flags on %s",
++			full_fname(fname));
++		return 0;
++	}
++
++	return 1;
++}
++
++/* Remove immutable flags from an object, so it can be altered/removed. */
++void make_mutable(char *fname, mode_t mode, uint32 fileflags)
++{
++	if (!preserve_flags && S_ISLNK(mode))
++		return;
++
++	if (fileflags & NOCHANGE_FLAGS)
++		set_fileflags(fname, fileflags & ~NOCHANGE_FLAGS);
++}
++
++/* Undo a prior make_mutable() call. */
++void undo_make_mutable(char *fname, mode_t mode, uint32 fileflags)
++{
++	if (!preserve_flags && S_ISLNK(mode))
++		return;
++
++	if (fileflags & NOCHANGE_FLAGS)
++		set_fileflags(fname, fileflags);
++}
++#endif
++
+ int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
+ 		   int flags)
+ {
+@@ -221,6 +259,15 @@ int set_file_attrs(char *fname, struct f
  	}
  #endif
  
 +#ifdef SUPPORT_FLAGS
 +	if (preserve_flags && !S_ISLNK(st->st_mode)
 +	 && st->st_flags != file->fileflags) {
-+		if (do_chflags(fname, file->fileflags) != 0) {
-+			rsyserr(FERROR, errno,
-+				"failed to set file flags on %s",
-+				full_fname(fname));
++		if (!set_fileflags(fname, file->fileflags))
 +			return 0;
-+		}
 +		updated = 1;
 +	}
 +#endif
 +
  	if (verbose > 1 && flags & ATTRS_REPORT) {
- 		enum logcode code = daemon_log_format_has_i || dry_run
- 				  ? FCLIENT : FINFO;
-@@ -252,6 +266,10 @@ void finish_transfer(char *fname, char *
- {
- 	int ret;
+ 		if (updated)
+ 			rprintf(FCLIENT, "%s\n", fname);
+@@ -268,6 +315,9 @@ void finish_transfer(char *fname, char *
+ 	set_file_attrs(fnametmp, file, NULL,
+ 		       ok_to_set_time ? 0 : ATTRS_SKIP_MTIME);
  
 +#ifdef SUPPORT_FLAGS
-+	make_mutable(fname); /* XXX */
-+#endif
-+
- 	if (inplace) {
- 		if (verbose > 2)
- 			rprintf(FINFO, "finishing %s\n", fname);
-@@ -305,3 +323,27 @@ const char *who_am_i(void)
- 		return am_server ? "server" : "client";
- 	return am_sender ? "sender" : am_generator ? "generator" : "receiver";
- }
-+
++	make_mutable(fnametmp, file->mode, file->fileflags);
++#endif
+ 	/* move tmp file over real file */
+ 	if (verbose > 2)
+ 		rprintf(FINFO, "renaming %s to %s\n", fnametmp, fname);
+@@ -282,6 +332,9 @@ void finish_transfer(char *fname, char *
+ 	}
+ 	if (ret == 0) {
+ 		/* The file was moved into place (not copied), so it's done. */
 +#ifdef SUPPORT_FLAGS
-+/* remove immutable flags from an object, so it can be altered/removed. */
-+void make_mutable(char *fname)
-+{
-+#define NOCHANGEBITS    (UF_IMMUTABLE | UF_APPEND | UF_NOUNLINK | SF_IMMUTABLE | SF_APPEND | SF_NOUNLINK)
-+	STRUCT_STAT stb;
-+	int failed;
-+
-+	if (dry_run)
-+		return;
-+
-+	/* XXX get rid of this extra stat() */
-+#ifdef SUPPORT_LINKS
-+	failed = do_lstat(fname, &stb);
-+#else
-+	failed = do_stat(fname, &stb);
-+#endif
-+	if (failed)
-+		return;
-+	if (stb.st_flags & NOCHANGEBITS)
-+		do_chflags(fname, stb.st_flags & ~NOCHANGEBITS);
-+}
++		undo_make_mutable(fname, file->mode, file->fileflags);
 +#endif
+ 		return;
+ 	}
+ 	/* The file was copied, so tweak the perms of the copied file.  If it
 --- old/rsync.h
 +++ new/rsync.h
 @@ -54,6 +54,7 @@
  #define XMIT_HAS_IDEV_DATA (1<<9)
  #define XMIT_SAME_DEV (1<<10)
  #define XMIT_RDEV_MINOR_IS_SMALL (1<<11)
 +#define XMIT_SAME_FLAGS (1<<12)
  
  /* These flags are used in the live flist data. */
  
-@@ -337,6 +338,10 @@ enum msgcode {
+@@ -344,6 +345,10 @@ enum msgcode {
  #define schar char
  #endif
  
 +#ifdef HAVE_CHFLAGS
 +#define SUPPORT_FLAGS 1
 +#endif
 +
  /* Find a variable that is either exactly 32-bits or longer.
   * If some code depends on 32-bit truncation, it will need to
   * take special action in a "#if SIZEOF_INT32 > 4" section. */
-@@ -519,6 +524,9 @@ struct file_struct {
+@@ -527,6 +532,9 @@ struct file_struct {
  		struct hlink *links;
  	} link_u;
  	time_t modtime;
 +#ifdef SUPPORT_FLAGS
 +	uint32 fileflags;
 +#endif
  	uid_t uid;
  	gid_t gid;
  	mode_t mode;
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -322,6 +322,7 @@ to the detailed description below for a 
+@@ -321,6 +321,7 @@ to the detailed description below for a 
+  -K, --keep-dirlinks         treat symlinked dir on receiver as dir
+  -H, --hard-links            preserve hard links
   -p, --perms                 preserve permissions
-  -E, --executability         preserve executability
-      --chmod=CHMOD           change destination permissions
 +     --flags                 preserve file flags
+  -E, --executability         preserve executability
+      --chmod=CHMOD           affect file and/or directory permissions
   -o, --owner                 preserve owner (super-user only)
-  -g, --group                 preserve group
-      --devices               preserve device files (super-user only)
-@@ -498,7 +499,9 @@ specified, in which case bf(-r) is not i
+@@ -509,7 +510,9 @@ specified, in which case bf(-r) is not i
  
  Note that bf(-a) bf(does not preserve hardlinks), because
  finding multiply-linked files is expensive.  You must separately
 -specify bf(-H).
 +specify bf(-H).  Note also that for compatibility, bf(-a)
 +currently bf(does not include --flags) (see there) to include preserving
 +change file flags (if supported by the OS).
  
  dit(--no-OPTION) You may turn off one or more implied options by prefixing
  the option name with "no-".  Not all options may be prefixed with a "no-":
-@@ -793,6 +796,13 @@ quote(itemize(
+@@ -804,6 +807,13 @@ quote(itemization(
  
  If bf(--perms) is enabled, this option is ignored.
  
 +dit(bf(--flags)) This option causes rsync to update the change file flags
-+to be the same as the source file, if your OS supports the chflags(2)
++to be the same as the source file, if your OS supports the bf(chflags)(2)
 +system call.  In any case, an attempt is made to remove flags that would
 +prevent a file to be altered.  Some flags can only be altered by the
 +super-user and can only be unset below a certain secure-level (usually
 +single-user mode).
 +
  dit(bf(--chmod)) This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
  transfer.  The resulting value is treated as though it was the permissions
 --- old/syscall.c
 +++ new/syscall.c
-@@ -155,6 +155,15 @@ int do_chmod(const char *path, mode_t mo
+@@ -152,6 +152,15 @@ int do_chmod(const char *path, mode_t mo
  }
  #endif
  
 +#ifdef SUPPORT_FLAGS
 +int do_chflags(const char *path, u_long flags)
 +{
@@ -370,31 +475,32 @@
 +
  int do_rename(const char *fname1, const char *fname2)
  {
  	if (dry_run) return 0;
 --- old/proto.h
 +++ new/proto.h
-@@ -231,6 +231,7 @@ void finish_transfer(char *fname, char *
- 		     struct file_struct *file, int ok_to_set_time,
- 		     int overwriting_basis);
- const char *who_am_i(void);
-+void make_mutable(char *fname);
- void successful_send(int ndx);
- int read_item_attrs(int f_in, int f_out, int ndx, uchar *type_ptr,
- 		    char *buf, int *len_ptr);
-@@ -254,6 +255,7 @@ int do_mknod(char *pathname, mode_t mode
+@@ -224,6 +224,8 @@ int recv_files(int f_in, struct file_lis
+ void setup_iconv();
+ void free_sums(struct sum_struct *s);
+ mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int exists);
++void make_mutable(char *fname, mode_t mode, uint32 fileflags);
++void undo_make_mutable(char *fname, mode_t mode, uint32 fileflags);
+ int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
+ 		   int flags);
+ RETSIGTYPE sig_int(UNUSED(int val));
+@@ -254,6 +256,7 @@ int do_mknod(char *pathname, mode_t mode
  int do_rmdir(const char *pathname);
  int do_open(const char *pathname, int flags, mode_t mode);
  int do_chmod(const char *path, mode_t mode);
 +int do_chflags(const char *path, u_long flags);
  int do_rename(const char *fname1, const char *fname2);
  void trim_trailing_slashes(char *name);
  int do_mkdir(char *fname, mode_t mode);
 --- old/configure
 +++ new/configure
-@@ -10963,12 +10963,13 @@ fi
+@@ -13474,12 +13474,13 @@ fi
  
  
  
 +
  for ac_func in waitpid wait4 getcwd strdup chown chmod lchmod mknod mkfifo \
      fchmod fstat ftruncate strchr readlink link utime utimes lutimes strftime \
@@ -417,40 +523,40 @@
 +
  /* Define to 1 if you have the `chmod' function. */
  #undef HAVE_CHMOD
  
 --- old/rsync.1
 +++ new/rsync.1
-@@ -378,6 +378,7 @@ to the detailed description below for a 
-  -p, --perms                 preserve permissions
-  -E, --executability         preserve executability
-      --chmod=CHMOD           change destination permissions
-+     --flags                 preserve file flags
-  -o, --owner                 preserve owner (super-user only)
-  -g, --group                 preserve group
-      --devices               preserve device files (super-user only)
-@@ -571,7 +572,9 @@ specified, in which case \fB-r\fP is not
+@@ -387,6 +387,7 @@ to the detailed description below for a 
+  \-K, \-\-keep\-dirlinks         treat symlinked dir on receiver as dir
+  \-H, \-\-hard\-links            preserve hard links
+  \-p, \-\-perms                 preserve permissions
++     \-\-flags                 preserve file flags
+  \-E, \-\-executability         preserve executability
+      \-\-chmod=CHMOD           affect file and/or directory permissions
+  \-o, \-\-owner                 preserve owner (super-user only)
+@@ -591,7 +592,9 @@ specified, in which case \fB\-r\fP is no
  .IP 
- Note that \fB-a\fP \fBdoes not preserve hardlinks\fP, because
+ Note that \fB\-a\fP \fBdoes not preserve hardlinks\fP, because
  finding multiply-linked files is expensive\&.  You must separately
--specify \fB-H\fP\&.
-+specify \fB-H\fP\&.  Note also that for compatibility, \fB-a\fP
-+currently \fBdoes not include --flags\fP (see there) to include preserving
+-specify \fB\-H\fP\&.
++specify \fB\-H\fP\&.  Note also that for compatibility, \fB\-a\fP
++currently \fBdoes not include \-\-flags\fP (see there) to include preserving
 +change file flags (if supported by the OS)\&.
  .IP 
- .IP "--no-OPTION" 
+ .IP "\-\-no\-OPTION"
  You may turn off one or more implied options by prefixing
-@@ -903,6 +906,14 @@ has a corresponding \&'r\&' permission e
+@@ -932,6 +935,14 @@ has a corresponding \&'r\&' permission e
  .IP 
- If \fB--perms\fP is enabled, this option is ignored\&.
+ If \fB\-\-perms\fP is enabled, this option is ignored\&.
  .IP 
-+.IP "\fB--flags\fP" 
++.IP "\fB\-\-flags\fP"
 +This option causes rsync to update the change file flags
-+to be the same as the source file, if your OS supports the chflags(2)
++to be the same as the source file, if your OS supports the \fBchflags\fP(2)
 +system call\&.  In any case, an attempt is made to remove flags that would
 +prevent a file to be altered\&.  Some flags can only be altered by the
 +super-user and can only be unset below a certain secure-level (usually
 +single-user mode)\&.
 +.IP 
- .IP "\fB--chmod\fP" 
+ .IP "\fB\-\-chmod\fP"
  This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/fsync.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/fsync.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/fsync.diff	2006-04-22 23:52:20.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/fsync.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,56 +1,62 @@
 This patch from Sami Farin lets you specify --fsync if you want fsync()
 to be called on every file we write.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/fsync.diff
+    ./configure                         (optional if already run)
+    make
+
 --- old/options.c
 +++ new/options.c
-@@ -43,6 +43,7 @@ int append_mode = 0;
+@@ -45,6 +45,7 @@ int append_mode = 0;
  int keep_dirlinks = 0;
  int copy_dirlinks = 0;
  int copy_links = 0;
 +int do_fsync = 0;
  int preserve_links = 0;
  int preserve_hard_links = 0;
  int preserve_perms = 0;
-@@ -327,6 +328,7 @@ void usage(enum logcode F)
+@@ -339,6 +340,7 @@ void usage(enum logcode F)
    rprintf(F,"     --partial-dir=DIR       put a partially transferred file into DIR\n");
    rprintf(F,"     --delay-updates         put all updated files into place at transfer's end\n");
    rprintf(F," -m, --prune-empty-dirs      prune empty directory chains from the file-list\n");
 +  rprintf(F,"     --fsync                 fsync every written file\n");
    rprintf(F,"     --numeric-ids           don't map uid/gid values by user/group name\n");
    rprintf(F,"     --timeout=TIME          set I/O timeout in seconds\n");
    rprintf(F," -I, --ignore-times          don't skip files that match in size and mod-time\n");
-@@ -504,6 +506,7 @@ static struct poptOption long_options[] 
+@@ -525,6 +527,7 @@ static struct poptOption long_options[] 
    {"only-write-batch", 0,  POPT_ARG_STRING, &batch_name, OPT_ONLY_WRITE_BATCH, 0, 0 },
    {"files-from",       0,  POPT_ARG_STRING, &files_from, 0, 0, 0 },
    {"from0",           '0', POPT_ARG_NONE,   &eol_nulls, 0, 0, 0},
 +  {"fsync",            0,  POPT_ARG_NONE,   &do_fsync, 0, 0, 0 },
    {"numeric-ids",      0,  POPT_ARG_NONE,   &numeric_ids, 0, 0, 0 },
    {"timeout",          0,  POPT_ARG_INT,    &io_timeout, 0, 0, 0 },
    {"rsh",             'e', POPT_ARG_STRING, &shell_cmd, 0, 0, 0 },
-@@ -1704,6 +1707,9 @@ void server_options(char **args,int *arg
+@@ -1727,6 +1730,9 @@ void server_options(char **args,int *arg
  		args[ac++] = tmpdir;
  	}
  
 +	if (do_fsync && am_sender)
 +		args[ac++] = "--fsync";
 +
  	if (basis_dir[0] && am_sender) {
  		/* the server only needs this option if it is not the sender,
  		 *   and it may be an older version that doesn't know this
 --- old/receiver.c
 +++ new/receiver.c
-@@ -36,6 +36,7 @@ extern int protocol_version;
+@@ -37,6 +37,7 @@ extern int protocol_version;
  extern int relative_paths;
  extern int preserve_hard_links;
  extern int preserve_perms;
 +extern int do_fsync;
  extern int basis_dir_cnt;
  extern int make_backups;
  extern int cleanup_got_literal;
-@@ -252,6 +253,12 @@ static int receive_data(int f_in, char *
+@@ -258,6 +259,12 @@ static int receive_data(int f_in, char *
  		exit_cleanup(RERR_FILEIO);
  	}
  
 +	if (do_fsync && fd != -1 && fsync(fd) != 0) {
 +		rsyserr(FERROR, errno, "fsync failed on %s",
 +			full_fname(fname));
@@ -59,31 +65,31 @@
 +
  	sum_end(file_sum1);
  
  	if (mapbuf)
 --- old/t_stub.c
 +++ new/t_stub.c
-@@ -26,6 +26,7 @@
-  * functions, so that module test harnesses can run standalone.
-  **/
+@@ -22,6 +22,7 @@
+ 
+ #include "rsync.h"
  
 +int do_fsync = 0;
  int modify_window = 0;
  int module_id = -1;
  int relative_paths = 0;
 --- old/util.c
 +++ new/util.c
-@@ -30,6 +30,7 @@
+@@ -26,6 +26,7 @@
  extern int verbose;
  extern int dry_run;
  extern int module_id;
 +extern int do_fsync;
  extern int modify_window;
  extern int relative_paths;
  extern int human_readable;
-@@ -319,6 +320,12 @@ int copy_file(const char *source, const 
+@@ -314,6 +315,12 @@ int copy_file(const char *source, const 
  		return -1;
  	}
  
 +	if (do_fsync && fsync(ofd) < 0) {
 +		rsyserr(FERROR, errno, "fsync failed on %s",
 +			full_fname(dest));
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/gzip-rsyncable-checksum.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/gzip-rsyncable-checksum.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/gzip-rsyncable-checksum.diff	2006-02-06 14:24:29.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/gzip-rsyncable-checksum.diff	2006-02-06 14:24:29.000000000 +0800
@@ -1,551 +1,551 @@
-NOTE: this patch is for _gzip_!
-
-Kevin Day's version of the gzip-rsyncable patch that uses the rsync
-checksum algorithm.
-
---- gzip-1.2.2/deflate.c	2004-09-15 10:28:14.000000000 -0700
-+++ rsyncable/deflate.c	2005-02-17 14:37:14.660957200 -0700
-@@ -98,6 +98,10 @@
-                             int length));
- #endif
- 
-+local void rsync_roll(deflate_state *s, unsigned start, unsigned num);
-+local void rsync_roll_noop(deflate_state *s, unsigned start, unsigned num);
-+local void rsync_roll2(deflate_state *s, unsigned start, unsigned num);
-+
- /* ===========================================================================
-  * Local data
-  */
-@@ -115,6 +119,39 @@
-  * See deflate.c for comments about the MIN_MATCH+1.
-  */
- 
-+
-+
-+/* 
-+	Valid values for RSYNC_DEFAULT_CHECKSUM_TYPE are:
-+
-+	Z_RSYNCABLE_OFF
-+	Z_RSYNCABLE_SIMPLESUM
-+	Z_RSYNCABLE_RSSUM
-+*/
-+
-+#ifndef RSYNC_DEFAULT_CHECKSUM_TYPE
-+#	define RSYNC_DEFAULT_CHECKSUM_TYPE Z_RSYNCABLE_RSSUM
-+#endif
-+
-+#ifndef RSYNC_DEFAULT_WINDOW_SIZE
-+#	define RSYNC_DEFAULT_WINDOW_SIZE 30
-+#endif
-+
-+#ifndef RSYNC_DEFAULT_RESET_BLOCK_SIZE
-+#	define RSYNC_DEFAULT_RESET_BLOCK_SIZE 4096 
-+#endif
-+
-+#ifndef RSYNC_RESET_MAGIC_VALUE
-+#	define RSYNC_RESET_MAGIC_VALUE 0
-+#endif
-+
-+#define RSYNC_SUM_MATCH(s) ((s)->rsync_sum % (s)->rsync_reset_block_size == RSYNC_RESET_MAGIC_VALUE)
-+/* Whether window sum matches magic value */
-+
-+/* Global rsync mode control variable */
-+int zlib_rsync = 1 ;
-+
-+
- /* Values for max_lazy_match, good_match and max_chain_length, depending on
-  * the desired pack level (0..9). The values given below have been tuned to
-  * exclude worst case performance for pathological files. Better values may be
-@@ -212,6 +249,36 @@
-     /* To do: ignore strm->next_in if we use it as window */
- }
- 
-+int ZEXPORT deflateSetRsyncParameters_(strm, checksum_type, window_size, reset_block_size)
-+    z_streamp strm;
-+    int  checksum_type;
-+	ulg window_size;
-+	ulg reset_block_size;
-+{
-+	deflate_state *s = strm->state;
-+
-+	switch(checksum_type){
-+		case Z_RSYNCABLE_SIMPLESUM: 
-+			s->rsync_rollfunction = rsync_roll; 
-+			break;
-+		case Z_RSYNCABLE_RSSUM: 
-+			s->rsync_rollfunction = rsync_roll2; 
-+			break;
-+		default: 
-+			s->rsync_rollfunction = rsync_roll_noop;
-+	}
-+
-+	s->rsync_window_size = window_size != 0 ? window_size : RSYNC_DEFAULT_WINDOW_SIZE;
-+	s->rsync_reset_block_size = reset_block_size != 0 ? reset_block_size : s->rsync_window_size;
-+
-+    s->rsync_chunk_end = 0xFFFFFFFFUL;
-+    s->rsync_sum = 0;
-+	s->rsync_s1 = 0;
-+	s->rsync_s2 = 0;
-+
-+	return Z_OK;
-+}
-+
- /* ========================================================================= */
- int ZEXPORT deflateInit2_(strm, level, method, windowBits, memLevel, strategy,
-                   version, stream_size)
-@@ -307,9 +374,13 @@
-     s->strategy = strategy;
-     s->method = (Byte)method;
- 
-+	deflateSetRsyncParameters_(strm, RSYNC_DEFAULT_CHECKSUM_TYPE, RSYNC_DEFAULT_WINDOW_SIZE, RSYNC_DEFAULT_RESET_BLOCK_SIZE);
-+
-     return deflateReset(strm);
- }
- 
-+
-+
- /* ========================================================================= */
- int ZEXPORT deflateSetDictionary (strm, dictionary, dictLength)
-     z_streamp strm;
-@@ -841,6 +912,13 @@
- #ifdef ASMV
-     match_init(); /* initialize the asm code */
- #endif
-+
-+    /* rsync params */
-+    s->rsync_chunk_end = 0xFFFFFFFFUL;
-+    s->rsync_sum = 0;
-+	s->rsync_s1 = 0;
-+	s->rsync_s2 = 0;
-+
- }
- 
- #ifndef FASTEST
-@@ -1123,6 +1201,8 @@
-             zmemcpy(s->window, s->window+wsize, (unsigned)wsize);
-             s->match_start -= wsize;
-             s->strstart    -= wsize; /* we now have strstart >= MAX_DIST */
-+            if (s->rsync_chunk_end != 0xFFFFFFFFUL)
-+                s->rsync_chunk_end -= wsize;
-             s->block_start -= (long) wsize;
- 
-             /* Slide the hash table (could be avoided with 32 bit values
-@@ -1184,15 +1264,98 @@
-     } while (s->lookahead < MIN_LOOKAHEAD && s->strm->avail_in != 0);
- }
- 
-+local void rsync_roll(s, start, num)
-+    deflate_state *s;
-+    unsigned start;
-+    unsigned num;
-+{
-+    unsigned i;
-+
-+    if (start < s->rsync_window_size) {
-+	/* before window fills. */
-+	for (i = start; i < s->rsync_window_size; i++) {
-+	    if (i == start + num) return;
-+	    s->rsync_sum += (ulg)s->window[i];
-+	}
-+	num -= (s->rsync_window_size - start);
-+	start = s->rsync_window_size;
-+    }
-+
-+    /* buffer after window full */
-+    for (i = start; i < start+num; i++) {
-+	/* New character in */
-+	s->rsync_sum += (ulg)s->window[i];
-+	/* Old character out */
-+	s->rsync_sum -= (ulg)s->window[i - s->rsync_window_size];
-+	if (s->rsync_chunk_end == 0xFFFFFFFFUL
-+            && RSYNC_SUM_MATCH(s))
-+	    s->rsync_chunk_end = i;
-+    }
-+}
-+
-+local void rsync_roll_noop(s, start, num)
-+    deflate_state *s;
-+    unsigned start;
-+    unsigned num;
-+{
-+}
-+
-+/*
-+ Implements the 2 part rsync checksum, instead of a simple summation checksum.
-+*/
-+local void rsync_roll2(deflate_state *s, unsigned start, unsigned num)
-+{
-+    unsigned i;
-+
-+    if (start < s->rsync_window_size) {
-+		/* before window fills. */
-+		for (i = start; i < s->rsync_window_size; i++) {
-+			if (i == start + num) return;
-+			s->rsync_s1 = (s->rsync_s1 + (ulg)s->window[i]) & 0xffff;
-+			s->rsync_s2 = (s->rsync_s2 + s->rsync_s1) & 0xffff;
-+		}
-+		num -= (s->rsync_window_size - start);
-+		start = s->rsync_window_size;
-+    }
-+
-+    /* buffer after window full */
-+    for (i = start; i < start+num; i++) {
-+		/* Old character out */
-+
-+		s->rsync_s1 = (s->rsync_s1 - (ulg)s->window[i - s->rsync_window_size]) & 0xffff;
-+		s->rsync_s2 = (s->rsync_s2 - s->rsync_window_size * (ulg)s->window[i - s->rsync_window_size]) & 0xffff;
-+
-+		/* New character in */
-+		s->rsync_s1 = (s->rsync_s1 + (ulg)s->window[i]) & 0xffff;
-+		s->rsync_s2 = (s->rsync_s2 + s->rsync_s1) & 0xffff;
-+
-+		// add the two together for the match calculation
-+		s->rsync_sum = s->rsync_s1 + s->rsync_s2;
-+
-+
-+		if (s->rsync_chunk_end == 0xFFFFFFFFUL
-+			&& RSYNC_SUM_MATCH(s)){
-+			s->rsync_chunk_end = i;
-+		}
-+    }
-+}
-+
-+/* ===========================================================================
-+ * Set rsync_chunk_end if window sum matches magic value.
-+ */
-+#define RSYNC_ROLL(s, start, num) \
-+   do { if (zlib_rsync) (s)->rsync_rollfunction((s), (start), (num)); } while(0)
-+
- /* ===========================================================================
-  * Flush the current block, with given end-of-file flag.
-  * IN assertion: strstart is set to the end of the current match.
-  */
--#define FLUSH_BLOCK_ONLY(s, eof) { \
-+#define FLUSH_BLOCK_ONLY(s, eof, pad) { \
-    _tr_flush_block(s, (s->block_start >= 0L ? \
-                    (charf *)&s->window[(unsigned)s->block_start] : \
-                    (charf *)Z_NULL), \
-                 (ulg)((long)s->strstart - s->block_start), \
-+                (pad), \
-                 (eof)); \
-    s->block_start = s->strstart; \
-    flush_pending(s->strm); \
-@@ -1200,8 +1363,8 @@
- }
- 
- /* Same but force premature exit if necessary. */
--#define FLUSH_BLOCK(s, eof) { \
--   FLUSH_BLOCK_ONLY(s, eof); \
-+#define FLUSH_BLOCK(s, eof, pad) { \
-+   FLUSH_BLOCK_ONLY(s, eof, pad); \
-    if (s->strm->avail_out == 0) return (eof) ? finish_started : need_more; \
- }
- 
-@@ -1252,16 +1415,16 @@
-             /* strstart == 0 is possible when wraparound on 16-bit machine */
-             s->lookahead = (uInt)(s->strstart - max_start);
-             s->strstart = (uInt)max_start;
--            FLUSH_BLOCK(s, 0);
-+            FLUSH_BLOCK(s, 0, 0);
-         }
-         /* Flush if we may have to slide, otherwise block_start may become
-          * negative and the data will be gone:
-          */
-         if (s->strstart - (uInt)s->block_start >= MAX_DIST(s)) {
--            FLUSH_BLOCK(s, 0);
-+            FLUSH_BLOCK(s, 0, 0);
-         }
-     }
--    FLUSH_BLOCK(s, flush == Z_FINISH);
-+    FLUSH_BLOCK(s, flush == Z_FINISH, 0);
-     return flush == Z_FINISH ? finish_done : block_done;
- }
- 
-@@ -1330,6 +1493,7 @@
- 
-             s->lookahead -= s->match_length;
- 
-+            RSYNC_ROLL(s, s->strstart, s->match_length);
-             /* Insert new strings in the hash table only if the match length
-              * is not too large. This saves time but degrades compression.
-              */
-@@ -1363,12 +1527,17 @@
-             /* No match, output a literal byte */
-             Tracevv((stderr,"%c", s->window[s->strstart]));
-             _tr_tally_lit (s, s->window[s->strstart], bflush);
-+            RSYNC_ROLL(s, s->strstart, 1);
-             s->lookahead--;
-             s->strstart++;
-         }
--        if (bflush) FLUSH_BLOCK(s, 0);
-+	if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
-+	    s->rsync_chunk_end = 0xFFFFFFFFUL;
-+	    bflush = 2;
-+	}
-+        if (bflush) FLUSH_BLOCK(s, 0, bflush-1);
-     }
--    FLUSH_BLOCK(s, flush == Z_FINISH);
-+    FLUSH_BLOCK(s, flush == Z_FINISH, bflush-1);
-     return flush == Z_FINISH ? finish_done : block_done;
- }
- 
-@@ -1457,6 +1626,7 @@
-              */
-             s->lookahead -= s->prev_length-1;
-             s->prev_length -= 2;
-+            RSYNC_ROLL(s, s->strstart, s->prev_length+1);
-             do {
-                 if (++s->strstart <= max_insert) {
-                     INSERT_STRING(s, s->strstart, hash_head);
-@@ -1466,7 +1636,11 @@
-             s->match_length = MIN_MATCH-1;
-             s->strstart++;
- 
--            if (bflush) FLUSH_BLOCK(s, 0);
-+            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
-+                s->rsync_chunk_end = 0xFFFFFFFFUL;
-+                bflush = 2;
-+            } 
-+            if (bflush) FLUSH_BLOCK(s, 0, bflush-1);
- 
-         } else if (s->match_available) {
-             /* If there was no match at the previous position, output a
-@@ -1475,9 +1649,14 @@
-              */
-             Tracevv((stderr,"%c", s->window[s->strstart-1]));
-             _tr_tally_lit(s, s->window[s->strstart-1], bflush);
-+            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
-+                s->rsync_chunk_end = 0xFFFFFFFFUL;
-+		bflush = 2;
-+            } 
-             if (bflush) {
--                FLUSH_BLOCK_ONLY(s, 0);
-+                FLUSH_BLOCK_ONLY(s, 0, bflush-1);
-             }
-+            RSYNC_ROLL(s, s->strstart, 1);
-             s->strstart++;
-             s->lookahead--;
-             if (s->strm->avail_out == 0) return need_more;
-@@ -1485,7 +1664,14 @@
-             /* There is no previous match to compare with, wait for
-              * the next step to decide.
-              */
-+            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
-+                /* Reset huffman tree */
-+                s->rsync_chunk_end = 0xFFFFFFFFUL;
-+                bflush = 2;
-+                FLUSH_BLOCK(s, 0, bflush-1);
-+            } 
-             s->match_available = 1;
-+            RSYNC_ROLL(s, s->strstart, 1);
-             s->strstart++;
-             s->lookahead--;
-         }
-@@ -1496,7 +1682,7 @@
-         _tr_tally_lit(s, s->window[s->strstart-1], bflush);
-         s->match_available = 0;
-     }
--    FLUSH_BLOCK(s, flush == Z_FINISH);
-+    FLUSH_BLOCK(s, flush == Z_FINISH, bflush-1);
-     return flush == Z_FINISH ? finish_done : block_done;
- }
- #endif /* FASTEST */
---- gzip-1.2.2/deflate.h	2004-02-24 07:38:44.000000000 -0700
-+++ rsyncable/deflate.h	2005-02-17 13:46:12.056551200 -0700
-@@ -254,6 +254,17 @@
-      * are always zero.
-      */
- 
-+    ulg rsync_sum;      /* rolling sum of rsync window */
-+    ulg rsync_chunk_end; /* next rsync sequence point */
-+	ulg rsync_window_size; /* the number of bytes used in computing the rolling checksum */
-+	ulg rsync_reset_block_size; /* the compressed stream will be reset approximately every 'rsync_reset_block_size' bytes */
-+	ulg rsync_s1; /* part 1 of the checksum for use with checksum type Z_RSYNCABLE_RSSUM*/
-+	ulg rsync_s2; /* part 2 of the checksum for use with checksum type Z_RSYNCABLE_RSSUM*/
-+
-+	/* the function that should be called for performing the rsyncable checksum roll */
-+	void (*rsync_rollfunction)(struct internal_state*s , unsigned start, unsigned num);
-+
-+
- } FAR deflate_state;
- 
- /* Output a byte on the stream.
-@@ -276,7 +287,7 @@
- void _tr_init         OF((deflate_state *s));
- int  _tr_tally        OF((deflate_state *s, unsigned dist, unsigned lc));
- void _tr_flush_block  OF((deflate_state *s, charf *buf, ulg stored_len,
--                          int eof));
-+                          int pad, int eof));
- void _tr_align        OF((deflate_state *s));
- void _tr_stored_block OF((deflate_state *s, charf *buf, ulg stored_len,
-                           int eof));
---- gzip-1.2.2/minigzip.c	2003-11-04 18:19:26.000000000 -0700
-+++ rsyncable/minigzip.c	2005-02-17 13:11:35.472851600 -0700
-@@ -215,7 +215,7 @@
-     }
-     gz_compress(in, out);
- 
--    unlink(file);
-+    //unlink(file);
- }
- 
- 
-@@ -236,7 +236,10 @@
-     if (len > SUFFIX_LEN && strcmp(file+len-SUFFIX_LEN, GZ_SUFFIX) == 0) {
-         infile = file;
-         outfile = buf;
--        outfile[len-3] = '\0';
-+        outfile[len-3] = '.';
-+        outfile[len-2] = 'u';
-+        outfile[len-1] = 'z';
-+        outfile[len-0] = '\0';
-     } else {
-         outfile = file;
-         infile = buf;
-@@ -255,7 +258,7 @@
- 
-     gz_uncompress(in, out);
- 
--    unlink(infile);
-+    //unlink(infile);
- }
- 
- 
---- gzip-1.2.2/trees.c	2004-02-24 07:36:38.000000000 -0700
-+++ rsyncable/trees.c	2005-02-17 13:09:38.768435100 -0700
-@@ -918,10 +918,11 @@
-  * Determine the best encoding for the current block: dynamic trees, static
-  * trees or store, and output the encoded block to the zip file.
-  */
--void _tr_flush_block(s, buf, stored_len, eof)
-+void _tr_flush_block(s, buf, stored_len, pad, eof)
-     deflate_state *s;
-     charf *buf;       /* input block, or NULL if too old */
-     ulg stored_len;   /* length of input block */
-+    int pad;          /* pad output to byte boundary */
-     int eof;          /* true if this is the last block for a file */
- {
-     ulg opt_lenb, static_lenb; /* opt_len and static_len in bytes */
-@@ -1009,6 +1010,12 @@
- #ifdef DEBUG
-         s->compressed_len += 7;  /* align on byte boundary */
- #endif
-+#ifdef DEBUG
-+    } else if (pad && (s->compressed_len % 8) != 0) {
-+#else
-+    } else if (pad) {
-+#endif
-+        _tr_stored_block(s, buf, 0, eof);
-     }
-     Tracev((stderr,"\ncomprlen %lu(%lu) ", s->compressed_len>>3,
-            s->compressed_len-7*eof));
---- gzip-1.2.2/zlib.def	1969-12-31 17:00:00.000000000 -0700
-+++ rsyncable/zlib.def	2005-02-17 14:01:48.972258000 -0700
-@@ -0,0 +1,61 @@
-+LIBRARY
-+; zlib data compression library
-+
-+EXPORTS
-+; basic functions
-+    zlibVersion
-+    deflate
-+    deflateEnd
-+    inflate
-+    inflateEnd
-+; advanced functions
-+    deflateSetDictionary
-+    deflateCopy
-+    deflateReset
-+    deflateParams
-+    deflateBound
-+    deflatePrime
-+    inflateSetDictionary
-+    inflateSync
-+    inflateCopy
-+    inflateReset
-+    inflateBack
-+    inflateBackEnd
-+    zlibCompileFlags
-+; utility functions
-+    compress
-+    compress2
-+    compressBound
-+    uncompress
-+    gzopen
-+    gzdopen
-+    gzsetparams
-+    gzread
-+    gzwrite
-+    gzprintf
-+    gzputs
-+    gzgets
-+    gzputc
-+    gzgetc
-+    gzungetc
-+    gzflush
-+    gzseek
-+    gzrewind
-+    gztell
-+    gzeof
-+    gzclose
-+    gzerror
-+    gzclearerr
-+; checksum functions
-+    adler32
-+    crc32
-+; various hacks, don't look :)
-+    deflateInit_
-+    deflateInit2_
-+    inflateInit_
-+    inflateInit2_
-+    inflateBackInit_
-+    inflateSyncPoint
-+    get_crc_table
-+    zError
-+	deflateSetRsyncParameters_
-\ No newline at end of file
---- gzip-1.2.2/zlib.h	2004-10-03 22:57:26.000000000 -0700
-+++ rsyncable/zlib.h	2005-02-17 14:02:11.753362200 -0700
-@@ -179,6 +179,13 @@
- 
- #define Z_NULL  0  /* for initializing zalloc, zfree, opaque */
- 
-+
-+/* Constants used for selecting Rsyncable checksum type */
-+#define Z_RSYNCABLE_OFF			0
-+#define Z_RSYNCABLE_SIMPLESUM	1
-+#define Z_RSYNCABLE_RSSUM		2
-+
-+
- #define zlib_version zlibVersion()
- /* for compatibility with versions < 1.0.2 */
- 
-@@ -1185,6 +1192,17 @@
-         ZLIB_VERSION, sizeof(z_stream))
- 
- 
-+
-+/* deflateSetRsyncParameters allows for setting rsyncable parameters on a stream.
-+	These parameters MUST be set immediately after the stream is created, and before
-+	any data is written to the stream.
-+ */
-+ZEXTERN int ZEXPORT deflateSetRsyncParameters_ OF((z_stream FAR *strm, int checksum_type, unsigned long window_size, unsigned long reset_block_size));
-+
-+#define deflateSetRsyncParameters(strm, checksum_type, window_size, reset_block_size) \
-+        deflateSetRsyncParameters_((strm), (checksum_type), (window_size), (reset_block_size))
-+
-+
- #if !defined(ZUTIL_H) && !defined(NO_DUMMY_DECL)
-     struct internal_state {int dummy;}; /* hack for buggy compilers */
- #endif
-@@ -1193,6 +1211,10 @@
- ZEXTERN int            ZEXPORT inflateSyncPoint OF((z_streamp z));
- ZEXTERN const uLongf * ZEXPORT get_crc_table    OF((void));
- 
-+/* Global rsync mode control variable */
-+extern int zlib_rsync;
-+
-+
- #ifdef __cplusplus
- }
- #endif
+NOTE: this patch is for _gzip_!
+
+Kevin Day's version of the gzip-rsyncable patch that uses the rsync
+checksum algorithm.
+
+--- gzip-1.2.2/deflate.c	2004-09-15 10:28:14.000000000 -0700
++++ rsyncable/deflate.c	2005-02-17 14:37:14.660957200 -0700
+@@ -98,6 +98,10 @@
+                             int length));
+ #endif
+ 
++local void rsync_roll(deflate_state *s, unsigned start, unsigned num);
++local void rsync_roll_noop(deflate_state *s, unsigned start, unsigned num);
++local void rsync_roll2(deflate_state *s, unsigned start, unsigned num);
++
+ /* ===========================================================================
+  * Local data
+  */
+@@ -115,6 +119,39 @@
+  * See deflate.c for comments about the MIN_MATCH+1.
+  */
+ 
++
++
++/* 
++	Valid values for RSYNC_DEFAULT_CHECKSUM_TYPE are:
++
++	Z_RSYNCABLE_OFF
++	Z_RSYNCABLE_SIMPLESUM
++	Z_RSYNCABLE_RSSUM
++*/
++
++#ifndef RSYNC_DEFAULT_CHECKSUM_TYPE
++#	define RSYNC_DEFAULT_CHECKSUM_TYPE Z_RSYNCABLE_RSSUM
++#endif
++
++#ifndef RSYNC_DEFAULT_WINDOW_SIZE
++#	define RSYNC_DEFAULT_WINDOW_SIZE 30
++#endif
++
++#ifndef RSYNC_DEFAULT_RESET_BLOCK_SIZE
++#	define RSYNC_DEFAULT_RESET_BLOCK_SIZE 4096 
++#endif
++
++#ifndef RSYNC_RESET_MAGIC_VALUE
++#	define RSYNC_RESET_MAGIC_VALUE 0
++#endif
++
++#define RSYNC_SUM_MATCH(s) ((s)->rsync_sum % (s)->rsync_reset_block_size == RSYNC_RESET_MAGIC_VALUE)
++/* Whether window sum matches magic value */
++
++/* Global rsync mode control variable */
++int zlib_rsync = 1 ;
++
++
+ /* Values for max_lazy_match, good_match and max_chain_length, depending on
+  * the desired pack level (0..9). The values given below have been tuned to
+  * exclude worst case performance for pathological files. Better values may be
+@@ -212,6 +249,36 @@
+     /* To do: ignore strm->next_in if we use it as window */
+ }
+ 
++int ZEXPORT deflateSetRsyncParameters_(strm, checksum_type, window_size, reset_block_size)
++    z_streamp strm;
++    int  checksum_type;
++	ulg window_size;
++	ulg reset_block_size;
++{
++	deflate_state *s = strm->state;
++
++	switch(checksum_type){
++		case Z_RSYNCABLE_SIMPLESUM: 
++			s->rsync_rollfunction = rsync_roll; 
++			break;
++		case Z_RSYNCABLE_RSSUM: 
++			s->rsync_rollfunction = rsync_roll2; 
++			break;
++		default: 
++			s->rsync_rollfunction = rsync_roll_noop;
++	}
++
++	s->rsync_window_size = window_size != 0 ? window_size : RSYNC_DEFAULT_WINDOW_SIZE;
++	s->rsync_reset_block_size = reset_block_size != 0 ? reset_block_size : s->rsync_window_size;
++
++    s->rsync_chunk_end = 0xFFFFFFFFUL;
++    s->rsync_sum = 0;
++	s->rsync_s1 = 0;
++	s->rsync_s2 = 0;
++
++	return Z_OK;
++}
++
+ /* ========================================================================= */
+ int ZEXPORT deflateInit2_(strm, level, method, windowBits, memLevel, strategy,
+                   version, stream_size)
+@@ -307,9 +374,13 @@
+     s->strategy = strategy;
+     s->method = (Byte)method;
+ 
++	deflateSetRsyncParameters_(strm, RSYNC_DEFAULT_CHECKSUM_TYPE, RSYNC_DEFAULT_WINDOW_SIZE, RSYNC_DEFAULT_RESET_BLOCK_SIZE);
++
+     return deflateReset(strm);
+ }
+ 
++
++
+ /* ========================================================================= */
+ int ZEXPORT deflateSetDictionary (strm, dictionary, dictLength)
+     z_streamp strm;
+@@ -841,6 +912,13 @@
+ #ifdef ASMV
+     match_init(); /* initialize the asm code */
+ #endif
++
++    /* rsync params */
++    s->rsync_chunk_end = 0xFFFFFFFFUL;
++    s->rsync_sum = 0;
++	s->rsync_s1 = 0;
++	s->rsync_s2 = 0;
++
+ }
+ 
+ #ifndef FASTEST
+@@ -1123,6 +1201,8 @@
+             zmemcpy(s->window, s->window+wsize, (unsigned)wsize);
+             s->match_start -= wsize;
+             s->strstart    -= wsize; /* we now have strstart >= MAX_DIST */
++            if (s->rsync_chunk_end != 0xFFFFFFFFUL)
++                s->rsync_chunk_end -= wsize;
+             s->block_start -= (long) wsize;
+ 
+             /* Slide the hash table (could be avoided with 32 bit values
+@@ -1184,15 +1264,98 @@
+     } while (s->lookahead < MIN_LOOKAHEAD && s->strm->avail_in != 0);
+ }
+ 
++local void rsync_roll(s, start, num)
++    deflate_state *s;
++    unsigned start;
++    unsigned num;
++{
++    unsigned i;
++
++    if (start < s->rsync_window_size) {
++	/* before window fills. */
++	for (i = start; i < s->rsync_window_size; i++) {
++	    if (i == start + num) return;
++	    s->rsync_sum += (ulg)s->window[i];
++	}
++	num -= (s->rsync_window_size - start);
++	start = s->rsync_window_size;
++    }
++
++    /* buffer after window full */
++    for (i = start; i < start+num; i++) {
++	/* New character in */
++	s->rsync_sum += (ulg)s->window[i];
++	/* Old character out */
++	s->rsync_sum -= (ulg)s->window[i - s->rsync_window_size];
++	if (s->rsync_chunk_end == 0xFFFFFFFFUL
++            && RSYNC_SUM_MATCH(s))
++	    s->rsync_chunk_end = i;
++    }
++}
++
++local void rsync_roll_noop(s, start, num)
++    deflate_state *s;
++    unsigned start;
++    unsigned num;
++{
++}
++
++/*
++ Implements the 2 part rsync checksum, instead of a simple summation checksum.
++*/
++local void rsync_roll2(deflate_state *s, unsigned start, unsigned num)
++{
++    unsigned i;
++
++    if (start < s->rsync_window_size) {
++		/* before window fills. */
++		for (i = start; i < s->rsync_window_size; i++) {
++			if (i == start + num) return;
++			s->rsync_s1 = (s->rsync_s1 + (ulg)s->window[i]) & 0xffff;
++			s->rsync_s2 = (s->rsync_s2 + s->rsync_s1) & 0xffff;
++		}
++		num -= (s->rsync_window_size - start);
++		start = s->rsync_window_size;
++    }
++
++    /* buffer after window full */
++    for (i = start; i < start+num; i++) {
++		/* Old character out */
++
++		s->rsync_s1 = (s->rsync_s1 - (ulg)s->window[i - s->rsync_window_size]) & 0xffff;
++		s->rsync_s2 = (s->rsync_s2 - s->rsync_window_size * (ulg)s->window[i - s->rsync_window_size]) & 0xffff;
++
++		/* New character in */
++		s->rsync_s1 = (s->rsync_s1 + (ulg)s->window[i]) & 0xffff;
++		s->rsync_s2 = (s->rsync_s2 + s->rsync_s1) & 0xffff;
++
++		// add the two together for the match calculation
++		s->rsync_sum = s->rsync_s1 + s->rsync_s2;
++
++
++		if (s->rsync_chunk_end == 0xFFFFFFFFUL
++			&& RSYNC_SUM_MATCH(s)){
++			s->rsync_chunk_end = i;
++		}
++    }
++}
++
++/* ===========================================================================
++ * Set rsync_chunk_end if window sum matches magic value.
++ */
++#define RSYNC_ROLL(s, start, num) \
++   do { if (zlib_rsync) (s)->rsync_rollfunction((s), (start), (num)); } while(0)
++
+ /* ===========================================================================
+  * Flush the current block, with given end-of-file flag.
+  * IN assertion: strstart is set to the end of the current match.
+  */
+-#define FLUSH_BLOCK_ONLY(s, eof) { \
++#define FLUSH_BLOCK_ONLY(s, eof, pad) { \
+    _tr_flush_block(s, (s->block_start >= 0L ? \
+                    (charf *)&s->window[(unsigned)s->block_start] : \
+                    (charf *)Z_NULL), \
+                 (ulg)((long)s->strstart - s->block_start), \
++                (pad), \
+                 (eof)); \
+    s->block_start = s->strstart; \
+    flush_pending(s->strm); \
+@@ -1200,8 +1363,8 @@
+ }
+ 
+ /* Same but force premature exit if necessary. */
+-#define FLUSH_BLOCK(s, eof) { \
+-   FLUSH_BLOCK_ONLY(s, eof); \
++#define FLUSH_BLOCK(s, eof, pad) { \
++   FLUSH_BLOCK_ONLY(s, eof, pad); \
+    if (s->strm->avail_out == 0) return (eof) ? finish_started : need_more; \
+ }
+ 
+@@ -1252,16 +1415,16 @@
+             /* strstart == 0 is possible when wraparound on 16-bit machine */
+             s->lookahead = (uInt)(s->strstart - max_start);
+             s->strstart = (uInt)max_start;
+-            FLUSH_BLOCK(s, 0);
++            FLUSH_BLOCK(s, 0, 0);
+         }
+         /* Flush if we may have to slide, otherwise block_start may become
+          * negative and the data will be gone:
+          */
+         if (s->strstart - (uInt)s->block_start >= MAX_DIST(s)) {
+-            FLUSH_BLOCK(s, 0);
++            FLUSH_BLOCK(s, 0, 0);
+         }
+     }
+-    FLUSH_BLOCK(s, flush == Z_FINISH);
++    FLUSH_BLOCK(s, flush == Z_FINISH, 0);
+     return flush == Z_FINISH ? finish_done : block_done;
+ }
+ 
+@@ -1330,6 +1493,7 @@
+ 
+             s->lookahead -= s->match_length;
+ 
++            RSYNC_ROLL(s, s->strstart, s->match_length);
+             /* Insert new strings in the hash table only if the match length
+              * is not too large. This saves time but degrades compression.
+              */
+@@ -1363,12 +1527,17 @@
+             /* No match, output a literal byte */
+             Tracevv((stderr,"%c", s->window[s->strstart]));
+             _tr_tally_lit (s, s->window[s->strstart], bflush);
++            RSYNC_ROLL(s, s->strstart, 1);
+             s->lookahead--;
+             s->strstart++;
+         }
+-        if (bflush) FLUSH_BLOCK(s, 0);
++	if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
++	    s->rsync_chunk_end = 0xFFFFFFFFUL;
++	    bflush = 2;
++	}
++        if (bflush) FLUSH_BLOCK(s, 0, bflush-1);
+     }
+-    FLUSH_BLOCK(s, flush == Z_FINISH);
++    FLUSH_BLOCK(s, flush == Z_FINISH, bflush-1);
+     return flush == Z_FINISH ? finish_done : block_done;
+ }
+ 
+@@ -1457,6 +1626,7 @@
+              */
+             s->lookahead -= s->prev_length-1;
+             s->prev_length -= 2;
++            RSYNC_ROLL(s, s->strstart, s->prev_length+1);
+             do {
+                 if (++s->strstart <= max_insert) {
+                     INSERT_STRING(s, s->strstart, hash_head);
+@@ -1466,7 +1636,11 @@
+             s->match_length = MIN_MATCH-1;
+             s->strstart++;
+ 
+-            if (bflush) FLUSH_BLOCK(s, 0);
++            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
++                s->rsync_chunk_end = 0xFFFFFFFFUL;
++                bflush = 2;
++            } 
++            if (bflush) FLUSH_BLOCK(s, 0, bflush-1);
+ 
+         } else if (s->match_available) {
+             /* If there was no match at the previous position, output a
+@@ -1475,9 +1649,14 @@
+              */
+             Tracevv((stderr,"%c", s->window[s->strstart-1]));
+             _tr_tally_lit(s, s->window[s->strstart-1], bflush);
++            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
++                s->rsync_chunk_end = 0xFFFFFFFFUL;
++		bflush = 2;
++            } 
+             if (bflush) {
+-                FLUSH_BLOCK_ONLY(s, 0);
++                FLUSH_BLOCK_ONLY(s, 0, bflush-1);
+             }
++            RSYNC_ROLL(s, s->strstart, 1);
+             s->strstart++;
+             s->lookahead--;
+             if (s->strm->avail_out == 0) return need_more;
+@@ -1485,7 +1664,14 @@
+             /* There is no previous match to compare with, wait for
+              * the next step to decide.
+              */
++            if (zlib_rsync && s->strstart > s->rsync_chunk_end) {
++                /* Reset huffman tree */
++                s->rsync_chunk_end = 0xFFFFFFFFUL;
++                bflush = 2;
++                FLUSH_BLOCK(s, 0, bflush-1);
++            } 
+             s->match_available = 1;
++            RSYNC_ROLL(s, s->strstart, 1);
+             s->strstart++;
+             s->lookahead--;
+         }
+@@ -1496,7 +1682,7 @@
+         _tr_tally_lit(s, s->window[s->strstart-1], bflush);
+         s->match_available = 0;
+     }
+-    FLUSH_BLOCK(s, flush == Z_FINISH);
++    FLUSH_BLOCK(s, flush == Z_FINISH, bflush-1);
+     return flush == Z_FINISH ? finish_done : block_done;
+ }
+ #endif /* FASTEST */
+--- gzip-1.2.2/deflate.h	2004-02-24 07:38:44.000000000 -0700
++++ rsyncable/deflate.h	2005-02-17 13:46:12.056551200 -0700
+@@ -254,6 +254,17 @@
+      * are always zero.
+      */
+ 
++    ulg rsync_sum;      /* rolling sum of rsync window */
++    ulg rsync_chunk_end; /* next rsync sequence point */
++	ulg rsync_window_size; /* the number of bytes used in computing the rolling checksum */
++	ulg rsync_reset_block_size; /* the compressed stream will be reset approximately every 'rsync_reset_block_size' bytes */
++	ulg rsync_s1; /* part 1 of the checksum for use with checksum type Z_RSYNCABLE_RSSUM*/
++	ulg rsync_s2; /* part 2 of the checksum for use with checksum type Z_RSYNCABLE_RSSUM*/
++
++	/* the function that should be called for performing the rsyncable checksum roll */
++	void (*rsync_rollfunction)(struct internal_state*s , unsigned start, unsigned num);
++
++
+ } FAR deflate_state;
+ 
+ /* Output a byte on the stream.
+@@ -276,7 +287,7 @@
+ void _tr_init         OF((deflate_state *s));
+ int  _tr_tally        OF((deflate_state *s, unsigned dist, unsigned lc));
+ void _tr_flush_block  OF((deflate_state *s, charf *buf, ulg stored_len,
+-                          int eof));
++                          int pad, int eof));
+ void _tr_align        OF((deflate_state *s));
+ void _tr_stored_block OF((deflate_state *s, charf *buf, ulg stored_len,
+                           int eof));
+--- gzip-1.2.2/minigzip.c	2003-11-04 18:19:26.000000000 -0700
++++ rsyncable/minigzip.c	2005-02-17 13:11:35.472851600 -0700
+@@ -215,7 +215,7 @@
+     }
+     gz_compress(in, out);
+ 
+-    unlink(file);
++    //unlink(file);
+ }
+ 
+ 
+@@ -236,7 +236,10 @@
+     if (len > SUFFIX_LEN && strcmp(file+len-SUFFIX_LEN, GZ_SUFFIX) == 0) {
+         infile = file;
+         outfile = buf;
+-        outfile[len-3] = '\0';
++        outfile[len-3] = '.';
++        outfile[len-2] = 'u';
++        outfile[len-1] = 'z';
++        outfile[len-0] = '\0';
+     } else {
+         outfile = file;
+         infile = buf;
+@@ -255,7 +258,7 @@
+ 
+     gz_uncompress(in, out);
+ 
+-    unlink(infile);
++    //unlink(infile);
+ }
+ 
+ 
+--- gzip-1.2.2/trees.c	2004-02-24 07:36:38.000000000 -0700
++++ rsyncable/trees.c	2005-02-17 13:09:38.768435100 -0700
+@@ -918,10 +918,11 @@
+  * Determine the best encoding for the current block: dynamic trees, static
+  * trees or store, and output the encoded block to the zip file.
+  */
+-void _tr_flush_block(s, buf, stored_len, eof)
++void _tr_flush_block(s, buf, stored_len, pad, eof)
+     deflate_state *s;
+     charf *buf;       /* input block, or NULL if too old */
+     ulg stored_len;   /* length of input block */
++    int pad;          /* pad output to byte boundary */
+     int eof;          /* true if this is the last block for a file */
+ {
+     ulg opt_lenb, static_lenb; /* opt_len and static_len in bytes */
+@@ -1009,6 +1010,12 @@
+ #ifdef DEBUG
+         s->compressed_len += 7;  /* align on byte boundary */
+ #endif
++#ifdef DEBUG
++    } else if (pad && (s->compressed_len % 8) != 0) {
++#else
++    } else if (pad) {
++#endif
++        _tr_stored_block(s, buf, 0, eof);
+     }
+     Tracev((stderr,"\ncomprlen %lu(%lu) ", s->compressed_len>>3,
+            s->compressed_len-7*eof));
+--- gzip-1.2.2/zlib.def	1969-12-31 17:00:00.000000000 -0700
++++ rsyncable/zlib.def	2005-02-17 14:01:48.972258000 -0700
+@@ -0,0 +1,61 @@
++LIBRARY
++; zlib data compression library
++
++EXPORTS
++; basic functions
++    zlibVersion
++    deflate
++    deflateEnd
++    inflate
++    inflateEnd
++; advanced functions
++    deflateSetDictionary
++    deflateCopy
++    deflateReset
++    deflateParams
++    deflateBound
++    deflatePrime
++    inflateSetDictionary
++    inflateSync
++    inflateCopy
++    inflateReset
++    inflateBack
++    inflateBackEnd
++    zlibCompileFlags
++; utility functions
++    compress
++    compress2
++    compressBound
++    uncompress
++    gzopen
++    gzdopen
++    gzsetparams
++    gzread
++    gzwrite
++    gzprintf
++    gzputs
++    gzgets
++    gzputc
++    gzgetc
++    gzungetc
++    gzflush
++    gzseek
++    gzrewind
++    gztell
++    gzeof
++    gzclose
++    gzerror
++    gzclearerr
++; checksum functions
++    adler32
++    crc32
++; various hacks, don't look :)
++    deflateInit_
++    deflateInit2_
++    inflateInit_
++    inflateInit2_
++    inflateBackInit_
++    inflateSyncPoint
++    get_crc_table
++    zError
++	deflateSetRsyncParameters_
+\ No newline at end of file
+--- gzip-1.2.2/zlib.h	2004-10-03 22:57:26.000000000 -0700
++++ rsyncable/zlib.h	2005-02-17 14:02:11.753362200 -0700
+@@ -179,6 +179,13 @@
+ 
+ #define Z_NULL  0  /* for initializing zalloc, zfree, opaque */
+ 
++
++/* Constants used for selecting Rsyncable checksum type */
++#define Z_RSYNCABLE_OFF			0
++#define Z_RSYNCABLE_SIMPLESUM	1
++#define Z_RSYNCABLE_RSSUM		2
++
++
+ #define zlib_version zlibVersion()
+ /* for compatibility with versions < 1.0.2 */
+ 
+@@ -1185,6 +1192,17 @@
+         ZLIB_VERSION, sizeof(z_stream))
+ 
+ 
++
++/* deflateSetRsyncParameters allows for setting rsyncable parameters on a stream.
++	These parameters MUST be set immediately after the stream is created, and before
++	any data is written to the stream.
++ */
++ZEXTERN int ZEXPORT deflateSetRsyncParameters_ OF((z_stream FAR *strm, int checksum_type, unsigned long window_size, unsigned long reset_block_size));
++
++#define deflateSetRsyncParameters(strm, checksum_type, window_size, reset_block_size) \
++        deflateSetRsyncParameters_((strm), (checksum_type), (window_size), (reset_block_size))
++
++
+ #if !defined(ZUTIL_H) && !defined(NO_DUMMY_DECL)
+     struct internal_state {int dummy;}; /* hack for buggy compilers */
+ #endif
+@@ -1193,6 +1211,10 @@
+ ZEXTERN int            ZEXPORT inflateSyncPoint OF((z_streamp z));
+ ZEXTERN const uLongf * ZEXPORT get_crc_table    OF((void));
+ 
++/* Global rsync mode control variable */
++extern int zlib_rsync;
++
++
+ #ifdef __cplusplus
+ }
+ #endif
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/id-pair.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/id-pair.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/id-pair.diff	2006-04-22 23:52:26.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/id-pair.diff	2006-11-07 12:42:59.000000000 +0800
@@ -5,26 +5,32 @@
 
 This only saves 4 bytes per file (not counting the overhead of the array).
 
 This probably needs a hashing algorithm to be added if the uid+gid list
 gets to be really large.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/id-pair.diff
+    ./configure                         (optional if already run)
+    make
+
 --- old/flist.c
 +++ new/flist.c
-@@ -58,6 +58,7 @@ extern int copy_unsafe_links;
+@@ -54,6 +54,7 @@ extern int copy_unsafe_links;
  extern int protocol_version;
  extern int sanitize_paths;
  extern struct stats stats;
 +extern struct id_pair *id_pairs;
  extern struct file_list *the_file_list;
  
  extern char curr_dir[MAXPATHLEN];
-@@ -359,14 +360,14 @@ static void send_file_entry(struct file_
+@@ -351,14 +352,14 @@ static void send_file_entry(struct file_
  		}
  	} else if (protocol_version < 28)
- 		rdev = makedev(0, 0);
+ 		rdev = MAKEDEV(0, 0);
 -	if (file->uid == uid)
 +	if (id_pairs[file->id_ndx].uid == uid)
  		flags |= XMIT_SAME_UID;
  	else
 -		uid = file->uid;
 -	if (file->gid == gid)
@@ -34,73 +40,73 @@
  	else
 -		gid = file->gid;
 +		gid = id_pairs[file->id_ndx].gid;
  	if (file->modtime == modtime)
  		flags |= XMIT_SAME_TIME;
  	else
-@@ -617,8 +618,7 @@ static struct file_struct *receive_file_
+@@ -609,8 +610,7 @@ static struct file_struct *receive_file_
  	file->modtime = modtime;
  	file->length = file_length;
  	file->mode = mode;
 -	file->uid = uid;
 -	file->gid = gid;
 +	file->id_ndx = id_pair(uid, gid);
  
  	if (dirname_len) {
  		file->dirname = lastdir = bp;
-@@ -869,8 +869,7 @@ struct file_struct *make_file(char *fnam
+@@ -862,8 +862,7 @@ struct file_struct *make_file(char *fnam
  	file->modtime = st.st_mtime;
  	file->length = st.st_size;
  	file->mode = st.st_mode;
 -	file->uid = st.st_uid;
 -	file->gid = st.st_gid;
 +	file->id_ndx = id_pair(st.st_uid, st.st_gid);
  
  #ifdef SUPPORT_HARD_LINKS
  	if (flist && flist->hlink_pool) {
-@@ -938,8 +937,7 @@ struct file_struct *make_file(char *fnam
+@@ -931,8 +930,7 @@ struct file_struct *make_file(char *fnam
  			file->modtime = st2.st_mtime;
  			file->length = st2.st_size;
  			file->mode = st2.st_mode;
 -			file->uid = st2.st_uid;
 -			file->gid = st2.st_gid;
 +			file->id_ndx = id_pair(st2.st_uid, st2.st_gid);
  			file->u.link = NULL;
  		} else
  			file->mode = save_mode;
-@@ -1383,7 +1381,7 @@ struct file_list *recv_file_list(int f)
+@@ -1380,7 +1378,7 @@ struct file_list *recv_file_list(int f)
  	clean_flist(flist, relative_paths, 1);
  
  	if (f >= 0) {
 -		recv_uid_list(f, flist);
 +		recv_uid_list(f);
  
  		/* Recv the io_error flag */
  		if (lp_ignore_errors(module_id) || ignore_errors)
-@@ -1699,13 +1697,15 @@ static void output_flist(struct file_lis
+@@ -1696,13 +1694,15 @@ static void output_flist(struct file_lis
  
  	for (i = 0; i < flist->count; i++) {
  		file = flist->files[i];
 -		if ((am_root || am_sender) && preserve_uid)
--			sprintf(uidbuf, " uid=%ld", (long)file->uid);
+-			snprintf(uidbuf, sizeof uidbuf, " uid=%ld", (long)file->uid);
 -		else
 +		if ((am_root || am_sender) && preserve_uid) {
-+			sprintf(uidbuf, " uid=%ld",
++			snprintf(uidbuf, sizeof uidbuf, " uid=%ld",
 +				(long)id_pairs[file->id_ndx].uid);
 +		} else
  			*uidbuf = '\0';
 -		if (preserve_gid && file->gid != GID_NONE)
--			sprintf(gidbuf, " gid=%ld", (long)file->gid);
+-			snprintf(gidbuf, sizeof gidbuf, " gid=%ld", (long)file->gid);
 -		else
 +		if (preserve_gid && id_pairs[file->id_ndx].gid != GID_NONE) {
-+			sprintf(gidbuf, " gid=%ld",
++			snprintf(gidbuf, sizeof gidbuf, " gid=%ld",
 +				(long)id_pairs[file->id_ndx].gid);
 +		} else
  			*gidbuf = '\0';
  		if (!am_sender)
- 			sprintf(depthbuf, "%d", file->dir.depth);
+ 			snprintf(depthbuf, sizeof depthbuf, "%d", file->dir.depth);
 --- old/generator.c
 +++ new/generator.c
 @@ -90,6 +90,7 @@ extern dev_t filesystem_dev;
  extern char *backup_dir;
  extern char *backup_suffix;
  extern int backup_suffix_len;
@@ -145,21 +151,21 @@
 +		    && st->st_gid != gid)
  			iflags |= ITEM_REPORT_GROUP;
  	} else
  		iflags |= ITEM_IS_NEW;
 --- old/log.c
 +++ new/log.c
-@@ -48,6 +48,7 @@ extern int daemon_log_format_has_o_or_i;
- extern mode_t orig_umask;
- extern char *auth_user;
- extern char *log_format;
+@@ -46,6 +46,7 @@ extern char *auth_user;
+ extern char *stdout_format;
+ extern char *logfile_format;
+ extern char *logfile_name;
 +extern struct id_pair *id_pairs;
  #if defined HAVE_ICONV_OPEN && defined HAVE_ICONV_H
  extern iconv_t ic_chck;
  #endif
-@@ -480,16 +481,16 @@ static void log_formatted(enum logcode c
+@@ -470,16 +471,16 @@ static void log_formatted(enum logcode c
  		case 'U':
  			strlcat(fmt, "ld", sizeof fmt);
  			snprintf(buf2, sizeof buf2, fmt,
 -				 (long)file->uid);
 +				 (long)id_pairs[file->id_ndx].uid);
  			n = buf2;
@@ -175,30 +181,30 @@
 +					 (long)id_pairs[file->id_ndx].gid);
  				n = buf2;
  			}
  			break;
 --- old/rsync.c
 +++ new/rsync.c
-@@ -50,6 +50,7 @@ extern int keep_dirlinks;
+@@ -49,6 +49,7 @@ extern int keep_dirlinks;
  extern int make_backups;
  extern mode_t orig_umask;
  extern struct stats stats;
 +extern struct id_pair *id_pairs;
  extern struct chmod_mode_struct *daemon_chmod_modes;
  
  #if defined HAVE_ICONV_OPEN && defined HAVE_ICONV_H
-@@ -128,6 +129,8 @@ int set_file_attrs(char *fname, struct f
- 	int updated = 0;
+@@ -130,6 +131,8 @@ int set_file_attrs(char *fname, struct f
  	STRUCT_STAT st2;
  	int change_uid, change_gid;
+ 	mode_t new_mode = file->mode;
 +	uid_t uid;
 +	gid_t gid;
  
  	if (!st) {
  		if (dry_run)
-@@ -160,9 +163,11 @@ int set_file_attrs(char *fname, struct f
+@@ -162,9 +165,11 @@ int set_file_attrs(char *fname, struct f
  			updated = 1;
  	}
  
 -	change_uid = am_root && preserve_uid && st->st_uid != file->uid;
 -	change_gid = preserve_gid && file->gid != GID_NONE
 -		&& st->st_gid != file->gid;
@@ -207,13 +213,13 @@
 +	change_uid = am_root && preserve_uid && st->st_uid != uid;
 +	change_gid = preserve_gid && gid != GID_NONE
 +		&& st->st_gid != gid;
  #if !defined HAVE_LCHOWN && !defined CHOWN_MODIFIES_SYMLINK
  	if (S_ISLNK(st->st_mode))
  		;
-@@ -174,18 +179,18 @@ int set_file_attrs(char *fname, struct f
+@@ -176,18 +181,18 @@ int set_file_attrs(char *fname, struct f
  				rprintf(FINFO,
  					"set uid of %s from %ld to %ld\n",
  					fname,
 -					(long)st->st_uid, (long)file->uid);
 +					(long)st->st_uid, (long)uid);
  			}
@@ -232,64 +238,64 @@
 +		    change_gid ? gid : st->st_gid) != 0) {
  			/* shouldn't have attempted to change uid or gid
  			 * unless have the privilege */
  			rsyserr(FERROR, errno, "%s %s failed",
 --- old/rsync.h
 +++ new/rsync.h
-@@ -495,6 +495,11 @@ struct hlink {
- 	int hlindex;
+@@ -503,6 +503,11 @@ struct hlink {
+ 	unsigned short link_dest_used;
  };
  
 +struct id_pair {
 +	uid_t uid;
 +	gid_t gid;
 +};
 +
  #define F_DEV	link_u.idev->dev
  #define F_INODE	link_u.idev->inode
  
-@@ -519,8 +524,7 @@ struct file_struct {
+@@ -527,8 +532,7 @@ struct file_struct {
  		struct hlink *links;
  	} link_u;
  	time_t modtime;
 -	uid_t uid;
 -	gid_t gid;
 +	int id_ndx;
  	mode_t mode;
  	uchar flags;	/* this item MUST remain last */
  };
 --- old/uidlist.c
 +++ new/uidlist.c
-@@ -37,6 +37,8 @@ extern int preserve_gid;
+@@ -38,6 +38,8 @@ extern int preserve_gid;
  extern int numeric_ids;
  extern int am_root;
  
 +struct id_pair *id_pairs;
 +
  struct idlist {
  	struct idlist *next;
  	int id, id2;
-@@ -46,6 +48,8 @@ struct idlist {
+@@ -47,6 +49,8 @@ struct idlist {
  static struct idlist *uidlist;
  static struct idlist *gidlist;
  
 +static int pair_cnt = 0, pair_alloc = 0;
 +
  static struct idlist *add_to_list(struct idlist **root, int id, char *name,
  				  int id2)
  {
-@@ -307,7 +311,7 @@ void send_uid_list(int f)
+@@ -306,7 +310,7 @@ void send_uid_list(int f)
  
  /* recv a complete uid/gid mapping from the peer and map the uid/gid
   * in the file list to local names */
 -void recv_uid_list(int f, struct file_list *flist)
 +void recv_uid_list(int f)
  {
  	int id, i;
  	char *name;
-@@ -338,11 +342,40 @@ void recv_uid_list(int f, struct file_li
+@@ -337,11 +341,40 @@ void recv_uid_list(int f, struct file_li
  
  	/* Now convert all the uids/gids from sender values to our values. */
  	if (am_root && preserve_uid && !numeric_ids) {
 -		for (i = 0; i < flist->count; i++)
 -			flist->files[i]->uid = match_uid(flist->files[i]->uid);
 +		for (i = 0; i < pair_cnt; i++)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/ignore-case.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/ignore-case.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/ignore-case.diff	2006-04-22 23:52:46.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/ignore-case.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,35 +1,52 @@
 This adds the --ignore-case option, which makes rsync compare filenames
 in a case-insensitive manner.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/ignore-case.diff
+    ./configure                            (optional if already run)
+    make
+
 --- old/flist.c
 +++ new/flist.c
-@@ -36,6 +36,7 @@ extern int am_sender;
+@@ -32,6 +32,7 @@ extern int am_sender;
  extern int do_progress;
  extern int always_checksum;
  extern int module_id;
 +extern int ignore_case;
  extern int ignore_errors;
  extern int numeric_ids;
  extern int recurse;
-@@ -1795,7 +1796,14 @@ int f_name_cmp(struct file_struct *f1, s
+@@ -1783,7 +1784,7 @@ int f_name_cmp(struct file_struct *f1, s
+ 	if (type1 != type2)
  		return type1 == t_PATH ? 1 : -1;
  
- 	while (1) {
--		if ((dif = (int)*c1++ - (int)*c2++) != 0)
+-	do {
++	while (1) {
+ 		if (!*c1) {
+ 			switch (state1) {
+ 			case s_DIR:
+@@ -1846,7 +1847,16 @@ int f_name_cmp(struct file_struct *f1, s
+ 			if (type1 != type2)
+ 				return type1 == t_PATH ? 1 : -1;
+ 		}
+-	} while ((dif = (int)*c1++ - (int)*c2++) == 0);
 +		if (ignore_case) {
 +			uchar ch1, ch2;
 +			ch1 = islower(*c1) ? toupper(*c1) : *c1;
 +			ch2 = islower(*c2) ? toupper(*c2) : *c2;
 +			c1++, c2++;
 +			if ((dif = (int)ch1 - (int)ch2) != 0)
 +				break;
 +		} else if ((dif = (int)*c1++ - (int)*c2++) != 0)
- 			break;
- 		if (!*c1) {
- 			switch (state1) {
++			break;
++	}
+ 
+ 	return dif;
+ }
 --- old/lib/wildmatch.c
 +++ new/lib/wildmatch.c
 @@ -53,6 +53,8 @@
  #define ISUPPER(c) (ISASCII(c) && isupper(c))
  #define ISXDIGIT(c) (ISASCII(c) && isxdigit(c))
  
@@ -62,49 +79,49 @@
 +    return ret;
  }
  
  /* Match the "pattern" against the forced-to-lower-case "text" string. */
 --- old/options.c
 +++ new/options.c
-@@ -109,6 +109,7 @@ OFF_T max_size = 0;
+@@ -111,6 +111,7 @@ OFF_T max_size = 0;
  OFF_T min_size = 0;
  int ignore_errors = 0;
  int modify_window = 0;
 +int ignore_case = 0;
  int blocking_io = -1;
  int checksum_seed = 0;
  int inplace = 0;
-@@ -349,6 +350,7 @@ void usage(enum logcode F)
+@@ -361,6 +362,7 @@ void usage(enum logcode F)
    rprintf(F,"     --include-from=FILE     read include patterns from FILE\n");
    rprintf(F,"     --files-from=FILE       read list of source-file names from FILE\n");
    rprintf(F," -0, --from0                 all *-from/filter files are delimited by 0s\n");
 +  rprintf(F,"     --ignore-case           ignore case when comparing filenames\n");
    rprintf(F,"     --address=ADDRESS       bind address for outgoing socket to daemon\n");
    rprintf(F,"     --port=PORT             specify double-colon alternate port number\n");
    rprintf(F,"     --sockopts=OPTIONS      specify custom TCP options\n");
-@@ -504,6 +506,7 @@ static struct poptOption long_options[] 
+@@ -525,6 +527,7 @@ static struct poptOption long_options[] 
    {"only-write-batch", 0,  POPT_ARG_STRING, &batch_name, OPT_ONLY_WRITE_BATCH, 0, 0 },
    {"files-from",       0,  POPT_ARG_STRING, &files_from, 0, 0, 0 },
    {"from0",           '0', POPT_ARG_NONE,   &eol_nulls, 0, 0, 0},
 +  {"ignore-case",      0,  POPT_ARG_NONE,   &ignore_case, 0, 0, 0 },
    {"numeric-ids",      0,  POPT_ARG_NONE,   &numeric_ids, 0, 0, 0 },
    {"timeout",          0,  POPT_ARG_INT,    &io_timeout, 0, 0, 0 },
    {"rsh",             'e', POPT_ARG_STRING, &shell_cmd, 0, 0, 0 },
-@@ -1665,6 +1668,9 @@ void server_options(char **args,int *arg
+@@ -1688,6 +1691,9 @@ void server_options(char **args,int *arg
  		args[ac++] = arg;
  	}
  
 +	if (ignore_case)
 +		args[ac++] = "--ignore-case";
 +
  	if (partial_dir && am_sender) {
  		if (partial_dir != tmp_partialdir) {
  			args[ac++] = "--partial-dir";
 --- old/wildtest.c
 +++ new/wildtest.c
-@@ -16,6 +16,7 @@ int fnmatch_errors = 0;
+@@ -32,6 +32,7 @@ int fnmatch_errors = 0;
  #endif
  
  int wildmatch_errors = 0;
 +int ignore_case = 0;
  
  typedef char bool;
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches: last-match.diff
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/link-by-hash.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/link-by-hash.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/link-by-hash.diff	2006-04-22 23:53:02.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/link-by-hash.diff	2006-11-07 12:43:04.000000000 +0800
@@ -1,23 +1,23 @@
-After applying this patch, run these commands for a successful build:
-
-    ./prepare-source
-    ./configure                      (optional if already run)
-    make
-
-Jason M. Felice writes:
+Jason M. Felice wrote:
 
 This patch adds the --link-by-hash=DIR option, which hard links received
 files in a link farm arranged by MD4 file hash.  The result is that the system
 will only store one copy of the unique contents of each file, regardless of
 the file's name.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/link-by-hash.diff
+    ./prepare-source
+    ./configure
+    make
 
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -34,7 +34,7 @@ OBJS1=rsync.o generator.o receiver.o cle
+@@ -35,7 +35,7 @@ OBJS1=rsync.o generator.o receiver.o cle
  	main.o checksum.o match.o syscall.o log.o backup.o
  OBJS2=options.o flist.o io.o compat.o hlink.o token.o uidlist.o socket.o \
  	fileio.o batch.o clientname.o chmod.o
 -OBJS3=progress.o pipe.o
 +OBJS3=progress.o pipe.o hashlink.o
  DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o
@@ -364,54 +364,54 @@
 +	return rc;
 +}
 +
 +#endif
 --- old/options.c
 +++ new/options.c
-@@ -143,6 +143,7 @@ char *backup_suffix = NULL;
+@@ -145,6 +145,7 @@ char *backup_suffix = NULL;
  char *tmpdir = NULL;
  char *partial_dir = NULL;
  char *basis_dir[MAX_BASIS_DIRS+1];
 +char *link_by_hash_dir = NULL;
  char *config_file = NULL;
  char *shell_cmd = NULL;
- char *log_format = NULL;
-@@ -337,6 +338,7 @@ void usage(enum logcode F)
+ char *logfile_name = NULL;
+@@ -349,6 +350,7 @@ void usage(enum logcode F)
    rprintf(F,"     --compare-dest=DIR      also compare destination files relative to DIR\n");
    rprintf(F,"     --copy-dest=DIR         ... and include copies of unchanged files\n");
    rprintf(F,"     --link-dest=DIR         hardlink to files in DIR when unchanged\n");
 +  rprintf(F,"     --link-by-hash=DIR      create hardlinks by hash into DIR\n");
    rprintf(F," -z, --compress              compress file data during the transfer\n");
    rprintf(F,"     --compress-level=NUM    explicitly set compression level\n");
    rprintf(F," -C, --cvs-exclude           auto-ignore files the same way CVS does\n");
-@@ -383,7 +385,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
+@@ -398,7 +400,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
        OPT_FILTER, OPT_COMPARE_DEST, OPT_COPY_DEST, OPT_LINK_DEST, OPT_HELP,
        OPT_INCLUDE, OPT_INCLUDE_FROM, OPT_MODIFY_WINDOW, OPT_MIN_SIZE, OPT_CHMOD,
        OPT_READ_BATCH, OPT_WRITE_BATCH, OPT_ONLY_WRITE_BATCH, OPT_MAX_SIZE,
 -      OPT_NO_D,
 +      OPT_NO_D, OPT_LINK_BY_HASH,
        OPT_SERVER, OPT_REFUSED_BASE = 9000};
  
  static struct poptOption long_options[] = {
-@@ -481,6 +483,7 @@ static struct poptOption long_options[] 
+@@ -499,6 +501,7 @@ static struct poptOption long_options[] 
    {"compare-dest",     0,  POPT_ARG_STRING, 0, OPT_COMPARE_DEST, 0, 0 },
    {"copy-dest",        0,  POPT_ARG_STRING, 0, OPT_COPY_DEST, 0, 0 },
    {"link-dest",        0,  POPT_ARG_STRING, 0, OPT_LINK_DEST, 0, 0 },
 +  {"link-by-hash",     0,  POPT_ARG_STRING, 0, OPT_LINK_BY_HASH, 0, 0},
    {"fuzzy",           'y', POPT_ARG_NONE,   &fuzzy_basis, 0, 0, 0 },
    {"compress",        'z', POPT_ARG_NONE,   0, 'z', 0, 0 },
    {"compress-level",   0,  POPT_ARG_INT,    &def_compress_level, 'z', 0, 0 },
-@@ -1066,6 +1069,21 @@ int parse_arguments(int *argc, const cha
+@@ -1089,6 +1092,21 @@ int parse_arguments(int *argc, const cha
  			usage(FINFO);
  			exit_cleanup(0);
  
 +                case OPT_LINK_BY_HASH:
 +#if HAVE_LINK
 +			arg = poptGetOptArg(pc);
 +			if (sanitize_paths)
-+				arg = sanitize_path(NULL, arg, NULL, 0);
++				arg = sanitize_path(NULL, arg, NULL, 0, NULL);
 +			link_by_hash_dir = (char *)arg;
 +			break;
 +#else
 +			snprintf(err_buf, sizeof err_buf,
 +				 "hard links are not supported on this %s\n",
 +				 am_server ? "server" : "client");
@@ -419,13 +419,13 @@
 +			return 0;
 +#endif
 +
  		default:
  			/* A large opt value means that set_refuse_options()
  			 * turned this option off. */
-@@ -1716,6 +1734,11 @@ void server_options(char **args,int *arg
+@@ -1739,6 +1757,11 @@ void server_options(char **args,int *arg
  		}
  	}
  
 +	if (link_by_hash_dir && am_sender) {
 +		args[ac++] = "--link-by-hash";
 +		args[ac++] = link_by_hash_dir;
@@ -433,21 +433,21 @@
 +
  	if (files_from && (!am_sender || filesfrom_host)) {
  		if (filesfrom_host) {
  			args[ac++] = "--files-from";
 --- old/receiver.c
 +++ new/receiver.c
-@@ -49,6 +49,7 @@ extern int delay_updates;
+@@ -50,6 +50,7 @@ extern int delay_updates;
  extern struct stats stats;
- extern char *log_format;
+ extern char *stdout_format;
  extern char *tmpdir;
 +extern char *link_by_hash_dir;
  extern char *partial_dir;
  extern char *basis_dir[];
  extern struct file_list *the_file_list;
-@@ -120,12 +121,13 @@ static int get_tmpname(char *fnametmp, c
+@@ -124,12 +125,13 @@ static int get_tmpname(char *fnametmp, c
  
  
  static int receive_data(int f_in, char *fname_r, int fd_r, OFF_T size_r,
 -			char *fname, int fd, OFF_T total_size)
 +			char *fname, int fd, OFF_T total_size, char *md4)
  {
@@ -456,83 +456,83 @@
  	struct map_struct *mapbuf;
  	struct sum_struct sum;
 +	struct mdfour mdfour_data;
  	int32 len;
  	OFF_T offset = 0;
  	OFF_T offset2;
-@@ -145,6 +147,9 @@ static int receive_data(int f_in, char *
+@@ -149,6 +151,9 @@ static int receive_data(int f_in, char *
  	} else
  		mapbuf = NULL;
  
 +	if (md4)
 +		mdfour_begin(&mdfour_data);
 +
  	sum_init(checksum_seed);
  
  	if (append_mode) {
-@@ -187,6 +192,8 @@ static int receive_data(int f_in, char *
+@@ -191,6 +196,8 @@ static int receive_data(int f_in, char *
  			cleanup_got_literal = 1;
  
  			sum_update(data, i);
 +			if (md4)
 +				mdfour_update(&mdfour_data, (uchar*)data, i);
  
  			if (fd != -1 && write_file(fd,data,i) != i)
  				goto report_write_error;
-@@ -213,6 +220,8 @@ static int receive_data(int f_in, char *
+@@ -217,6 +224,8 @@ static int receive_data(int f_in, char *
  
  			see_token(map, len);
  			sum_update(map, len);
 +			if (md4)
 +				mdfour_update(&mdfour_data, (uchar*)map, len);
  		}
  
- 		if (inplace) {
-@@ -253,6 +262,8 @@ static int receive_data(int f_in, char *
+ 		if (updating_basis) {
+@@ -259,6 +268,8 @@ static int receive_data(int f_in, char *
  	}
  
  	sum_end(file_sum1);
 +	if (md4)
 +		mdfour_result(&mdfour_data, (unsigned char*)md4);
  
  	if (mapbuf)
  		unmap_file(mapbuf);
-@@ -268,7 +279,7 @@ static int receive_data(int f_in, char *
+@@ -274,7 +285,7 @@ static int receive_data(int f_in, char *
  
  static void discard_receive_data(int f_in, OFF_T length)
  {
 -	receive_data(f_in, NULL, -1, 0, NULL, -1, length);
 +	receive_data(f_in, NULL, -1, 0, NULL, -1, length, NULL);
  }
  
  static void handle_delayed_updates(struct file_list *flist, char *local_name)
-@@ -600,8 +611,12 @@ int recv_files(int f_in, struct file_lis
+@@ -611,8 +622,12 @@ int recv_files(int f_in, struct file_lis
  			rprintf(FINFO, "%s\n", fname);
  
  		/* recv file data */
 +#if HAVE_LINK
 +		if (link_by_hash_dir)
 +			file->u.sum = new_array(char, MD4_SUM_LENGTH);
 +#endif
  		recv_ok = receive_data(f_in, fnamecmp, fd1, st.st_size,
 -				       fname, fd2, file->length);
 +				       fname, fd2, file->length, file->u.sum);
  
- 		if (!log_before_transfer)
- 			log_item(file, &initial_stats, iflags, NULL);
+ 		log_item(log_code, file, &initial_stats, iflags, NULL);
+ 
 --- old/rsync.c
 +++ new/rsync.c
-@@ -49,6 +49,7 @@ extern int inplace;
+@@ -48,6 +48,7 @@ extern int inplace;
  extern int keep_dirlinks;
  extern int make_backups;
  extern mode_t orig_umask;
 +extern char *link_by_hash_dir;
  extern struct stats stats;
  extern struct chmod_mode_struct *daemon_chmod_modes;
  
-@@ -269,8 +270,15 @@ void finish_transfer(char *fname, char *
+@@ -271,8 +272,15 @@ void finish_transfer(char *fname, char *
  	/* move tmp file over real file */
  	if (verbose > 2)
  		rprintf(FINFO, "renaming %s to %s\n", fnametmp, fname);
 -	ret = robust_rename(fnametmp, fname, partialptr,
 -			    file->mode & INITACCESSPERMS);
 +#if HAVE_LINK
@@ -546,13 +546,13 @@
 +	}
  	if (ret < 0) {
  		rsyserr(FERROR, errno, "%s %s -> \"%s\"",
  			ret == -2 ? "copy" : "rename",
 --- old/rsync.h
 +++ new/rsync.h
-@@ -643,6 +643,14 @@ struct stats {
+@@ -651,6 +651,14 @@ struct stats {
  	int current_file_index;
  };
  
 +struct hashfile_struct {
 +	struct hashfile_struct *next;
 +	struct hashfile_struct *prev;
@@ -563,39 +563,38 @@
 +
  struct chmod_mode_struct;
  
  #include "byteorder.h"
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -365,6 +365,7 @@ to the detailed description below for a 
+@@ -366,6 +366,7 @@ to the detailed description below for a 
       --compare-dest=DIR      also compare received files relative to DIR
       --copy-dest=DIR         ... and include copies of unchanged files
       --link-dest=DIR         hardlink to files in DIR when unchanged
 +     --link-by-hash=DIR      create hardlinks by hash into DIR
   -z, --compress              compress file data during the transfer
       --compress-level=NUM    explicitly set compression level
   -C, --cvs-exclude           auto-ignore files in the same way CVS does
 --- old/proto.h
 +++ new/proto.h
-@@ -89,6 +89,12 @@ void itemize(struct file_struct *file, i
+@@ -89,6 +89,11 @@ void itemize(struct file_struct *file, i
  int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st);
  void check_for_finished_hlinks(int itemizing, enum logcode code);
  void generate_files(int f_out, struct file_list *flist, char *local_name);
-+char* make_hash_name(struct file_struct *file);
 +void kill_hashfile(struct hashfile_struct *hashfile);
 +void kill_hashfiles(struct hashfile_struct *hashfiles);
 +struct hashfile_struct *find_hashfiles(char *hashname, int64 size, long *fnbr);
 +struct hashfile_struct *compare_hashfiles(int fd,struct hashfile_struct *files);
 +int link_by_hash(char *fnametmp,char *fname,struct file_struct *file);
  void init_hard_links(void);
  int hard_link_check(struct file_struct *file, int ndx, char *fname,
  		    int statret, STRUCT_STAT *st, int itemizing,
 --- old/rsync.1
 +++ new/rsync.1
-@@ -421,6 +421,7 @@ to the detailed description below for a 
-      --compare-dest=DIR      also compare received files relative to DIR
-      --copy-dest=DIR         \&.\&.\&. and include copies of unchanged files
-      --link-dest=DIR         hardlink to files in DIR when unchanged
-+     --link-by-hash=DIR      create hardlinks by hash into DIR
-  -z, --compress              compress file data during the transfer
-      --compress-level=NUM    explicitly set compression level
-  -C, --cvs-exclude           auto-ignore files in the same way CVS does
+@@ -432,6 +432,7 @@ to the detailed description below for a 
+      \-\-compare\-dest=DIR      also compare received files relative to DIR
+      \-\-copy\-dest=DIR         \&.\&.\&. and include copies of unchanged files
+      \-\-link\-dest=DIR         hardlink to files in DIR when unchanged
++     \-\-link\-by\-hash=DIR      create hardlinks by hash into DIR
+  \-z, \-\-compress              compress file data during the transfer
+      \-\-compress\-level=NUM    explicitly set compression level
+  \-C, \-\-cvs\-exclude           auto-ignore files in the same way CVS does
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/links-depth.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/links-depth.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/links-depth.diff	2006-04-22 23:53:12.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/links-depth.diff	2006-11-07 12:43:08.000000000 +0800
@@ -3,23 +3,29 @@
 
 The patch has been heavily modified from its original form to work
 with the latest codebase, but even in its original form it didn't
 handle relative symlinks properly, and that has not yet been fixed
 in this modified version.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/links-depth.diff
+    ./configure                          (optional if already run)
+    make
+
 --- old/flist.c
 +++ new/flist.c
-@@ -45,6 +45,7 @@ extern int one_file_system;
+@@ -41,6 +41,7 @@ extern int one_file_system;
  extern int copy_dirlinks;
  extern int keep_dirlinks;
  extern int preserve_links;
 +extern int follow_links_depth;
  extern int preserve_hard_links;
  extern int preserve_devices;
  extern int preserve_specials;
-@@ -710,6 +711,30 @@ static struct file_struct *receive_file_
+@@ -702,6 +703,30 @@ static struct file_struct *receive_file_
  	return file;
  }
  
 +#if SUPPORT_LINKS
 +static int links_depth(char *linkname, STRUCT_STAT *st_ptr)
 +{
@@ -44,13 +50,13 @@
 +}
 +#endif
 +
  /**
   * Create a file_struct for a named file by reading its stat()
   * information and performing extensive checks against global
-@@ -844,7 +869,13 @@ struct file_struct *make_file(char *fnam
+@@ -837,7 +862,13 @@ struct file_struct *make_file(char *fnam
  	basename_len = strlen(basename) + 1; /* count the '\0' */
  
  #ifdef SUPPORT_LINKS
 -	linkname_len = S_ISLNK(st.st_mode) ? strlen(linkname) + 1 : 0;
 +	if (S_ISLNK(st.st_mode)) {
 +		if (follow_links_depth && links_depth(linkname, &st))
@@ -61,50 +67,50 @@
 +		linkname_len = 0;
  #else
  	linkname_len = 0;
  #endif
 --- old/options.c
 +++ new/options.c
-@@ -44,6 +44,7 @@ int keep_dirlinks = 0;
+@@ -46,6 +46,7 @@ int keep_dirlinks = 0;
  int copy_dirlinks = 0;
  int copy_links = 0;
  int preserve_links = 0;
 +int follow_links_depth = 0;
  int preserve_hard_links = 0;
  int preserve_perms = 0;
  int preserve_executability = 0;
-@@ -285,6 +286,7 @@ void usage(enum logcode F)
+@@ -297,6 +298,7 @@ void usage(enum logcode F)
    rprintf(F,"     --append                append data onto shorter files\n");
    rprintf(F," -d, --dirs                  transfer directories without recursing\n");
    rprintf(F," -l, --links                 copy symlinks as symlinks\n");
 +  rprintf(F,"     --links-depth=NUM       follow symlinks up to NUM depth\n");
    rprintf(F," -L, --copy-links            transform symlink into referent file/dir\n");
    rprintf(F,"     --copy-unsafe-links     only \"unsafe\" symlinks are transformed\n");
    rprintf(F,"     --safe-links            ignore symlinks that point outside the source tree\n");
-@@ -430,6 +432,7 @@ static struct poptOption long_options[] 
+@@ -447,6 +449,7 @@ static struct poptOption long_options[] 
    {"links",           'l', POPT_ARG_VAL,    &preserve_links, 1, 0, 0 },
    {"no-links",         0,  POPT_ARG_VAL,    &preserve_links, 0, 0, 0 },
    {"no-l",             0,  POPT_ARG_VAL,    &preserve_links, 0, 0, 0 },
 +  {"links-depth",      0,  POPT_ARG_INT,    &follow_links_depth , 0, 0, 0 },
    {"copy-links",      'L', POPT_ARG_NONE,   &copy_links, 0, 0, 0 },
    {"copy-unsafe-links",0,  POPT_ARG_NONE,   &copy_unsafe_links, 0, 0, 0 },
    {"safe-links",       0,  POPT_ARG_NONE,   &safe_symlinks, 0, 0, 0 },
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -313,6 +313,7 @@ to the detailed description below for a 
+@@ -314,6 +314,7 @@ to the detailed description below for a 
       --append                append data onto shorter files
   -d, --dirs                  transfer directories without recursing
   -l, --links                 copy symlinks as symlinks
 +     --links-depth=NUM       follow symlinks up to NUM depth
   -L, --copy-links            transform symlink into referent file/dir
       --copy-unsafe-links     only "unsafe" symlinks are transformed
       --safe-links            ignore symlinks that point outside the tree
 --- old/rsync.1
 +++ new/rsync.1
-@@ -369,6 +369,7 @@ to the detailed description below for a 
-      --append                append data onto shorter files
-  -d, --dirs                  transfer directories without recursing
-  -l, --links                 copy symlinks as symlinks
-+     --links-depth=NUM       follow symlinks up to NUM depth
-  -L, --copy-links            transform symlink into referent file/dir
-      --copy-unsafe-links     only "unsafe" symlinks are transformed
-      --safe-links            ignore symlinks that point outside the tree
+@@ -380,6 +380,7 @@ to the detailed description below for a 
+      \-\-append                append data onto shorter files
+  \-d, \-\-dirs                  transfer directories without recursing
+  \-l, \-\-links                 copy symlinks as symlinks
++     \-\-links\-depth=NUM       follow symlinks up to NUM depth
+  \-L, \-\-copy\-links            transform symlink into referent file/dir
+      \-\-copy\-unsafe\-links     only "unsafe" symlinks are transformed
+      \-\-safe\-links            ignore symlinks that point outside the tree
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches: log-file.diff
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/md5.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/md5.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/md5.diff	2006-04-22 23:53:27.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/md5.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,68 +1,77 @@
+This patch adds the --md5 option, which makes rsync use md5 checksums
+instead of md4.
+
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/md5.diff
+    ./configure
+    make
+
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -26,7 +26,7 @@ VERSION=@VERSION@
+@@ -27,7 +27,7 @@ VERSION=@VERSION@
  .SUFFIXES: .c .o
  
  HEADERS=byteorder.h config.h errcode.h proto.h rsync.h lib/pool_alloc.h
 -LIBOBJ=lib/wildmatch.o lib/compat.o lib/snprintf.o lib/mdfour.o \
 +LIBOBJ=lib/wildmatch.o lib/compat.o lib/snprintf.o lib/mdfour.o lib/md5.o \
  	lib/permstring.o lib/pool_alloc.o @LIBOBJS@
  ZLIBOBJ=zlib/deflate.o zlib/inffast.o zlib/inflate.o zlib/inftrees.o \
  	zlib/trees.o zlib/zutil.o zlib/adler32.o zlib/compress.o zlib/crc32.o
 --- old/checksum.c
 +++ new/checksum.c
-@@ -18,6 +18,7 @@
- */
+@@ -21,6 +21,7 @@
+  */
  
  #include "rsync.h"
 +#include "lib/md5.h"
  
  int csum_length=2; /* initial value */
  
-@@ -25,6 +26,7 @@ int csum_length=2; /* initial value */
+@@ -28,6 +29,7 @@ int csum_length=2; /* initial value */
  
  extern int checksum_seed;
  extern int protocol_version;
 +extern int use_md5;
  
  /*
    a simple 32 bit checksum that can be upadted from either end
-@@ -55,6 +57,7 @@ void get_checksum2(char *buf, int32 len,
+@@ -58,6 +60,7 @@ void get_checksum2(char *buf, int32 len,
  	static char *buf1;
  	static int32 len1;
  	struct mdfour m;
 +	md5_context ctx;
  
  	if (len > len1) {
  		if (buf1)
-@@ -65,7 +68,10 @@ void get_checksum2(char *buf, int32 len,
+@@ -68,7 +71,10 @@ void get_checksum2(char *buf, int32 len,
  			out_of_memory("get_checksum2");
  	}
  
 -	mdfour_begin(&m);
 +	if (use_md5)
 +		md5_starts(&ctx);
 +	else
 +		mdfour_begin(&m);
  
  	memcpy(buf1,buf,len);
  	if (checksum_seed) {
-@@ -74,7 +80,10 @@ void get_checksum2(char *buf, int32 len,
+@@ -77,7 +83,10 @@ void get_checksum2(char *buf, int32 len,
  	}
  
  	for(i = 0; i + CSUM_CHUNK <= len; i += CSUM_CHUNK) {
 -		mdfour_update(&m, (uchar *)(buf1+i), CSUM_CHUNK);
 +		if (use_md5)
 +			md5_update(&ctx, (uchar *)(buf1+i), CSUM_CHUNK);
 +		else
 +			mdfour_update(&m, (uchar *)(buf1+i), CSUM_CHUNK);
  	}
  	/*
  	 * Prior to version 27 an incorrect MD4 checksum was computed
-@@ -83,10 +92,16 @@ void get_checksum2(char *buf, int32 len,
+@@ -86,10 +95,16 @@ void get_checksum2(char *buf, int32 len,
  	 * even when there are no more bytes.
  	 */
  	if (len - i > 0 || protocol_version >= 27) {
 -		mdfour_update(&m, (uchar *)(buf1+i), (len-i));
 +		if (use_md5)
 +			md5_update(&ctx, (uchar *)(buf1+i), len-i);
@@ -75,21 +84,21 @@
 +		md5_finish(&ctx, (uchar *)sum);
 +	else
 +		mdfour_result(&m, (uchar *)sum);
  }
  
  
-@@ -97,6 +112,7 @@ void file_checksum(char *fname,char *sum
+@@ -100,6 +115,7 @@ void file_checksum(char *fname,char *sum
  	int fd;
  	OFF_T len = size;
  	struct mdfour m;
 +	md5_context ctx;
  
  	memset(sum,0,MD4_SUM_LENGTH);
  
-@@ -106,21 +122,36 @@ void file_checksum(char *fname,char *sum
+@@ -109,21 +125,36 @@ void file_checksum(char *fname,char *sum
  
  	buf = map_file(fd, size, MAX_MAP_SIZE, CSUM_CHUNK);
  
 -	mdfour_begin(&m);
 +	if (use_md5)
 +		md5_starts(&ctx);
@@ -126,13 +135,13 @@
 +		md5_finish(&ctx, (uchar *)sum);
 +	else
 +		mdfour_result(&m, (uchar *)sum);
  
  	close(fd);
  	unmap_file(buf);
-@@ -130,11 +161,15 @@ void file_checksum(char *fname,char *sum
+@@ -133,11 +164,15 @@ void file_checksum(char *fname,char *sum
  static int32 sumresidue;
  static char sumrbuf[CSUM_CHUNK];
  static struct mdfour md;
 +static md5_context ctxd;
  
  void sum_init(int seed)
@@ -143,13 +152,13 @@
 +		md5_starts(&ctxd);
 +	else
 +		mdfour_begin(&md);
  	sumresidue = 0;
  	SIVAL(s, 0, seed);
  	sum_update(s, 4);
-@@ -159,13 +194,19 @@ void sum_update(char *p, int32 len)
+@@ -162,13 +197,19 @@ void sum_update(char *p, int32 len)
  	if (sumresidue) {
  		int32 i = CSUM_CHUNK - sumresidue;
  		memcpy(sumrbuf + sumresidue, p, i);
 -		mdfour_update(&md, (uchar *)sumrbuf, CSUM_CHUNK);
 +		if (use_md5)
 +			md5_update(&ctxd, (uchar *)sumrbuf, CSUM_CHUNK);
@@ -165,13 +174,13 @@
 +			md5_update(&ctxd, (uchar *)p, CSUM_CHUNK);
 +		else
 +			mdfour_update(&md, (uchar *)p, CSUM_CHUNK);
  		len -= CSUM_CHUNK;
  		p += CSUM_CHUNK;
  	}
-@@ -177,8 +218,15 @@ void sum_update(char *p, int32 len)
+@@ -180,8 +221,15 @@ void sum_update(char *p, int32 len)
  
  void sum_end(char *sum)
  {
 -	if (sumresidue || protocol_version >= 27)
 -		mdfour_update(&md, (uchar *)sumrbuf, sumresidue);
 +	if (sumresidue || protocol_version >= 27) {
@@ -550,37 +559,37 @@
 +void md5_update(md5_context *ctx, uchar *input, uint32 length);
 +void md5_finish(md5_context *ctx, uchar digest[16]);
 +
 +#endif /* md5.h */
 --- old/options.c
 +++ new/options.c
-@@ -115,6 +115,7 @@ int inplace = 0;
+@@ -117,6 +117,7 @@ int inplace = 0;
  int delay_updates = 0;
  long block_size = 0; /* "long" because popt can't set an int32. */
  
 +int use_md5 = 0;
  
  /** Network address family. **/
  #ifdef INET6
-@@ -367,6 +368,7 @@ void usage(enum logcode F)
+@@ -381,6 +382,7 @@ void usage(enum logcode F)
    rprintf(F,"     --only-write-batch=FILE like --write-batch but w/o updating destination\n");
    rprintf(F,"     --read-batch=FILE       read a batched update from FILE\n");
    rprintf(F,"     --protocol=NUM          force an older protocol version to be used\n");
 +  rprintf(F,"     --md5                   use MD5 checksums instead of MD4\n");
  #ifdef INET6
    rprintf(F," -4, --ipv4                  prefer IPv4\n");
    rprintf(F," -6, --ipv6                  prefer IPv6\n");
-@@ -476,6 +478,7 @@ static struct poptOption long_options[] 
+@@ -494,6 +496,7 @@ static struct poptOption long_options[] 
    {"whole-file",      'W', POPT_ARG_VAL,    &whole_file, 1, 0, 0 },
    {"no-whole-file",    0,  POPT_ARG_VAL,    &whole_file, 0, 0, 0 },
    {"no-W",             0,  POPT_ARG_VAL,    &whole_file, 0, 0, 0 },
 +  {"md5",              0,  POPT_ARG_NONE,   &use_md5, 0, 0, 0 },
    {"checksum",        'c', POPT_ARG_NONE,   &always_checksum, 0, 0, 0 },
    {"block-size",      'B', POPT_ARG_LONG,   &block_size, 0, 0, 0 },
    {"compare-dest",     0,  POPT_ARG_STRING, 0, OPT_COMPARE_DEST, 0, 0 },
-@@ -1619,6 +1622,9 @@ void server_options(char **args,int *arg
+@@ -1642,6 +1645,9 @@ void server_options(char **args,int *arg
  		args[ac++] = arg;
  	}
  
 +	if (use_md5) 
 +		args[ac++] = "--md5";
 +
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/netgroup-auth.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/netgroup-auth.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/netgroup-auth.diff	2006-02-06 14:32:33.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/netgroup-auth.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,20 +1,25 @@
 This allows you to use the samba style @netgroup names in hosts allow
 and hosts deny.
 
 This patch still needs autoconf support for portability.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/netgroup-auth.diff
+    ./configure                           (optional if already run)
+    make
+
 --- old/access.c
 +++ new/access.c
-@@ -22,12 +22,15 @@
-   */
+@@ -20,11 +20,14 @@
+  */
  
  #include "rsync.h"
 +#include <netdb.h>
  
- 
  static int match_hostname(char *host, char *tok)
  {
  	if (!host || !*host)
  		return 0;
 + 	if (*tok == '@' && tok[1])
 +		return innetgr(tok + 1, host, NULL, NULL);
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/ODBC-dblog.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/ODBC-dblog.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/ODBC-dblog.diff	2006-04-22 23:53:42.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/ODBC-dblog.diff	2006-11-07 12:43:21.000000000 +0800
@@ -1,58 +1,59 @@
 Add support for logging daemon messages to an SQL database.
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/ODBC-dblog.diff
     ./prepare-source
     ./configure --enable-ODBC
     make
 
-See the file "instructions" (after applying this patch) for more info.
+See the newly-created file "instructions" for more info.
 
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -31,7 +31,7 @@ LIBOBJ=lib/wildmatch.o lib/compat.o lib/
+@@ -32,7 +32,7 @@ LIBOBJ=lib/wildmatch.o lib/compat.o lib/
  ZLIBOBJ=zlib/deflate.o zlib/inffast.o zlib/inflate.o zlib/inftrees.o \
  	zlib/trees.o zlib/zutil.o zlib/adler32.o zlib/compress.o zlib/crc32.o
  OBJS1=rsync.o generator.o receiver.o cleanup.o sender.o exclude.o util.o \
 -	main.o checksum.o match.o syscall.o log.o backup.o
 +	main.o checksum.o match.o syscall.o log.o backup.o @EXTRA_OBJECT@
  OBJS2=options.o flist.o io.o compat.o hlink.o token.o uidlist.o socket.o \
  	fileio.o batch.o clientname.o chmod.o
  OBJS3=progress.o pipe.o
 --- old/cleanup.c
 +++ new/cleanup.c
-@@ -23,6 +23,7 @@
- 
+@@ -27,6 +27,7 @@ extern int am_server;
+ extern int am_daemon;
  extern int io_error;
  extern int keep_partial;
 +extern int am_generator;
  extern int log_got_error;
  extern char *partial_dir;
+ extern char *logfile_name;
+@@ -174,8 +175,13 @@ NORETURN void _exit_cleanup(int code, co
+ 				code = exit_code = RERR_PARTIAL;
+ 		}
  
-@@ -149,8 +150,13 @@ void _exit_cleanup(int code, const char 
- 			code = RERR_PARTIAL;
- 	}
- 
--	if (code)
-+	if (code) {
- 		log_exit(code, file, line);
+-		if (code || am_daemon || (logfile_name && (am_server || !verbose)))
++		if (code || am_daemon || (logfile_name && (am_server || !verbose))) {
+ 			log_exit(code, file, line);
 +#ifdef HAVE_LIBODBC
-+		db_log_exit(code,file,line);
-+		db_log_close();
++			db_log_exit(code, file, line);
++			db_log_close();
 +#endif
-+	}
++		}
  
- 	if (verbose > 2) {
- 		rprintf(FINFO,"_exit_cleanup(code=%d, file=%s, line=%d): about to call exit(%d)\n",
+ 		/* FALLTHROUGH */
+ #include "case_N.h"
 --- old/clientserver.c
 +++ new/clientserver.c
-@@ -395,6 +395,9 @@ static int rsync_module(int f_in, int f_
+@@ -394,6 +394,9 @@ static int rsync_module(int f_in, int f_
  		   XFLG_ABS_IF_SLASH | XFLG_OLD_PREFIXES);
  
- 	log_init();
+ 	log_init(1);
 +#ifdef HAVE_LIBODBC
 +	db_log_open();
 +#endif
  
  #ifdef HAVE_PUTENV
  	if (*lp_prexfer_exec(i) || *lp_postxfer_exec(i)) {
@@ -65,13 +66,13 @@
 +#endif
  		} else {
  			rprintf(FLOG, "rsync %s %s from %s (%s)\n",
  				am_sender ? "on" : "to",
 --- old/configure.in
 +++ new/configure.in
-@@ -577,6 +577,12 @@ if test x"$with_included_popt" != x"yes"
+@@ -610,6 +610,12 @@ if test x"$with_included_popt" != x"yes"
      AC_CHECK_LIB(popt, poptGetContext, , [with_included_popt=yes])
  fi
  
 +AC_ARG_ENABLE(ODBC, AC_HELP_STRING([--enable-ODBC], [compile in support for ODBC database logging]),
 +    [ AC_CHECK_HEADERS(sql.h sqlext.h sqltypes.h)
 +    AC_CHECK_LIB(odbc,SQLExecDirect)
@@ -894,13 +895,13 @@
 +    BEFORE the session row is inserted into the database.  (as is done when a
 +    sequence is used for unique IDs).  If False the statement will be executed
 +    after the session row is inserted (as is done when the session ID is
 +    automatically generates unique IDs).  Defaults to True.
 --- old/loadparm.c
 +++ new/loadparm.c
-@@ -120,9 +120,16 @@ typedef struct
+@@ -122,9 +122,16 @@ typedef struct
  {
  	char *auth_users;
  	char *comment;
 +	char *custom_unique_id_select;
 +	char *database_datasource;
 +	char *database_password;
@@ -911,33 +912,34 @@
  	char *exclude;
  	char *exclude_from;
 +	char *exit_table_name;
  	char *filter;
  	char *gid;
  	char *hosts_allow;
-@@ -139,13 +146,19 @@ typedef struct
+@@ -142,14 +149,20 @@ typedef struct
  	char *prexfer_exec;
  	char *refuse_options;
  	char *secrets_file;
 +	char *sequence_name;
 +	char *session_table_name;
  	char *temp_dir;
 +	char *transfer_table_name;
  	char *uid;
 +	char *unique_id_method;
  
  	int max_connections;
  	int max_verbosity;
+ 	int syslog_facility;
  	int timeout;
  
 +	BOOL database_logging;
 +	BOOL get_custom_id_before_insert;
  	BOOL ignore_errors;
  	BOOL ignore_nonreadable;
  	BOOL list;
-@@ -165,9 +178,16 @@ static service sDefault =
+@@ -169,9 +182,16 @@ static service sDefault =
  {
   /* auth_users; */		NULL,
   /* comment; */			NULL,
 + /* custom_unique_id_select; */	NULL,
 + /* database_datasource; */	NULL,
 + /* database_password; */	NULL,
@@ -948,33 +950,34 @@
   /* exclude; */			NULL,
   /* exclude_from; */		NULL,
 + /* exit_table_name; */		NULL,
   /* filter; */			NULL,
   /* gid; */			NOBODY_GROUP,
   /* hosts_allow; */		NULL,
-@@ -184,13 +204,19 @@ static service sDefault =
+@@ -189,14 +209,20 @@ static service sDefault =
   /* prexfer_exec; */		NULL,
   /* refuse_options; */		NULL,
   /* secrets_file; */		NULL,
 + /* sequence_name; */		NULL,
 + /* session_table_name; */	NULL,
   /* temp_dir; */ 		NULL,
 + /* transfer_table_name; */	NULL,
   /* uid; */			NOBODY_USER,
 + /* unique_id_method; */	NULL,
  
   /* max_connections; */		0,
   /* max_verbosity; */		1,
+  /* syslog_facility; */		LOG_DAEMON,
   /* timeout; */			0,
  
 + /* database_logging; */	False,
 + /* get_custom_id_before_insert; */ True,
   /* ignore_errors; */		False,
   /* ignore_nonreadable; */	False,
   /* list; */			True,
-@@ -291,10 +317,19 @@ static struct parm_struct parm_table[] =
+@@ -295,10 +321,19 @@ static struct parm_struct parm_table[] =
  
   {"auth users",        P_STRING, P_LOCAL, &sDefault.auth_users,        NULL,0},
   {"comment",           P_STRING, P_LOCAL, &sDefault.comment,           NULL,0},
 + {"custom unique id select",P_STRING,P_LOCAL,&sDefault.custom_unique_id_select,NULL,0},
 + {"database datasource",P_STRING,P_LOCAL, &sDefault.database_datasource,NULL,0},
 + {"database logging",  P_BOOL,   P_LOCAL, &sDefault.database_logging,  NULL,0},
@@ -988,29 +991,30 @@
 + {"exit table name",   P_STRING, P_LOCAL, &sDefault.exit_table_name,   NULL,0},
   {"filter",            P_STRING, P_LOCAL, &sDefault.filter,            NULL,0},
 + {"get custom id before insert",P_BOOL,P_LOCAL,&sDefault.get_custom_id_before_insert,NULL,0},
   {"gid",               P_STRING, P_LOCAL, &sDefault.gid,               NULL,0},
   {"hosts allow",       P_STRING, P_LOCAL, &sDefault.hosts_allow,       NULL,0},
   {"hosts deny",        P_STRING, P_LOCAL, &sDefault.hosts_deny,        NULL,0},
-@@ -318,11 +353,15 @@ static struct parm_struct parm_table[] =
+@@ -323,12 +358,16 @@ static struct parm_struct parm_table[] =
   {"read only",         P_BOOL,   P_LOCAL, &sDefault.read_only,         NULL,0},
   {"refuse options",    P_STRING, P_LOCAL, &sDefault.refuse_options,    NULL,0},
   {"secrets file",      P_STRING, P_LOCAL, &sDefault.secrets_file,      NULL,0},
 + {"sequence name",     P_STRING, P_LOCAL, &sDefault.sequence_name,     NULL,0},
 + {"session table name",P_STRING, P_LOCAL, &sDefault.session_table_name,NULL,0},
   {"strict modes",      P_BOOL,   P_LOCAL, &sDefault.strict_modes,      NULL,0},
+  {"syslog facility",   P_ENUM,   P_LOCAL, &sDefault.syslog_facility,enum_facilities,0},
   {"temp dir",          P_PATH,   P_LOCAL, &sDefault.temp_dir,          NULL,0},
   {"timeout",           P_INTEGER,P_LOCAL, &sDefault.timeout,           NULL,0},
   {"transfer logging",  P_BOOL,   P_LOCAL, &sDefault.transfer_logging,  NULL,0},
 + {"transfer table name",P_STRING,P_LOCAL, &sDefault.transfer_table_name,NULL,0},
   {"uid",               P_STRING, P_LOCAL, &sDefault.uid,               NULL,0},
 + {"unique id method",  P_STRING, P_LOCAL, &sDefault.unique_id_method,  NULL,0},
   {"use chroot",        P_BOOL,   P_LOCAL, &sDefault.use_chroot,        NULL,0},
   {"write only",        P_BOOL,   P_LOCAL, &sDefault.write_only,        NULL,0},
   {NULL,                P_BOOL,   P_NONE,  NULL,                        NULL,0}
-@@ -383,9 +422,16 @@ FN_GLOBAL_INTEGER(lp_syslog_facility, &G
+@@ -384,9 +423,16 @@ FN_GLOBAL_INTEGER(lp_rsync_port, &Global
  
  FN_LOCAL_STRING(lp_auth_users, auth_users)
  FN_LOCAL_STRING(lp_comment, comment)
 +FN_LOCAL_STRING(lp_custom_unique_id_select,custom_unique_id_select)
 +FN_LOCAL_STRING(lp_database_datasource, database_datasource)
 +FN_LOCAL_STRING(lp_database_password, database_password)
@@ -1021,18 +1025,19 @@
  FN_LOCAL_STRING(lp_exclude, exclude)
  FN_LOCAL_STRING(lp_exclude_from, exclude_from)
 +FN_LOCAL_STRING(lp_exit_table_name, exit_table_name)
  FN_LOCAL_STRING(lp_filter, filter)
  FN_LOCAL_STRING(lp_gid, gid)
  FN_LOCAL_STRING(lp_hosts_allow, hosts_allow)
-@@ -402,13 +448,19 @@ FN_LOCAL_STRING(lp_postxfer_exec, postxf
+@@ -404,14 +450,20 @@ FN_LOCAL_STRING(lp_postxfer_exec, postxf
  FN_LOCAL_STRING(lp_prexfer_exec, prexfer_exec)
  FN_LOCAL_STRING(lp_refuse_options, refuse_options)
  FN_LOCAL_STRING(lp_secrets_file, secrets_file)
 +FN_LOCAL_STRING(lp_sequence_name,sequence_name)
 +FN_LOCAL_STRING(lp_session_table_name,session_table_name)
+ FN_LOCAL_INTEGER(lp_syslog_facility, syslog_facility)
  FN_LOCAL_STRING(lp_temp_dir, temp_dir)
 +FN_LOCAL_STRING(lp_transfer_table_name, transfer_table_name)
  FN_LOCAL_STRING(lp_uid, uid)
 +FN_LOCAL_STRING(lp_unique_id_method,unique_id_method)
  
  FN_LOCAL_INTEGER(lp_max_connections, max_connections)
@@ -1043,148 +1048,147 @@
 +FN_LOCAL_BOOL(lp_get_custom_id_before_insert,get_custom_id_before_insert)
  FN_LOCAL_BOOL(lp_ignore_errors, ignore_errors)
  FN_LOCAL_BOOL(lp_ignore_nonreadable, ignore_nonreadable)
  FN_LOCAL_BOOL(lp_list, list)
 --- old/log.c
 +++ new/log.c
-@@ -95,7 +95,7 @@ struct {
+@@ -93,7 +93,7 @@ struct {
  /*
   * Map from rsync error code to name, or return NULL.
   */
 -static char const *rerr_name(int code)
 +char const *rerr_name(int code)
  {
  	int i;
  	for (i = 0; rerr_names[i].name; i++) {
---- old/main.c
-+++ new/main.c
-@@ -169,6 +169,9 @@ static void handle_stats(int f)
- 
- 	if (am_daemon) {
- 		log_exit(0, __FILE__, __LINE__);
-+#ifdef HAVE_LIBODBC
-+		db_log_exit(0,__FILE__,__LINE__);
-+#endif
- 		if (f == -1 || !am_sender)
- 			return;
- 	}
 --- old/receiver.c
 +++ new/receiver.c
-@@ -108,6 +108,10 @@ static int get_tmpname(char *fnametmp, c
+@@ -110,6 +110,10 @@ static int get_tmpname(char *fnametmp, c
  
  	if (maxname < 1) {
  		rprintf(FERROR, "temporary filename too long: %s\n", fname);
 +#ifdef HAVE_LIBODBC
 +		db_log_error(FERROR,13, "temporary filename too long: %s\n",
 +			fname);
 +#endif
  		fnametmp[0] = '\0';
  		return 0;
  	}
-@@ -224,6 +228,11 @@ static int receive_data(int f_in, char *
- 					rsyserr(FERROR, errno,
- 						"lseek failed on %s",
- 						full_fname(fname));
+@@ -173,6 +177,10 @@ static int receive_data(int f_in, char *
+ 		if (fd != -1 && (j = do_lseek(fd, offset, SEEK_SET)) != offset) {
+ 			rsyserr(FERROR, errno, "lseek of %s returned %.0f, not %.0f",
+ 				full_fname(fname), (double)j, (double)offset);
++#ifdef HAVE_LIBODBC
++			db_log_error(FERROR, 14, "lseek failed on %s",
++				full_fname(fname));
++#endif
+ 			exit_cleanup(RERR_FILEIO);
+ 		}
+ 	}
+@@ -230,6 +238,11 @@ static int receive_data(int f_in, char *
+ 						"lseek of %s returned %.0f, not %.0f",
+ 						full_fname(fname),
+ 						(double)pos, (double)offset);
 +#ifdef HAVE_LIBODBC
 +					db_log_error(FERROR, 14,
 +						"lseek failed on %s",
 +						full_fname(fname));
 +#endif
  					exit_cleanup(RERR_FILEIO);
  				}
  				continue;
-@@ -249,6 +258,9 @@ static int receive_data(int f_in, char *
+@@ -255,6 +268,9 @@ static int receive_data(int f_in, char *
  	    report_write_error:
  		rsyserr(FERROR, errno, "write failed on %s",
  			full_fname(fname));
 +#ifdef HAVE_LIBODBC
 +		db_log_error(FERROR, 15, "write failed on %s",full_fname(fname));
 +#endif
  		exit_cleanup(RERR_FILEIO);
  	}
  
-@@ -292,6 +304,12 @@ static void handle_delayed_updates(struc
+@@ -298,6 +314,12 @@ static void handle_delayed_updates(struc
  				rsyserr(FERROR, errno,
  					"rename failed for %s (from %s)",
  					full_fname(fname), partialptr);
 +#ifdef HAVE_LIBODBC
 +				db_log_error(FERROR, 16,
 +					"rename failed for %s (from %s)",
 +					full_fname(fname),
 +					partialptr);
 +#endif
  			} else {
- 				if (remove_sent_files
+ 				if (remove_source_files
  				    || (preserve_hard_links
-@@ -414,6 +432,9 @@ int recv_files(int f_in, struct file_lis
+@@ -422,6 +444,9 @@ int recv_files(int f_in, struct file_lis
  		if (server_filter_list.head
  		    && check_filter(&server_filter_list, fname, 0) < 0) {
  			rprintf(FERROR, "attempt to hack rsync failed.\n");
 +#ifdef HAVE_LIBODBC
-+				db_log_error(FERROR,17,"attempt to hack rsync failed.");
++			db_log_error(FERROR,17,"attempt to hack rsync failed.");
 +#endif
  			exit_cleanup(RERR_PROTOCOL);
  		}
  
-@@ -469,6 +490,11 @@ int recv_files(int f_in, struct file_lis
+@@ -478,6 +503,11 @@ int recv_files(int f_in, struct file_lis
  					rprintf(FERROR,
  						"invalid basis_dir index: %d.\n",
  						fnamecmp_type);
 +#ifdef HAVE_LIBODBC
 +					db_log_error(FERROR, 18,
 +						"invalid basis_dir index: %d.\n",
 +						fnamecmp_type);
 +#endif
  					exit_cleanup(RERR_PROTOCOL);
  				}
  				pathjoin(fnamecmpbuf, sizeof fnamecmpbuf,
-@@ -514,6 +540,9 @@ int recv_files(int f_in, struct file_lis
- 		if (fd1 != -1 && do_fstat(fd1,&st) != 0) {
+@@ -526,6 +556,9 @@ int recv_files(int f_in, struct file_lis
+ 		} else if (do_fstat(fd1,&st) != 0) {
  			rsyserr(FERROR, errno, "fstat %s failed",
  				full_fname(fnamecmp));
 +#ifdef HAVE_LIBODBC
-+				db_log_error(FERROR, 19,"fstat %s failed",full_fname(fnamecmp));
++			db_log_error(FERROR, 19,"fstat %s failed",full_fname(fnamecmp));
 +#endif
  			discard_receive_data(f_in, file->length);
  			close(fd1);
  			continue;
-@@ -527,6 +556,9 @@ int recv_files(int f_in, struct file_lis
+@@ -539,6 +572,9 @@ int recv_files(int f_in, struct file_lis
  			 */
  			rprintf(FERROR,"recv_files: %s is a directory\n",
  				full_fname(fnamecmp));
 +#ifdef HAVE_LIBODBC
-+				db_log_error(FERROR,20,"recv_files: %s is a directory",full_fname(fnamecmp));
++			db_log_error(FERROR,20,"recv_files: %s is a directory",full_fname(fnamecmp));
 +#endif
  			discard_receive_data(f_in, file->length);
  			close(fd1);
  			continue;
-@@ -550,6 +582,9 @@ int recv_files(int f_in, struct file_lis
+@@ -562,6 +598,9 @@ int recv_files(int f_in, struct file_lis
  			if (fd2 == -1) {
  				rsyserr(FERROR, errno, "open %s failed",
  					full_fname(fname));
 +#ifdef HAVE_LIBODBC
-+					db_log_error(FERROR,22, "open %s failed", full_fname(fname));
++				db_log_error(FERROR,22, "open %s failed", full_fname(fname));
 +#endif
  				discard_receive_data(f_in, file->length);
  				if (fd1 != -1)
  					close(fd1);
-@@ -583,6 +618,10 @@ int recv_files(int f_in, struct file_lis
+@@ -595,6 +634,10 @@ int recv_files(int f_in, struct file_lis
  			if (fd2 == -1) {
  				rsyserr(FERROR, errno, "mkstemp %s failed",
  					full_fname(fnametmp));
 +#ifdef HAVE_LIBODBC
-+					db_log_error(FERROR, 22, "mkstemp %s failed",
++				db_log_error(FERROR, 22, "mkstemp %s failed",
 +					full_fname(fnametmp));
 +#endif
  				discard_receive_data(f_in, file->length);
  				if (fd1 != -1)
  					close(fd1);
-@@ -605,12 +644,19 @@ int recv_files(int f_in, struct file_lis
+@@ -615,12 +658,19 @@ int recv_files(int f_in, struct file_lis
+ 				       fname, fd2, file->length);
  
- 		if (!log_before_transfer)
- 			log_item(file, &initial_stats, iflags, NULL);
+ 		log_item(log_code, file, &initial_stats, iflags, NULL);
 +#ifdef HAVE_LIBODBC
 +		db_log_transfer(file, &initial_stats, "receive");
 +#endif
  
  		if (fd1 != -1)
  			close(fd1);
@@ -1195,31 +1199,31 @@
 +			db_log_error(FERROR, 23, "close failed on %s",
 +				full_fname(fnametmp));
 +#endif
  			exit_cleanup(RERR_FILEIO);
  		}
  
-@@ -664,6 +710,12 @@ int recv_files(int f_in, struct file_lis
+@@ -679,6 +729,12 @@ int recv_files(int f_in, struct file_lis
  				rprintf(msgtype,
  					"%s: %s failed verification -- update %s%s.\n",
  					errstr, fname, keptstr, redostr);
 +#ifdef HAVE_LIBODBC
-+					db_log_error(msgtype,24,
++				db_log_error(msgtype,24,
 +					"%s: %s failed verification -- update %s%s.\n",
 +					errstr, fname,
 +					keptstr, redostr);
 +#endif
  			}
  			if (!phase) {
  				SIVAL(numbuf, 0, i);
 --- old/sender.c
 +++ new/sender.c
-@@ -352,6 +352,9 @@ void send_files(struct file_list *flist,
+@@ -355,6 +355,9 @@ void send_files(struct file_list *flist,
+ 			end_progress(st.st_size);
  
- 		if (!log_before_transfer)
- 			log_item(file, &initial_stats, iflags, NULL);
+ 		log_item(log_code, file, &initial_stats, iflags, NULL);
 +#ifdef HAVE_LIBODBC
 +		db_log_transfer(file, &initial_stats,"send");
 +#endif
  
  		if (mbuf) {
  			j = unmap_file(mbuf);
@@ -1237,14 +1241,14 @@
 +void db_log_exit(int code, const char *file, int line);
 +void db_log_delete(char *fname, int mode);
 +void db_log_error(enum logcode code, int errcode, const char *format,...);
  void set_filter_dir(const char *dir, unsigned int dirlen);
  void *push_local_filters(const char *dir, unsigned int dirlen);
  void pop_local_filters(void *mem);
-@@ -149,9 +157,16 @@ int lp_rsync_port(void);
- int lp_syslog_facility(void);
+@@ -147,9 +155,16 @@ char *lp_socket_options(void);
+ int lp_rsync_port(void);
  char *lp_auth_users(int );
  char *lp_comment(int );
 +char *lp_custom_unique_id_select(int );
 +char *lp_database_datasource(int );
 +char *lp_database_password(int );
 +char *lp_database_username(int );
@@ -1254,18 +1258,19 @@
  char *lp_exclude(int );
  char *lp_exclude_from(int );
 +char *lp_exit_table_name(int );
  char *lp_filter(int );
  char *lp_gid(int );
  char *lp_hosts_allow(int );
-@@ -168,11 +183,17 @@ char *lp_postxfer_exec(int );
+@@ -167,12 +182,18 @@ char *lp_postxfer_exec(int );
  char *lp_prexfer_exec(int );
  char *lp_refuse_options(int );
  char *lp_secrets_file(int );
 +char *lp_sequence_name(int );
 +char *lp_session_table_name(int );
+ int lp_syslog_facility(int );
  char *lp_temp_dir(int );
 +char *lp_transfer_table_name(int );
  char *lp_uid(int );
 +char *lp_unique_id_method(int );
  int lp_max_connections(int );
  int lp_max_verbosity(int );
@@ -1277,113 +1282,131 @@
  BOOL lp_list(int );
 @@ -184,6 +205,7 @@ BOOL lp_write_only(int );
  BOOL lp_load(char *pszFname, int globals_only);
  int lp_numservices(void);
  int lp_number(char *name);
 +char const *rerr_name(int code);
- void log_init(void);
+ void log_init(int restart);
  void logfile_close(void);
  void logfile_reopen(void);
 --- old/configure
 +++ new/configure
-@@ -309,7 +309,7 @@ ac_includes_default="\
- # include <unistd.h>
- #endif"
- 
--ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
-+ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA EXTRA_OBJECT OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
- ac_subst_files=''
- 
- # Initialize some variables set by options.
-@@ -852,6 +852,7 @@ Optional Features:
+@@ -664,6 +664,7 @@ INSTALL_DATA
+ HAVE_REMSH
+ LIBOBJS
+ ALLOCA
++EXTRA_OBJECT
+ OBJ_SAVE
+ OBJ_RESTORE
+ CC_SHOBJ_FLAG
+@@ -1258,6 +1259,7 @@ Optional Features:
    --disable-largefile     omit support for large files
    --disable-ipv6          don't even try to use IPv6
    --disable-locale        turn off locale features
 +  --enable-ODBC           compile in support for ODBC database logging
  
  Optional Packages:
    --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-@@ -11558,6 +11559,237 @@ fi
+@@ -14159,6 +14161,266 @@ fi
  
  fi
  
-+# Check whether --enable-ODBC or --disable-ODBC was given.
++# Check whether --enable-ODBC was given.
 +if test "${enable_ODBC+set}" = set; then
-+  enableval="$enable_ODBC"
-+
++  enableval=$enable_ODBC;
 +
 +
 +for ac_header in sql.h sqlext.h sqltypes.h
 +do
 +as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
-+  echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  { echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +else
 +  # Is the header compilable?
-+echo "$as_me:$LINENO: checking $ac_header usability" >&5
-+echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
++echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +$ac_includes_default
 +#include <$ac_header>
 +_ACEOF
 +rm -f conftest.$ac_objext
-+if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-+  (eval $ac_compile) 2>conftest.er1
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest.$ac_objext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_header_compiler=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_header_compiler=no
++	ac_header_compiler=no
 +fi
-+rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-+echo "${ECHO_T}$ac_header_compiler" >&6
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
 +
 +# Is the header present?
-+echo "$as_me:$LINENO: checking $ac_header presence" >&5
-+echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
++echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +#include <$ac_header>
 +_ACEOF
-+if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } >/dev/null; then
@@ -1401,15 +1424,16 @@
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
 +  ac_header_preproc=no
 +fi
++
 +rm -f conftest.err conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-+echo "${ECHO_T}$ac_header_preproc" >&6
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
 +
 +# So?  What about this header?
 +case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
 +  yes:no: )
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
 +echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -1427,143 +1451,161 @@
 +    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
 +echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
 +echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
 +echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
-+    (
-+      cat <<\_ASBOX
-+## ------------------------------------------ ##
-+## Report this to the AC_PACKAGE_NAME lists.  ##
-+## ------------------------------------------ ##
-+_ASBOX
-+    ) |
-+      sed "s/^/$as_me: WARNING:     /" >&2
++
 +    ;;
 +esac
-+echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++{ echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  eval "$as_ac_Header=\$ac_header_preproc"
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +
 +fi
 +if test `eval echo '${'$as_ac_Header'}'` = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
 +_ACEOF
 +
 +fi
 +
 +done
 +
 +
-+echo "$as_me:$LINENO: checking for SQLExecDirect in -lodbc" >&5
-+echo $ECHO_N "checking for SQLExecDirect in -lodbc... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking for SQLExecDirect in -lodbc" >&5
++echo $ECHO_N "checking for SQLExecDirect in -lodbc... $ECHO_C" >&6; }
 +if test "${ac_cv_lib_odbc_SQLExecDirect+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_check_lib_save_LIBS=$LIBS
 +LIBS="-lodbc  $LIBS"
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char SQLExecDirect ();
 +int
 +main ()
 +{
-+SQLExecDirect ();
++return SQLExecDirect ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_cv_lib_odbc_SQLExecDirect=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_cv_lib_odbc_SQLExecDirect=no
++	ac_cv_lib_odbc_SQLExecDirect=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +LIBS=$ac_check_lib_save_LIBS
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_lib_odbc_SQLExecDirect" >&5
-+echo "${ECHO_T}$ac_cv_lib_odbc_SQLExecDirect" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_lib_odbc_SQLExecDirect" >&5
++echo "${ECHO_T}$ac_cv_lib_odbc_SQLExecDirect" >&6; }
 +if test $ac_cv_lib_odbc_SQLExecDirect = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define HAVE_LIBODBC 1
 +_ACEOF
 +
 +  LIBS="-lodbc $LIBS"
 +
 +fi
 +
 +    EXTRA_OBJECT="$EXTRA_OBJECT dblog.o"
 +
-+fi;
++fi
++
 +
- echo "$as_me:$LINENO: checking whether to use included libpopt" >&5
- echo $ECHO_N "checking whether to use included libpopt... $ECHO_C" >&6
+ { echo "$as_me:$LINENO: checking whether to use included libpopt" >&5
+ echo $ECHO_N "checking whether to use included libpopt... $ECHO_C" >&6; }
  if test x"$with_included_popt" = x"yes"; then
-@@ -12755,6 +12987,7 @@ s,@INSTALL_DATA@,$INSTALL_DATA,;t t
- s,@HAVE_REMSH@,$HAVE_REMSH,;t t
- s,@LIBOBJS@,$LIBOBJS,;t t
- s,@ALLOCA@,$ALLOCA,;t t
-+s,@EXTRA_OBJECT@,$EXTRA_OBJECT,;t t
- s,@OBJ_SAVE@,$OBJ_SAVE,;t t
- s,@OBJ_RESTORE@,$OBJ_RESTORE,;t t
- s,@CC_SHOBJ_FLAG@,$CC_SHOBJ_FLAG,;t t
+@@ -15483,6 +15745,7 @@ INSTALL_DATA!$INSTALL_DATA$ac_delim
+ HAVE_REMSH!$HAVE_REMSH$ac_delim
+ LIBOBJS!$LIBOBJS$ac_delim
+ ALLOCA!$ALLOCA$ac_delim
++EXTRA_OBJECT!$EXTRA_OBJECT$ac_delim
+ OBJ_SAVE!$OBJ_SAVE$ac_delim
+ OBJ_RESTORE!$OBJ_RESTORE$ac_delim
+ CC_SHOBJ_FLAG!$CC_SHOBJ_FLAG$ac_delim
+@@ -15490,7 +15753,7 @@ BUILD_POPT!$BUILD_POPT$ac_delim
+ LTLIBOBJS!$LTLIBOBJS$ac_delim
+ _ACEOF
+ 
+-  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 71; then
++  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 72; then
+     break
+   elif $ac_last_try; then
+     { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
 --- old/config.h.in
 +++ new/config.h.in
 @@ -155,6 +155,9 @@
  /* Define to 1 if you have the `nsl_s' library (-lnsl_s). */
  #undef HAVE_LIBNSL_S
  
 +/* Define to 1 if you have the `odbc' library (-lodbc). */
 +#undef HAVE_LIBODBC
 +
  /* Define to 1 if you have the `popt' library (-lpopt). */
  #undef HAVE_LIBPOPT
  
-@@ -276,6 +279,15 @@
+@@ -280,6 +283,15 @@
  /* Define to 1 if you have the "socketpair" function */
  #undef HAVE_SOCKETPAIR
  
 +/* Define to 1 if you have the <sqlext.h> header file. */
 +#undef HAVE_SQLEXT_H
 +
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches: omit-dir-changes.diff
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/openssl-support.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/openssl-support.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/openssl-support.diff	2006-04-22 23:53:50.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/openssl-support.diff	2006-11-07 12:43:31.000000000 +0800
@@ -1,13 +1,7 @@
-After applying this patch, run these commands for a successful build:
-
-    ./prepare-source
-    ./configure
-    make
-
-Casey Marshall writes:
+Casey Marshall wrote:
 
 I've been hacking together a way to use rsync with OpenSSL, and have
 attached my current patch against a recent CVS tree. The details of
 this implementation are:
 
   1. The SSL code is added as a "layer" that is forked into its own
@@ -31,85 +25,94 @@
 
   4. There are a number of details not implemented.
 
 All warnings apply; I don't do C programming all that often, so I
 can't say if I've left any cleanup/compatibility errors in the code.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/openssl-support.diff
+    ./prepare-source
+    ./configure
+    make
 
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -38,7 +38,7 @@ OBJS3=progress.o pipe.o
+@@ -39,7 +39,7 @@ OBJS3=progress.o pipe.o
  DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o
  popt_OBJS=popt/findme.o  popt/popt.o  popt/poptconfig.o \
  	popt/popthelp.o popt/poptparse.o
 -OBJS=$(OBJS1) $(OBJS2) $(OBJS3) $(DAEMON_OBJ) $(LIBOBJ) $(ZLIBOBJ) @BUILD_POPT@
 +OBJS=$(OBJS1) $(OBJS2) $(OBJS3) $(DAEMON_OBJ) $(LIBOBJ) $(ZLIBOBJ) @BUILD_POPT@ @SSL_OBJS@
  
  TLS_OBJ = tls.o syscall.o lib/compat.o lib/snprintf.o lib/permstring.o
  
 --- old/cleanup.c
 +++ new/cleanup.c
-@@ -22,6 +22,9 @@
- #include "rsync.h"
- 
+@@ -26,6 +26,9 @@
+ extern int am_server;
+ extern int am_daemon;
  extern int io_error;
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +extern int use_ssl;
 +#endif
  extern int keep_partial;
  extern int log_got_error;
  extern char *partial_dir;
-@@ -101,6 +104,11 @@ void _exit_cleanup(int code, const char 
- 	SIGACTION(SIGUSR1, SIG_IGN);
- 	SIGACTION(SIGUSR2, SIG_IGN);
- 
-+#if HAVE_OPENSSL
-+	if (use_ssl)
-+		end_tls();
+@@ -117,6 +120,14 @@ NORETURN void _exit_cleanup(int code, co
+ 				code, file, line);
+ 		}
+ 
++#ifdef HAVE_OPENSSL
++		/* FALLTHROUGH */
++#include "case_N.h"
++
++		if (use_ssl)
++			end_tls();
 +#endif
 +
- 	if (verbose > 3) {
- 		rprintf(FINFO,"_exit_cleanup(code=%d, file=%s, line=%d): entered\n",
- 			code, file, line);
+ 		/* FALLTHROUGH */
+ #include "case_N.h"
+ 
 --- old/clientserver.c
 +++ new/clientserver.c
-@@ -34,6 +34,9 @@ extern int am_sender;
+@@ -30,6 +30,9 @@ extern int am_sender;
  extern int am_server;
  extern int am_daemon;
  extern int am_root;
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +extern int use_ssl;
 +#endif
  extern int rsync_port;
  extern int kluge_around_eof;
  extern int daemon_over_rsh;
-@@ -109,8 +112,18 @@ int start_socket_client(char *host, char
+@@ -106,8 +109,18 @@ int start_socket_client(char *host, char
  	set_socket_options(fd, sockopts);
  
  	ret = start_inband_exchange(user, path, fd, fd, argc);
 +	if (ret)
 +		return ret;
-+
-+#if HAVE_OPENSSL
+ 
+-	return ret ? ret : client_run(fd, fd, -1, argc, argv);
++#ifdef HAVE_OPENSSL
 +	if (use_ssl) {
 +		int f_in = get_tls_rfd();
 +		int f_out = get_tls_wfd();
 +		return client_run(f_in, f_out, -1, argc, argv);
 +	}
 +#endif
- 
--	return ret ? ret : client_run(fd, fd, -1, argc, argv);
++
 +	return client_run(fd, fd, -1, argc, argv);
  }
  
- int start_inband_exchange(char *user, char *path, int f_in, int f_out, 
-@@ -171,6 +184,33 @@ int start_inband_exchange(char *user, ch
+ int start_inband_exchange(char *user, char *path, int f_in, int f_out,
+@@ -168,6 +181,33 @@ int start_inband_exchange(char *user, ch
  	if (verbose > 1)
  		print_child_argv(sargs);
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +	if (use_ssl) {
 +		io_printf(f_out, "#starttls\n");
 +		while (1) {
 +			if (!read_line(f_in, line, sizeof(line)-1)) {
 +				rprintf(FERROR, "rsync: did not receive reply to #starttls\n");
 +				return -1;
@@ -133,57 +136,49 @@
 +	}
 +#endif
 +
  	p = strchr(path,'/');
  	if (p) *p = 0;
  	io_printf(f_out, "%s\n", path);
-@@ -199,6 +239,10 @@ int start_inband_exchange(char *user, ch
+@@ -196,6 +236,10 @@ int start_inband_exchange(char *user, ch
  			 * server to terminate the listing of modules.
  			 * We don't want to go on and transfer
  			 * anything; just exit. */
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +			if (use_ssl)
 +				end_tls();
 +#endif
  			exit(0);
  		}
  
-@@ -206,6 +250,10 @@ int start_inband_exchange(char *user, ch
+@@ -203,6 +247,10 @@ int start_inband_exchange(char *user, ch
  			rprintf(FERROR, "%s\n", line);
  			/* This is always fatal; the server will now
  			 * close the socket. */
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +			if (use_ssl)
 +				end_tls();
 +#endif
  			return -1;
  		}
  
-@@ -722,6 +770,7 @@ static void send_listing(int fd)
- 		io_printf(fd,"@RSYNCD: EXIT\n");
- }
- 
-+
- /* this is called when a connection is established to a client
-    and we want to start talking. The setup of the system is done from
-    here */
-@@ -780,6 +829,9 @@ int start_daemon(int f_in, int f_out)
+@@ -780,6 +828,9 @@ int start_daemon(int f_in, int f_out)
  	if (protocol_version > remote_protocol)
  		protocol_version = remote_protocol;
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +retry:
 +#endif
  	line[0] = 0;
  	if (!read_line(f_in, line, sizeof line - 1))
  		return -1;
-@@ -791,6 +843,20 @@ int start_daemon(int f_in, int f_out)
+@@ -791,6 +842,20 @@ int start_daemon(int f_in, int f_out)
  		return -1;
  	}
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +	if (use_ssl && strcmp(line, "#starttls") == 0) {
 +		io_printf(f_out, "@RSYNCD: starttls\n");
 +		if (start_tls(f_in, f_out)) {
 +			rprintf(FLOG, "SSL connection failed: %s\n",
 +				get_ssl_error());
 +			return -1;
@@ -196,13 +191,13 @@
 +
  	if (*line == '#') {
  		/* it's some sort of command that I don't understand */
  		io_printf(f_out, "@ERROR: Unknown command '%s'\n", line);
 --- old/configure.in
 +++ new/configure.in
-@@ -282,6 +282,21 @@ if test x"$enable_locale" != x"no"; then
+@@ -290,6 +290,21 @@ if test x"$enable_locale" != x"no"; then
  	AC_DEFINE(CONFIG_LOCALE)
  fi
  
 +AC_ARG_ENABLE(openssl,
 +              AC_HELP_STRING([--enable-openssl], [compile SSL support with OpenSSL.]))
 +
@@ -220,113 +215,172 @@
 +
  AC_MSG_CHECKING([whether to call shutdown on all sockets])
  case $host_os in
  	*cygwin* ) AC_MSG_RESULT(yes)
 --- old/options.c
 +++ new/options.c
-@@ -166,6 +166,14 @@ int log_format_has_o_or_i = 0;
+@@ -173,6 +173,14 @@ int logfile_format_has_o_or_i = 0;
  int always_checksum = 0;
  int list_only = 0;
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +int use_ssl = 0;
 +char *ssl_cert_path = NULL;
 +char *ssl_key_path = NULL;
 +char *ssl_key_passwd = NULL;
 +char *ssl_ca_path = NULL;
 +#endif
 +
  #define MAX_BATCH_NAME_LEN 256	/* Must be less than MAXPATHLEN-13 */
  char *batch_name = NULL;
  
-@@ -194,6 +202,7 @@ static void print_rsync_version(enum log
+@@ -201,6 +209,7 @@ static void print_rsync_version(enum log
  	char const *hardlinks = "no ";
  	char const *links = "no ";
  	char const *ipv6 = "no ";
 +	char const *ssl = "no ";
  	STRUCT_STAT *dumstat;
  
  #ifdef HAVE_SOCKETPAIR
-@@ -216,6 +225,10 @@ static void print_rsync_version(enum log
+@@ -223,6 +232,10 @@ static void print_rsync_version(enum log
  	ipv6 = "";
  #endif
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +	ssl = "";
 +#endif
 +
  	rprintf(f, "%s  version %s  protocol version %d\n",
  		RSYNC_NAME, RSYNC_VERSION, PROTOCOL_VERSION);
  	rprintf(f, "Copyright (C) 1996-2006 by Andrew Tridgell, Wayne Davison, and others.\n");
-@@ -228,9 +241,9 @@ static void print_rsync_version(enum log
+@@ -235,9 +248,9 @@ static void print_rsync_version(enum log
  	/* Note that this field may not have type ino_t.  It depends
  	 * on the complicated interaction between largefile feature
  	 * macros. */
 -	rprintf(f, "              %sinplace, %sIPv6, "
 +	rprintf(f, "              %sinplace, %sIPv6, %sSSL, "
  		"%d-bit system inums, %d-bit internal inums\n",
 -		have_inplace, ipv6,
 +		have_inplace, ipv6, ssl,
  		(int) (sizeof dumstat->st_ino * 8),
  		(int) (sizeof (int64) * 8));
  #ifdef MAINTAINER_MODE
-@@ -371,6 +384,13 @@ void usage(enum logcode F)
+@@ -385,6 +398,13 @@ void usage(enum logcode F)
    rprintf(F," -4, --ipv4                  prefer IPv4\n");
    rprintf(F," -6, --ipv6                  prefer IPv6\n");
  #endif
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +  rprintf(F,"     --ssl                   allow socket connections to use SSL\n");
 +  rprintf(F,"     --ssl-cert=FILE         path to daemon's SSL certificate\n");
 +  rprintf(F,"     --ssl-key=FILE          path to daemon's SSL private key\n");
 +  rprintf(F,"     --ssl-key-passwd=PASS   password for PEM-encoded private key\n");
 +  rprintf(F,"     --ssl-ca-certs=FILE     path to trusted CA certificates\n");
 +#endif
    rprintf(F,"     --version               print version number\n");
    rprintf(F,"(-h) --help                  show this help (-h works with no other options)\n");
  
-@@ -383,7 +403,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
+@@ -398,7 +418,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
        OPT_FILTER, OPT_COMPARE_DEST, OPT_COPY_DEST, OPT_LINK_DEST, OPT_HELP,
        OPT_INCLUDE, OPT_INCLUDE_FROM, OPT_MODIFY_WINDOW, OPT_MIN_SIZE, OPT_CHMOD,
        OPT_READ_BATCH, OPT_WRITE_BATCH, OPT_ONLY_WRITE_BATCH, OPT_MAX_SIZE,
 -      OPT_NO_D,
 +      OPT_NO_D, OPT_USE_SSL,
        OPT_SERVER, OPT_REFUSED_BASE = 9000};
  
  static struct poptOption long_options[] = {
-@@ -524,6 +544,13 @@ static struct poptOption long_options[] 
+@@ -545,6 +565,13 @@ static struct poptOption long_options[] 
    {"checksum-seed",    0,  POPT_ARG_INT,    &checksum_seed, 0, 0, 0 },
    {"server",           0,  POPT_ARG_NONE,   0, OPT_SERVER, 0, 0 },
    {"sender",           0,  POPT_ARG_NONE,   0, OPT_SENDER, 0, 0 },
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +  {"ssl",              0,  POPT_ARG_NONE,   0, OPT_USE_SSL, 0, 0},
 +  {"ssl-cert",         0,  POPT_ARG_STRING, &ssl_cert_path, OPT_USE_SSL, 0, 0},
 +  {"ssl-key",          0,  POPT_ARG_STRING, &ssl_key_path, OPT_USE_SSL, 0, 0},
 +  {"ssl-key-passwd",   0,  POPT_ARG_STRING, &ssl_key_passwd, OPT_USE_SSL, 0, 0},
 +  {"ssl-ca-certs",     0,  POPT_ARG_STRING, &ssl_ca_path, OPT_USE_SSL, 0, 0},
 +#endif
    /* All the following options switch us into daemon-mode option-parsing. */
    {"config",           0,  POPT_ARG_STRING, 0, OPT_DAEMON, 0, 0 },
    {"daemon",           0,  POPT_ARG_NONE,   0, OPT_DAEMON, 0, 0 },
-@@ -1066,6 +1093,12 @@ int parse_arguments(int *argc, const cha
+@@ -572,6 +599,13 @@ static void daemon_usage(enum logcode F)
+   rprintf(F," -4, --ipv4                  prefer IPv4\n");
+   rprintf(F," -6, --ipv6                  prefer IPv6\n");
+ #endif
++#ifdef HAVE_OPENSSL
++  rprintf(F,"     --ssl                   allow socket connections to use SSL\n");
++  rprintf(F,"     --ssl-cert=FILE         path to daemon's SSL certificate\n");
++  rprintf(F,"     --ssl-key=FILE          path to daemon's SSL private key\n");
++  rprintf(F,"     --ssl-key-passwd=PASS   password for PEM-encoded private key\n");
++  rprintf(F,"     --ssl-ca-certs=FILE     path to trusted CA certificates\n");
++#endif
+   rprintf(F,"     --help                  show this help screen\n");
+ 
+   rprintf(F,"\n");
+@@ -598,6 +632,13 @@ static struct poptOption long_daemon_opt
+   {"protocol",         0,  POPT_ARG_INT,    &protocol_version, 0, 0, 0 },
+   {"server",           0,  POPT_ARG_NONE,   &am_server, 0, 0, 0 },
+   {"temp-dir",        'T', POPT_ARG_STRING, &tmpdir, 0, 0, 0 },
++#ifdef HAVE_OPENSSL
++  {"ssl",              0,  POPT_ARG_NONE,   0, OPT_USE_SSL, 0, 0},
++  {"ssl-cert",         0,  POPT_ARG_STRING, &ssl_cert_path, OPT_USE_SSL, 0, 0},
++  {"ssl-key",          0,  POPT_ARG_STRING, &ssl_key_path, OPT_USE_SSL, 0, 0},
++  {"ssl-key-passwd",   0,  POPT_ARG_STRING, &ssl_key_passwd, OPT_USE_SSL, 0, 0},
++  {"ssl-ca-certs",     0,  POPT_ARG_STRING, &ssl_ca_path, OPT_USE_SSL, 0, 0},
++#endif
+   {"verbose",         'v', POPT_ARG_NONE,   0, 'v', 0, 0 },
+   {"no-verbose",       0,  POPT_ARG_VAL,    &verbose, 0, 0, 0 },
+   {"no-v",             0,  POPT_ARG_VAL,    &verbose, 0, 0, 0 },
+@@ -855,6 +896,12 @@ int parse_arguments(int *argc, const cha
+ 					verbose++;
+ 					break;
+ 
++#ifdef HAVE_OPENSSL
++				case OPT_USE_SSL:
++					use_ssl = 1;
++					break;
++#endif
++
+ 				default:
+ 					rprintf(FERROR,
+ 					    "rsync: %s: %s (in daemon mode)\n",
+@@ -878,6 +925,17 @@ int parse_arguments(int *argc, const cha
+ 				exit_cleanup(RERR_SYNTAX);
+ 			}
+ 
++#ifdef HAVE_OPENSSL
++			if (use_ssl) {
++				if (init_tls()) {
++					snprintf(err_buf, sizeof(err_buf),
++						 "Openssl error: %s\n",
++						 get_ssl_error());
++					return 0;
++				}
++			}
++#endif
++
+ 			*argv = poptGetArgs(pc);
+ 			*argc = count_args(*argv);
+ 			am_starting_up = 0;
+@@ -1089,6 +1147,12 @@ int parse_arguments(int *argc, const cha
  			usage(FINFO);
  			exit_cleanup(0);
  
++#ifdef HAVE_OPENSSL
 +		case OPT_USE_SSL:
-+#if HAVE_OPENSSL
 +			use_ssl = 1;
-+#endif
 +			break;
++#endif
 +
  		default:
  			/* A large opt value means that set_refuse_options()
  			 * turned this option off. */
-@@ -1343,6 +1376,17 @@ int parse_arguments(int *argc, const cha
+@@ -1365,6 +1429,17 @@ int parse_arguments(int *argc, const cha
  	if (delay_updates && !partial_dir)
  		partial_dir = tmp_partialdir;
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +	if (use_ssl) {
 +		if (init_tls()) {
 +			snprintf(err_buf, sizeof(err_buf),
 +				 "Openssl error: %s\n",
 +				 get_ssl_error());
 +			return 0;
@@ -334,23 +388,23 @@
 +	}
 +#endif
 +
  	if (inplace) {
  #ifdef HAVE_FTRUNCATE
  		if (partial_dir) {
-@@ -1756,11 +1800,28 @@ char *check_for_hostspec(char *s, char *
- {
+@@ -1782,10 +1857,27 @@ char *check_for_hostspec(char *s, char *
  	char *p;
  	int not_host;
+ 	int hostlen;
 +	int url_prefix_len = sizeof URL_PREFIX - 1;
  
 -	if (port_ptr && strncasecmp(URL_PREFIX, s, strlen(URL_PREFIX)) == 0) {
 +	if (!port_ptr)
 +		url_prefix_len = 0;
 +	else if (strncasecmp(URL_PREFIX, s, url_prefix_len) != 0) {
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +		url_prefix_len = sizeof SSL_URL_PREFIX - 1;
 +		if (strncasecmp(SSL_URL_PREFIX, s, url_prefix_len) != 0)
 +			url_prefix_len = 0;
 +		else {
 +			if (!use_ssl)
 +				init_tls();
@@ -359,13 +413,12 @@
 +#else
 +		url_prefix_len = 0;
 +#endif
 +	}
 +	if (url_prefix_len) {
  		char *path;
- 		int hostlen;
 -		s += strlen(URL_PREFIX);
 +		s += url_prefix_len;
  		if ((p = strchr(s, '/')) != NULL) {
  			hostlen = p - s;
  			path = p + 1;
 --- old/rsync.h
@@ -375,27 +428,27 @@
  #define DEFAULT_LOCK_FILE "/var/run/rsyncd.lock"
  #define URL_PREFIX "rsync://"
 +#define SSL_URL_PREFIX "rsyncs://"
  
  #define BACKUP_SUFFIX "~"
  
-@@ -412,6 +413,11 @@ enum msgcode {
+@@ -419,6 +420,11 @@ enum msgcode {
  # define SIZEOF_INT64 SIZEOF_OFF_T
  #endif
  
-+#if HAVE_OPENSSL
++#ifdef HAVE_OPENSSL
 +#include <openssl/ssl.h>
 +#include <openssl/err.h>
 +#endif
 +
  /* Starting from protocol version 26, we always use 64-bit
   * ino_t and dev_t internally, even if this platform does not
   * allow files to have 64-bit inums.  That's because the
 --- old/ssl.c
 +++ new/ssl.c
-@@ -0,0 +1,366 @@
+@@ -0,0 +1,370 @@
 +/* -*- c-file-style: "linux" -*-
 + * ssl.c: operations for negotiating SSL rsync connections. 
 + *
 + * Copyright (C) 2003  Casey Marshall <rsdio@metastatic.org>
 + *
 + * This program is free software; you can redistribute it and/or modify
@@ -412,13 +465,13 @@
 + * along with this program; if not, write to the Free Software
 + * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 + */
 +
 +#include "rsync.h"
 +
-+#if HAVE_SYS_SELECT_H
++#ifdef HAVE_SYS_SELECT_H
 +#include <sys/select.h>
 +#else
 +#include <sys/time.h>
 +#include <sys/types.h>
 +#include <unistd.h>
 +#endif
@@ -439,12 +492,16 @@
 +static SSL *ssl;
 +static int tls_read[2] = { -1, -1 };
 +static int tls_write[2] = { -1, -1 };
 +static int ssl_running;
 +static int ssl_pid = -1;
 +
++#ifdef HAVE_SIGACTION
++static struct sigaction sigact;
++#endif
++
 +/**
 + * A non-interactive callback to be passed to SSL_CTX_set_default_password_cb,
 + * which merely copies the value of ssl_key_passwd into buf. This is
 + * used for when the private key password is supplied via an option.
 + */
 +static int default_password_cb(char *buf, int n, UNUSED(int f), UNUSED(void *u))
@@ -627,13 +684,13 @@
 +	if (ssl_pid != 0) {
 +		close(tls_write[0]);
 +		close(tls_read[1]);
 +		return 0;
 +	}
 +
-+	signal(SIGUSR1, tls_sigusr1);
++	SIGACTION(SIGUSR1, tls_sigusr1);
 +	ssl = SSL_new(ssl_ctx);
 +	if (!ssl)
 +		goto closed;
 +	if (am_daemon || am_server)
 +		SSL_set_accept_state(ssl);
 +	else
@@ -773,106 +830,119 @@
 +void end_tls(void);
  int do_unlink(const char *fname);
  int do_symlink(const char *fname1, const char *fname2);
  int do_link(const char *fname1, const char *fname2);
 --- old/configure
 +++ new/configure
-@@ -309,7 +309,7 @@ ac_includes_default="\
- # include <unistd.h>
- #endif"
- 
--ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
-+ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH SSL_OBJS LIBOBJS ALLOCA OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
- ac_subst_files=''
- 
- # Initialize some variables set by options.
-@@ -852,6 +852,7 @@ Optional Features:
+@@ -662,6 +662,7 @@ INSTALL_PROGRAM
+ INSTALL_SCRIPT
+ INSTALL_DATA
+ HAVE_REMSH
++SSL_OBJS
+ LIBOBJS
+ ALLOCA
+ OBJ_SAVE
+@@ -1258,6 +1259,7 @@ Optional Features:
    --disable-largefile     omit support for large files
    --disable-ipv6          don't even try to use IPv6
    --disable-locale        turn off locale features
 +  --enable-openssl        compile SSL support with OpenSSL.
  
  Optional Packages:
    --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-@@ -3668,6 +3669,102 @@ _ACEOF
+@@ -4827,6 +4829,116 @@ _ACEOF
  
  fi
  
-+# Check whether --enable-openssl or --disable-openssl was given.
++# Check whether --enable-openssl was given.
 +if test "${enable_openssl+set}" = set; then
-+  enableval="$enable_openssl"
++  enableval=$enable_openssl;
++fi
 +
-+fi;
 +
 +if test "x$enable_openssl" != xno
 +then
 +	have_ssl=yes
 +
-+echo "$as_me:$LINENO: checking for SSL_library_init in -lssl" >&5
-+echo $ECHO_N "checking for SSL_library_init in -lssl... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking for SSL_library_init in -lssl" >&5
++echo $ECHO_N "checking for SSL_library_init in -lssl... $ECHO_C" >&6; }
 +if test "${ac_cv_lib_ssl_SSL_library_init+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_check_lib_save_LIBS=$LIBS
 +LIBS="-lssl  $LIBS"
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char SSL_library_init ();
 +int
 +main ()
 +{
-+SSL_library_init ();
++return SSL_library_init ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_cv_lib_ssl_SSL_library_init=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_cv_lib_ssl_SSL_library_init=no
++	ac_cv_lib_ssl_SSL_library_init=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +LIBS=$ac_check_lib_save_LIBS
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_lib_ssl_SSL_library_init" >&5
-+echo "${ECHO_T}$ac_cv_lib_ssl_SSL_library_init" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_lib_ssl_SSL_library_init" >&5
++echo "${ECHO_T}$ac_cv_lib_ssl_SSL_library_init" >&6; }
 +if test $ac_cv_lib_ssl_SSL_library_init = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define HAVE_LIBSSL 1
 +_ACEOF
 +
 +  LIBS="-lssl $LIBS"
@@ -890,36 +960,45 @@
 +
 +		SSL_OBJS=ssl.o
 +
 +	fi
 +fi
 +
- echo "$as_me:$LINENO: checking whether to call shutdown on all sockets" >&5
- echo $ECHO_N "checking whether to call shutdown on all sockets... $ECHO_C" >&6
+ { echo "$as_me:$LINENO: checking whether to call shutdown on all sockets" >&5
+ echo $ECHO_N "checking whether to call shutdown on all sockets... $ECHO_C" >&6; }
  case $host_os in
-@@ -12753,6 +12850,7 @@ s,@INSTALL_PROGRAM@,$INSTALL_PROGRAM,;t 
- s,@INSTALL_SCRIPT@,$INSTALL_SCRIPT,;t t
- s,@INSTALL_DATA@,$INSTALL_DATA,;t t
- s,@HAVE_REMSH@,$HAVE_REMSH,;t t
-+s,@SSL_OBJS@,$SSL_OBJS,;t t
- s,@LIBOBJS@,$LIBOBJS,;t t
- s,@ALLOCA@,$ALLOCA,;t t
- s,@OBJ_SAVE@,$OBJ_SAVE,;t t
+@@ -15481,6 +15593,7 @@ INSTALL_PROGRAM!$INSTALL_PROGRAM$ac_deli
+ INSTALL_SCRIPT!$INSTALL_SCRIPT$ac_delim
+ INSTALL_DATA!$INSTALL_DATA$ac_delim
+ HAVE_REMSH!$HAVE_REMSH$ac_delim
++SSL_OBJS!$SSL_OBJS$ac_delim
+ LIBOBJS!$LIBOBJS$ac_delim
+ ALLOCA!$ALLOCA$ac_delim
+ OBJ_SAVE!$OBJ_SAVE$ac_delim
+@@ -15490,7 +15603,7 @@ BUILD_POPT!$BUILD_POPT$ac_delim
+ LTLIBOBJS!$LTLIBOBJS$ac_delim
+ _ACEOF
+ 
+-  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 71; then
++  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 72; then
+     break
+   elif $ac_last_try; then
+     { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
 --- old/config.h.in
 +++ new/config.h.in
 @@ -164,6 +164,9 @@
  /* Define to 1 if you have the `socket' library (-lsocket). */
  #undef HAVE_LIBSOCKET
  
 +/* Define to 1 if you have the `ssl' library (-lssl). */
 +#undef HAVE_LIBSSL
 +
  /* Define to 1 if you have the <limits.h> header file. */
  #undef HAVE_LIMITS_H
  
-@@ -225,6 +228,9 @@
+@@ -229,6 +232,9 @@
  /* Define to 1 if you have the `open64' function. */
  #undef HAVE_OPEN64
  
 +/* true if you want to use SSL. */
 +#undef HAVE_OPENSSL
 +
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/slow-down.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/slow-down.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/slow-down.diff	2006-04-22 00:58:13.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/slow-down.diff	2006-11-02 05:33:37.000000000 +0800
@@ -5,52 +5,58 @@
 
 The idea is to lessen rsync's impact on disk I/O.  Unfortunately, there
 should really be a way to affect more of rsync's processing, perhaps by
 specifying a maximum disk I/O rate (and have that affect a maximum stat()
 rate or something like that).
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/slow-down.diff
+    ./configure                           (optional if already run)
+    make
+
 --- old/flist.c
 +++ new/flist.c
-@@ -57,6 +57,7 @@ extern int copy_links;
+@@ -53,6 +53,7 @@ extern int copy_links;
  extern int copy_unsafe_links;
  extern int protocol_version;
  extern int sanitize_paths;
 +extern unsigned long sleep_asec;
  extern struct stats stats;
  extern struct file_list *the_file_list;
  
-@@ -1043,6 +1044,9 @@ static void send_directory(int f, struct
+@@ -1036,6 +1037,9 @@ static void send_directory(int f, struct
  		}
  
  		send_file_name(f, flist, fbuf, NULL, 0);
 +		/* Sleep for a bit, to avoid hammering the disk. */
 +		if (sleep_asec)
 +			usleep(sleep_asec);
  	}
  
  	fbuf[len] = '\0';
 --- old/options.c
 +++ new/options.c
-@@ -100,6 +100,7 @@ int size_only = 0;
+@@ -102,6 +102,7 @@ int size_only = 0;
  int daemon_bwlimit = 0;
  int bwlimit = 0;
  int fuzzy_basis = 0;
 +unsigned long sleep_asec = 0;
  size_t bwlimit_writemax = 0;
  int ignore_existing = 0;
  int ignore_non_existing = 0;
-@@ -363,6 +364,7 @@ void usage(enum logcode F)
+@@ -377,6 +378,7 @@ void usage(enum logcode F)
    rprintf(F,"     --password-file=FILE    read password from FILE\n");
    rprintf(F,"     --list-only             list the files instead of copying them\n");
    rprintf(F,"     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second\n");
 +  rprintf(F,"     --slow-down=USECs       sleep N usec while creating the filelist\n");
    rprintf(F,"     --write-batch=FILE      write a batched update to FILE\n");
    rprintf(F,"     --only-write-batch=FILE like --write-batch but w/o updating destination\n");
    rprintf(F,"     --read-batch=FILE       read a batched update from FILE\n");
-@@ -495,6 +497,7 @@ static struct poptOption long_options[] 
-   {"log-format",       0,  POPT_ARG_STRING, &log_format, 0, 0, 0 },
+@@ -516,6 +518,7 @@ static struct poptOption long_options[] 
+   {"log-format",       0,  POPT_ARG_STRING, &stdout_format, 0, 0, 0 }, /* DEPRECATED */
    {"itemize-changes", 'i', POPT_ARG_NONE,   0, 'i', 0, 0 },
    {"bwlimit",          0,  POPT_ARG_INT,    &bwlimit, 0, 0, 0 },
 +  {"slow-down",        0,  POPT_ARG_LONG,   &sleep_asec, 0, 0, 0 },
    {"backup",          'b', POPT_ARG_NONE,   &make_backups, 0, 0, 0 },
    {"backup-dir",       0,  POPT_ARG_STRING, &backup_dir, 0, 0, 0 },
    {"suffix",           0,  POPT_ARG_STRING, &backup_suffix, 0, 0, 0 },
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/slp.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/slp.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/slp.diff	2006-04-22 23:54:09.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/slp.diff	2006-11-07 12:43:47.000000000 +0800
@@ -1,38 +1,39 @@
 This adds Service Location Protocol support.
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/slp.diff
     ./prepare-source
     ./configure --enable-slp
     make
 
 TODO: the configure changes should abort if the user requests --enable-slp
 and we can't honor that request.
 
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -12,6 +12,8 @@ CFLAGS=@CFLAGS@
+@@ -13,6 +13,8 @@ CFLAGS=@CFLAGS@
  CPPFLAGS=@CPPFLAGS@
  EXEEXT=@EXEEXT@
  LDFLAGS=@LDFLAGS@
 +LIBSLP=@LIBSLP@
 +SLPOBJ=@SLPOBJ@
  
  INSTALLCMD=@INSTALL@
  INSTALLMAN=@INSTALL@
-@@ -35,7 +37,7 @@ OBJS1=rsync.o generator.o receiver.o cle
+@@ -36,7 +38,7 @@ OBJS1=rsync.o generator.o receiver.o cle
  OBJS2=options.o flist.o io.o compat.o hlink.o token.o uidlist.o socket.o \
  	fileio.o batch.o clientname.o chmod.o
  OBJS3=progress.o pipe.o
 -DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o
 +DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o $(SLPOBJ)
  popt_OBJS=popt/findme.o  popt/popt.o  popt/poptconfig.o \
  	popt/popthelp.o popt/poptparse.o
  OBJS=$(OBJS1) $(OBJS2) $(OBJS3) $(DAEMON_OBJ) $(LIBOBJ) $(ZLIBOBJ) @BUILD_POPT@
-@@ -69,7 +71,7 @@ install-strip:
+@@ -70,7 +72,7 @@ install-strip:
  	$(MAKE) INSTALL_STRIP='-s' install
  
  rsync$(EXEEXT): $(OBJS)
 -	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)
 +	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(LIBS) $(LIBSLP)
  
@@ -53,13 +54,13 @@
 +
  	if (((pid_file = lp_pid_file()) != NULL) && (*pid_file != '\0')) {
  		char pidbuf[16];
  		int fd;
 --- old/configure.in
 +++ new/configure.in
-@@ -559,6 +559,29 @@ if test $rsync_cv_can_hardlink_special =
+@@ -592,6 +592,29 @@ if test $rsync_cv_can_hardlink_special =
      AC_DEFINE(CAN_HARDLINK_SPECIAL, 1, [Define to 1 if link() can hard-link special files.])
  fi
  
 +AC_ARG_ENABLE(slp, [  --disable-slp           turn off SLP support, defaults to on])
 +AC_ARG_WITH(openslp-libs, [  --with-openslp-libs     set directory for OpenSLP library],
 +    LDFLAGS="-L$withval $LDFLAGS"
@@ -85,45 +86,45 @@
 +
  AC_CACHE_CHECK([for working socketpair],rsync_cv_HAVE_SOCKETPAIR,[
  AC_TRY_RUN([
  #include <sys/types.h>
 --- old/loadparm.c
 +++ new/loadparm.c
-@@ -105,6 +105,9 @@ typedef struct
+@@ -108,6 +108,9 @@ typedef struct
  	char *socket_options;
  
  	int rsync_port;
 +#ifdef HAVE_LIBSLP
 +	int slp_refresh;
 +#endif
- 	int syslog_facility;
  } global;
  
-@@ -286,6 +289,9 @@ static struct parm_struct parm_table[] =
+ static global Globals;
+@@ -291,6 +294,9 @@ static struct parm_struct parm_table[] =
   {"motd file",         P_STRING, P_GLOBAL,&Globals.motd_file,          NULL,0},
   {"pid file",          P_STRING, P_GLOBAL,&Globals.pid_file,           NULL,0},
   {"port",              P_INTEGER,P_GLOBAL,&Globals.rsync_port,         NULL,0},
 +#ifdef HAVE_LIBSLP
 + {"slp refresh",       P_INTEGER,P_GLOBAL,&Globals.slp_refresh,        NULL,0},
 +#endif
   {"socket options",    P_STRING, P_GLOBAL,&Globals.socket_options,     NULL,0},
-  {"syslog facility",   P_ENUM,   P_GLOBAL,&Globals.syslog_facility,enum_facilities,0},
  
-@@ -379,6 +385,9 @@ FN_GLOBAL_STRING(lp_pid_file, &Globals.p
+  {"auth users",        P_STRING, P_LOCAL, &sDefault.auth_users,        NULL,0},
+@@ -381,6 +387,9 @@ FN_GLOBAL_STRING(lp_pid_file, &Globals.p
  FN_GLOBAL_STRING(lp_socket_options, &Globals.socket_options)
  
  FN_GLOBAL_INTEGER(lp_rsync_port, &Globals.rsync_port)
 +#ifdef HAVE_LIBSLP
 +FN_GLOBAL_INTEGER(lp_slp_refresh, &Globals.slp_refresh)
 +#endif
- FN_GLOBAL_INTEGER(lp_syslog_facility, &Globals.syslog_facility)
  
  FN_LOCAL_STRING(lp_auth_users, auth_users)
+ FN_LOCAL_STRING(lp_comment, comment)
 --- old/main.c
 +++ new/main.c
-@@ -971,6 +971,18 @@ static int start_client(int argc, char *
+@@ -1058,6 +1058,18 @@ static int start_client(int argc, char *
  
  	if (!read_batch) { /* for read_batch, NO source is specified */
  		shell_path = check_for_hostspec(argv[0], &shell_machine, &rsync_port);
 +
 +		if (shell_machine && !shell_machine[0]) {
 +#ifdef HAVE_LIBSLP
@@ -138,32 +139,32 @@
 +
  		if (shell_path) { /* source is remote */
  			char *dummy1;
  			int dummy2;
 --- old/options.c
 +++ new/options.c
-@@ -194,6 +194,7 @@ static void print_rsync_version(enum log
+@@ -201,6 +201,7 @@ static void print_rsync_version(enum log
  	char const *hardlinks = "no ";
  	char const *links = "no ";
  	char const *ipv6 = "no ";
 +	char const *slp = "no ";
  	STRUCT_STAT *dumstat;
  
  #ifdef HAVE_SOCKETPAIR
-@@ -216,6 +217,10 @@ static void print_rsync_version(enum log
+@@ -223,6 +224,10 @@ static void print_rsync_version(enum log
  	ipv6 = "";
  #endif
  
 +#if HAVE_LIBSLP
 +	slp = "";
 +#endif
 +
  	rprintf(f, "%s  version %s  protocol version %d\n",
  		RSYNC_NAME, RSYNC_VERSION, PROTOCOL_VERSION);
  	rprintf(f, "Copyright (C) 1996-2006 by Andrew Tridgell, Wayne Davison, and others.\n");
-@@ -228,9 +233,9 @@ static void print_rsync_version(enum log
+@@ -235,9 +240,9 @@ static void print_rsync_version(enum log
  	/* Note that this field may not have type ino_t.  It depends
  	 * on the complicated interaction between largefile feature
  	 * macros. */
 -	rprintf(f, "              %sinplace, %sIPv6, "
 +	rprintf(f, "              %sinplace, %sIPv6, %sSLP, "
  		"%d-bit system inums, %d-bit internal inums\n",
@@ -171,22 +172,22 @@
 +		have_inplace, ipv6, slp,
  		(int) (sizeof dumstat->st_ino * 8),
  		(int) (sizeof (int64) * 8));
  #ifdef MAINTAINER_MODE
 --- old/rsync.h
 +++ new/rsync.h
-@@ -156,6 +156,9 @@
+@@ -157,6 +157,9 @@
  #define SIGNIFICANT_ITEM_FLAGS (~(\
  	ITEM_BASIS_TYPE_FOLLOWS | ITEM_XNAME_FOLLOWS | ITEM_LOCAL_CHANGE))
  
 +/* this is the minimum we'll use, irrespective of config setting */
 +/* definately don't set to less than about 30 seconds */
 +#define SLP_MIN_TIMEOUT 120
  
- /* Log-message categories.  Only FERROR and FINFO get sent over the socket.
-  * FLOG and FCLIENT are only used on the daemon side for custom logging,
+ /* Log-message categories.  Only FERROR and FINFO get sent over the socket,
+  * but FLOG and FSOCKERR can be sent over the receiver -> generator pipe.
 --- old/rsync.yo
 +++ new/rsync.yo
 @@ -139,7 +139,12 @@ particular rsync daemon by leaving off t
  
  quote(tt(rsync somehost.mydomain.com::))
  
@@ -205,13 +206,13 @@
 @@ -0,0 +1,3 @@
 +
 +slp refresh = 300
 +
 --- old/rsyncd.conf.yo
 +++ new/rsyncd.conf.yo
-@@ -119,6 +119,15 @@ details on some of the options you may b
+@@ -103,6 +103,15 @@ details on some of the options you may b
  special socket options are set.  These settings are superseded by the
  bf(--sockopts) command-line option.
  
 +dit(bf(slp refresh)) This option is used to determine how long service
 +advertisements are valid (measured in seconds), and is only applicable if
 +you have Service Location Protocol support compiled in. If this option is
@@ -221,23 +222,23 @@
 +Using 3600 (one hour) is a good number if you tend to change your
 +configuration.
 +
  enddit()
  
  
-@@ -543,6 +552,7 @@ use chroot = no
+@@ -556,6 +565,7 @@ use chroot = no
  max connections = 4
  syslog facility = local5
  pid file = /var/run/rsyncd.pid
 +slp refresh = 3600
  
  [ftp]
          path = /var/ftp/pub
 --- old/socket.c
 +++ new/socket.c
-@@ -471,6 +471,16 @@ void start_accept_loop(int port, int (*f
+@@ -466,6 +466,16 @@ void start_accept_loop(int port, int (*f
  {
  	fd_set deffds;
  	int *sp, maxfd, i;
 +#ifdef HAVE_LIBSLP
 +	time_t next_slp_refresh;
 +	short slp_timeout = lp_slp_refresh();
@@ -248,13 +249,13 @@
 +		slp_timeout -= 15;
 +	}
 +#endif
  
  #ifdef HAVE_SIGACTION
  	sigact.sa_flags = SA_NOCLDSTOP;
-@@ -499,14 +509,25 @@ void start_accept_loop(int port, int (*f
+@@ -494,14 +504,25 @@ void start_accept_loop(int port, int (*f
  			maxfd = sp[i];
  	}
  
 +#ifdef HAVE_LIBSLP
 +	next_slp_refresh = time(NULL) + slp_timeout;
 +#endif
@@ -274,13 +275,13 @@
 +		slp_tv.tv_sec = 10;
 +		slp_tv.tv_usec = 0;
 +#endif
  
  		/* close log file before the potentially very long select so
  		 * file can be trimmed by another process instead of growing
-@@ -518,8 +539,18 @@ void start_accept_loop(int port, int (*f
+@@ -513,8 +534,18 @@ void start_accept_loop(int port, int (*f
  #else
  		fds = deffds;
  #endif
 -
 -		if (select(maxfd + 1, &fds, NULL, NULL, NULL) != 1)
 +#ifdef HAVE_LIBSLP
@@ -534,152 +535,171 @@
 +
 +	/* refresh is done in main select loop */
 +	return 0;
 +}
 --- old/proto.h
 +++ new/proto.h
-@@ -146,6 +146,7 @@ char *lp_motd_file(void);
+@@ -145,6 +145,7 @@ char *lp_motd_file(void);
  char *lp_pid_file(void);
  char *lp_socket_options(void);
  int lp_rsync_port(void);
 +int lp_slp_refresh(void);
- int lp_syslog_facility(void);
  char *lp_auth_users(int );
  char *lp_comment(int );
+ char *lp_dont_compress(int );
 @@ -246,6 +247,8 @@ void start_accept_loop(int port, int (*f
  void set_socket_options(int fd, char *options);
  void become_daemon(void);
  int sock_exec(const char *prog);
 +int print_service_list(void);
 +int register_services(void);
  int do_unlink(const char *fname);
  int do_symlink(const char *fname1, const char *fname2);
  int do_link(const char *fname1, const char *fname2);
 --- old/configure
 +++ new/configure
-@@ -309,7 +309,7 @@ ac_includes_default="\
- # include <unistd.h>
- #endif"
- 
--ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
-+ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS RSYNC_VERSION build build_cpu build_vendor build_os host host_cpu host_vendor host_os target target_cpu target_vendor target_os CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT CPP EGREP INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA HAVE_REMSH LIBOBJS ALLOCA LIBSLP SLPOBJ OBJ_SAVE OBJ_RESTORE CC_SHOBJ_FLAG BUILD_POPT LTLIBOBJS'
- ac_subst_files=''
- 
- # Initialize some variables set by options.
-@@ -852,6 +852,7 @@ Optional Features:
+@@ -664,6 +664,8 @@ INSTALL_DATA
+ HAVE_REMSH
+ LIBOBJS
+ ALLOCA
++LIBSLP
++SLPOBJ
+ OBJ_SAVE
+ OBJ_RESTORE
+ CC_SHOBJ_FLAG
+@@ -1258,6 +1260,7 @@ Optional Features:
    --disable-largefile     omit support for large files
    --disable-ipv6          don't even try to use IPv6
    --disable-locale        turn off locale features
 +  --disable-slp           turn off SLP support, defaults to on
  
  Optional Packages:
    --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-@@ -861,6 +862,8 @@ Optional Packages:
-   --with-rsyncd-conf=PATH set configuration file for rsync server to PATH
-                           (default: /etc/rsyncd.conf)
-   --with-rsh=CMD          set remote shell command to CMD (default: ssh)
+@@ -1270,6 +1273,8 @@ Optional Packages:
+   --with-nobody-group=GROUP
+                           set the default unprivileged group (default nobody
+                           or nogroup)
 +  --with-openslp-libs     set directory for OpenSLP library
 +  --with-openslp-includes set directory for OpenSLP includes
  
  Some influential environment variables:
    CC          C compiler command
-@@ -11423,6 +11426,249 @@ _ACEOF
+@@ -13999,6 +14004,276 @@ _ACEOF
  
  fi
  
-+# Check whether --enable-slp or --disable-slp was given.
++# Check whether --enable-slp was given.
 +if test "${enable_slp+set}" = set; then
-+  enableval="$enable_slp"
++  enableval=$enable_slp;
++fi
 +
-+fi;
 +
-+# Check whether --with-openslp-libs or --without-openslp-libs was given.
++# Check whether --with-openslp-libs was given.
 +if test "${with_openslp_libs+set}" = set; then
-+  withval="$with_openslp_libs"
-+  LDFLAGS="-L$withval $LDFLAGS"
++  withval=$with_openslp_libs; LDFLAGS="-L$withval $LDFLAGS"
 +    DSOFLAGS="-L$withval $DSOFLAGS"
-+fi;
++fi
++
 +
-+# Check whether --with-openslp-includes or --without-openslp-includes was given.
++# Check whether --with-openslp-includes was given.
 +if test "${with_openslp_includes+set}" = set; then
-+  withval="$with_openslp_includes"
-+  CFLAGS="-I$withval $CFLAGS"
++  withval=$with_openslp_includes; CFLAGS="-I$withval $CFLAGS"
 +    CXXFLAGS="-I$withval $CXXFLAGS"
 +    CPPFLAGS="-I$withval $CPPFLAGS"
-+fi;
++fi
++
 +
 +LIBSLP=""
 +SLPOBJ=""
 +
 +if test x$enable_slp != xno; then
 +    if test "${ac_cv_header_slp_h+set}" = set; then
-+  echo "$as_me:$LINENO: checking for slp.h" >&5
-+echo $ECHO_N "checking for slp.h... $ECHO_C" >&6
++  { echo "$as_me:$LINENO: checking for slp.h" >&5
++echo $ECHO_N "checking for slp.h... $ECHO_C" >&6; }
 +if test "${ac_cv_header_slp_h+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_header_slp_h" >&5
-+echo "${ECHO_T}$ac_cv_header_slp_h" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_header_slp_h" >&5
++echo "${ECHO_T}$ac_cv_header_slp_h" >&6; }
 +else
 +  # Is the header compilable?
-+echo "$as_me:$LINENO: checking slp.h usability" >&5
-+echo $ECHO_N "checking slp.h usability... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking slp.h usability" >&5
++echo $ECHO_N "checking slp.h usability... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +$ac_includes_default
 +#include <slp.h>
 +_ACEOF
 +rm -f conftest.$ac_objext
-+if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-+  (eval $ac_compile) 2>conftest.er1
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest.$ac_objext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_header_compiler=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_header_compiler=no
++	ac_header_compiler=no
 +fi
-+rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-+echo "${ECHO_T}$ac_header_compiler" >&6
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
 +
 +# Is the header present?
-+echo "$as_me:$LINENO: checking slp.h presence" >&5
-+echo $ECHO_N "checking slp.h presence... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking slp.h presence" >&5
++echo $ECHO_N "checking slp.h presence... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +#include <slp.h>
 +_ACEOF
-+if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } >/dev/null; then
@@ -697,15 +717,16 @@
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
 +  ac_header_preproc=no
 +fi
++
 +rm -f conftest.err conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-+echo "${ECHO_T}$ac_header_preproc" >&6
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
 +
 +# So?  What about this header?
 +case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
 +  yes:no: )
 +    { echo "$as_me:$LINENO: WARNING: slp.h: accepted by the compiler, rejected by the preprocessor!" >&5
 +echo "$as_me: WARNING: slp.h: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -723,97 +744,104 @@
 +    { echo "$as_me:$LINENO: WARNING: slp.h:     section \"Present But Cannot Be Compiled\"" >&5
 +echo "$as_me: WARNING: slp.h:     section \"Present But Cannot Be Compiled\"" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: slp.h: proceeding with the preprocessor's result" >&5
 +echo "$as_me: WARNING: slp.h: proceeding with the preprocessor's result" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: slp.h: in the future, the compiler will take precedence" >&5
 +echo "$as_me: WARNING: slp.h: in the future, the compiler will take precedence" >&2;}
-+    (
-+      cat <<\_ASBOX
-+## ------------------------------------------ ##
-+## Report this to the AC_PACKAGE_NAME lists.  ##
-+## ------------------------------------------ ##
-+_ASBOX
-+    ) |
-+      sed "s/^/$as_me: WARNING:     /" >&2
++
 +    ;;
 +esac
-+echo "$as_me:$LINENO: checking for slp.h" >&5
-+echo $ECHO_N "checking for slp.h... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking for slp.h" >&5
++echo $ECHO_N "checking for slp.h... $ECHO_C" >&6; }
 +if test "${ac_cv_header_slp_h+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_cv_header_slp_h=$ac_header_preproc
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_header_slp_h" >&5
-+echo "${ECHO_T}$ac_cv_header_slp_h" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_header_slp_h" >&5
++echo "${ECHO_T}$ac_cv_header_slp_h" >&6; }
 +
 +fi
 +if test $ac_cv_header_slp_h = yes; then
-+  echo "$as_me:$LINENO: checking for SLPOpen in -lslp" >&5
-+echo $ECHO_N "checking for SLPOpen in -lslp... $ECHO_C" >&6
++  { echo "$as_me:$LINENO: checking for SLPOpen in -lslp" >&5
++echo $ECHO_N "checking for SLPOpen in -lslp... $ECHO_C" >&6; }
 +if test "${ac_cv_lib_slp_SLPOpen+set}" = set; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  ac_check_lib_save_LIBS=$LIBS
 +LIBS="-lslp  $LIBS"
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +
-+/* Override any gcc2 internal prototype to avoid an error.  */
++/* Override any GCC internal prototype to avoid an error.
++   Use char because int might match the return type of a GCC
++   builtin and then its argument prototype would still apply.  */
 +#ifdef __cplusplus
 +extern "C"
 +#endif
-+/* We use char because int might match the return type of a gcc2
-+   builtin and then its argument prototype would still apply.  */
 +char SLPOpen ();
 +int
 +main ()
 +{
-+SLPOpen ();
++return SLPOpen ();
 +  ;
 +  return 0;
 +}
 +_ACEOF
 +rm -f conftest.$ac_objext conftest$ac_exeext
-+if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-+  (eval $ac_link) 2>conftest.er1
++if { (ac_try="$ac_link"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_link") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest$ac_exeext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_cv_lib_slp_SLPOpen=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_cv_lib_slp_SLPOpen=no
++	ac_cv_lib_slp_SLPOpen=no
 +fi
-+rm -f conftest.err conftest.$ac_objext \
++
++rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
 +      conftest$ac_exeext conftest.$ac_ext
 +LIBS=$ac_check_lib_save_LIBS
 +fi
-+echo "$as_me:$LINENO: result: $ac_cv_lib_slp_SLPOpen" >&5
-+echo "${ECHO_T}$ac_cv_lib_slp_SLPOpen" >&6
++{ echo "$as_me:$LINENO: result: $ac_cv_lib_slp_SLPOpen" >&5
++echo "${ECHO_T}$ac_cv_lib_slp_SLPOpen" >&6; }
 +if test $ac_cv_lib_slp_SLPOpen = yes; then
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_LIBSLP 1
 +_ACEOF
 +
@@ -826,24 +854,33 @@
 +
 +fi
 +
 +
 +
 +
- echo "$as_me:$LINENO: checking for working socketpair" >&5
- echo $ECHO_N "checking for working socketpair... $ECHO_C" >&6
+ { echo "$as_me:$LINENO: checking for working socketpair" >&5
+ echo $ECHO_N "checking for working socketpair... $ECHO_C" >&6; }
  if test "${rsync_cv_HAVE_SOCKETPAIR+set}" = set; then
-@@ -12755,6 +13001,8 @@ s,@INSTALL_DATA@,$INSTALL_DATA,;t t
- s,@HAVE_REMSH@,$HAVE_REMSH,;t t
- s,@LIBOBJS@,$LIBOBJS,;t t
- s,@ALLOCA@,$ALLOCA,;t t
-+s,@LIBSLP@,$LIBSLP,;t t
-+s,@SLPOBJ@,$SLPOBJ,;t t
- s,@OBJ_SAVE@,$OBJ_SAVE,;t t
- s,@OBJ_RESTORE@,$OBJ_RESTORE,;t t
- s,@CC_SHOBJ_FLAG@,$CC_SHOBJ_FLAG,;t t
+@@ -15483,6 +15758,8 @@ INSTALL_DATA!$INSTALL_DATA$ac_delim
+ HAVE_REMSH!$HAVE_REMSH$ac_delim
+ LIBOBJS!$LIBOBJS$ac_delim
+ ALLOCA!$ALLOCA$ac_delim
++LIBSLP!$LIBSLP$ac_delim
++SLPOBJ!$SLPOBJ$ac_delim
+ OBJ_SAVE!$OBJ_SAVE$ac_delim
+ OBJ_RESTORE!$OBJ_RESTORE$ac_delim
+ CC_SHOBJ_FLAG!$CC_SHOBJ_FLAG$ac_delim
+@@ -15490,7 +15767,7 @@ BUILD_POPT!$BUILD_POPT$ac_delim
+ LTLIBOBJS!$LTLIBOBJS$ac_delim
+ _ACEOF
+ 
+-  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 71; then
++  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 73; then
+     break
+   elif $ac_last_try; then
+     { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
 --- old/config.h.in
 +++ new/config.h.in
 @@ -161,6 +161,9 @@
  /* Define to 1 if you have the `resolv' library (-lresolv). */
  #undef HAVE_LIBRESOLV
  
@@ -852,48 +889,49 @@
 +
  /* Define to 1 if you have the `socket' library (-lsocket). */
  #undef HAVE_LIBSOCKET
  
 --- old/rsync.1
 +++ new/rsync.1
-@@ -156,7 +156,14 @@ particular rsync daemon by leaving off t
- \f(CWrsync somehost\&.mydomain\&.com::\fP
- .RE 
+@@ -168,7 +168,15 @@ particular rsync daemon by leaving off t
+ .RE
+ 
  .PP 
 -See the following section for more details\&.
 +And, if Service Location Protocol is available, the following will list the
 +available rsync servers:
 +.PP 
 +.RS 
 +\f(CWrsync rsync://\fP
-+.RE 
++.RE
++
 +.PP 
 +See the following section for even more usage details\&.
  .PP 
- .SH "ADVANCED USAGE" 
- .PP 
+ .SH "ADVANCED USAGE"
+ 
 --- old/rsyncd.conf.5
 +++ new/rsyncd.conf.5
-@@ -137,6 +137,16 @@ details on some of the options you may b
+@@ -120,6 +120,16 @@ details on some of the options you may b
  special socket options are set\&.  These settings are superseded by the
- \fB--sockopts\fP command-line option\&.
+ \fB\-\-sockopts\fP command-line option\&.
  .IP 
-+.IP "\fBslp refresh\fP" 
++.IP "\fBslp refresh\fP"
 +This option is used to determine how long service
 +advertisements are valid (measured in seconds), and is only applicable if
 +you have Service Location Protocol support compiled in\&. If this option is
 +not set or is set to zero, then service advertisements never time out\&. If
 +this is set to less than 120 seconds, then 120 seconds is used\&. If it is
 +set to more than 65535, then 65535 is used (which is a limitation of SLP)\&.
 +Using 3600 (one hour) is a good number if you tend to change your
 +configuration\&.
 +.IP 
+ .SH "MODULE OPTIONS"
+ 
  .PP 
- .SH "MODULE OPTIONS" 
- .PP 
-@@ -635,6 +645,7 @@ use chroot = no
+@@ -663,6 +673,7 @@ use chroot = no
  max connections = 4
  syslog facility = local5
  pid file = /var/run/rsyncd\&.pid
 +slp refresh = 3600
  
  [ftp]
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/soften-links.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/soften-links.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/soften-links.diff	2006-02-06 14:32:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/soften-links.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,20 +1,21 @@
-Date: Fri, 12 Apr 2002 13:44:22 +0200
-From: Marco d'Itri <md@Linux.IT>
-To: mbp@samba.org
-Subject: rsync and debian mirrors
+Marco d'Itri wrote:
 
 I run one of the debian mirrors, and I had to write this patch because
 my archive is split between more than one disk. Would you accept a more
 polished version of this patch for inclusion in rsync?
 
-[Updated to latest CVS source by Wayne Davison.]
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/soften-links.diff
+    ./configure                           (optional if already run)
+    make
 
 --- old/syscall.c
 +++ new/syscall.c
-@@ -62,9 +62,14 @@ int do_symlink(const char *fname1, const
+@@ -59,9 +59,14 @@ int do_symlink(const char *fname1, const
  #ifdef HAVE_LINK
  int do_link(const char *fname1, const char *fname2)
  {
 +	int st;
 +
  	if (dry_run) return 0;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/source-filter_dest-filter.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/source-filter_dest-filter.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/source-filter_dest-filter.diff	2006-04-23 00:11:09.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/source-filter_dest-filter.diff	2006-11-07 12:43:52.000000000 +0800
@@ -20,102 +20,103 @@
  - If filter changes size of file, you should use --times-only option to
    prevent repeated transfers of unchanged files.
 
  - If the COMMAND contains single quotes, option-passing breaks.  (Needs
    to be fixed.)
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/source-filter_dest-filter.diff
     ./prepare-source
-    ./configure                      (optional if already run)
+    ./configure                                (optional if already run)
     make
 
 --- old/generator.c
 +++ new/generator.c
-@@ -61,6 +61,7 @@ extern int append_mode;
+@@ -60,6 +60,7 @@ extern int append_mode;
  extern int make_backups;
  extern int csum_length;
  extern int ignore_times;
 +extern int times_only;
  extern int size_only;
  extern OFF_T max_size;
  extern OFF_T min_size;
-@@ -376,7 +377,7 @@ void itemize(struct file_struct *file, i
+@@ -378,7 +379,7 @@ void itemize(struct file_struct *file, i
  /* Perform our quick-check heuristic for determining if a file is unchanged. */
  int unchanged_file(char *fn, struct file_struct *file, STRUCT_STAT *st)
  {
 -	if (st->st_size != file->length)
 +	if (!times_only && st->st_size != file->length)
  		return 0;
  
  	/* if always checksum is set then we use the checksum instead
 --- old/main.c
 +++ new/main.c
-@@ -111,7 +111,7 @@ pid_t wait_process(pid_t pid, int *statu
+@@ -122,7 +122,7 @@ pid_t wait_process(pid_t pid, int *statu
  }
  
  /* Wait for a process to exit, calling io_flush while waiting. */
 -static void wait_process_with_flush(pid_t pid, int *exit_code_ptr)
 +void wait_process_with_flush(pid_t pid, int *exit_code_ptr)
  {
  	pid_t waited_pid;
  	int status;
 --- old/options.c
 +++ new/options.c
-@@ -97,6 +97,7 @@ int keep_partial = 0;
+@@ -99,6 +99,7 @@ int keep_partial = 0;
  int safe_symlinks = 0;
  int copy_unsafe_links = 0;
  int size_only = 0;
 +int times_only = 0;
  int daemon_bwlimit = 0;
  int bwlimit = 0;
  int fuzzy_basis = 0;
-@@ -146,6 +147,8 @@ char *basis_dir[MAX_BASIS_DIRS+1];
- char *config_file = NULL;
- char *shell_cmd = NULL;
- char *log_format = NULL;
+@@ -151,6 +152,8 @@ char *logfile_name = NULL;
+ char *logfile_format = NULL;
+ char *stdout_format = NULL;
+ char *password_file = NULL;
 +char *source_filter = NULL;
 +char *dest_filter = NULL;
- char *password_file = NULL;
  char *rsync_path = RSYNC_PATH;
  char *backup_dir = NULL;
-@@ -331,6 +334,7 @@ void usage(enum logcode F)
+ char backup_dir_buf[MAXPATHLEN];
+@@ -343,6 +346,7 @@ void usage(enum logcode F)
    rprintf(F,"     --timeout=TIME          set I/O timeout in seconds\n");
    rprintf(F," -I, --ignore-times          don't skip files that match in size and mod-time\n");
    rprintf(F,"     --size-only             skip files that match in size\n");
 +  rprintf(F,"     --times-only            skip files that match in mod-time\n");
    rprintf(F,"     --modify-window=NUM     compare mod-times with reduced accuracy\n");
    rprintf(F," -T, --temp-dir=DIR          create temporary files in directory DIR\n");
    rprintf(F," -y, --fuzzy                 find similar file for basis if no dest file\n");
-@@ -366,6 +370,8 @@ void usage(enum logcode F)
+@@ -380,6 +384,8 @@ void usage(enum logcode F)
    rprintf(F,"     --write-batch=FILE      write a batched update to FILE\n");
    rprintf(F,"     --only-write-batch=FILE like --write-batch but w/o updating destination\n");
    rprintf(F,"     --read-batch=FILE       read a batched update from FILE\n");
 +  rprintf(F,"     --source-filter=COMMAND filter file through COMMAND at source\n");
 +  rprintf(F,"     --dest-filter=COMMAND   filter file through COMMAND at destination\n");
    rprintf(F,"     --protocol=NUM          force an older protocol version to be used\n");
  #ifdef INET6
    rprintf(F," -4, --ipv4                  prefer IPv4\n");
-@@ -446,6 +452,7 @@ static struct poptOption long_options[] 
+@@ -463,6 +469,7 @@ static struct poptOption long_options[] 
    {"chmod",            0,  POPT_ARG_STRING, 0, OPT_CHMOD, 0, 0 },
    {"ignore-times",    'I', POPT_ARG_NONE,   &ignore_times, 0, 0, 0 },
    {"size-only",        0,  POPT_ARG_NONE,   &size_only, 0, 0, 0 },
 +  {"times-only",       0,  POPT_ARG_NONE,   &times_only , 0, 0, 0 },
    {"one-file-system", 'x', POPT_ARG_NONE,   0, 'x', 0, 0 },
    {"update",          'u', POPT_ARG_NONE,   &update_only, 0, 0, 0 },
    {"existing",         0,  POPT_ARG_NONE,   &ignore_non_existing, 0, 0, 0 },
-@@ -520,6 +527,8 @@ static struct poptOption long_options[] 
+@@ -541,6 +548,8 @@ static struct poptOption long_options[] 
    {"password-file",    0,  POPT_ARG_STRING, &password_file, 0, 0, 0 },
    {"blocking-io",      0,  POPT_ARG_VAL,    &blocking_io, 1, 0, 0 },
    {"no-blocking-io",   0,  POPT_ARG_VAL,    &blocking_io, 0, 0, 0 },
 +  {"source-filter",    0,  POPT_ARG_STRING, &source_filter, 0, 0, 0 },
 +  {"dest-filter",      0,  POPT_ARG_STRING, &dest_filter, 0, 0, 0 },
    {"protocol",         0,  POPT_ARG_INT,    &protocol_version, 0, 0, 0 },
    {"checksum-seed",    0,  POPT_ARG_INT,    &checksum_seed, 0, 0, 0 },
    {"server",           0,  POPT_ARG_NONE,   0, OPT_SERVER, 0, 0 },
-@@ -1388,6 +1397,16 @@ int parse_arguments(int *argc, const cha
+@@ -1410,6 +1419,16 @@ int parse_arguments(int *argc, const cha
  		}
  	}
  
 +	if (source_filter || dest_filter) {
 +		if (whole_file == 0) {
 +			snprintf(err_buf, sizeof err_buf,
@@ -126,13 +127,13 @@
 +		whole_file = 1;
 +	}
 +
  	if (files_from) {
  		char *h, *p;
  		int q;
-@@ -1653,6 +1672,25 @@ void server_options(char **args,int *arg
+@@ -1676,6 +1695,25 @@ void server_options(char **args,int *arg
  			args[ac++] = "--size-only";
  	}
  
 +	if (times_only && am_sender)
 +		args[ac++] = "--times-only";
 +
@@ -154,13 +155,13 @@
 +
  	if (modify_window_set) {
  		if (asprintf(&arg, "--modify-window=%d", modify_window) < 0)
  			goto oom;
 --- old/pipe.c
 +++ new/pipe.c
-@@ -157,3 +157,77 @@ pid_t local_child(int argc, char **argv,
+@@ -166,3 +166,77 @@ pid_t local_child(int argc, char **argv,
  
  	return pid;
  }
 +
 +pid_t run_filter(char *command[], int out, int *pipe_to_filter)
 +{
@@ -234,32 +235,32 @@
 +	}
 +
 +	return pid;
 +}
 --- old/receiver.c
 +++ new/receiver.c
-@@ -48,6 +48,7 @@ extern int inplace;
+@@ -48,6 +48,7 @@ extern int checksum_seed;
+ extern int inplace;
  extern int delay_updates;
  extern struct stats stats;
- extern char *log_format;
 +extern char *dest_filter;
+ extern char *stdout_format;
  extern char *tmpdir;
  extern char *partial_dir;
- extern char *basis_dir[];
-@@ -345,6 +346,8 @@ int recv_files(int f_in, struct file_lis
- 		      : !am_server && log_format_has_i;
+@@ -351,6 +352,8 @@ int recv_files(int f_in, struct file_lis
+ 	enum logcode log_code = log_before_transfer ? FLOG : FINFO;
  	int max_phase = protocol_version >= 29 ? 2 : 1;
  	int i, recv_ok;
 +	pid_t pid = 0;
 +	char *filter_argv[MAX_FILTER_ARGS + 1];
  
  	if (verbose > 2)
  		rprintf(FINFO,"recv_files(%d) starting\n",flist->count);
-@@ -357,6 +360,23 @@ int recv_files(int f_in, struct file_lis
- 	if (delay_updates)
- 		delayed_bits = bitbag_create(flist->count);
+@@ -365,6 +368,23 @@ int recv_files(int f_in, struct file_lis
+ 
+ 	updating_basis = inplace;
  
 +	if (dest_filter) {
 +		char *p;
 +		char *sep = " \t";
 +		int i;
 +		for (p = strtok(dest_filter, sep), i = 0;
@@ -275,23 +276,23 @@
 +		}
 +	}
 +
  	while (1) {
  		cleanup_disable();
  
-@@ -599,6 +619,9 @@ int recv_files(int f_in, struct file_lis
+@@ -610,6 +630,9 @@ int recv_files(int f_in, struct file_lis
  		else if (!am_server && verbose && do_progress)
  			rprintf(FINFO, "%s\n", fname);
  
 +		if (dest_filter)
 +			pid = run_filter(filter_argv, fd2, &fd2);
 +
  		/* recv file data */
  		recv_ok = receive_data(f_in, fnamecmp, fd1, st.st_size,
  				       fname, fd2, file->length);
-@@ -614,6 +637,16 @@ int recv_files(int f_in, struct file_lis
+@@ -624,6 +647,16 @@ int recv_files(int f_in, struct file_lis
  			exit_cleanup(RERR_FILEIO);
  		}
  
 +		if (dest_filter) {
 +			int status;
 +			wait_process_with_flush(pid, &status);
@@ -300,44 +301,44 @@
 +					dest_filter, status);
 +				continue;
 +			}
 +		}
 +
  		if ((recv_ok && (!delay_updates || !partialptr)) || inplace) {
- 			if (partialptr == fname || *partial_dir == '/')
- 				partialptr = NULL;
+ 			char *temp_copy_name;
+ 			if (partialptr == fname)
 --- old/rsync.h
 +++ new/rsync.h
-@@ -103,6 +103,7 @@
+@@ -104,6 +104,7 @@
  #define IOERR_DEL_LIMIT (1<<2)
  
  #define MAX_ARGS 1000
 +#define MAX_FILTER_ARGS 100
  #define MAX_BASIS_DIRS 20
  #define MAX_SERVER_ARGS (MAX_BASIS_DIRS*2 + 100)
  
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -359,6 +359,7 @@ to the detailed description below for a 
+@@ -360,6 +360,7 @@ to the detailed description below for a 
       --timeout=TIME          set I/O timeout in seconds
   -I, --ignore-times          don't skip files that match size and time
       --size-only             skip files that match in size
 +     --times-only            skip files that match in mod-time
       --modify-window=NUM     compare mod-times with reduced accuracy
   -T, --temp-dir=DIR          create temporary files in directory DIR
   -y, --fuzzy                 find similar file for basis if no dest file
-@@ -394,6 +395,8 @@ to the detailed description below for a 
+@@ -397,6 +398,8 @@ to the detailed description below for a 
       --write-batch=FILE      write a batched update to FILE
       --only-write-batch=FILE like --write-batch but w/o updating dest
       --read-batch=FILE       read a batched update from FILE
 +     --source-filter=COMMAND filter file through COMMAND at source
 +     --dest-filter=COMMAND   filter file through COMMAND at destination
       --protocol=NUM          force an older protocol version to be used
       --checksum-seed=NUM     set block/file checksum seed (advanced)
   -4, --ipv4                  prefer IPv4
-@@ -1711,6 +1714,33 @@ file previously generated by bf(--write-
+@@ -1759,6 +1762,33 @@ file previously generated by bf(--write-
  If em(FILE) is bf(-), the batch data will be read from standard input.
  See the "BATCH MODE" section for details.
  
 +dit(bf(--source-filter=COMMAND)) This option allows the user to specify a
 +filter program that will be applied to the contents of all transferred
 +regular files before the data is sent to destination.  COMMAND will receive
@@ -367,22 +368,22 @@
 +
  dit(bf(--protocol=NUM)) Force an older protocol version to be used.  This
  is useful for creating a batch file that is compatible with an older
  version of rsync.  For instance, if rsync 2.6.4 is being used with the
 --- old/sender.c
 +++ new/sender.c
-@@ -41,6 +41,7 @@ extern int write_batch;
+@@ -43,6 +43,7 @@ extern int batch_fd;
+ extern int write_batch;
  extern struct stats stats;
  extern struct file_list *the_file_list;
- extern char *log_format;
 +extern char *source_filter;
+ extern char *stdout_format;
  
  
- /**
-@@ -219,6 +220,26 @@ void send_files(struct file_list *flist,
- 		      : !am_server && log_format_has_i;
+@@ -224,6 +225,26 @@ void send_files(struct file_list *flist,
+ 	enum logcode log_code = log_before_transfer ? FLOG : FINFO;
  	int f_xfer = write_batch < 0 ? batch_fd : f_out;
  	int i, j;
 +	char *filter_argv[MAX_FILTER_ARGS + 1];
 +	char *tmp = 0;
 +	int unlink_tmp = 0;
 +
@@ -402,21 +403,21 @@
 +			exit_cleanup(RERR_SYNTAX);
 +		}
 +	}
  
  	if (verbose > 2)
  		rprintf(FINFO, "send_files starting\n");
-@@ -293,6 +314,7 @@ void send_files(struct file_list *flist,
+@@ -297,6 +318,7 @@ void send_files(struct file_list *flist,
  			return;
  		}
  
 +		unlink_tmp = 0;
  		fd = do_open(fname, O_RDONLY, 0);
  		if (fd == -1) {
  			if (errno == ENOENT) {
-@@ -321,6 +343,33 @@ void send_files(struct file_list *flist,
+@@ -325,6 +347,33 @@ void send_files(struct file_list *flist,
  			return;
  		}
  
 +		if (source_filter) {
 +			int fd2;
 +			char *tmpl = "/tmp/rsync-filtered_sourceXXXXXX";
@@ -444,13 +445,13 @@
 +			}
 +		}
 +
  		if (st.st_size) {
  			int32 read_size = MAX(s->blength * 3, MAX_MAP_SIZE);
  			mbuf = map_file(fd, st.st_size, read_size, s->blength);
-@@ -363,6 +412,8 @@ void send_files(struct file_list *flist,
+@@ -366,6 +415,8 @@ void send_files(struct file_list *flist,
  			}
  		}
  		close(fd);
 +		if (unlink_tmp)
 +			unlink(tmp);
  
@@ -474,59 +475,59 @@
 +pid_t run_filter_on_file(char *command[], int out, int in);
  void end_progress(OFF_T size);
  void show_progress(OFF_T ofs, OFF_T size);
  int recv_files(int f_in, struct file_list *flist, char *local_name);
 --- old/rsync.1
 +++ new/rsync.1
-@@ -415,6 +415,7 @@ to the detailed description below for a 
-      --timeout=TIME          set I/O timeout in seconds
-  -I, --ignore-times          don\&'t skip files that match size and time
-      --size-only             skip files that match in size
-+     --times-only            skip files that match in mod-time
-      --modify-window=NUM     compare mod-times with reduced accuracy
-  -T, --temp-dir=DIR          create temporary files in directory DIR
-  -y, --fuzzy                 find similar file for basis if no dest file
-@@ -450,6 +451,8 @@ to the detailed description below for a 
-      --write-batch=FILE      write a batched update to FILE
-      --only-write-batch=FILE like --write-batch but w/o updating dest
-      --read-batch=FILE       read a batched update from FILE
-+     --source-filter=COMMAND filter file through COMMAND at source
-+     --dest-filter=COMMAND   filter file through COMMAND at destination
-      --protocol=NUM          force an older protocol version to be used
-      --checksum-seed=NUM     set block/file checksum seed (advanced)
-  -4, --ipv4                  prefer IPv4
-@@ -1959,6 +1962,35 @@ file previously generated by \fB--write-
- If \fIFILE\fP is \fB-\fP, the batch data will be read from standard input\&.
+@@ -426,6 +426,7 @@ to the detailed description below for a 
+      \-\-timeout=TIME          set I/O timeout in seconds
+  \-I, \-\-ignore\-times          don\&'t skip files that match size and time
+      \-\-size\-only             skip files that match in size
++     \-\-times\-only            skip files that match in mod-time
+      \-\-modify\-window=NUM     compare mod-times with reduced accuracy
+  \-T, \-\-temp\-dir=DIR          create temporary files in directory DIR
+  \-y, \-\-fuzzy                 find similar file for basis if no dest file
+@@ -463,6 +464,8 @@ to the detailed description below for a 
+      \-\-write\-batch=FILE      write a batched update to FILE
+      \-\-only\-write\-batch=FILE like \-\-write\-batch but w/o updating dest
+      \-\-read\-batch=FILE       read a batched update from FILE
++     \-\-source\-filter=COMMAND filter file through COMMAND at source
++     \-\-dest\-filter=COMMAND   filter file through COMMAND at destination
+      \-\-protocol=NUM          force an older protocol version to be used
+      \-\-checksum\-seed=NUM     set block/file checksum seed (advanced)
+  \-4, \-\-ipv4                  prefer IPv4
+@@ -2038,6 +2041,35 @@ file previously generated by \fB\-\-writ
+ If \fIFILE\fP is \fB\-\fP, the batch data will be read from standard input\&.
  See the "BATCH MODE" section for details\&.
  .IP 
-+.IP "\fB--source-filter=COMMAND\fP" 
++.IP "\fB\-\-source\-filter=COMMAND\fP"
 +This option allows the user to specify a
 +filter program that will be applied to the contents of all transferred
 +regular files before the data is sent to destination\&.  COMMAND will receive
 +the data on its standard input and it should write the filtered data to
 +standard output\&.  COMMAND should exit non-zero if it cannot process the
 +data or if it encounters an error when writing the data to stdout\&.
 +.IP 
-+Example: --source-filter="gzip -9" will cause remote files to be
++Example: \-\-source\-filter="gzip \-9" will cause remote files to be
 +compressed\&.
-+Use of --source-filter automatically enables --whole-file\&.
++Use of \-\-source\-filter automatically enables \-\-whole\-file\&.
 +If your filter does not output the same number of bytes that it received on
-+input, you should use --times-only to disable size and content checks on
++input, you should use \-\-times\-only to disable size and content checks on
 +subsequent rsync runs\&.
 +.IP 
-+.IP "\fB--dest-filter=COMMAND\fP" 
++.IP "\fB\-\-dest\-filter=COMMAND\fP"
 +This option allows you to specify a filter
 +program that will be applied to the contents of all transferred regular
 +files before the data is written to disk\&.  COMMAND will receive the data on
 +its standard input and it should write the filtered data to standard
 +output\&.  COMMAND should exit non-zero if it cannot process the data or if
 +it encounters an error when writing the data to stdout\&.
 +.IP 
-+Example: --dest-filter="gzip -9" will cause remote files to be compressed\&.
-+Use of --dest-filter automatically enables --whole-file\&.
++Example: \-\-dest\-filter="gzip \-9" will cause remote files to be compressed\&.
++Use of \-\-dest\-filter automatically enables \-\-whole\-file\&.
 +If your filter does not output the same number of bytes that it
-+received on input, you should use --times-only to disable size and
++received on input, you should use \-\-times\-only to disable size and
 +content checks on subsequent rsync runs\&.
 +.IP 
- .IP "\fB--protocol=NUM\fP" 
+ .IP "\fB\-\-protocol=NUM\fP"
  Force an older protocol version to be used\&.  This
  is useful for creating a batch file that is compatible with an older
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/threaded-receiver.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/threaded-receiver.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/threaded-receiver.diff	2006-04-23 00:11:16.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/threaded-receiver.diff	2006-11-07 12:43:53.000000000 +0800
@@ -15,74 +15,74 @@
 
 NOTE: we still need to duplicate the partial_fname static in util.c!
 
 If you try this out, please send some email to wayned@samba.org or the rsync
 mailing list with your results, build changes, bug reports, etc.  Thanks!
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
-    ./prepare-source
-    ./configure                      (optional if already run)
+    patch -p1 <patches/threaded-receiver.diff
+    ./configure
     make
 
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -6,7 +6,7 @@ exec_prefix=@exec_prefix@
+@@ -7,7 +7,7 @@ exec_prefix=@exec_prefix@
  bindir=@bindir@
  mandir=@mandir@
  
 -LIBS=@LIBS@
 +LIBS=@LIBS@ -lpthread
  CC=@CC@
  CFLAGS=@CFLAGS@
  CPPFLAGS=@CPPFLAGS@
 --- old/cleanup.c
 +++ new/cleanup.c
-@@ -26,10 +26,6 @@ extern int keep_partial;
- extern int log_got_error;
+@@ -31,10 +31,6 @@ extern int log_got_error;
  extern char *partial_dir;
+ extern char *logfile_name;
  
 -#ifdef HAVE_SIGACTION
 -static struct sigaction sigact;
 -#endif
 -
  /**
   * Close all open sockets and files, allowing a (somewhat) graceful
   * shutdown() of socket connections.  This eliminates the abortive
-@@ -98,9 +94,6 @@ void _exit_cleanup(int code, const char 
- 	}
- 	inside_cleanup++;
+@@ -98,9 +94,6 @@ NORETURN void _exit_cleanup(int code, co
+ 	static int exit_code = 0;
+ 	static int unmodified_code = 0;
  
 -	SIGACTION(SIGUSR1, SIG_IGN);
 -	SIGACTION(SIGUSR2, SIG_IGN);
 -
- 	if (verbose > 3) {
- 		rprintf(FINFO,"_exit_cleanup(code=%d, file=%s, line=%d): entered\n",
- 			code, file, line);
-@@ -132,8 +125,6 @@ void _exit_cleanup(int code, const char 
- 	io_flush(FULL_FLUSH);
- 	if (cleanup_fname)
- 		do_unlink(cleanup_fname);
--	if (code)
--		kill_all(SIGUSR1);
- 	if (cleanup_pid && cleanup_pid == getpid()) {
- 		char *pidf = lp_pid_file();
- 		if (pidf && *pidf)
+ 	if (exit_code) /* Preserve first error code when recursing. */
+ 		code = exit_code;
+ 
+@@ -157,8 +150,6 @@ NORETURN void _exit_cleanup(int code, co
+ 
+ 		if (cleanup_fname)
+ 			do_unlink(cleanup_fname);
+-		if (code)
+-			kill_all(SIGUSR1);
+ 		if (cleanup_pid && cleanup_pid == getpid()) {
+ 			char *pidf = lp_pid_file();
+ 			if (pidf && *pidf)
 --- old/errcode.h
 +++ new/errcode.h
 @@ -37,7 +37,6 @@
  #define RERR_CRASHED    15      /* sibling crashed */
  #define RERR_TERMINATED 16      /* sibling terminated abnormally */
  
 -#define RERR_SIGNAL1    19      /* status returned when sent SIGUSR1 */
  #define RERR_SIGNAL     20      /* status returned when sent SIGINT, SIGTERM, SIGHUP */
  #define RERR_WAITCHILD  21      /* some error returned by waitpid() */
  #define RERR_MALLOC     22      /* error allocating core memory buffers */
 --- old/generator.c
 +++ new/generator.c
-@@ -67,7 +67,6 @@ extern OFF_T min_size;
+@@ -66,7 +66,6 @@ extern OFF_T min_size;
  extern int io_error;
  extern int allowed_lull;
  extern int sock_f_out;
 -extern int ignore_timeout;
  extern int protocol_version;
  extern int fuzzy_basis;
@@ -96,105 +96,105 @@
 +static int GEN_make_backups;
 +static int GEN_csum_length;
 +
  /* For calling delete_file() */
  #define DEL_FORCE_RECURSE	(1<<1) /* recurse even w/o --force */
  #define DEL_TERSE		(1<<3)
-@@ -443,8 +447,8 @@ static void sum_sizes_sqroot(struct sum_
+@@ -445,8 +449,8 @@ static void sum_sizes_sqroot(struct sum_
  	}
  
  	if (protocol_version < 27) {
 -		s2length = csum_length;
 -	} else if (csum_length == SUM_LENGTH) {
 +		s2length = GEN_csum_length;
 +	} else if (GEN_csum_length == SUM_LENGTH) {
  		s2length = SUM_LENGTH;
  	} else {
  		int32 c;
-@@ -454,7 +458,7 @@ static void sum_sizes_sqroot(struct sum_
- 		for (c = blength; c >>= 1 && b; b--) {}
+@@ -456,7 +460,7 @@ static void sum_sizes_sqroot(struct sum_
+ 		for (c = blength; (c >>= 1) && b; b--) {}
  		/* add a bit, subtract rollsum, round up. */
  		s2length = (b + 1 - 32 + 7) / 8; /* --optimize in compiler-- */
 -		s2length = MAX(s2length, csum_length);
 +		s2length = MAX(s2length, GEN_csum_length);
  		s2length = MIN(s2length, SUM_LENGTH);
  	}
  
-@@ -488,7 +492,7 @@ static void generate_and_send_sums(int f
+@@ -490,7 +494,7 @@ static void generate_and_send_sums(int f
  	sum_sizes_sqroot(&sum, len);
  	write_sum_head(f_out, &sum);
  
 -	if (append_mode > 0 && f_copy < 0)
 +	if (GEN_append_mode > 0 && f_copy < 0)
  		return;
  
  	if (len > 0)
-@@ -507,7 +511,7 @@ static void generate_and_send_sums(int f
+@@ -509,7 +513,7 @@ static void generate_and_send_sums(int f
  
  		if (f_copy >= 0) {
  			full_write(f_copy, map, n1);
 -			if (append_mode > 0)
 +			if (GEN_append_mode > 0)
  				continue;
  		}
  
-@@ -1175,7 +1179,7 @@ static void recv_generator(char *fname, 
+@@ -1208,7 +1212,7 @@ static void recv_generator(char *fname, 
  		return;
  	}
  
 -	if (append_mode && st.st_size > file->length)
 +	if (GEN_append_mode && st.st_size > file->length)
  		return;
  
  	if (fnamecmp_type <= FNAMECMP_BASIS_DIR_HIGH)
-@@ -1230,7 +1234,7 @@ static void recv_generator(char *fname, 
+@@ -1271,7 +1275,7 @@ static void recv_generator(char *fname, 
  		goto notify_others;
  	}
  
 -	if (inplace && make_backups && fnamecmp_type == FNAMECMP_FNAME) {
 +	if (inplace && GEN_make_backups && fnamecmp_type == FNAMECMP_FNAME) {
  		if (!(backupptr = get_backup_name(fname))) {
  			close(fd);
  			return;
-@@ -1321,9 +1325,12 @@ void generate_files(int f_out, struct fi
+@@ -1362,9 +1366,12 @@ void generate_files(int f_out, struct fi
  	int save_ignore_existing = ignore_existing;
  	int save_ignore_non_existing = ignore_non_existing;
  	int save_do_progress = do_progress;
 -	int save_make_backups = make_backups;
 +	int save_make_backups = GEN_make_backups = make_backups;
  	int dir_tweaking = !(list_only || local_name || dry_run);
  
 +	GEN_append_mode = append_mode;
 +	GEN_csum_length = csum_length;
 +
  	if (protocol_version >= 29) {
  		itemizing = 1;
- 		maybe_ATTRS_REPORT = log_format_has_i ? 0 : ATTRS_REPORT;
-@@ -1351,7 +1358,7 @@ void generate_files(int f_out, struct fi
+ 		maybe_ATTRS_REPORT = stdout_format_has_i ? 0 : ATTRS_REPORT;
+@@ -1392,7 +1399,7 @@ void generate_files(int f_out, struct fi
  		do_delete_pass(flist);
  	do_progress = 0;
  
 -	if (append_mode || whole_file < 0)
 +	if (GEN_append_mode || whole_file < 0)
  		whole_file = 0;
  	if (verbose >= 2) {
  		rprintf(FINFO, "delta-transmission %s\n",
-@@ -1360,12 +1367,6 @@ void generate_files(int f_out, struct fi
+@@ -1401,12 +1408,6 @@ void generate_files(int f_out, struct fi
  			: "enabled");
  	}
  
 -	/* Since we often fill up the outgoing socket and then just sit around
 -	 * waiting for the other 2 processes to do their thing, we don't want
 -	 * to exit on a timeout.  If the data stops flowing, the receiver will
 -	 * notice that and let us know via the redo pipe (or its closing). */
 -	ignore_timeout = 1;
 -
  	for (i = 0; i < flist->count; i++) {
  		struct file_struct *file = flist->files[i];
  
-@@ -1409,23 +1410,34 @@ void generate_files(int f_out, struct fi
+@@ -1450,23 +1451,34 @@ void generate_files(int f_out, struct fi
  		delete_in_dir(NULL, NULL, NULL, NULL);
  
  	phase++;
 -	csum_length = SUM_LENGTH;
 +	GEN_csum_length = SUM_LENGTH; /* csum_length is set by the receiver */
  	max_size = min_size = ignore_existing = ignore_non_existing = 0;
@@ -229,13 +229,13 @@
 +			continue;
 +		}
 +		file = flist->files[i];
  		if (local_name)
  			strlcpy(fbuf, local_name, sizeof fbuf);
  		else
-@@ -1437,27 +1449,43 @@ void generate_files(int f_out, struct fi
+@@ -1478,27 +1490,43 @@ void generate_files(int f_out, struct fi
  	phase++;
  	ignore_non_existing = save_ignore_non_existing;
  	ignore_existing = save_ignore_existing;
 -	make_backups = save_make_backups;
 +	GEN_make_backups = save_make_backups;
  
@@ -282,42 +282,42 @@
 +		}
  	}
  
  	do_progress = save_do_progress;
 --- old/io.c
 +++ new/io.c
-@@ -46,20 +46,17 @@ extern int allowed_lull;
+@@ -40,20 +40,17 @@ extern int allowed_lull;
  extern int am_server;
  extern int am_daemon;
  extern int am_sender;
 -extern int am_generator;
  extern int eol_nulls;
  extern int read_batch;
  extern int csum_length;
  extern int checksum_seed;
  extern int protocol_version;
--extern int remove_sent_files;
+-extern int remove_source_files;
  extern int preserve_hard_links;
  extern char *filesfrom_host;
  extern struct stats stats;
  extern struct file_list *the_file_list;
  
  const char phase_unknown[] = "unknown";
 -int ignore_timeout = 0;
  int batch_fd = -1;
  int batch_gen_fd = -1;
  
-@@ -67,7 +64,6 @@ int batch_gen_fd = -1;
+@@ -61,7 +58,6 @@ int batch_gen_fd = -1;
  int kluge_around_eof = 0;
  
  int msg_fd_in = -1;
 -int msg_fd_out = -1;
  int sock_f_in = -1;
  int sock_f_out = -1;
  
-@@ -94,27 +90,31 @@ static OFF_T active_bytecnt = 0;
+@@ -88,27 +84,31 @@ static OFF_T active_bytecnt = 0;
  static void read_loop(int fd, char *buf, size_t len);
  
  struct flist_ndx_item {
 -	struct flist_ndx_item *next;
 +	volatile struct flist_ndx_item *next;
  	int ndx;
@@ -349,13 +349,13 @@
  
 -static struct msg_list msg2genr, msg2sndr;
 +static struct msg_list msg_list = { NULL, NULL, PTHREAD_MUTEX_INITIALIZER };
  
  static void flist_ndx_push(struct flist_ndx_list *lp, int ndx)
  {
-@@ -124,27 +124,31 @@ static void flist_ndx_push(struct flist_
+@@ -118,27 +118,31 @@ static void flist_ndx_push(struct flist_
  		out_of_memory("flist_ndx_push");
  	item->next = NULL;
  	item->ndx = ndx;
 +	pthread_mutex_lock(&redo_list.mutex);
  	if (lp->tail)
  		lp->tail->next = item;
@@ -387,22 +387,22 @@
  		lp->tail = NULL;
 +	pthread_mutex_unlock(&hlink_list.mutex);
 +	free(head);
  
  	return ndx;
  }
-@@ -153,7 +157,7 @@ static void check_timeout(void)
+@@ -147,7 +151,7 @@ static void check_timeout(void)
  {
  	time_t t;
  
 -	if (!io_timeout || ignore_timeout)
 +	if (!io_timeout)
  		return;
  
  	if (!last_io_in) {
-@@ -194,44 +198,38 @@ void set_io_timeout(int secs)
+@@ -188,44 +192,38 @@ void set_io_timeout(int secs)
  
  /* Setup the fd used to receive MSG_* messages.  Only needed during the
   * early stages of being a local sender (up through the sending of the
 - * file list) or when we're the generator (to fetch the messages from
 - * the receiver). */
 + * file list). */
@@ -457,13 +457,13 @@
 - * of the file list) or when we're the generator (to fetch the messages
 - * from the receiver). */
 + * of the file list). */
  static void read_msg_fd(void)
  {
  	char buf[2048];
-@@ -250,57 +248,6 @@ static void read_msg_fd(void)
+@@ -244,51 +242,6 @@ static void read_msg_fd(void)
  	tag = (tag >> 24) - MPLEX_BASE;
  
  	switch (tag) {
 -	case MSG_DONE:
 -		if (len != 0 || !am_generator) {
 -			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
@@ -474,39 +474,33 @@
 -	case MSG_REDO:
 -		if (len != 4 || !am_generator) {
 -			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 -			exit_cleanup(RERR_STREAMIO);
 -		}
 -		read_loop(fd, buf, 4);
--		if (remove_sent_files)
+-		if (remove_source_files)
 -			decrement_active_files(IVAL(buf,0));
 -		flist_ndx_push(&redo_list, IVAL(buf,0));
 -		break;
 -	case MSG_DELETED:
 -		if (len >= (int)sizeof buf || !am_generator) {
 -			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 -			exit_cleanup(RERR_STREAMIO);
 -		}
 -		read_loop(fd, buf, len);
--		if (defer_forwarding_messages)
--			msg_list_add(&msg2sndr, MSG_DELETED, buf, len);
--		else
--			io_multiplex_write(MSG_DELETED, buf, len);
+-		send_msg(MSG_DELETED, buf, len);
 -		break;
 -	case MSG_SUCCESS:
 -		if (len != 4 || !am_generator) {
 -			rprintf(FERROR, "invalid message %d:%d\n", tag, len);
 -			exit_cleanup(RERR_STREAMIO);
 -		}
 -		read_loop(fd, buf, len);
--		if (remove_sent_files) {
+-		if (remove_source_files) {
 -			decrement_active_files(IVAL(buf,0));
--			if (defer_forwarding_messages)
--				msg_list_add(&msg2sndr, MSG_SUCCESS, buf, len);
--			else
--				io_multiplex_write(MSG_SUCCESS, buf, len);
+-			send_msg(MSG_SUCCESS, buf, len);
 -		}
 -		if (preserve_hard_links)
 -			flist_ndx_push(&hlink_list, IVAL(buf,0));
 -		break;
 -	case MSG_SOCKERR:
 -		if (!am_generator) {
@@ -515,25 +509,13 @@
 -		}
 -		close_multiplexing_out();
 -		/* FALL THROUGH */
  	case MSG_INFO:
  	case MSG_ERROR:
  	case MSG_LOG:
-@@ -309,10 +256,7 @@ static void read_msg_fd(void)
- 			if (n >= sizeof buf)
- 				n = sizeof buf - 1;
- 			read_loop(fd, buf, n);
--			if (am_generator && am_server && defer_forwarding_messages)
--				msg_list_add(&msg2sndr, tag, buf, n);
--			else
--				rwrite((enum logcode)tag, buf, n);
-+			rwrite((enum logcode)tag, buf, n);
- 			len -= n;
- 		}
- 		break;
-@@ -347,70 +291,76 @@ void decrement_active_files(int ndx)
+@@ -332,75 +285,80 @@ void decrement_active_files(int ndx)
  	active_bytecnt -= the_file_list->files[ndx]->length;
  }
  
 -/* Try to push messages off the list onto the wire.  If we leave with more
 +/* Try to pop messages off the list onto the wire.  If we leave with more
   * to do, return 0.  On error, return -1.  If everything flushed, return 1.
@@ -599,23 +581,27 @@
  	}
 -	return 1;
 +	defer_forwarding_messages = 0;
 +	no_flush--;
  }
  
- void send_msg(enum msgcode code, char *buf, int len)
+ int send_msg(enum msgcode code, char *buf, int len)
  {
 -	if (msg_fd_out < 0) {
-+	if (am_receiver())
-+		msg_list_add(code, buf, len);
-+	else
- 		io_multiplex_write(code, buf, len);
--		return;
--	}
++	if (!am_receiver()) {
+ 		if (!defer_forwarding_messages)
+ 			return io_multiplex_write(code, buf, len);
+ 		if (!io_multiplexing_out)
+ 			return 0;
+-		msg_list_add(&msg2sndr, code, buf, len);
+-		return 1;
+ 	}
 -	msg_list_add(&msg2genr, code, buf, len);
 -	msg2genr_flush(NORMAL_FLUSH);
++	msg_list_add(code, buf, len);
+ 	return 1;
  }
  
 -int get_redo_num(int itemizing, enum logcode code)
 +/* This is only used by the receiver. */
 +void push_redo_num(int ndx)
  {
@@ -648,61 +634,61 @@
  int get_hlink_num(void)
  {
 +	assert(am_generator());
  	return flist_ndx_pop(&hlink_list);
  }
  
-@@ -490,11 +440,6 @@ static int read_timeout(int fd, char *bu
+@@ -480,11 +438,6 @@ static int read_timeout(int fd, char *bu
  		FD_ZERO(&r_fds);
  		FD_ZERO(&w_fds);
  		FD_SET(fd, &r_fds);
 -		if (msg2genr.head) {
 -			FD_SET(msg_fd_out, &w_fds);
 -			if (msg_fd_out > maxfd)
 -				maxfd = msg_fd_out;
 -		}
  		if (io_filesfrom_f_out >= 0) {
  			int new_fd;
  			if (io_filesfrom_buflen == 0) {
-@@ -527,9 +472,6 @@ static int read_timeout(int fd, char *bu
+@@ -517,9 +470,6 @@ static int read_timeout(int fd, char *bu
  			continue;
  		}
  
 -		if (msg2genr.head && FD_ISSET(msg_fd_out, &w_fds))
 -			msg2genr_flush(NORMAL_FLUSH);
 -
  		if (io_filesfrom_f_out >= 0) {
  			if (io_filesfrom_buflen) {
  				if (FD_ISSET(io_filesfrom_f_out, &w_fds)) {
-@@ -851,6 +793,8 @@ static void readfd(int fd, char *buffer,
+@@ -847,6 +797,8 @@ static void readfd(int fd, char *buffer,
  	}
  
  	if (fd == write_batch_monitor_in) {
 +		if (am_generator())
 +		    rprintf(FINFO, "writing %d bytes to batch file from generator\n", total);
  		if ((size_t)write(batch_fd, buffer, total) != total)
  			exit_cleanup(RERR_FILEIO);
  	}
-@@ -1112,7 +1056,6 @@ static void writefd_unbuffered(int fd,ch
+@@ -1115,7 +1067,6 @@ static void writefd_unbuffered(int fd,ch
  			 * to grab any messages they sent before they died. */
  			while (fd == sock_f_out && io_multiplexing_in) {
  				set_io_timeout(30);
 -				ignore_timeout = 0;
  				readfd_unbuffered(sock_f_in, io_filesfrom_buf,
  						  sizeof io_filesfrom_buf);
  			}
-@@ -1123,7 +1066,7 @@ static void writefd_unbuffered(int fd,ch
+@@ -1126,7 +1077,7 @@ static void writefd_unbuffered(int fd,ch
  		defer_forwarding_messages = 1;
  
  		if (fd == sock_f_out) {
 -			if (io_timeout || am_generator)
 +			if (io_timeout || am_generator())
  				last_io_out = time(NULL);
  			sleep_for_bwlimit(cnt);
  		}
-@@ -1133,23 +1076,6 @@ static void writefd_unbuffered(int fd,ch
+@@ -1136,23 +1087,6 @@ static void writefd_unbuffered(int fd,ch
  	no_flush--;
  }
  
 -static void msg2sndr_flush(void)
 -{
 -	if (defer_forwarding_messages)
@@ -720,93 +706,94 @@
 -	}
 -}
 -
  /**
   * Write an message to a multiplexed stream. If this fails then rsync
   * exits.
-@@ -1175,14 +1101,15 @@ static void mplex_write(enum msgcode cod
+@@ -1178,14 +1112,15 @@ static void mplex_write(enum msgcode cod
  		defer_forwarding_messages = 1;
  		writefd_unbuffered(sock_f_out, buf, len);
  		defer_forwarding_messages = 0;
 -		msg2sndr_flush();
 +		if (am_generator())
 +			msg_list_flush();
  	}
  }
  
- void io_flush(int flush_it_all)
+-void io_flush(int flush_it_all)
++void io_flush(UNUSED(int flush_it_all))
  {
 -	msg2genr_flush(flush_it_all);
 -	msg2sndr_flush();
 +	if (am_generator())
 +		msg_list_flush();
  
  	if (!iobuf_out_cnt || no_flush)
  		return;
-@@ -1196,11 +1123,6 @@ void io_flush(int flush_it_all)
+@@ -1199,11 +1134,6 @@ void io_flush(int flush_it_all)
  
  static void writefd(int fd,char *buf,size_t len)
  {
 -	if (fd == msg_fd_out) {
 -		rprintf(FERROR, "Internal error: wrong write used in receiver.\n");
 -		exit_cleanup(RERR_PROTOCOL);
 -	}
 -
  	if (fd == sock_f_out)
  		stats.total_written += len;
  
-@@ -1406,9 +1328,3 @@ void start_write_batch(int fd)
+@@ -1409,9 +1339,3 @@ void start_write_batch(int fd)
  	else
  		write_batch_monitor_in = fd;
  }
 -
 -void stop_write_batch(void)
 -{
 -	write_batch_monitor_out = -1;
 -	write_batch_monitor_in = -1;
 -}
 --- old/log.c
 +++ new/log.c
-@@ -38,7 +38,6 @@ extern int am_sender;
+@@ -33,7 +33,6 @@ extern int am_sender;
  extern int local_server;
  extern int quiet;
  extern int module_id;
 -extern int msg_fd_out;
  extern int allow_8bit_chars;
  extern int protocol_version;
  extern int preserve_times;
-@@ -76,7 +75,6 @@ struct {
+@@ -75,7 +74,6 @@ struct {
  	{ RERR_IPC        , "error in IPC code" },
  	{ RERR_CRASHED    , "sibling process crashed" },
  	{ RERR_TERMINATED , "sibling process terminated abnormally" },
 -	{ RERR_SIGNAL1    , "received SIGUSR1" },
  	{ RERR_SIGNAL     , "received SIGINT, SIGTERM, or SIGHUP" },
  	{ RERR_WAITCHILD  , "waitpid() failed" },
  	{ RERR_MALLOC     , "error allocating core memory buffers" },
-@@ -232,8 +230,8 @@ void rwrite(enum logcode code, char *buf
- 	if (quiet && code == FINFO)
- 		return;
+@@ -241,8 +239,8 @@ void rwrite(enum logcode code, char *buf
+ 	if (len < 0)
+ 		exit_cleanup(RERR_MESSAGEIO);
  
 -	if (am_server && msg_fd_out >= 0) {
 -		/* Pass the message to our sibling. */
 +	if (am_receiver()) {
 +		/* Pass the message to the generator thread. */
  		send_msg((enum msgcode)code, buf, len);
  		return;
  	}
 --- old/main.c
 +++ new/main.c
-@@ -30,7 +30,6 @@ extern int list_only;
+@@ -32,7 +32,6 @@ extern int list_only;
  extern int am_root;
  extern int am_server;
  extern int am_sender;
 -extern int am_generator;
  extern int am_daemon;
  extern int blocking_io;
- extern int remove_sent_files;
-@@ -85,9 +84,20 @@ struct pid_status {
+ extern int remove_source_files;
+@@ -96,9 +95,20 @@ struct pid_status {
  
  static time_t starttime, endtime;
  static int64 total_read, total_written;
 +static pthread_t receiver_tid;
  
  static void show_malloc_stats(void);
@@ -821,22 +808,22 @@
 +	return receiver_tid != 0 && pthread_self() == receiver_tid;
 +}
 +
  /* Works like waitpid(), but if we already harvested the child pid in our
   * remember_children(), we succeed instead of returning an error. */
  pid_t wait_process(pid_t pid, int *status_ptr, int flags)
-@@ -164,7 +174,7 @@ static void handle_stats(int f)
+@@ -175,7 +185,7 @@ static void handle_stats(int f)
  		show_flist_stats();
  	}
  
 -	if (am_generator)
 +	if (am_generator())
  		return;
  
  	if (am_daemon) {
-@@ -628,12 +638,30 @@ static void do_server_sender(int f_in, i
+@@ -683,12 +693,30 @@ static void do_server_sender(int f_in, i
  	exit_cleanup(0);
  }
  
 +struct thread_args {
 +    struct file_list *flist;
 +    char *local_name;
@@ -864,33 +851,33 @@
 -	int error_pipe[2];
 +	void *value_ptr;
 +	struct thread_args args;
  
  	/* The receiving side mustn't obey this, or an existing symlink that
  	 * points to an identical file won't be replaced by the referent. */
-@@ -642,70 +670,16 @@ static int do_recv(int f_in,int f_out,st
+@@ -697,70 +725,16 @@ static int do_recv(int f_in,int f_out,st
  	if (preserve_hard_links)
  		init_hard_links();
  
 -	if (fd_pair(error_pipe) < 0) {
 -		rsyserr(FERROR, errno, "pipe failed in do_recv");
+-		exit_cleanup(RERR_IPC);
+-	}
+-
+-	io_flush(NORMAL_FLUSH);
+-
+-	if ((pid = do_fork()) == -1) {
+-		rsyserr(FERROR, errno, "fork failed in do_recv");
 +	args.f_in = f_in;
 +	args.flist = flist;
 +	args.local_name = local_name;
 +	if (pthread_create(&receiver_tid, NULL, start_receiver_thread, &args) < 0) {
 +		rsyserr(FERROR, errno, "pthread_create failed in do_recv");
  		exit_cleanup(RERR_IPC);
  	}
  
--	io_flush(NORMAL_FLUSH);
--
--	if ((pid = do_fork()) == -1) {
--		rsyserr(FERROR, errno, "fork failed in do_recv");
--		exit_cleanup(RERR_IPC);
--	}
--
 -	if (pid == 0) {
 -		close(error_pipe[0]);
 -		if (f_in != f_out)
 -			close(f_out);
 -
 -		/* we can't let two processes write to the socket at one time */
@@ -940,13 +927,13 @@
  
 -	set_msg_fd_in(error_pipe[0]);
 -
  	generate_files(f_out, flist, local_name);
  
  	handle_stats(-1);
-@@ -716,10 +690,13 @@ static int do_recv(int f_in,int f_out,st
+@@ -771,10 +745,13 @@ static int do_recv(int f_in,int f_out,st
  	}
  	io_flush(FULL_FLUSH);
  
 -	set_msg_fd_in(-1);
 -	kill(pid, SIGUSR2);
 -	wait_process_with_flush(pid, &exit_code);
@@ -958,13 +945,13 @@
 +	close_all();
 +
 +	return *(int*)value_ptr;
  }
  
  
-@@ -1089,22 +1066,6 @@ static int start_client(int argc, char *
+@@ -1176,22 +1153,6 @@ static int start_client(int argc, char *
  	return ret;
  }
  
 -
 -static RETSIGTYPE sigusr1_handler(UNUSED(int val))
 -{
@@ -981,266 +968,266 @@
 -	_exit(0);
 -}
 -
  RETSIGTYPE remember_children(UNUSED(int val))
  {
  #ifdef WNOHANG
-@@ -1196,8 +1157,6 @@ int main(int argc,char *argv[])
+@@ -1283,8 +1244,6 @@ int main(int argc,char *argv[])
  # endif
  	sigact.sa_flags = SA_NOCLDSTOP;
  #endif
 -	SIGACTMASK(SIGUSR1, sigusr1_handler);
 -	SIGACTMASK(SIGUSR2, sigusr2_handler);
  	SIGACTMASK(SIGCHLD, remember_children);
  #ifdef MAINTAINER_MODE
  	SIGACTMASK(SIGSEGV, rsync_panic_handler);
 --- old/match.c
 +++ new/match.c
-@@ -20,7 +20,7 @@
+@@ -23,7 +23,7 @@
  #include "rsync.h"
  
  extern int verbose;
 -extern int do_progress;
 +extern int recv_progress;
  extern int checksum_seed;
  extern int append_mode;
  
-@@ -110,7 +110,7 @@ static void matched(int f, struct sum_st
+@@ -113,7 +113,7 @@ static void matched(int f, struct sum_st
  	else
  		last_match = offset;
  
 -	if (buf && do_progress)
 +	if (buf && recv_progress)
  		show_progress(last_match, buf->file_size);
  }
  
-@@ -314,7 +314,7 @@ void match_sums(int f, struct sum_struct
+@@ -317,7 +317,7 @@ void match_sums(int f, struct sum_struct
  	if (append_mode) {
  		OFF_T j = 0;
  		for (j = CHUNK_SIZE; j < s->flength; j += CHUNK_SIZE) {
 -			if (buf && do_progress)
 +			if (buf && recv_progress)
  				show_progress(last_match, buf->file_size);
  			sum_update(map_ptr(buf, last_match, CHUNK_SIZE),
  				   CHUNK_SIZE);
-@@ -322,7 +322,7 @@ void match_sums(int f, struct sum_struct
+@@ -325,7 +325,7 @@ void match_sums(int f, struct sum_struct
  		}
  		if (last_match < s->flength) {
  			int32 len = s->flength - last_match;
 -			if (buf && do_progress)
 +			if (buf && recv_progress)
  				show_progress(last_match, buf->file_size);
  			sum_update(map_ptr(buf, last_match, len), len);
  			last_match = s->flength;
 --- old/options.c
 +++ new/options.c
-@@ -72,7 +72,6 @@ int def_compress_level = Z_DEFAULT_COMPR
+@@ -74,7 +74,6 @@ int def_compress_level = Z_DEFAULT_COMPR
  int am_root = 0;
  int am_server = 0;
  int am_sender = 0;
 -int am_generator = 0;
  int am_starting_up = 1;
  int relative_paths = -1;
  int implied_dirs = 1;
-@@ -93,6 +92,7 @@ int am_daemon = 0;
+@@ -95,6 +94,7 @@ int am_daemon = 0;
  int daemon_over_rsh = 0;
  int do_stats = 0;
  int do_progress = 0;
 +int recv_progress = 0;
  int keep_partial = 0;
  int safe_symlinks = 0;
  int copy_unsafe_links = 0;
-@@ -1298,6 +1298,7 @@ int parse_arguments(int *argc, const cha
+@@ -1306,6 +1306,7 @@ int parse_arguments(int *argc, const cha
  
  	if (do_progress && !verbose && !log_before_transfer && !am_server)
  		verbose = 1;
 +	recv_progress = do_progress;
  
  	if (dry_run)
  		do_xfers = 0;
 --- old/pipe.c
 +++ new/pipe.c
-@@ -56,7 +56,7 @@ pid_t piped_child(char **command, int *f
+@@ -59,7 +59,7 @@ pid_t piped_child(char **command, int *f
  		exit_cleanup(RERR_IPC);
  	}
  
 -	pid = do_fork();
 +	pid = fork();
  	if (pid == -1) {
  		rsyserr(FERROR, errno, "fork");
  		exit_cleanup(RERR_IPC);
-@@ -120,7 +120,7 @@ pid_t local_child(int argc, char **argv,
+@@ -123,7 +123,7 @@ pid_t local_child(int argc, char **argv,
  		exit_cleanup(RERR_IPC);
  	}
  
 -	pid = do_fork();
 +	pid = fork();
  	if (pid == -1) {
  		rsyserr(FERROR, errno, "fork");
  		exit_cleanup(RERR_IPC);
 --- old/receiver.c
 +++ new/receiver.c
-@@ -24,7 +24,7 @@ extern int verbose;
+@@ -25,7 +25,7 @@
+ extern int verbose;
  extern int do_xfers;
- extern int am_daemon;
  extern int am_server;
 -extern int do_progress;
 +extern int recv_progress;
  extern int log_before_transfer;
- extern int log_format_has_i;
- extern int daemon_log_format_has_i;
-@@ -153,7 +153,7 @@ static int receive_data(int f_in, char *
+ extern int stdout_format_has_i;
+ extern int logfile_format_has_i;
+@@ -157,7 +157,7 @@ static int receive_data(int f_in, char *
  		if (sum.remainder)
  			sum.flength -= sum.blength - sum.remainder;
  		for (j = CHUNK_SIZE; j < sum.flength; j += CHUNK_SIZE) {
 -			if (do_progress)
 +			if (recv_progress)
  				show_progress(offset, total_size);
  			sum_update(map_ptr(mapbuf, offset, CHUNK_SIZE),
  				   CHUNK_SIZE);
-@@ -161,7 +161,7 @@ static int receive_data(int f_in, char *
+@@ -165,7 +165,7 @@ static int receive_data(int f_in, char *
  		}
  		if (offset < sum.flength) {
  			int32 len = sum.flength - offset;
 -			if (do_progress)
 +			if (recv_progress)
  				show_progress(offset, total_size);
  			sum_update(map_ptr(mapbuf, offset, len), len);
  			offset = sum.flength;
-@@ -174,7 +174,7 @@ static int receive_data(int f_in, char *
+@@ -178,7 +178,7 @@ static int receive_data(int f_in, char *
  	}
  
  	while ((i = recv_token(f_in, &data)) != 0) {
 -		if (do_progress)
 +		if (recv_progress)
  			show_progress(offset, total_size);
  
  		if (i > 0) {
-@@ -242,7 +242,7 @@ static int receive_data(int f_in, char *
+@@ -248,7 +248,7 @@ static int receive_data(int f_in, char *
  		ftruncate(fd, offset);
  #endif
  
 -	if (do_progress)
 +	if (recv_progress)
  		end_progress(total_size);
  
  	if (fd != -1 && offset > 0 && sparse_end(fd) != 0) {
-@@ -293,12 +293,12 @@ static void handle_delayed_updates(struc
+@@ -299,12 +299,12 @@ static void handle_delayed_updates(struc
  					"rename failed for %s (from %s)",
  					full_fname(fname), partialptr);
  			} else {
--				if (remove_sent_files
+-				if (remove_source_files
 -				    || (preserve_hard_links
 -				     && file->link_u.links)) {
-+				if (remove_sent_files) {
++				if (remove_source_files) {
  					SIVAL(numbuf, 0, i);
  					send_msg(MSG_SUCCESS,numbuf,4);
  				}
 +				if (preserve_hard_links && file->link_u.links)
 +					push_hlink_num(i);
  				handle_partial_dir(partialptr, PDIR_DELETE);
  			}
  		}
-@@ -349,11 +349,6 @@ int recv_files(int f_in, struct file_lis
+@@ -355,11 +355,6 @@ int recv_files(int f_in, struct file_lis
  	if (verbose > 2)
  		rprintf(FINFO,"recv_files(%d) starting\n",flist->count);
  
 -	if (flist->hlink_pool) {
 -		pool_destroy(flist->hlink_pool);
 -		flist->hlink_pool = NULL;
 -	}
 -
  	if (delay_updates)
  		delayed_bits = bitbag_create(flist->count);
  
-@@ -374,7 +369,7 @@ int recv_files(int f_in, struct file_lis
+@@ -382,7 +377,7 @@ int recv_files(int f_in, struct file_lis
  				rprintf(FINFO, "recv_files phase=%d\n", phase);
  			if (phase == 2 && delay_updates)
  				handle_delayed_updates(flist, local_name);
 -			send_msg(MSG_DONE, "", 0);
 +			push_redo_num(-2);
  			if (keep_partial && !partial_dir)
  				make_backups = 0; /* prevents double backup */
  			if (append_mode) {
-@@ -596,7 +591,7 @@ int recv_files(int f_in, struct file_lis
+@@ -607,7 +602,7 @@ int recv_files(int f_in, struct file_lis
  		/* log the transfer */
  		if (log_before_transfer)
- 			log_item(file, &initial_stats, iflags, NULL);
+ 			log_item(FCLIENT, file, &initial_stats, iflags, NULL);
 -		else if (!am_server && verbose && do_progress)
 +		else if (!am_server && verbose && recv_progress)
  			rprintf(FINFO, "%s\n", fname);
  
  		/* recv file data */
-@@ -639,11 +634,13 @@ int recv_files(int f_in, struct file_lis
+@@ -654,11 +649,13 @@ int recv_files(int f_in, struct file_lis
  		cleanup_disable();
  
  		if (recv_ok > 0) {
--			if (remove_sent_files
+-			if (remove_source_files
 -			    || (preserve_hard_links && file->link_u.links)) {
-+			if (remove_sent_files) {
++			if (remove_source_files) {
 +				decrement_active_files(i);
  				SIVAL(numbuf, 0, i);
  				send_msg(MSG_SUCCESS, numbuf, 4);
  			}
 +			if (preserve_hard_links && file->link_u.links)
 +				push_hlink_num(i);
  		} else if (!recv_ok) {
  			int msgtype = phase || read_batch ? FERROR : FINFO;
  			if (msgtype == FERROR || verbose) {
-@@ -666,8 +663,8 @@ int recv_files(int f_in, struct file_lis
+@@ -681,8 +678,8 @@ int recv_files(int f_in, struct file_lis
  					errstr, fname, keptstr, redostr);
  			}
  			if (!phase) {
 -				SIVAL(numbuf, 0, i);
 -				send_msg(MSG_REDO, numbuf, 4);
 +				decrement_active_files(i);
 +				push_redo_num(i);
  			}
  		}
  	}
 --- old/rsync.c
 +++ new/rsync.c
-@@ -40,7 +40,6 @@ extern int omit_dir_times;
+@@ -39,7 +39,6 @@ extern int omit_dir_times;
  extern int am_root;
  extern int am_server;
  extern int am_sender;
 -extern int am_generator;
  extern int am_starting_up;
  extern int allow_8bit_chars;
  extern int preserve_uid;
-@@ -303,5 +302,5 @@ const char *who_am_i(void)
+@@ -305,5 +304,5 @@ const char *who_am_i(void)
  {
  	if (am_starting_up)
  		return am_server ? "server" : "client";
 -	return am_sender ? "sender" : am_generator ? "generator" : "receiver";
 +	return am_sender ? "sender" : am_generator() ? "generator" : "receiver";
  }
 --- old/rsync.h
 +++ new/rsync.h
-@@ -168,10 +168,8 @@ enum msgcode {
+@@ -169,10 +169,8 @@ enum msgcode {
  	MSG_DATA=0,	/* raw data on the multiplexed stream */
  	MSG_ERROR=FERROR, MSG_INFO=FINFO, /* remote logging */
  	MSG_LOG=FLOG, MSG_SOCKERR=FSOCKERR, /* sibling logging */
 -	MSG_REDO=9,	/* reprocess indicated flist index */
  	MSG_SUCCESS=100,/* successfully updated indicated flist index */
  	MSG_DELETED=101,/* successfully deleted a file on receiving side */
 -	MSG_DONE=86	/* current phase is done */
  };
  
  #include "errcode.h"
-@@ -322,6 +320,7 @@ enum msgcode {
+@@ -329,6 +327,7 @@ enum msgcode {
  #endif
  
  #include <assert.h>
 +#include <pthread.h>
  
  #include "lib/pool_alloc.h"
  
 --- old/util.c
 +++ new/util.c
-@@ -420,49 +420,6 @@ int robust_rename(char *from, char *to, 
+@@ -415,49 +415,6 @@ int robust_rename(char *from, char *to, 
  	return -1;
  }
  
 -static pid_t all_pids[10];
 -static int num_pids;
 -
@@ -1293,28 +1280,37 @@
  void io_set_sock_fds(int f_in, int f_out);
  void set_io_timeout(int secs);
  void set_msg_fd_in(int fd);
 -void set_msg_fd_out(int fd);
  void increment_active_files(int ndx, int itemizing, enum logcode code);
  void decrement_active_files(int ndx);
- void send_msg(enum msgcode code, char *buf, int len);
+ int send_msg(enum msgcode code, char *buf, int len);
 -int get_redo_num(int itemizing, enum logcode code);
 +void push_redo_num(int ndx);
 +int get_redo_num(void);
 +void push_hlink_num(int ndx);
  int get_hlink_num(void);
  void io_set_filesfrom_fds(int f_in, int f_out);
  int read_filesfrom_line(int fd, char *fname);
+@@ -123,7 +124,7 @@ uchar read_byte(int f);
+ int read_vstring(int f, char *buf, int bufsize);
+ void read_sum_head(int f, struct sum_struct *sum);
+ void write_sum_head(int f, struct sum_struct *sum);
+-void io_flush(int flush_it_all);
++void io_flush(UNUSED(int flush_it_all));
+ void write_shortint(int f, int x);
+ void write_int(int f,int32 x);
+ void write_longint(int f, int64 x);
 @@ -139,7 +140,6 @@ int io_multiplex_write(enum msgcode code
  void close_multiplexing_in(void);
  void close_multiplexing_out(void);
  void start_write_batch(int fd);
 -void stop_write_batch(void);
  char *lp_bind_address(void);
- char *lp_log_file(void);
  char *lp_motd_file(void);
+ char *lp_pid_file(void);
 @@ -198,6 +198,8 @@ void maybe_log_item(struct file_struct *
  		    char *buf);
  void log_delete(char *fname, int mode);
  void log_exit(int code, const char *file, int line);
 +int am_generator();
 +int am_receiver();
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/time-limit.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/time-limit.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/time-limit.diff	2006-04-23 00:11:57.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/time-limit.diff	2006-11-07 12:43:57.000000000 +0800
@@ -1,22 +1,28 @@
 John Taylor's patch for implementing --time-limit and --stop-at, reworked
 to be simpler and more efficient by Wayne Davison.
 
 Do we need configure support for mktime()?
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/time-limit.diff
+    ./configure                              (optional if already run)
+    make
+
 --- old/io.c
 +++ new/io.c
-@@ -56,6 +56,7 @@ extern int remove_sent_files;
+@@ -50,6 +50,7 @@ extern int remove_source_files;
  extern int preserve_hard_links;
  extern char *filesfrom_host;
  extern struct stats stats;
 +extern time_t stop_at_utime;
  extern struct file_list *the_file_list;
  
  const char phase_unknown[] = "unknown";
-@@ -153,16 +154,24 @@ static void check_timeout(void)
+@@ -147,16 +148,24 @@ static void check_timeout(void)
  {
  	time_t t;
  
 +	if ((!io_timeout || ignore_timeout) && !stop_at_utime)
 +		return;
 +
@@ -40,48 +46,48 @@
 -
  	if (t - last_io_in >= io_timeout) {
  		if (!am_server && !am_daemon) {
  			rprintf(FERROR, "io timeout after %d seconds -- exiting\n",
 --- old/options.c
 +++ new/options.c
-@@ -114,6 +114,7 @@ int checksum_seed = 0;
+@@ -116,6 +116,7 @@ int checksum_seed = 0;
  int inplace = 0;
  int delay_updates = 0;
  long block_size = 0; /* "long" because popt can't set an int32. */
 +time_t stop_at_utime = 0;
  
  
  /** Network address family. **/
-@@ -363,6 +364,8 @@ void usage(enum logcode F)
+@@ -377,6 +378,8 @@ void usage(enum logcode F)
    rprintf(F,"     --password-file=FILE    read password from FILE\n");
    rprintf(F,"     --list-only             list the files instead of copying them\n");
    rprintf(F,"     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second\n");
 +  rprintf(F,"     --stop-at=y-m-dTh:m     Stop rsync at year-month-dayThour:minute\n");
 +  rprintf(F,"     --time-limit=MINS       Stop rsync after MINS minutes have elapsed\n");
    rprintf(F,"     --write-batch=FILE      write a batched update to FILE\n");
    rprintf(F,"     --only-write-batch=FILE like --write-batch but w/o updating destination\n");
    rprintf(F,"     --read-batch=FILE       read a batched update from FILE\n");
-@@ -383,7 +386,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
+@@ -398,7 +401,7 @@ enum {OPT_VERSION = 1000, OPT_DAEMON, OP
        OPT_FILTER, OPT_COMPARE_DEST, OPT_COPY_DEST, OPT_LINK_DEST, OPT_HELP,
        OPT_INCLUDE, OPT_INCLUDE_FROM, OPT_MODIFY_WINDOW, OPT_MIN_SIZE, OPT_CHMOD,
        OPT_READ_BATCH, OPT_WRITE_BATCH, OPT_ONLY_WRITE_BATCH, OPT_MAX_SIZE,
 -      OPT_NO_D,
 +      OPT_NO_D, OPT_STOP_AT, OPT_TIME_LIMIT,
        OPT_SERVER, OPT_REFUSED_BASE = 9000};
  
  static struct poptOption long_options[] = {
-@@ -495,6 +498,8 @@ static struct poptOption long_options[] 
-   {"log-format",       0,  POPT_ARG_STRING, &log_format, 0, 0, 0 },
+@@ -516,6 +519,8 @@ static struct poptOption long_options[] 
+   {"log-format",       0,  POPT_ARG_STRING, &stdout_format, 0, 0, 0 }, /* DEPRECATED */
    {"itemize-changes", 'i', POPT_ARG_NONE,   0, 'i', 0, 0 },
    {"bwlimit",          0,  POPT_ARG_INT,    &bwlimit, 0, 0, 0 },
 +  {"stop-at",          0,  POPT_ARG_STRING, 0, OPT_STOP_AT, 0, 0 },
 +  {"time-limit",       0,  POPT_ARG_STRING, 0, OPT_TIME_LIMIT, 0, 0 },
    {"backup",          'b', POPT_ARG_NONE,   &make_backups, 0, 0, 0 },
    {"backup-dir",       0,  POPT_ARG_STRING, &backup_dir, 0, 0, 0 },
    {"suffix",           0,  POPT_ARG_STRING, &backup_suffix, 0, 0, 0 },
-@@ -1066,6 +1071,36 @@ int parse_arguments(int *argc, const cha
+@@ -1089,6 +1094,36 @@ int parse_arguments(int *argc, const cha
  			usage(FINFO);
  			exit_cleanup(0);
  
 +		case OPT_STOP_AT:
 +			arg = poptGetOptArg(pc);
 +			if ((stop_at_utime = parse_time(arg)) == (time_t)-1) {
@@ -112,13 +118,13 @@
 +			stop_at_utime += time(NULL);
 +			break;
 +
  		default:
  			/* A large opt value means that set_refuse_options()
  			 * turned this option off. */
-@@ -1619,6 +1654,15 @@ void server_options(char **args,int *arg
+@@ -1642,6 +1677,15 @@ void server_options(char **args,int *arg
  		args[ac++] = arg;
  	}
  
 +	if (stop_at_utime) {
 +		long mins = (stop_at_utime - time(NULL)) / 60;
 +		if (mins <= 0)
@@ -130,22 +136,22 @@
 +
  	if (backup_dir) {
  		args[ac++] = "--backup-dir";
  		args[ac++] = backup_dir;
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -391,6 +391,8 @@ to the detailed description below for a 
+@@ -394,6 +394,8 @@ to the detailed description below for a 
       --password-file=FILE    read password from FILE
       --list-only             list the files instead of copying them
       --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
 +     --stop-at=y-m-dTh:m     Stop rsync at year-month-dayThour:minute
 +     --time-limit=MINS       Stop rsync after MINS minutes have elapsed
       --write-batch=FILE      write a batched update to FILE
       --only-write-batch=FILE like --write-batch but w/o updating dest
       --read-batch=FILE       read a batched update from FILE
-@@ -1685,6 +1687,19 @@ transfer was too fast, it will wait befo
+@@ -1733,6 +1735,19 @@ transfer was too fast, it will wait befo
  result is an average transfer rate equaling the specified limit. A value
  of zero specifies no limit.
  
 +dit(bf(--stop-at=y-m-dTh:m)) This option allows you to specify at what
 +time to stop rsync, in year-month-dayThour:minute numeric format (e.g.
 +2004-12-31T23:59).  You can specify a 2 or 4-digit year.  You can also
@@ -161,13 +167,13 @@
 +
  dit(bf(--write-batch=FILE)) Record a file that can later be applied to
  another identical destination with bf(--read-batch). See the "BATCH MODE"
  section for details, and also the bf(--only-write-batch) option.
 --- old/util.c
 +++ new/util.c
-@@ -126,6 +126,133 @@ void overflow_exit(char *str)
+@@ -121,6 +121,133 @@ NORETURN void overflow_exit(char *str)
  	exit_cleanup(RERR_MALLOC);
  }
  
 +/* Allow the user to specify a time in the format yyyy-mm-ddThh:mm while
 + * also allowing abbreviated data.  For instance, if the time is omitted,
 + * it defaults to midnight.  If the date is omitted, it defaults to the
@@ -299,45 +305,45 @@
  {
  #if !defined HAVE_LUTIMES || !defined HAVE_UTIMES
 --- old/proto.h
 +++ new/proto.h
 @@ -278,6 +278,7 @@ int fd_pair(int fd[2]);
  void print_child_argv(char **cmd);
- void out_of_memory(char *str);
- void overflow_exit(char *str);
+ NORETURN void out_of_memory(char *str);
+ NORETURN void overflow_exit(char *str);
 +time_t parse_time(const char *arg);
  int set_modtime(char *fname, time_t modtime, mode_t mode);
  int mkdir_defmode(char *fname);
  int create_directory_path(char *fname);
 --- old/rsync.1
 +++ new/rsync.1
-@@ -447,6 +447,8 @@ to the detailed description below for a 
-      --password-file=FILE    read password from FILE
-      --list-only             list the files instead of copying them
-      --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
-+     --stop-at=y-m-dTh:m     Stop rsync at year-month-dayThour:minute
-+     --time-limit=MINS       Stop rsync after MINS minutes have elapsed
-      --write-batch=FILE      write a batched update to FILE
-      --only-write-batch=FILE like --write-batch but w/o updating dest
-      --read-batch=FILE       read a batched update from FILE
-@@ -1930,6 +1932,21 @@ transfer was too fast, it will wait befo
+@@ -460,6 +460,8 @@ to the detailed description below for a 
+      \-\-password\-file=FILE    read password from FILE
+      \-\-list\-only             list the files instead of copying them
+      \-\-bwlimit=KBPS          limit I/O bandwidth; KBytes per second
++     \-\-stop\-at=y-m-dTh:m     Stop rsync at year-month-dayThour:minute
++     \-\-time\-limit=MINS       Stop rsync after MINS minutes have elapsed
+      \-\-write\-batch=FILE      write a batched update to FILE
+      \-\-only\-write\-batch=FILE like \-\-write\-batch but w/o updating dest
+      \-\-read\-batch=FILE       read a batched update from FILE
+@@ -2009,6 +2011,21 @@ transfer was too fast, it will wait befo
  result is an average transfer rate equaling the specified limit\&. A value
  of zero specifies no limit\&.
  .IP 
-+.IP "\fB--stop-at=y-m-dTh:m\fP" 
++.IP "\fB\-\-stop\-at=y-m-dTh:m\fP"
 +This option allows you to specify at what
 +time to stop rsync, in year-month-dayThour:minute numeric format (e\&.g\&.
-+2004-12-31T23:59)\&.  You can specify a 2 or 4-digit year\&.  You can also
++2004\-12\-31T23:59)\&.  You can specify a 2 or 4-digit year\&.  You can also
 +leave off various items and the result will be the next possible time
-+that matches the specified data\&.  For example, "1-30" specifies the next
++that matches the specified data\&.  For example, "1\-30" specifies the next
 +January 30th (at midnight), "04:00" specifies the next 4am, "1"
 +specifies the next 1st of the month at midnight, and ":59" specifies the
 +next 59th minute after the hour\&.  If you prefer, you may separate the
 +date numbers using slashes instead of dashes\&.
 +.IP 
-+.IP "\fB--time-limit=MINS\fP" 
++.IP "\fB\-\-time\-limit=MINS\fP"
 +This option allows you to specify the maximum
 +number of minutes rsync will run for\&.
 +.IP 
- .IP "\fB--write-batch=FILE\fP" 
+ .IP "\fB\-\-write\-batch=FILE\fP"
  Record a file that can later be applied to
- another identical destination with \fB--read-batch\fP\&. See the "BATCH MODE"
+ another identical destination with \fB\-\-read\-batch\fP\&. See the "BATCH MODE"
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/tru64.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/tru64.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/tru64.diff	2006-02-06 14:32:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/tru64.diff	2006-11-02 05:33:37.000000000 +0800
@@ -1,8 +1,14 @@
 This is an adapted version of the original by Zoong Pham.
 
+To use this patch, run these commands for a successful build:
+
+    patch -p1 <patches/tru64.diff
+    ./configure                          (optional if already run)
+    make
+
 --- old/lib/getaddrinfo.c
 +++ new/lib/getaddrinfo.c
 @@ -41,6 +41,20 @@
  
  #include <rsync.h>
  
@@ -22,13 +28,13 @@
 +
  #if defined(__KAME__) && defined(INET6)
  # define FAITH
  #endif
 --- old/syscall.c
 +++ new/syscall.c
-@@ -27,6 +27,7 @@
+@@ -24,6 +24,7 @@
  #include "rsync.h"
  
  #if !defined MKNOD_CREATES_SOCKETS && defined HAVE_SYS_UN_H
 +#define _SOCKADDR_LEN
  #include <sys/un.h>
  #endif
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/verify-patches /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/verify-patches
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/verify-patches	2006-03-15 09:59:45.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/verify-patches	2006-11-02 05:33:37.000000000 +0800
@@ -30,13 +30,13 @@
 from inside the patches subdir.
 EOT
 }
 
 $ENV{'LC_COLLATE'} = 'C';
 $| = 1;
-my $CONF_OPTS = '-C';
+my $CONF_OPTS = '--cache-file=../config.cache';
 
 my($has_dependencies, @new, @rejects);
 
 END {
     &restore_cvsdir;
     system "rsync -a --del cvsdir/ workdir/" if -d 'cvsdir';
@@ -46,40 +46,41 @@
 open(IN, '../CVS/Root') or die $!;
 chomp($root = <IN>);
 close IN;
 
 mkdir('tmp', 0777) unless -d 'tmp';
 chdir('tmp') or die "Unable to chdir to 'tmp'";
+symlink('..', 'patches') unless -d 'patches';
 
 mkdir('workdir') unless -d 'workdir';
 open(OUT, '>exclude') or die $!;
 print OUT join("\n", 'CVS', @generated_files), "\n";
 close OUT;
 
 unless ($no_cvs) {
     print "Using CVS to update the tmp/cvsdir copy of the source.\n";
     system qq|cvs -qd "$root" co -P -d cvsdir rsync|;
 }
 
-@ARGV = glob('../*.diff') unless @ARGV;
+@ARGV = glob('patches/*.diff') unless @ARGV;
 
 DIFF:
 foreach my $diff (@ARGV) {
     next unless $diff =~ /\.diff$/;
     next if $diff =~ /gzip-rsyncable[-_a-z]*\.diff$/;
     $diff =~ s#^(patches|\.\.)/##;
 
     my $conf_opts;
-    open(IN, "../$diff") or die $!;
+    open(IN, "patches/$diff") or die $!;
     while (<IN>) {
 	last if /^--- /;
-	if (/^Depends-On-Patch: (\S+.diff)$/) {
+	if (m#^\s+patch -p1 <patches/(\S+.diff)# && $1 ne $diff) {
 	    my $dep = $1;
 	    $has_dependencies = 1;
 	    print "\nApplying dependency patch $dep...\n";
-	    if (system("patch -d cvsdir -p1 -b -Vt <../$dep") != 0) {
+	    if (system("patch -d cvsdir -p1 -b -Vt <patches/$dep") != 0) {
 		print "Unable to cleanly apply dependency patch -- skipping $diff\n";
 		system "rm -f cvsdir/*.rej cvsdir/*/*.rej";
 		&restore_cvsdir;
 		next DIFF;
 	    }
 	    sleep(1) if $prepare_source; # Ensure later diffs get later times.
@@ -155,13 +156,13 @@
 	    if ($cmd eq 'D') {
 		$default = generate_new_patch($diff);
 		next;
 	    }
 	    if ($cmd eq 'E') {
 		chdir('workdir') or die $!;
-		system "vim -d ../../$diff ../new.patch";
+		system "vim -d ../patches/$diff ../new.patch";
 		chdir('..') or die $!;
 		$default = 'U,A,D';
 		next;
 	    }
 	    if ($cmd eq 'F') {
 		chdir('workdir') or die $!;
@@ -174,13 +175,13 @@
 		last PROMPT;
 	    }
 	    if ($cmd eq 'Q') {
 		exit;
 	    }
 	    if ($cmd eq 'U') {
-		system "cp -p new.patch ../$diff";
+		system "cp -p new.patch patches/$diff";
 		print "\nUpdated $diff from new.patch\n";
 		$default = 'A';
 		next;
 	    }
 	}
     }
@@ -197,13 +198,13 @@
 
     undef @new;
     system "rsync -a --delete --exclude='*~' cvsdir/ workdir/";
     print "\nApplying patch $diff...\n";
     undef @rejects;
     my($saw_offset, $saw_fuzz);
-    open(IN, "patch -d workdir -p1 --no-backup-if-mismatch <../$diff |") or die $!;
+    open(IN, "patch -d workdir -p1 --no-backup-if-mismatch <patches/$diff |") or die $!;
     while (<IN>) {
 	print $_;
 	chomp;
 	if (s/^patching file //) {
 	    push(@new, $_) unless -f "cvsdir/$_";
 	} elsif (s/.* saving rejects to file //) {
@@ -237,33 +238,33 @@
 {
     my($diff) = @_;
 
     foreach (@new) {
 	system "touch -r workdir/$_ cvsdir/$_";
     }
-    open(IN, "../$diff") or die $!;
+    open(IN, "patches/$diff") or die $!;
     open(OUT, '>new.patch') or die $!;
     while (<IN>) {
 	last if /^--- /;
 	print OUT $_;
     }
     close IN;
-    &filter_diff('diff --exclude-from=exclude -upr cvsdir workdir');
+    &filter_diff('diff --exclude-from=exclude -dupr cvsdir workdir');
     if ($prepare_source) {
 	# These are not included in the diff above so that patch will give
 	# generated files a later timestamp than the source files.
 	foreach my $fn (@generated_files) {
-	    &filter_diff("diff -up cvsdir/$fn workdir");
+	    &filter_diff("diff -dup cvsdir/$fn workdir");
 	}
     }
     close OUT;
     foreach (@new) {
 	unlink("cvsdir/$_");
     }
     print "\nDiffing... ";
-    if (system("diff ../$diff new.patch >/dev/null") == 0) {
+    if (system("diff patches/$diff new.patch >/dev/null") == 0) {
 	print "new patch is identical to old.\n";
 	return 'N';
     }
     print "New patch DIFFERS from old.\n";
     'E';
 }
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/xattrs.diff /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/xattrs.diff
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/patches/xattrs.diff	2006-04-23 00:12:16.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/patches/xattrs.diff	2006-11-07 12:44:13.000000000 +0800
@@ -1,17 +1,37 @@
-Depends-On-Patch: acls.diff
+This patch adds basic support for extended attributes.  It works, but there
+are some things that still needs to be improved (see TODO list below).
 
-After applying this patch, run these commands for a successful build:
+To use this patch, run these commands for a successful build:
 
+    patch -p1 <patches/acls.diff
+    patch -p1 <patches/xattrs.diff
     ./prepare-source
     ./configure --enable-acl-support --enable-xattr-support
     make
 
+Alternately, if you don't want ACL support, configure it this way:
+
+    ./configure --enable-xattr-support
+
+TODO:
+
+ - This patch needs to more efficiently handle large xattrs, especially when
+   they're unchanged.
+
+ - Extraneous xattr values need to be removed from files that are not being
+   recreated.
+
+ - We need to affect the itemized output to know when xattrs are being updated.
+
+ - We need to affect the --link-dest option to avoid hard-linking two files
+   that differ in their xattrs (when --xattrs was specified).
+
 --- old/Makefile.in
 +++ new/Makefile.in
-@@ -27,13 +27,13 @@ VERSION=@VERSION@
+@@ -28,13 +28,13 @@ VERSION=@VERSION@
  
  HEADERS=byteorder.h config.h errcode.h proto.h rsync.h smb_acls.h lib/pool_alloc.h
  LIBOBJ=lib/wildmatch.o lib/compat.o lib/snprintf.o lib/mdfour.o \
 -	lib/permstring.o lib/pool_alloc.o lib/sysacls.o @LIBOBJS@
 +	lib/permstring.o lib/pool_alloc.o lib/sysacls.o lib/sysxattr.o @LIBOBJS@
  ZLIBOBJ=zlib/deflate.o zlib/inffast.o zlib/inflate.o zlib/inftrees.o \
@@ -21,270 +41,491 @@
  OBJS2=options.o flist.o io.o compat.o hlink.o token.o uidlist.o socket.o \
 -	fileio.o batch.o clientname.o chmod.o acls.o
 +	fileio.o batch.o clientname.o chmod.o acls.o xattr.o
  OBJS3=progress.o pipe.o
  DAEMON_OBJ = params.o loadparm.o clientserver.o access.o connection.o authenticate.o
  popt_OBJS=popt/findme.o  popt/popt.o  popt/poptconfig.o \
+--- old/acls.c
++++ new/acls.c
+@@ -30,6 +30,7 @@ extern int read_only;
+ extern int list_only;
+ extern int orig_umask;
+ extern int preserve_acls;
++extern int preserve_xattrs;
+ extern unsigned int file_struct_len;
+ 
+ /* === ACL structures === */
+@@ -741,6 +742,10 @@ void receive_acl(struct file_struct *fil
+ 	type = SMB_ACL_TYPE_ACCESS;
+ 	racl_list = &access_acl_list;
+ 	ndx_ptr = (char*)file + file_struct_len;
++#ifdef SUPPORT_XATTRS
++	if (preserve_xattrs)
++		ndx_ptr += 4;
++#endif
+ 	do {
+ 		char tag = read_byte(f);
+ 		int ndx;
+@@ -800,6 +805,10 @@ void cache_acl(struct file_struct *file,
+ 	racl = sxp->acc_acl;
+ 	racl_list = &access_acl_list;
+ 	ndx_ptr = (char*)file + file_struct_len;
++#ifdef SUPPORT_XATTRS
++	if (preserve_xattrs)
++		ndx_ptr += 4;
++#endif
+ 	do {
+ 		if (!racl)
+ 			ndx = -1;
+@@ -920,6 +929,10 @@ int set_acl(const char *fname, const str
+ 
+ 	type = SMB_ACL_TYPE_ACCESS;
+ 	ndx_ptr = (char*)file + file_struct_len;
++#ifdef SUPPORT_XATTRS
++	if (preserve_xattrs)
++		ndx_ptr += 4;
++#endif
+ 	do {
+ 		acl_duo *duo_item;
+ 		BOOL eq;
 --- old/backup.c
 +++ new/backup.c
-@@ -29,6 +29,7 @@ extern char *backup_dir;
+@@ -30,6 +30,7 @@ extern char *backup_dir;
  
  extern int am_root;
  extern int preserve_acls;
 +extern int preserve_xattrs;
  extern int preserve_devices;
  extern int preserve_specials;
  extern int preserve_links;
-@@ -137,6 +138,10 @@ static int make_bak_dir(char *fullpath)
- 				if (preserve_acls)
- 					dup_acl(end, fullpath, st.st_mode);
+@@ -136,6 +137,9 @@ static int make_bak_dir(char *fullpath)
+ #ifdef SUPPORT_ACLS
+ 				sx.acc_acl = sx.def_acl = NULL;
+ #endif
++#ifdef SUPPORT_XATTRS
++				sx.xattr = NULL;
++#endif
+ 				if (!(file = make_file(rel, NULL, NULL, 0, NO_FILTERS)))
+ 					continue;
+ #ifdef SUPPORT_ACLS
+@@ -144,6 +148,12 @@ static int make_bak_dir(char *fullpath)
+ 					cache_acl(file, &sx);
+ 				}
  #endif
 +#ifdef SUPPORT_XATTRS
-+				if (preserve_xattrs)
-+					dup_xattr(end, fullpath );
++				if (preserve_xattrs) {
++					get_xattr(rel, &sx);
++					cache_xattr(file, &sx);
++				}
 +#endif
+ 				set_file_attrs(fullpath, file, NULL, 0);
+ 				free(file);
  			}
- 		}
- 		*p = '/';
-@@ -194,6 +199,10 @@ static int keep_backup(char *fname)
- 	if (preserve_acls)
- 		push_keep_backup_acl(file, fname, buf);
+@@ -195,6 +205,9 @@ static int keep_backup(char *fname)
+ #ifdef SUPPORT_ACLS
+ 	sx.acc_acl = sx.def_acl = NULL;
  #endif
 +#ifdef SUPPORT_XATTRS
-+	if (preserve_xattrs)
-+		push_keep_backup_xattr(file, fname, buf);
++	sx.xattr = NULL;
 +#endif
  
- 	/* Check to see if this is a device file, or link */
- 	if ((am_root && preserve_devices && IS_DEVICE(file->mode))
-@@ -274,6 +283,10 @@ static int keep_backup(char *fname)
- 	if (preserve_acls)
- 		cleanup_keep_backup_acl();
+ 	if (!(file = make_file(fname, NULL, NULL, 0, NO_FILTERS)))
+ 		return 1; /* the file could have disappeared */
+@@ -208,6 +221,12 @@ static int keep_backup(char *fname)
+ 		cache_acl(file, &sx);
+ 	}
  #endif
 +#ifdef SUPPORT_XATTRS
-+	if (preserve_xattrs)
-+		cleanup_keep_backup_xattr();
++	if (preserve_xattrs) {
++		get_xattr(fname, &sx);
++		cache_xattr(file, &sx);
++	}
 +#endif
- 	free(file);
  
- 	if (verbose > 1) {
+ 	/* Check to see if this is a device file, or link */
+ 	if ((am_root && preserve_devices && IS_DEVICE(file->mode))
 --- old/configure.in
 +++ new/configure.in
-@@ -823,6 +823,30 @@ samba_cv_HAVE_ACL_GET_PERM_NP=yes,samba_
+@@ -856,6 +856,40 @@ samba_cv_HAVE_ACL_GET_PERM_NP=yes,samba_
    AC_MSG_RESULT(no)
  )
  
 +AC_CHECK_HEADERS(attr/xattr.h)
++AC_CHECK_HEADERS(sys/xattr.h)
++AC_CHECK_HEADERS(sys/extattr.h)
 +AC_MSG_CHECKING(whether to support extended attributes)
 +AC_ARG_ENABLE(xattr-support,
 +AC_HELP_STRING([--enable-xattr-support], [Include extended attribute support (default=no)]),
 +[ case "$enableval" in
 +  yes)
 +      case "$host_os" in
 +      *linux*)
 +            AC_MSG_RESULT(Using Linux xattrs)
 +            AC_DEFINE(HAVE_LINUX_XATTRS, 1, [True if you have Linux xattrs])
 +            ;;
++      darwin*)
++            AC_MSG_RESULT(Using OS X xattrs)
++            AC_DEFINE(HAVE_OSX_XATTRS, 1, [True if you have Mac OS X xattrs])
++            ;;
++      freebsd*)
++            AC_MSG_RESULT(Using FreeBSD extattrs)
++            AC_DEFINE(HAVE_FREEBSD_XATTRS, 1, [True if you have FreeBSD xattrs])
++            ;;
 +      *)
-+            AC_MSG_RESULT(Xattrs requested but not linux.  Good luck)
++            AC_MSG_RESULT(Xattrs requested but not Linux or OS X.  Good luck...)
 +            ;;
 +      esac
 +      ;;
 +  *)
 +      AC_MSG_RESULT(no)
-+      AC_DEFINE(HAVE_NA_XATTRS, 1, [True if you don't have extended attributes])
++      AC_DEFINE(HAVE_NO_XATTRS, 1, [True if you don't have extended attributes])
 +  esac ],
 +  AC_MSG_RESULT(no)
-+  AC_DEFINE(HAVE_NO_XATTRL, 1, [True if you don't have extended attributes])
++  AC_DEFINE(HAVE_NO_XATTRS, 1, [True if you don't have extended attributes])
 +)
 +
  AC_CONFIG_FILES([Makefile lib/dummy zlib/dummy popt/dummy shconfig])
  AC_OUTPUT
  
 --- old/flist.c
 +++ new/flist.c
-@@ -45,6 +45,7 @@ extern int one_file_system;
+@@ -41,6 +41,7 @@ extern int one_file_system;
  extern int copy_dirlinks;
  extern int keep_dirlinks;
  extern int preserve_acls;
 +extern int preserve_xattrs;
  extern int preserve_links;
  extern int preserve_hard_links;
  extern int preserve_devices;
-@@ -970,6 +971,10 @@ static struct file_struct *send_file_nam
- 	if (preserve_acls && make_acl(file, fname) < 0)
- 		return NULL;
+@@ -498,7 +499,7 @@ static struct file_struct *receive_file_
+ 	char thisname[MAXPATHLEN];
+ 	unsigned int l1 = 0, l2 = 0;
+ 	int alloc_len, basename_len, dirname_len, linkname_len, sum_len;
+-#ifdef SUPPORT_ACLS
++#if defined SUPPORT_ACLS || defined SUPPORT_XATTRS
+ 	int xtra_len;
+ #endif
+ 	OFF_T file_length;
+@@ -610,10 +611,16 @@ static struct file_struct *receive_file_
+ 		xtra_len = (S_ISDIR(mode) ? 2 : 1) * 4;
+ 	else
+ 		xtra_len = 0;
++#elif defined SUPPORT_XATTRS
++	xtra_len = 0;
++#endif
++#ifdef SUPPORT_XATTRS
++	if (preserve_xattrs)
++		xtra_len += 4;
+ #endif
+ 
+ 	alloc_len = file_struct_len + dirname_len + basename_len
+-#ifdef SUPPORT_ACLS
++#if defined SUPPORT_ACLS || defined SUPPORT_XATTRS
+ 		  + xtra_len
+ #endif
+ 		  + linkname_len + sum_len;
+@@ -622,7 +629,7 @@ static struct file_struct *receive_file_
+ 	file = (struct file_struct *)bp;
+ 	memset(bp, 0, file_struct_len);
+ 	bp += file_struct_len;
+-#ifdef SUPPORT_ACLS
++#if defined SUPPORT_ACLS || defined SUPPORT_XATTRS
+ 	bp += xtra_len;
+ #endif
+ 
+@@ -723,6 +730,10 @@ static struct file_struct *receive_file_
+ 	if (preserve_acls)
+ 		receive_acl(file, f);
+ #endif
++#ifdef SUPPORT_XATTRS
++	if (preserve_xattrs)
++		receive_xattr(file, f );
++#endif
+ 
+ 	return file;
+ }
+@@ -974,7 +985,7 @@ static struct file_struct *send_file_nam
+ 					  unsigned short flags)
+ {
+ 	struct file_struct *file;
+-#ifdef SUPPORT_ACLS
++#if defined SUPPORT_ACLS || defined SUPPORT_XATTRS
+ 	statx sx;
+ #endif
+ 
+@@ -994,6 +1005,13 @@ static struct file_struct *send_file_nam
+ 			return NULL;
+ 	}
  #endif
 +#ifdef SUPPORT_XATTRS
-+	if (preserve_xattrs && make_xattr(file, fname) < 0)
-+		return NULL;
++	if (preserve_xattrs) {
++		sx.xattr = NULL;
++		if (get_xattr(fname, &sx) < 0)
++			return NULL;
++	}
 +#endif
  
  	maybe_emit_filelist_progress(flist->count + flist_count_offset);
  
-@@ -982,12 +987,20 @@ static struct file_struct *send_file_nam
+@@ -1006,11 +1024,19 @@ static struct file_struct *send_file_nam
  		if (preserve_acls)
- 			send_acl(file, f);
+ 			send_acl(&sx, f);
  #endif
 +#ifdef SUPPORT_XATTRS
 +		if (preserve_xattrs)
-+			send_xattr(file, f);
++			send_xattr(&sx, f);
 +#endif
  	} else {
  #ifdef SUPPORT_ACLS
- 		/* Cleanup unsent ACL(s). */
  		if (preserve_acls)
- 			send_acl(file, -1);
+ 			free_acl(&sx);
  #endif
 +#ifdef SUPPORT_XATTRS
 +		if (preserve_xattrs)
-+			send_xattr(file, -1);
++			free_xattr(&sx);
 +#endif
  	}
  	return file;
  }
-@@ -1380,6 +1393,10 @@ struct file_list *recv_file_list(int f)
- 		if (preserve_acls)
- 			receive_acl(file, f);
- #endif
-+#ifdef SUPPORT_XATTRS
-+		if (preserve_xattrs)
-+			receive_xattr(file, f );
-+#endif
- 
- 		if (S_ISREG(file->mode) || S_ISLNK(file->mode))
- 			stats.total_size += file->length;
-@@ -1407,6 +1424,10 @@ struct file_list *recv_file_list(int f)
- 	if (preserve_acls)
- 		sort_file_acl_index_lists();
- #endif
-+#ifdef SUPPORT_XATTRS
-+	if (preserve_xattrs)
-+		sort_file_xattr_index_lists();
-+#endif
- 
- 	if (f >= 0) {
- 		recv_uid_list(f, flist);
 --- old/lib/sysxattr.c
 +++ new/lib/sysxattr.c
-@@ -0,0 +1,41 @@
-+/* Extended attribute support for rsync. */
-+/* This file Copyright (C) 2004 Red Hat, Inc. */
-+/* Written by Jay Fenlason */
-+
-+/* This program is free software; you can redistribute it and/or modify
-+   it under the terms of the GNU General Public License as published by
-+   the Free Software Foundation; either version 2 of the License, or
-+   (at your option) any later version.
-+
-+   This program is distributed in the hope that it will be useful,
-+   but WITHOUT ANY WARRANTY; without even the implied warranty of
-+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-+   GNU General Public License for more details.
-+
-+   You should have received a copy of the GNU General Public License
-+   along with this program; if not, write to the Free Software
-+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-+*/
+@@ -0,0 +1,135 @@
++/*
++ * Extended attribute support for rsync.
++ *
++ * Copyright (C) 2004 Red Hat, Inc.
++ * Written by Jay Fenlason.
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License along
++ * with this program; if not, write to the Free Software Foundation, Inc.,
++ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
++ */
 +
 +#include "rsync.h"
++#include "sysxattr.h"
++
++#ifdef SUPPORT_XATTRS
 +
 +#if defined HAVE_LINUX_XATTRS
 +
 +ssize_t sys_lgetxattr(const char *path, const char *name, void *value, size_t size)
 +{
 +	return lgetxattr(path, name, value, size);
 +}
 +
-+int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size, int flags)
++ssize_t sys_fgetxattr(int filedes, const char *name, void *value, size_t size)
++{
++	return fgetxattr(filedes, name, value, size);
++}
++
++int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size)
++{
++	return lsetxattr(path, name, value, size, 0);
++}
++
++int sys_lremovexattr(const char *path, const char *name)
 +{
-+	return lsetxattr(path, name, value, size, flags);
++	return lremovexattr(path, name);
 +}
 +
 +ssize_t sys_llistxattr(const char *path, char *list, size_t size)
 +{
 +	return llistxattr(path, list, size);
 +}
 +
++#elif HAVE_OSX_XATTRS
++
++ssize_t sys_lgetxattr(const char *path, const char *name, void *value, size_t size)
++{
++	return getxattr(path, name, value, size, 0, XATTR_NOFOLLOW);
++}
++
++ssize_t sys_fgetxattr(int filedes, const char *name, void *value, size_t size)
++{
++	return fgetxattr(filedes, name, value, size, 0, 0);
++}
++
++int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size)
++{
++	return setxattr(path, name, value, size, 0, XATTR_NOFOLLOW);
++}
++
++int sys_lremovexattr(const char *path, const char *name)
++{
++	return removexattr(path, name, XATTR_NOFOLLOW);
++}
++
++ssize_t sys_llistxattr(const char *path, char *list, size_t size)
++{
++	return listxattr(path, list, size, XATTR_NOFOLLOW);
++}
++
++#elif HAVE_FREEBSD_XATTRS
++
++ssize_t sys_lgetxattr(const char *path, const char *name, void *value, size_t size)
++{
++	return extattr_get_link(path, EXTATTR_NAMESPACE_USER, name, value, size);
++}
++
++ssize_t sys_fgetxattr(int filedes, const char *name, void *value, size_t size)
++{
++	return extattr_get_fd(filedes, EXTATTR_NAMESPACE_USER, name, value, size);
++}
++
++int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size)
++{
++	return extattr_set_link(path, EXTATTR_NAMESPACE_USER, name, value, size);
++}
++
++int sys_lremovexattr(const char *path, const char *name)
++{
++	return extattr_delete_link(path, EXTATTR_NAMESPACE_USER, name);
++}
++
++ssize_t sys_llistxattr(const char *path, char *list, size_t size)
++{
++	unsigned char keylen;
++	ssize_t off, len = extattr_list_link(path, EXTATTR_NAMESPACE_USER, list, size);
++
++	if (len <= 0 || (size_t)len > size)
++		return len;
++
++	/* FreeBSD puts a single-byte length before each string, with no '\0'
++	 * terminator.  We need to change this into a series of null-terminted
++	 * strings.  Since the size is the same, we can simply transform the
++	 * output in place. */
++	for (off = 0; off < len; off += keylen + 1) {
++		keylen = ((unsigned char*)list)[off];
++		if (off + keylen >= len) {
++			/* Should be impossible, but kernel bugs happen! */
++			errno = EINVAL;
++			return -1;
++		}
++		memmove(list+off, list+off+1, keylen);
++		list[off+keylen] = '\0';
++	}
++
++	return len;
++}
++
 +#else
 +
-+#endif /* No xattrs */
++#error You need to create xattr compatibility functions.
++
++#endif
++
++#endif /* SUPPORT_XATTRS */
 --- old/lib/sysxattr.h
 +++ new/lib/sysxattr.h
-@@ -0,0 +1,9 @@
-+#if defined HAVE_LINUX_XATTRS
+@@ -0,0 +1,26 @@
++#ifdef SUPPORT_XATTRS
++
++#if defined HAVE_ATTR_XATTR_H
++#include <attr/xattr.h>
++#elif defined HAVE_SYS_XATTR_H
++#include <sys/xattr.h>
++#elif defined HAVE_SYS_EXTATTR_H
++#include <sys/extattr.h>
++#endif
++
++/* Linux 2.4 does not define this as a distinct errno value: */
++#ifndef ENOATTR
++#define ENOATTR ENODATA
++#endif
 +
 +ssize_t sys_lgetxattr(const char *path, const char *name, void *value, size_t size);
-+int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size, int flags);
++ssize_t sys_fgetxattr(int filedes, const char *name, void *value, size_t size);
++int sys_lsetxattr(const char *path, const char *name, const void *value, size_t size);
++int sys_lremovexattr(const char *path, const char *name);
 +ssize_t sys_llistxattr(const char *path, char *list, size_t size);
 +
 +#else
 +
-+#endif /* No xattrs */
++/* No xattrs available */
++
++#endif
 --- old/options.c
 +++ new/options.c
-@@ -46,6 +46,7 @@ int copy_links = 0;
+@@ -48,6 +48,7 @@ int copy_links = 0;
  int preserve_links = 0;
  int preserve_hard_links = 0;
  int preserve_acls = 0;
 +int preserve_xattrs = 0;
  int preserve_perms = 0;
  int preserve_executability = 0;
  int preserve_devices = 0;
-@@ -194,6 +195,7 @@ static void print_rsync_version(enum log
+@@ -201,6 +202,7 @@ static void print_rsync_version(enum log
  	char const *have_inplace = "no ";
  	char const *hardlinks = "no ";
  	char const *acls = "no ";
 +	char const *xattrs = "no ";
  	char const *links = "no ";
  	char const *ipv6 = "no ";
  	STRUCT_STAT *dumstat;
-@@ -213,7 +215,9 @@ static void print_rsync_version(enum log
+@@ -220,7 +222,9 @@ static void print_rsync_version(enum log
  #ifdef SUPPORT_ACLS
  	acls = "";
  #endif
 -
 +#ifdef SUPPORT_XATTRS
 +	xattrs = "";
 +#endif
  #ifdef SUPPORT_LINKS
  	links = "";
  #endif
-@@ -227,9 +231,9 @@ static void print_rsync_version(enum log
- 	rprintf(f, "Copyright (C) 1996-2006 by Andrew Tridgell, Wayne Davison, and others.\n");
- 	rprintf(f, "<http://rsync.samba.org/>\n");
- 	rprintf(f, "Capabilities: %d-bit files, %ssocketpairs, "
--		"%shard links, %sACLs, %ssymlinks, batchfiles,\n",
-+		"%shard links, %sACLs, %sxattrs, %ssymlinks, batchfiles,\n",
- 		(int) (sizeof (OFF_T) * 8),
--		got_socketpair, hardlinks, acls, links);
-+		got_socketpair, hardlinks, acls, xattrs, links);
+@@ -236,8 +240,8 @@ static void print_rsync_version(enum log
+ 	rprintf(f, "Capabilities: %d-bit files, %ssocketpairs, %shard links, %ssymlinks,\n",
+ 		(int) (sizeof (OFF_T) * 8), got_socketpair, hardlinks, links);
+ 
+-	rprintf(f, "              batchfiles, %sinplace, %sIPv6, %sACLs,\n",
+-		have_inplace, ipv6, acls);
++	rprintf(f, "              batchfiles, %sinplace, %sIPv6, %sACLs, %sxattrs,\n",
++		have_inplace, ipv6, acls, xattrs);
  
  	/* Note that this field may not have type ino_t.  It depends
  	 * on the complicated interaction between largefile feature
-@@ -302,6 +306,9 @@ void usage(enum logcode F)
+@@ -289,7 +293,7 @@ void usage(enum logcode F)
+   rprintf(F," -q, --quiet                 suppress non-error messages\n");
+   rprintf(F,"     --no-motd               suppress daemon-mode MOTD (see manpage caveat)\n");
+   rprintf(F," -c, --checksum              skip based on checksum, not mod-time & size\n");
+-  rprintf(F," -a, --archive               archive mode; same as -rlptgoD (no -H, -A)\n");
++  rprintf(F," -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)\n");
+   rprintf(F,"     --no-OPTION             turn off an implied OPTION (e.g. --no-D)\n");
+   rprintf(F," -r, --recursive             recurse into directories\n");
+   rprintf(F," -R, --relative              use relative path names\n");
+@@ -314,6 +318,9 @@ void usage(enum logcode F)
  #ifdef SUPPORT_ACLS
    rprintf(F," -A, --acls                  preserve ACLs (implies --perms)\n");
  #endif
 +#ifdef SUPPORT_XATTRS
 +  rprintf(F," -X, --xattrs                preserve extended attributes (implies --perms)\n");
 +#endif
-   rprintf(F,"     --chmod=CHMOD           change destination permissions\n");
    rprintf(F," -o, --owner                 preserve owner (super-user only)\n");
    rprintf(F," -g, --group                 preserve group\n");
-@@ -420,6 +427,9 @@ static struct poptOption long_options[] 
+   rprintf(F,"     --devices               preserve device files (super-user only)\n");
+@@ -436,6 +443,9 @@ static struct poptOption long_options[] 
    {"acls",            'A', POPT_ARG_NONE,   0, 'A', 0, 0 },
    {"no-acls",          0,  POPT_ARG_VAL,    &preserve_acls, 0, 0, 0 },
    {"no-A",             0,  POPT_ARG_VAL,    &preserve_acls, 0, 0, 0 },
 +  {"xattrs",          'X', POPT_ARG_NONE,   0, 'X', 0, 0 },
 +  {"no-xattrs",        0,  POPT_ARG_VAL,    &preserve_xattrs, 0, 0, 0 },
 +  {"no-X",             0,  POPT_ARG_VAL,    &preserve_xattrs, 0, 0, 0 },
    {"times",           't', POPT_ARG_VAL,    &preserve_times, 1, 0, 0 },
    {"no-times",         0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
    {"no-t",             0,  POPT_ARG_VAL,    &preserve_times, 0, 0, 0 },
-@@ -1095,6 +1105,17 @@ int parse_arguments(int *argc, const cha
+@@ -1117,6 +1127,17 @@ int parse_arguments(int *argc, const cha
  			return 0;
  #endif
  
 +		case 'X':
 +#ifdef SUPPORT_XATTRS
 +			preserve_xattrs = 1;
@@ -292,76 +533,91 @@
 +			break;
 +#else
 +			snprintf(err_buf,sizeof(err_buf),
 +				 "extended attributes are not supported on this %s\n",
 +				 am_server ? "server" : "client");
 +			return 0;
-+#endif /* SUPPORT_XATTRS */
++#endif
  
  		default:
  			/* A large opt value means that set_refuse_options()
-@@ -1542,6 +1563,10 @@ void server_options(char **args,int *arg
+@@ -1563,6 +1584,10 @@ void server_options(char **args,int *arg
  	if (preserve_acls)
  		argstr[x++] = 'A';
  #endif
 +#ifdef SUPPORT_XATTRS
 +	if (preserve_xattrs)
 +		argstr[x++] = 'X';
 +#endif
  	if (preserve_uid)
  		argstr[x++] = 'o';
  	if (preserve_gid)
 --- old/rsync.c
 +++ new/rsync.c
-@@ -34,6 +34,7 @@ extern int verbose;
+@@ -33,6 +33,7 @@
+ extern int verbose;
  extern int dry_run;
- extern int daemon_log_format_has_i;
  extern int preserve_acls;
 +extern int preserve_xattrs;
  extern int preserve_perms;
  extern int preserve_executability;
  extern int preserve_times;
-@@ -215,6 +216,10 @@ int set_file_attrs(char *fname, struct f
- 	if (preserve_acls && set_acl(fname, file, &st->st_mode) == 0)
- 		updated = 1;
- #endif
+@@ -218,6 +219,10 @@ int set_file_attrs(char *fname, struct f
+ 	if (daemon_chmod_modes && !S_ISLNK(new_mode))
+ 		new_mode = tweak_mode(new_mode, daemon_chmod_modes);
+ 
 +#ifdef SUPPORT_XATTRS
-+	if (preserve_xattrs && set_xattr(fname, file) == 0)
++	if (preserve_xattrs && set_xattr(fname, file, sxp) == 0)
 +		updated = 1;
 +#endif
- 
- #ifdef HAVE_CHMOD
- 	if ((st->st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS)) {
+ #ifdef SUPPORT_ACLS
+ 	/* It's OK to call set_acl() now, even for a dir, as the generator
+ 	 * will enable owner-writability using chmod, if necessary.
 --- old/rsync.h
 +++ new/rsync.h
-@@ -674,6 +674,14 @@ struct chmod_mode_struct;
+@@ -500,6 +500,10 @@ struct idev {
+ #define ACLS_NEED_MASK 1
  #endif
- #include "smb_acls.h"
  
-+#ifdef HAVE_LINUX_XATTRS
++#ifndef HAVE_NO_XATTRS
 +#define SUPPORT_XATTRS 1
 +#endif
 +
-+#if defined SUPPORT_XATTRS && defined HAVE_ATTR_XATTR_H
-+#include <attr/xattr.h>
+ #define GID_NONE ((gid_t)-1)
+ 
+ #define HL_CHECK_MASTER	0
+@@ -694,6 +698,9 @@ typedef struct {
+     struct rsync_acl *acc_acl; /* access ACL */
+     struct rsync_acl *def_acl; /* default ACL */
+ #endif
++#ifdef SUPPORT_XATTRS
++    item_list *xattr;
 +#endif
-+
- #include "proto.h"
+ } statx;
  
- /* We have replacement versions of these if they're missing. */
+ #define ACL_READY(sx) ((sx).acc_acl != NULL)
 --- old/rsync.yo
 +++ new/rsync.yo
-@@ -322,6 +322,7 @@ to the detailed description below for a 
-  -p, --perms                 preserve permissions
+@@ -301,7 +301,7 @@ to the detailed description below for a 
+  -q, --quiet                 suppress non-error messages
+      --no-motd               suppress daemon-mode MOTD (see caveat)
+  -c, --checksum              skip based on checksum, not mod-time & size
+- -a, --archive               archive mode; same as -rlptgoD (no -H, -A)
++ -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)
+      --no-OPTION             turn off an implied OPTION (e.g. --no-D)
+  -r, --recursive             recurse into directories
+  -R, --relative              use relative path names
+@@ -324,6 +324,7 @@ to the detailed description below for a 
   -E, --executability         preserve executability
+      --chmod=CHMOD           affect file and/or directory permissions
   -A, --acls                  preserve ACLs (implies -p) [non-standard]
 + -X, --xattrs                preserve extended attrs (implies -p) [n.s.]
-      --chmod=CHMOD           change destination permissions
   -o, --owner                 preserve owner (super-user only)
   -g, --group                 preserve group
-@@ -807,6 +808,11 @@ version makes it incompatible with sendi
+      --devices               preserve device files (super-user only)
+@@ -818,6 +819,11 @@ version makes it incompatible with sendi
  rsync unless you double the bf(--acls) option (e.g. bf(-AA)).  This
  doubling is not needed when pulling files from an older rsync.
  
 +dit(bf(-X, --xattrs)) This option causes rsync to update the remote
 +extended attributes to be the same as the local ones.  This will work
 +only if the remote machine's rsync supports this option also. This is
@@ -369,635 +625,547 @@
 +
  dit(bf(--chmod)) This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
  transfer.  The resulting value is treated as though it was the permissions
 --- old/xattr.c
 +++ new/xattr.c
-@@ -0,0 +1,523 @@
-+/* Extended Attribute support for rsync */
-+/* Copyright (C) 2004 Red Hat, Inc */
-+/* Written by Jay Fenlason, vaguely based on the ACLs patch */
-+
-+/* This program is free software; you can redistribute it and/or modify
-+   it under the terms of the GNU General Public License as published by
-+   the Free Software Foundation; either version 2 of the License, or
-+   (at your option) any later version.
-+
-+   This program is distributed in the hope that it will be useful,
-+   but WITHOUT ANY WARRANTY; without even the implied warranty of
-+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-+   GNU General Public License for more details.
-+
-+   You should have received a copy of the GNU General Public License
-+   along with this program; if not, write to the Free Software
-+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-+*/
+@@ -0,0 +1,417 @@
++/*
++ * Extended Attribute support for rsync.
++ * Written by Jay Fenlason, vaguely based on the ACLs patch.
++ *
++ * Copyright (C) 2004 Red Hat, Inc.
++ * Copyright (C) 2006 Wayne Davison
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License along
++ * with this program; if not, write to the Free Software Foundation, Inc.,
++ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
++ */
 +
 +#include "rsync.h"
 +#include "lib/sysxattr.h"
 +
 +#ifdef SUPPORT_XATTRS
 +
 +extern int dry_run;
++extern int am_root;
++extern int read_only;
++extern int list_only;
++extern unsigned int file_struct_len;
 +
 +#define RSYNC_XAL_INITIAL 5
 +#define RSYNC_XAL_LIST_INITIAL 100
 +
-+typedef struct {
-+	size_t name_len;
-+	char *name;
-+	size_t datum_len;
-+	char *datum;
-+} rsync_xa;
++#define HAS_PREFIX(str, prfx) (*(str) == *(prfx) \
++			    && strncmp(str, prfx, sizeof (prfx) - 1) == 0)
 +
-+typedef struct {
-+	size_t count;
-+	size_t alloc;
-+	rsync_xa *rxas;
-+} rsync_xal;
++#define USER_PREFIX "user."
++#define UPRE_LEN ((int)sizeof USER_PREFIX - 1)
++#define SYSTEM_PREFIX "system."
++#define SPRE_LEN ((int)sizeof SYSTEM_PREFIX - 1)
++
++#ifdef HAVE_LINUX_XATTRS
++#define RPRE_LEN 0
++#else
++#define RSYNC_PREFIX "rsync."
++#define RPRE_LEN ((int)sizeof RSYNC_PREFIX - 1)
++#endif
 +
 +typedef struct {
-+	size_t count;
-+	size_t alloc;
-+	rsync_xal *rxals;
-+} rsync_xal_list;
++	char *datum, *name;
++	size_t datum_len, name_len;
++} rsync_xa;
 +
 +static size_t namebuf_len = 0;
 +static char *namebuf = NULL;
 +
-+static size_t datumbuf_len = 0;
-+static char *datumbuf = NULL;
-+
-+static rsync_xal curr_rsync_xal = { 0, 0, NULL };
-+static rsync_xal_list rsync_xal_l = { 0, 0, NULL };
-+
-+
-+/* ------------------------------------------------------------------------- */
-+
-+/* the below stuff is only used by the receiver */
-+
-+/* structure to hold index to rsync_xal_l member corresponding to
-+ * flist->files[i] */
-+
-+typedef struct {
-+	const struct file_struct *file;
-+	int xalidx;
-+} file_xal_index;
-+
-+typedef struct {
-+	size_t count;
-+	size_t alloc;
-+	file_xal_index *filexalidxs;
-+} file_xal_index_list;
-+
-+static file_xal_index_list fxil = {0, 0, NULL };
-+
-+/* stuff for redirecting calls to set_acl() from set_perms()
-+ * for keep_backup() */
-+static const struct file_struct *backup_orig_file = NULL;
-+static const char null_string[] = "";
-+static const char *backup_orig_fname = null_string;
-+static const char *backup_dest_fname = null_string;
-+static rsync_xal backup_xal;
++static item_list empty_xattr = EMPTY_ITEM_LIST;
++static item_list rsync_xal_l = EMPTY_ITEM_LIST;
 +
 +/* ------------------------------------------------------------------------- */
 +
-+static void rsync_xal_free(rsync_xal *x)
++static void rsync_xal_free(item_list *xalp)
 +{
 +	size_t i;
++	rsync_xa *rxas = xalp->items;
 +
-+	for (i = 0; i < x->count; i++) {
-+		free(x->rxas[i].name);
-+		/* free(x->rxas[i].value); */
++	for (i = 0; i < xalp->count; i++) {
++		free(rxas[i].datum);
++		/*free(rxas[i].name);*/
 +	}
-+	x->count = 0;
++	xalp->count = 0;
 +}
 +
-+static int rsync_xal_compare_names(const void *x1, const void *x2)
++void free_xattr(statx *sxp)
 +{
-+	const rsync_xa *xa1;
-+	const rsync_xa *xa2;
++	rsync_xal_free(sxp->xattr);
++	free(sxp->xattr);
++	sxp->xattr = NULL;
++}
 +
-+	xa1 = x1;
-+	xa2 = x2;
++static int rsync_xal_compare_names(const void *x1, const void *x2)
++{
++	const rsync_xa *xa1 = x1;
++	const rsync_xa *xa2 = x2;
 +	return strcmp(xa1->name, xa2->name);
 +}
 +
-+static int rsync_xal_get(const char *fname, rsync_xal *x)
++static int rsync_xal_get(const char *fname, item_list *xalp)
 +{
-+	ssize_t name_size;
-+	ssize_t datum_size;
-+	ssize_t left;
-+	char *name;
-+	size_t len;
-+	char *ptr;
++	ssize_t list_len, name_len, datum_len;
++	char *name, *ptr;
 +
 +	if (!namebuf) {
-+		namebuf_len = 100;
++		namebuf_len = 1024;
 +		namebuf = new_array(char, namebuf_len);
-+		datumbuf_len = 100;
-+		datumbuf = new_array(char, datumbuf_len);
-+		if (!namebuf || !datumbuf)
++		if (!namebuf)
 +			out_of_memory("rsync_xal_get");
 +	}
 +
-+	name_size = sys_llistxattr(fname, namebuf, namebuf_len);
-+	if (name_size > (ssize_t)namebuf_len) {
-+		name_size = -1;
++	/* The length returned includes all the '\0' terminators. */
++	list_len = sys_llistxattr(fname, namebuf, namebuf_len);
++	if (list_len > (ssize_t)namebuf_len) {
++		list_len = -1;
 +		errno = ERANGE;
 +	}
-+	if (name_size < 0) {
++	if (list_len < 0) {
 +		if (errno == ENOTSUP)
-+			return -1;
++			return 0;
 +		if (errno == ERANGE) {
-+			name_size = sys_llistxattr(fname, NULL, 0);
-+			if (name_size < 0) {
-+				rprintf(FERROR, "%s: rsync_xal_get: llistxattr: %s\n",
-+					fname, strerror(errno));
++			list_len = sys_llistxattr(fname, NULL, 0);
++			if (list_len < 0) {
++				rsyserr(FERROR, errno,
++					"rsync_xal_get: llistxattr(\"%s\",0) failed",
++					fname);
 +				return -1;
 +			}
-+			namebuf = realloc_array(namebuf, char, name_size + 1);
++			namebuf = realloc_array(namebuf, char, list_len + 1024);
 +			if (!namebuf)
 +				out_of_memory("rsync_xal_get");
-+			namebuf_len = name_size;
-+			name_size = sys_llistxattr(fname, namebuf, namebuf_len);
-+			if (name_size < 0) {
-+				rprintf(FERROR,
-+				    "%s: rsync_xal_get: re-llistxattr failed: %s\n",
-+				    fname, strerror(errno));
++			namebuf_len = list_len + 1024;
++			list_len = sys_llistxattr(fname, namebuf, namebuf_len);
++			if (list_len < 0) {
++				rsyserr(FERROR, errno,
++					"rsync_xal_get: llistxattr(\"%s\",%ld) failed",
++					fname, (long)namebuf_len);
 +				return -1;
 +			}
 +		} else {
-+			rprintf(FERROR,
-+			    "%s: rsync_xal_get: llistxattr failed: %s\n",
-+			    fname, strerror(errno));
++			rsyserr(FERROR, errno,
++				"rsync_xal_get: llistxattr(\"%s\",%ld) failed",
++				fname, (long)namebuf_len);
 +			return -1;
 +		}
 +	}
-+	rsync_xal_free(x);
-+	if (name_size == 0)
-+		return 0;
-+	for (left = name_size, name = namebuf; left > 0 ; left -= len, name += len) {
-+		len = strlen(name) + 1;
-+
-+		if (x->count >= x->alloc) {
-+			size_t new_alloc;
-+			rsync_xa *new_rxas;
-+
-+			new_alloc = x->alloc < RSYNC_XAL_INITIAL ? RSYNC_XAL_INITIAL : x->alloc * 2;
-+			new_rxas = realloc_array(x->rxas, rsync_xa, new_alloc);
-+			if (!new_rxas)
-+				out_of_memory("rsync_xal_get");
-+			x->alloc = new_alloc;
-+			x->rxas = new_rxas;
-+		}
-+		datum_size = sys_lgetxattr(fname, name, datumbuf, datumbuf_len);
-+		if (datum_size > (ssize_t)datumbuf_len) {
-+			datum_size = -1;
-+			errno = ERANGE;
-+		}
-+		if (datum_size < 0) {
++
++	for (name = namebuf; list_len > 0; name += name_len) {
++		rsync_xa *rxas;
++
++		name_len = strlen(name) + 1;
++		list_len -= name_len;
++
++#ifdef HAVE_LINUX_XATTRS
++		/* We don't send the system namespace. */
++		if (HAS_PREFIX(name, SYSTEM_PREFIX))
++			continue;
++#endif
++
++		datum_len = sys_lgetxattr(fname, name, NULL, 0);
++		if (datum_len < 0) {
 +			if (errno == ENOTSUP)
 +				return -1;
-+			if (errno == ERANGE) {
-+				datum_size = sys_lgetxattr(fname, name, NULL, 0);
-+				if (datum_size < 0) {
-+					rprintf(FERROR,
-+					    "%s: rsync_xal_get: lgetxattr %s failed: %s\n",
-+					    fname, name, strerror(errno));
-+					return -1;
-+				}
-+				datumbuf = realloc_array(datumbuf, char, datum_size + 1);
-+				if (!datumbuf)
-+					out_of_memory("rsync_xal_get");
-+				datumbuf_len = datum_size;
-+				datum_size = sys_lgetxattr(fname, name, datumbuf, datumbuf_len);
-+				if (datum_size < 0) {
++			rsyserr(FERROR, errno,
++			    "rsync_xal_get: lgetxattr(\"%s\",\"%s\",0) failed",
++			    fname, name);
++			return -1;
++		}
++		ptr = new_array(char, name_len + datum_len);
++		if (!ptr)
++			out_of_memory("rsync_xal_get");
++		if (datum_len) {
++			ssize_t len = sys_lgetxattr(fname, name, ptr, datum_len);
++			if (len != datum_len) {
++				if (len < 0) {
++					rsyserr(FERROR, errno,
++					    "rsync_xal_get: lgetxattr(\"%s\",\"%s\",%ld)"
++					    " failed", fname, name, (long)datum_len);
++				} else {
 +					rprintf(FERROR,
-+					    "%s: rsync_xal_get: re-lgetxattr of %s failed: %s\n",
-+					    name, fname, strerror(errno));
-+					return -1;
++					    "rsync_xal_get: lgetxattr(\"%s\",\"%s\",%ld)"
++					    " returned %ld\n", fname, name,
++					    (long)datum_len, (long)len);
 +				}
-+			} else {
-+				rprintf(FERROR,
-+				    "%s: rsync_xal_get: lgetxattr %s failed: %s\n",
-+				    fname, name, strerror(errno));
++				free(ptr);
 +				return -1;
 +			}
 +		}
-+		ptr = new_array(char, len + datum_size);
-+		if (!ptr)
-+			out_of_memory("rsync_xal_get");
-+		strcpy(ptr, name);
-+		if (datum_size)
-+			memcpy(ptr + len, datumbuf, datum_size);
-+		x->rxas[curr_rsync_xal.count].name_len = len;
-+		x->rxas[curr_rsync_xal.count].name = ptr;
-+		x->rxas[curr_rsync_xal.count].datum_len = datum_size;
-+		x->rxas[curr_rsync_xal.count].datum = ptr + len;
-+		x->count++;
-+	}
-+	if (x->count > 1) {
-+		qsort(x->rxas, x->count, sizeof (rsync_xa), rsync_xal_compare_names);
++		rxas = EXPAND_ITEM_LIST(xalp, rsync_xa, RSYNC_XAL_INITIAL);
++		rxas->name = ptr + datum_len;
++		rxas->datum = ptr;
++		rxas->name_len = name_len;
++		rxas->datum_len = datum_len;
++		memcpy(rxas->name, name, name_len);
 +	}
++	if (xalp->count > 1)
++		qsort(xalp->items, xalp->count, sizeof (rsync_xa), rsync_xal_compare_names);
 +	return 0;
 +}
 +
-+
-+/* generate the xattr(s) for this flist entry;
-+ * xattr(s) are either sent or cleaned-up by send_xattr() below */
-+
-+int make_xattr(UNUSED(const struct file_struct *file), const char *fname)
++/* Read the xattr(s) for this filename. */
++int get_xattr(const char *fname, statx *sxp)
 +{
-+	rsync_xal_get(fname, &curr_rsync_xal);
-+	return 0; /* TODO:  This needs to return 1 if no xattrs changed! */
++	sxp->xattr = new(item_list);
++	*sxp->xattr = empty_xattr;
++	if (rsync_xal_get(fname, sxp->xattr) < 0) {
++		free_xattr(sxp);
++		return -1;
++	}
++	return 0;
 +}
 +
-+static ssize_t rsync_xal_find_matching(void)
++static int find_matching_xattr(item_list *xalp)
 +{
-+	size_t i;
-+	size_t j;
++	size_t i, j;
++	item_list *lst = rsync_xal_l.items;
 +
 +	for (i = 0; i < rsync_xal_l.count; i++) {
++		rsync_xa *rxas1 = lst[i].items;
++		rsync_xa *rxas2 = xalp->items;
++
 +		/* Wrong number of elements? */
-+		if (rsync_xal_l.rxals[i].count != curr_rsync_xal.count)
++		if (lst[i].count != xalp->count)
 +			continue;
 +		/* any elements different? */
-+		for (j = 0; j < curr_rsync_xal.count; j++) {
-+			if (rsync_xal_l.rxals[i].rxas[j].name_len != curr_rsync_xal.rxas[j].name_len
-+			 || rsync_xal_l.rxals[i].rxas[j].datum_len != curr_rsync_xal.rxas[j].datum_len
-+			 || strcmp(rsync_xal_l.rxals[i].rxas[j].name, curr_rsync_xal.rxas[j].name)
-+			 || memcmp(rsync_xal_l.rxals[i].rxas[j].datum, curr_rsync_xal.rxas[j].datum, curr_rsync_xal.rxas[j].datum_len))
++		for (j = 0; j < xalp->count; j++) {
++			if (rxas1[j].name_len != rxas2[j].name_len
++			 || rxas1[j].datum_len != rxas2[j].datum_len
++			 || strcmp(rxas1[j].name, rxas2[j].name)
++			 || memcmp(rxas1[j].datum, rxas2[j].datum, rxas2[j].datum_len))
 +				break;
 +		}
 +		/* no differences found.  This is The One! */
-+		if (j == curr_rsync_xal.count)
-+			break;
-+	}
-+	if (i < rsync_xal_l.count)
-+		return i;
-+	return (ssize_t)-1;
-+}
-+
-+/* Store curr_rsync_xal on the end of rsync_xal_l */
-+static void rsync_xal_store(void)
-+{
-+	if (rsync_xal_l.count <= rsync_xal_l.alloc) {
-+		size_t new_alloc;
-+		void *new_xal;
-+
-+		new_alloc = rsync_xal_l.count < RSYNC_XAL_LIST_INITIAL ? RSYNC_XAL_LIST_INITIAL : rsync_xal_l.count * 2;
-+		new_xal = realloc_array(rsync_xal_l.rxals, rsync_xal, new_alloc);
-+		if (!new_xal)
-+			out_of_memory("rsync_xal_store");
-+		rsync_xal_l.alloc = new_alloc;
-+		rsync_xal_l.rxals = new_xal;
++		if (j == xalp->count)
++			return i;
 +	}
-+	rsync_xal_l.rxals[rsync_xal_l.count] = curr_rsync_xal;
-+	rsync_xal_l.count++;
-+	curr_rsync_xal.count = 0;
-+	curr_rsync_xal.alloc = 0;
-+}
 +
-+/* send the make_xattr()-generated xattr list for this flist entry,
-+ * or clean up after an flist entry that's not being sent (f == -1) */
++	return -1;
++}
 +
-+void send_xattr(UNUSED(const struct file_struct *file), int f)
++/* Store *xalp on the end of rsync_xal_l */
++static void rsync_xal_store(item_list *xalp)
 +{
-+	ssize_t index;
++	item_list *new_lst = EXPAND_ITEM_LIST(&rsync_xal_l, item_list, RSYNC_XAL_LIST_INITIAL);
++	/* Since the following call starts a new list, we know it will hold the
++	 * entire initial-count, not just enough space for one new item. */
++	*new_lst = empty_xattr;
++	(void)EXPAND_ITEM_LIST(new_lst, rsync_xa, xalp->count);
++	memcpy(new_lst->items, xalp->items, xalp->count * sizeof (rsync_xa));
++	new_lst->count = xalp->count;
++	xalp->count = 0;
++}
 +
-+	if (f == -1) {
-+		rsync_xal_free(&curr_rsync_xal);
-+		return;
-+	}
-+	index = rsync_xal_find_matching();
-+	if (index != -1) {
++/* Send the make_xattr()-generated xattr list for this flist entry. */
++void send_xattr(statx *sxp, int f)
++{
++	int ndx = find_matching_xattr(sxp->xattr);
++	if (ndx != -1) {
 +		write_byte(f, 'x');
-+		write_int(f, index);
-+		rsync_xal_free(&curr_rsync_xal);
++		write_int(f, ndx);
++		rsync_xal_free(sxp->xattr);
 +	} else {
 +		rsync_xa *rxa;
-+		size_t count;
-+
-+		count = curr_rsync_xal.count;
++		int count = sxp->xattr->count;
 +		write_byte(f, 'X');
 +		write_int(f, count);
-+		for (rxa = curr_rsync_xal.rxas; count--; rxa++) {
++		for (rxa = sxp->xattr->items; count--; rxa++) {
++#ifdef HAVE_LINUX_XATTRS
 +			write_int(f, rxa->name_len);
 +			write_int(f, rxa->datum_len);
 +			write_buf(f, rxa->name, rxa->name_len);
++#else
++			/* We strip the rsync prefix from disguised namespaces
++			 * and put everything else in the user namespace. */
++			if (HAS_PREFIX(rxa->name, RSYNC_PREFIX)
++			 && rxa->name[RPRE_LEN] != '%') {
++				write_int(f, rxa->name_len - RPRE_LEN);
++				write_int(f, rxa->datum_len);
++				write_buf(f, rxa->name + RPRE_LEN, rxa->name_len - RPRE_LEN);
++			} else {
++				write_int(f, rxa->name_len + UPRE_LEN);
++				write_int(f, rxa->datum_len);
++				write_buf(f, USER_PREFIX, UPRE_LEN);
++				write_buf(f, rxa->name, rxa->name_len);
++			}
++#endif
 +			write_buf(f, rxa->datum, rxa->datum_len);
 +		}
-+		rsync_xal_store();
++		rsync_xal_store(sxp->xattr); /* adds item to rsync_xal_l */
 +	}
++	free_xattr(sxp);
 +}
 +
-+
 +/* ------------------------------------------------------------------------- */
-+/* receive and build the rsync_xattr_lists */
 +
++/* receive and build the rsync_xattr_lists */
 +void receive_xattr(struct file_struct *file, int f)
 +{
-+	char *fname;
-+	int tag;
++	static item_list temp_xattr = EMPTY_ITEM_LIST;
++	char *ndx_ptr = (char*)file + file_struct_len;
++	int ndx, tag = read_byte(f);
 +
-+	fname = f_name(file, NULL);
-+	tag = read_byte(f);
-+	if (tag != 'X' && tag != 'x') {
-+		rprintf(FERROR,
-+		    "%s: receive_xattr: unknown extended attribute type tag: %c\n",
-+		    fname, tag);
-+		exit_cleanup(RERR_STREAMIO);
-+	}
-+
-+	if (fxil.alloc <= fxil.count) {
-+		void *new_ptr;
-+		size_t new_alloc;
-+
-+		if (fxil.count <  RSYNC_XAL_LIST_INITIAL)
-+			new_alloc = fxil.alloc + RSYNC_XAL_LIST_INITIAL;
-+		else
-+			new_alloc = fxil.alloc * 2;
-+		new_ptr = realloc_array(fxil.filexalidxs, file_xal_index, new_alloc);
-+		if (!new_ptr)
-+			out_of_memory("receive_xattr");
-+		if (verbose >= 3) {
-+			rprintf(FINFO, "receive_xattr to %lu bytes, %s move\n",
-+				(unsigned long)(new_alloc * sizeof (file_xal_index)),
-+				fxil.filexalidxs == new_ptr ? "did not" : "did");
-+		}
-+
-+		fxil.filexalidxs = new_ptr;
-+		fxil.alloc = new_alloc;
-+	}
-+
-+	fxil.filexalidxs[fxil.count].file = file;
 +	if (tag == 'X') {
-+		size_t count;
-+		size_t i;
-+
-+		fxil.filexalidxs[fxil.count].xalidx = rsync_xal_l.count;
-+
-+		count = read_int(f);
-+		curr_rsync_xal.count = count;
-+		curr_rsync_xal.alloc = count;
-+		curr_rsync_xal.rxas = new_array(rsync_xa, count);
-+		if (!curr_rsync_xal.rxas)
-+			out_of_memory("receive_xattr");
++		int i, count = read_int(f);
 +		for (i = 0; i < count; i++) {
-+			size_t name_len;
-+			size_t datum_len;
-+			char *ptr;
-+
-+			name_len = read_int(f);
-+			datum_len = read_int(f);
-+			if (name_len + datum_len < name_len)
++			char *ptr, *name;
++			rsync_xa *rxa;
++			size_t name_len = read_int(f);
++			size_t datum_len = read_int(f);
++#ifdef HAVE_LINUX_XATTRS
++			size_t extra_len = 0;
++#else
++			size_t extra_len = am_root ? RPRE_LEN : 0;
++			if (datum_len + extra_len < datum_len)
++				out_of_memory("receive_xattr"); /* overflow */
++#endif
++			if (name_len + datum_len + extra_len < name_len)
 +				out_of_memory("receive_xattr"); /* overflow */
-+			ptr = new_array(char, name_len + datum_len);
++			ptr = new_array(char, name_len + datum_len + extra_len);
 +			if (!ptr)
 +				out_of_memory("receive_xattr");
-+			read_buf(f, ptr, name_len);
-+			read_buf(f, ptr + name_len, datum_len);
-+			curr_rsync_xal.rxas[i].name_len = name_len;
-+			curr_rsync_xal.rxas[i].datum_len = datum_len;
-+			curr_rsync_xal.rxas[i].name = ptr;
-+			curr_rsync_xal.rxas[i].datum = ptr + name_len;
++			name = ptr + datum_len + extra_len;
++			read_buf(f, name, name_len);
++			read_buf(f, ptr, datum_len);
++#ifdef HAVE_LINUX_XATTRS
++			/* Non-root can only save the user namespace. */
++			if (!am_root && !HAS_PREFIX(name, USER_PREFIX)) {
++				free(ptr);
++				continue;
++			}
++#else
++			/* This OS only has a user namespace, so we either
++			 * strip the user prefix, or we put a non-user
++			 * namespace inside our rsync hierarchy. */
++			if (HAS_PREFIX(name, USER_PREFIX)) {
++				name += UPRE_LEN;
++				name_len -= UPRE_LEN;
++			} else if (am_root) {
++				name -= RPRE_LEN;
++				name_len += RPRE_LEN;
++				memcpy(name, RSYNC_PREFIX, RPRE_LEN);
++			} else {
++				free(ptr);
++				continue;
++			}
++#endif
++			rxa = EXPAND_ITEM_LIST(&temp_xattr, rsync_xa, count);
++			rxa->name = name;
++			rxa->datum = ptr;
++			rxa->name_len = name_len;
++			rxa->datum_len = datum_len;
 +		}
-+		rsync_xal_store();
-+	} else {
-+		size_t index;
-+
-+		index = read_int(f);
-+		if (index >= rsync_xal_l.count) {
-+			rprintf(FERROR, "%s: receive_xattr: xa index %lu out of range\n",
-+				fname, (unsigned long)index);
++		ndx = rsync_xal_l.count; /* pre-incremented count */
++		rsync_xal_store(&temp_xattr); /* adds item to rsync_xal_l */
++	} else if (tag == 'x') {
++		ndx = read_int(f);
++		if (ndx < 0 || (size_t)ndx >= rsync_xal_l.count) {
++			rprintf(FERROR, "receive_xattr: xa index %d out of"
++				" range for %s\n", ndx, f_name(file, NULL));
 +			exit_cleanup(RERR_STREAMIO);
 +		}
-+		fxil.filexalidxs[fxil.count].xalidx = index;
++	} else {
++		rprintf(FERROR, "receive_xattr: unknown extended attribute"
++			" type tag (%c) for %s\n", tag, f_name(file, NULL));
++		exit_cleanup(RERR_STREAMIO);
 +	}
-+	fxil.count++;
++
++	SIVAL(ndx_ptr, 0, ndx);
 +}
 +
-+static int rsync_xal_set(const char *fname, rsync_xal *x)
++/* Turn the xattr data in statx into cached xattr data, setting the index
++ * values in the file struct. */
++void cache_xattr(struct file_struct *file, statx *sxp)
 +{
++	char *ndx_ptr = (char*)file + file_struct_len;
++	int ndx;
++
++	if (!sxp->xattr)
++		return;
++
++	ndx = find_matching_xattr(sxp->xattr);
++	if (ndx == -1)
++		rsync_xal_store(sxp->xattr); /* adds item to rsync_xal_l */
++	free_xattr(sxp);
++
++	SIVAL(ndx_ptr, 0, ndx);
++}
++
++static int rsync_xal_set(const char *fname, item_list *xalp)
++{
++	rsync_xa *rxas = xalp->items;
 +	size_t i;
 +	int ret = 0;
 +
-+	for (i = 0; i < x->count; i++) {
-+		int status = sys_lsetxattr(fname, x->rxas[i].name, x->rxas[i].datum, x->rxas[i].datum_len, 0);
++	for (i = 0; i < xalp->count; i++) {
++		int status = sys_lsetxattr(fname, rxas[i].name, rxas[i].datum, rxas[i].datum_len);
 +		if (status < 0) {
-+			rprintf(FERROR, "%s: rsync_xal_set: lsetxattr %s failed: %s\n",
-+				fname, x->rxas[i].name, strerror(errno));
++			rsyserr(FERROR, errno,
++				"rsync_xal_set: lsetxattr(\"%s\",\"%s\") failed",
++				fname, rxas[i].name);
 +			ret = -1;
 +		}
 +	}
 +	return ret;
 +}
 +
-+/* for duplicating xattrs on backups when using backup_dir */
-+
-+int dup_xattr(const char *orig, const char *bak)
++/* Set extended attributes on indicated filename. */
++int set_xattr(const char *fname, const struct file_struct *file, UNUSED(statx *sxp))
 +{
-+	int ret;
++	int ndx;
++	char *ndx_ptr = (char*)file + file_struct_len;
++	item_list *lst = rsync_xal_l.items;
 +
-+	if (rsync_xal_get(orig, &backup_xal) < 0)
-+		ret = rsync_xal_set(bak, &backup_xal);
-+	else
-+		ret = 0;
-+	rsync_xal_free(&backup_xal);
++	if (dry_run)
++		return 1; /* FIXME: --dry-run needs to compute this value */
 +
-+	return ret;
-+}
++	if (read_only || list_only) {
++		errno = EROFS;
++		return -1;
++	}
 +
-+void push_keep_backup_xattr(const struct file_struct *file, const char *orig, const char *dest)
-+{
-+	backup_orig_file = file;
-+	backup_orig_fname = orig;
-+	backup_dest_fname = dest;
-+	rsync_xal_get(orig, &backup_xal);
-+}
-+
-+static int set_keep_backup_xal(void)
-+{
-+	return rsync_xal_set(backup_dest_fname, &backup_xal);
-+}
-+
-+void cleanup_keep_backup_xattr(void)
-+{
-+	backup_orig_file = NULL;
-+	backup_orig_fname = null_string;
-+	backup_dest_fname = null_string;
-+	rsync_xal_free(&backup_xal);
-+}
-+
-+static int file_xal_index_compare(const void *x1, const void *x2)
-+{
-+	const file_xal_index *xa1;
-+	const file_xal_index *xa2;
-+
-+	xa1 = x1;
-+	xa2 = x2;
-+	return xa1->file == xa2->file ? 0 : xa1->file < xa2->file ? -1 : 1;
-+}
-+
-+void sort_file_xattr_index_lists(void)
-+{
-+	qsort(fxil.filexalidxs, fxil.count, sizeof (file_xal_index), file_xal_index_compare);
-+}
-+
-+static int find_file_xal_index(const struct file_struct *file)
-+{
-+	int low = 0, high = fxil.count;
-+	const struct file_struct *file_mid;
-+
-+	if (!high--) {
-+		rprintf(FERROR, "find_file_xal_index: no entries\n");
-+		exit_cleanup(RERR_STREAMIO);
-+		return -1;
-+	}
-+	do {
-+		int mid = (high + low) / 2;
-+		file_mid = fxil.filexalidxs[mid].file;
-+		if (file_mid == file)
-+			return fxil.filexalidxs[mid].xalidx;
-+		if (file_mid > file)
-+			high = mid - 1;
-+		else
-+			low = mid + 1;
-+	} while (low < high);
-+	if (low == high) {
-+		file_mid = fxil.filexalidxs[low].file;
-+		if (file_mid == file)
-+			return fxil.filexalidxs[low].xalidx;
-+	}
-+	rprintf(FERROR,
-+		"find_file_xal_index: can't find entry for file in list\n");
-+	exit_cleanup(RERR_STREAMIO);
-+	return -1;
-+}
-+
-+/* set extended attributes on rsync-ed or keep_backup-ed file */
-+
-+int set_xattr(const char *fname, const struct file_struct *file)
-+{
-+	int xalidx;
-+	rsync_xal *x;
-+
-+	if (dry_run)
-+		return 1; /* FIXME: --dry-run needs to compute this value */
-+
-+	if (file == backup_orig_file) {
-+		if (!strcmp(fname, backup_dest_fname))
-+			return set_keep_backup_xal();
-+	}
-+	xalidx = find_file_xal_index(file);
-+	x = &(rsync_xal_l.rxals[xalidx]);
-+
-+	return rsync_xal_set(fname, x);
++	ndx = IVAL(ndx_ptr, 0);
++	return rsync_xal_set(fname, lst + ndx); /* TODO:  This needs to return 1 if no xattrs changed! */
 +}
 +
 +#endif /* SUPPORT_XATTRS */
 --- old/proto.h
 +++ new/proto.h
-@@ -332,4 +332,12 @@ void bitbag_set_bit(struct bitbag *bb, i
- void bitbag_clear_bit(struct bitbag *bb, int ndx);
- int bitbag_check_bit(struct bitbag *bb, int ndx);
+@@ -332,4 +332,10 @@ int bitbag_check_bit(struct bitbag *bb, 
  int bitbag_next_bit(struct bitbag *bb, int after);
-+int make_xattr(UNUSED(const struct file_struct *file), const char *fname);
-+void send_xattr(UNUSED(const struct file_struct *file), int f);
+ void *expand_item_list(item_list *lp, size_t item_size,
+ 		       const char *desc, int incr);
++void free_xattr(statx *sxp);
++int get_xattr(const char *fname, statx *sxp);
++void send_xattr(statx *sxp, int f);
 +void receive_xattr(struct file_struct *file, int f);
-+int dup_xattr(const char *orig, const char *bak);
-+void push_keep_backup_xattr(const struct file_struct *file, const char *orig, const char *dest);
-+void cleanup_keep_backup_xattr(void);
-+void sort_file_xattr_index_lists(void);
-+int set_xattr(const char *fname, const struct file_struct *file);
++void cache_xattr(struct file_struct *file, statx *sxp);
++int set_xattr(const char *fname, const struct file_struct *file, UNUSED(statx *sxp));
  int sys_gettimeofday(struct timeval *tv);
 --- old/configure
 +++ new/configure
-@@ -853,6 +853,7 @@ Optional Features:
+@@ -1259,6 +1259,7 @@ Optional Features:
    --disable-ipv6          don't even try to use IPv6
    --disable-locale        turn off locale features
    --enable-acl-support    Include ACL support (default=no)
 +  --enable-xattr-support  Include extended attribute support (default=no)
  
  Optional Packages:
    --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-@@ -12840,6 +12841,198 @@ echo "${ECHO_T}no" >&6
+@@ -15628,6 +15629,559 @@ echo "${ECHO_T}no" >&6; }
+ fi
  
- fi;
  
 +
 +for ac_header in attr/xattr.h
 +do
 +as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
-+  echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  { echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +else
 +  # Is the header compilable?
-+echo "$as_me:$LINENO: checking $ac_header usability" >&5
-+echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
++echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +$ac_includes_default
 +#include <$ac_header>
 +_ACEOF
 +rm -f conftest.$ac_objext
-+if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-+  (eval $ac_compile) 2>conftest.er1
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } &&
-+	 { ac_try='test -z "$ac_c_werror_flag"			 || test ! -s conftest.err'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; } &&
 +	 { ac_try='test -s conftest.$ac_objext'
-+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-+  (eval $ac_try) 2>&5
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
 +  ac_status=$?
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); }; }; then
 +  ac_header_compiler=yes
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
-+ac_header_compiler=no
++	ac_header_compiler=no
 +fi
-+rm -f conftest.err conftest.$ac_objext conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-+echo "${ECHO_T}$ac_header_compiler" >&6
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
 +
 +# Is the header present?
-+echo "$as_me:$LINENO: checking $ac_header presence" >&5
-+echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6
++{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
++echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
 +cat >conftest.$ac_ext <<_ACEOF
 +/* confdefs.h.  */
 +_ACEOF
 +cat confdefs.h >>conftest.$ac_ext
 +cat >>conftest.$ac_ext <<_ACEOF
 +/* end confdefs.h.  */
 +#include <$ac_header>
 +_ACEOF
-+if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
 +  ac_status=$?
 +  grep -v '^ *+' conftest.er1 >conftest.err
 +  rm -f conftest.er1
 +  cat conftest.err >&5
 +  echo "$as_me:$LINENO: \$? = $ac_status" >&5
 +  (exit $ac_status); } >/dev/null; then
@@ -1015,15 +1183,16 @@
 +else
 +  echo "$as_me: failed program was:" >&5
 +sed 's/^/| /' conftest.$ac_ext >&5
 +
 +  ac_header_preproc=no
 +fi
++
 +rm -f conftest.err conftest.$ac_ext
-+echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-+echo "${ECHO_T}$ac_header_preproc" >&6
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
 +
 +# So?  What about this header?
 +case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
 +  yes:no: )
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
 +echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
@@ -1041,147 +1210,522 @@
 +    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
 +echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
 +echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
 +    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
 +echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
-+    (
-+      cat <<\_ASBOX
-+## ------------------------------------------ ##
-+## Report this to the AC_PACKAGE_NAME lists.  ##
-+## ------------------------------------------ ##
-+_ASBOX
-+    ) |
-+      sed "s/^/$as_me: WARNING:     /" >&2
++
 +    ;;
 +esac
-+echo "$as_me:$LINENO: checking for $ac_header" >&5
-+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-+if eval "test \"\${$as_ac_Header+set}\" = set"; then
++{ echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
 +  echo $ECHO_N "(cached) $ECHO_C" >&6
 +else
 +  eval "$as_ac_Header=\$ac_header_preproc"
 +fi
-+echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
 +
 +fi
 +if test `eval echo '${'$as_ac_Header'}'` = yes; then
 +  cat >>confdefs.h <<_ACEOF
 +#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
 +_ACEOF
 +
 +fi
 +
 +done
 +
-+echo "$as_me:$LINENO: checking whether to support extended attributes" >&5
-+echo $ECHO_N "checking whether to support extended attributes... $ECHO_C" >&6
-+# Check whether --enable-xattr-support or --disable-xattr-support was given.
++
++for ac_header in sys/xattr.h
++do
++as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  { echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  echo $ECHO_N "(cached) $ECHO_C" >&6
++fi
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
++else
++  # Is the header compilable?
++{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
++echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
++cat >conftest.$ac_ext <<_ACEOF
++/* confdefs.h.  */
++_ACEOF
++cat confdefs.h >>conftest.$ac_ext
++cat >>conftest.$ac_ext <<_ACEOF
++/* end confdefs.h.  */
++$ac_includes_default
++#include <$ac_header>
++_ACEOF
++rm -f conftest.$ac_objext
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
++  ac_status=$?
++  grep -v '^ *+' conftest.er1 >conftest.err
++  rm -f conftest.er1
++  cat conftest.err >&5
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); } &&
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
++  ac_status=$?
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); }; } &&
++	 { ac_try='test -s conftest.$ac_objext'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
++  ac_status=$?
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); }; }; then
++  ac_header_compiler=yes
++else
++  echo "$as_me: failed program was:" >&5
++sed 's/^/| /' conftest.$ac_ext >&5
++
++	ac_header_compiler=no
++fi
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
++
++# Is the header present?
++{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
++echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
++cat >conftest.$ac_ext <<_ACEOF
++/* confdefs.h.  */
++_ACEOF
++cat confdefs.h >>conftest.$ac_ext
++cat >>conftest.$ac_ext <<_ACEOF
++/* end confdefs.h.  */
++#include <$ac_header>
++_ACEOF
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
++  ac_status=$?
++  grep -v '^ *+' conftest.er1 >conftest.err
++  rm -f conftest.er1
++  cat conftest.err >&5
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); } >/dev/null; then
++  if test -s conftest.err; then
++    ac_cpp_err=$ac_c_preproc_warn_flag
++    ac_cpp_err=$ac_cpp_err$ac_c_werror_flag
++  else
++    ac_cpp_err=
++  fi
++else
++  ac_cpp_err=yes
++fi
++if test -z "$ac_cpp_err"; then
++  ac_header_preproc=yes
++else
++  echo "$as_me: failed program was:" >&5
++sed 's/^/| /' conftest.$ac_ext >&5
++
++  ac_header_preproc=no
++fi
++
++rm -f conftest.err conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
++
++# So?  What about this header?
++case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
++  yes:no: )
++    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
++echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the compiler's result" >&5
++echo "$as_me: WARNING: $ac_header: proceeding with the compiler's result" >&2;}
++    ac_header_preproc=yes
++    ;;
++  no:yes:* )
++    { echo "$as_me:$LINENO: WARNING: $ac_header: present but cannot be compiled" >&5
++echo "$as_me: WARNING: $ac_header: present but cannot be compiled" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header:     check for missing prerequisite headers?" >&5
++echo "$as_me: WARNING: $ac_header:     check for missing prerequisite headers?" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: see the Autoconf documentation" >&5
++echo "$as_me: WARNING: $ac_header: see the Autoconf documentation" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
++echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
++echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
++echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
++
++    ;;
++esac
++{ echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  echo $ECHO_N "(cached) $ECHO_C" >&6
++else
++  eval "$as_ac_Header=\$ac_header_preproc"
++fi
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
++
++fi
++if test `eval echo '${'$as_ac_Header'}'` = yes; then
++  cat >>confdefs.h <<_ACEOF
++#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
++_ACEOF
++
++fi
++
++done
++
++
++for ac_header in sys/extattr.h
++do
++as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  { echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  echo $ECHO_N "(cached) $ECHO_C" >&6
++fi
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
++else
++  # Is the header compilable?
++{ echo "$as_me:$LINENO: checking $ac_header usability" >&5
++echo $ECHO_N "checking $ac_header usability... $ECHO_C" >&6; }
++cat >conftest.$ac_ext <<_ACEOF
++/* confdefs.h.  */
++_ACEOF
++cat confdefs.h >>conftest.$ac_ext
++cat >>conftest.$ac_ext <<_ACEOF
++/* end confdefs.h.  */
++$ac_includes_default
++#include <$ac_header>
++_ACEOF
++rm -f conftest.$ac_objext
++if { (ac_try="$ac_compile"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_compile") 2>conftest.er1
++  ac_status=$?
++  grep -v '^ *+' conftest.er1 >conftest.err
++  rm -f conftest.er1
++  cat conftest.err >&5
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); } &&
++	 { ac_try='test -z "$ac_c_werror_flag" || test ! -s conftest.err'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
++  ac_status=$?
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); }; } &&
++	 { ac_try='test -s conftest.$ac_objext'
++  { (case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_try") 2>&5
++  ac_status=$?
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); }; }; then
++  ac_header_compiler=yes
++else
++  echo "$as_me: failed program was:" >&5
++sed 's/^/| /' conftest.$ac_ext >&5
++
++	ac_header_compiler=no
++fi
++
++rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
++echo "${ECHO_T}$ac_header_compiler" >&6; }
++
++# Is the header present?
++{ echo "$as_me:$LINENO: checking $ac_header presence" >&5
++echo $ECHO_N "checking $ac_header presence... $ECHO_C" >&6; }
++cat >conftest.$ac_ext <<_ACEOF
++/* confdefs.h.  */
++_ACEOF
++cat confdefs.h >>conftest.$ac_ext
++cat >>conftest.$ac_ext <<_ACEOF
++/* end confdefs.h.  */
++#include <$ac_header>
++_ACEOF
++if { (ac_try="$ac_cpp conftest.$ac_ext"
++case "(($ac_try" in
++  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
++  *) ac_try_echo=$ac_try;;
++esac
++eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
++  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
++  ac_status=$?
++  grep -v '^ *+' conftest.er1 >conftest.err
++  rm -f conftest.er1
++  cat conftest.err >&5
++  echo "$as_me:$LINENO: \$? = $ac_status" >&5
++  (exit $ac_status); } >/dev/null; then
++  if test -s conftest.err; then
++    ac_cpp_err=$ac_c_preproc_warn_flag
++    ac_cpp_err=$ac_cpp_err$ac_c_werror_flag
++  else
++    ac_cpp_err=
++  fi
++else
++  ac_cpp_err=yes
++fi
++if test -z "$ac_cpp_err"; then
++  ac_header_preproc=yes
++else
++  echo "$as_me: failed program was:" >&5
++sed 's/^/| /' conftest.$ac_ext >&5
++
++  ac_header_preproc=no
++fi
++
++rm -f conftest.err conftest.$ac_ext
++{ echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
++echo "${ECHO_T}$ac_header_preproc" >&6; }
++
++# So?  What about this header?
++case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in
++  yes:no: )
++    { echo "$as_me:$LINENO: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&5
++echo "$as_me: WARNING: $ac_header: accepted by the compiler, rejected by the preprocessor!" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the compiler's result" >&5
++echo "$as_me: WARNING: $ac_header: proceeding with the compiler's result" >&2;}
++    ac_header_preproc=yes
++    ;;
++  no:yes:* )
++    { echo "$as_me:$LINENO: WARNING: $ac_header: present but cannot be compiled" >&5
++echo "$as_me: WARNING: $ac_header: present but cannot be compiled" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header:     check for missing prerequisite headers?" >&5
++echo "$as_me: WARNING: $ac_header:     check for missing prerequisite headers?" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: see the Autoconf documentation" >&5
++echo "$as_me: WARNING: $ac_header: see the Autoconf documentation" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&5
++echo "$as_me: WARNING: $ac_header:     section \"Present But Cannot Be Compiled\"" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: proceeding with the preprocessor's result" >&5
++echo "$as_me: WARNING: $ac_header: proceeding with the preprocessor's result" >&2;}
++    { echo "$as_me:$LINENO: WARNING: $ac_header: in the future, the compiler will take precedence" >&5
++echo "$as_me: WARNING: $ac_header: in the future, the compiler will take precedence" >&2;}
++
++    ;;
++esac
++{ echo "$as_me:$LINENO: checking for $ac_header" >&5
++echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6; }
++if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
++  echo $ECHO_N "(cached) $ECHO_C" >&6
++else
++  eval "$as_ac_Header=\$ac_header_preproc"
++fi
++ac_res=`eval echo '${'$as_ac_Header'}'`
++	       { echo "$as_me:$LINENO: result: $ac_res" >&5
++echo "${ECHO_T}$ac_res" >&6; }
++
++fi
++if test `eval echo '${'$as_ac_Header'}'` = yes; then
++  cat >>confdefs.h <<_ACEOF
++#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
++_ACEOF
++
++fi
++
++done
++
++{ echo "$as_me:$LINENO: checking whether to support extended attributes" >&5
++echo $ECHO_N "checking whether to support extended attributes... $ECHO_C" >&6; }
++# Check whether --enable-xattr-support was given.
 +if test "${enable_xattr_support+set}" = set; then
-+  enableval="$enable_xattr_support"
-+   case "$enableval" in
++  enableval=$enable_xattr_support;  case "$enableval" in
 +  yes)
 +      case "$host_os" in
 +      *linux*)
-+            echo "$as_me:$LINENO: result: Using Linux xattrs" >&5
-+echo "${ECHO_T}Using Linux xattrs" >&6
++            { echo "$as_me:$LINENO: result: Using Linux xattrs" >&5
++echo "${ECHO_T}Using Linux xattrs" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
 +#define HAVE_LINUX_XATTRS 1
 +_ACEOF
 +
 +            ;;
++      darwin*)
++            { echo "$as_me:$LINENO: result: Using OS X xattrs" >&5
++echo "${ECHO_T}Using OS X xattrs" >&6; }
++
++cat >>confdefs.h <<\_ACEOF
++#define HAVE_OSX_XATTRS 1
++_ACEOF
++
++            ;;
++      freebsd*)
++            { echo "$as_me:$LINENO: result: Using FreeBSD extattrs" >&5
++echo "${ECHO_T}Using FreeBSD extattrs" >&6; }
++
++cat >>confdefs.h <<\_ACEOF
++#define HAVE_FREEBSD_XATTRS 1
++_ACEOF
++
++            ;;
 +      *)
-+            echo "$as_me:$LINENO: result: Xattrs requested but not linux.  Good luck" >&5
-+echo "${ECHO_T}Xattrs requested but not linux.  Good luck" >&6
++            { echo "$as_me:$LINENO: result: Xattrs requested but not Linux or OS X.  Good luck..." >&5
++echo "${ECHO_T}Xattrs requested but not Linux or OS X.  Good luck..." >&6; }
 +            ;;
 +      esac
 +      ;;
 +  *)
-+      echo "$as_me:$LINENO: result: no" >&5
-+echo "${ECHO_T}no" >&6
++      { echo "$as_me:$LINENO: result: no" >&5
++echo "${ECHO_T}no" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
-+#define HAVE_NA_XATTRS 1
++#define HAVE_NO_XATTRS 1
 +_ACEOF
 +
 +  esac
 +else
-+  echo "$as_me:$LINENO: result: no" >&5
-+echo "${ECHO_T}no" >&6
++  { echo "$as_me:$LINENO: result: no" >&5
++echo "${ECHO_T}no" >&6; }
 +
 +cat >>confdefs.h <<\_ACEOF
-+#define HAVE_NO_XATTRL 1
++#define HAVE_NO_XATTRS 1
 +_ACEOF
 +
 +
-+fi;
++fi
++
 +
-                                                   ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
+ ac_config_files="$ac_config_files Makefile lib/dummy zlib/dummy popt/dummy shconfig"
  
  cat >confcache <<\_ACEOF
 --- old/config.h.in
 +++ new/config.h.in
-@@ -52,6 +52,9 @@
+@@ -55,6 +55,9 @@
  /* Define to 1 if you have the `asprintf' function. */
  #undef HAVE_ASPRINTF
  
 +/* Define to 1 if you have the <attr/xattr.h> header file. */
 +#undef HAVE_ATTR_XATTR_H
 +
  /* Define to 1 if readdir() is broken */
  #undef HAVE_BROKEN_READDIR
  
-@@ -191,6 +194,9 @@
+@@ -92,6 +95,9 @@
+ /* Define to 1 if you have the <float.h> header file. */
+ #undef HAVE_FLOAT_H
+ 
++/* True if you have FreeBSD xattrs */
++#undef HAVE_FREEBSD_XATTRS
++
+ /* Define to 1 if you have the `fstat' function. */
+ #undef HAVE_FSTAT
+ 
+@@ -194,6 +200,9 @@
  /* Define to 1 if you have the `link' function. */
  #undef HAVE_LINK
  
 +/* True if you have Linux xattrs */
 +#undef HAVE_LINUX_XATTRS
 +
  /* Define to 1 if you have the `locale_charset' function. */
  #undef HAVE_LOCALE_CHARSET
  
-@@ -234,6 +240,9 @@
- /* Define to 1 if you have the `mtrace' function. */
- #undef HAVE_MTRACE
- 
-+/* True if you don't have extended attributes */
-+#undef HAVE_NA_XATTRS
-+
- /* Define to 1 if you have the <ndir.h> header file, and it defines `DIR'. */
- #undef HAVE_NDIR_H
- 
-@@ -246,6 +255,9 @@
+@@ -253,9 +262,15 @@
  /* true if you don't have ACLs */
  #undef HAVE_NO_ACLS
  
 +/* True if you don't have extended attributes */
-+#undef HAVE_NO_XATTRL
++#undef HAVE_NO_XATTRS
 +
  /* Define to 1 if you have the `open64' function. */
  #undef HAVE_OPEN64
  
++/* True if you have Mac OS X xattrs */
++#undef HAVE_OSX_XATTRS
++
+ /* true if you have posix ACLs */
+ #undef HAVE_POSIX_ACLS
+ 
+@@ -365,6 +380,9 @@
+    */
+ #undef HAVE_SYS_DIR_H
+ 
++/* Define to 1 if you have the <sys/extattr.h> header file. */
++#undef HAVE_SYS_EXTATTR_H
++
+ /* Define to 1 if you have the <sys/fcntl.h> header file. */
+ #undef HAVE_SYS_FCNTL_H
+ 
+@@ -408,6 +426,9 @@
+ /* Define to 1 if you have the <sys/wait.h> header file. */
+ #undef HAVE_SYS_WAIT_H
+ 
++/* Define to 1 if you have the <sys/xattr.h> header file. */
++#undef HAVE_SYS_XATTR_H
++
+ /* Define to 1 if you have the `tcgetpgrp' function. */
+ #undef HAVE_TCGETPGRP
+ 
 --- old/rsync.1
 +++ new/rsync.1
-@@ -378,6 +378,7 @@ to the detailed description below for a 
-  -p, --perms                 preserve permissions
-  -E, --executability         preserve executability
-  -A, --acls                  preserve ACLs (implies -p) [non-standard]
-+ -X, --xattrs                preserve extended attrs (implies -p) [n\&.s\&.]
-      --chmod=CHMOD           change destination permissions
-  -o, --owner                 preserve owner (super-user only)
-  -g, --group                 preserve group
-@@ -918,6 +919,12 @@ version makes it incompatible with sendi
- rsync unless you double the \fB--acls\fP option (e\&.g\&. \fB-AA\fP)\&.  This
+@@ -367,7 +367,7 @@ to the detailed description below for a 
+  \-q, \-\-quiet                 suppress non-error messages
+      \-\-no\-motd               suppress daemon-mode MOTD (see caveat)
+  \-c, \-\-checksum              skip based on checksum, not mod-time & size
+- \-a, \-\-archive               archive mode; same as \-rlptgoD (no \-H, \-A)
++ \-a, \-\-archive               archive mode; equals \-rlptgoD (no \-H,\-A,\-X)
+      \-\-no\-OPTION             turn off an implied OPTION (e\&.g\&. \-\-no\-D)
+  \-r, \-\-recursive             recurse into directories
+  \-R, \-\-relative              use relative path names
+@@ -390,6 +390,7 @@ to the detailed description below for a 
+  \-E, \-\-executability         preserve executability
+      \-\-chmod=CHMOD           affect file and/or directory permissions
+  \-A, \-\-acls                  preserve ACLs (implies \-p) [non-standard]
++ \-X, \-\-xattrs                preserve extended attrs (implies \-p) [n\&.s\&.]
+  \-o, \-\-owner                 preserve owner (super-user only)
+  \-g, \-\-group                 preserve group
+      \-\-devices               preserve device files (super-user only)
+@@ -947,6 +948,12 @@ version makes it incompatible with sendi
+ rsync unless you double the \fB\-\-acls\fP option (e\&.g\&. \fB\-AA\fP)\&.  This
  doubling is not needed when pulling files from an older rsync\&.
  .IP 
-+.IP "\fB-X, --xattrs\fP" 
++.IP "\fB\-X, \-\-xattrs\fP"
 +This option causes rsync to update the remote
 +extended attributes to be the same as the local ones\&.  This will work
 +only if the remote machine\&'s rsync supports this option also\&. This is
 +a non-standard option\&.
 +.IP 
- .IP "\fB--chmod\fP" 
+ .IP "\fB\-\-chmod\fP"
  This option tells rsync to apply one or more
  comma-separated "chmod" strings to the permission of the files in the
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/pipe.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/pipe.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/pipe.c	2006-02-24 09:56:26.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/pipe.c	2006-05-30 06:56:58.000000000 +0800
@@ -1,34 +1,37 @@
-/*  -*- c-file-style: "linux" -*-
+/*
+ * Routines used to setup various kinds of inter-process pipes.
  *
- * Copyright (C) 1996-2000 by Andrew Tridgell
- * Copyright (C) Paul Mackerras 1996
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
 #include "rsync.h"
 
 extern int am_sender;
 extern int am_server;
 extern int blocking_io;
 extern int filesfrom_fd;
 extern mode_t orig_umask;
+extern char *logfile_name;
 extern struct chmod_mode_struct *chmod_modes;
 
 /**
  * Create a child connected to us via its stdin/stdout.
  *
  * This is derived from CVS code
@@ -143,12 +146,18 @@
 			close(to_child_pipe[0]);
 		if (from_child_pipe[1] != STDOUT_FILENO)
 			close(from_child_pipe[1]);
 		child_main(argc, argv);
 	}
 
+	/* Let the client side handle this. */
+	if (logfile_name) {
+		logfile_name = NULL;
+		logfile_close();
+	}
+
 	if (close(from_child_pipe[1]) < 0 ||
 	    close(to_child_pipe[0]) < 0) {
 		rsyserr(FERROR, errno, "Failed to close");
 		exit_cleanup(RERR_IPC);
 	}
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/prepare-source /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/prepare-source
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/prepare-source	2006-04-18 02:15:02.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/prepare-source	2006-10-07 22:39:01.000000000 +0800
@@ -1,12 +1,12 @@
 #!/bin/sh
-# Use autoconf, autoheader, yodl, etc. to ready the generated files
-# in the release.  This is typically used after applying a diff from
-# "patches" directory in CVS.
+# Use autoconf, autoheader, yodl, etc. to ready the generated files in the
+# release.  This is typically used after applying a diff from the "patches"
+# directory in a CVS-checked-out version.
 #
-# NOTE:  if you use a diff from the "patches" directory in a release
-# tar, this is not needed (but doesn't hurt anything).
+# NOTE:  if you use a diff from the "patches" directory of a *release tar*
+# (as opposed to from CVS), this is not needed (but doesn't hurt anything).
 dir=`dirname $0`
-if test x"$dir" != x -o x"$dir" != x.; then
+if test x"$dir" != x -a x"$dir" != x.; then
     cd "$dir"
 fi
 make -f prepare-source.mak
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/prepare-source.mak /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/prepare-source.mak
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/prepare-source.mak	2006-02-08 01:30:35.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/prepare-source.mak	2006-10-24 08:33:32.000000000 +0800
@@ -15,9 +15,11 @@
 	fi
 
 man: rsync.1 rsyncd.conf.5
 
 rsync.1: rsync.yo
 	yodl2man -o rsync.1 rsync.yo
+	-./tweak_manpage_dashes rsync.1
 
 rsyncd.conf.5: rsyncd.conf.yo
 	yodl2man -o rsyncd.conf.5 rsyncd.conf.yo
+	-./tweak_manpage_dashes rsyncd.conf.5
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/progress.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/progress.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/progress.c	2006-01-15 01:10:52.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/progress.c	2006-10-14 07:17:33.000000000 +0800
@@ -1,25 +1,27 @@
-/*  -*- c-file-style: "linux" -*-
+/*
+ * Routines to output progress information during a file transfer.
  *
- * Copyright (C) 1996-2000 by Andrew Tridgell
- * Copyright (C) Paul Mackerras 1996
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
 #include "rsync.h"
 
 extern struct stats stats;
 extern int am_server;
@@ -99,14 +101,14 @@
 	if (is_last) {
 		snprintf(eol, sizeof eol, " (xfer#%d, to-check=%d/%d)\n",
 			stats.num_transferred_files,
 			stats.num_files - stats.current_file_index - 1,
 			stats.num_files);
 	} else
-		strcpy(eol, "\r");
-	rprintf(FINFO, "%12s %3d%% %7.2f%s %4d:%02d:%02d%s",
+		strlcpy(eol, "\r", sizeof eol);
+	rprintf(FCLIENT, "%12s %3d%% %7.2f%s %4d:%02d:%02d%s",
 		human_num(ofs), pct, rate, units,
 		remain_h, remain_m, remain_s, eol);
 }
 
 void end_progress(OFF_T size)
 {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/proto.h /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/proto.h
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/proto.h	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/proto.h	2006-11-07 12:39:47.000000000 +0800
@@ -18,33 +18,33 @@
 void sum_end(char *sum);
 struct chmod_mode_struct *parse_chmod(const char *modestr,
 				      struct chmod_mode_struct **root_mode_ptr);
 int tweak_mode(int mode, struct chmod_mode_struct *chmod_modes);
 int free_chmod_mode(struct chmod_mode_struct *chmod_modes);
 void close_all(void);
-void _exit_cleanup(int code, const char *file, int line);
+NORETURN void _exit_cleanup(int code, const char *file, int line);
 void cleanup_disable(void);
 void cleanup_set(char *fnametmp, char *fname, struct file_struct *file,
 		 int fd_r, int fd_w);
 void cleanup_set_pid(pid_t pid);
 char *client_addr(int fd);
 char *client_name(int fd);
 void client_sockaddr(int fd,
 		     struct sockaddr_storage *ss,
 		     socklen_t *ss_len);
 int lookup_name(int fd, const struct sockaddr_storage *ss,
 		socklen_t ss_len,
-		char *name_buf, size_t name_buf_len,
-		char *port_buf, size_t port_buf_len);
+		char *name_buf, size_t name_buf_size,
+		char *port_buf, size_t port_buf_size);
 int compare_addrinfo_sockaddr(const struct addrinfo *ai,
 			      const struct sockaddr_storage *ss);
 int check_name(int fd,
 	       const struct sockaddr_storage *ss,
-	       char *name_buf);
+	       char *name_buf, size_t name_buf_size);
 int start_socket_client(char *host, char *path, int argc, char *argv[]);
-int start_inband_exchange(char *user, char *path, int f_in, int f_out, 
+int start_inband_exchange(char *user, char *path, int f_in, int f_out,
 			  int argc);
 int start_daemon(int f_in, int f_out);
 int daemon_main(void);
 void setup_protocol(int f_out,int f_in);
 int claim_connection(char *fname,int max_connections);
 void set_filter_dir(const char *dir, unsigned int dirlen);
@@ -65,13 +65,13 @@
 struct map_struct *map_file(int fd, OFF_T len, int32 read_size,
 			    int32 blk_size);
 char *map_ptr(struct map_struct *map, OFF_T offset, int32 len);
 int unmap_file(struct map_struct *map);
 void init_flist(void);
 void show_flist_stats(void);
-int link_stat(const char *path, STRUCT_STAT *buffer, int follow_dirlinks);
+int link_stat(const char *path, STRUCT_STAT *stp, int follow_dirlinks);
 void flist_expand(struct file_list *flist);
 struct file_struct *make_file(char *fname, struct file_list *flist,
 			      STRUCT_STAT *stp, unsigned short flags,
 			      int filter_level);
 struct file_list *send_file_list(int f, int argc, char *argv[]);
 struct file_list *recv_file_list(int f);
@@ -101,13 +101,13 @@
 void io_set_sock_fds(int f_in, int f_out);
 void set_io_timeout(int secs);
 void set_msg_fd_in(int fd);
 void set_msg_fd_out(int fd);
 void increment_active_files(int ndx, int itemizing, enum logcode code);
 void decrement_active_files(int ndx);
-void send_msg(enum msgcode code, char *buf, int len);
+int send_msg(enum msgcode code, char *buf, int len);
 int get_redo_num(int itemizing, enum logcode code);
 int get_hlink_num(void);
 void io_set_filesfrom_fds(int f_in, int f_out);
 int read_filesfrom_line(int fd, char *fname);
 void io_start_buffering_out(void);
 void io_start_buffering_in(void);
@@ -138,18 +138,16 @@
 int io_multiplex_write(enum msgcode code, char *buf, size_t len);
 void close_multiplexing_in(void);
 void close_multiplexing_out(void);
 void start_write_batch(int fd);
 void stop_write_batch(void);
 char *lp_bind_address(void);
-char *lp_log_file(void);
 char *lp_motd_file(void);
 char *lp_pid_file(void);
 char *lp_socket_options(void);
 int lp_rsync_port(void);
-int lp_syslog_facility(void);
 char *lp_auth_users(int );
 char *lp_comment(int );
 char *lp_dont_compress(int );
 char *lp_exclude(int );
 char *lp_exclude_from(int );
 char *lp_filter(int );
@@ -157,20 +155,22 @@
 char *lp_hosts_allow(int );
 char *lp_hosts_deny(int );
 char *lp_include(int );
 char *lp_include_from(int );
 char *lp_incoming_chmod(int );
 char *lp_lock_file(int );
+char *lp_log_file(int );
 char *lp_log_format(int );
 char *lp_name(int );
 char *lp_outgoing_chmod(int );
 char *lp_path(int );
 char *lp_postxfer_exec(int );
 char *lp_prexfer_exec(int );
 char *lp_refuse_options(int );
 char *lp_secrets_file(int );
+int lp_syslog_facility(int );
 char *lp_temp_dir(int );
 char *lp_uid(int );
 int lp_max_connections(int );
 int lp_max_verbosity(int );
 int lp_timeout(int );
 BOOL lp_ignore_errors(int );
@@ -181,22 +181,22 @@
 BOOL lp_transfer_logging(int );
 BOOL lp_use_chroot(int );
 BOOL lp_write_only(int );
 BOOL lp_load(char *pszFname, int globals_only);
 int lp_numservices(void);
 int lp_number(char *name);
-void log_init(void);
+void log_init(int restart);
 void logfile_close(void);
 void logfile_reopen(void);
 void rwrite(enum logcode code, char *buf, int len);
 void rprintf(enum logcode code, const char *format, ...);
 void rsyserr(enum logcode code, int errcode, const char *format, ...);
 void rflush(enum logcode code);
 int log_format_has(const char *format, char esc);
-void log_item(struct file_struct *file, struct stats *initial_stats,
-	      int iflags, char *hlink);
+void log_item(enum logcode code, struct file_struct *file,
+	      struct stats *initial_stats, int iflags, char *hlink);
 void maybe_log_item(struct file_struct *file, int iflags, int itemizing,
 		    char *buf);
 void log_delete(char *fname, int mode);
 void log_exit(int code, const char *file, int line);
 pid_t wait_process(pid_t pid, int *status_ptr, int flags);
 int child_main(int argc, char *argv[]);
@@ -220,13 +220,13 @@
 		  int (*child_main)(int, char*[]));
 void end_progress(OFF_T size);
 void show_progress(OFF_T ofs, OFF_T size);
 int recv_files(int f_in, struct file_list *flist, char *local_name);
 void setup_iconv();
 void free_sums(struct sum_struct *s);
-mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int exists);
+mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int exists);
 int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
 		   int flags);
 RETSIGTYPE sig_int(UNUSED(int val));
 void finish_transfer(char *fname, char *fnametmp, char *partialptr,
 		     struct file_struct *file, int ok_to_set_time,
 		     int overwriting_basis);
@@ -273,14 +273,14 @@
 void send_uid_list(int f);
 void recv_uid_list(int f, struct file_list *flist);
 void set_nonblocking(int fd);
 void set_blocking(int fd);
 int fd_pair(int fd[2]);
 void print_child_argv(char **cmd);
-void out_of_memory(char *str);
-void overflow_exit(char *str);
+NORETURN void out_of_memory(char *str);
+NORETURN void overflow_exit(char *str);
 int set_modtime(char *fname, time_t modtime, mode_t mode);
 int mkdir_defmode(char *fname);
 int create_directory_path(char *fname);
 int full_write(int desc, char *ptr, size_t len);
 int copy_file(const char *source, const char *dest, mode_t mode);
 int robust_unlink(const char *fname);
@@ -294,14 +294,15 @@
 void glob_expand(char *base1, char ***argv_ptr, int *argc_ptr, int *maxargs_ptr);
 void strlower(char *s);
 size_t pathjoin(char *dest, size_t destsize, const char *p1, const char *p2);
 size_t stringjoin(char *dest, size_t destsize, ...);
 int count_dir_elements(const char *p);
 unsigned int clean_fname(char *name, BOOL collapse_dot_dot);
-char *sanitize_path(char *dest, const char *p, const char *rootdir, int depth);
-int push_dir(char *dir);
+char *sanitize_path(char *dest, const char *p, const char *rootdir, int depth,
+		    const char *symlink);
+int push_dir(char *dir, int set_path_only);
 int pop_dir(char *dir);
 char *full_fname(const char *fn);
 char *partial_dir_fname(const char *fname);
 int handle_partial_dir(const char *fname, int create);
 int unsafe_symlink(const char *dest, const char *src);
 char *human_num(int64 num);
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/receiver.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/receiver.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/receiver.c	2006-02-25 00:43:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/receiver.c	2006-10-13 15:18:29.000000000 +0800
@@ -1,64 +1,67 @@
-/* -*- c-file-style: "linux" -*-
-
-   Copyright (C) 1996-2000 by Andrew Tridgell
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+/*
+ * Routines only used by the receiving process.
+ *
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int do_xfers;
-extern int am_daemon;
 extern int am_server;
 extern int do_progress;
 extern int log_before_transfer;
-extern int log_format_has_i;
-extern int daemon_log_format_has_i;
+extern int stdout_format_has_i;
+extern int logfile_format_has_i;
 extern int csum_length;
 extern int read_batch;
 extern int write_batch;
 extern int batch_gen_fd;
 extern int protocol_version;
 extern int relative_paths;
 extern int preserve_hard_links;
 extern int preserve_perms;
 extern int basis_dir_cnt;
 extern int make_backups;
 extern int cleanup_got_literal;
-extern int remove_sent_files;
+extern int remove_source_files;
 extern int append_mode;
 extern int sparse_files;
 extern int keep_partial;
 extern int checksum_seed;
 extern int inplace;
 extern int delay_updates;
 extern struct stats stats;
-extern char *log_format;
+extern char *stdout_format;
 extern char *tmpdir;
 extern char *partial_dir;
 extern char *basis_dir[];
 extern struct file_list *the_file_list;
 extern struct filter_list_struct server_filter_list;
 
 static struct bitbag *delayed_bits = NULL;
 static int phase = 0;
+/* We're either updating the basis file or an identical copy: */
+static int updating_basis;
 
 
 /*
  * get_tmpname() - create a tmp filename for a given filename
  *
  *   If a tmpdir is defined, use that as the directory to
@@ -78,45 +81,46 @@
  *   look like the original, except to satisfy us humans.
  *   As long as it's unique, rsync will work.
  */
 
 static int get_tmpname(char *fnametmp, char *fname)
 {
+	int maxname, added, length = 0;
 	char *f;
-	int     length = 0;
-	int	maxname;
 
 	if (tmpdir) {
 		/* Note: this can't overflow, so the return value is safe */
 		length = strlcpy(fnametmp, tmpdir, MAXPATHLEN - 2);
 		fnametmp[length++] = '/';
-		fnametmp[length] = '\0';	/* always NULL terminated */
 	}
 
 	if ((f = strrchr(fname, '/')) != NULL) {
 		++f;
 		if (!tmpdir) {
 			length = f - fname;
 			/* copy up to and including the slash */
 			strlcpy(fnametmp, fname, length + 1);
 		}
 	} else
 		f = fname;
 	fnametmp[length++] = '.';
-	fnametmp[length] = '\0';		/* always NULL terminated */
 
+	/* The maxname value is bufsize, and includes space for the '\0'.
+	 * (Note that NAME_MAX get -8 for the leading '.' above.) */
 	maxname = MIN(MAXPATHLEN - 7 - length, NAME_MAX - 8);
 
 	if (maxname < 1) {
 		rprintf(FERROR, "temporary filename too long: %s\n", fname);
 		fnametmp[0] = '\0';
 		return 0;
 	}
 
-	strlcpy(fnametmp + length, f, maxname);
-	strcat(fnametmp + length, ".XXXXXX");
+	added = strlcpy(fnametmp + length, f, maxname);
+	if (added >= maxname)
+		added = maxname - 1;
+	memcpy(fnametmp + length + added, ".XXXXXX", 8);
 
 	return 1;
 }
 
 
 static int receive_data(int f_in, char *fname_r, int fd_r, OFF_T size_r,
@@ -163,15 +167,15 @@
 			int32 len = sum.flength - offset;
 			if (do_progress)
 				show_progress(offset, total_size);
 			sum_update(map_ptr(mapbuf, offset, len), len);
 			offset = sum.flength;
 		}
-		if (fd != -1 && do_lseek(fd, offset, SEEK_SET) != offset) {
-			rsyserr(FERROR, errno, "lseek failed on %s",
-				full_fname(fname));
+		if (fd != -1 && (j = do_lseek(fd, offset, SEEK_SET)) != offset) {
+			rsyserr(FERROR, errno, "lseek of %s returned %.0f, not %.0f",
+				full_fname(fname), (double)j, (double)offset);
 			exit_cleanup(RERR_FILEIO);
 		}
 	}
 
 	while ((i = recv_token(f_in, &data)) != 0) {
 		if (do_progress)
@@ -212,21 +216,23 @@
 			map = map_ptr(mapbuf,offset2,len);
 
 			see_token(map, len);
 			sum_update(map, len);
 		}
 
-		if (inplace) {
+		if (updating_basis) {
 			if (offset == offset2 && fd != -1) {
+				OFF_T pos;
 				if (flush_write_file(fd) < 0)
 					goto report_write_error;
 				offset += len;
-				if (do_lseek(fd, len, SEEK_CUR) != offset) {
+				if ((pos = do_lseek(fd, len, SEEK_CUR)) != offset) {
 					rsyserr(FERROR, errno,
-						"lseek failed on %s",
-						full_fname(fname));
+						"lseek of %s returned %.0f, not %.0f",
+						full_fname(fname),
+						(double)pos, (double)offset);
 					exit_cleanup(RERR_FILEIO);
 				}
 				continue;
 			}
 		}
 		if (fd != -1 && map && write_file(fd, map, len) != (int)len)
@@ -290,13 +296,13 @@
 			 * partial-dir must be on the same drive. */
 			if (do_rename(partialptr, fname) < 0) {
 				rsyserr(FERROR, errno,
 					"rename failed for %s (from %s)",
 					full_fname(fname), partialptr);
 			} else {
-				if (remove_sent_files
+				if (remove_source_files
 				    || (preserve_hard_links
 				     && file->link_u.links)) {
 					SIVAL(numbuf, 0, i);
 					send_msg(MSG_SUCCESS,numbuf,4);
 				}
 				handle_partial_dir(partialptr, PDIR_DELETE);
@@ -338,14 +344,14 @@
 	char *fnamecmp, *partialptr, numbuf[4];
 	char fnamecmpbuf[MAXPATHLEN];
 	uchar fnamecmp_type;
 	struct file_struct *file;
 	struct stats initial_stats;
 	int save_make_backups = make_backups;
-	int itemizing = am_daemon ? daemon_log_format_has_i
-		      : !am_server && log_format_has_i;
+	int itemizing = am_server ? logfile_format_has_i : stdout_format_has_i;
+	enum logcode log_code = log_before_transfer ? FLOG : FINFO;
 	int max_phase = protocol_version >= 29 ? 2 : 1;
 	int i, recv_ok;
 
 	if (verbose > 2)
 		rprintf(FINFO,"recv_files(%d) starting\n",flist->count);
 
@@ -354,12 +360,14 @@
 		flist->hlink_pool = NULL;
 	}
 
 	if (delay_updates)
 		delayed_bits = bitbag_create(flist->count);
 
+	updating_basis = inplace;
+
 	while (1) {
 		cleanup_disable();
 
 		i = read_int(f_in);
 		if (i == -1) {
 			if (read_batch) {
@@ -415,20 +423,19 @@
 		    && check_filter(&server_filter_list, fname, 0) < 0) {
 			rprintf(FERROR, "attempt to hack rsync failed.\n");
 			exit_cleanup(RERR_PROTOCOL);
 		}
 
 		if (!do_xfers) { /* log the transfer */
-			if (!am_server && log_format)
-				log_item(file, &stats, iflags, NULL);
+			log_item(FCLIENT, file, &stats, iflags, NULL);
 			if (read_batch)
 				discard_receive_data(f_in, file->length);
 			continue;
 		}
 		if (write_batch < 0) {
-			log_item(file, &stats, iflags, NULL);
+			log_item(FINFO, file, &stats, iflags, NULL);
 			if (!am_server)
 				discard_receive_data(f_in, file->length);
 			continue;
 		}
 
 		if (read_batch) {
@@ -454,20 +461,22 @@
 				fnamecmp = partialptr;
 				break;
 			case FNAMECMP_BACKUP:
 				fnamecmp = get_backup_name(fname);
 				break;
 			case FNAMECMP_FUZZY:
+				updating_basis = 0;
 				if (file->dirname) {
 					pathjoin(fnamecmpbuf, MAXPATHLEN,
 						 file->dirname, xname);
 					fnamecmp = fnamecmpbuf;
 				} else
 					fnamecmp = xname;
 				break;
 			default:
+				updating_basis = 0;
 				if (fnamecmp_type >= basis_dir_cnt) {
 					rprintf(FERROR,
 						"invalid basis_dir index: %d.\n",
 						fnamecmp_type);
 					exit_cleanup(RERR_PROTOCOL);
 				}
@@ -508,13 +517,16 @@
 					 basis_dir[0], fname);
 				fnamecmp = fnamecmpbuf;
 				fd1 = do_open(fnamecmp, O_RDONLY, 0);
 			}
 		}
 
-		if (fd1 != -1 && do_fstat(fd1,&st) != 0) {
+		if (fd1 == -1) {
+			st.st_mode = 0;
+			st.st_size = 0;
+		} else if (do_fstat(fd1,&st) != 0) {
 			rsyserr(FERROR, errno, "fstat %s failed",
 				full_fname(fnamecmp));
 			discard_receive_data(f_in, file->length);
 			close(fd1);
 			continue;
 		}
@@ -541,13 +553,13 @@
 		 * mode based on the local permissions and some heuristics. */
 		if (!preserve_perms) {
 			int exists = fd1 != -1;
 			file->mode = dest_mode(file->mode, st.st_mode, exists);
 		}
 
-		/* We now check to see if we are writing file "inplace" */
+		/* We now check to see if we are writing the file "inplace" */
 		if (inplace)  {
 			fd2 = do_open(fname, O_WRONLY|O_CREAT, 0600);
 			if (fd2 == -1) {
 				rsyserr(FERROR, errno, "open %s failed",
 					full_fname(fname));
 				discard_receive_data(f_in, file->length);
@@ -586,41 +598,44 @@
 				discard_receive_data(f_in, file->length);
 				if (fd1 != -1)
 					close(fd1);
 				continue;
 			}
 
-			if (keep_partial)
-				cleanup_set(fnametmp, partialptr, file, fd1, fd2);
+			cleanup_set(fnametmp, partialptr, file, fd1, fd2);
 		}
 
 		/* log the transfer */
 		if (log_before_transfer)
-			log_item(file, &initial_stats, iflags, NULL);
+			log_item(FCLIENT, file, &initial_stats, iflags, NULL);
 		else if (!am_server && verbose && do_progress)
 			rprintf(FINFO, "%s\n", fname);
 
 		/* recv file data */
 		recv_ok = receive_data(f_in, fnamecmp, fd1, st.st_size,
 				       fname, fd2, file->length);
 
-		if (!log_before_transfer)
-			log_item(file, &initial_stats, iflags, NULL);
+		log_item(log_code, file, &initial_stats, iflags, NULL);
 
 		if (fd1 != -1)
 			close(fd1);
 		if (close(fd2) < 0) {
 			rsyserr(FERROR, errno, "close failed on %s",
 				full_fname(fnametmp));
 			exit_cleanup(RERR_FILEIO);
 		}
 
 		if ((recv_ok && (!delay_updates || !partialptr)) || inplace) {
-			if (partialptr == fname || *partial_dir == '/')
-				partialptr = NULL;
-			finish_transfer(fname, fnametmp, partialptr,
+			char *temp_copy_name;
+			if (partialptr == fname)
+				partialptr = temp_copy_name = NULL;
+			else if (*partial_dir == '/')
+				temp_copy_name = NULL;
+			else
+				temp_copy_name = partialptr;
+			finish_transfer(fname, fnametmp, temp_copy_name,
 					file, recv_ok, 1);
 			if (fnamecmp == partialptr) {
 				do_unlink(partialptr);
 				handle_partial_dir(partialptr, PDIR_DELETE);
 			}
 		} else if (keep_partial && partialptr
@@ -636,13 +651,13 @@
 			do_unlink(fnametmp);
 		}
 
 		cleanup_disable();
 
 		if (recv_ok > 0) {
-			if (remove_sent_files
+			if (remove_source_files
 			    || (preserve_hard_links && file->link_u.links)) {
 				SIVAL(numbuf, 0, i);
 				send_msg(MSG_SUCCESS, numbuf, 4);
 			}
 		} else if (!recv_ok) {
 			int msgtype = phase || read_batch ? FERROR : FINFO;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.1 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.1
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.1	2006-04-22 23:38:37.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.1	2006-11-07 12:39:51.000000000 +0800
@@ -1,10 +1,11 @@
-.TH "rsync" "1" "22 Apr 2006" "" "" 
-.SH "NAME" 
+.TH "rsync" "1" "6 Nov 2006" "" ""
+.SH "NAME"
 rsync \- faster, flexible replacement for rcp
-.SH "SYNOPSIS" 
+.SH "SYNOPSIS"
+
 .PP 
 rsync [OPTION]\&.\&.\&. SRC [SRC]\&.\&.\&. DEST
 .PP 
 rsync [OPTION]\&.\&.\&. SRC [SRC]\&.\&.\&. [USER@]HOST:DEST
 .PP 
 rsync [OPTION]\&.\&.\&. SRC [SRC]\&.\&.\&. [USER@]HOST::DEST
@@ -16,13 +17,14 @@
 rsync [OPTION]\&.\&.\&. [USER@]HOST:SRC [DEST]
 .PP 
 rsync [OPTION]\&.\&.\&. [USER@]HOST::SRC [DEST]
 .PP 
 rsync [OPTION]\&.\&.\&. rsync://[USER@]HOST[:PORT]/SRC [DEST]
 .PP 
-.SH "DESCRIPTION" 
+.SH "DESCRIPTION"
+
 .PP 
 rsync is a program that behaves in much the same way that rcp does,
 but has many more options and uses the rsync remote-update protocol to
 greatly speed up file transfers when the destination file is being
 updated\&.
 .PP 
@@ -45,14 +47,16 @@
 does not require super-user privileges
 .IP o 
 pipelining of file transfers to minimize latency costs
 .IP o 
 support for anonymous or authenticated rsync daemons (ideal for
 mirroring)
+
 .PP 
-.SH "GENERAL" 
+.SH "GENERAL"
+
 .PP 
 Rsync copies files either to or from a remote host, or locally on the
 current host (it does not support copying files between two remote hosts)\&.
 .PP 
 There are two different ways for rsync to contact a remote system: using a
 remote-shell program as the transport (such as ssh or rsh) or contacting an
@@ -62,142 +66,155 @@
 source or destination path contains a double colon (::) separator after a
 host specification, OR when an rsync:// URL is specified (see also the
 "USING RSYNC-DAEMON FEATURES VIA A REMOTE-SHELL CONNECTION" section for
 an exception to this latter rule)\&.
 .PP 
 As a special case, if a single source arg is specified without a
-destination, the files are listed in an output format similar to "ls -l"\&.
+destination, the files are listed in an output format similar to "ls \-l"\&.
 .PP 
 As expected, if neither the source or destination path specify a remote
-host, the copy occurs locally (see also the \fB--list-only\fP option)\&.
+host, the copy occurs locally (see also the \fB\-\-list\-only\fP option)\&.
 .PP 
-.SH "SETUP" 
+.SH "SETUP"
+
 .PP 
 See the file README for installation instructions\&.
 .PP 
 Once installed, you can use rsync to any machine that you can access via
 a remote shell (as well as some that you can access using the rsync
 daemon-mode protocol)\&.  For remote transfers, a modern rsync uses ssh
 for its communications, but it may have been configured to use a
 different remote shell by default, such as rsh or remsh\&.
 .PP 
-You can also specify any remote shell you like, either by using the \fB-e\fP
+You can also specify any remote shell you like, either by using the \fB\-e\fP
 command line option, or by setting the RSYNC_RSH environment variable\&.
 .PP 
 Note that rsync must be installed on both the source and destination
 machines\&.
 .PP 
-.SH "USAGE" 
+.SH "USAGE"
+
 .PP 
 You use rsync in the same way you use rcp\&. You must specify a source
 and a destination, one of which may be remote\&.
 .PP 
 Perhaps the best way to explain the syntax is with some examples:
 .PP 
 .RS 
-\f(CWrsync -t *\&.c foo:src/\fP
-.RE 
+\f(CWrsync \-t *\&.c foo:src/\fP
+.RE
+
 .PP 
 This would transfer all files matching the pattern *\&.c from the
 current directory to the directory src on the machine foo\&. If any of
 the files already exist on the remote system then the rsync
 remote-update protocol is used to update the file by sending only the
 differences\&. See the tech report for details\&.
 .PP 
 .RS 
-\f(CWrsync -avz foo:src/bar /data/tmp\fP
-.RE 
+\f(CWrsync \-avz foo:src/bar /data/tmp\fP
+.RE
+
 .PP 
 This would recursively transfer all files from the directory src/bar on the
 machine foo into the /data/tmp/bar directory on the local machine\&. The
 files are transferred in "archive" mode, which ensures that symbolic
 links, devices, attributes, permissions, ownerships, etc\&. are preserved
 in the transfer\&.  Additionally, compression will be used to reduce the
 size of data portions of the transfer\&.
 .PP 
 .RS 
-\f(CWrsync -avz foo:src/bar/ /data/tmp\fP
-.RE 
+\f(CWrsync \-avz foo:src/bar/ /data/tmp\fP
+.RE
+
 .PP 
 A trailing slash on the source changes this behavior to avoid creating an
 additional directory level at the destination\&.  You can think of a trailing
 / on a source as meaning "copy the contents of this directory" as opposed
 to "copy the directory by name", but in both cases the attributes of the
 containing directory are transferred to the containing directory on the
 destination\&.  In other words, each of the following commands copies the
 files in the same way, including their setting of the attributes of
 /dest/foo:
 .PP 
 .RS 
-\f(CWrsync -av /src/foo /dest\fP
+\f(CWrsync \-av /src/foo /dest\fP
 .br 
-\f(CWrsync -av /src/foo/ /dest/foo\fP
+\f(CWrsync \-av /src/foo/ /dest/foo\fP
 .br 
-.RE 
+.RE
+
 .PP 
 Note also that host and module references don\&'t require a trailing slash to
 copy the contents of the default directory\&.  For example, both of these
 copy the remote directory\&'s contents into "/dest":
 .PP 
 .RS 
-\f(CWrsync -av host: /dest\fP
+\f(CWrsync \-av host: /dest\fP
 .br 
-\f(CWrsync -av host::module /dest\fP
+\f(CWrsync \-av host::module /dest\fP
 .br 
-.RE 
+.RE
+
 .PP 
 You can also use rsync in local-only mode, where both the source and
 destination don\&'t have a \&':\&' in the name\&. In this case it behaves like
 an improved copy command\&.
 .PP 
 Finally, you can list all the (listable) modules available from a
 particular rsync daemon by leaving off the module name:
 .PP 
 .RS 
 \f(CWrsync somehost\&.mydomain\&.com::\fP
-.RE 
+.RE
+
 .PP 
 See the following section for more details\&.
 .PP 
-.SH "ADVANCED USAGE" 
+.SH "ADVANCED USAGE"
+
 .PP 
 The syntax for requesting multiple files from a remote host involves using
 quoted spaces in the SRC\&.  Some examples:
 .PP 
 .RS 
 \f(CWrsync host::\&'modname/dir1/file1 modname/dir2/file2\&' /dest\fP
-.RE 
+.RE
+
 .PP 
 This would copy file1 and file2 into /dest from an rsync daemon\&.  Each
 additional arg must include the same "modname/" prefix as the first one,
 and must be preceded by a single space\&.  All other spaces are assumed
 to be a part of the filenames\&.
 .PP 
 .RS 
-\f(CWrsync -av host:\&'dir1/file1 dir2/file2\&' /dest\fP
-.RE 
+\f(CWrsync \-av host:\&'dir1/file1 dir2/file2\&' /dest\fP
+.RE
+
 .PP 
 This would copy file1 and file2 into /dest using a remote shell\&.  This
 word-splitting is done by the remote shell, so if it doesn\&'t work it means
 that the remote shell isn\&'t configured to split its args based on
 whitespace (a very rare setting, but not unknown)\&.  If you need to transfer
 a filename that contains whitespace, you\&'ll need to either escape the
 whitespace in a way that the remote shell will understand, or use wildcards
 in place of the spaces\&.  Two examples of this are:
 .PP 
 .RS 
-\f(CWrsync -av host:\&'file\e name\e with\e spaces\&' /dest\fP
+\f(CWrsync \-av host:\&'file\e name\e with\e spaces\&' /dest\fP
 .br 
-\f(CWrsync -av host:file?name?with?spaces /dest\fP
+\f(CWrsync \-av host:file?name?with?spaces /dest\fP
 .br 
-.RE 
+.RE
+
 .PP 
 This latter example assumes that your shell passes through unmatched
 wildcards\&.  If it complains about "no match", put the name in quotes\&.
 .PP 
-.SH "CONNECTING TO AN RSYNC DAEMON" 
+.SH "CONNECTING TO AN RSYNC DAEMON"
+
 .PP 
 It is also possible to use rsync without a remote shell as the transport\&.
 In this case you will directly connect to a remote rsync daemon, typically
 using TCP port 873\&.  (This obviously requires the daemon to be running on
 the remote system, so refer to the STARTING AN RSYNC DAEMON TO ACCEPT
 CONNECTIONS section below for information on that\&.)
@@ -217,39 +234,38 @@
 if you specify no path name on the remote daemon then the
 list of accessible paths on the daemon will be shown\&.
 .IP o 
 if you specify no local destination then a listing of the
 specified files on the remote daemon is provided\&.
 .IP o 
-you must not specify the \fB--rsh\fP (\fB-e\fP) option\&.
+you must not specify the \fB\-\-rsh\fP (\fB\-e\fP) option\&.
+
 .PP 
 An example that copies all the files in a remote module named "src":
 .PP 
-
 .nf 
- 
-    rsync -av host::src /dest
+    rsync \-av host::src /dest
 .fi 
- 
 
 .PP 
 Some modules on the remote daemon may require authentication\&. If so,
 you will receive a password prompt when you connect\&. You can avoid the
 password prompt by setting the environment variable RSYNC_PASSWORD to
-the password you want to use or using the \fB--password-file\fP option\&. This
+the password you want to use or using the \fB\-\-password\-file\fP option\&. This
 may be useful when scripting rsync\&.
 .PP 
 WARNING: On some systems environment variables are visible to all
-users\&. On those systems using \fB--password-file\fP is recommended\&.
+users\&. On those systems using \fB\-\-password\-file\fP is recommended\&.
 .PP 
 You may establish the connection via a web proxy by setting the
 environment variable RSYNC_PROXY to a hostname:port pair pointing to
 your web proxy\&.  Note that your web proxy\&'s configuration must support
 proxy connections to port 873\&.
 .PP 
-.SH "USING RSYNC-DAEMON FEATURES VIA A REMOTE-SHELL CONNECTION" 
+.SH "USING RSYNC-DAEMON FEATURES VIA A REMOTE-SHELL CONNECTION"
+
 .PP 
 It is sometimes useful to use various features of an rsync daemon (such as
 named modules) without actually allowing any new socket connections into a
 system (other than what is already required to allow remote-shell access)\&.
 Rsync supports connecting to a host using a remote shell and then spawning
 a single-use "daemon" server that expects to read its config file in the
@@ -262,63 +278,60 @@
 connections from "localhost"\&.)
 .PP 
 From the user\&'s perspective, a daemon transfer via a remote-shell
 connection uses nearly the same command-line syntax as a normal
 rsync-daemon transfer, with the only exception being that you must
 explicitly set the remote shell program on the command-line with the
-\fB--rsh=COMMAND\fP option\&.  (Setting the RSYNC_RSH in the environment
+\fB\-\-rsh=COMMAND\fP option\&.  (Setting the RSYNC_RSH in the environment
 will not turn on this functionality\&.)  For example:
 .PP 
-
 .nf 
- 
-    rsync -av --rsh=ssh host::module /dest
+    rsync \-av \-\-rsh=ssh host::module /dest
 .fi 
- 
 
 .PP 
 If you need to specify a different remote-shell user, keep in mind that the
 user@ prefix in front of the host is specifying the rsync-user value (for a
 module that requires user-based authentication)\&.  This means that you must
-give the \&'-l user\&' option to ssh when specifying the remote-shell, as in
-this example that uses the short version of the \fB--rsh\fP option:
+give the \&'\-l user\&' option to ssh when specifying the remote-shell, as in
+this example that uses the short version of the \fB\-\-rsh\fP option:
 .PP 
-
 .nf 
- 
-    rsync -av -e "ssh -l ssh-user" rsync-user@host::module /dest
+    rsync \-av \-e "ssh \-l ssh-user" rsync-user@host::module /dest
 .fi 
- 
 
 .PP 
 The "ssh-user" will be used at the ssh level; the "rsync-user" will be
 used to log-in to the "module"\&.
 .PP 
-.SH "STARTING AN RSYNC DAEMON TO ACCEPT CONNECTIONS" 
+.SH "STARTING AN RSYNC DAEMON TO ACCEPT CONNECTIONS"
+
 .PP 
 In order to connect to an rsync daemon, the remote system needs to have a
 daemon already running (or it needs to have configured something like inetd
 to spawn an rsync daemon for incoming connections on a particular port)\&.
 For full information on how to start a daemon that will handling incoming
 socket connections, see the \fBrsyncd\&.conf\fP(5) man page -- that is the config
 file for the daemon, and it contains the full details for how to run the
 daemon (including stand-alone and inetd configurations)\&.
 .PP 
 If you\&'re using one of the remote-shell transports for the transfer, there is
 no need to manually start an rsync daemon\&.
 .PP 
-.SH "EXAMPLES" 
+.SH "EXAMPLES"
+
 .PP 
 Here are some examples of how I use rsync\&.
 .PP 
 To backup my wife\&'s home directory, which consists of large MS Word
 files and mail folders, I use a cron job that runs
 .PP 
 .RS 
-\f(CWrsync -Cavz \&. arvidsjaur:backup\fP
-.RE 
+\f(CWrsync \-Cavz \&. arvidsjaur:backup\fP
+.RE
+
 .PP 
 each night over a PPP connection to a duplicate directory on my machine
 "arvidsjaur"\&.
 .PP 
 To synchronize my samba source trees I use the following Makefile
 targets:
@@ -320,235 +333,242 @@
 each night over a PPP connection to a duplicate directory on my machine
 "arvidsjaur"\&.
 .PP 
 To synchronize my samba source trees I use the following Makefile
 targets:
 .PP 
-
 .nf 
- 
     get:
-            rsync -avuzb --exclude \&'*~\&' samba:samba/ \&.
+            rsync \-avuzb \-\-exclude \&'*~\&' samba:samba/ \&.
     put:
-            rsync -Cavuzb \&. samba:samba/
+            rsync \-Cavuzb \&. samba:samba/
     sync: get put
 .fi 
- 
 
 .PP 
 this allows me to sync with a CVS directory at the other end of the
 connection\&. I then do CVS operations on the remote machine, which saves a
 lot of time as the remote CVS protocol isn\&'t very efficient\&.
 .PP 
 I mirror a directory between my "old" and "new" ftp sites with the
 command:
 .PP 
-\f(CWrsync -az -e ssh --delete ~ftp/pub/samba nimbus:"~ftp/pub/tridge"\fP
+\f(CWrsync \-az \-e ssh \-\-delete ~ftp/pub/samba nimbus:"~ftp/pub/tridge"\fP
 .PP 
 This is launched from cron every few hours\&.
 .PP 
-.SH "OPTIONS SUMMARY" 
+.SH "OPTIONS SUMMARY"
+
 .PP 
 Here is a short summary of the options available in rsync\&. Please refer
 to the detailed description below for a complete description\&.  
 .nf 
- 
-
- -v, --verbose               increase verbosity
- -q, --quiet                 suppress non-error messages
- -c, --checksum              skip based on checksum, not mod-time & size
- -a, --archive               archive mode; same as -rlptgoD (no -H)
-     --no-OPTION             turn off an implied OPTION (e\&.g\&. --no-D)
- -r, --recursive             recurse into directories
- -R, --relative              use relative path names
-     --no-implied-dirs       don\&'t send implied dirs with --relative
- -b, --backup                make backups (see --suffix & --backup-dir)
-     --backup-dir=DIR        make backups into hierarchy based in DIR
-     --suffix=SUFFIX         backup suffix (default ~ w/o --backup-dir)
- -u, --update                skip files that are newer on the receiver
-     --inplace               update destination files in-place
-     --append                append data onto shorter files
- -d, --dirs                  transfer directories without recursing
- -l, --links                 copy symlinks as symlinks
- -L, --copy-links            transform symlink into referent file/dir
-     --copy-unsafe-links     only "unsafe" symlinks are transformed
-     --safe-links            ignore symlinks that point outside the tree
- -k, --copy-dirlinks         transform symlink to dir into referent dir
- -K, --keep-dirlinks         treat symlinked dir on receiver as dir
- -H, --hard-links            preserve hard links
- -p, --perms                 preserve permissions
- -E, --executability         preserve executability
-     --chmod=CHMOD           change destination permissions
- -o, --owner                 preserve owner (super-user only)
- -g, --group                 preserve group
-     --devices               preserve device files (super-user only)
-     --specials              preserve special files
- -D                          same as --devices --specials
- -t, --times                 preserve times
- -O, --omit-dir-times        omit directories when preserving times
-     --super                 receiver attempts super-user activities
- -S, --sparse                handle sparse files efficiently
- -n, --dry-run               show what would have been transferred
- -W, --whole-file            copy files whole (without rsync algorithm)
- -x, --one-file-system       don\&'t cross filesystem boundaries
- -B, --block-size=SIZE       force a fixed checksum block-size
- -e, --rsh=COMMAND           specify the remote shell to use
-     --rsync-path=PROGRAM    specify the rsync to run on remote machine
-     --existing              ignore non-existing files on receiving side
-     --ignore-existing       ignore files that already exist on receiver
-     --remove-sent-files     sent files/symlinks are removed from sender
-     --del                   an alias for --delete-during
-     --delete                delete files that don\&'t exist on sender
-     --delete-before         receiver deletes before transfer (default)
-     --delete-during         receiver deletes during xfer, not before
-     --delete-after          receiver deletes after transfer, not before
-     --delete-excluded       also delete excluded files on receiver
-     --ignore-errors         delete even if there are I/O errors
-     --force                 force deletion of dirs even if not empty
-     --max-delete=NUM        don\&'t delete more than NUM files
-     --max-size=SIZE         don\&'t transfer any file larger than SIZE
-     --min-size=SIZE         don\&'t transfer any file smaller than SIZE
-     --partial               keep partially transferred files
-     --partial-dir=DIR       put a partially transferred file into DIR
-     --delay-updates         put all updated files into place at end
- -m, --prune-empty-dirs      prune empty directory chains from file-list
-     --numeric-ids           don\&'t map uid/gid values by user/group name
-     --timeout=TIME          set I/O timeout in seconds
- -I, --ignore-times          don\&'t skip files that match size and time
-     --size-only             skip files that match in size
-     --modify-window=NUM     compare mod-times with reduced accuracy
- -T, --temp-dir=DIR          create temporary files in directory DIR
- -y, --fuzzy                 find similar file for basis if no dest file
-     --compare-dest=DIR      also compare received files relative to DIR
-     --copy-dest=DIR         \&.\&.\&. and include copies of unchanged files
-     --link-dest=DIR         hardlink to files in DIR when unchanged
- -z, --compress              compress file data during the transfer
-     --compress-level=NUM    explicitly set compression level
- -C, --cvs-exclude           auto-ignore files in the same way CVS does
- -f, --filter=RULE           add a file-filtering RULE
- -F                          same as --filter=\&'dir-merge /\&.rsync-filter\&'
-                             repeated: --filter=\&'- \&.rsync-filter\&'
-     --exclude=PATTERN       exclude files matching PATTERN
-     --exclude-from=FILE     read exclude patterns from FILE
-     --include=PATTERN       don\&'t exclude files matching PATTERN
-     --include-from=FILE     read include patterns from FILE
-     --files-from=FILE       read list of source-file names from FILE
- -0, --from0                 all *from/filter files are delimited by 0s
-     --address=ADDRESS       bind address for outgoing socket to daemon
-     --port=PORT             specify double-colon alternate port number
-     --sockopts=OPTIONS      specify custom TCP options
-     --blocking-io           use blocking I/O for the remote shell
-     --stats                 give some file-transfer stats
- -8, --8-bit-output          leave high-bit chars unescaped in output
- -h, --human-readable        output numbers in a human-readable format
-     --progress              show progress during transfer
- -P                          same as --partial --progress
- -i, --itemize-changes       output a change-summary for all updates
-     --log-format=FORMAT     output filenames using the specified format
-     --password-file=FILE    read password from FILE
-     --list-only             list the files instead of copying them
-     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
-     --write-batch=FILE      write a batched update to FILE
-     --only-write-batch=FILE like --write-batch but w/o updating dest
-     --read-batch=FILE       read a batched update from FILE
-     --protocol=NUM          force an older protocol version to be used
-     --checksum-seed=NUM     set block/file checksum seed (advanced)
- -4, --ipv4                  prefer IPv4
- -6, --ipv6                  prefer IPv6
-     --version               print version number
-(-h) --help                  show this help (see below for -h comment)
 
+ \-v, \-\-verbose               increase verbosity
+ \-q, \-\-quiet                 suppress non-error messages
+     \-\-no\-motd               suppress daemon-mode MOTD (see caveat)
+ \-c, \-\-checksum              skip based on checksum, not mod-time & size
+ \-a, \-\-archive               archive mode; same as \-rlptgoD (no \-H)
+     \-\-no\-OPTION             turn off an implied OPTION (e\&.g\&. \-\-no\-D)
+ \-r, \-\-recursive             recurse into directories
+ \-R, \-\-relative              use relative path names
+     \-\-no\-implied\-dirs       don\&'t send implied dirs with \-\-relative
+ \-b, \-\-backup                make backups (see \-\-suffix & \-\-backup\-dir)
+     \-\-backup\-dir=DIR        make backups into hierarchy based in DIR
+     \-\-suffix=SUFFIX         backup suffix (default ~ w/o \-\-backup\-dir)
+ \-u, \-\-update                skip files that are newer on the receiver
+     \-\-inplace               update destination files in-place
+     \-\-append                append data onto shorter files
+ \-d, \-\-dirs                  transfer directories without recursing
+ \-l, \-\-links                 copy symlinks as symlinks
+ \-L, \-\-copy\-links            transform symlink into referent file/dir
+     \-\-copy\-unsafe\-links     only "unsafe" symlinks are transformed
+     \-\-safe\-links            ignore symlinks that point outside the tree
+ \-k, \-\-copy\-dirlinks         transform symlink to dir into referent dir
+ \-K, \-\-keep\-dirlinks         treat symlinked dir on receiver as dir
+ \-H, \-\-hard\-links            preserve hard links
+ \-p, \-\-perms                 preserve permissions
+ \-E, \-\-executability         preserve executability
+     \-\-chmod=CHMOD           affect file and/or directory permissions
+ \-o, \-\-owner                 preserve owner (super-user only)
+ \-g, \-\-group                 preserve group
+     \-\-devices               preserve device files (super-user only)
+     \-\-specials              preserve special files
+ \-D                          same as \-\-devices \-\-specials
+ \-t, \-\-times                 preserve times
+ \-O, \-\-omit\-dir\-times        omit directories when preserving times
+     \-\-super                 receiver attempts super-user activities
+ \-S, \-\-sparse                handle sparse files efficiently
+ \-n, \-\-dry\-run               show what would have been transferred
+ \-W, \-\-whole\-file            copy files whole (without rsync algorithm)
+ \-x, \-\-one\-file\-system       don\&'t cross filesystem boundaries
+ \-B, \-\-block\-size=SIZE       force a fixed checksum block-size
+ \-e, \-\-rsh=COMMAND           specify the remote shell to use
+     \-\-rsync\-path=PROGRAM    specify the rsync to run on remote machine
+     \-\-existing              skip creating new files on receiver
+     \-\-ignore\-existing       skip updating files that exist on receiver
+     \-\-remove\-source\-files   sender removes synchronized files (non-dir)
+     \-\-del                   an alias for \-\-delete\-during
+     \-\-delete                delete extraneous files from dest dirs
+     \-\-delete\-before         receiver deletes before transfer (default)
+     \-\-delete\-during         receiver deletes during xfer, not before
+     \-\-delete\-after          receiver deletes after transfer, not before
+     \-\-delete\-excluded       also delete excluded files from dest dirs
+     \-\-ignore\-errors         delete even if there are I/O errors
+     \-\-force                 force deletion of dirs even if not empty
+     \-\-max\-delete=NUM        don\&'t delete more than NUM files
+     \-\-max\-size=SIZE         don\&'t transfer any file larger than SIZE
+     \-\-min\-size=SIZE         don\&'t transfer any file smaller than SIZE
+     \-\-partial               keep partially transferred files
+     \-\-partial\-dir=DIR       put a partially transferred file into DIR
+     \-\-delay\-updates         put all updated files into place at end
+ \-m, \-\-prune\-empty\-dirs      prune empty directory chains from file-list
+     \-\-numeric\-ids           don\&'t map uid/gid values by user/group name
+     \-\-timeout=TIME          set I/O timeout in seconds
+ \-I, \-\-ignore\-times          don\&'t skip files that match size and time
+     \-\-size\-only             skip files that match in size
+     \-\-modify\-window=NUM     compare mod-times with reduced accuracy
+ \-T, \-\-temp\-dir=DIR          create temporary files in directory DIR
+ \-y, \-\-fuzzy                 find similar file for basis if no dest file
+     \-\-compare\-dest=DIR      also compare received files relative to DIR
+     \-\-copy\-dest=DIR         \&.\&.\&. and include copies of unchanged files
+     \-\-link\-dest=DIR         hardlink to files in DIR when unchanged
+ \-z, \-\-compress              compress file data during the transfer
+     \-\-compress\-level=NUM    explicitly set compression level
+ \-C, \-\-cvs\-exclude           auto-ignore files in the same way CVS does
+ \-f, \-\-filter=RULE           add a file-filtering RULE
+ \-F                          same as \-\-filter=\&'dir-merge /\&.rsync\-filter\&'
+                             repeated: \-\-filter=\&'\- \&.rsync\-filter\&'
+     \-\-exclude=PATTERN       exclude files matching PATTERN
+     \-\-exclude\-from=FILE     read exclude patterns from FILE
+     \-\-include=PATTERN       don\&'t exclude files matching PATTERN
+     \-\-include\-from=FILE     read include patterns from FILE
+     \-\-files\-from=FILE       read list of source-file names from FILE
+ \-0, \-\-from0                 all *from/filter files are delimited by 0s
+     \-\-address=ADDRESS       bind address for outgoing socket to daemon
+     \-\-port=PORT             specify double-colon alternate port number
+     \-\-sockopts=OPTIONS      specify custom TCP options
+     \-\-blocking\-io           use blocking I/O for the remote shell
+     \-\-stats                 give some file-transfer stats
+ \-8, \-\-8\-bit\-output          leave high-bit chars unescaped in output
+ \-h, \-\-human\-readable        output numbers in a human-readable format
+     \-\-progress              show progress during transfer
+ \-P                          same as \-\-partial \-\-progress
+ \-i, \-\-itemize\-changes       output a change-summary for all updates
+     \-\-out\-format=FORMAT     output updates using the specified FORMAT
+     \-\-log\-file=FILE         log what we\&'re doing to the specified FILE
+     \-\-log\-file\-format=FMT   log updates using the specified FMT
+     \-\-password\-file=FILE    read password from FILE
+     \-\-list\-only             list the files instead of copying them
+     \-\-bwlimit=KBPS          limit I/O bandwidth; KBytes per second
+     \-\-write\-batch=FILE      write a batched update to FILE
+     \-\-only\-write\-batch=FILE like \-\-write\-batch but w/o updating dest
+     \-\-read\-batch=FILE       read a batched update from FILE
+     \-\-protocol=NUM          force an older protocol version to be used
+     \-\-checksum\-seed=NUM     set block/file checksum seed (advanced)
+ \-4, \-\-ipv4                  prefer IPv4
+ \-6, \-\-ipv6                  prefer IPv6
+     \-\-version               print version number
+(\-h) \-\-help                  show this help (see below for \-h comment)
 .fi 
- 
 
 .PP 
 Rsync can also be run as a daemon, in which case the following options are
 accepted: 
 .nf 
- 
-
-     --daemon                run as an rsync daemon
-     --address=ADDRESS       bind to the specified address
-     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
-     --config=FILE           specify alternate rsyncd\&.conf file
-     --no-detach             do not detach from the parent
-     --port=PORT             listen on alternate port number
-     --sockopts=OPTIONS      specify custom TCP options
- -v, --verbose               increase verbosity
- -4, --ipv4                  prefer IPv4
- -6, --ipv6                  prefer IPv6
- -h, --help                  show this help (if used after --daemon)
 
+     \-\-daemon                run as an rsync daemon
+     \-\-address=ADDRESS       bind to the specified address
+     \-\-bwlimit=KBPS          limit I/O bandwidth; KBytes per second
+     \-\-config=FILE           specify alternate rsyncd\&.conf file
+     \-\-no\-detach             do not detach from the parent
+     \-\-port=PORT             listen on alternate port number
+     \-\-log\-file=FILE         override the "log file" setting
+     \-\-log\-file\-format=FMT   override the "log format" setting
+     \-\-sockopts=OPTIONS      specify custom TCP options
+ \-v, \-\-verbose               increase verbosity
+ \-4, \-\-ipv4                  prefer IPv4
+ \-6, \-\-ipv6                  prefer IPv6
+ \-h, \-\-help                  show this help (if used after \-\-daemon)
 .fi 
- 
 
 .PP 
-.SH "OPTIONS" 
+.SH "OPTIONS"
+
 .PP 
 rsync uses the GNU long options package\&. Many of the command line
 options have two variants, one short and one long\&.  These are shown
 below, separated by commas\&. Some options only have a long variant\&.
 The \&'=\&' for options that take a parameter is optional; whitespace
 can be used instead\&.
 .PP 
-.IP "\fB--help\fP" 
+.IP "\fB\-\-help\fP"
 Print a short help page describing the options
 available in rsync and exit\&.  For backward-compatibility with older
-versions of rsync, the help will also be output if you use the \fB-h\fP
+versions of rsync, the help will also be output if you use the \fB\-h\fP
 option without any other args\&.
 .IP 
-.IP "\fB--version\fP" 
+.IP "\fB\-\-version\fP"
 print the rsync version number and exit\&.
 .IP 
-.IP "\fB-v, --verbose\fP" 
+.IP "\fB\-v, \-\-verbose\fP"
 This option increases the amount of information you
 are given during the transfer\&.  By default, rsync works silently\&. A
-single \fB-v\fP will give you information about what files are being
-transferred and a brief summary at the end\&. Two \fB-v\fP flags will give you
+single \fB\-v\fP will give you information about what files are being
+transferred and a brief summary at the end\&. Two \fB\-v\fP flags will give you
 information on what files are being skipped and slightly more
-information at the end\&. More than two \fB-v\fP flags should only be used if
+information at the end\&. More than two \fB\-v\fP flags should only be used if
 you are debugging rsync\&.
 .IP 
 Note that the names of the transferred files that are output are done using
-a default \fB--log-format\fP of "%n%L", which tells you just the name of the
-file and, if the item is a link, where it points\&.  At the single \fB-v\fP
+a default \fB\-\-out\-format\fP of "%n%L", which tells you just the name of the
+file and, if the item is a link, where it points\&.  At the single \fB\-v\fP
 level of verbosity, this does not mention when a file gets its attributes
 changed\&.  If you ask for an itemized list of changed attributes (either
-\fB--itemize-changes\fP or adding "%i" to the \fB--log-format\fP setting), the
+\fB\-\-itemize\-changes\fP or adding "%i" to the \fB\-\-out\-format\fP setting), the
 output (on the client) increases to mention all items that are changed in
-any way\&.  See the \fB--log-format\fP option for more details\&.
+any way\&.  See the \fB\-\-out\-format\fP option for more details\&.
 .IP 
-.IP "\fB-q, --quiet\fP" 
+.IP "\fB\-q, \-\-quiet\fP"
 This option decreases the amount of information you
 are given during the transfer, notably suppressing information messages
 from the remote server\&. This flag is useful when invoking rsync from
 cron\&.
 .IP 
-.IP "\fB-I, --ignore-times\fP" 
+.IP "\fB\-\-no\-motd\fP"
+This option affects the information that is output
+by the client at the start of a daemon transfer\&.  This suppresses the
+message-of-the-day (MOTD) text, but it also affects the list of modules
+that the daemon sends in response to the "rsync host::" request (due to
+a limitation in the rsync protocol), so omit this option if you want to
+request the list of modules from the deamon\&.
+.IP 
+.IP "\fB\-I, \-\-ignore\-times\fP"
 Normally rsync will skip any files that are
 already the same size and have the same modification time-stamp\&.
-This option turns off this "quick check" behavior\&.
+This option turns off this "quick check" behavior, causing all files to
+be updated\&.
 .IP 
-.IP "\fB--size-only\fP" 
+.IP "\fB\-\-size\-only\fP"
 Normally rsync will not transfer any files that are
 already the same size and have the same modification time-stamp\&. With the
-\fB--size-only\fP option, files will not be transferred if they have the same size,
+\fB\-\-size\-only\fP option, files will not be transferred if they have the same size,
 regardless of timestamp\&. This is useful when starting to use rsync
 after using another mirroring system which may not preserve timestamps
 exactly\&.
 .IP 
-.IP "\fB--modify-window\fP" 
+.IP "\fB\-\-modify\-window\fP"
 When comparing two timestamps, rsync treats the
 timestamps as being equal if they differ by no more than the modify-window
 value\&.  This is normally 0 (for an exact match), but you may find it useful
 to set this to a larger value in some situations\&.  In particular, when
 transferring to or from an MS Windows FAT filesystem (which represents
-times with a 2-second resolution), \fB--modify-window=1\fP is useful
+times with a 2-second resolution), \fB\-\-modify\-window=1\fP is useful
 (allowing times to differ by up to 1 second)\&.
 .IP 
-.IP "\fB-c, --checksum\fP" 
+.IP "\fB\-c, \-\-checksum\fP"
 This forces the sender to checksum \fIevery\fP
 regular file using a 128-bit MD4 checksum\&.  It does this during the initial
 file-system scan as it builds the list of all available files\&. The receiver
 then checksums its version of each file (if it exists and it has the same
 size as its sender-side counterpart) in order to decide which files need to
 be updated: files with either a changed size or a changed checksum are
@@ -559,461 +579,471 @@
 .IP 
 Note that rsync always verifies that each \fItransferred\fP file was correctly
 reconstructed on the receiving side by checking its whole-file checksum, but
 that automatic after-the-transfer verification has nothing to do with this
 option\&'s before-the-transfer "Does this file need to be updated?" check\&.
 .IP 
-.IP "\fB-a, --archive\fP" 
-This is equivalent to \fB-rlptgoD\fP\&. It is a quick
+.IP "\fB\-a, \-\-archive\fP"
+This is equivalent to \fB\-rlptgoD\fP\&. It is a quick
 way of saying you want recursion and want to preserve almost
-everything (with -H being a notable omission)\&.
-The only exception to the above equivalence is when \fB--files-from\fP is
-specified, in which case \fB-r\fP is not implied\&.
+everything (with \-H being a notable omission)\&.
+The only exception to the above equivalence is when \fB\-\-files\-from\fP is
+specified, in which case \fB\-r\fP is not implied\&.
 .IP 
-Note that \fB-a\fP \fBdoes not preserve hardlinks\fP, because
+Note that \fB\-a\fP \fBdoes not preserve hardlinks\fP, because
 finding multiply-linked files is expensive\&.  You must separately
-specify \fB-H\fP\&.
+specify \fB\-H\fP\&.
 .IP 
-.IP "--no-OPTION" 
+.IP "\-\-no\-OPTION"
 You may turn off one or more implied options by prefixing
-the option name with "no-"\&.  Not all options may be prefixed with a "no-":
-only options that are implied by other options (e\&.g\&. \fB--no-D\fP,
-\fB--no-perms\fP) or have different defaults in various circumstances
-(e\&.g\&. \fB--no-whole-file\fP, \fB--no-blocking-io\fP, \fB--no-dirs\fP)\&.  You may
-specify either the short or the long option name after the "no-" prefix
-(e\&.g\&. \fB--no-R\fP is the same as \fB--no-relative\fP)\&.
-.IP 
-For example: if you want to use \fB-a\fP (\fB--archive\fP) but don\&'t want
-\fB-o\fP (\fB--owner\fP), instead of converting \fB-a\fP into \fB-rlptgD\fP, you
-could specify \fB-a --no-o\fP (or \fB-a --no-owner\fP)\&.
-.IP 
-The order of the options is important:  if you specify \fB--no-r -a\fP, the
-\fB-r\fP option would end up being turned on, the opposite of \fB-a --no-r\fP\&.
-Note also that the side-effects of the \fB--files-from\fP option are NOT
+the option name with "no\-"\&.  Not all options may be prefixed with a "no\-":
+only options that are implied by other options (e\&.g\&. \fB\-\-no\-D\fP,
+\fB\-\-no\-perms\fP) or have different defaults in various circumstances
+(e\&.g\&. \fB\-\-no\-whole\-file\fP, \fB\-\-no\-blocking\-io\fP, \fB\-\-no\-dirs\fP)\&.  You may
+specify either the short or the long option name after the "no\-" prefix
+(e\&.g\&. \fB\-\-no\-R\fP is the same as \fB\-\-no\-relative\fP)\&.
+.IP 
+For example: if you want to use \fB\-a\fP (\fB\-\-archive\fP) but don\&'t want
+\fB\-o\fP (\fB\-\-owner\fP), instead of converting \fB\-a\fP into \fB\-rlptgD\fP, you
+could specify \fB\-a \-\-no\-o\fP (or \fB\-a \-\-no\-owner\fP)\&.
+.IP 
+The order of the options is important:  if you specify \fB\-\-no\-r \-a\fP, the
+\fB\-r\fP option would end up being turned on, the opposite of \fB\-a \-\-no\-r\fP\&.
+Note also that the side-effects of the \fB\-\-files\-from\fP option are NOT
 positional, as it affects the default state of several options and slightly
-changes the meaning of \fB-a\fP (see the \fB--files-from\fP option for more
+changes the meaning of \fB\-a\fP (see the \fB\-\-files\-from\fP option for more
 details)\&.
 .IP 
-.IP "\fB-r, --recursive\fP" 
+.IP "\fB\-r, \-\-recursive\fP"
 This tells rsync to copy directories
-recursively\&.  See also \fB--dirs\fP (\fB-d\fP)\&.
+recursively\&.  See also \fB\-\-dirs\fP (\fB\-d\fP)\&.
 .IP 
-.IP "\fB-R, --relative\fP" 
+.IP "\fB\-R, \-\-relative\fP"
 Use relative paths\&. This means that the full path
 names specified on the command line are sent to the server rather than
 just the last parts of the filenames\&. This is particularly useful when
 you want to send several different directories at the same time\&. For
 example, if you used this command:
 .IP 
 .RS 
-\f(CW   rsync -av /foo/bar/baz\&.c remote:/tmp/\fP
-.RE 
+\f(CW   rsync \-av /foo/bar/baz\&.c remote:/tmp/\fP
+.RE
+
 .IP 
 \&.\&.\&. this would create a file named baz\&.c in /tmp/ on the remote
 machine\&. If instead you used
 .IP 
 .RS 
-\f(CW   rsync -avR /foo/bar/baz\&.c remote:/tmp/\fP
-.RE 
+\f(CW   rsync \-avR /foo/bar/baz\&.c remote:/tmp/\fP
+.RE
+
 .IP 
 then a file named /tmp/foo/bar/baz\&.c would be created on the remote
 machine -- the full path name is preserved\&.  To limit the amount of
 path information that is sent, you have a couple options:  (1) With
 a modern rsync on the sending side (beginning with 2\&.6\&.7), you can
 insert a dot and a slash into the source path, like this:
 .IP 
 .RS 
-\f(CW   rsync -avR /foo/\&./bar/baz\&.c remote:/tmp/\fP
-.RE 
+\f(CW   rsync \-avR /foo/\&./bar/baz\&.c remote:/tmp/\fP
+.RE
+
 .IP 
 That would create /tmp/bar/baz\&.c on the remote machine\&.  (Note that the
 dot must be followed by a slash, so "/foo/\&." would not be abbreviated\&.)
 (2) For older rsync versions, you would need to use a chdir to limit the
 source path\&.  For example, when pushing files:
 .IP 
 .RS 
-\f(CW   (cd /foo; rsync -avR bar/baz\&.c remote:/tmp/) \fP
-.RE 
+\f(CW   (cd /foo; rsync \-avR bar/baz\&.c remote:/tmp/) \fP
+.RE
+
 .IP 
 (Note that the parens put the two commands into a sub-shell, so that the
 "cd" command doesn\&'t remain in effect for future commands\&.)
 If you\&'re pulling files, use this idiom (which doesn\&'t work with an
 rsync daemon):
 .IP 
 .RS 
-\f(CW   rsync -avR --rsync-path="cd /foo; rsync" \e \fP
+\f(CW   rsync \-avR \-\-rsync\-path="cd /foo; rsync" \e \fP
 .br 
 \f(CW       remote:bar/baz\&.c /tmp/\fP
-.RE 
+.RE
+
 .IP 
-.IP "\fB--no-implied-dirs\fP" 
+.IP "\fB\-\-no\-implied\-dirs\fP"
 This option affects the default behavior of the
-\fB--relative\fP option\&.  When it is specified, the attributes of the implied
+\fB\-\-relative\fP option\&.  When it is specified, the attributes of the implied
 directories from the source names are not included in the transfer\&.  This
 means that the corresponding path elements on the destination system are
 left unchanged if they exist, and any missing implied directories are
 created with default attributes\&.  This even allows these implied path
 elements to have big differences, such as being a symlink to a directory on
 one side of the transfer, and a real directory on the other side\&.
 .IP 
 For instance, if a command-line arg or a files-from entry told rsync to
 transfer the file "path/foo/file", the directories "path" and "path/foo"
-are implied when \fB--relative\fP is used\&.  If "path/foo" is a symlink to
+are implied when \fB\-\-relative\fP is used\&.  If "path/foo" is a symlink to
 "bar" on the destination system, the receiving rsync would ordinarily
 delete "path/foo", recreate it as a directory, and receive the file into
-the new directory\&.  With \fB--no-implied-dirs\fP, the receiving rsync updates
+the new directory\&.  With \fB\-\-no\-implied\-dirs\fP, the receiving rsync updates
 "path/foo/file" using the existing path elements, which means that the file
 ends up being created in "path/bar"\&.  Another way to accomplish this link
-preservation is to use the \fB--keep-dirlinks\fP option (which will also
+preservation is to use the \fB\-\-keep\-dirlinks\fP option (which will also
 affect symlinks to directories in the rest of the transfer)\&.
 .IP 
 In a similar but opposite scenario, if the transfer of "path/foo/file" is
 requested and "path/foo" is a symlink on the sending side, running without
-\fB--no-implied-dirs\fP would cause rsync to transform "path/foo" on the
+\fB\-\-no\-implied\-dirs\fP would cause rsync to transform "path/foo" on the
 receiving side into an identical symlink, and then attempt to transfer
 "path/foo/file", which might fail if the duplicated symlink did not point
 to a directory on the receiving side\&.  Another way to avoid this sending of
-a symlink as an implied directory is to use \fB--copy-unsafe-links\fP, or
-\fB--copy-dirlinks\fP (both of which also affect symlinks in the rest of the
+a symlink as an implied directory is to use \fB\-\-copy\-unsafe\-links\fP, or
+\fB\-\-copy\-dirlinks\fP (both of which also affect symlinks in the rest of the
 transfer -- see their descriptions for full details)\&.
 .IP 
-.IP "\fB-b, --backup\fP" 
+.IP "\fB\-b, \-\-backup\fP"
 With this option, preexisting destination files are
 renamed as each file is transferred or deleted\&.  You can control where the
 backup file goes and what (if any) suffix gets appended using the
-\fB--backup-dir\fP and \fB--suffix\fP options\&.
+\fB\-\-backup\-dir\fP and \fB\-\-suffix\fP options\&.
 .IP 
-Note that if you don\&'t specify \fB--backup-dir\fP, (1) the
-\fB--omit-dir-times\fP option will be implied, and (2) if \fB--delete\fP is
-also in effect (without \fB--delete-excluded\fP), rsync will add a "protect"
+Note that if you don\&'t specify \fB\-\-backup\-dir\fP, (1) the
+\fB\-\-omit\-dir\-times\fP option will be implied, and (2) if \fB\-\-delete\fP is
+also in effect (without \fB\-\-delete\-excluded\fP), rsync will add a "protect"
 filter-rule for the backup suffix to the end of all your existing excludes
-(e\&.g\&. -f "P *~")\&.  This will prevent previously backed-up files from being
+(e\&.g\&. \-f "P *~")\&.  This will prevent previously backed-up files from being
 deleted\&.  Note that if you are supplying your own filter rules, you may
 need to manually insert your own exclude/protect rule somewhere higher up
 in the list so that it has a high enough priority to be effective (e\&.g\&., if
 your rules specify a trailing inclusion/exclusion of \&'*\&', the auto-added
 rule would never be reached)\&.
 .IP 
-.IP "\fB--backup-dir=DIR\fP" 
-In combination with the \fB--backup\fP option, this
-tells rsync to store all backups in the specified directory\&. This is
-very useful for incremental backups\&.  You can additionally
-specify a backup suffix using the \fB--suffix\fP option
+.IP "\fB\-\-backup\-dir=DIR\fP"
+In combination with the \fB\-\-backup\fP option, this
+tells rsync to store all backups in the specified directory on the receiving
+side\&.  This can be used for incremental backups\&.  You can additionally
+specify a backup suffix using the \fB\-\-suffix\fP option
 (otherwise the files backed up in the specified directory
 will keep their original filenames)\&.
 .IP 
-.IP "\fB--suffix=SUFFIX\fP" 
+.IP "\fB\-\-suffix=SUFFIX\fP"
 This option allows you to override the default
-backup suffix used with the \fB--backup\fP (\fB-b\fP) option\&. The default suffix is a ~
-if no -\fB-backup-dir\fP was specified, otherwise it is an empty string\&.
+backup suffix used with the \fB\-\-backup\fP (\fB\-b\fP) option\&. The default suffix is a ~
+if no \-\fB\-backup-dir\fP was specified, otherwise it is an empty string\&.
 .IP 
-.IP "\fB-u, --update\fP" 
+.IP "\fB\-u, \-\-update\fP"
 This forces rsync to skip any files which exist on
 the destination and have a modified time that is newer than the source
 file\&.  (If an existing destination file has a modify time equal to the
 source file\&'s, it will be updated if the sizes are different\&.)
 .IP 
-In the current implementation of \fB--update\fP, a difference of file format
+In the current implementation of \fB\-\-update\fP, a difference of file format
 between the sender and receiver is always
 considered to be important enough for an update, no matter what date
 is on the objects\&.  In other words, if the source has a directory or a
 symlink where the destination has a file, the transfer would occur
 regardless of the timestamps\&.  This might change in the future (feel
 free to comment on this on the mailing list if you have an opinion)\&.
 .IP 
-.IP "\fB--inplace\fP" 
+.IP "\fB\-\-inplace\fP"
 This causes rsync not to create a new copy of the file
 and then move it into place\&.  Instead rsync will overwrite the existing
 file, meaning that the rsync algorithm can\&'t accomplish the full amount of
 network reduction it might be able to otherwise (since it does not yet try
 to sort data matches)\&.  One exception to this is if you combine the option
-with \fB--backup\fP, since rsync is smart enough to use the backup file as the
+with \fB\-\-backup\fP, since rsync is smart enough to use the backup file as the
 basis file for the transfer\&.
 .IP 
 This option is useful for transfer of large files with block-based changes
 or appended data, and also on systems that are disk bound, not network
 bound\&.
 .IP 
-The option implies \fB--partial\fP (since an interrupted transfer does not delete
-the file), but conflicts with \fB--partial-dir\fP and \fB--delay-updates\fP\&.
-Prior to rsync 2\&.6\&.4 \fB--inplace\fP was also incompatible with \fB--compare-dest\fP
-and \fB--link-dest\fP\&.
+The option implies \fB\-\-partial\fP (since an interrupted transfer does not delete
+the file), but conflicts with \fB\-\-partial\-dir\fP and \fB\-\-delay\-updates\fP\&.
+Prior to rsync 2\&.6\&.4 \fB\-\-inplace\fP was also incompatible with \fB\-\-compare\-dest\fP
+and \fB\-\-link\-dest\fP\&.
 .IP 
 WARNING: The file\&'s data will be in an inconsistent state during the
 transfer (and possibly afterward if the transfer gets interrupted), so you
 should not use this option to update files that are in use\&.  Also note that
 rsync will be unable to update a file in-place that is not writable by the
 receiving user\&.
 .IP 
-.IP "\fB--append\fP" 
+.IP "\fB\-\-append\fP"
 This causes rsync to update a file by appending data onto
 the end of the file, which presumes that the data that already exists on
 the receiving side is identical with the start of the file on the sending
 side\&.  If that is not true, the file will fail the checksum test, and the
-resend will do a normal \fB--inplace\fP update to correct the mismatched data\&.
+resend will do a normal \fB\-\-inplace\fP update to correct the mismatched data\&.
 Only files on the receiving side that are shorter than the corresponding
 file on the sending side (as well as new files) are sent\&.
-Implies \fB--inplace\fP, but does not conflict with \fB--sparse\fP (though the
-\fB--sparse\fP option will be auto-disabled if a resend of the already-existing
+Implies \fB\-\-inplace\fP, but does not conflict with \fB\-\-sparse\fP (though the
+\fB\-\-sparse\fP option will be auto-disabled if a resend of the already-existing
 data is required)\&.
 .IP 
-.IP "\fB-d, --dirs\fP" 
+.IP "\fB\-d, \-\-dirs\fP"
 Tell the sending side to include any directories that
-are encountered\&.  Unlike \fB--recursive\fP, a directory\&'s contents are not copied
+are encountered\&.  Unlike \fB\-\-recursive\fP, a directory\&'s contents are not copied
 unless the directory name specified is "\&." or ends with a trailing slash
 (e\&.g\&. "\&.", "dir/\&.", "dir/", etc\&.)\&.  Without this option or the
-\fB--recursive\fP option, rsync will skip all directories it encounters (and
+\fB\-\-recursive\fP option, rsync will skip all directories it encounters (and
 output a message to that effect for each one)\&.  If you specify both
-\fB--dirs\fP and \fB--recursive\fP, \fB--recursive\fP takes precedence\&.
+\fB\-\-dirs\fP and \fB\-\-recursive\fP, \fB\-\-recursive\fP takes precedence\&.
 .IP 
-.IP "\fB-l, --links\fP" 
+.IP "\fB\-l, \-\-links\fP"
 When symlinks are encountered, recreate the
 symlink on the destination\&.
 .IP 
-.IP "\fB-L, --copy-links\fP" 
+.IP "\fB\-L, \-\-copy\-links\fP"
 When symlinks are encountered, the item that
 they point to (the referent) is copied, rather than the symlink\&.  In older
 versions of rsync, this option also had the side-effect of telling the
 receiving side to follow symlinks, such as symlinks to directories\&.  In a
-modern rsync such as this one, you\&'ll need to specify \fB--keep-dirlinks\fP (\fB-K\fP)
+modern rsync such as this one, you\&'ll need to specify \fB\-\-keep\-dirlinks\fP (\fB\-K\fP)
 to get this extra behavior\&.  The only exception is when sending files to
-an rsync that is too old to understand \fB-K\fP -- in that case, the \fB-L\fP option
-will still have the side-effect of \fB-K\fP on that older receiving rsync\&.
+an rsync that is too old to understand \fB\-K\fP -- in that case, the \fB\-L\fP option
+will still have the side-effect of \fB\-K\fP on that older receiving rsync\&.
 .IP 
-.IP "\fB--copy-unsafe-links\fP" 
+.IP "\fB\-\-copy\-unsafe\-links\fP"
 This tells rsync to copy the referent of
 symbolic links that point outside the copied tree\&.  Absolute symlinks
 are also treated like ordinary files, and so are any symlinks in the
-source path itself when \fB--relative\fP is used\&.  This option has no
-additional effect if \fB--copy-links\fP was also specified\&.
+source path itself when \fB\-\-relative\fP is used\&.  This option has no
+additional effect if \fB\-\-copy\-links\fP was also specified\&.
 .IP 
-.IP "\fB--safe-links\fP" 
+.IP "\fB\-\-safe\-links\fP"
 This tells rsync to ignore any symbolic links
 which point outside the copied tree\&. All absolute symlinks are
-also ignored\&. Using this option in conjunction with \fB--relative\fP may
+also ignored\&. Using this option in conjunction with \fB\-\-relative\fP may
 give unexpected results\&.
 .IP 
-.IP "\fB-K, --copy-dirlinks\fP" 
+.IP "\fB\-K, \-\-copy\-dirlinks\fP"
 This option causes the sending side to treat
 a symlink to a directory as though it were a real directory\&.  This is
 useful if you don\&'t want symlinks to non-directories to be affected, as
-they would be using \fB--copy-links\fP\&.
+they would be using \fB\-\-copy\-links\fP\&.
 .IP 
 Without this option, if the sending side has replaced a directory with a
 symlink to a directory, the receiving side will delete anything that is in
 the way of the new symlink, including a directory hierarchy (as long as
-\fB--force\fP or \fB--delete\fP is in effect)\&.
+\fB\-\-force\fP or \fB\-\-delete\fP is in effect)\&.
 .IP 
-See also \fB--keep-dirlinks\fP for an analogous option for the receiving
+See also \fB\-\-keep\-dirlinks\fP for an analogous option for the receiving
 side\&.
 .IP 
-.IP "\fB-K, --keep-dirlinks\fP" 
+.IP "\fB\-K, \-\-keep\-dirlinks\fP"
 This option causes the receiving side to treat
 a symlink to a directory as though it were a real directory, but only if it
 matches a real directory from the sender\&.  Without this option, the
 receiver\&'s symlink would be deleted and replaced with a real directory\&.
 .IP 
 For example, suppose you transfer a directory "foo" that contains a file
 "file", but "foo" is a symlink to directory "bar" on the receiver\&.  Without
-\fB--keep-dirlinks\fP, the receiver deletes symlink "foo", recreates it as a
+\fB\-\-keep\-dirlinks\fP, the receiver deletes symlink "foo", recreates it as a
 directory, and receives the file into the new directory\&.  With
-\fB--keep-dirlinks\fP, the receiver keeps the symlink and "file" ends up in
+\fB\-\-keep\-dirlinks\fP, the receiver keeps the symlink and "file" ends up in
 "bar"\&.
 .IP 
-See also \fB--copy-dirlinks\fP for an analogous option for the sending side\&.
+See also \fB\-\-copy\-dirlinks\fP for an analogous option for the sending side\&.
 .IP 
-.IP "\fB-H, --hard-links\fP" 
+.IP "\fB\-H, \-\-hard\-links\fP"
 This tells rsync to look for hard-linked files in
 the transfer and link together the corresponding files on the receiving
 side\&.  Without this option, hard-linked files in the transfer are treated
 as though they were separate files\&.
 .IP 
 Note that rsync can only detect hard links if both parts of the link
 are in the list of files being sent\&.
 .IP 
-.IP "\fB-p, --perms\fP" 
+.IP "\fB\-p, \-\-perms\fP"
 This option causes the receiving rsync to set the
 destination permissions to be the same as the source permissions\&.  (See
-also the \fB--chmod\fP option for a way to modify what rsync considers to
+also the \fB\-\-chmod\fP option for a way to modify what rsync considers to
 be the source permissions\&.)
 .IP 
 When this option is \fIoff\fP, permissions are set as follows:
 .IP 
 .RS 
 .IP o 
 Existing files (including updated files) retain their existing
-permissions, though the \fB--executability\fP option might change just
+permissions, though the \fB\-\-executability\fP option might change just
 the execute permission for the file\&.
 .IP o 
 New files get their "normal" permission bits set to the source
 file\&'s permissions masked with the receiving end\&'s umask setting, and
 their special permission bits disabled except in the case where a new
 directory inherits a setgid bit from its parent directory\&.
-.RE 
+.RE
+
 .IP 
-Thus, when \fB--perms\fP and \fB--executability\fP are both disabled,
+Thus, when \fB\-\-perms\fP and \fB\-\-executability\fP are both disabled,
 rsync\&'s behavior is the same as that of other file-copy utilities,
 such as \fBcp\fP(1) and \fBtar\fP(1)\&.
 .IP 
 In summary: to give destination files (both old and new) the source
-permissions, use \fB--perms\fP\&.  To give new files the destination-default
+permissions, use \fB\-\-perms\fP\&.  To give new files the destination-default
 permissions (while leaving existing files unchanged), make sure that the
-\fB--perms\fP option is off and use \fB--chmod=ugo=rwX\fP (which ensures that
+\fB\-\-perms\fP option is off and use \fB\-\-chmod=ugo=rwX\fP (which ensures that
 all non-masked bits get enabled)\&.  If you\&'d care to make this latter
 behavior easier to type, you could define a popt alias for it, such as
-putting this line in the file ~/\&.popt (this defines the \fB-s\fP option,
-and includes --no-g to use the default group of the destination dir):
+putting this line in the file ~/\&.popt (this defines the \fB\-s\fP option,
+and includes \-\-no\-g to use the default group of the destination dir):
 .IP 
 .RS 
-\f(CW   rsync alias -s --no-p --no-g --chmod=ugo=rwX\fP
-.RE 
+\f(CW   rsync alias \-s \-\-no\-p \-\-no\-g \-\-chmod=ugo=rwX\fP
+.RE
+
 .IP 
 You could then use this new option in a command such as this one:
 .IP 
 .RS 
-\f(CW   rsync -asv src/ dest/\fP
-.RE 
+\f(CW   rsync \-asv src/ dest/\fP
+.RE
+
 .IP 
-(Caveat: make sure that \fB-a\fP does not follow \fB-s\fP, or it will re-enable
-the "--no-*" options\&.)
+(Caveat: make sure that \fB\-a\fP does not follow \fB\-s\fP, or it will re-enable
+the "\-\-no\-*" options\&.)
 .IP 
 The preservation of the destination\&'s setgid bit on newly-created
-directories when \fB--perms\fP is off was added in rsync 2\&.6\&.7\&.  Older rsync
+directories when \fB\-\-perms\fP is off was added in rsync 2\&.6\&.7\&.  Older rsync
 versions erroneously preserved the three special permission bits for
-newly-created files when \fB--perms\fP was off, while overriding the
+newly-created files when \fB\-\-perms\fP was off, while overriding the
 destination\&'s setgid bit setting on a newly-created directory\&.  (Keep in
 mind that it is the version of the receiving rsync that affects this
 behavior\&.)
 .IP 
-.IP "\fB-E, --executability\fP" 
+.IP "\fB\-E, \-\-executability\fP"
 This option causes rsync to preserve the
-executability (or non-executability) of regular files when \fB--perms\fP is
+executability (or non-executability) of regular files when \fB\-\-perms\fP is
 not enabled\&.  A regular file is considered to be executable if at least one
 \&'x\&' is turned on in its permissions\&.  When an existing destination file\&'s
 executability differs from that of the corresponding source file, rsync
 modifies the destination file\&'s permissions as follows:
 .IP 
 .RS 
 .IP o 
 To make a file non-executable, rsync turns off all its \&'x\&'
 permissions\&.
 .IP o 
 To make a file executable, rsync turns on each \&'x\&' permission that
 has a corresponding \&'r\&' permission enabled\&.
-.RE 
+.RE
+
 .IP 
-If \fB--perms\fP is enabled, this option is ignored\&.
+If \fB\-\-perms\fP is enabled, this option is ignored\&.
 .IP 
-.IP "\fB--chmod\fP" 
+.IP "\fB\-\-chmod\fP"
 This option tells rsync to apply one or more
 comma-separated "chmod" strings to the permission of the files in the
 transfer\&.  The resulting value is treated as though it was the permissions
 that the sending side supplied for the file, which means that this option
-can seem to have no effect on existing files if \fB--perms\fP is not enabled\&.
+can seem to have no effect on existing files if \fB\-\-perms\fP is not enabled\&.
 .IP 
 In addition to the normal parsing rules specified in the \fBchmod\fP(1)
 manpage, you can specify an item that should only apply to a directory by
 prefixing it with a \&'D\&', or specify an item that should only apply to a
 file by prefixing it with a \&'F\&'\&.  For example:
 .IP 
 .RS 
---chmod=Dg+s,ug+w,Fo-w,+X
-.RE 
+\-\-chmod=Dg+s,ug+w,Fo-w,+X
+.RE
+
 .IP 
-It is also legal to specify multiple \fB--chmod\fP options, as each
+It is also legal to specify multiple \fB\-\-chmod\fP options, as each
 additional option is just appended to the list of changes to make\&.
 .IP 
-See the \fB--perms\fP and \fB--executability\fP options for how the resulting
+See the \fB\-\-perms\fP and \fB\-\-executability\fP options for how the resulting
 permission value can be applied to the files in the transfer\&.
 .IP 
-.IP "\fB-o, --owner\fP" 
+.IP "\fB\-o, \-\-owner\fP"
 This option causes rsync to set the owner of the
 destination file to be the same as the source file, but only if the
-receiving rsync is being run as the super-user (see also the \fB--super\fP
+receiving rsync is being run as the super-user (see also the \fB\-\-super\fP
 option to force rsync to attempt super-user activities)\&.
 Without this option, the owner is set to the invoking user on the
 receiving side\&.
 .IP 
 The preservation of ownership will associate matching names by default, but
 may fall back to using the ID number in some circumstances (see also the
-\fB--numeric-ids\fP option for a full discussion)\&.
+\fB\-\-numeric\-ids\fP option for a full discussion)\&.
 .IP 
-.IP "\fB-g, --group\fP" 
+.IP "\fB\-g, \-\-group\fP"
 This option causes rsync to set the group of the
 destination file to be the same as the source file\&.  If the receiving
-program is not running as the super-user (or if \fB--no-super\fP was
+program is not running as the super-user (or if \fB\-\-no\-super\fP was
 specified), only groups that the invoking user on the receiving side
 is a member of will be preserved\&.
 Without this option, the group is set to the default group of the invoking
 user on the receiving side\&.
 .IP 
 The preservation of group information will associate matching names by
 default, but may fall back to using the ID number in some circumstances
-(see also the \fB--numeric-ids\fP option for a full discussion)\&.
+(see also the \fB\-\-numeric\-ids\fP option for a full discussion)\&.
 .IP 
-.IP "\fB--devices\fP" 
+.IP "\fB\-\-devices\fP"
 This option causes rsync to transfer character and
 block device files to the remote system to recreate these devices\&.
 This option has no effect if the receiving rsync is not run as the
-super-user and \fB--super\fP is not specified\&.
+super-user and \fB\-\-super\fP is not specified\&.
 .IP 
-.IP "\fB--specials\fP" 
+.IP "\fB\-\-specials\fP"
 This option causes rsync to transfer special files
 such as named sockets and fifos\&.
 .IP 
-.IP "\fB-D\fP" 
-The \fB-D\fP option is equivalent to \fB--devices\fP \fB--specials\fP\&.
+.IP "\fB\-D\fP"
+The \fB\-D\fP option is equivalent to \fB\-\-devices\fP \fB\-\-specials\fP\&.
 .IP 
-.IP "\fB-t, --times\fP" 
+.IP "\fB\-t, \-\-times\fP"
 This tells rsync to transfer modification times along
 with the files and update them on the remote system\&.  Note that if this
 option is not used, the optimization that excludes files that have not been
-modified cannot be effective; in other words, a missing \fB-t\fP or \fB-a\fP will
-cause the next transfer to behave as if it used \fB-I\fP, causing all files to be
+modified cannot be effective; in other words, a missing \fB\-t\fP or \fB\-a\fP will
+cause the next transfer to behave as if it used \fB\-I\fP, causing all files to be
 updated (though the rsync algorithm will make the update fairly efficient
-if the files haven\&'t actually changed, you\&'re much better off using \fB-t\fP)\&.
+if the files haven\&'t actually changed, you\&'re much better off using \fB\-t\fP)\&.
 .IP 
-.IP "\fB-O, --omit-dir-times\fP" 
+.IP "\fB\-O, \-\-omit\-dir\-times\fP"
 This tells rsync to omit directories when
-it is preserving modification times (see \fB--times\fP)\&.  If NFS is sharing
-the directories on the receiving side, it is a good idea to use \fB-O\fP\&.
-This option is inferred if you use \fB--backup\fP without \fB--backup-dir\fP\&.
+it is preserving modification times (see \fB\-\-times\fP)\&.  If NFS is sharing
+the directories on the receiving side, it is a good idea to use \fB\-O\fP\&.
+This option is inferred if you use \fB\-\-backup\fP without \fB\-\-backup\-dir\fP\&.
 .IP 
-.IP "\fB--super\fP" 
+.IP "\fB\-\-super\fP"
 This tells the receiving side to attempt super-user
 activities even if the receiving rsync wasn\&'t run by the super-user\&.  These
-activities include: preserving users via the \fB--owner\fP option, preserving
-all groups (not just the current user\&'s groups) via the \fB--groups\fP
-option, and copying devices via the \fB--devices\fP option\&.  This is useful
+activities include: preserving users via the \fB\-\-owner\fP option, preserving
+all groups (not just the current user\&'s groups) via the \fB\-\-groups\fP
+option, and copying devices via the \fB\-\-devices\fP option\&.  This is useful
 for systems that allow such activities without being the super-user, and
 also for ensuring that you will get errors if the receiving side isn\&'t
 being running as the super-user\&.  To turn off super-user activities, the
-super-user can use \fB--no-super\fP\&.
+super-user can use \fB\-\-no\-super\fP\&.
 .IP 
-.IP "\fB-S, --sparse\fP" 
+.IP "\fB\-S, \-\-sparse\fP"
 Try to handle sparse files efficiently so they take
-up less space on the destination\&.  Conflicts with \fB--inplace\fP because it\&'s
+up less space on the destination\&.  Conflicts with \fB\-\-inplace\fP because it\&'s
 not possible to overwrite data in a sparse fashion\&.
 .IP 
 NOTE: Don\&'t use this option when the destination is a Solaris "tmpfs"
 filesystem\&. It doesn\&'t seem to handle seeks over null regions
 correctly and ends up corrupting the files\&.
 .IP 
-.IP "\fB-n, --dry-run\fP" 
+.IP "\fB\-n, \-\-dry\-run\fP"
 This tells rsync to not do any file transfers,
 instead it will just report the actions it would have taken\&.
 .IP 
-.IP "\fB-W, --whole-file\fP" 
+.IP "\fB\-W, \-\-whole\-file\fP"
 With this option the incremental rsync algorithm
 is not used and the whole file is sent as-is instead\&.  The transfer may be
 faster if this option is used when the bandwidth between the source and
 destination machines is higher than the bandwidth to disk (especially when the
 "disk" is actually a networked filesystem)\&.  This is the default when both
 the source and destination are specified as local paths\&.
 .IP 
-.IP "\fB-x, --one-file-system\fP" 
+.IP "\fB\-x, \-\-one\-file\-system\fP"
 This tells rsync to avoid crossing a
 filesystem boundary when recursing\&.  This does not limit the user\&'s ability
 to specify items to copy from multiple filesystems, just rsync\&'s recursion
 through the hierarchy of each directory that the user specified, and also
 the analogous recursion on the receiving side during deletion\&.  Also keep
 in mind that rsync treats a "bind" mount to the same device as being on the
@@ -1021,148 +1051,149 @@
 .IP 
 If this option is repeated, rsync omits all mount-point directories from
 the copy\&.  Otherwise, it includes an empty directory at each mount-point it
 encounters (using the attributes of the mounted directory because those of
 the underlying mount-point directory are inaccessible)\&.
 .IP 
-If rsync has been told to collapse symlinks (via \fB--copy-links\fP or
-\fB--copy-unsafe-links\fP), a symlink to a directory on another device is
+If rsync has been told to collapse symlinks (via \fB\-\-copy\-links\fP or
+\fB\-\-copy\-unsafe\-links\fP), a symlink to a directory on another device is
 treated like a mount-point\&.  Symlinks to non-directories are unaffected
 by this option\&.
 .IP 
-.IP "\fB--existing, --ignore-non-existing\fP" 
+.IP "\fB\-\-existing, \-\-ignore\-non\-existing\fP"
 This tells rsync to skip
-updating files that do not exist yet on the destination\&.  If this option is
-combined with the \fB--ignore-existing\fP option, no files will be updated
-(which can be useful if all you want to do is to delete missing files)\&.
+creating files (including directories) that do not exist
+yet on the destination\&.  If this option is
+combined with the \fB\-\-ignore\-existing\fP option, no files will be updated
+(which can be useful if all you want to do is to delete extraneous files)\&.
 .IP 
-.IP "\fB--ignore-existing\fP" 
+.IP "\fB\-\-ignore\-existing\fP"
 This tells rsync to skip updating files that
-already exist on the destination\&.  See also \fB--ignore-non-existing\fP\&.
+already exist on the destination (this does \fInot\fP ignore existing
+directores, or nothing would get done)\&.  See also \fB\-\-existing\fP\&.
 .IP 
-.IP "\fB--remove-sent-files\fP" 
+.IP "\fB\-\-remove\-source\-files\fP"
 This tells rsync to remove from the sending
-side the files and/or symlinks that are newly created or whose content is
-updated on the receiving side\&.  Directories and devices are not removed,
-nor are files/symlinks whose attributes are merely changed\&.
+side the files (meaning non-directories) that are a part of the transfer
+and have been successfully duplicated on the receiving side\&.
 .IP 
-.IP "\fB--delete\fP" 
+.IP "\fB\-\-delete\fP"
 This tells rsync to delete extraneous files from the
 receiving side (ones that aren\&'t on the sending side), but only for the
 directories that are being synchronized\&.  You must have asked rsync to
 send the whole directory (e\&.g\&. "dir" or "dir/") without using a wildcard
 for the directory\&'s contents (e\&.g\&. "dir/*") since the wildcard is expanded
 by the shell and rsync thus gets a request to transfer individual files, not
 the files\&' parent directory\&.  Files that are excluded from transfer are
-also excluded from being deleted unless you use the \fB--delete-excluded\fP
+also excluded from being deleted unless you use the \fB\-\-delete\-excluded\fP
 option or mark the rules as only matching on the sending side (see the
 include/exclude modifiers in the FILTER RULES section)\&.
 .IP 
-Prior to rsync 2\&.6\&.7, this option would have no effect unless \fB--recursive\fP
-was in effect\&.  Beginning with 2\&.6\&.7, deletions will also occur when \fB--dirs\fP
-(\fB-d\fP) is in effect, but only for directories whose contents are being copied\&.
+Prior to rsync 2\&.6\&.7, this option would have no effect unless \fB\-\-recursive\fP
+was in effect\&.  Beginning with 2\&.6\&.7, deletions will also occur when \fB\-\-dirs\fP
+(\fB\-d\fP) is in effect, but only for directories whose contents are being copied\&.
 .IP 
 This option can be dangerous if used incorrectly!  It is a very good idea
-to run first using the \fB--dry-run\fP option (\fB-n\fP) to see what files would be
+to run first using the \fB\-\-dry\-run\fP option (\fB\-n\fP) to see what files would be
 deleted to make sure important files aren\&'t listed\&.
 .IP 
 If the sending side detects any I/O errors, then the deletion of any
 files at the destination will be automatically disabled\&. This is to
 prevent temporary filesystem failures (such as NFS errors) on the
 sending side causing a massive deletion of files on the
-destination\&.  You can override this with the \fB--ignore-errors\fP option\&.
+destination\&.  You can override this with the \fB\-\-ignore\-errors\fP option\&.
 .IP 
-The \fB--delete\fP option may be combined with one of the --delete-WHEN options
-without conflict, as well as \fB--delete-excluded\fP\&.  However, if none of the
---delete-WHEN options are specified, rsync will currently choose the
-\fB--delete-before\fP algorithm\&.  A future version may change this to choose the
-\fB--delete-during\fP algorithm\&.  See also \fB--delete-after\fP\&.
+The \fB\-\-delete\fP option may be combined with one of the \-\-delete\-WHEN options
+without conflict, as well as \fB\-\-delete\-excluded\fP\&.  However, if none of the
+\-\-delete\-WHEN options are specified, rsync will currently choose the
+\fB\-\-delete\-before\fP algorithm\&.  A future version may change this to choose the
+\fB\-\-delete\-during\fP algorithm\&.  See also \fB\-\-delete\-after\fP\&.
 .IP 
-.IP "\fB--delete-before\fP" 
+.IP "\fB\-\-delete\-before\fP"
 Request that the file-deletions on the receiving
-side be done before the transfer starts\&.  This is the default if \fB--delete\fP
-or \fB--delete-excluded\fP is specified without one of the --delete-WHEN options\&.
-See \fB--delete\fP (which is implied) for more details on file-deletion\&.
+side be done before the transfer starts\&.  This is the default if \fB\-\-delete\fP
+or \fB\-\-delete\-excluded\fP is specified without one of the \-\-delete\-WHEN options\&.
+See \fB\-\-delete\fP (which is implied) for more details on file-deletion\&.
 .IP 
 Deleting before the transfer is helpful if the filesystem is tight for space
 and removing extraneous files would help to make the transfer possible\&.
 However, it does introduce a delay before the start of the transfer,
-and this delay might cause the transfer to timeout (if \fB--timeout\fP was
+and this delay might cause the transfer to timeout (if \fB\-\-timeout\fP was
 specified)\&.
 .IP 
-.IP "\fB--delete-during, --del\fP" 
+.IP "\fB\-\-delete\-during, \-\-del\fP"
 Request that the file-deletions on the
 receiving side be done incrementally as the transfer happens\&.  This is
 a faster method than choosing the before- or after-transfer algorithm,
 but it is only supported beginning with rsync version 2\&.6\&.4\&.
-See \fB--delete\fP (which is implied) for more details on file-deletion\&.
+See \fB\-\-delete\fP (which is implied) for more details on file-deletion\&.
 .IP 
-.IP "\fB--delete-after\fP" 
+.IP "\fB\-\-delete\-after\fP"
 Request that the file-deletions on the receiving
 side be done after the transfer has completed\&.  This is useful if you
 are sending new per-directory merge files as a part of the transfer and
 you want their exclusions to take effect for the delete phase of the
 current transfer\&.
-See \fB--delete\fP (which is implied) for more details on file-deletion\&.
+See \fB\-\-delete\fP (which is implied) for more details on file-deletion\&.
 .IP 
-.IP "\fB--delete-excluded\fP" 
+.IP "\fB\-\-delete\-excluded\fP"
 In addition to deleting the files on the
 receiving side that are not on the sending side, this tells rsync to also
-delete any files on the receiving side that are excluded (see \fB--exclude\fP)\&.
+delete any files on the receiving side that are excluded (see \fB\-\-exclude\fP)\&.
 See the FILTER RULES section for a way to make individual exclusions behave
 this way on the receiver, and for a way to protect files from
-\fB--delete-excluded\fP\&.
-See \fB--delete\fP (which is implied) for more details on file-deletion\&.
+\fB\-\-delete\-excluded\fP\&.
+See \fB\-\-delete\fP (which is implied) for more details on file-deletion\&.
 .IP 
-.IP "\fB--ignore-errors\fP" 
-Tells \fB--delete\fP to go ahead and delete files
+.IP "\fB\-\-ignore\-errors\fP"
+Tells \fB\-\-delete\fP to go ahead and delete files
 even when there are I/O errors\&.
 .IP 
-.IP "\fB--force\fP" 
+.IP "\fB\-\-force\fP"
 This option tells rsync to delete a non-empty directory
 when it is to be replaced by a non-directory\&.  This is only relevant if
-deletions are not active (see \fB--delete\fP for details)\&.
+deletions are not active (see \fB\-\-delete\fP for details)\&.
 .IP 
-Note for older rsync versions: \fB--force\fP used to still be required when
-using \fB--delete-after\fP, and it used to be non-functional unless the
-\fB--recursive\fP option was also enabled\&.
+Note for older rsync versions: \fB\-\-force\fP used to still be required when
+using \fB\-\-delete\-after\fP, and it used to be non-functional unless the
+\fB\-\-recursive\fP option was also enabled\&.
 .IP 
-.IP "\fB--max-delete=NUM\fP" 
+.IP "\fB\-\-max\-delete=NUM\fP"
 This tells rsync not to delete more than NUM
 files or directories (NUM must be non-zero)\&.
 This is useful when mirroring very large trees to prevent disasters\&.
 .IP 
-.IP "\fB--max-size=SIZE\fP" 
+.IP "\fB\-\-max\-size=SIZE\fP"
 This tells rsync to avoid transferring any
 file that is larger than the specified SIZE\&. The SIZE value can be
 suffixed with a string to indicate a size multiplier, and
-may be a fractional value (e\&.g\&. "\fB--max-size=1\&.5m\fP")\&.
+may be a fractional value (e\&.g\&. "\fB\-\-max\-size=1\&.5m\fP")\&.
 .IP 
 The suffixes are as follows: "K" (or "KiB") is a kibibyte (1024),
 "M" (or "MiB") is a mebibyte (1024*1024), and "G" (or "GiB") is a
 gibibyte (1024*1024*1024)\&.
 If you want the multiplier to be 1000 instead of 1024, use "KB",
 "MB", or "GB"\&.  (Note: lower-case is also accepted for all values\&.)
-Finally, if the suffix ends in either "+1" or "-1", the value will
+Finally, if the suffix ends in either "+1" or "\-1", the value will
 be offset by one byte in the indicated direction\&.
 .IP 
-Examples: --max-size=1\&.5mb-1 is 1499999 bytes, and --max-size=2g+1 is
+Examples: \-\-max\-size=1\&.5mb\-1 is 1499999 bytes, and \-\-max\-size=2g+1 is
 2147483649 bytes\&.
 .IP 
-.IP "\fB--min-size=SIZE\fP" 
+.IP "\fB\-\-min\-size=SIZE\fP"
 This tells rsync to avoid transferring any
 file that is smaller than the specified SIZE, which can help in not
 transferring small, junk files\&.
-See the \fB--max-size\fP option for a description of SIZE\&.
+See the \fB\-\-max\-size\fP option for a description of SIZE\&.
 .IP 
-.IP "\fB-B, --block-size=BLOCKSIZE\fP" 
+.IP "\fB\-B, \-\-block\-size=BLOCKSIZE\fP"
 This forces the block size used in
 the rsync algorithm to a fixed value\&.  It is normally selected based on
 the size of each file being updated\&.  See the technical report for details\&.
 .IP 
-.IP "\fB-e, --rsh=COMMAND\fP" 
+.IP "\fB\-e, \-\-rsh=COMMAND\fP"
 This option allows you to choose an alternative
 remote shell program to use for communication between the local and
 remote copies of rsync\&. Typically, rsync is configured to use ssh by
 default, but you may prefer to use rsh on a local network\&.
 .IP 
 If this option is used with \fB[user@]host::module/path\fP, then the
@@ -1179,206 +1210,214 @@
 argument (but not backslashes)\&.  Note that doubling a single-quote
 inside a single-quoted string gives you a single-quote; likewise for
 double-quotes (though you need to pay attention to which quotes your
 shell is parsing and which quotes rsync is parsing)\&.  Some examples:
 .IP 
 .RS 
-\f(CW    -e \&'ssh -p 2234\&'\fP
+\f(CW    \-e \&'ssh \-p 2234\&'\fP
 .br 
-\f(CW    -e \&'ssh -o "ProxyCommand nohup ssh firewall nc -w1 %h %p"\&'\fP
+\f(CW    \-e \&'ssh \-o "ProxyCommand nohup ssh firewall nc \-w1 %h %p"\&'\fP
 .br 
-.RE 
+.RE
+
 .IP 
 (Note that ssh users can alternately customize site-specific connect
 options in their \&.ssh/config file\&.)
 .IP 
 You can also choose the remote shell program using the RSYNC_RSH
-environment variable, which accepts the same range of values as \fB-e\fP\&.
+environment variable, which accepts the same range of values as \fB\-e\fP\&.
 .IP 
-See also the \fB--blocking-io\fP option which is affected by this option\&.
+See also the \fB\-\-blocking\-io\fP option which is affected by this option\&.
 .IP 
-.IP "\fB--rsync-path=PROGRAM\fP" 
+.IP "\fB\-\-rsync\-path=PROGRAM\fP"
 Use this to specify what program is to be run
 on the remote machine to start-up rsync\&.  Often used when rsync is not in
-the default remote-shell\&'s path (e\&.g\&. --rsync-path=/usr/local/bin/rsync)\&.
+the default remote-shell\&'s path (e\&.g\&. \-\-rsync\-path=/usr/local/bin/rsync)\&.
 Note that PROGRAM is run with the help of a shell, so it can be any
 program, script, or command sequence you\&'d care to run, so long as it does
 not corrupt the standard-in & standard-out that rsync is using to
 communicate\&.
 .IP 
 One tricky example is to set a different default directory on the remote
-machine for use with the \fB--relative\fP option\&.  For instance:
+machine for use with the \fB\-\-relative\fP option\&.  For instance:
 .IP 
 .RS 
-\f(CW    rsync -avR --rsync-path="cd /a/b && rsync" hst:c/d /e/\fP
-.RE 
+\f(CW    rsync \-avR \-\-rsync\-path="cd /a/b && rsync" hst:c/d /e/\fP
+.RE
+
 .IP 
-.IP "\fB-C, --cvs-exclude\fP" 
+.IP "\fB\-C, \-\-cvs\-exclude\fP"
 This is a useful shorthand for excluding a
 broad range of files that you often don\&'t want to transfer between
 systems\&. It uses the same algorithm that CVS uses to determine if
 a file should be ignored\&.
 .IP 
 The exclude list is initialized to:
 .IP 
 .RS 
 .RS 
 \f(CWRCS SCCS CVS CVS\&.adm RCSLOG cvslog\&.* tags TAGS \&.make\&.state
 \&.nse_depinfo *~ #* \&.#* ,* _$* *$ *\&.old *\&.bak *\&.BAK *\&.orig *\&.rej
-\&.del-* *\&.a *\&.olb *\&.o *\&.obj *\&.so *\&.exe *\&.Z *\&.elc *\&.ln core \&.svn/\fP
-.RE 
-.RE 
+\&.del\-* *\&.a *\&.olb *\&.o *\&.obj *\&.so *\&.exe *\&.Z *\&.elc *\&.ln core \&.svn/\fP
+.RE
+.RE
+
 .IP 
 then files listed in a $HOME/\&.cvsignore are added to the list and any
 files listed in the CVSIGNORE environment variable (all cvsignore names
 are delimited by whitespace)\&.
 .IP 
 Finally, any file is ignored if it is in the same directory as a
 \&.cvsignore file and matches one of the patterns listed therein\&.  Unlike
 rsync\&'s filter/exclude files, these patterns are split on whitespace\&.
 See the \fBcvs\fP(1) manual for more information\&.
 .IP 
-If you\&'re combining \fB-C\fP with your own \fB--filter\fP rules, you should
+If you\&'re combining \fB\-C\fP with your own \fB\-\-filter\fP rules, you should
 note that these CVS excludes are appended at the end of your own rules,
-regardless of where the \fB-C\fP was placed on the command-line\&.  This makes them
+regardless of where the \fB\-C\fP was placed on the command-line\&.  This makes them
 a lower priority than any rules you specified explicitly\&.  If you want to
 control where these CVS excludes get inserted into your filter rules, you
-should omit the \fB-C\fP as a command-line option and use a combination of
-\fB--filter=:C\fP and \fB--filter=-C\fP (either on your command-line or by
-putting the ":C" and "-C" rules into a filter file with your other rules)\&.
+should omit the \fB\-C\fP as a command-line option and use a combination of
+\fB\-\-filter=:C\fP and \fB\-\-filter=\-C\fP (either on your command-line or by
+putting the ":C" and "\-C" rules into a filter file with your other rules)\&.
 The first option turns on the per-directory scanning for the \&.cvsignore
 file\&.  The second option does a one-time import of the CVS excludes
 mentioned above\&.
 .IP 
-.IP "\fB-f, --filter=RULE\fP" 
+.IP "\fB\-f, \-\-filter=RULE\fP"
 This option allows you to add rules to selectively
 exclude certain files from the list of files to be transferred\&. This is
 most useful in combination with a recursive transfer\&.
 .IP 
-You may use as many \fB--filter\fP options on the command line as you like
+You may use as many \fB\-\-filter\fP options on the command line as you like
 to build up the list of files to exclude\&.
 .IP 
 See the FILTER RULES section for detailed information on this option\&.
 .IP 
-.IP "\fB-F\fP" 
-The \fB-F\fP option is a shorthand for adding two \fB--filter\fP rules to
+.IP "\fB\-F\fP"
+The \fB\-F\fP option is a shorthand for adding two \fB\-\-filter\fP rules to
 your command\&.  The first time it is used is a shorthand for this rule:
 .IP 
 .RS 
-\f(CW   --filter=\&'dir-merge /\&.rsync-filter\&'\fP
-.RE 
+\f(CW   \-\-filter=\&'dir\-merge /\&.rsync\-filter\&'\fP
+.RE
+
 .IP 
-This tells rsync to look for per-directory \&.rsync-filter files that have
+This tells rsync to look for per-directory \&.rsync\-filter files that have
 been sprinkled through the hierarchy and use their rules to filter the
-files in the transfer\&.  If \fB-F\fP is repeated, it is a shorthand for this
+files in the transfer\&.  If \fB\-F\fP is repeated, it is a shorthand for this
 rule:
 .IP 
 .RS 
-\f(CW   --filter=\&'exclude \&.rsync-filter\&'\fP
-.RE 
+\f(CW   \-\-filter=\&'exclude \&.rsync\-filter\&'\fP
+.RE
+
 .IP 
-This filters out the \&.rsync-filter files themselves from the transfer\&.
+This filters out the \&.rsync\-filter files themselves from the transfer\&.
 .IP 
 See the FILTER RULES section for detailed information on how these options
 work\&.
 .IP 
-.IP "\fB--exclude=PATTERN\fP" 
+.IP "\fB\-\-exclude=PATTERN\fP"
 This option is a simplified form of the
-\fB--filter\fP option that defaults to an exclude rule and does not allow
+\fB\-\-filter\fP option that defaults to an exclude rule and does not allow
 the full rule-parsing syntax of normal filter rules\&.
 .IP 
 See the FILTER RULES section for detailed information on this option\&.
 .IP 
-.IP "\fB--exclude-from=FILE\fP" 
-This option is related to the \fB--exclude\fP
+.IP "\fB\-\-exclude\-from=FILE\fP"
+This option is related to the \fB\-\-exclude\fP
 option, but it specifies a FILE that contains exclude patterns (one per line)\&.
 Blank lines in the file and lines starting with \&';\&' or \&'#\&' are ignored\&.
-If \fIFILE\fP is \fB-\fP, the list will be read from standard input\&.
+If \fIFILE\fP is \fB\-\fP, the list will be read from standard input\&.
 .IP 
-.IP "\fB--include=PATTERN\fP" 
+.IP "\fB\-\-include=PATTERN\fP"
 This option is a simplified form of the
-\fB--filter\fP option that defaults to an include rule and does not allow
+\fB\-\-filter\fP option that defaults to an include rule and does not allow
 the full rule-parsing syntax of normal filter rules\&.
 .IP 
 See the FILTER RULES section for detailed information on this option\&.
 .IP 
-.IP "\fB--include-from=FILE\fP" 
-This option is related to the \fB--include\fP
+.IP "\fB\-\-include\-from=FILE\fP"
+This option is related to the \fB\-\-include\fP
 option, but it specifies a FILE that contains include patterns (one per line)\&.
 Blank lines in the file and lines starting with \&';\&' or \&'#\&' are ignored\&.
-If \fIFILE\fP is \fB-\fP, the list will be read from standard input\&.
+If \fIFILE\fP is \fB\-\fP, the list will be read from standard input\&.
 .IP 
-.IP "\fB--files-from=FILE\fP" 
+.IP "\fB\-\-files\-from=FILE\fP"
 Using this option allows you to specify the
-exact list of files to transfer (as read from the specified FILE or \fB-\fP
+exact list of files to transfer (as read from the specified FILE or \fB\-\fP
 for standard input)\&.  It also tweaks the default behavior of rsync to make
 transferring just the specified files and directories easier:
 .IP 
 .RS 
 .IP o 
-The \fB--relative\fP (\fB-R\fP) option is implied, which preserves the path
+The \fB\-\-relative\fP (\fB\-R\fP) option is implied, which preserves the path
 information that is specified for each item in the file (use
-\fB--no-relative\fP or \fB--no-R\fP if you want to turn that off)\&.
+\fB\-\-no\-relative\fP or \fB\-\-no\-R\fP if you want to turn that off)\&.
 .IP o 
-The \fB--dirs\fP (\fB-d\fP) option is implied, which will create directories
+The \fB\-\-dirs\fP (\fB\-d\fP) option is implied, which will create directories
 specified in the list on the destination rather than noisily skipping
-them (use \fB--no-dirs\fP or \fB--no-d\fP if you want to turn that off)\&.
+them (use \fB\-\-no\-dirs\fP or \fB\-\-no\-d\fP if you want to turn that off)\&.
 .IP o 
-The \fB--archive\fP (\fB-a\fP) option\&'s behavior does not imply \fB--recursive\fP
-(\fB-r\fP), so specify it explicitly, if you want it\&.
+The \fB\-\-archive\fP (\fB\-a\fP) option\&'s behavior does not imply \fB\-\-recursive\fP
+(\fB\-r\fP), so specify it explicitly, if you want it\&.
 .IP o 
 These side-effects change the default state of rsync, so the position
-of the \fB--files-from\fP option on the command-line has no bearing on how
-other options are parsed (e\&.g\&. \fB-a\fP works the same before or after
-\fB--files-from\fP, as does \fB--no-R\fP and all other options)\&.
-.RE 
+of the \fB\-\-files\-from\fP option on the command-line has no bearing on how
+other options are parsed (e\&.g\&. \fB\-a\fP works the same before or after
+\fB\-\-files\-from\fP, as does \fB\-\-no\-R\fP and all other options)\&.
+.RE
+
 .IP 
 The file names that are read from the FILE are all relative to the
 source dir -- any leading slashes are removed and no "\&.\&." references are
 allowed to go higher than the source dir\&.  For example, take this
 command:
 .IP 
 .RS 
-\f(CW   rsync -a --files-from=/tmp/foo /usr remote:/backup\fP
-.RE 
+\f(CW   rsync \-a \-\-files\-from=/tmp/foo /usr remote:/backup\fP
+.RE
+
 .IP 
 If /tmp/foo contains the string "bin" (or even "/bin"), the /usr/bin
 directory will be created as /backup/bin on the remote host\&.  If it
 contains "bin/" (note the trailing slash), the immediate contents of
 the directory would also be sent (without needing to be explicitly
 mentioned in the file -- this began in version 2\&.6\&.4)\&.  In both cases,
-if the \fB-r\fP option was enabled, that dir\&'s entire hierarchy would
-also be transferred (keep in mind that \fB-r\fP needs to be specified
-explicitly with \fB--files-from\fP, since it is not implied by \fB-a\fP)\&.
+if the \fB\-r\fP option was enabled, that dir\&'s entire hierarchy would
+also be transferred (keep in mind that \fB\-r\fP needs to be specified
+explicitly with \fB\-\-files\-from\fP, since it is not implied by \fB\-a\fP)\&.
 Also note
-that the effect of the (enabled by default) \fB--relative\fP option is to
+that the effect of the (enabled by default) \fB\-\-relative\fP option is to
 duplicate only the path info that is read from the file -- it does not
 force the duplication of the source-spec path (/usr in this case)\&.
 .IP 
-In addition, the \fB--files-from\fP file can be read from the remote host
+In addition, the \fB\-\-files\-from\fP file can be read from the remote host
 instead of the local host if you specify a "host:" in front of the file
 (the host must match one end of the transfer)\&.  As a short-cut, you can
 specify just a prefix of ":" to mean "use the remote end of the
 transfer"\&.  For example:
 .IP 
 .RS 
-\f(CW   rsync -a --files-from=:/path/file-list src:/ /tmp/copy\fP
-.RE 
+\f(CW   rsync \-a \-\-files\-from=:/path/file\-list src:/ /tmp/copy\fP
+.RE
+
 .IP 
 This would copy all the files specified in the /path/file-list file that
 was located on the remote "src" host\&.
 .IP 
-.IP "\fB-0, --from0\fP" 
+.IP "\fB\-0, \-\-from0\fP"
 This tells rsync that the rules/filenames it reads from a
 file are terminated by a null (\&'\e0\&') character, not a NL, CR, or CR+LF\&.
-This affects \fB--exclude-from\fP, \fB--include-from\fP, \fB--files-from\fP, and any
-merged files specified in a \fB--filter\fP rule\&.
-It does not affect \fB--cvs-exclude\fP (since all names read from a \&.cvsignore
+This affects \fB\-\-exclude\-from\fP, \fB\-\-include\-from\fP, \fB\-\-files\-from\fP, and any
+merged files specified in a \fB\-\-filter\fP rule\&.
+It does not affect \fB\-\-cvs\-exclude\fP (since all names read from a \&.cvsignore
 file are split on whitespace)\&.
 .IP 
-.IP "\fB-T, --temp-dir=DIR\fP" 
+.IP "\fB\-T, \-\-temp\-dir=DIR\fP"
 This option instructs rsync to use DIR as a
 scratch directory when creating temporary copies of the files transferred
 on the receiving side\&.  The default behavior is to create each temporary
 file in the same directory as the associated destination file\&.
 .IP 
 This option is most often used when the receiving disk partition does not
@@ -1393,171 +1432,179 @@
 temporary file in the destination directory, and then renamed into place)
 it would be possible for the old file to continue taking up disk space (if
 someone had it open), and thus there might not be enough room to fit the
 new version on the disk at the same time\&.
 .IP 
 If you are using this option for reasons other than a shortage of disk
-space, you may wish to combine it with the \fB--delay-updates\fP option,
+space, you may wish to combine it with the \fB\-\-delay\-updates\fP option,
 which will ensure that all copied files get put into subdirectories in the
 destination hierarchy, awaiting the end of the transfer\&.  If you don\&'t
 have enough room to duplicate all the arriving files on the destination
 partition, another way to tell rsync that you aren\&'t overly concerned
-about disk space is to use the \fB--partial-dir\fP option with a relative
+about disk space is to use the \fB\-\-partial\-dir\fP option with a relative
 path; because this tells rsync that it is OK to stash off a copy of a
 single file in a subdir in the destination hierarchy, rsync will use the
 partial-dir as a staging area to bring over the copied file, and then
-rename it into place from there\&. (Specifying a \fB--partial-dir\fP with
+rename it into place from there\&. (Specifying a \fB\-\-partial\-dir\fP with
 an absolute path does not have this side-effect\&.)
 .IP 
-.IP "\fB-y, --fuzzy\fP" 
+.IP "\fB\-y, \-\-fuzzy\fP"
 This option tells rsync that it should look for a
 basis file for any destination file that is missing\&.  The current algorithm
 looks in the same directory as the destination file for either a file that
 has an identical size and modified-time, or a similarly-named file\&.  If
 found, rsync uses the fuzzy basis file to try to speed up the transfer\&.
 .IP 
-Note that the use of the \fB--delete\fP option might get rid of any potential
-fuzzy-match files, so either use \fB--delete-after\fP or specify some
+Note that the use of the \fB\-\-delete\fP option might get rid of any potential
+fuzzy-match files, so either use \fB\-\-delete\-after\fP or specify some
 filename exclusions if you need to prevent this\&.
 .IP 
-.IP "\fB--compare-dest=DIR\fP" 
+.IP "\fB\-\-compare\-dest=DIR\fP"
 This option instructs rsync to use \fIDIR\fP on
 the destination machine as an additional hierarchy to compare destination
 files against doing transfers (if the files are missing in the destination
 directory)\&.  If a file is found in \fIDIR\fP that is identical to the
 sender\&'s file, the file will NOT be transferred to the destination
 directory\&.  This is useful for creating a sparse backup of just files that
 have changed from an earlier backup\&.
 .IP 
-Beginning in version 2\&.6\&.4, multiple \fB--compare-dest\fP directories may be
+Beginning in version 2\&.6\&.4, multiple \fB\-\-compare\-dest\fP directories may be
 provided, which will cause rsync to search the list in the order specified
 for an exact match\&.
 If a match is found that differs only in attributes, a local copy is made
 and the attributes updated\&.
 If a match is not found, a basis file from one of the \fIDIR\fPs will be
 selected to try to speed up the transfer\&.
 .IP 
 If \fIDIR\fP is a relative path, it is relative to the destination directory\&.
-See also \fB--copy-dest\fP and \fB--link-dest\fP\&.
+See also \fB\-\-copy\-dest\fP and \fB\-\-link\-dest\fP\&.
 .IP 
-.IP "\fB--copy-dest=DIR\fP" 
-This option behaves like \fB--compare-dest\fP, but
+.IP "\fB\-\-copy\-dest=DIR\fP"
+This option behaves like \fB\-\-compare\-dest\fP, but
 rsync will also copy unchanged files found in \fIDIR\fP to the destination
 directory using a local copy\&.
 This is useful for doing transfers to a new destination while leaving
 existing files intact, and then doing a flash-cutover when all files have
 been successfully transferred\&.
 .IP 
-Multiple \fB--copy-dest\fP directories may be provided, which will cause
+Multiple \fB\-\-copy\-dest\fP directories may be provided, which will cause
 rsync to search the list in the order specified for an unchanged file\&.
 If a match is not found, a basis file from one of the \fIDIR\fPs will be
 selected to try to speed up the transfer\&.
 .IP 
 If \fIDIR\fP is a relative path, it is relative to the destination directory\&.
-See also \fB--compare-dest\fP and \fB--link-dest\fP\&.
+See also \fB\-\-compare\-dest\fP and \fB\-\-link\-dest\fP\&.
 .IP 
-.IP "\fB--link-dest=DIR\fP" 
-This option behaves like \fB--copy-dest\fP, but
+.IP "\fB\-\-link\-dest=DIR\fP"
+This option behaves like \fB\-\-copy\-dest\fP, but
 unchanged files are hard linked from \fIDIR\fP to the destination directory\&.
 The files must be identical in all preserved attributes (e\&.g\&. permissions,
 possibly ownership) in order for the files to be linked together\&.
 An example:
 .IP 
 .RS 
-\f(CW  rsync -av --link-dest=$PWD/prior_dir host:src_dir/ new_dir/\fP
-.RE 
+\f(CW  rsync \-av \-\-link\-dest=$PWD/prior_dir host:src_dir/ new_dir/\fP
+.RE
+
 .IP 
-Beginning in version 2\&.6\&.4, multiple \fB--link-dest\fP directories may be
+Beginning in version 2\&.6\&.4, multiple \fB\-\-link\-dest\fP directories may be
 provided, which will cause rsync to search the list in the order specified
 for an exact match\&.
 If a match is found that differs only in attributes, a local copy is made
 and the attributes updated\&.
 If a match is not found, a basis file from one of the \fIDIR\fPs will be
 selected to try to speed up the transfer\&.
 .IP 
+Note that if you combine this option with \fB\-\-ignore\-times\fP, rsync will not
+link any files together because it only links identical files together as a
+substitute for transferring the file, never as an additional check after the
+file is updated\&.
+.IP 
 If \fIDIR\fP is a relative path, it is relative to the destination directory\&.
-See also \fB--compare-dest\fP and \fB--copy-dest\fP\&.
+See also \fB\-\-compare\-dest\fP and \fB\-\-copy\-dest\fP\&.
 .IP 
 Note that rsync versions prior to 2\&.6\&.1 had a bug that could prevent
-\fB--link-dest\fP from working properly for a non-super-user when \fB-o\fP was
-specified (or implied by \fB-a\fP)\&.  You can work-around this bug by avoiding
-the \fB-o\fP option when sending to an old rsync\&.
+\fB\-\-link\-dest\fP from working properly for a non-super-user when \fB\-o\fP was
+specified (or implied by \fB\-a\fP)\&.  You can work-around this bug by avoiding
+the \fB\-o\fP option when sending to an old rsync\&.
 .IP 
-.IP "\fB-z, --compress\fP" 
+.IP "\fB\-z, \-\-compress\fP"
 With this option, rsync compresses the file data
 as it is sent to the destination machine, which reduces the amount of data
 being transmitted -- something that is useful over a slow connection\&.
 .IP 
 Note that this option typically achieves better compression ratios than can
 be achieved by using a compressing remote shell or a compressing transport
 because it takes advantage of the implicit information in the matching data
 blocks that are not explicitly sent over the connection\&.
 .IP 
-.IP "\fB--compress-level=NUM\fP" 
+.IP "\fB\-\-compress\-level=NUM\fP"
 Explicitly set the compression level to use
-(see \fB--compress\fP) instead of letting it default\&.  If NUM is non-zero,
-the \fB--compress\fP option is implied\&.
+(see \fB\-\-compress\fP) instead of letting it default\&.  If NUM is non-zero,
+the \fB\-\-compress\fP option is implied\&.
 .IP 
-.IP "\fB--numeric-ids\fP" 
+.IP "\fB\-\-numeric\-ids\fP"
 With this option rsync will transfer numeric group
 and user IDs rather than using user and group names and mapping them
 at both ends\&.
 .IP 
 By default rsync will use the username and groupname to determine
 what ownership to give files\&. The special uid 0 and the special group
-0 are never mapped via user/group names even if the \fB--numeric-ids\fP
+0 are never mapped via user/group names even if the \fB\-\-numeric\-ids\fP
 option is not specified\&.
 .IP 
 If a user or group has no name on the source system or it has no match
 on the destination system, then the numeric ID
 from the source system is used instead\&.  See also the comments on the
 "use chroot" setting in the rsyncd\&.conf manpage for information on how
 the chroot setting affects rsync\&'s ability to look up the names of the
 users and groups and what you can do about it\&.
 .IP 
-.IP "\fB--timeout=TIMEOUT\fP" 
+.IP "\fB\-\-timeout=TIMEOUT\fP"
 This option allows you to set a maximum I/O
 timeout in seconds\&. If no data is transferred for the specified time
 then rsync will exit\&. The default is 0, which means no timeout\&.
 .IP 
-.IP "\fB--address\fP" 
+.IP "\fB\-\-address\fP"
 By default rsync will bind to the wildcard address when
-connecting to an rsync daemon\&.  The \fB--address\fP option allows you to
+connecting to an rsync daemon\&.  The \fB\-\-address\fP option allows you to
 specify a specific IP address (or hostname) to bind to\&.  See also this
-option in the \fB--daemon\fP mode section\&.
+option in the \fB\-\-daemon\fP mode section\&.
 .IP 
-.IP "\fB--port=PORT\fP" 
+.IP "\fB\-\-port=PORT\fP"
 This specifies an alternate TCP port number to use
 rather than the default of 873\&.  This is only needed if you are using the
 double-colon (::) syntax to connect with an rsync daemon (since the URL
 syntax has a way to specify the port as a part of the URL)\&.  See also this
-option in the \fB--daemon\fP mode section\&.
+option in the \fB\-\-daemon\fP mode section\&.
 .IP 
-.IP "\fB--sockopts\fP" 
+.IP "\fB\-\-sockopts\fP"
 This option can provide endless fun for people
 who like to tune their systems to the utmost degree\&. You can set all
 sorts of socket options which may make transfers faster (or
-slower!)\&. Read the man page for the \f(CWsetsockopt()\fP system call for
+slower!)\&. Read the man page for the 
+\f(CWsetsockopt()\fP
+system call for
 details on some of the options you may be able to set\&. By default no
 special socket options are set\&. This only affects direct socket
 connections to a remote rsync daemon\&.  This option also exists in the
-\fB--daemon\fP mode section\&.
+\fB\-\-daemon\fP mode section\&.
 .IP 
-.IP "\fB--blocking-io\fP" 
+.IP "\fB\-\-blocking\-io\fP"
 This tells rsync to use blocking I/O when launching
 a remote shell transport\&.  If the remote shell is either rsh or remsh,
 rsync defaults to using
 blocking I/O, otherwise it defaults to using non-blocking I/O\&.  (Note that
 ssh prefers non-blocking I/O\&.)
 .IP 
-.IP "\fB-i, --itemize-changes\fP" 
+.IP "\fB\-i, \-\-itemize\-changes\fP"
 Requests a simple itemized list of the
 changes that are being made to each file, including attribute changes\&.
-This is exactly the same as specifying \fB--log-format=\&'%i %n%L\&'\fP\&.
+This is exactly the same as specifying \fB\-\-out\-format=\&'%i %n%L\&'\fP\&.
 If you repeat the option, unchanged files will also be output, but only
-if the receiving rsync is at least version 2\&.6\&.7 (you can use \fB-vv\fP
+if the receiving rsync is at least version 2\&.6\&.7 (you can use \fB\-vv\fP
 with older versions of rsync, but that also turns on the output of other
 verbose messages)\&.
 .IP 
 The "%i" escape has a cryptic output that is 9 letters long\&.  The general
 format is like the string \fBYXcstpogz\fP, where \fBY\fP is replaced by the
 type of update being done, \fBX\fP is replaced by the file-type, and the
@@ -1575,17 +1622,18 @@
 (received)\&.
 .IP o 
 A \fBc\fP means that a local change/creation is occurring for the item
 (such as the creation of a directory or the changing of a symlink, etc\&.)\&.
 .IP o 
 A \fBh\fP means that the item is a hard link to another item (requires
-\fB--hard-links\fP)\&.
+\fB\-\-hard\-links\fP)\&.
 .IP o 
 A \fB\&.\fP means that the item is not being updated (though it might
 have attributes that are being modified)\&.
-.RE 
+.RE
+
 .IP 
 The file-types that replace the \fBX\fP are: \fBf\fP for a file, a \fBd\fP for a
 directory, an \fBL\fP for a symlink, a \fBD\fP for a device, and a \fBS\fP for a
 special file (e\&.g\&. named sockets and fifos)\&.
 .IP 
 The other letters in the string above are the actual letters that
@@ -1597,68 +1645,95 @@
 .IP 
 The attribute that is associated with each letter is as follows:
 .IP 
 .RS 
 .IP o 
 A \fBc\fP means the checksum of the file is different and will be
-updated by the file transfer (requires \fB--checksum\fP)\&.
+updated by the file transfer (requires \fB\-\-checksum\fP)\&.
 .IP o 
 A \fBs\fP means the size of the file is different and will be updated
 by the file transfer\&.
 .IP o 
 A \fBt\fP means the modification time is different and is being updated
-to the sender\&'s value (requires \fB--times\fP)\&.  An alternate value of \fBT\fP
+to the sender\&'s value (requires \fB\-\-times\fP)\&.  An alternate value of \fBT\fP
 means that the time will be set to the transfer time, which happens
 anytime a symlink is transferred, or when a file or device is transferred
-without \fB--times\fP\&.
+without \fB\-\-times\fP\&.
 .IP o 
 A \fBp\fP means the permissions are different and are being updated to
-the sender\&'s value (requires \fB--perms\fP)\&.
+the sender\&'s value (requires \fB\-\-perms\fP)\&.
 .IP o 
 An \fBo\fP means the owner is different and is being updated to the
-sender\&'s value (requires \fB--owner\fP and super-user privileges)\&.
+sender\&'s value (requires \fB\-\-owner\fP and super-user privileges)\&.
 .IP o 
 A \fBg\fP means the group is different and is being updated to the
-sender\&'s value (requires \fB--group\fP and the authority to set the group)\&.
+sender\&'s value (requires \fB\-\-group\fP and the authority to set the group)\&.
 .IP o 
 The \fBz\fP slot is reserved for future use\&.
-.RE 
+.RE
+
 .IP 
 One other output is possible:  when deleting files, the "%i" will output
 the string "*deleting" for each item that is being removed (assuming that
 you are talking to a recent enough rsync that it logs deletions instead of
 outputting them as a verbose message)\&.
 .IP 
-.IP "\fB--log-format=FORMAT\fP" 
+.IP "\fB\-\-out\-format=FORMAT\fP"
 This allows you to specify exactly what the
-rsync client outputs to the user on a per-file basis\&.  The format is a text
+rsync client outputs to the user on a per-update basis\&.  The format is a text
 string containing embedded single-character escape sequences prefixed with
 a percent (%) character\&.  For a list of the possible escape characters, see
-the "log format" setting in the rsyncd\&.conf manpage\&.  (Note that this
-option does not affect what a daemon logs to its logfile\&.)
+the "log format" setting in the rsyncd\&.conf manpage\&.
 .IP 
 Specifying this option will mention each file, dir, etc\&. that gets updated
 in a significant way (a transferred file, a recreated symlink/device, or a
-touched directory) unless the itemize-changes escape (%i) is included in
-the string, in which case the logging of names increases to mention any
+touched directory)\&.  In addition, if the itemize-changes escape (%i) is
+included in the string, the logging of names increases to mention any
 item that is changed in any way (as long as the receiving side is at least
-2\&.6\&.4)\&.  See the \fB--itemize-changes\fP option for a description of the
+2\&.6\&.4)\&.  See the \fB\-\-itemize\-changes\fP option for a description of the
 output of "%i"\&.
 .IP 
-The \fB--verbose\fP option implies a format of "%n%L", but you can use
-\fB--log-format\fP without \fB--verbose\fP if you like, or you can override
+The \fB\-\-verbose\fP option implies a format of "%n%L", but you can use
+\fB\-\-out\-format\fP without \fB\-\-verbose\fP if you like, or you can override
 the format of its per-file output using this option\&.
 .IP 
-Rsync will output the log-format string prior to a file\&'s transfer unless
+Rsync will output the out-format string prior to a file\&'s transfer unless
 one of the transfer-statistic escapes is requested, in which case the
 logging is done at the end of the file\&'s transfer\&.  When this late logging
-is in effect and \fB--progress\fP is also specified, rsync will also output
+is in effect and \fB\-\-progress\fP is also specified, rsync will also output
 the name of the file being transferred prior to its progress information
-(followed, of course, by the log-format output)\&.
+(followed, of course, by the out-format output)\&.
+.IP 
+.IP "\fB\-\-log\-file=FILE\fP"
+This option causes rsync to log what it is doing
+to a file\&.  This is similar to the logging that a daemon does, but can be
+requested for the client side and/or the server side of a non-daemon
+transfer\&.  If specified as a client option, transfer logging will be
+enabled with a default format of "%i %n%L"\&.  See the \fB\-\-log\-file\-format\fP
+option if you wish to override this\&.
+.IP 
+Here\&'s a example command that requests the remote side to log what is
+happening:
+.IP 
+.nf 
+  rsync \-av \-\-rsync\-path="rsync \-\-log\-file=/tmp/rlog" src/ dest/
+.fi 
+
+.IP 
+This is very useful if you need to debug why a connection is closing
+unexpectedly\&.
 .IP 
-.IP "\fB--stats\fP" 
+.IP "\fB\-\-log\-file\-format=FORMAT\fP"
+This allows you to specify exactly what
+per-update logging is put into the file specified by the \fB\-\-log\-file\fP option
+(which must also be specified for this option to have any effect)\&.  If you
+specify an empty string, updated files will not be mentioned in the log file\&.
+For a list of the possible escape characters, see the "log format" setting
+in the rsyncd\&.conf manpage\&.
+.IP 
+.IP "\fB\-\-stats\fP"
 This tells rsync to print a verbose set of statistics
 on the file transfer, allowing you to tell how effective the rsync
 algorithm is for your data\&.
 .IP 
 The current statistics are as follows: 
 .RS 
@@ -1699,126 +1774,127 @@
 from the client side to the server side\&.
 .IP o 
 \fBTotal bytes received\fP is the count of all non-message bytes that
 rsync received by the client side from the server side\&.  "Non-message"
 bytes means that we don\&'t count the bytes for a verbose message that the
 server sent to us, which makes the stats more consistent\&.
-.RE 
+.RE
+
 .IP 
-.IP "\fB-8, --8-bit-output\fP" 
+.IP "\fB\-8, \-\-8\-bit\-output\fP"
 This tells rsync to leave all high-bit characters
 unescaped in the output instead of trying to test them to see if they\&'re
 valid in the current locale and escaping the invalid ones\&.  All control
 characters (but never tabs) are always escaped, regardless of this option\&'s
 setting\&.
 .IP 
 The escape idiom that started in 2\&.6\&.7 is to output a literal backslash (\e)
 and a hash (#), followed by exactly 3 octal digits\&.  For example, a newline
 would output as "\e#012"\&.  A literal backslash that is in a filename is not
-escaped unless it is followed by a hash and 3 digits (0-9)\&.
+escaped unless it is followed by a hash and 3 digits (0\-9)\&.
 .IP 
-.IP "\fB-h, --human-readable\fP" 
+.IP "\fB\-h, \-\-human\-readable\fP"
 Output numbers in a more human-readable format\&.
 This makes big numbers output using larger units, with a K, M, or G suffix\&.  If
 this option was specified once, these units are K (1000), M (1000*1000), and
 G (1000*1000*1000); if the option is repeated, the units are powers of 1024
 instead of 1000\&.
 .IP 
-.IP "\fB--partial\fP" 
+.IP "\fB\-\-partial\fP"
 By default, rsync will delete any partially
 transferred file if the transfer is interrupted\&. In some circumstances
 it is more desirable to keep partially transferred files\&. Using the
-\fB--partial\fP option tells rsync to keep the partial file which should
+\fB\-\-partial\fP option tells rsync to keep the partial file which should
 make a subsequent transfer of the rest of the file much faster\&.
 .IP 
-.IP "\fB--partial-dir=DIR\fP" 
+.IP "\fB\-\-partial\-dir=DIR\fP"
 A better way to keep partial files than the
-\fB--partial\fP option is to specify a \fIDIR\fP that will be used to hold the
+\fB\-\-partial\fP option is to specify a \fIDIR\fP that will be used to hold the
 partial data (instead of writing it out to the destination file)\&.
 On the next transfer, rsync will use a file found in this
 dir as data to speed up the resumption of the transfer and then delete it
 after it has served its purpose\&.
 .IP 
-Note that if \fB--whole-file\fP is specified (or implied), any partial-dir
+Note that if \fB\-\-whole\-file\fP is specified (or implied), any partial-dir
 file that is found for a file that is being updated will simply be removed
 (since
 rsync is sending files without using the incremental rsync algorithm)\&.
 .IP 
 Rsync will create the \fIDIR\fP if it is missing (just the last dir -- not
 the whole path)\&.  This makes it easy to use a relative path (such as
-"\fB--partial-dir=\&.rsync-partial\fP") to have rsync create the
+"\fB\-\-partial\-dir=\&.rsync\-partial\fP") to have rsync create the
 partial-directory in the destination file\&'s directory when needed, and then
 remove it again when the partial file is deleted\&.
 .IP 
 If the partial-dir value is not an absolute path, rsync will add an exclude
 rule at the end of all your existing excludes\&.  This will prevent the
 sending of any partial-dir files that may exist on the sending side, and
 will also prevent the untimely deletion of partial-dir items on the
-receiving side\&.  An example: the above \fB--partial-dir\fP option would add
-the equivalent of "\fB--exclude=\&.rsync-partial/\fP" at the end of any other
+receiving side\&.  An example: the above \fB\-\-partial\-dir\fP option would add
+the equivalent of "\fB\-\-exclude=\&.rsync\-partial/\fP" at the end of any other
 filter rules\&.
 .IP 
 If you are supplying your own exclude rules, you may need to add your own
 exclude/hide/protect rule for the partial-dir because (1) the auto-added
 rule may be ineffective at the end of your other rules, or (2) you may wish
 to override rsync\&'s exclude choice\&.  For instance, if you want to make
 rsync clean-up any left-over partial-dirs that may be lying around, you
-should specify \fB--delete-after\fP and add a "risk" filter rule, e\&.g\&.
-\fB-f \&'R \&.rsync-partial/\&'\fP\&.  (Avoid using \fB--delete-before\fP or
-\fB--delete-during\fP unless you don\&'t need rsync to use any of the
+should specify \fB\-\-delete\-after\fP and add a "risk" filter rule, e\&.g\&.
+\fB\-f \&'R \&.rsync\-partial/\&'\fP\&.  (Avoid using \fB\-\-delete\-before\fP or
+\fB\-\-delete\-during\fP unless you don\&'t need rsync to use any of the
 left-over partial-dir data during the current run\&.)
 .IP 
-IMPORTANT: the \fB--partial-dir\fP should not be writable by other users or it
+IMPORTANT: the \fB\-\-partial\-dir\fP should not be writable by other users or it
 is a security risk\&.  E\&.g\&. AVOID "/tmp"\&.
 .IP 
 You can also set the partial-dir value the RSYNC_PARTIAL_DIR environment
-variable\&.  Setting this in the environment does not force \fB--partial\fP to be
-enabled, but rather it affects where partial files go when \fB--partial\fP is
-specified\&.  For instance, instead of using \fB--partial-dir=\&.rsync-tmp\fP
-along with \fB--progress\fP, you could set RSYNC_PARTIAL_DIR=\&.rsync-tmp in your
-environment and then just use the \fB-P\fP option to turn on the use of the
-\&.rsync-tmp dir for partial transfers\&.  The only times that the \fB--partial\fP
-option does not look for this environment value are (1) when \fB--inplace\fP was
-specified (since \fB--inplace\fP conflicts with \fB--partial-dir\fP), and (2) when
-\fB--delay-updates\fP was specified (see below)\&.
+variable\&.  Setting this in the environment does not force \fB\-\-partial\fP to be
+enabled, but rather it affects where partial files go when \fB\-\-partial\fP is
+specified\&.  For instance, instead of using \fB\-\-partial\-dir=\&.rsync\-tmp\fP
+along with \fB\-\-progress\fP, you could set RSYNC_PARTIAL_DIR=\&.rsync\-tmp in your
+environment and then just use the \fB\-P\fP option to turn on the use of the
+\&.rsync\-tmp dir for partial transfers\&.  The only times that the \fB\-\-partial\fP
+option does not look for this environment value are (1) when \fB\-\-inplace\fP was
+specified (since \fB\-\-inplace\fP conflicts with \fB\-\-partial\-dir\fP), and (2) when
+\fB\-\-delay\-updates\fP was specified (see below)\&.
 .IP 
 For the purposes of the daemon-config\&'s "refuse options" setting,
-\fB--partial-dir\fP does \fInot\fP imply \fB--partial\fP\&.  This is so that a
-refusal of the \fB--partial\fP option can be used to disallow the overwriting
+\fB\-\-partial\-dir\fP does \fInot\fP imply \fB\-\-partial\fP\&.  This is so that a
+refusal of the \fB\-\-partial\fP option can be used to disallow the overwriting
 of destination files with a partial transfer, while still allowing the
-safer idiom provided by \fB--partial-dir\fP\&.
+safer idiom provided by \fB\-\-partial\-dir\fP\&.
 .IP 
-.IP "\fB--delay-updates\fP" 
+.IP "\fB\-\-delay\-updates\fP"
 This option puts the temporary file from each
 updated file into a holding directory until the end of the
 transfer, at which time all the files are renamed into place in rapid
 succession\&.  This attempts to make the updating of the files a little more
 atomic\&.  By default the files are placed into a directory named "\&.~tmp~" in
 each file\&'s destination directory, but if you\&'ve specified the
-\fB--partial-dir\fP option, that directory will be used instead\&.  See the
-comments in the \fB--partial-dir\fP section for a discussion of how this
+\fB\-\-partial\-dir\fP option, that directory will be used instead\&.  See the
+comments in the \fB\-\-partial\-dir\fP section for a discussion of how this
 "\&.~tmp~" dir will be excluded from the transfer, and what you can do if
 you wnat rsync to cleanup old "\&.~tmp~" dirs that might be lying around\&.
-Conflicts with \fB--inplace\fP and \fB--append\fP\&.
+Conflicts with \fB\-\-inplace\fP and \fB\-\-append\fP\&.
 .IP 
 This option uses more memory on the receiving side (one bit per file
 transferred) and also requires enough free disk space on the receiving
 side to hold an additional copy of all the updated files\&.  Note also that
-you should not use an absolute path to \fB--partial-dir\fP unless (1)
+you should not use an absolute path to \fB\-\-partial\-dir\fP unless (1)
 there is no
 chance of any of the files in the transfer having the same name (since all
 the updated files will be put into a single directory if the path is
 absolute)
 and (2) there are no mount points in the hierarchy (since the
 delayed updates will fail if they can\&'t be renamed into place)\&.
 .IP 
 See also the "atomic-rsync" perl script in the "support" subdir for an
-update algorithm that is even more atomic (it uses \fB--link-dest\fP and a
+update algorithm that is even more atomic (it uses \fB\-\-link\-dest\fP and a
 parallel hierarchy of files)\&.
 .IP 
-.IP "\fB-m, --prune-empty-dirs\fP" 
+.IP "\fB\-m, \-\-prune\-empty\-dirs\fP"
 This option tells the receiving rsync to get
 rid of empty directories from the file-list, including nested directories
 that have no non-directory children\&.  This is useful for avoiding the
 creation of a bunch of useless directories when the sending rsync is
 recursively scanning a hierarchy of files using include/exclude/filter
 rules\&.
@@ -1831,118 +1907,121 @@
 .IP 
 You can prevent the pruning of certain empty directories from the file-list
 by using a global "protect" filter\&.  For instance, this option would ensure
 that the directory "emptydir" was kept in the file-list:
 .IP 
 .RS 
---filter \&'protect emptydir/\&'
-.RE 
+\-\-filter \&'protect emptydir/\&'
+.RE
+
 .IP 
 Here\&'s an example that copies all \&.pdf files in a hierarchy, only creating
 the necessary destination directories to hold the \&.pdf files, and ensures
 that any superfluous files and directories in the destination are removed
 (note the hide filter of non-directories being used instead of an exclude):
 .IP 
 .RS 
-rsync -avm --del --include=\&'*\&.pdf\&' -f \&'hide,! */\&' src/ dest
-.RE 
+rsync \-avm \-\-del \-\-include=\&'*\&.pdf\&' \-f \&'hide,! */\&' src/ dest
+.RE
+
 .IP 
 If you didn\&'t want to remove superfluous destination files, the more
-time-honored options of "--include=\&'*/\&' --exclude=\&'*\&'" would work fine
+time-honored options of "\-\-include=\&'*/\&' \-\-exclude=\&'*\&'" would work fine
 in place of the hide-filter (if that is more natural to you)\&.
 .IP 
-.IP "\fB--progress\fP" 
+.IP "\fB\-\-progress\fP"
 This option tells rsync to print information
 showing the progress of the transfer\&. This gives a bored user
 something to watch\&.
-Implies \fB--verbose\fP if it wasn\&'t already specified\&.
+Implies \fB\-\-verbose\fP if it wasn\&'t already specified\&.
 .IP 
-When the file is transferring, the data looks like this:
+While rsync is transferring a regular file, it updates a progress line that
+looks like this:
 .IP 
-
 .nf 
- 
       782448  63%  110\&.64kB/s    0:00:04
 .fi 
- 
 
 .IP 
-This tells you the current file size, the percentage of the transfer that
-is complete, the current calculated file-completion rate (including both
-data over the wire and data being matched locally), and the estimated time
-remaining in this transfer\&.
+In this example, the receiver has reconstructed 782448 bytes or 63% of the
+sender\&'s file, which is being reconstructed at a rate of 110\&.64 kilobytes
+per second, and the transfer will finish in 4 seconds if the current rate
+is maintained until the end\&.
+.IP 
+These statistics can be misleading if the incremental transfer algorithm is
+in use\&.  For example, if the sender\&'s file consists of the basis file
+followed by additional data, the reported rate will probably drop
+dramatically when the receiver gets to the literal data, and the transfer
+will probably take much longer to finish than the receiver estimated as it
+was finishing the matched part of the file\&.
 .IP 
-After a file is complete, the data looks like this:
+When the file transfer finishes, rsync replaces the progress line with a
+summary line that looks like this:
 .IP 
-
 .nf 
- 
-     1238099 100%  146\&.38kB/s    0:00:08  (5, 57\&.1% of 396)
+     1238099 100%  146\&.38kB/s    0:00:08  (xfer#5, to-check=169/396)
 .fi 
- 
 
 .IP 
-This tells you the final file size, that it\&'s 100% complete, the final
-transfer rate for the file, the amount of elapsed time it took to transfer
-the file, and the addition of a total-transfer summary in parentheses\&.
-These additional numbers tell you how many files have been updated, and
-what percent of the total number of files has been scanned\&.
+In this example, the file was 1238099 bytes long in total, the average rate
+of transfer for the whole file was 146\&.38 kilobytes per second over the 8
+seconds that it took to complete, it was the 5th transfer of a regular file
+during the current rsync session, and there are 169 more files for the
+receiver to check (to see if they are up-to-date or not) remaining out of
+the 396 total files in the file-list\&.
 .IP 
-.IP "\fB-P\fP" 
-The \fB-P\fP option is equivalent to \fB--partial\fP \fB--progress\fP\&.  Its
+.IP "\fB\-P\fP"
+The \fB\-P\fP option is equivalent to \fB\-\-partial\fP \fB\-\-progress\fP\&.  Its
 purpose is to make it much easier to specify these two options for a long
 transfer that may be interrupted\&.
 .IP 
-.IP "\fB--password-file\fP" 
+.IP "\fB\-\-password\-file\fP"
 This option allows you to provide a password
 in a file for accessing a remote rsync daemon\&. Note that this option
 is only useful when accessing an rsync daemon using the built in
 transport, not when using a remote shell as the transport\&. The file
 must not be world readable\&. It should contain just the password as a
 single line\&.
 .IP 
-.IP "\fB--list-only\fP" 
+.IP "\fB\-\-list\-only\fP"
 This option will cause the source files to be listed
 instead of transferred\&.  This option is inferred if there is a single source
 arg and no destination specified, so its main uses are: (1) to turn a copy
 command that includes a
 destination arg into a file-listing command, (2) to be able to specify more
 than one local source arg (note: be sure to include the destination), or
-(3) to avoid the automatically added "\fB-r --exclude=\&'/*/*\&'\fP" options that
+(3) to avoid the automatically added "\fB\-r \-\-exclude=\&'/*/*\&'\fP" options that
 rsync usually uses as a compatibility kluge when generating a non-recursive
 listing\&.  Caution: keep in mind that a source arg with a wild-card is expanded
 by the shell into multiple args, so it is never safe to try to list such an arg
 without using this option\&.  For example:
 .IP 
-
 .nf 
- 
-    rsync -av --list-only foo* dest/
+    rsync \-av \-\-list\-only foo* dest/
 .fi 
- 
 
 .IP 
-.IP "\fB--bwlimit=KBPS\fP" 
+.IP "\fB\-\-bwlimit=KBPS\fP"
 This option allows you to specify a maximum
 transfer rate in kilobytes per second\&. This option is most effective when
 using rsync with large files (several megabytes and up)\&. Due to the nature
 of rsync transfers, blocks of data are sent, then if rsync determines the
 transfer was too fast, it will wait before sending the next data block\&. The
 result is an average transfer rate equaling the specified limit\&. A value
 of zero specifies no limit\&.
 .IP 
-.IP "\fB--write-batch=FILE\fP" 
+.IP "\fB\-\-write\-batch=FILE\fP"
 Record a file that can later be applied to
-another identical destination with \fB--read-batch\fP\&. See the "BATCH MODE"
-section for details, and also the \fB--only-write-batch\fP option\&.
+another identical destination with \fB\-\-read\-batch\fP\&. See the "BATCH MODE"
+section for details, and also the \fB\-\-only\-write\-batch\fP option\&.
 .IP 
-.IP "\fB--only-write-batch=FILE\fP" 
-Works like \fB--write-batch\fP, except that
+.IP "\fB\-\-only\-write\-batch=FILE\fP"
+Works like \fB\-\-write\-batch\fP, except that
 no updates are made on the destination system when creating the batch\&.
 This lets you transport the changes to the destination system via some
-other means and then apply the changes via \fB--read-batch\fP\&.
+other means and then apply the changes via \fB\-\-read\-batch\fP\&.
 .IP 
 Note that you can feel free to write the batch directly to some portable
 media: if this media fills to capacity before the end of the transfer, you
 can just apply that partial transfer to the destination and repeat the
 whole process to get the rest of the changes (as long as you don\&'t mind a
 partially updated destination system while the multi-update cycle is
@@ -1950,119 +2029,137 @@
 .IP 
 Also note that you only save bandwidth when pushing changes to a remote
 system because this allows the batched data to be diverted from the sender
 into the batch file without having to flow over the wire to the receiver
 (when pulling, the sender is remote, and thus can\&'t write the batch)\&.
 .IP 
-.IP "\fB--read-batch=FILE\fP" 
+.IP "\fB\-\-read\-batch=FILE\fP"
 Apply all of the changes stored in FILE, a
-file previously generated by \fB--write-batch\fP\&.
-If \fIFILE\fP is \fB-\fP, the batch data will be read from standard input\&.
+file previously generated by \fB\-\-write\-batch\fP\&.
+If \fIFILE\fP is \fB\-\fP, the batch data will be read from standard input\&.
 See the "BATCH MODE" section for details\&.
 .IP 
-.IP "\fB--protocol=NUM\fP" 
+.IP "\fB\-\-protocol=NUM\fP"
 Force an older protocol version to be used\&.  This
 is useful for creating a batch file that is compatible with an older
 version of rsync\&.  For instance, if rsync 2\&.6\&.4 is being used with the
-\fB--write-batch\fP option, but rsync 2\&.6\&.3 is what will be used to run the
-\fB--read-batch\fP option, you should use "--protocol=28" when creating the
+\fB\-\-write\-batch\fP option, but rsync 2\&.6\&.3 is what will be used to run the
+\fB\-\-read\-batch\fP option, you should use "\-\-protocol=28" when creating the
 batch file to force the older protocol version to be used in the batch
 file (assuming you can\&'t upgrade the rsync on the reading system)\&.
 .IP 
-.IP "\fB-4, --ipv4\fP or \fB-6, --ipv6\fP" 
+.IP "\fB\-4, \-\-ipv4\fP or \fB\-6, \-\-ipv6\fP"
 Tells rsync to prefer IPv4/IPv6
 when creating sockets\&.  This only affects sockets that rsync has direct
 control over, such as the outgoing socket when directly contacting an
-rsync daemon\&.  See also these options in the \fB--daemon\fP mode section\&.
+rsync daemon\&.  See also these options in the \fB\-\-daemon\fP mode section\&.
 .IP 
-.IP "\fB--checksum-seed=NUM\fP" 
+.IP "\fB\-\-checksum\-seed=NUM\fP"
 Set the MD4 checksum seed to the integer
 NUM\&.  This 4 byte checksum seed is included in each block and file
 MD4 checksum calculation\&.  By default the checksum seed is generated
-by the server and defaults to the current \f(CWtime()\fP\&.  This option
+by the server and defaults to the current 
+\f(CWtime()\fP
+\&.  This option
 is used to set a specific checksum seed, which is useful for
 applications that want repeatable block and file checksums, or
 in the case where the user wants a more random checksum seed\&.
-Note that setting NUM to 0 causes rsync to use the default of \f(CWtime()\fP
+Note that setting NUM to 0 causes rsync to use the default of 
+\f(CWtime()\fP
 for checksum seed\&.
+
 .PP 
-.SH "DAEMON OPTIONS" 
+.SH "DAEMON OPTIONS"
+
 .PP 
 The options allowed when starting an rsync daemon are as follows:
 .PP 
-.IP "\fB--daemon\fP" 
+.IP "\fB\-\-daemon\fP"
 This tells rsync that it is to run as a daemon\&.  The
 daemon you start running may be accessed using an rsync client using
 the \fBhost::module\fP or \fBrsync://host/module/\fP syntax\&.
 .IP 
 If standard input is a socket then rsync will assume that it is being
 run via inetd, otherwise it will detach from the current terminal and
 become a background daemon\&.  The daemon will read the config file
 (rsyncd\&.conf) on each connect made by a client and respond to
 requests accordingly\&.  See the \fBrsyncd\&.conf\fP(5) man page for more
 details\&.
 .IP 
-.IP "\fB--address\fP" 
+.IP "\fB\-\-address\fP"
 By default rsync will bind to the wildcard address when
-run as a daemon with the \fB--daemon\fP option\&.  The \fB--address\fP option
+run as a daemon with the \fB\-\-daemon\fP option\&.  The \fB\-\-address\fP option
 allows you to specify a specific IP address (or hostname) to bind to\&.  This
-makes virtual hosting possible in conjunction with the \fB--config\fP option\&.
+makes virtual hosting possible in conjunction with the \fB\-\-config\fP option\&.
 See also the "address" global option in the rsyncd\&.conf manpage\&.
 .IP 
-.IP "\fB--bwlimit=KBPS\fP" 
+.IP "\fB\-\-bwlimit=KBPS\fP"
 This option allows you to specify a maximum
 transfer rate in kilobytes per second for the data the daemon sends\&.
-The client can still specify a smaller \fB--bwlimit\fP value, but their
+The client can still specify a smaller \fB\-\-bwlimit\fP value, but their
 requested value will be rounded down if they try to exceed it\&.  See the
 client version of this option (above) for some extra details\&.
 .IP 
-.IP "\fB--config=FILE\fP" 
+.IP "\fB\-\-config=FILE\fP"
 This specifies an alternate config file than
-the default\&.  This is only relevant when \fB--daemon\fP is specified\&.
+the default\&.  This is only relevant when \fB\-\-daemon\fP is specified\&.
 The default is /etc/rsyncd\&.conf unless the daemon is running over
 a remote shell program and the remote user is not the super-user; in that case
 the default is rsyncd\&.conf in the current directory (typically $HOME)\&.
 .IP 
-.IP "\fB--no-detach\fP" 
+.IP "\fB\-\-no\-detach\fP"
 When running as a daemon, this option instructs
 rsync to not detach itself and become a background process\&.  This
 option is required when running as a service on Cygwin, and may also
 be useful when rsync is supervised by a program such as
 \fBdaemontools\fP or AIX\&'s \fBSystem Resource Controller\fP\&.
-\fB--no-detach\fP is also recommended when rsync is run under a
+\fB\-\-no\-detach\fP is also recommended when rsync is run under a
 debugger\&.  This option has no effect if rsync is run from inetd or
 sshd\&.
 .IP 
-.IP "\fB--port=PORT\fP" 
+.IP "\fB\-\-port=PORT\fP"
 This specifies an alternate TCP port number for the
 daemon to listen on rather than the default of 873\&.  See also the "port"
 global option in the rsyncd\&.conf manpage\&.
 .IP 
-.IP "\fB--sockopts\fP" 
+.IP "\fB\-\-log\-file=FILE\fP"
+This option tells the rsync daemon to use the
+given log-file name instead of using the "log file" setting in the config
+file\&.
+.IP 
+.IP "\fB\-\-log\-file\-format=FORMAT\fP"
+This option tells the rsync daemon to use the
+given FORMAT string instead of using the "log format" setting in the config
+file\&.  It also enables "transfer logging" unless the string is empty, in which
+case transfer logging is turned off\&.
+.IP 
+.IP "\fB\-\-sockopts\fP"
 This overrides the \fBsocket options\fP setting in the
 rsyncd\&.conf file and has the same syntax\&.
 .IP 
-.IP "\fB-v, --verbose\fP" 
+.IP "\fB\-v, \-\-verbose\fP"
 This option increases the amount of information the
 daemon logs during its startup phase\&.  After the client connects, the
 daemon\&'s verbosity level will be controlled by the options that the client
 used and the "max verbosity" setting in the module\&'s config section\&.
 .IP 
-.IP "\fB-4, --ipv4\fP or \fB-6, --ipv6\fP" 
+.IP "\fB\-4, \-\-ipv4\fP or \fB\-6, \-\-ipv6\fP"
 Tells rsync to prefer IPv4/IPv6
 when creating the incoming sockets that the rsync daemon will use to
 listen for connections\&.  One of these options may be required in older
 versions of Linux to work around an IPv6 bug in the kernel (if you see
 an "address already in use" error when nothing else is using the port,
-try specifying \fB--ipv6\fP or \fB--ipv4\fP when starting the daemon)\&.
+try specifying \fB\-\-ipv6\fP or \fB\-\-ipv4\fP when starting the daemon)\&.
 .IP 
-.IP "\fB-h, --help\fP" 
-When specified after \fB--daemon\fP, print a short help
+.IP "\fB\-h, \-\-help\fP"
+When specified after \fB\-\-daemon\fP, print a short help
 page describing the options available for starting an rsync daemon\&.
+
 .PP 
-.SH "FILTER RULES" 
+.SH "FILTER RULES"
+
 .PP 
 The filter rules allow for flexible selection of which files to transfer
 (include) and which files to skip (exclude)\&.  The rules either directly
 specify include/exclude patterns or they specify a way to acquire more
 include/exclude patterns (e\&.g\&. to read them from a file)\&.
 .PP 
@@ -2078,22 +2175,23 @@
 .PP 
 .RS 
 \f(CWRULE [PATTERN_OR_FILENAME]\fP
 .br 
 \f(CWRULE,MODIFIERS [PATTERN_OR_FILENAME]\fP
 .br 
-.RE 
+.RE
+
 .PP 
 You have your choice of using either short or long RULE names, as described
 below\&.  If you use a short-named rule, the \&',\&' separating the RULE from the
 MODIFIERS is optional\&.  The PATTERN or FILENAME that follows (when present)
 must come after either a single space or an underscore (_)\&.
 Here are the available rule prefixes:
 .PP 
 .RS 
-\fBexclude, -\fP specifies an exclude pattern\&. 
+\fBexclude, \-\fP specifies an exclude pattern\&. 
 .br 
 \fBinclude, +\fP specifies an include pattern\&. 
 .br 
 \fBmerge, \&.\fP specifies a merge-file to read for more rules\&. 
 .br 
 \fBdir-merge, :\fP specifies a per-directory merge-file\&. 
@@ -2105,37 +2203,39 @@
 \fBprotect, P\fP specifies a pattern for protecting files from deletion\&. 
 .br 
 \fBrisk, R\fP files that match the pattern are not protected\&. 
 .br 
 \fBclear, !\fP clears the current include/exclude list (takes no arg) 
 .br 
-.RE 
+.RE
+
 .PP 
 When rules are being read from a file, empty lines are ignored, as are
 comment lines that start with a "#"\&.
 .PP 
-Note that the \fB--include\fP/\fB--exclude\fP command-line options do not allow the
+Note that the \fB\-\-include\fP/\fB\-\-exclude\fP command-line options do not allow the
 full range of rule parsing as described above -- they only allow the
 specification of include/exclude patterns plus a "!" token to clear the
 list (and the normal comment parsing when rules are read from a file)\&.
 If a pattern
-does not begin with "- " (dash, space) or "+ " (plus, space), then the
-rule will be interpreted as if "+ " (for an include option) or "- " (for
-an exclude option) were prefixed to the string\&.  A \fB--filter\fP option, on
+does not begin with "\- " (dash, space) or "+ " (plus, space), then the
+rule will be interpreted as if "+ " (for an include option) or "\- " (for
+an exclude option) were prefixed to the string\&.  A \fB\-\-filter\fP option, on
 the other hand, must always contain either a short or long rule name at the
 start of the rule\&.
 .PP 
-Note also that the \fB--filter\fP, \fB--include\fP, and \fB--exclude\fP options take one
+Note also that the \fB\-\-filter\fP, \fB\-\-include\fP, and \fB\-\-exclude\fP options take one
 rule/pattern each\&. To add multiple ones, you can repeat the options on
-the command-line, use the merge-file syntax of the \fB--filter\fP option, or
-the \fB--include-from\fP/\fB--exclude-from\fP options\&.
+the command-line, use the merge-file syntax of the \fB\-\-filter\fP option, or
+the \fB\-\-include\-from\fP/\fB\-\-exclude\-from\fP options\&.
 .PP 
-.SH "INCLUDE/EXCLUDE PATTERN RULES" 
+.SH "INCLUDE/EXCLUDE PATTERN RULES"
+
 .PP 
 You can include and exclude files by specifying patterns using the "+",
-"-", etc\&. filter rules (as introduced in the FILTER RULES section above)\&.
+"\-", etc\&. filter rules (as introduced in the FILTER RULES section above)\&.
 The include/exclude rules each specify a pattern that is matched against
 the names of the files that are going to be transferred\&.  These patterns
 can take several forms:
 .PP 
 .IP o 
 if the pattern starts with a / then it is anchored to a
@@ -2165,13 +2265,13 @@
 a \&'*\&' matches any non-empty path component (it stops at slashes)\&.
 .IP o 
 use \&'**\&' to match anything, including slashes\&.
 .IP o 
 a \&'?\&' matches any character except a slash (/)\&.
 .IP o 
-a \&'[\&' introduces a character class, such as [a-z] or [[:alpha:]]\&.
+a \&'[\&' introduces a character class, such as [a\-z] or [[:alpha:]]\&.
 .IP o 
 in a wildcard pattern, a backslash can be used to escape a wildcard
 character, but it is matched literally when no wildcards are present\&.
 .IP o 
 if the pattern contains a / (not counting a trailing /) or a "**",
 then it is matched against the full pathname, including any leading
@@ -2182,81 +2282,86 @@
 down\&.)
 .IP o 
 a trailing "dir_name/***" will match both the directory (as if
 "dir_name/" had been specified) and all the files in the directory
 (as if "dir_name/**" had been specified)\&.  (This behavior is new for
 version 2\&.6\&.7\&.)
+
 .PP 
-Note that, when using the \fB--recursive\fP (\fB-r\fP) option (which is implied by
-\fB-a\fP), every subcomponent of every path is visited from the top down, so
+Note that, when using the \fB\-\-recursive\fP (\fB\-r\fP) option (which is implied by
+\fB\-a\fP), every subcomponent of every path is visited from the top down, so
 include/exclude patterns get applied recursively to each subcomponent\&'s
 full name (e\&.g\&. to include "/foo/bar/baz" the subcomponents "/foo" and
 "/foo/bar" must not be excluded)\&.
 The exclude patterns actually short-circuit the directory traversal stage
 when rsync finds the files to send\&.  If a pattern excludes a particular
 parent directory, it can render a deeper include pattern ineffectual
 because rsync did not descend through that excluded section of the
 hierarchy\&.  This is particularly important when using a trailing \&'*\&' rule\&.
 For instance, this won\&'t work:
 .PP 
 .RS 
-\f(CW+ /some/path/this-file-will-not-be-found\fP
+\f(CW+ /some/path/this\-file\-will\-not\-be\-found\fP
 .br 
-\f(CW+ /file-is-included\fP
+\f(CW+ /file\-is\-included\fP
 .br 
-\f(CW- *\fP
+\f(CW\- *\fP
 .br 
-.RE 
+.RE
+
 .PP 
 This fails because the parent directory "some" is excluded by the \&'*\&'
 rule, so rsync never visits any of the files in the "some" or "some/path"
 directories\&.  One solution is to ask for all directories in the hierarchy
 to be included by using a single rule: "+ */" (put it somewhere before the
-"- *" rule), and perhaps use the \fB--prune-empty-dirs\fP option\&.  Another
+"\- *" rule), and perhaps use the \fB\-\-prune\-empty\-dirs\fP option\&.  Another
 solution is to add specific include rules for all
 the parent dirs that need to be visited\&.  For instance, this set of rules
 works fine:
 .PP 
 .RS 
 \f(CW+ /some/\fP
 .br 
 \f(CW+ /some/path/\fP
 .br 
-\f(CW+ /some/path/this-file-is-found\fP
+\f(CW+ /some/path/this\-file\-is\-found\fP
 .br 
-\f(CW+ /file-also-included\fP
+\f(CW+ /file\-also\-included\fP
 .br 
-\f(CW- *\fP
+\f(CW\- *\fP
 .br 
-.RE 
+.RE
+
 .PP 
 Here are some examples of exclude/include matching:
 .PP 
 .IP o 
-"- *\&.o" would exclude all filenames matching *\&.o
+"\- *\&.o" would exclude all filenames matching *\&.o
 .IP o 
-"- /foo" would exclude a file (or directory) named foo in the
+"\- /foo" would exclude a file (or directory) named foo in the
 transfer-root directory
 .IP o 
-"- foo/" would exclude any directory named foo
+"\- foo/" would exclude any directory named foo
 .IP o 
-"- /foo/*/bar" would exclude any file named bar which is at two
+"\- /foo/*/bar" would exclude any file named bar which is at two
 levels below a directory named foo in the transfer-root directory
 .IP o 
-"- /foo/**/bar" would exclude any file named bar two
+"\- /foo/**/bar" would exclude any file named bar two
 or more levels below a directory named foo in the transfer-root directory
 .IP o 
-The combination of "+ */", "+ *\&.c", and "- *" would include all
+The combination of "+ */", "+ *\&.c", and "\- *" would include all
 directories and C source files but nothing else (see also the
-\fB--prune-empty-dirs\fP option)
+\fB\-\-prune\-empty\-dirs\fP option)
 .IP o 
-The combination of "+ foo/", "+ foo/bar\&.c", and "- *" would include
+The combination of "+ foo/", "+ foo/bar\&.c", and "\- *" would include
 only the foo directory and foo/bar\&.c (the foo directory must be
 explicitly included or it would be excluded by the "*")
+
 .PP 
-.SH "MERGE-FILE FILTER RULES" 
+.SH "MERGE-FILE FILTER RULES"
+
 .PP 
 You can merge whole files into your filter rules by specifying either a
 merge (\&.) or a dir-merge (:) filter rule (as introduced in the FILTER RULES
 section above)\&.
 .PP 
 There are two kinds of merged files -- single-instance (\&'\&.\&') and
@@ -2275,74 +2380,76 @@
 .PP 
 .RS 
 \f(CWmerge /etc/rsync/default\&.rules\fP
 .br 
 \f(CW\&. /etc/rsync/default\&.rules\fP
 .br 
-\f(CWdir-merge \&.per-dir-filter\fP
+\f(CWdir\-merge \&.per\-dir\-filter\fP
 .br 
-\f(CWdir-merge,n- \&.non-inherited-per-dir-excludes\fP
+\f(CWdir\-merge,n\- \&.non\-inherited\-per\-dir\-excludes\fP
 .br 
-\f(CW:n- \&.non-inherited-per-dir-excludes\fP
+\f(CW:n\- \&.non\-inherited\-per\-dir\-excludes\fP
 .br 
-.RE 
+.RE
+
 .PP 
 The following modifiers are accepted after a merge or dir-merge rule:
 .PP 
 .IP o 
-A \fB-\fP specifies that the file should consist of only exclude
+A \fB\-\fP specifies that the file should consist of only exclude
 patterns, with no other rule-parsing except for in-file comments\&.
 .IP o 
 A \fB+\fP specifies that the file should consist of only include
 patterns, with no other rule-parsing except for in-file comments\&.
 .IP o 
 A \fBC\fP is a way to specify that the file should be read in a
-CVS-compatible manner\&.  This turns on \&'n\&', \&'w\&', and \&'-\&', but also
+CVS-compatible manner\&.  This turns on \&'n\&', \&'w\&', and \&'\-\&', but also
 allows the list-clearing token (!) to be specified\&.  If no filename is
 provided, "\&.cvsignore" is assumed\&.
 .IP o 
 A \fBe\fP will exclude the merge-file name from the transfer; e\&.g\&.
-"dir-merge,e \&.rules" is like "dir-merge \&.rules" and "- \&.rules"\&.
+"dir-merge,e \&.rules" is like "dir-merge \&.rules" and "\- \&.rules"\&.
 .IP o 
 An \fBn\fP specifies that the rules are not inherited by subdirectories\&.
 .IP o 
 A \fBw\fP specifies that the rules are word-split on whitespace instead
 of the normal line-splitting\&.  This also turns off comments\&.  Note: the
 space that separates the prefix from the rule is treated specially, so
-"- foo + bar" is parsed as two rules (assuming that prefix-parsing wasn\&'t
+"\- foo + bar" is parsed as two rules (assuming that prefix-parsing wasn\&'t
 also disabled)\&.
 .IP o 
-You may also specify any of the modifiers for the "+" or "-" rules
+You may also specify any of the modifiers for the "+" or "\-" rules
 (below) in order to have the rules that are read in from the file
-default to having that modifier set\&.  For instance, "merge,-/ \&.excl" would
+default to having that modifier set\&.  For instance, "merge,\-/ \&.excl" would
 treat the contents of \&.excl as absolute-path excludes,
 while "dir-merge,s \&.filt" and ":sC" would each make all their
 per-directory rules apply only on the sending side\&.
+
 .PP 
-The following modifiers are accepted after a "+" or "-":
+The following modifiers are accepted after a "+" or "\-":
 .PP 
 .IP o 
 A "/" specifies that the include/exclude rule should be matched
 against the absolute pathname of the current item\&.  For example,
-"-/ /etc/passwd" would exclude the passwd file any time the transfer
-was sending files from the "/etc" directory, and "-/ subdir/foo"
+"\-/ /etc/passwd" would exclude the passwd file any time the transfer
+was sending files from the "/etc" directory, and "\-/ subdir/foo"
 would always exclude "foo" when it is in a dir named "subdir", even
 if "foo" is at the root of the current transfer\&.
 .IP o 
 A "!" specifies that the include/exclude should take effect if
-the pattern fails to match\&.  For instance, "-! */" would exclude all
+the pattern fails to match\&.  For instance, "\-! */" would exclude all
 non-directories\&.
 .IP o 
 A \fBC\fP is used to indicate that all the global CVS-exclude rules
-should be inserted as excludes in place of the "-C"\&.  No arg should
+should be inserted as excludes in place of the "\-C"\&.  No arg should
 follow\&.
 .IP o 
 An \fBs\fP is used to indicate that the rule applies to the sending
 side\&.  When a rule affects the sending side, it prevents files from
 being transferred\&.  The default is for a rule to affect both sides
-unless \fB--delete-excluded\fP was specified, in which case default rules
+unless \fB\-\-delete\-excluded\fP was specified, in which case default rules
 become sender-side only\&.  See also the hide (H) and show (S) rules,
 which are an alternate way to specify sending-side includes/excludes\&.
 .IP o 
 An \fBr\fP is used to indicate that the rule applies to the receiving
 side\&.  When a rule affects the receiving side, it prevents files from
 being deleted\&.  See the \fBs\fP modifier for more info\&.  See also the
@@ -2362,207 +2470,220 @@
 Another way to prevent a single rule from a dir-merge file from being inherited is to
 anchor it with a leading slash\&.  Anchored rules in a per-directory
 merge-file are relative to the merge-file\&'s directory, so a pattern "/foo"
 would only match the file "foo" in the directory where the dir-merge filter
 file was found\&.
 .PP 
-Here\&'s an example filter file which you\&'d specify via \fB--filter="\&. file":\fP
+Here\&'s an example filter file which you\&'d specify via \fB\-\-filter="\&. file":\fP
 .PP 
 .RS 
-\f(CWmerge /home/user/\&.global-filter\fP
+\f(CWmerge /home/user/\&.global\-filter\fP
 .br 
-\f(CW- *\&.gz\fP
+\f(CW\- *\&.gz\fP
 .br 
-\f(CWdir-merge \&.rules\fP
+\f(CWdir\-merge \&.rules\fP
 .br 
 \f(CW+ *\&.[ch]\fP
 .br 
-\f(CW- *\&.o\fP
+\f(CW\- *\&.o\fP
 .br 
-.RE 
+.RE
+
 .PP 
-This will merge the contents of the /home/user/\&.global-filter file at the
+This will merge the contents of the /home/user/\&.global\-filter file at the
 start of the list and also turns the "\&.rules" filename into a per-directory
 filter file\&.  All rules read in prior to the start of the directory scan
 follow the global anchoring rules (i\&.e\&. a leading slash matches at the root
 of the transfer)\&.
 .PP 
 If a per-directory merge-file is specified with a path that is a parent
 directory of the first transfer directory, rsync will scan all the parent
 dirs from that starting point to the transfer directory for the indicated
-per-directory file\&.  For instance, here is a common filter (see \fB-F\fP):
+per-directory file\&.  For instance, here is a common filter (see \fB\-F\fP):
 .PP 
 .RS 
-\f(CW--filter=\&': /\&.rsync-filter\&'\fP
-.RE 
+\f(CW\-\-filter=\&': /\&.rsync\-filter\&'\fP
+.RE
+
 .PP 
-That rule tells rsync to scan for the file \&.rsync-filter in all
+That rule tells rsync to scan for the file \&.rsync\-filter in all
 directories from the root down through the parent directory of the
 transfer prior to the start of the normal directory scan of the file in
 the directories that are sent as a part of the transfer\&.  (Note: for an
 rsync daemon, the root is always the same as the module\&'s "path"\&.)
 .PP 
 Some examples of this pre-scanning for per-directory files:
 .PP 
 .RS 
-\f(CWrsync -avF /src/path/ /dest/dir\fP
+\f(CWrsync \-avF /src/path/ /dest/dir\fP
 .br 
-\f(CWrsync -av --filter=\&': \&.\&./\&.\&./\&.rsync-filter\&' /src/path/ /dest/dir\fP
+\f(CWrsync \-av \-\-filter=\&': \&.\&./\&.\&./\&.rsync\-filter\&' /src/path/ /dest/dir\fP
 .br 
-\f(CWrsync -av --filter=\&': \&.rsync-filter\&' /src/path/ /dest/dir\fP
+\f(CWrsync \-av \-\-filter=\&': \&.rsync\-filter\&' /src/path/ /dest/dir\fP
 .br 
-.RE 
+.RE
+
 .PP 
-The first two commands above will look for "\&.rsync-filter" in "/" and
+The first two commands above will look for "\&.rsync\-filter" in "/" and
 "/src" before the normal scan begins looking for the file in "/src/path"
 and its subdirectories\&.  The last command avoids the parent-dir scan
-and only looks for the "\&.rsync-filter" files in each directory that is
+and only looks for the "\&.rsync\-filter" files in each directory that is
 a part of the transfer\&.
 .PP 
 If you want to include the contents of a "\&.cvsignore" in your patterns,
 you should use the rule ":C", which creates a dir-merge of the \&.cvsignore
 file, but parsed in a CVS-compatible manner\&.  You can
-use this to affect where the \fB--cvs-exclude\fP (\fB-C\fP) option\&'s inclusion of the
+use this to affect where the \fB\-\-cvs\-exclude\fP (\fB\-C\fP) option\&'s inclusion of the
 per-directory \&.cvsignore file gets placed into your rules by putting the
 ":C" wherever you like in your filter rules\&.  Without this, rsync would
 add the dir-merge rule for the \&.cvsignore file at the end of all your other
 rules (giving it a lower priority than your command-line rules)\&.  For
 example:
 .PP 
 .RS 
-\f(CWcat <<EOT | rsync -avC --filter=\&'\&. -\&' a/ b\fP
+\f(CWcat <<EOT | rsync \-avC \-\-filter=\&'\&. \-\&' a/ b\fP
 .br 
 \f(CW+ foo\&.o\fP
 .br 
 \f(CW:C\fP
 .br 
-\f(CW- *\&.old\fP
+\f(CW\- *\&.old\fP
 .br 
 \f(CWEOT\fP
 .br 
-\f(CWrsync -avC --include=foo\&.o -f :C --exclude=\&'*\&.old\&' a/ b\fP
+\f(CWrsync \-avC \-\-include=foo\&.o \-f :C \-\-exclude=\&'*\&.old\&' a/ b\fP
 .br 
-.RE 
+.RE
+
 .PP 
 Both of the above rsync commands are identical\&.  Each one will merge all
 the per-directory \&.cvsignore rules in the middle of the list rather than
 at the end\&.  This allows their dir-specific rules to supersede the rules
 that follow the :C instead of being subservient to all your rules\&.  To
 affect the other CVS exclude rules (i\&.e\&. the default list of exclusions,
 the contents of $HOME/\&.cvsignore, and the value of $CVSIGNORE) you should
-omit the \fB-C\fP command-line option and instead insert a "-C" rule into
-your filter rules; e\&.g\&. "--filter=-C"\&.
+omit the \fB\-C\fP command-line option and instead insert a "\-C" rule into
+your filter rules; e\&.g\&. "\-\-filter=\-C"\&.
 .PP 
-.SH "LIST-CLEARING FILTER RULE" 
+.SH "LIST-CLEARING FILTER RULE"
+
 .PP 
 You can clear the current include/exclude list by using the "!" filter
 rule (as introduced in the FILTER RULES section above)\&.  The "current"
 list is either the global list of rules (if the rule is encountered while
 parsing the filter options) or a set of per-directory rules (which are
 inherited in their own sub-list, so a subdirectory can use this to clear
 out the parent\&'s rules)\&.
 .PP 
-.SH "ANCHORING INCLUDE/EXCLUDE PATTERNS" 
+.SH "ANCHORING INCLUDE/EXCLUDE PATTERNS"
+
 .PP 
 As mentioned earlier, global include/exclude patterns are anchored at the
 "root of the transfer" (as opposed to per-directory patterns, which are
 anchored at the merge-file\&'s directory)\&.  If you think of the transfer as
 a subtree of names that are being sent from sender to receiver, the
 transfer-root is where the tree starts to be duplicated in the destination
 directory\&.  This root governs where patterns that start with a / match\&.
 .PP 
 Because the matching is relative to the transfer-root, changing the
-trailing slash on a source path or changing your use of the \fB--relative\fP
+trailing slash on a source path or changing your use of the \fB\-\-relative\fP
 option affects the path you need to use in your matching (in addition to
 changing how much of the file tree is duplicated on the destination
 host)\&.  The following examples demonstrate this\&.
 .PP 
 Let\&'s say that we want to match two source files, one with an absolute
 path of "/home/me/foo/bar", and one with a path of "/home/you/bar/baz"\&.
 Here is how the various command choices differ for a 2-source transfer:
 .PP 
 .RS 
-Example cmd: rsync -a /home/me /home/you /dest 
+Example cmd: rsync \-a /home/me /home/you /dest 
 .br 
-+/- pattern: /me/foo/bar 
++/\- pattern: /me/foo/bar 
 .br 
-+/- pattern: /you/bar/baz 
++/\- pattern: /you/bar/baz 
 .br 
 Target file: /dest/me/foo/bar 
 .br 
 Target file: /dest/you/bar/baz 
 .br 
-.RE 
+.RE
+
 .PP 
 .RS 
-Example cmd: rsync -a /home/me/ /home/you/ /dest 
+Example cmd: rsync \-a /home/me/ /home/you/ /dest 
 .br 
-+/- pattern: /foo/bar               (note missing "me") 
++/\- pattern: /foo/bar               (note missing "me") 
 .br 
-+/- pattern: /bar/baz               (note missing "you") 
++/\- pattern: /bar/baz               (note missing "you") 
 .br 
 Target file: /dest/foo/bar 
 .br 
 Target file: /dest/bar/baz 
 .br 
-.RE 
+.RE
+
 .PP 
 .RS 
-Example cmd: rsync -a --relative /home/me/ /home/you /dest 
+Example cmd: rsync \-a \-\-relative /home/me/ /home/you /dest 
 .br 
-+/- pattern: /home/me/foo/bar       (note full path) 
++/\- pattern: /home/me/foo/bar       (note full path) 
 .br 
-+/- pattern: /home/you/bar/baz      (ditto) 
++/\- pattern: /home/you/bar/baz      (ditto) 
 .br 
 Target file: /dest/home/me/foo/bar 
 .br 
 Target file: /dest/home/you/bar/baz 
 .br 
-.RE 
+.RE
+
 .PP 
 .RS 
-Example cmd: cd /home; rsync -a --relative me/foo you/ /dest 
+Example cmd: cd /home; rsync \-a \-\-relative me/foo you/ /dest 
 .br 
-+/- pattern: /me/foo/bar      (starts at specified path) 
++/\- pattern: /me/foo/bar      (starts at specified path) 
 .br 
-+/- pattern: /you/bar/baz     (ditto) 
++/\- pattern: /you/bar/baz     (ditto) 
 .br 
 Target file: /dest/me/foo/bar 
 .br 
 Target file: /dest/you/bar/baz 
 .br 
-.RE 
+.RE
+
 .PP 
 The easiest way to see what name you should filter is to just
-look at the output when using \fB--verbose\fP and put a / in front of the name
-(use the \fB--dry-run\fP option if you\&'re not yet ready to copy any files)\&.
+look at the output when using \fB\-\-verbose\fP and put a / in front of the name
+(use the \fB\-\-dry\-run\fP option if you\&'re not yet ready to copy any files)\&.
 .PP 
-.SH "PER-DIRECTORY RULES AND DELETE" 
+.SH "PER-DIRECTORY RULES AND DELETE"
+
 .PP 
 Without a delete option, per-directory rules are only relevant on the
 sending side, so you can feel free to exclude the merge files themselves
 without affecting the transfer\&.  To make this easy, the \&'e\&' modifier adds
 this exclude for you, as seen in these two equivalent commands:
 .PP 
 .RS 
-\f(CWrsync -av --filter=\&': \&.excl\&' --exclude=\&.excl host:src/dir /dest\fP
+\f(CWrsync \-av \-\-filter=\&': \&.excl\&' \-\-exclude=\&.excl host:src/dir /dest\fP
 .br 
-\f(CWrsync -av --filter=\&':e \&.excl\&' host:src/dir /dest\fP
+\f(CWrsync \-av \-\-filter=\&':e \&.excl\&' host:src/dir /dest\fP
 .br 
-.RE 
+.RE
+
 .PP 
 However, if you want to do a delete on the receiving side AND you want some
 files to be excluded from being deleted, you\&'ll need to be sure that the
 receiving side knows what files to exclude\&.  The easiest way is to include
-the per-directory merge files in the transfer and use \fB--delete-after\fP,
+the per-directory merge files in the transfer and use \fB\-\-delete\-after\fP,
 because this ensures that the receiving side gets all the same exclude
 rules as the sending side before it tries to delete anything:
 .PP 
 .RS 
-\f(CWrsync -avF --delete-after host:src/dir /dest\fP
-.RE 
+\f(CWrsync \-avF \-\-delete\-after host:src/dir /dest\fP
+.RE
+
 .PP 
 However, if the merge files are not a part of the transfer, you\&'ll need to
 either specify some global exclude rules (i\&.e\&. specified on the command
 line), or you\&'ll need to maintain your own per-directory merge files on
 the receiving side\&.  An example of the first is this (assume that the
 remote \&.rules files exclude themselves):
@@ -2564,44 +2685,39 @@
 However, if the merge files are not a part of the transfer, you\&'ll need to
 either specify some global exclude rules (i\&.e\&. specified on the command
 line), or you\&'ll need to maintain your own per-directory merge files on
 the receiving side\&.  An example of the first is this (assume that the
 remote \&.rules files exclude themselves):
 .PP 
-
 .nf 
- 
-rsync -av --filter=\&': \&.rules\&' --filter=\&'\&. /my/extra\&.rules\&'
-   --delete host:src/dir /dest
+rsync \-av \-\-filter=\&': \&.rules\&' \-\-filter=\&'\&. /my/extra\&.rules\&'
+   \-\-delete host:src/dir /dest
 .fi 
- 
 
 .PP 
 In the above example the extra\&.rules file can affect both sides of the
 transfer, but (on the sending side) the rules are subservient to the rules
 merged from the \&.rules files because they were specified after the
 per-directory merge rule\&.
 .PP 
-In one final example, the remote side is excluding the \&.rsync-filter
-files from the transfer, but we want to use our own \&.rsync-filter files
+In one final example, the remote side is excluding the \&.rsync\-filter
+files from the transfer, but we want to use our own \&.rsync\-filter files
 to control what gets deleted on the receiving side\&.  To do this we must
 specifically exclude the per-directory merge files (so that they don\&'t get
 deleted) and then put rules into the local files to control what else
 should not get deleted\&.  Like one of these commands:
 .PP 
-
 .nf 
- 
-    rsync -av --filter=\&':e /\&.rsync-filter\&' --delete \e 
+    rsync \-av \-\-filter=\&':e /\&.rsync\-filter\&' \-\-delete \e 
         host:src/dir /dest
-    rsync -avFF --delete host:src/dir /dest
+    rsync \-avFF \-\-delete host:src/dir /dest
 .fi 
- 
 
 .PP 
-.SH "BATCH MODE" 
+.SH "BATCH MODE"
+
 .PP 
 Batch mode can be used to apply the same set of updates to many
 identical systems\&. Suppose one has a tree which is replicated on a
 number of hosts\&.  Now suppose some changes have been made to this
 source tree and those changes need to be propagated to the other
 hosts\&. In order to do this using batch mode, rsync is run with the
@@ -2631,26 +2747,28 @@
 be used to transfer the batch update files in parallel to many hosts
 at once, instead of sending the same data to every host individually\&.
 .PP 
 Examples:
 .PP 
 .RS 
-\f(CW$ rsync --write-batch=foo -a host:/source/dir/ /adest/dir/\fP
+\f(CW$ rsync \-\-write\-batch=foo \-a host:/source/dir/ /adest/dir/\fP
 .br 
 \f(CW$ scp foo* remote:\fP
 .br 
 \f(CW$ ssh remote \&./foo\&.sh /bdest/dir/\fP
 .br 
-.RE 
+.RE
+
 .PP 
 .RS 
-\f(CW$ rsync --write-batch=foo -a /source/dir/ /adest/dir/\fP
+\f(CW$ rsync \-\-write\-batch=foo \-a /source/dir/ /adest/dir/\fP
 .br 
-\f(CW$ ssh remote rsync --read-batch=- -a /bdest/dir/ <foo\fP
+\f(CW$ ssh remote rsync \-\-read\-batch=\- \-a /bdest/dir/ <foo\fP
 .br 
-.RE 
+.RE
+
 .PP 
 In these examples, rsync is used to update /adest/dir/ from /source/dir/
 and the information to repeat this operation is stored in "foo" and
 "foo\&.sh"\&.  The host "remote" is then updated with the batched data going
 into the directory /bdest/dir\&.  The differences between the two examples
 reveals some of the flexibility you have in how you deal with batches:
@@ -2663,237 +2781,262 @@
 The first example uses the created "foo\&.sh" file to get the right
 rsync options when running the read-batch command on the remote host\&.
 .IP o 
 The second example reads the batch data via standard input so that
 the batch file doesn\&'t need to be copied to the remote machine first\&.
 This example avoids the foo\&.sh script because it needed to use a modified
-\fB--read-batch\fP option, but you could edit the script file if you wished to
+\fB\-\-read\-batch\fP option, but you could edit the script file if you wished to
 make use of it (just be sure that no other option is trying to use
-standard input, such as the "\fB--exclude-from=-\fP" option)\&.
+standard input, such as the "\fB\-\-exclude\-from=\-\fP" option)\&.
+
 .PP 
 Caveats:
 .PP 
 The read-batch option expects the destination tree that it is updating
 to be identical to the destination tree that was used to create the
 batch update fileset\&.  When a difference between the destination trees
 is encountered the update might be discarded with a warning (if the file
 appears to be up-to-date already) or the file-update may be attempted
 and then, if the file fails to verify, the update discarded with an
 error\&.  This means that it should be safe to re-run a read-batch operation
 if the command got interrupted\&.  If you wish to force the batched-update to
-always be attempted regardless of the file\&'s size and date, use the \fB-I\fP
+always be attempted regardless of the file\&'s size and date, use the \fB\-I\fP
 option (when reading the batch)\&.
 If an error occurs, the destination tree will probably be in a
 partially updated state\&. In that case, rsync can
 be used in its regular (non-batch) mode of operation to fix up the
 destination tree\&.
 .PP 
 The rsync version used on all destinations must be at least as new as the
 one used to generate the batch file\&.  Rsync will die with an error if the
 protocol version in the batch file is too new for the batch-reading rsync
-to handle\&.  See also the \fB--protocol\fP option for a way to have the
+to handle\&.  See also the \fB\-\-protocol\fP option for a way to have the
 creating rsync generate a batch file that an older rsync can understand\&.
 (Note that batch files changed format in version 2\&.6\&.3, so mixing versions
 older than that with newer versions will not work\&.)
 .PP 
 When reading a batch file, rsync will force the value of certain options
 to match the data in the batch file if you didn\&'t set them to the same
 as the batch-writing command\&.  Other options can (and should) be changed\&.
-For instance \fB--write-batch\fP changes to \fB--read-batch\fP,
-\fB--files-from\fP is dropped, and the
-\fB--filter\fP/\fB--include\fP/\fB--exclude\fP options are not needed unless
-one of the \fB--delete\fP options is specified\&.
+For instance \fB\-\-write\-batch\fP changes to \fB\-\-read\-batch\fP,
+\fB\-\-files\-from\fP is dropped, and the
+\fB\-\-filter\fP/\fB\-\-include\fP/\fB\-\-exclude\fP options are not needed unless
+one of the \fB\-\-delete\fP options is specified\&.
 .PP 
 The code that creates the BATCH\&.sh file transforms any filter/include/exclude
 options into a single list that is appended as a "here" document to the
 shell script file\&.  An advanced user can use this to modify the exclude
-list if a change in what gets deleted by \fB--delete\fP is desired\&.  A normal
+list if a change in what gets deleted by \fB\-\-delete\fP is desired\&.  A normal
 user can ignore this detail and just use the shell script as an easy way
-to run the appropriate \fB--read-batch\fP command for the batched data\&.
+to run the appropriate \fB\-\-read\-batch\fP command for the batched data\&.
 .PP 
 The original batch mode in rsync was based on "rsync+", but the latest
 version uses a new implementation\&.
 .PP 
-.SH "SYMBOLIC LINKS" 
+.SH "SYMBOLIC LINKS"
+
 .PP 
 Three basic behaviors are possible when rsync encounters a symbolic
 link in the source directory\&.
 .PP 
 By default, symbolic links are not transferred at all\&.  A message
 "skipping non-regular" file is emitted for any symlinks that exist\&.
 .PP 
-If \fB--links\fP is specified, then symlinks are recreated with the same
-target on the destination\&.  Note that \fB--archive\fP implies
-\fB--links\fP\&.
+If \fB\-\-links\fP is specified, then symlinks are recreated with the same
+target on the destination\&.  Note that \fB\-\-archive\fP implies
+\fB\-\-links\fP\&.
 .PP 
-If \fB--copy-links\fP is specified, then symlinks are "collapsed" by
+If \fB\-\-copy\-links\fP is specified, then symlinks are "collapsed" by
 copying their referent, rather than the symlink\&.
 .PP 
 rsync also distinguishes "safe" and "unsafe" symbolic links\&.  An
 example where this might be used is a web site mirror that wishes
 ensure the rsync module they copy does not include symbolic links to
 \fB/etc/passwd\fP in the public section of the site\&.  Using
-\fB--copy-unsafe-links\fP will cause any links to be copied as the file
-they point to on the destination\&.  Using \fB--safe-links\fP will cause
+\fB\-\-copy\-unsafe\-links\fP will cause any links to be copied as the file
+they point to on the destination\&.  Using \fB\-\-safe\-links\fP will cause
 unsafe links to be omitted altogether\&.  (Note that you must specify
-\fB--links\fP for \fB--safe-links\fP to have any effect\&.)
+\fB\-\-links\fP for \fB\-\-safe\-links\fP to have any effect\&.)
 .PP 
 Symbolic links are considered unsafe if they are absolute symlinks
 (start with \fB/\fP), empty, or if they contain enough \fB"\&.\&."\fP
 components to ascend from the directory being copied\&.
 .PP 
 Here\&'s a summary of how the symlink options are interpreted\&.  The list is
 in order of precedence, so if your combination of options isn\&'t mentioned,
 use the first line that is a complete subset of your options:
 .PP 
-.IP "\fB--copy-links\fP" 
+.IP "\fB\-\-copy\-links\fP"
 Turn all symlinks into normal files (leaving no
 symlinks for any other options to affect)\&.
 .PP 
-.IP "\fB--links --copy-unsafe-links\fP" 
+.IP "\fB\-\-links \-\-copy\-unsafe\-links\fP"
 Turn all unsafe symlinks into files
 and duplicate all safe symlinks\&.
 .PP 
-.IP "\fB--copy-unsafe-links\fP" 
+.IP "\fB\-\-copy\-unsafe\-links\fP"
 Turn all unsafe symlinks into files, noisily
 skip all safe symlinks\&.
 .PP 
-.IP "\fB--links --safe-links\fP" 
+.IP "\fB\-\-links \-\-safe\-links\fP"
 Duplicate safe symlinks and skip unsafe
 ones\&.
 .PP 
-.IP "\fB--links\fP" 
+.IP "\fB\-\-links\fP"
 Duplicate all symlinks\&.
 .PP 
-.SH "DIAGNOSTICS" 
+.SH "DIAGNOSTICS"
+
 .PP 
 rsync occasionally produces error messages that may seem a little
 cryptic\&. The one that seems to cause the most confusion is "protocol
 version mismatch -- is your shell clean?"\&.
 .PP 
 This message is usually caused by your startup scripts or remote shell
 facility producing unwanted garbage on the stream that rsync is using
 for its transport\&. The way to diagnose this problem is to run your
 remote shell like this:
 .PP 
 .RS 
 \f(CWssh remotehost /bin/true > out\&.dat\fP
-.RE 
+.RE
+
 .PP 
 then look at out\&.dat\&. If everything is working correctly then out\&.dat
 should be a zero length file\&. If you are getting the above error from
 rsync then you will probably find that out\&.dat contains some text or
 data\&. Look at the contents and try to work out what is producing
 it\&. The most common cause is incorrectly configured shell startup
 scripts (such as \&.cshrc or \&.profile) that contain output statements
 for non-interactive logins\&.
 .PP 
 If you are having trouble debugging filter patterns, then
-try specifying the \fB-vv\fP option\&.  At this level of verbosity rsync will
+try specifying the \fB\-vv\fP option\&.  At this level of verbosity rsync will
 show why each individual file is included or excluded\&.
 .PP 
-.SH "EXIT VALUES" 
+.SH "EXIT VALUES"
+
 .PP 
-.IP "\fB0\fP" 
+.IP "\fB0\fP"
 Success
-.IP "\fB1\fP" 
+.IP "\fB1\fP"
 Syntax or usage error
-.IP "\fB2\fP" 
+.IP "\fB2\fP"
 Protocol incompatibility
-.IP "\fB3\fP" 
+.IP "\fB3\fP"
 Errors selecting input/output files, dirs
-.IP "\fB4\fP" 
+.IP "\fB4\fP"
 Requested action not supported: an attempt
 was made to manipulate 64-bit files on a platform that cannot support
 them; or an option was specified that is supported by the client and
 not by the server\&.
-.IP "\fB5\fP" 
+.IP "\fB5\fP"
 Error starting client-server protocol
-.IP "\fB6\fP" 
+.IP "\fB6\fP"
 Daemon unable to append to log-file
-.IP "\fB10\fP" 
+.IP "\fB10\fP"
 Error in socket I/O
-.IP "\fB11\fP" 
+.IP "\fB11\fP"
 Error in file I/O
-.IP "\fB12\fP" 
+.IP "\fB12\fP"
 Error in rsync protocol data stream
-.IP "\fB13\fP" 
+.IP "\fB13\fP"
 Errors with program diagnostics
-.IP "\fB14\fP" 
+.IP "\fB14\fP"
 Error in IPC code
-.IP "\fB20\fP" 
+.IP "\fB20\fP"
 Received SIGUSR1 or SIGINT
-.IP "\fB21\fP" 
-Some error returned by \f(CWwaitpid()\fP
-.IP "\fB22\fP" 
+.IP "\fB21\fP"
+Some error returned by 
+\f(CWwaitpid()\fP
+.IP "\fB22\fP"
 Error allocating core memory buffers
-.IP "\fB23\fP" 
+.IP "\fB23\fP"
 Partial transfer due to error
-.IP "\fB24\fP" 
+.IP "\fB24\fP"
 Partial transfer due to vanished source files
-.IP "\fB25\fP" 
-The --max-delete limit stopped deletions
-.IP "\fB30\fP" 
+.IP "\fB25\fP"
+The \-\-max\-delete limit stopped deletions
+.IP "\fB30\fP"
 Timeout in data send/receive
+
 .PP 
-.SH "ENVIRONMENT VARIABLES" 
+.SH "ENVIRONMENT VARIABLES"
+
 .PP 
-.IP "\fBCVSIGNORE\fP" 
+.IP "\fBCVSIGNORE\fP"
 The CVSIGNORE environment variable supplements any
-ignore patterns in \&.cvsignore files\&. See the \fB--cvs-exclude\fP option for
+ignore patterns in \&.cvsignore files\&. See the \fB\-\-cvs\-exclude\fP option for
 more details\&.
-.IP "\fBRSYNC_RSH\fP" 
+.IP "\fBRSYNC_RSH\fP"
 The RSYNC_RSH environment variable allows you to
 override the default shell used as the transport for rsync\&.  Command line
-options are permitted after the command name, just as in the \fB-e\fP option\&.
-.IP "\fBRSYNC_PROXY\fP" 
+options are permitted after the command name, just as in the \fB\-e\fP option\&.
+.IP "\fBRSYNC_PROXY\fP"
 The RSYNC_PROXY environment variable allows you to
 redirect your rsync client to use a web proxy when connecting to a
 rsync daemon\&. You should set RSYNC_PROXY to a hostname:port pair\&.
-.IP "\fBRSYNC_PASSWORD\fP" 
+.IP "\fBRSYNC_PASSWORD\fP"
 Setting RSYNC_PASSWORD to the required
 password allows you to run authenticated rsync connections to an rsync
 daemon without user intervention\&. Note that this does not supply a
 password to a shell transport such as ssh\&.
-.IP "\fBUSER\fP or \fBLOGNAME\fP" 
+.IP "\fBUSER\fP or \fBLOGNAME\fP"
 The USER or LOGNAME environment variables
 are used to determine the default username sent to an rsync daemon\&.
 If neither is set, the username defaults to "nobody"\&.
-.IP "\fBHOME\fP" 
+.IP "\fBHOME\fP"
 The HOME environment variable is used to find the user\&'s
 default \&.cvsignore file\&.
+
 .PP 
-.SH "FILES" 
+.SH "FILES"
+
 .PP 
 /etc/rsyncd\&.conf or rsyncd\&.conf
 .PP 
-.SH "SEE ALSO" 
+.SH "SEE ALSO"
+
 .PP 
 \fBrsyncd\&.conf\fP(5)
 .PP 
-.SH "BUGS" 
+.SH "BUGS"
+
 .PP 
 times are transferred as *nix time_t values
 .PP 
 When transferring to FAT filesystems rsync may re-sync
 unmodified files\&.
-See the comments on the \fB--modify-window\fP option\&.
+See the comments on the \fB\-\-modify\-window\fP option\&.
 .PP 
 file permissions, devices, etc\&. are transferred as native numerical
 values
 .PP 
-see also the comments on the \fB--delete\fP option
+see also the comments on the \fB\-\-delete\fP option
 .PP 
 Please report bugs! See the website at
 http://rsync\&.samba\&.org/
 .PP 
-.SH "VERSION" 
+.SH "VERSION"
+
+.PP 
+This man page is current for version 2\&.6\&.9 of rsync\&.
 .PP 
-This man page is current for version 2\&.6\&.8 of rsync\&.
+.SH "INTERNAL OPTIONS"
+
 .PP 
-.SH "CREDITS" 
+The options \fB\-\-server\fP and \fB\-\-sender\fP are used internally by rsync,
+and should never be typed by a user under normal circumstances\&.  Some
+awareness of these options may be needed in certain scenarios, such as
+when setting up a login that can only run an rsync command\&.  For instance,
+the support directory of the rsync distribution has an example script
+named rrsync (for restricted rsync) that can be used with a restricted
+ssh login\&.
+.PP 
+.SH "CREDITS"
+
 .PP 
 rsync is distributed under the GNU public license\&.  See the file
 COPYING for details\&.
 .PP 
 A WEB site is available at
 http://rsync\&.samba\&.org/\&.  The site
@@ -2905,22 +3048,24 @@
 .PP 
 We would be delighted to hear from you if you like this program\&.
 .PP 
 This program uses the excellent zlib compression library written by
 Jean-loup Gailly and Mark Adler\&.
 .PP 
-.SH "THANKS" 
+.SH "THANKS"
+
 .PP 
 Thanks to Richard Brent, Brendan Mackay, Bill Waite, Stephen Rothwell
 and David Bell for helpful suggestions, patches and testing of rsync\&.
 I\&'ve probably missed some people, my apologies if I have\&.
 .PP 
 Especial thanks also to: David Dykstra, Jos Backus, Sebastian Krahmer,
 Martin Pool, Wayne Davison, J\&.W\&. Schultz\&.
 .PP 
-.SH "AUTHOR" 
+.SH "AUTHOR"
+
 .PP 
 rsync was originally written by Andrew Tridgell and Paul Mackerras\&.
 Many people have later contributed to it\&.
 .PP 
 Mailing lists for support and development are available at
 http://lists\&.samba\&.org
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.c	2006-02-24 09:56:26.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.c	2006-10-09 06:02:13.000000000 +0800
@@ -1,27 +1,27 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/* this file contains code used by more than one part of the rsync
-   process */
+ * Routines common to more than one of the rsync processes.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 #if defined HAVE_ICONV_OPEN && defined HAVE_ICONV_H
 #include <iconv.h>
 #endif
 #if defined HAVE_LIBCHARSET_H && defined HAVE_LOCALE_CHARSET
@@ -29,13 +29,12 @@
 #elif defined HAVE_LANGINFO_H && defined HAVE_NL_LANGINFO
 #include <langinfo.h>
 #endif
 
 extern int verbose;
 extern int dry_run;
-extern int daemon_log_format_has_i;
 extern int preserve_perms;
 extern int preserve_executability;
 extern int preserve_times;
 extern int omit_dir_times;
 extern int am_root;
 extern int am_server;
@@ -98,54 +97,57 @@
 	if (s->sums) free(s->sums);
 	free(s);
 }
 
 /* This is only called when we aren't preserving permissions.  Figure out what
  * the permissions should be and return them merged back into the mode. */
-mode_t dest_mode(mode_t flist_mode, mode_t cur_mode, int exists)
+mode_t dest_mode(mode_t flist_mode, mode_t stat_mode, int exists)
 {
+	int new_mode;
 	/* If the file already exists, we'll return the local permissions,
 	 * possibly tweaked by the --executability option. */
 	if (exists) {
+		new_mode = (flist_mode & ~CHMOD_BITS) | (stat_mode & CHMOD_BITS);
 		if (preserve_executability && S_ISREG(flist_mode)) {
 			/* If the source file is executable, grant execute
 			 * rights to everyone who can read, but ONLY if the
 			 * file isn't already executable. */
 			if (!(flist_mode & 0111))
-				cur_mode &= ~0111;
-			else if (!(cur_mode & 0111))
-				cur_mode |= (cur_mode & 0444) >> 2;
-		}
-	} else
-		cur_mode = flist_mode & ACCESSPERMS & ~orig_umask;
-	if (daemon_chmod_modes && !S_ISLNK(flist_mode))
-		cur_mode = tweak_mode(cur_mode, daemon_chmod_modes);
-	return (flist_mode & ~CHMOD_BITS) | (cur_mode & CHMOD_BITS);
+				new_mode &= ~0111;
+			else if (!(stat_mode & 0111))
+				new_mode |= (new_mode & 0444) >> 2;
+		}
+	} else {
+		/* Apply the umask and turn off special permissions. */
+		new_mode = flist_mode & (~CHMOD_BITS | (ACCESSPERMS & ~orig_umask));
+	}
+	return new_mode;
 }
 
 int set_file_attrs(char *fname, struct file_struct *file, STRUCT_STAT *st,
 		   int flags)
 {
 	int updated = 0;
 	STRUCT_STAT st2;
 	int change_uid, change_gid;
+	mode_t new_mode = file->mode;
 
 	if (!st) {
 		if (dry_run)
 			return 1;
 		if (link_stat(fname, &st2, 0) < 0) {
 			rsyserr(FERROR, errno, "stat %s failed",
 				full_fname(fname));
 			return 0;
 		}
 		st = &st2;
-		if (!preserve_perms && S_ISDIR(file->mode)
+		if (!preserve_perms && S_ISDIR(new_mode)
 		 && st->st_mode & S_ISGID) {
 			/* We just created this directory and its setgid
 			 * bit is on, so make sure it stays on. */
-			file->mode |= S_ISGID;
+			new_mode |= S_ISGID;
 		}
 	}
 
 	if (!preserve_times || (S_ISDIR(st->st_mode) && omit_dir_times))
 		flags |= ATTRS_SKIP_MTIME;
 	if (!(flags & ATTRS_SKIP_MTIME)
@@ -200,33 +202,33 @@
 			link_stat(fname, st,
 				  keep_dirlinks && S_ISDIR(st->st_mode));
 		}
 		updated = 1;
 	}
 
+	if (daemon_chmod_modes && !S_ISLNK(new_mode))
+		new_mode = tweak_mode(new_mode, daemon_chmod_modes);
 #ifdef HAVE_CHMOD
-	if ((st->st_mode & CHMOD_BITS) != (file->mode & CHMOD_BITS)) {
-		int ret = do_chmod(fname, file->mode);
+	if ((st->st_mode & CHMOD_BITS) != (new_mode & CHMOD_BITS)) {
+		int ret = do_chmod(fname, new_mode);
 		if (ret < 0) {
 			rsyserr(FERROR, errno,
 				"failed to set permissions on %s",
 				full_fname(fname));
 			return 0;
 		}
 		if (ret == 0) /* ret == 1 if symlink could not be set */
 			updated = 1;
 	}
 #endif
 
 	if (verbose > 1 && flags & ATTRS_REPORT) {
-		enum logcode code = daemon_log_format_has_i || dry_run
-				  ? FCLIENT : FINFO;
 		if (updated)
-			rprintf(code, "%s\n", fname);
+			rprintf(FCLIENT, "%s\n", fname);
 		else
-			rprintf(code, "%s is uptodate\n", fname);
+			rprintf(FCLIENT, "%s is uptodate\n", fname);
 	}
 	return updated;
 }
 
 RETSIGTYPE sig_int(UNUSED(int val))
 {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsyncd.conf.5 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsyncd.conf.5
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsyncd.conf.5	2006-04-22 23:38:38.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsyncd.conf.5	2006-11-07 12:39:52.000000000 +0800
@@ -1,185 +1,174 @@
-.TH "rsyncd\&.conf" "5" "22 Apr 2006" "" "" 
-.SH "NAME" 
+.TH "rsyncd\&.conf" "5" "6 Nov 2006" "" ""
+.SH "NAME"
 rsyncd\&.conf \- configuration file for rsync in daemon mode
-.SH "SYNOPSIS" 
+.SH "SYNOPSIS"
+
 .PP 
 rsyncd\&.conf
 .PP 
-.SH "DESCRIPTION" 
+.SH "DESCRIPTION"
+
 .PP 
 The rsyncd\&.conf file is the runtime configuration file for rsync when
-run as an rsync daemon\&. 
+run as an rsync daemon\&.
 .PP 
 The rsyncd\&.conf file controls authentication, access, logging and
 available modules\&.
 .PP 
-.SH "FILE FORMAT" 
+.SH "FILE FORMAT"
+
 .PP 
-The file consists of modules and parameters\&. A module begins with the 
+The file consists of modules and parameters\&. A module begins with the
 name of the module in square brackets and continues until the next
 module begins\&. Modules contain parameters of the form \&'name = value\&'\&.
 .PP 
 The file is line-based -- that is, each newline-terminated line represents
 either a comment, a module name or a parameter\&.
 .PP 
-Only the first equals sign in a parameter is significant\&. Whitespace before 
+Only the first equals sign in a parameter is significant\&. Whitespace before
 or after the first equals sign is discarded\&. Leading, trailing and internal
 whitespace in module and parameter names is irrelevant\&. Leading and
 trailing whitespace in a parameter value is discarded\&. Internal whitespace
 within a parameter value is retained verbatim\&.
 .PP 
-Any line beginning with a hash (#) is ignored, as are lines containing 
+Any line beginning with a hash (#) is ignored, as are lines containing
 only whitespace\&.
 .PP 
 Any line ending in a \e is "continued" on the next line in the
 customary UNIX fashion\&.
 .PP 
 The values following the equals sign in parameters are all either a string
 (no quotes needed) or a boolean, which may be given as yes/no, 0/1 or
 true/false\&. Case is not significant in boolean values, but is preserved
-in string values\&. 
+in string values\&.
 .PP 
-.SH "LAUNCHING THE RSYNC DAEMON" 
+.SH "LAUNCHING THE RSYNC DAEMON"
+
 .PP 
-The rsync daemon is launched by specifying the \fB--daemon\fP option to
-rsync\&. 
+The rsync daemon is launched by specifying the \fB\-\-daemon\fP option to
+rsync\&.
 .PP 
 The daemon must run with root privileges if you wish to use chroot, to
 bind to a port numbered under 1024 (as is the default 873), or to set
 file ownership\&.  Otherwise, it must just have permission to read and
 write the appropriate data, log, and lock files\&.
 .PP 
 You can launch it either via inetd, as a stand-alone daemon, or from
 an rsync client via a remote shell\&.  If run as a stand-alone daemon then
-just run the command "\fBrsync --daemon\fP" from a suitable startup script\&.
+just run the command "\fBrsync \-\-daemon\fP" from a suitable startup script\&.
 .PP 
 When run via inetd you should add a line like this to /etc/services:
 .PP 
-
 .nf 
- 
   rsync           873/tcp
 .fi 
- 
 
 .PP 
 and a single line something like this to /etc/inetd\&.conf:
 .PP 
-
 .nf 
- 
-  rsync   stream  tcp     nowait  root   /usr/bin/rsync rsyncd --daemon
+  rsync   stream  tcp     nowait  root   /usr/bin/rsync rsyncd \-\-daemon
 .fi 
- 
 
 .PP 
 Replace "/usr/bin/rsync" with the path to where you have rsync installed on
 your system\&.  You will then need to send inetd a HUP signal to tell it to
 reread its config file\&.
 .PP 
 Note that you should \fBnot\fP send the rsync daemon a HUP signal to force
 it to reread the \f(CWrsyncd\&.conf\fP file\&. The file is re-read on each client
-connection\&. 
+connection\&.
 .PP 
-.SH "GLOBAL OPTIONS" 
+.SH "GLOBAL OPTIONS"
+
 .PP 
 The first parameters in the file (before a [module] header) are the
-global parameters\&. 
+global parameters\&.
 .PP 
 You may also include any module parameters in the global part of the
 config file in which case the supplied value will override the
 default for that parameter\&.
 .PP 
-.IP "\fBmotd file\fP" 
+.IP "\fBmotd file\fP"
 The "motd file" option allows you to specify a
 "message of the day" to display to clients on each connect\&. This
 usually contains site information and any legal notices\&. The default
 is no motd file\&.
 .IP 
-.IP "\fBlog file\fP" 
-The "log file" option tells the rsync daemon to log
-messages to that file rather than using syslog\&. This is particularly
-useful on systems (such as AIX) where \f(CWsyslog()\fP doesn\&'t work for
-chrooted programs\&.  If the daemon fails to open to specified file, it
-will fall back to using syslog and output an error about the failure\&.
-(Note that a failure to open the specified log file used to be a fatal
-error\&.)
-.IP 
-.IP "\fBpid file\fP" 
+.IP "\fBpid file\fP"
 The "pid file" option tells the rsync daemon to write
 its process ID to that file\&.
 .IP 
-.IP "\fBsyslog facility\fP" 
-The "syslog facility" option allows you to
-specify the syslog facility name to use when logging messages from the
-rsync daemon\&. You may use any standard syslog facility name which is
-defined on your system\&. Common names are auth, authpriv, cron, daemon,
-ftp, kern, lpr, mail, news, security, syslog, user, uucp, local0,
-local1, local2, local3, local4, local5, local6 and local7\&. The default
-is daemon\&. 
-.IP 
-.IP "\fBport\fP" 
+.IP "\fBport\fP"
 You can override the default port the daemon will listen on
 by specifying this value (defaults to 873)\&.  This is ignored if the daemon
-is being run by inetd, and is superseded by the \fB--port\fP command-line option\&.
+is being run by inetd, and is superseded by the \fB\-\-port\fP command-line option\&.
 .IP 
-.IP "\fBaddress\fP" 
+.IP "\fBaddress\fP"
 You can override the default IP address the daemon
 will listen on by specifying this value\&.  This is ignored if the daemon is
-being run by inetd, and is superseded by the \fB--address\fP command-line option\&.
+being run by inetd, and is superseded by the \fB\-\-address\fP command-line option\&.
 .IP 
-.IP "\fBsocket options\fP" 
+.IP "\fBsocket options\fP"
 This option can provide endless fun for people
 who like to tune their systems to the utmost degree\&. You can set all
 sorts of socket options which may make transfers faster (or
-slower!)\&. Read the man page for the \f(CWsetsockopt()\fP system call for
+slower!)\&. Read the man page for the 
+\f(CWsetsockopt()\fP
+system call for
 details on some of the options you may be able to set\&. By default no
 special socket options are set\&.  These settings are superseded by the
-\fB--sockopts\fP command-line option\&.
+\fB\-\-sockopts\fP command-line option\&.
 .IP 
-.PP 
-.SH "MODULE OPTIONS" 
+.SH "MODULE OPTIONS"
+
 .PP 
 After the global options you should define a number of modules, each
 module exports a directory tree as a symbolic name\&. Modules are
 exported by specifying a module name in square brackets [module]
 followed by the options for that module\&.
 .PP 
-.IP 
-.IP "\fBcomment\fP" 
+.IP "\fBcomment\fP"
 The "comment" option specifies a description string
 that is displayed next to the module name when clients obtain a list
 of available modules\&. The default is no comment\&.
 .IP 
-.IP "\fBpath\fP" 
+.IP "\fBpath\fP"
 The "path" option specifies the directory in the daemon\&'s
 filesystem to make available in this module\&.  You must specify this option
 for each module in \f(CWrsyncd\&.conf\fP\&.
 .IP 
-.IP "\fBuse chroot\fP" 
+.IP "\fBuse chroot\fP"
 If "use chroot" is true, the rsync daemon will chroot
 to the "path" before starting the file transfer with the client\&.  This has
 the advantage of extra protection against possible implementation security
-holes, but it has the disadvantages of requiring super-user privileges, 
+holes, but it has the disadvantages of requiring super-user privileges,
 of not being able to follow symbolic links that are either absolute or outside
 of the new root path, and of complicating the preservation of usernames and groups
 (see below)\&.  When "use chroot" is false, for security reasons,
 symlinks may only be relative paths pointing to other files within the root
 path, and leading slashes are removed from most absolute paths (options
-such as \fB--backup-dir\fP, \fB--compare-dest\fP, etc\&. interpret an absolute path as
+such as \fB\-\-backup\-dir\fP, \fB\-\-compare\-dest\fP, etc\&. interpret an absolute path as
 rooted in the module\&'s "path" dir, just as if chroot was specified)\&.
 The default for "use chroot" is true\&.
 .IP 
 In order to preserve usernames and groupnames, rsync needs to be able to
 use the standard library functions for looking up names and IDs (i\&.e\&.
-\f(CWgetpwuid()\fP, \f(CWgetgrgid()\fP, \f(CWgetpwname()\fP, and \f(CWgetgrnam()\fP)\&.  This means a
+\f(CWgetpwuid()\fP
+, 
+\f(CWgetgrgid()\fP
+, 
+\f(CWgetpwname()\fP
+, and 
+\f(CWgetgrnam()\fP
+)\&.  This means a
 process in the chroot namespace will need to have access to the resources
 used by these library functions (traditionally /etc/passwd and
 /etc/group)\&.  If these resources are not available, rsync will only be
-able to copy the IDs, just as if the \fB--numeric-ids\fP option had been
+able to copy the IDs, just as if the \fB\-\-numeric\-ids\fP option had been
 specified\&.
 .IP 
 Note that you are free to setup user/group information in the chroot area
 differently from your normal system\&.  For example, you could abbreviate
 the list of users and groups\&.  Also, you can protect this information from
 being downloaded/uploaded by adding an exclude rule to the rsyncd\&.conf file
@@ -189,136 +178,165 @@
 directory and all its contents combining the rule "/some/dir/" with the
 rule "/some/dir/**" just to be sure that rsync will not allow deeper
 access to some of the excluded files inside the directory (rsync tries to
 do this automatically, but you might as well specify both to be extra
 sure)\&.
 .IP 
-.IP "\fBmax connections\fP" 
+.IP "\fBmax connections\fP"
 The "max connections" option allows you to
 specify the maximum number of simultaneous connections you will allow\&.
 Any clients connecting when the maximum has been reached will receive a
 message telling them to try later\&.  The default is 0 which means no limit\&.
 See also the "lock file" option\&.
 .IP 
-.IP "\fBmax verbosity\fP" 
+.IP "\fBlog file\fP"
+When the "log file" option is set to a non-empty
+string, the rsync daemon will log messages to the indicated file rather
+than using syslog\&. This is particularly useful on systems (such as AIX)
+where 
+\f(CWsyslog()\fP
+doesn\&'t work for chrooted programs\&.  The file is
+opened before 
+\f(CWchroot()\fP
+is called, allowing it to be placed outside
+the transfer\&.  If this value is set on a per-module basis instead of
+globally, the global log will still contain any authorization failures
+or config-file error messages\&.
+.IP 
+If the daemon fails to open to specified file, it will fall back to
+using syslog and output an error about the failure\&.  (Note that the
+failure to open the specified log file used to be a fatal error\&.)
+.IP 
+.IP "\fBsyslog facility\fP"
+The "syslog facility" option allows you to
+specify the syslog facility name to use when logging messages from the
+rsync daemon\&. You may use any standard syslog facility name which is
+defined on your system\&. Common names are auth, authpriv, cron, daemon,
+ftp, kern, lpr, mail, news, security, syslog, user, uucp, local0,
+local1, local2, local3, local4, local5, local6 and local7\&. The default
+is daemon\&.  This setting has no effect if the "log file" setting is a
+non-empty string (either set in the per-modules settings, or inherited
+from the global settings)\&.
+.IP 
+.IP "\fBmax verbosity\fP"
 The "max verbosity" option allows you to control
 the maximum amount of verbose information that you\&'ll allow the daemon to
 generate (since the information goes into the log file)\&. The default is 1,
 which allows the client to request one level of verbosity\&.
 .IP 
-.IP "\fBlock file\fP" 
+.IP "\fBlock file\fP"
 The "lock file" option specifies the file to use to
 support the "max connections" option\&. The rsync daemon uses record
 locking on this file to ensure that the max connections limit is not
-exceeded for the modules sharing the lock file\&. 
+exceeded for the modules sharing the lock file\&.
 The default is \f(CW/var/run/rsyncd\&.lock\fP\&.
 .IP 
-.IP "\fBread only\fP" 
+.IP "\fBread only\fP"
 The "read only" option determines whether clients
 will be able to upload files or not\&. If "read only" is true then any
 attempted uploads will fail\&. If "read only" is false then uploads will
 be possible if file permissions on the daemon side allow them\&. The default
 is for all modules to be read only\&.
 .IP 
-.IP "\fBwrite only\fP" 
+.IP "\fBwrite only\fP"
 The "write only" option determines whether clients
 will be able to download files or not\&. If "write only" is true then any
 attempted downloads will fail\&. If "write only" is false then downloads
 will be possible if file permissions on the daemon side allow them\&.  The
 default is for this option to be disabled\&.
 .IP 
-.IP "\fBlist\fP" 
+.IP "\fBlist\fP"
 The "list" option determines if this module should be
 listed when the client asks for a listing of available modules\&. By
 setting this to false you can create hidden modules\&. The default is
 for modules to be listable\&.
 .IP 
-.IP "\fBuid\fP" 
+.IP "\fBuid\fP"
 The "uid" option specifies the user name or user ID that
 file transfers to and from that module should take place as when the daemon
 was run as root\&. In combination with the "gid" option this determines what
-file permissions are available\&. The default is uid -2, which is normally
+file permissions are available\&. The default is uid \-2, which is normally
 the user "nobody"\&.
 .IP 
-.IP "\fBgid\fP" 
+.IP "\fBgid\fP"
 The "gid" option specifies the group name or group ID that
 file transfers to and from that module should take place as when the daemon
-was run as root\&. This complements the "uid" option\&. The default is gid -2,
+was run as root\&. This complements the "uid" option\&. The default is gid \-2,
 which is normally the group "nobody"\&.
 .IP 
-.IP "\fBfilter\fP" 
+.IP "\fBfilter\fP"
 The "filter" option allows you to specify a space-separated
 list of filter rules that the daemon will not allow to be read or written\&.
 This is only superficially equivalent to the client specifying these
-patterns with the \fB--filter\fP option\&.  Only one "filter" option may be
+patterns with the \fB\-\-filter\fP option\&.  Only one "filter" option may be
 specified, but it may contain as many rules as you like, including
 merge-file rules\&.  Note that per-directory merge-file rules do not provide
-as much protection as global rules, but they can be used to make \fB--delete\fP
+as much protection as global rules, but they can be used to make \fB\-\-delete\fP
 work better when a client downloads the daemon\&'s files (if the per-dir
 merge files are included in the transfer)\&.
 .IP 
-.IP "\fBexclude\fP" 
+.IP "\fBexclude\fP"
 The "exclude" option allows you to specify a
 space-separated list of patterns that the daemon will not allow to be read
 or written\&.  This is only superficially equivalent to the client
-specifying these patterns with the \fB--exclude\fP option\&.  Only one "exclude"
-option may be specified, but you can use "-" and "+" before patterns to
+specifying these patterns with the \fB\-\-exclude\fP option\&.  Only one "exclude"
+option may be specified, but you can use "\-" and "+" before patterns to
 specify exclude/include\&.
 .IP 
 Because this exclude list is not passed to the client it only applies on
 the daemon: that is, it excludes files received by a client when receiving
 from a daemon and files deleted on a daemon when sending to a daemon, but
 it doesn\&'t exclude files from being deleted on a client when receiving
-from a daemon\&.  
+from a daemon\&.
 .IP 
-.IP "\fBexclude from\fP" 
+.IP "\fBexclude from\fP"
 The "exclude from" option specifies a filename
 on the daemon that contains exclude patterns, one per line\&.
 This is only superficially equivalent
-to the client specifying the \fB--exclude-from\fP option with an equivalent file\&.
+to the client specifying the \fB\-\-exclude\-from\fP option with an equivalent file\&.
 See the "exclude" option above\&.
 .IP 
-.IP "\fBinclude\fP" 
+.IP "\fBinclude\fP"
 The "include" option allows you to specify a
 space-separated list of patterns which rsync should not exclude\&. This is
 only superficially equivalent to the client specifying these patterns with
-the \fB--include\fP option because it applies only on the daemon\&.  This is
+the \fB\-\-include\fP option because it applies only on the daemon\&.  This is
 useful as it allows you to build up quite complex exclude/include rules\&.
-Only one "include" option may be specified, but you can use "+" and "-"
+Only one "include" option may be specified, but you can use "+" and "\-"
 before patterns to switch include/exclude\&.  See the "exclude" option
 above\&.
 .IP 
-.IP "\fBinclude from\fP" 
+.IP "\fBinclude from\fP"
 The "include from" option specifies a filename
 on the daemon that contains include patterns, one per line\&. This is
 only superficially equivalent to the client specifying the
-\fB--include-from\fP option with a equivalent file\&.
+\fB\-\-include\-from\fP option with a equivalent file\&.
 See the "exclude" option above\&.
 .IP 
-.IP "\fBincoming chmod\fP" 
+.IP "\fBincoming chmod\fP"
 This option allows you to specify a set of
 comma-separated chmod strings that will affect the permissions of all
 incoming files (files that are being received by the daemon)\&.  These
 changes happen after all other permission calculations, and this will
 even override destination-default and/or existing permissions when the
-client does not specify \fB--perms\fP\&.
-See the description of the \fB--chmod\fP rsync option and the \fBchmod\fP(1)
+client does not specify \fB\-\-perms\fP\&.
+See the description of the \fB\-\-chmod\fP rsync option and the \fBchmod\fP(1)
 manpage for information on the format of this string\&.
 .IP 
-.IP "\fBoutgoing chmod\fP" 
+.IP "\fBoutgoing chmod\fP"
 This option allows you to specify a set of
 comma-separated chmod strings that will affect the permissions of all
 outgoing files (files that are being sent out from the daemon)\&.  These
 changes happen first, making the sent permissions appear to be different
 than those stored in the filesystem itself\&.  For instance, you could
 disable group write permissions on the server while having it appear to
 be on to the clients\&.
-See the description of the \fB--chmod\fP rsync option and the \fBchmod\fP(1)
+See the description of the \fB\-\-chmod\fP rsync option and the \fBchmod\fP(1)
 manpage for information on the format of this string\&.
 .IP 
-.IP "\fBauth users\fP" 
+.IP "\fBauth users\fP"
 The "auth users" option specifies a comma and
 space-separated list of usernames that will be allowed to connect to
 this module\&. The usernames do not need to exist on the local
 system\&. The usernames may also contain shell wildcard characters\&. If
 "auth users" is set then the client will be challenged to supply a
 username and password to connect to the module\&. A challenge response
@@ -326,39 +344,39 @@
 usernames and passwords are stored in the file specified by the
 "secrets file" option\&. The default is for all users to be able to
 connect without a password (this is called "anonymous rsync")\&.
 .IP 
 See also the "CONNECTING TO AN RSYNC DAEMON OVER A REMOTE SHELL
 PROGRAM" section in \fBrsync\fP(1) for information on how handle an
-rsyncd\&.conf-level username that differs from the remote-shell-level
+rsyncd\&.conf\-level username that differs from the remote-shell-level
 username when using a remote shell to connect to an rsync daemon\&.
 .IP 
-.IP "\fBsecrets file\fP" 
+.IP "\fBsecrets file\fP"
 The "secrets file" option specifies the name of
 a file that contains the username:password pairs used for
 authenticating this module\&. This file is only consulted if the "auth
 users" option is specified\&. The file is line based and contains
 username:password pairs separated by a single colon\&. Any line starting
 with a hash (#) is considered a comment and is skipped\&. The passwords
 can contain any characters but be warned that many operating systems
 limit the length of passwords that can be typed at the client end, so
-you may find that passwords longer than 8 characters don\&'t work\&. 
+you may find that passwords longer than 8 characters don\&'t work\&.
 .IP 
 There is no default for the "secrets file" option, you must choose a name
 (such as \f(CW/etc/rsyncd\&.secrets\fP)\&.  The file must normally not be readable
 by "other"; see "strict modes"\&.
 .IP 
-.IP "\fBstrict modes\fP" 
-The "strict modes" option determines whether or not 
+.IP "\fBstrict modes\fP"
+The "strict modes" option determines whether or not
 the permissions on the secrets file will be checked\&.  If "strict modes" is
 true, then the secrets file must not be readable by any user ID other
 than the one that the rsync daemon is running under\&.  If "strict modes" is
 false, the check is not performed\&.  The default is true\&.  This option
 was added to accommodate rsync running on the Windows operating system\&.
 .IP 
-.IP "\fBhosts allow\fP" 
+.IP "\fBhosts allow\fP"
 The "hosts allow" option allows you to specify a
 list of patterns that are matched against a connecting clients
 hostname and IP address\&. If none of the patterns match then the
 connection is rejected\&.
 .IP 
 Each pattern can be in one of five forms:
@@ -382,73 +400,75 @@
 be matched (case insensitive) against the pattern\&. Only an exact
 match is allowed in\&.
 .IP o 
 a hostname pattern using wildcards\&. These are matched using the
 same rules as normal unix filename matching\&. If the pattern matches
 then the client is allowed in\&.
-.RE 
+.RE
+
 .IP 
 Note IPv6 link-local addresses can have a scope in the address specification:
 .IP 
 .RS 
 \f(CW    fe80::1%link1\fP
 .br 
 \f(CW    fe80::%link1/64\fP
 .br 
 \f(CW    fe80::%link1/ffff:ffff:ffff:ffff::\fP
 .br 
-.RE 
+.RE
+
 .IP 
 You can also combine "hosts allow" with a separate "hosts deny"
 option\&. If both options are specified then the "hosts allow" option s
 checked first and a match results in the client being able to
 connect\&. The "hosts deny" option is then checked and a match means
-that the host is rejected\&. If the host does not match either the 
+that the host is rejected\&. If the host does not match either the
 "hosts allow" or the "hosts deny" patterns then it is allowed to
 connect\&.
 .IP 
 The default is no "hosts allow" option, which means all hosts can connect\&.
 .IP 
-.IP "\fBhosts deny\fP" 
+.IP "\fBhosts deny\fP"
 The "hosts deny" option allows you to specify a
 list of patterns that are matched against a connecting clients
 hostname and IP address\&. If the pattern matches then the connection is
 rejected\&. See the "hosts allow" option for more information\&.
 .IP 
 The default is no "hosts deny" option, which means all hosts can connect\&.
 .IP 
-.IP "\fBignore errors\fP" 
+.IP "\fBignore errors\fP"
 The "ignore errors" option tells rsyncd to
 ignore I/O errors on the daemon when deciding whether to run the delete
-phase of the transfer\&. Normally rsync skips the \fB--delete\fP step if any
+phase of the transfer\&. Normally rsync skips the \fB\-\-delete\fP step if any
 I/O errors have occurred in order to prevent disastrous deletion due
 to a temporary resource shortage or other I/O error\&. In some cases this
 test is counter productive so you can use this option to turn off this
-behavior\&. 
+behavior\&.
 .IP 
-.IP "\fBignore nonreadable\fP" 
+.IP "\fBignore nonreadable\fP"
 This tells the rsync daemon to completely
 ignore files that are not readable by the user\&. This is useful for
 public archives that may have some non-readable files among the
 directories, and the sysadmin doesn\&'t want those files to be seen at all\&.
 .IP 
-.IP "\fBtransfer logging\fP" 
-The "transfer logging" option enables per-file 
+.IP "\fBtransfer logging\fP"
+The "transfer logging" option enables per-file
 logging of downloads and uploads in a format somewhat similar to that
 used by ftp daemons\&.  The daemon always logs the transfer at the end, so
 if a transfer is aborted, no mention will be made in the log file\&.
 .IP 
 If you want to customize the log lines, see the "log format" option\&.
 .IP 
-.IP "\fBlog format\fP" 
+.IP "\fBlog format\fP"
 The "log format" option allows you to specify the
 format used for logging file transfers when transfer logging is enabled\&.
 The format is a text string containing embedded single-character escape
 sequences prefixed with a percent (%) character\&.  An optional numeric
 field width may also be specified between the percent and the escape
-letter (e\&.g\&. "%-50n %8l %07p")\&.
+letter (e\&.g\&. "%\-50n %8l %07p")\&.
 .IP 
 The default log format is "%o %h [%a] %m (%u) %f %l", and a "%t [%p] "
 is always prefixed when using the "log file" option\&.
 (A perl script that will summarize this default log format is included
 in the rsync source code distribution in the "support" subdirectory:
 rsyncstats\&.)
@@ -456,13 +476,13 @@
 The single-character escapes that are understood are as follows:
 .IP 
 .RS 
 .IP o 
 %a the remote IP address
 .IP o 
-%b the number of bytes actually transferred 
+%b the number of bytes actually transferred
 .IP o 
 %B the permission bits of the file (e\&.g\&. rwxrwxrwt)
 .IP o 
 %c the checksum bytes received for this file (only when sending)
 .IP o 
 %f the filename (long form on sender; no trailing "/")
@@ -472,13 +492,13 @@
 %h the remote host name
 .IP o 
 %i an itemized list of what is being updated
 .IP o 
 %l the length of the file in bytes
 .IP o 
-%L the string " -> SYMLINK", " => HARDLINK", or "" (where \fBSYMLINK\fP or \fBHARDLINK\fP is a filename)
+%L the string " \-> SYMLINK", " => HARDLINK", or "" (where \fBSYMLINK\fP or \fBHARDLINK\fP is a filename)
 .IP o 
 %m the module name
 .IP o 
 %M the last-modified time of the file
 .IP o 
 %n the filename (short form; trailing "/" on dir)
@@ -491,68 +511,73 @@
 .IP o 
 %t the current date time
 .IP o 
 %u the authenticated username or an empty string
 .IP o 
 %U the uid of the file (decimal)
-.RE 
+.RE
+
 .IP 
 For a list of what the characters mean that are output by "%i", see the
-\fB--itemize-changes\fP option in the rsync manpage\&.
+\fB\-\-itemize\-changes\fP option in the rsync manpage\&.
 .IP 
 Note that some of the logged output changes when talking with older
 rsync versions\&.  For instance, deleted files were only output as verbose
 messages prior to rsync 2\&.6\&.4\&.
 .IP 
-.IP "\fBtimeout\fP" 
+.IP "\fBtimeout\fP"
 The "timeout" option allows you to override the
 clients choice for I/O timeout for this module\&. Using this option you
 can ensure that rsync won\&'t wait on a dead client forever\&. The timeout
 is specified in seconds\&. A value of zero means no timeout and is the
 default\&. A good choice for anonymous rsync daemons may be 600 (giving
 a 10 minute timeout)\&.
 .IP 
-.IP "\fBrefuse options\fP" 
+.IP "\fBrefuse options\fP"
 The "refuse options" option allows you to
 specify a space-separated list of rsync command line options that will
 be refused by your rsync daemon\&.
 You may specify the full option name, its one-letter abbreviation, or a
 wild-card string that matches multiple options\&.
-For example, this would refuse \fB--checksum\fP (\fB-c\fP) and all the various
+For example, this would refuse \fB\-\-checksum\fP (\fB\-c\fP) and all the various
 delete options:
 .IP 
 .RS 
 \f(CW    refuse options = c delete\fP
-.RE 
+.RE
+
 .IP 
 The reason the above refuses all delete options is that the options imply
-\fB--delete\fP, and implied options are refused just like explicit options\&.
+\fB\-\-delete\fP, and implied options are refused just like explicit options\&.
 As an additional safety feature, the refusal of "delete" also refuses
 \fBremove-sent-files\fP when the daemon is the sender; if you want the latter
-without the former, instead refuse "delete-*" -- that refuses all the
-delete modes without affecting \fB--remove-sent-files\fP\&.
+without the former, instead refuse "delete\-*" -- that refuses all the
+delete modes without affecting \fB\-\-remove\-sent\-files\fP\&.
 .IP 
 When an option is refused, the daemon prints an error message and exits\&.
-To prevent all compression, you can use "dont compress = *" (see below)
+To prevent all compression when serving files,
+you can use "dont compress = *" (see below)
 instead of "refuse options = compress" to avoid returning an error to a
 client that requests compression\&.
 .IP 
-.IP "\fBdont compress\fP" 
+.IP "\fBdont compress\fP"
 The "dont compress" option allows you to select
 filenames based on wildcard patterns that should not be compressed
-during transfer\&. Compression is expensive in terms of CPU usage so it
+when pulling files from the daemon (no analogous option exists to
+govern the pushing of files to a daemon)\&.
+Compression is expensive in terms of CPU usage, so it
 is usually good to not try to compress files that won\&'t compress well,
-such as already compressed files\&. 
+such as already compressed files\&.
 .IP 
 The "dont compress" option takes a space-separated list of
 case-insensitive wildcard patterns\&. Any source filename matching one
 of the patterns will not be compressed during transfer\&.
 .IP 
 The default setting is \f(CW*\&.gz *\&.tgz *\&.zip *\&.z *\&.rpm *\&.deb *\&.iso *\&.bz2 *\&.tbz\fP
 .IP 
-.IP "\fBpre-xfer exec\fP, \fBpost-xfer exec\fP" 
+.IP "\fBpre-xfer exec\fP, \fBpost-xfer exec\fP"
 You may specify a command to be run
 before and/or after the transfer\&.  If the \fBpre-xfer exec\fP command fails, the
 transfer is aborted before it begins\&.
 .IP 
 The following environment variables will be set, though some are
 specific to the pre-xfer or the post-xfer environment:
@@ -566,33 +591,40 @@
 \fBRSYNC_HOST_ADDR\fP: The accessing host\&'s IP address\&.
 .IP o 
 \fBRSYNC_HOST_NAME\fP: The accessing host\&'s name\&.
 .IP o 
 \fBRSYNC_USER_NAME\fP: The accessing user\&'s name (empty if no user)\&.
 .IP o 
+\fBRSYNC_PID\fP: A unique number for this transfer\&.
+.IP o 
 \fBRSYNC_REQUEST\fP: (pre-xfer only) The module/path info specified
 by the user (note that the user can specify multiple source files,
 so the request can be something like "mod/path1 mod/path2", etc\&.)\&.
 .IP o 
 \fBRSYNC_ARG#\fP: (pre-xfer only) The pre-request arguments are set
 in these numbered values\&. RSYNC_ARG0 is always "rsyncd", and the last
 value contains a single period\&.
 .IP o 
-\fBRSYNC_EXIT_STATUS\fP: (post-xfer only) rsync\&'s exit value\&.  This will be 0 for a
-successful run, a positive value for an error that rsync returned
-(e\&.g\&. 23=partial xfer), or a -1 if rsync failed to exit properly\&.
-.IP o 
-\fBRSYNC_RAW_STATUS\fP: (post-xfer only) the raw exit value from \f(CWwaitpid()\fP\&.
-.RE 
+\fBRSYNC_EXIT_STATUS\fP: (post-xfer only) the server side\&'s exit value\&.
+This will be 0 for a successful run, a positive value for an error that the
+server generated, or a \-1 if rsync failed to exit properly\&.  Note that an
+error that occurs on the client side does not currently get sent to the
+server side, so this is not the final exit status for the whole transfer\&.
+.IP o 
+\fBRSYNC_RAW_STATUS\fP: (post-xfer only) the raw exit value from 
+\f(CWwaitpid()\fP
+\&.
+.RE
+
 .IP 
 Even though the commands can be associated with a particular module, they
 are run using the permissions of the user that started the daemon (not the
 module\&'s uid/gid setting) without any chroot restrictions\&.
 .IP 
-.PP 
-.SH "AUTHENTICATION STRENGTH" 
+.SH "AUTHENTICATION STRENGTH"
+
 .PP 
 The authentication protocol used in rsync is a 128 bit MD4 based
 challenge response system\&. This is fairly weak protection, though (with
 at least one brute-force hash-finding algorithm publicly available), so
 if you want really top-quality security, then I recommend that you run
 rsync over ssh\&.  (Yes, a future version of rsync will switch over to a
@@ -603,34 +635,30 @@
 authentication is provided\&. Use ssh as the transport if you want
 encryption\&.
 .PP 
 Future versions of rsync may support SSL for better authentication and
 encryption, but that is still being investigated\&.
 .PP 
-.SH "EXAMPLES" 
+.SH "EXAMPLES"
+
 .PP 
 A simple rsyncd\&.conf file that allow anonymous rsync to a ftp area at
 \f(CW/home/ftp\fP would be:
 .PP 
-
 .nf 
- 
 
 [ftp]
         path = /home/ftp
         comment = ftp export area
 
 .fi 
- 
 
 .PP 
 A more sophisticated example would be:
 .PP 
-
 .nf 
- 
 
 uid = nobody
 gid = nobody
 use chroot = no
 max connections = 4
 syslog facility = local5
@@ -644,56 +672,62 @@
         path = /var/ftp/pub/samba
         comment = Samba ftp area (approx 300 MB)
 
 [rsyncftp]
         path = /var/ftp/pub/rsync
         comment = rsync ftp area (approx 6 MB)
-        
+
 [sambawww]
         path = /public_html/samba
         comment = Samba WWW pages (approx 240 MB)
 
 [cvs]
         path = /data/cvs
         comment = CVS repository (requires authentication)
         auth users = tridge, susan
         secrets file = /etc/rsyncd\&.secrets
 
 .fi 
- 
 
 .PP 
 The /etc/rsyncd\&.secrets file would look something like this:
 .PP 
 .RS 
 \f(CWtridge:mypass\fP
 .br 
 \f(CWsusan:herpass\fP
 .br 
-.RE 
+.RE
+
 .PP 
-.SH "FILES" 
+.SH "FILES"
+
 .PP 
 /etc/rsyncd\&.conf or rsyncd\&.conf
 .PP 
-.SH "SEE ALSO" 
+.SH "SEE ALSO"
+
 .PP 
-rsync(1)
+\fBrsync\fP(1)
 .PP 
-.SH "DIAGNOSTICS" 
+.SH "DIAGNOSTICS"
+
 .PP 
-.SH "BUGS" 
+.SH "BUGS"
+
 .PP 
 Please report bugs! The rsync bug tracking system is online at
 http://rsync\&.samba\&.org/
 .PP 
-.SH "VERSION" 
+.SH "VERSION"
+
 .PP 
-This man page is current for version 2\&.6\&.8 of rsync\&.
+This man page is current for version 2\&.6\&.9 of rsync\&.
 .PP 
-.SH "CREDITS" 
+.SH "CREDITS"
+
 .PP 
 rsync is distributed under the GNU public license\&.  See the file
 COPYING for details\&.
 .PP 
 The primary ftp site for rsync is
 ftp://rsync\&.samba\&.org/pub/rsync\&.
@@ -703,19 +737,21 @@
 .PP 
 We would be delighted to hear from you if you like this program\&.
 .PP 
 This program uses the zlib compression library written by Jean-loup
 Gailly and Mark Adler\&.
 .PP 
-.SH "THANKS" 
+.SH "THANKS"
+
 .PP 
 Thanks to Warren Stanley for his original idea and patch for the rsync
 daemon\&. Thanks to Karsten Thygesen for his many suggestions and
-documentation! 
+documentation!
 .PP 
-.SH "AUTHOR" 
+.SH "AUTHOR"
+
 .PP 
 rsync was written by Andrew Tridgell and Paul Mackerras\&.
 Many people have later contributed to it\&.
 .PP 
 Mailing lists for support and development are available at
-http://lists\&.samba\&.org 
+http://lists\&.samba\&.org
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsyncd.conf.yo /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsyncd.conf.yo
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsyncd.conf.yo	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsyncd.conf.yo	2006-11-07 12:39:47.000000000 +0800
@@ -1,51 +1,51 @@
 mailto(rsync-bugs@samba.org)
-manpage(rsyncd.conf)(5)(22 Apr 2006)()()
+manpage(rsyncd.conf)(5)(6 Nov 2006)()()
 manpagename(rsyncd.conf)(configuration file for rsync in daemon mode)
 manpagesynopsis()
 
 rsyncd.conf
 
 manpagedescription()
 
 The rsyncd.conf file is the runtime configuration file for rsync when
-run as an rsync daemon. 
+run as an rsync daemon.
 
 The rsyncd.conf file controls authentication, access, logging and
 available modules.
 
 manpagesection(FILE FORMAT)
 
-The file consists of modules and parameters. A module begins with the 
+The file consists of modules and parameters. A module begins with the
 name of the module in square brackets and continues until the next
 module begins. Modules contain parameters of the form 'name = value'.
 
 The file is line-based -- that is, each newline-terminated line represents
 either a comment, a module name or a parameter.
 
-Only the first equals sign in a parameter is significant. Whitespace before 
+Only the first equals sign in a parameter is significant. Whitespace before
 or after the first equals sign is discarded. Leading, trailing and internal
 whitespace in module and parameter names is irrelevant. Leading and
 trailing whitespace in a parameter value is discarded. Internal whitespace
 within a parameter value is retained verbatim.
 
-Any line beginning with a hash (#) is ignored, as are lines containing 
+Any line beginning with a hash (#) is ignored, as are lines containing
 only whitespace.
 
 Any line ending in a \ is "continued" on the next line in the
 customary UNIX fashion.
 
 The values following the equals sign in parameters are all either a string
 (no quotes needed) or a boolean, which may be given as yes/no, 0/1 or
 true/false. Case is not significant in boolean values, but is preserved
-in string values. 
+in string values.
 
 manpagesection(LAUNCHING THE RSYNC DAEMON)
 
 The rsync daemon is launched by specifying the bf(--daemon) option to
-rsync. 
+rsync.
 
 The daemon must run with root privileges if you wish to use chroot, to
 bind to a port numbered under 1024 (as is the default 873), or to set
 file ownership.  Otherwise, it must just have permission to read and
 write the appropriate data, log, and lock files.
 
@@ -55,57 +55,41 @@
 
 When run via inetd you should add a line like this to /etc/services:
 
 verb(  rsync           873/tcp)
 
 and a single line something like this to /etc/inetd.conf:
-    
+
 verb(  rsync   stream  tcp     nowait  root   /usr/bin/rsync rsyncd --daemon)
 
 Replace "/usr/bin/rsync" with the path to where you have rsync installed on
 your system.  You will then need to send inetd a HUP signal to tell it to
 reread its config file.
 
 Note that you should bf(not) send the rsync daemon a HUP signal to force
 it to reread the tt(rsyncd.conf) file. The file is re-read on each client
-connection. 
+connection.
 
 manpagesection(GLOBAL OPTIONS)
 
 The first parameters in the file (before a [module] header) are the
-global parameters. 
+global parameters.
 
 You may also include any module parameters in the global part of the
 config file in which case the supplied value will override the
 default for that parameter.
 
 startdit()
 dit(bf(motd file)) The "motd file" option allows you to specify a
 "message of the day" to display to clients on each connect. This
 usually contains site information and any legal notices. The default
 is no motd file.
 
-dit(bf(log file)) The "log file" option tells the rsync daemon to log
-messages to that file rather than using syslog. This is particularly
-useful on systems (such as AIX) where code(syslog()) doesn't work for
-chrooted programs.  If the daemon fails to open to specified file, it
-will fall back to using syslog and output an error about the failure.
-(Note that a failure to open the specified log file used to be a fatal
-error.)
-
 dit(bf(pid file)) The "pid file" option tells the rsync daemon to write
 its process ID to that file.
 
-dit(bf(syslog facility)) The "syslog facility" option allows you to
-specify the syslog facility name to use when logging messages from the
-rsync daemon. You may use any standard syslog facility name which is
-defined on your system. Common names are auth, authpriv, cron, daemon,
-ftp, kern, lpr, mail, news, security, syslog, user, uucp, local0,
-local1, local2, local3, local4, local5, local6 and local7. The default
-is daemon. 
-
 dit(bf(port)) You can override the default port the daemon will listen on
 by specifying this value (defaults to 873).  This is ignored if the daemon
 is being run by inetd, and is superseded by the bf(--port) command-line option.
 
 dit(bf(address)) You can override the default IP address the daemon
 will listen on by specifying this value.  This is ignored if the daemon is
@@ -139,13 +123,13 @@
 filesystem to make available in this module.  You must specify this option
 for each module in tt(rsyncd.conf).
 
 dit(bf(use chroot)) If "use chroot" is true, the rsync daemon will chroot
 to the "path" before starting the file transfer with the client.  This has
 the advantage of extra protection against possible implementation security
-holes, but it has the disadvantages of requiring super-user privileges, 
+holes, but it has the disadvantages of requiring super-user privileges,
 of not being able to follow symbolic links that are either absolute or outside
 of the new root path, and of complicating the preservation of usernames and groups
 (see below).  When "use chroot" is false, for security reasons,
 symlinks may only be relative paths pointing to other files within the root
 path, and leading slashes are removed from most absolute paths (options
 such as bf(--backup-dir), bf(--compare-dest), etc. interpret an absolute path as
@@ -177,21 +161,44 @@
 dit(bf(max connections)) The "max connections" option allows you to
 specify the maximum number of simultaneous connections you will allow.
 Any clients connecting when the maximum has been reached will receive a
 message telling them to try later.  The default is 0 which means no limit.
 See also the "lock file" option.
 
+dit(bf(log file)) When the "log file" option is set to a non-empty
+string, the rsync daemon will log messages to the indicated file rather
+than using syslog. This is particularly useful on systems (such as AIX)
+where code(syslog()) doesn't work for chrooted programs.  The file is
+opened before code(chroot()) is called, allowing it to be placed outside
+the transfer.  If this value is set on a per-module basis instead of
+globally, the global log will still contain any authorization failures
+or config-file error messages.
+
+If the daemon fails to open to specified file, it will fall back to
+using syslog and output an error about the failure.  (Note that the
+failure to open the specified log file used to be a fatal error.)
+
+dit(bf(syslog facility)) The "syslog facility" option allows you to
+specify the syslog facility name to use when logging messages from the
+rsync daemon. You may use any standard syslog facility name which is
+defined on your system. Common names are auth, authpriv, cron, daemon,
+ftp, kern, lpr, mail, news, security, syslog, user, uucp, local0,
+local1, local2, local3, local4, local5, local6 and local7. The default
+is daemon.  This setting has no effect if the "log file" setting is a
+non-empty string (either set in the per-modules settings, or inherited
+from the global settings).
+
 dit(bf(max verbosity)) The "max verbosity" option allows you to control
 the maximum amount of verbose information that you'll allow the daemon to
 generate (since the information goes into the log file). The default is 1,
 which allows the client to request one level of verbosity.
 
 dit(bf(lock file)) The "lock file" option specifies the file to use to
 support the "max connections" option. The rsync daemon uses record
 locking on this file to ensure that the max connections limit is not
-exceeded for the modules sharing the lock file. 
+exceeded for the modules sharing the lock file.
 The default is tt(/var/run/rsyncd.lock).
 
 dit(bf(read only)) The "read only" option determines whether clients
 will be able to upload files or not. If "read only" is true then any
 attempted uploads will fail. If "read only" is false then uploads will
 be possible if file permissions on the daemon side allow them. The default
@@ -237,13 +244,13 @@
 specify exclude/include.
 
 Because this exclude list is not passed to the client it only applies on
 the daemon: that is, it excludes files received by a client when receiving
 from a daemon and files deleted on a daemon when sending to a daemon, but
 it doesn't exclude files from being deleted on a client when receiving
-from a daemon.  
+from a daemon.
 
 dit(bf(exclude from)) The "exclude from" option specifies a filename
 on the daemon that contains exclude patterns, one per line.
 This is only superficially equivalent
 to the client specifying the bf(--exclude-from) option with an equivalent file.
 See the "exclude" option above.
@@ -303,19 +310,19 @@
 authenticating this module. This file is only consulted if the "auth
 users" option is specified. The file is line based and contains
 username:password pairs separated by a single colon. Any line starting
 with a hash (#) is considered a comment and is skipped. The passwords
 can contain any characters but be warned that many operating systems
 limit the length of passwords that can be typed at the client end, so
-you may find that passwords longer than 8 characters don't work. 
+you may find that passwords longer than 8 characters don't work.
 
 There is no default for the "secrets file" option, you must choose a name
 (such as tt(/etc/rsyncd.secrets)).  The file must normally not be readable
 by "other"; see "strict modes".
 
-dit(bf(strict modes)) The "strict modes" option determines whether or not 
+dit(bf(strict modes)) The "strict modes" option determines whether or not
 the permissions on the secrets file will be checked.  If "strict modes" is
 true, then the secrets file must not be readable by any user ID other
 than the one that the rsync daemon is running under.  If "strict modes" is
 false, the check is not performed.  The default is true.  This option
 was added to accommodate rsync running on the Windows operating system.
 
@@ -323,13 +330,13 @@
 list of patterns that are matched against a connecting clients
 hostname and IP address. If none of the patterns match then the
 connection is rejected.
 
 Each pattern can be in one of five forms:
 
-quote(itemize(
+quote(itemization(
   it() a dotted decimal IPv4 address of the form a.b.c.d, or an IPv6 address
   of the form a:b:c::d:e:f. In this case the incoming machine's IP address
   must match exactly.
   it() an address/mask in the form ipaddr/n where ipaddr is the IP address
   and n is the number of one bits in the netmask.  All IP addresses which
   match the masked IP address will be allowed in.
@@ -354,13 +361,13 @@
 )
 
 You can also combine "hosts allow" with a separate "hosts deny"
 option. If both options are specified then the "hosts allow" option s
 checked first and a match results in the client being able to
 connect. The "hosts deny" option is then checked and a match means
-that the host is rejected. If the host does not match either the 
+that the host is rejected. If the host does not match either the
 "hosts allow" or the "hosts deny" patterns then it is allowed to
 connect.
 
 The default is no "hosts allow" option, which means all hosts can connect.
 
 dit(bf(hosts deny)) The "hosts deny" option allows you to specify a
@@ -373,20 +380,20 @@
 dit(bf(ignore errors)) The "ignore errors" option tells rsyncd to
 ignore I/O errors on the daemon when deciding whether to run the delete
 phase of the transfer. Normally rsync skips the bf(--delete) step if any
 I/O errors have occurred in order to prevent disastrous deletion due
 to a temporary resource shortage or other I/O error. In some cases this
 test is counter productive so you can use this option to turn off this
-behavior. 
+behavior.
 
 dit(bf(ignore nonreadable)) This tells the rsync daemon to completely
 ignore files that are not readable by the user. This is useful for
 public archives that may have some non-readable files among the
 directories, and the sysadmin doesn't want those files to be seen at all.
 
-dit(bf(transfer logging)) The "transfer logging" option enables per-file 
+dit(bf(transfer logging)) The "transfer logging" option enables per-file
 logging of downloads and uploads in a format somewhat similar to that
 used by ftp daemons.  The daemon always logs the transfer at the end, so
 if a transfer is aborted, no mention will be made in the log file.
 
 If you want to customize the log lines, see the "log format" option.
 
@@ -402,15 +409,15 @@
 (A perl script that will summarize this default log format is included
 in the rsync source code distribution in the "support" subdirectory:
 rsyncstats.)
 
 The single-character escapes that are understood are as follows:
 
-quote(itemize(
+quote(itemization(
   it() %a the remote IP address
-  it() %b the number of bytes actually transferred 
+  it() %b the number of bytes actually transferred
   it() %B the permission bits of the file (e.g. rwxrwxrwt)
   it() %c the checksum bytes received for this file (only when sending)
   it() %f the filename (long form on sender; no trailing "/")
   it() %G the gid of the file (decimal) or "DEFAULT"
   it() %h the remote host name
   it() %i an itemized list of what is being updated
@@ -456,21 +463,24 @@
 As an additional safety feature, the refusal of "delete" also refuses
 bf(remove-sent-files) when the daemon is the sender; if you want the latter
 without the former, instead refuse "delete-*" -- that refuses all the
 delete modes without affecting bf(--remove-sent-files).
 
 When an option is refused, the daemon prints an error message and exits.
-To prevent all compression, you can use "dont compress = *" (see below)
+To prevent all compression when serving files,
+you can use "dont compress = *" (see below)
 instead of "refuse options = compress" to avoid returning an error to a
 client that requests compression.
 
 dit(bf(dont compress)) The "dont compress" option allows you to select
 filenames based on wildcard patterns that should not be compressed
-during transfer. Compression is expensive in terms of CPU usage so it
+when pulling files from the daemon (no analogous option exists to
+govern the pushing of files to a daemon).
+Compression is expensive in terms of CPU usage, so it
 is usually good to not try to compress files that won't compress well,
-such as already compressed files. 
+such as already compressed files.
 
 The "dont compress" option takes a space-separated list of
 case-insensitive wildcard patterns. Any source filename matching one
 of the patterns will not be compressed during transfer.
 
 The default setting is tt(*.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz)
@@ -479,27 +489,30 @@
 before and/or after the transfer.  If the bf(pre-xfer exec) command fails, the
 transfer is aborted before it begins.
 
 The following environment variables will be set, though some are
 specific to the pre-xfer or the post-xfer environment:
 
-quote(itemize(
+quote(itemization(
   it() bf(RSYNC_MODULE_NAME): The name of the module being accessed.
   it() bf(RSYNC_MODULE_PATH): The path configured for the module.
   it() bf(RSYNC_HOST_ADDR): The accessing host's IP address.
   it() bf(RSYNC_HOST_NAME): The accessing host's name.
   it() bf(RSYNC_USER_NAME): The accessing user's name (empty if no user).
+  it() bf(RSYNC_PID): A unique number for this transfer.
   it() bf(RSYNC_REQUEST): (pre-xfer only) The module/path info specified
   by the user (note that the user can specify multiple source files,
   so the request can be something like "mod/path1 mod/path2", etc.).
   it() bf(RSYNC_ARG#): (pre-xfer only) The pre-request arguments are set
   in these numbered values. RSYNC_ARG0 is always "rsyncd", and the last
   value contains a single period.
-  it() bf(RSYNC_EXIT_STATUS): (post-xfer only) rsync's exit value.  This will be 0 for a
-  successful run, a positive value for an error that rsync returned
-  (e.g. 23=partial xfer), or a -1 if rsync failed to exit properly.
+  it() bf(RSYNC_EXIT_STATUS): (post-xfer only) the server side's exit value.
+  This will be 0 for a successful run, a positive value for an error that the
+  server generated, or a -1 if rsync failed to exit properly.  Note that an
+  error that occurs on the client side does not currently get sent to the
+  server side, so this is not the final exit status for the whole transfer.
   it() bf(RSYNC_RAW_STATUS): (post-xfer only) the raw exit value from code(waitpid()).
 ))
 
 Even though the commands can be associated with a particular module, they
 are run using the permissions of the user that started the daemon (not the
 module's uid/gid setting) without any chroot restrictions.
@@ -552,13 +565,13 @@
         path = /var/ftp/pub/samba
         comment = Samba ftp area (approx 300 MB)
 
 [rsyncftp]
         path = /var/ftp/pub/rsync
         comment = rsync ftp area (approx 6 MB)
-        
+
 [sambawww]
         path = /public_html/samba
         comment = Samba WWW pages (approx 240 MB)
 
 [cvs]
         path = /data/cvs
@@ -577,24 +590,24 @@
 manpagefiles()
 
 /etc/rsyncd.conf or rsyncd.conf
 
 manpageseealso()
 
-rsync(1)
+bf(rsync)(1)
 
 manpagediagnostics()
 
 manpagebugs()
 
 Please report bugs! The rsync bug tracking system is online at
 url(http://rsync.samba.org/)(http://rsync.samba.org/)
 
 manpagesection(VERSION)
 
-This man page is current for version 2.6.8 of rsync.
+This man page is current for version 2.6.9 of rsync.
 
 manpagesection(CREDITS)
 
 rsync is distributed under the GNU public license.  See the file
 COPYING for details.
 
@@ -610,15 +623,15 @@
 Gailly and Mark Adler.
 
 manpagesection(THANKS)
 
 Thanks to Warren Stanley for his original idea and patch for the rsync
 daemon. Thanks to Karsten Thygesen for his many suggestions and
-documentation! 
+documentation!
 
 manpageauthor()
 
 rsync was written by Andrew Tridgell and Paul Mackerras.
 Many people have later contributed to it.
 
 Mailing lists for support and development are available at
-url(http://lists.samba.org)(lists.samba.org) 
+url(http://lists.samba.org)(lists.samba.org)
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.h /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.h
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.h	2006-04-14 00:53:15.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.h	2006-10-24 11:31:30.000000000 +0800
@@ -1,26 +1,26 @@
 /*
-   Copyright (C) by Andrew Tridgell 1996, 2000
-   Copyright (C) Paul Mackerras 1996
-   Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
+ * Copyright (C) 1996, 2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #define False 0
 #define True 1
 
 #define BLOCK_SIZE 700
 #define RSYNC_RSH_ENV "RSYNC_RSH"
@@ -61,12 +61,13 @@
 #define FLAG_SENT (1<<1)	/* sender */
 #define FLAG_HLINK_EOL (1<<1)	/* receiver/generator */
 #define FLAG_MOUNT_POINT (1<<2)	/* sender/generator */
 #define FLAG_DEL_HERE (1<<3)	/* receiver/generator */
 #define FLAG_HLINK_TOL (1<<4)	/* receiver/generator */
 #define FLAG_NO_FUZZY (1<<5)	/* generator */
+#define FLAG_MISSING (1<<6)	/* generator */
 
 /* update this if you make incompatible changes */
 #define PROTOCOL_VERSION 29
 
 /* We refuse to interoperate with versions that are not in this range.
  * Note that we assume we'll work with later versions: the onus is on
@@ -154,16 +155,16 @@
 #define ITEM_DELETED (1<<17)		   /* used by log_formatted() */
 
 #define SIGNIFICANT_ITEM_FLAGS (~(\
 	ITEM_BASIS_TYPE_FOLLOWS | ITEM_XNAME_FOLLOWS | ITEM_LOCAL_CHANGE))
 
 
-/* Log-message categories.  Only FERROR and FINFO get sent over the socket.
- * FLOG and FCLIENT are only used on the daemon side for custom logging,
- * while FNAME is only used on the client side. */
-enum logcode { FERROR=1, FINFO=2, FLOG=3, FCLIENT=4, FNAME=5, FSOCKERR=6 };
+/* Log-message categories.  Only FERROR and FINFO get sent over the socket,
+ * but FLOG and FSOCKERR can be sent over the receiver -> generator pipe.
+ * FLOG only goes to the log file, not the client; FCLIENT is the opposite. */
+enum logcode { FNONE=0, FERROR=1, FINFO=2, FLOG=3, FCLIENT=4, FSOCKERR=5 };
 
 /* Messages types that are sent over the message channel.  The logcode
  * values must all be present here with identical numbers. */
 enum msgcode {
 	MSG_DATA=0,	/* raw data on the multiplexed stream */
 	MSG_ERROR=FERROR, MSG_INFO=FINFO, /* remote logging */
@@ -310,12 +311,18 @@
 #  define makedev mkdev
 # endif
 #elif defined MAJOR_IN_SYSMACROS
 #include <sys/sysmacros.h>
 #endif
 
+#ifdef MAKEDEV_TAKES_3_ARGS
+#define MAKEDEV(devmajor,devminor) makedev(0,devmajor,devminor)
+#else
+#define MAKEDEV(devmajor,devminor) makedev(devmajor,devminor)
+#endif
+
 #ifdef HAVE_COMPAT_H
 #include <compat.h>
 #endif
 
 #ifdef HAVE_LIMITS_H
 # include <limits.h>
@@ -379,24 +386,24 @@
 /* CAVEAT: on some systems, int64 will really be a 32-bit integer IFF
  * that's the maximum size the file system can handle and there is no
  * 64-bit type available.  The rsync source must therefore take steps
  * to ensure that any code that really requires a 64-bit integer has
  * it (e.g. the checksum code uses two 32-bit integers for its 64-bit
  * counter). */
-#if SIZEOF_OFF64_T == 8
-# define int64 off64_t
-# define SIZEOF_INT64 8
-#elif SIZEOF_LONG == 8
+#if SIZEOF_LONG == 8
 # define int64 long
 # define SIZEOF_INT64 8
 #elif SIZEOF_INT == 8
 # define int64 int
 # define SIZEOF_INT64 8
 #elif SIZEOF_LONG_LONG == 8
 # define int64 long long
 # define SIZEOF_INT64 8
+#elif SIZEOF_OFF64_T == 8
+# define int64 off64_t
+# define SIZEOF_INT64 8
 #elif SIZEOF_OFF_T == 8
 # define int64 off_t
 # define SIZEOF_INT64 8
 #elif SIZEOF_INT > 8
 # define int64 int
 # define SIZEOF_INT64 SIZEOF_INT
@@ -488,14 +495,15 @@
 #define GID_NONE ((gid_t)-1)
 
 #define HL_CHECK_MASTER	0
 #define HL_SKIP		1
 
 struct hlink {
-	int next;
-	int hlindex;
+	int32 next;
+	int32 hlindex;
+	unsigned short link_dest_used;
 };
 
 #define F_DEV	link_u.idev->dev
 #define F_INODE	link_u.idev->inode
 
 #define F_HLINDEX link_u.links->hlindex
@@ -656,12 +664,13 @@
  *
  * <http://www.opensource.apple.com/bugs/X/gcc/2512150.html> */
 #define __attribute__(x)
 #endif
 
 #define UNUSED(x) x __attribute__((__unused__))
+#define NORETURN __attribute__((__noreturn__))
 
 #include "proto.h"
 
 /* We have replacement versions of these if they're missing. */
 #ifndef HAVE_ASPRINTF
 int asprintf(char **ptr, const char *format, ...);
@@ -845,12 +854,15 @@
 size_t strlcat(char *d, const char *s, size_t bufsize);
 #endif
 
 #ifndef WEXITSTATUS
 #define	WEXITSTATUS(stat)	((int)(((stat)>>8)&0xFF))
 #endif
+#ifndef WIFEXITED
+#define	WIFEXITED(stat)		((int)((stat)&0xFF) == 0)
+#endif
 
 #define exit_cleanup(code) _exit_cleanup(code, __FILE__, __LINE__)
 
 #ifdef HAVE_GETEUID
 #define MY_UID() geteuid()
 #else
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.yo /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.yo
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/rsync.yo	2006-04-22 23:38:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/rsync.yo	2006-11-07 12:39:47.000000000 +0800
@@ -1,8 +1,8 @@
 mailto(rsync-bugs@samba.org)
-manpage(rsync)(1)(22 Apr 2006)()()
+manpage(rsync)(1)(6 Nov 2006)()()
 manpagename(rsync)(faster, flexible replacement for rcp)
 manpagesynopsis()
 
 rsync [OPTION]... SRC [SRC]... DEST
 
 rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST
@@ -30,13 +30,13 @@
 differences between two sets of files across the network connection, using
 an efficient checksum-search algorithm described in the technical
 report that accompanies this package.
 
 Some of the additional features of rsync are:
 
-itemize(
+itemization(
   it() support for copying links, devices, owners, groups, and permissions
   it() exclude and exclude-from options similar to GNU tar
   it() a CVS exclude mode for ignoring the same files that CVS would ignore
   it() can use any transparent remote shell, including ssh or rsh
   it() does not require super-user privileges
   it() pipelining of file transfers to minimize latency costs
@@ -179,13 +179,13 @@
 the remote system, so refer to the STARTING AN RSYNC DAEMON TO ACCEPT
 CONNECTIONS section below for information on that.)
 
 Using rsync in this way is the same as using it with a remote shell except
 that:
 
-itemize(
+itemization(
 	it() you either use a double colon :: instead of a single colon to
 	separate the hostname from the path, or you use an rsync:// URL.
 	it() the first word of the "path" is actually a module name.
 	it() the remote daemon may print a message of the day when you
 	connect.
 	it() if you specify no path name on the remote daemon then the
@@ -296,12 +296,13 @@
 manpagesection(OPTIONS SUMMARY)
 
 Here is a short summary of the options available in rsync. Please refer
 to the detailed description below for a complete description.  verb(
  -v, --verbose               increase verbosity
  -q, --quiet                 suppress non-error messages
+     --no-motd               suppress daemon-mode MOTD (see caveat)
  -c, --checksum              skip based on checksum, not mod-time & size
  -a, --archive               archive mode; same as -rlptgoD (no -H)
      --no-OPTION             turn off an implied OPTION (e.g. --no-D)
  -r, --recursive             recurse into directories
  -R, --relative              use relative path names
      --no-implied-dirs       don't send implied dirs with --relative
@@ -318,13 +319,13 @@
      --safe-links            ignore symlinks that point outside the tree
  -k, --copy-dirlinks         transform symlink to dir into referent dir
  -K, --keep-dirlinks         treat symlinked dir on receiver as dir
  -H, --hard-links            preserve hard links
  -p, --perms                 preserve permissions
  -E, --executability         preserve executability
-     --chmod=CHMOD           change destination permissions
+     --chmod=CHMOD           affect file and/or directory permissions
  -o, --owner                 preserve owner (super-user only)
  -g, --group                 preserve group
      --devices               preserve device files (super-user only)
      --specials              preserve special files
  -D                          same as --devices --specials
  -t, --times                 preserve times
@@ -334,21 +335,21 @@
  -n, --dry-run               show what would have been transferred
  -W, --whole-file            copy files whole (without rsync algorithm)
  -x, --one-file-system       don't cross filesystem boundaries
  -B, --block-size=SIZE       force a fixed checksum block-size
  -e, --rsh=COMMAND           specify the remote shell to use
      --rsync-path=PROGRAM    specify the rsync to run on remote machine
-     --existing              ignore non-existing files on receiving side
-     --ignore-existing       ignore files that already exist on receiver
-     --remove-sent-files     sent files/symlinks are removed from sender
+     --existing              skip creating new files on receiver
+     --ignore-existing       skip updating files that exist on receiver
+     --remove-source-files   sender removes synchronized files (non-dir)
      --del                   an alias for --delete-during
-     --delete                delete files that don't exist on sender
+     --delete                delete extraneous files from dest dirs
      --delete-before         receiver deletes before transfer (default)
      --delete-during         receiver deletes during xfer, not before
      --delete-after          receiver deletes after transfer, not before
-     --delete-excluded       also delete excluded files on receiver
+     --delete-excluded       also delete excluded files from dest dirs
      --ignore-errors         delete even if there are I/O errors
      --force                 force deletion of dirs even if not empty
      --max-delete=NUM        don't delete more than NUM files
      --max-size=SIZE         don't transfer any file larger than SIZE
      --min-size=SIZE         don't transfer any file smaller than SIZE
      --partial               keep partially transferred files
@@ -384,41 +385,43 @@
      --stats                 give some file-transfer stats
  -8, --8-bit-output          leave high-bit chars unescaped in output
  -h, --human-readable        output numbers in a human-readable format
      --progress              show progress during transfer
  -P                          same as --partial --progress
  -i, --itemize-changes       output a change-summary for all updates
-     --log-format=FORMAT     output filenames using the specified format
+     --out-format=FORMAT     output updates using the specified FORMAT
+     --log-file=FILE         log what we're doing to the specified FILE
+     --log-file-format=FMT   log updates using the specified FMT
      --password-file=FILE    read password from FILE
      --list-only             list the files instead of copying them
      --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
      --write-batch=FILE      write a batched update to FILE
      --only-write-batch=FILE like --write-batch but w/o updating dest
      --read-batch=FILE       read a batched update from FILE
      --protocol=NUM          force an older protocol version to be used
      --checksum-seed=NUM     set block/file checksum seed (advanced)
  -4, --ipv4                  prefer IPv4
  -6, --ipv6                  prefer IPv6
      --version               print version number
-(-h) --help                  show this help (see below for -h comment)
-)
+(-h) --help                  show this help (see below for -h comment))
 
 Rsync can also be run as a daemon, in which case the following options are
 accepted: verb(
      --daemon                run as an rsync daemon
      --address=ADDRESS       bind to the specified address
      --bwlimit=KBPS          limit I/O bandwidth; KBytes per second
      --config=FILE           specify alternate rsyncd.conf file
      --no-detach             do not detach from the parent
      --port=PORT             listen on alternate port number
+     --log-file=FILE         override the "log file" setting
+     --log-file-format=FMT   override the "log format" setting
      --sockopts=OPTIONS      specify custom TCP options
  -v, --verbose               increase verbosity
  -4, --ipv4                  prefer IPv4
  -6, --ipv6                  prefer IPv6
- -h, --help                  show this help (if used after --daemon)
-)
+ -h, --help                  show this help (if used after --daemon))
 
 manpageoptions()
 
 rsync uses the GNU long options package. Many of the command line
 options have two variants, one short and one long.  These are shown
 below, separated by commas. Some options only have a long variant.
@@ -439,28 +442,36 @@
 transferred and a brief summary at the end. Two bf(-v) flags will give you
 information on what files are being skipped and slightly more
 information at the end. More than two bf(-v) flags should only be used if
 you are debugging rsync.
 
 Note that the names of the transferred files that are output are done using
-a default bf(--log-format) of "%n%L", which tells you just the name of the
+a default bf(--out-format) of "%n%L", which tells you just the name of the
 file and, if the item is a link, where it points.  At the single bf(-v)
 level of verbosity, this does not mention when a file gets its attributes
 changed.  If you ask for an itemized list of changed attributes (either
-bf(--itemize-changes) or adding "%i" to the bf(--log-format) setting), the
+bf(--itemize-changes) or adding "%i" to the bf(--out-format) setting), the
 output (on the client) increases to mention all items that are changed in
-any way.  See the bf(--log-format) option for more details.
+any way.  See the bf(--out-format) option for more details.
 
 dit(bf(-q, --quiet)) This option decreases the amount of information you
 are given during the transfer, notably suppressing information messages
 from the remote server. This flag is useful when invoking rsync from
 cron.
 
+dit(bf(--no-motd)) This option affects the information that is output
+by the client at the start of a daemon transfer.  This suppresses the
+message-of-the-day (MOTD) text, but it also affects the list of modules
+that the daemon sends in response to the "rsync host::" request (due to
+a limitation in the rsync protocol), so omit this option if you want to
+request the list of modules from the deamon.
+
 dit(bf(-I, --ignore-times)) Normally rsync will skip any files that are
 already the same size and have the same modification time-stamp.
-This option turns off this "quick check" behavior.
+This option turns off this "quick check" behavior, causing all files to
+be updated.
 
 dit(bf(--size-only)) Normally rsync will not transfer any files that are
 already the same size and have the same modification time-stamp. With the
 bf(--size-only) option, files will not be transferred if they have the same size,
 regardless of timestamp. This is useful when starting to use rsync
 after using another mirroring system which may not preserve timestamps
@@ -604,14 +615,14 @@
 need to manually insert your own exclude/protect rule somewhere higher up
 in the list so that it has a high enough priority to be effective (e.g., if
 your rules specify a trailing inclusion/exclusion of '*', the auto-added
 rule would never be reached).
 
 dit(bf(--backup-dir=DIR)) In combination with the bf(--backup) option, this
-tells rsync to store all backups in the specified directory. This is
-very useful for incremental backups.  You can additionally
+tells rsync to store all backups in the specified directory on the receiving
+side.  This can be used for incremental backups.  You can additionally
 specify a backup suffix using the bf(--suffix) option
 (otherwise the files backed up in the specified directory
 will keep their original filenames).
 
 dit(bf(--suffix=SUFFIX)) This option allows you to override the default
 backup suffix used with the bf(--backup) (bf(-b)) option. The default suffix is a ~
@@ -734,13 +745,13 @@
 destination permissions to be the same as the source permissions.  (See
 also the bf(--chmod) option for a way to modify what rsync considers to
 be the source permissions.)
 
 When this option is em(off), permissions are set as follows:
 
-quote(itemize(
+quote(itemization(
   it() Existing files (including updated files) retain their existing
   permissions, though the bf(--executability) option might change just
   the execute permission for the file.
   it() New files get their "normal" permission bits set to the source
   file's permissions masked with the receiving end's umask setting, and
   their special permission bits disabled except in the case where a new
@@ -781,13 +792,13 @@
 executability (or non-executability) of regular files when bf(--perms) is
 not enabled.  A regular file is considered to be executable if at least one
 'x' is turned on in its permissions.  When an existing destination file's
 executability differs from that of the corresponding source file, rsync
 modifies the destination file's permissions as follows:
 
-quote(itemize(
+quote(itemization(
   it() To make a file non-executable, rsync turns off all its 'x'
   permissions.
   it() To make a file executable, rsync turns on each 'x' permission that
   has a corresponding 'r' permission enabled.
 ))
 
@@ -902,23 +913,24 @@
 If rsync has been told to collapse symlinks (via bf(--copy-links) or
 bf(--copy-unsafe-links)), a symlink to a directory on another device is
 treated like a mount-point.  Symlinks to non-directories are unaffected
 by this option.
 
 dit(bf(--existing, --ignore-non-existing)) This tells rsync to skip
-updating files that do not exist yet on the destination.  If this option is
+creating files (including directories) that do not exist
+yet on the destination.  If this option is
 combined with the bf(--ignore-existing) option, no files will be updated
-(which can be useful if all you want to do is to delete missing files).
+(which can be useful if all you want to do is to delete extraneous files).
 
 dit(bf(--ignore-existing)) This tells rsync to skip updating files that
-already exist on the destination.  See also bf(--ignore-non-existing).
+already exist on the destination (this does em(not) ignore existing
+directores, or nothing would get done).  See also bf(--existing).
 
-dit(bf(--remove-sent-files)) This tells rsync to remove from the sending
-side the files and/or symlinks that are newly created or whose content is
-updated on the receiving side.  Directories and devices are not removed,
-nor are files/symlinks whose attributes are merely changed.
+dit(bf(--remove-source-files)) This tells rsync to remove from the sending
+side the files (meaning non-directories) that are a part of the transfer
+and have been successfully duplicated on the receiving side.
 
 dit(bf(--delete)) This tells rsync to delete extraneous files from the
 receiving side (ones that aren't on the sending side), but only for the
 directories that are being synchronized.  You must have asked rsync to
 send the whole directory (e.g. "dir" or "dir/") without using a wildcard
 for the directory's contents (e.g. "dir/*") since the wildcard is expanded
@@ -1149,13 +1161,13 @@
 
 dit(bf(--files-from=FILE)) Using this option allows you to specify the
 exact list of files to transfer (as read from the specified FILE or bf(-)
 for standard input).  It also tweaks the default behavior of rsync to make
 transferring just the specified files and directories easier:
 
-quote(itemize(
+quote(itemization(
   it() The bf(--relative) (bf(-R)) option is implied, which preserves the path
   information that is specified for each item in the file (use
   bf(--no-relative) or bf(--no-R) if you want to turn that off).
   it() The bf(--dirs) (bf(-d)) option is implied, which will create directories
   specified in the list on the destination rather than noisily skipping
   them (use bf(--no-dirs) or bf(--no-d) if you want to turn that off).
@@ -1294,12 +1306,17 @@
 for an exact match.
 If a match is found that differs only in attributes, a local copy is made
 and the attributes updated.
 If a match is not found, a basis file from one of the em(DIR)s will be
 selected to try to speed up the transfer.
 
+Note that if you combine this option with bf(--ignore-times), rsync will not
+link any files together because it only links identical files together as a
+substitute for transferring the file, never as an additional check after the
+file is updated.
+
 If em(DIR) is a relative path, it is relative to the destination directory.
 See also bf(--compare-dest) and bf(--copy-dest).
 
 Note that rsync versions prior to 2.6.1 had a bug that could prevent
 bf(--link-dest) from working properly for a non-super-user when bf(-o) was
 specified (or implied by bf(-a)).  You can work-around this bug by avoiding
@@ -1363,13 +1380,13 @@
 rsync defaults to using
 blocking I/O, otherwise it defaults to using non-blocking I/O.  (Note that
 ssh prefers non-blocking I/O.)
 
 dit(bf(-i, --itemize-changes)) Requests a simple itemized list of the
 changes that are being made to each file, including attribute changes.
-This is exactly the same as specifying bf(--log-format='%i %n%L').
+This is exactly the same as specifying bf(--out-format='%i %n%L').
 If you repeat the option, unchanged files will also be output, but only
 if the receiving rsync is at least version 2.6.7 (you can use bf(-vv)
 with older versions of rsync, but that also turns on the output of other
 verbose messages).
 
 The "%i" escape has a cryptic output that is 9 letters long.  The general
@@ -1377,13 +1394,13 @@
 type of update being done, bf(X) is replaced by the file-type, and the
 other letters represent attributes that may be output if they are being
 modified.
 
 The update types that replace the bf(Y) are as follows:
 
-quote(itemize(
+quote(itemization(
   it() A bf(<) means that a file is being transferred to the remote host
   (sent).
   it() A bf(>) means that a file is being transferred to the local host
   (received).
   it() A bf(c) means that a local change/creation is occurring for the item
   (such as the creation of a directory or the changing of a symlink, etc.).
@@ -1403,13 +1420,13 @@
 item replaces each letter with a "+", (2) an identical item replaces the
 dots with spaces, and (3) an unknown attribute replaces each letter with
 a "?" (this can happen when talking to an older rsync).
 
 The attribute that is associated with each letter is as follows:
 
-quote(itemize(
+quote(itemization(
   it() A bf(c) means the checksum of the file is different and will be
   updated by the file transfer (requires bf(--checksum)).
   it() A bf(s) means the size of the file is different and will be updated
   by the file transfer.
   it() A bf(t) means the modification time is different and is being updated
   to the sender's value (requires bf(--times)).  An alternate value of bf(T)
@@ -1427,43 +1444,64 @@
 
 One other output is possible:  when deleting files, the "%i" will output
 the string "*deleting" for each item that is being removed (assuming that
 you are talking to a recent enough rsync that it logs deletions instead of
 outputting them as a verbose message).
 
-dit(bf(--log-format=FORMAT)) This allows you to specify exactly what the
-rsync client outputs to the user on a per-file basis.  The format is a text
+dit(bf(--out-format=FORMAT)) This allows you to specify exactly what the
+rsync client outputs to the user on a per-update basis.  The format is a text
 string containing embedded single-character escape sequences prefixed with
 a percent (%) character.  For a list of the possible escape characters, see
-the "log format" setting in the rsyncd.conf manpage.  (Note that this
-option does not affect what a daemon logs to its logfile.)
+the "log format" setting in the rsyncd.conf manpage.
 
 Specifying this option will mention each file, dir, etc. that gets updated
 in a significant way (a transferred file, a recreated symlink/device, or a
-touched directory) unless the itemize-changes escape (%i) is included in
-the string, in which case the logging of names increases to mention any
+touched directory).  In addition, if the itemize-changes escape (%i) is
+included in the string, the logging of names increases to mention any
 item that is changed in any way (as long as the receiving side is at least
 2.6.4).  See the bf(--itemize-changes) option for a description of the
 output of "%i".
 
 The bf(--verbose) option implies a format of "%n%L", but you can use
-bf(--log-format) without bf(--verbose) if you like, or you can override
+bf(--out-format) without bf(--verbose) if you like, or you can override
 the format of its per-file output using this option.
 
-Rsync will output the log-format string prior to a file's transfer unless
+Rsync will output the out-format string prior to a file's transfer unless
 one of the transfer-statistic escapes is requested, in which case the
 logging is done at the end of the file's transfer.  When this late logging
 is in effect and bf(--progress) is also specified, rsync will also output
 the name of the file being transferred prior to its progress information
-(followed, of course, by the log-format output).
+(followed, of course, by the out-format output).
+
+dit(bf(--log-file=FILE)) This option causes rsync to log what it is doing
+to a file.  This is similar to the logging that a daemon does, but can be
+requested for the client side and/or the server side of a non-daemon
+transfer.  If specified as a client option, transfer logging will be
+enabled with a default format of "%i %n%L".  See the bf(--log-file-format)
+option if you wish to override this.
+
+Here's a example command that requests the remote side to log what is
+happening:
+
+verb(  rsync -av --rsync-path="rsync --log-file=/tmp/rlog" src/ dest/)
+
+This is very useful if you need to debug why a connection is closing
+unexpectedly.
+
+dit(bf(--log-file-format=FORMAT)) This allows you to specify exactly what
+per-update logging is put into the file specified by the bf(--log-file) option
+(which must also be specified for this option to have any effect).  If you
+specify an empty string, updated files will not be mentioned in the log file.
+For a list of the possible escape characters, see the "log format" setting
+in the rsyncd.conf manpage.
 
 dit(bf(--stats)) This tells rsync to print a verbose set of statistics
 on the file transfer, allowing you to tell how effective the rsync
 algorithm is for your data.
 
-The current statistics are as follows: quote(itemize(
+The current statistics are as follows: quote(itemization(
   it() bf(Number of files) is the count of all "files" (in the generic
   sense), which includes directories, symlinks, etc.
   it() bf(Number of files transferred) is the count of normal files that
   were updated via the rsync algorithm, which does not include created
   dirs, symlinks, etc.
   it() bf(Total file size) is the total sum of all file sizes in the transfer.
@@ -1630,30 +1668,40 @@
 
 dit(bf(--progress)) This option tells rsync to print information
 showing the progress of the transfer. This gives a bored user
 something to watch.
 Implies bf(--verbose) if it wasn't already specified.
 
-When the file is transferring, the data looks like this:
+While rsync is transferring a regular file, it updates a progress line that
+looks like this:
 
 verb(      782448  63%  110.64kB/s    0:00:04)
 
-This tells you the current file size, the percentage of the transfer that
-is complete, the current calculated file-completion rate (including both
-data over the wire and data being matched locally), and the estimated time
-remaining in this transfer.
-
-After a file is complete, the data looks like this:
-
-verb(     1238099 100%  146.38kB/s    0:00:08  (5, 57.1% of 396))
-
-This tells you the final file size, that it's 100% complete, the final
-transfer rate for the file, the amount of elapsed time it took to transfer
-the file, and the addition of a total-transfer summary in parentheses.
-These additional numbers tell you how many files have been updated, and
-what percent of the total number of files has been scanned.
+In this example, the receiver has reconstructed 782448 bytes or 63% of the
+sender's file, which is being reconstructed at a rate of 110.64 kilobytes
+per second, and the transfer will finish in 4 seconds if the current rate
+is maintained until the end.
+
+These statistics can be misleading if the incremental transfer algorithm is
+in use.  For example, if the sender's file consists of the basis file
+followed by additional data, the reported rate will probably drop
+dramatically when the receiver gets to the literal data, and the transfer
+will probably take much longer to finish than the receiver estimated as it
+was finishing the matched part of the file.
+
+When the file transfer finishes, rsync replaces the progress line with a
+summary line that looks like this:
+
+verb(     1238099 100%  146.38kB/s    0:00:08  (xfer#5, to-check=169/396))
+
+In this example, the file was 1238099 bytes long in total, the average rate
+of transfer for the whole file was 146.38 kilobytes per second over the 8
+seconds that it took to complete, it was the 5th transfer of a regular file
+during the current rsync session, and there are 169 more files for the
+receiver to check (to see if they are up-to-date or not) remaining out of
+the 396 total files in the file-list.
 
 dit(bf(-P)) The bf(-P) option is equivalent to bf(--partial) bf(--progress).  Its
 purpose is to make it much easier to specify these two options for a long
 transfer that may be interrupted.
 
 dit(bf(--password-file)) This option allows you to provide a password
@@ -1779,12 +1827,21 @@
 sshd.
 
 dit(bf(--port=PORT)) This specifies an alternate TCP port number for the
 daemon to listen on rather than the default of 873.  See also the "port"
 global option in the rsyncd.conf manpage.
 
+dit(bf(--log-file=FILE)) This option tells the rsync daemon to use the
+given log-file name instead of using the "log file" setting in the config
+file.
+
+dit(bf(--log-file-format=FORMAT)) This option tells the rsync daemon to use the
+given FORMAT string instead of using the "log format" setting in the config
+file.  It also enables "transfer logging" unless the string is empty, in which
+case transfer logging is turned off.
+
 dit(bf(--sockopts)) This overrides the bf(socket options) setting in the
 rsyncd.conf file and has the same syntax.
 
 dit(bf(-v, --verbose)) This option increases the amount of information the
 daemon logs during its startup phase.  After the client connects, the
 daemon's verbosity level will be controlled by the options that the client
@@ -1865,13 +1922,13 @@
 You can include and exclude files by specifying patterns using the "+",
 "-", etc. filter rules (as introduced in the FILTER RULES section above).
 The include/exclude rules each specify a pattern that is matched against
 the names of the files that are going to be transferred.  These patterns
 can take several forms:
 
-itemize(
+itemization(
   it() if the pattern starts with a / then it is anchored to a
   particular spot in the hierarchy of files, otherwise it is matched
   against the end of the pathname.  This is similar to a leading ^ in
   regular expressions.
   Thus "/foo" would match a file named "foo" at either the "root of the
   transfer" (for a global rule) or in the merge-file's directory (for a
@@ -1943,13 +2000,13 @@
 tt(+ /file-also-included)nl()
 tt(- *)nl()
 )
 
 Here are some examples of exclude/include matching:
 
-itemize(
+itemization(
   it() "- *.o" would exclude all filenames matching *.o
   it() "- /foo" would exclude a file (or directory) named foo in the
   transfer-root directory
   it() "- foo/" would exclude any directory named foo
   it() "- /foo/*/bar" would exclude any file named bar which is at two
   levels below a directory named foo in the transfer-root directory
@@ -1990,13 +2047,13 @@
 tt(dir-merge,n- .non-inherited-per-dir-excludes)nl()
 tt(:n- .non-inherited-per-dir-excludes)nl()
 )
 
 The following modifiers are accepted after a merge or dir-merge rule:
 
-itemize(
+itemization(
   it() A bf(-) specifies that the file should consist of only exclude
   patterns, with no other rule-parsing except for in-file comments.
   it() A bf(+) specifies that the file should consist of only include
   patterns, with no other rule-parsing except for in-file comments.
   it() A bf(C) is a way to specify that the file should be read in a
   CVS-compatible manner.  This turns on 'n', 'w', and '-', but also
@@ -2017,13 +2074,13 @@
   while "dir-merge,s .filt" and ":sC" would each make all their
   per-directory rules apply only on the sending side.
 )
 
 The following modifiers are accepted after a "+" or "-":
 
-itemize(
+itemization(
   it() A "/" specifies that the include/exclude rule should be matched
   against the absolute pathname of the current item.  For example,
   "-/ /etc/passwd" would exclude the passwd file any time the transfer
   was sending files from the "/etc" directory, and "-/ subdir/foo"
   would always exclude "foo" when it is in a dir named "subdir", even
   if "foo" is at the root of the current transfer.
@@ -2292,13 +2349,13 @@
 In these examples, rsync is used to update /adest/dir/ from /source/dir/
 and the information to repeat this operation is stored in "foo" and
 "foo.sh".  The host "remote" is then updated with the batched data going
 into the directory /bdest/dir.  The differences between the two examples
 reveals some of the flexibility you have in how you deal with batches:
 
-itemize(
+itemization(
   it() The first example shows that the initial copy doesn't have to be
   local -- you can push or pull data to/from a remote host using either the
   remote-shell syntax or rsync daemon syntax, as desired.
   it() The first example uses the created "foo.sh" file to get the right
   rsync options when running the read-batch command on the remote host.
   it() The second example reads the batch data via standard input so that
@@ -2496,13 +2553,23 @@
 
 Please report bugs! See the website at
 url(http://rsync.samba.org/)(http://rsync.samba.org/)
 
 manpagesection(VERSION)
 
-This man page is current for version 2.6.8 of rsync.
+This man page is current for version 2.6.9 of rsync.
+
+manpagesection(INTERNAL OPTIONS)
+
+The options bf(--server) and bf(--sender) are used internally by rsync,
+and should never be typed by a user under normal circumstances.  Some
+awareness of these options may be needed in certain scenarios, such as
+when setting up a login that can only run an rsync command.  For instance,
+the support directory of the rsync distribution has an example script
+named rrsync (for restricted rsync) that can be used with a restricted
+ssh login.
 
 manpagesection(CREDITS)
 
 rsync is distributed under the GNU public license.  See the file
 COPYING for details.
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/runtests.sh /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/runtests.sh
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/runtests.sh	2006-03-17 05:37:18.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/runtests.sh	2006-11-04 08:18:49.000000000 +0800
@@ -1,23 +1,23 @@
 #! /bin/sh
 
 # Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+# Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License version
 # 2 as published by the Free Software Foundation.
 #
 # This program is distributed in the hope that it will be useful, but
 # WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 # Lesser General Public License for more details.
 # 
 # You should have received a copy of the GNU Lesser General Public
 # License along with this program; if not, write to the Free Software
-# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-
+# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 
 # rsync top-level test script -- this invokes all the other more
 # detailed tests in order.  This script can either be called by `make
 # check' or `make installcheck'.  `check' runs against the copies of
 # the program and other files in the build directory, and
 # `installcheck' against the installed copy of the program.  
@@ -135,15 +135,33 @@
     if set -x; then
 	# If it doesn't work the first time, don't keep trying.
 	RUNSHFLAGS="$RUNSHFLAGS -x"
     fi
 fi
 
+POSIXLY_CORRECT=1 
+if test x"$TOOLDIR" = x; then
+    TOOLDIR=`pwd`
+fi
+srcdir=`dirname $0`
+if test x"$srcdir" = x -o x"$srcdir" = x.; then
+    srcdir="$TOOLDIR"
+fi
+if test x"$rsync_bin" = x; then
+    rsync_bin="$TOOLDIR/rsync"
+fi
+
+# This allows the user to specify extra rsync options -- use carefully!
+RSYNC="$rsync_bin $*"
+#RSYNC="valgrind $rsync_bin $*"
+
+export POSIXLY_CORRECT TOOLDIR srcdir RSYNC
+
 echo "============================================================"
-echo "$0 running in `pwd`"
-echo "    rsync_bin=$rsync_bin"
+echo "$0 running in $TOOLDIR"
+echo "    rsync_bin=$RSYNC"
 echo "    srcdir=$srcdir"
 
 if [ -f /usr/bin/whoami ]; then
     testuser=`/usr/bin/whoami`
 elif [ -f /usr/ucb/whoami ]; then
     testuser=`/usr/ucb/whoami`
@@ -161,55 +179,52 @@
     echo "    preserve_scratch=yes"
 else
     echo "    preserve_scratch=no"
 fi    
 
 # Check if setfacl is around and if it supports the -k or -s option.
-if setfacl --help 2>/dev/null | grep ' -k,' >/dev/null; then
+if setfacl --help 2>&1 | grep ' -k,\|\[-[a-z]*k' >/dev/null; then
     setfacl_nodef='setfacl -k'
 elif setfacl -s u::7,g::5,o:5 testsuite 2>/dev/null; then
     setfacl_nodef='setfacl -s u::7,g::5,o:5'
 else
     setfacl_nodef=true
 fi
 
+export setfacl_nodef
+
 if [ ! -f "$rsync_bin" ]; then
     echo "rsync_bin $rsync_bin is not a file" >&2
     exit 2
 fi
 
 if [ ! -d "$srcdir" ]; then
     echo "srcdir $srcdir is not a directory" >&2
     exit 2
 fi
 
-RSYNC="$rsync_bin"
-#RSYNC="valgrind --tool=addrcheck $rsync_bin"
-
-export rsync_bin RSYNC setfacl_nodef
-
 skipped=0
 missing=0
 passed=0
 failed=0
 
 # Prefix for scratch directory.  We create separate directories for
 # each test case, so that they can be left behind in case of failure
 # to aid investigation.
-scratchbase="`pwd`"/testtmp
+scratchbase="$TOOLDIR"/testtmp
 echo "    scratchbase=$scratchbase"
 
 suitedir="$srcdir/testsuite"
 
 export scratchdir suitedir
 
 prep_scratch() {
     [ -d "$scratchdir" ] && rm -rf "$scratchdir"
     mkdir "$scratchdir"
     # Get rid of default ACLs and dir-setgid to avoid confusing some tests.
-    $setfacl_nodef "$scratchdir"
+    $setfacl_nodef "$scratchdir" || true
     chmod g-s "$scratchdir"
     return 0
 }
 
 maybe_discard_scratch() {
     [ x"$preserve_scratch" != xyes ] && [ -d "$scratchdir" ] && rm -rf "$scratchdir"
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/sender.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/sender.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/sender.c	2006-01-15 04:26:24.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/sender.c	2006-09-20 09:53:32.000000000 +0800
@@ -1,49 +1,52 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Routines only used by the sending process.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 extern int verbose;
 extern int do_xfers;
 extern int am_server;
 extern int am_daemon;
 extern int log_before_transfer;
-extern int log_format_has_i;
-extern int daemon_log_format_has_i;
+extern int stdout_format_has_i;
+extern int logfile_format_has_i;
 extern int csum_length;
 extern int append_mode;
 extern int io_error;
 extern int allowed_lull;
 extern int protocol_version;
-extern int remove_sent_files;
+extern int remove_source_files;
 extern int updating_basis_file;
 extern int make_backups;
 extern int do_progress;
 extern int inplace;
 extern int batch_fd;
 extern int write_batch;
 extern struct stats stats;
 extern struct file_list *the_file_list;
-extern char *log_format;
+extern char *stdout_format;
 
 
 /**
  * @file
  *
  * The sender gets checksums from the generator, calculates deltas,
@@ -122,23 +125,25 @@
 	unsigned int offset;
 
 	if (ndx < 0 || ndx >= the_file_list->count)
 		return;
 
 	file = the_file_list->files[ndx];
-	/* The generator might tell us about symlinks we didn't send. */
-	if (!(file->flags & FLAG_SENT) && !S_ISLNK(file->mode))
-		return;
 	if (file->dir.root) {
 		offset = stringjoin(fname, sizeof fname,
 				    file->dir.root, "/", NULL);
 	} else
 		offset = 0;
 	f_name(file, fname + offset);
-	if (remove_sent_files && do_unlink(fname) == 0 && verbose > 1)
-		rprintf(FINFO, "sender removed %s\n", fname + offset);
+	if (remove_source_files) {
+		if (do_unlink(fname) == 0) {
+			if (verbose > 1)
+				rprintf(FINFO, "sender removed %s\n", fname + offset);
+		} else
+			rsyserr(FERROR, errno, "sender failed to remove %s", fname + offset);
+	}
 }
 
 static void write_ndx_and_attrs(int f_out, int ndx, int iflags,
 				uchar fnamecmp_type, char *buf, int len)
 {
 	write_int(f_out, ndx);
@@ -212,14 +217,14 @@
 	uchar fnamecmp_type;
 	int iflags, xlen;
 	struct file_struct *file;
 	int phase = 0, max_phase = protocol_version >= 29 ? 2 : 1;
 	struct stats initial_stats;
 	int save_make_backups = make_backups;
-	int itemizing = am_daemon ? daemon_log_format_has_i
-		      : !am_server && log_format_has_i;
+	int itemizing = am_server ? logfile_format_has_i : stdout_format_has_i;
+	enum logcode log_code = log_before_transfer ? FLOG : FINFO;
 	int f_xfer = write_batch < 0 ? batch_fd : f_out;
 	int i, j;
 
 	if (verbose > 2)
 		rprintf(FINFO, "send_files starting\n");
 
@@ -275,14 +280,13 @@
 
 		stats.current_file_index = i;
 		stats.num_transferred_files++;
 		stats.total_transferred_size += file->length;
 
 		if (!do_xfers) { /* log the transfer */
-			if (!am_server && log_format)
-				log_item(file, &stats, iflags, NULL);
+			log_item(FCLIENT, file, &stats, iflags, NULL);
 			write_ndx_and_attrs(f_out, i, iflags, fnamecmp_type,
 					    xname, xlen);
 			continue;
 		}
 
 		initial_stats = stats;
@@ -337,24 +341,23 @@
 		write_sum_head(f_xfer, s);
 
 		if (verbose > 2)
 			rprintf(FINFO, "calling match_sums %s\n", fname);
 
 		if (log_before_transfer)
-			log_item(file, &initial_stats, iflags, NULL);
+			log_item(FCLIENT, file, &initial_stats, iflags, NULL);
 		else if (!am_server && verbose && do_progress)
-			rprintf(FINFO, "%s\n", fname2);
+			rprintf(FCLIENT, "%s\n", fname2);
 
 		set_compression(fname);
 
 		match_sums(f_xfer, s, mbuf, st.st_size);
 		if (do_progress)
 			end_progress(st.st_size);
 
-		if (!log_before_transfer)
-			log_item(file, &initial_stats, iflags, NULL);
+		log_item(log_code, file, &initial_stats, iflags, NULL);
 
 		if (mbuf) {
 			j = unmap_file(mbuf);
 			if (j) {
 				io_error |= IOERR_GENERAL;
 				rsyserr(FERROR, j,
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/socket.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/socket.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/socket.c	2006-04-11 08:48:28.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/socket.c	2006-11-01 03:21:57.000000000 +0800
@@ -1,42 +1,37 @@
-/* -*- c-file-style: "linux" -*-
-
-   rsync -- fast file replication program
-
-   Copyright (C) 1992-2001 by Andrew Tridgell <tridge@samba.org>
-   Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/**
- * @file socket.c
- *
+/*
  * Socket functions used in rsync.
  *
- * This file is now converted to use the new-style getaddrinfo()
+ * Copyright (C) 1992-2001 Andrew Tridgell <tridge@samba.org>
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+/* This file is now converted to use the new-style getaddrinfo()
  * interface, which supports IPv6 but is also supported on recent
  * IPv4-only machines.  On systems that don't have that interface, we
- * emulate it using the KAME implementation.
- **/
+ * emulate it using the KAME implementation. */
 
 #include "rsync.h"
 #include <netinet/in_systm.h>
 #include <netinet/ip.h>
+#include <netinet/tcp.h>
 
 extern char *bind_address;
 extern int default_af_hint;
 
 #ifdef HAVE_SIGACTION
 static struct sigaction sigact;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/cull_options /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/cull_options
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/cull_options	2005-06-23 23:53:26.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/cull_options	2006-09-18 08:13:50.000000000 +0800
@@ -52,13 +52,13 @@
 # check the arg when receiving; and 3 = always check the arg.
 our \%long_opt = (
 EOT
 
 foreach my $opt (sort keys %long_opt) {
     my $val = $long_opt{$opt};
-    $val = 1 if $opt =~ /^max-/;
+    $val = 1 if $opt =~ /^(max-|min-)/;
     $val = 3 if $opt eq 'files-from';
     $val = '$ro ? -1 : ' . $val if $opt =~ /^remove-/;
     print "  '$opt' => $val,\n";
 }
 
 print ");\n\n";
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/file-attr-restore /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/file-attr-restore
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/file-attr-restore	2006-03-22 02:06:26.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/file-attr-restore	2006-09-03 04:05:08.000000000 +0800
@@ -44,13 +44,14 @@
 }x;
 
 while (<>) {
     my($type, $perms, $owner, $group, $name) = /$detail_line/;
     die "Invalid input line $.:\n$_" unless defined $name;
     die "A filename is not properly escaped:\n$_" unless $name =~ /^[^"\\]*(\\(\d\d\d|\D)[^"\\]*)*$/;
-    my $fn = eval "\"$name\"";
+    my $fn = $name;
+    $fn =~ s/\\(\d+|.)/ eval "\"\\$1\"" /eg;
     if ($type eq '-') {
 	undef $type unless -f $fn;
     } elsif ($type eq 'd') {
 	undef $type unless -d $fn;
     } elsif ($type eq 'b') {
 	undef $type unless -b $fn;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/rrsync /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/rrsync
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/support/rrsync	2005-06-23 23:58:57.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/support/rrsync	2006-09-18 08:16:31.000000000 +0800
@@ -47,23 +47,25 @@
 # These options are the only options that rsync might send to the server,
 # and only in the option format that the stock rsync produces.
 
 # To disable a short-named option, add its letter to this string:
 our $short_disabled = '';
 
-our $short_no_arg = 'CDHIKLORSWbcdglnoprtuvxz'; # DO NOT REMOVE ANY
+our $short_no_arg = 'CDEHIKLORSWbcdgklmnoprtuvxz'; # DO NOT REMOVE ANY
 our $short_with_num = 'B'; # DO NOT REMOVE ANY
 
 # To disable a long-named option, change its value to a -1.  The values mean:
 # 0 = the option has no arg; 1 = the arg doesn't need any checking; 2 = only
 # check the arg when receiving; and 3 = always check the arg.
 our %long_opt = (
+  'append' => 0,
   'backup-dir' => 2,
   'bwlimit' => 1,
   'checksum-seed' => 1,
   'compare-dest' => 2,
+  'compress-level' => 1,
   'copy-dest' => 2,
   'copy-unsafe-links' => 0,
   'daemon' => 0,
   'delay-updates' => 0,
   'delete' => 0,
   'delete-after' => 0,
@@ -80,25 +82,31 @@
   'inplace' => 0,
   'link-dest' => 2,
   'list-only' => 0,
   'log-format' => 1,
   'max-delete' => 1,
   'max-size' => 1,
+  'min-size' => 1,
   'modify-window' => 1,
   'no-implied-dirs' => 0,
+  'no-r' => 0,
   'no-relative' => 0,
+  'no-specials' => 0,
   'numeric-ids' => 0,
   'only-write-batch' => 1,
   'partial' => 0,
   'partial-dir' => 2,
   'remove-sent-files' => $ro ? -1 : 0,
+  'remove-source-files' => $ro ? -1 : 0,
   'safe-links' => 0,
   'sender' => 0,
   'server' => 0,
   'size-only' => 0,
+  'specials' => 0,
   'suffix' => 1,
+  'super' => 0,
   'temp-dir' => 2,
   'timeout' => 1,
 );
 
 ### END of options data produced by the cull_options script. ###
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/syscall.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/syscall.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/syscall.c	2006-01-30 02:52:53.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/syscall.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,31 +1,28 @@
-/* 
-   Copyright (C) Andrew Tridgell 1998
-   Copyright (C) 2002 by Martin Pool
-   
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/**
- * @file syscall.c
- *
+/*
  * Syscall wrappers to ensure that nothing gets done in dry_run mode
  * and to handle system peculiarities.
- **/
+ *
+ * Copyright (C) 1998 Andrew Tridgell
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
 #if !defined MKNOD_CREATES_SOCKETS && defined HAVE_SYS_UN_H
 #include <sys/un.h>
 #endif
@@ -165,29 +162,29 @@
 void trim_trailing_slashes(char *name)
 {
 	int l;
 	/* Some BSD systems cannot make a directory if the name
 	 * contains a trailing slash.
 	 * <http://www.opensource.apple.com/bugs/X/BSD%20Kernel/2734739.html> */
-	
+
 	/* Don't change empty string; and also we can't improve on
 	 * "/" */
-	
+
 	l = strlen(name);
 	while (l > 1) {
 		if (name[--l] != '/')
 			break;
 		name[l] = '\0';
 	}
 }
 
 int do_mkdir(char *fname, mode_t mode)
 {
 	if (dry_run) return 0;
 	RETURN_ERROR_IF_RO_OR_LO;
-	trim_trailing_slashes(fname);	
+	trim_trailing_slashes(fname);
 	return mkdir(fname, mode);
 }
 
 /* like mkstemp but forces permissions */
 int do_mkstemp(char *template, mode_t perms)
 {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/chmod-option.test /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/chmod-option.test
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/chmod-option.test	2006-02-04 01:58:48.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/chmod-option.test	2006-10-13 12:59:53.000000000 +0800
@@ -35,8 +35,38 @@
 umask 002
 chmod ug-s,a+rX "$checkdir"/*
 chmod +w "$checkdir" "$checkdir"/dir*
 
 checkit "$RSYNC -avv --chmod ug-s,a+rX,D+w \"$fromdir/\" \"$todir/\"" "$checkdir" "$todir"
 
+rm -r "$fromdir" "$checkdir" "$todir"
+makepath "$todir"
+makepath "$fromdir/foo"
+touch "$fromdir/bar"
+
+checkit "$RSYNC -avv \"$fromdir/\" \"$checkdir/\"" "$fromdir" "$checkdir"
+chmod o+x "$fromdir"/bar
+
+checkit "$RSYNC -avv --chmod=Fo-x \"$fromdir/\" \"$todir/\"" "$checkdir" "$todir"
+
+# Tickle a bug in rsync 2.6.8: if you push a new directory with --perms off to
+# a daemon with an incoming chmod, the daemon pretends the directory is a file
+# for the purposes of the second application of the incoming chmod.
+
+build_rsyncd_conf
+cat >>"$scratchdir/test-rsyncd.conf" <<EOF
+[test-incoming-chmod]
+	path = $todir
+	read only = no
+	incoming chmod = Fo-x
+EOF
+
+RSYNC_CONNECT_PROG="$RSYNC --config=$conf --daemon"
+export RSYNC_CONNECT_PROG
+
+rm -r "$todir"
+makepath "$todir"
+
+checkit "$RSYNC -rtvv \"$fromdir/\" localhost::test-incoming-chmod/" "$checkdir" "$todir"
+
 # The script would have aborted on error, so getting here means we've won.
 exit 0
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/delete.test /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/delete.test
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/delete.test	2006-02-05 03:29:13.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/delete.test	2006-09-01 08:43:52.000000000 +0800
@@ -20,8 +20,22 @@
 
 checkit "$RSYNC -avv --remove-sent-files \
     \"$fromdir/\" \"$todir/\"" "$chkdir/copy" "$todir"
 
 diff -r "$chkdir/empty" "$fromdir"
 
+# Make sure that "P" but not "-" per-dir merge-file filters take effect with
+# --delete-excluded.
+cat >"$todir/filters" <<EOF
+P foo
+- bar
+EOF
+touch "$todir/foo" "$todir/bar" "$todir/baz"
+
+$RSYNC -r --exclude=baz --filter=': filters' --delete-excluded "$fromdir/" "$todir/"
+
+test -f "$todir/foo" || test_fail "rsync deleted $todir/foo"
+test -f "$todir/bar" && test_fail "rsync did not delete $todir/bar"
+test -f "$todir/baz" && test_fail "rsync did not delete $todir/baz"
+
 # The script would have aborted on error, so getting here means we've won.
 exit 0
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/itemize.test /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/itemize.test
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/itemize.test	2006-02-09 09:17:01.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/itemize.test	2006-10-11 08:51:50.000000000 +0800
@@ -26,12 +26,13 @@
 umask 022
 ln "$fromdir/foo/config1" "$fromdir/foo/extra"
 
 $RSYNC -iplr "$fromdir/" "$todir/" \
     | tee "$outfile"
 cat <<EOT >"$chkfile"
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 >f+++++++ bar/baz/rsync
 cd+++++++ foo/
 >f+++++++ foo/config1
 >f+++++++ foo/config2
@@ -127,33 +128,33 @@
 .f...p... foo/config1
 >f..t.... foo/config2
 EOT
 diff $diffopt "$chkfile" "$outfile" || test_fail "test 7 failed"
 
 mv "$todir" "$lddir"
-$RSYNC -ivvplrtH --copy-dest="$lddir" "$fromdir/" "$todir/" \
+$RSYNC -ivvplrtH --copy-dest=../ld "$fromdir/" "$todir/" \
     | tee "$outfile"
 filter_outfile
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 cf        bar/baz/rsync
 cd+++++++ foo/
 cf        foo/config1
 cf        foo/config2
 hf        foo/extra => foo/config1
 cL..T.... foo/sym -> ../bar/baz/rsync
 EOT
 diff $diffopt "$chkfile" "$outfile" || test_fail "test 8 failed"
 
 rm -rf "$todir"
-$RSYNC -iplrtH --copy-dest="$lddir" "$fromdir/" "$todir/" \
+$RSYNC -iplrtH --copy-dest=../ld "$fromdir/" "$todir/" \
     | tee "$outfile"
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 cd+++++++ foo/
 hf        foo/extra => foo/config1
 EOT
 diff $diffopt "$chkfile" "$outfile" || test_fail "test 9 failed"
@@ -178,36 +179,47 @@
 
 rm -rf "$todir"
 $RSYNC -ivvplrtH --link-dest="$lddir" "$fromdir/" "$todir/" \
     | tee "$outfile"
 filter_outfile
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 hf        bar/baz/rsync
 cd+++++++ foo/
 hf        foo/config1
 hf        foo/config2
 hf        foo/extra => foo/config1
 hL        foo/sym -> ../bar/baz/rsync
 EOT
 diff $diffopt "$chkfile" "$outfile" || test_fail "test 11 failed"
 
 rm -rf "$todir"
-$RSYNC -iplrtH --link-dest="$lddir" "$fromdir/" "$todir/" \
+$RSYNC -iplrtH --dry-run --link-dest=../ld "$fromdir/" "$todir/" \
     | tee "$outfile"
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 cd+++++++ foo/
 EOT
 diff $diffopt "$chkfile" "$outfile" || test_fail "test 12 failed"
 
 rm -rf "$todir"
+$RSYNC -iplrtH --link-dest=../ld "$fromdir/" "$todir/" \
+    | tee "$outfile"
+cat <<EOT >"$chkfile"
+cd+++++++ ./
+cd+++++++ bar/
+cd+++++++ bar/baz/
+cd+++++++ foo/
+EOT
+diff $diffopt "$chkfile" "$outfile" || test_fail "test 13 failed"
+
+rm -rf "$todir"
 $RSYNC -vvplrtH --link-dest="$lddir" "$fromdir/" "$todir/" \
     | tee "$outfile"
 filter_outfile
 cat <<EOT >"$chkfile"
 ./
 bar/
@@ -216,42 +228,42 @@
 foo/
 foo/config1 is uptodate
 foo/config2 is uptodate
 "foo/extra" is a hard link
 foo/sym is uptodate
 EOT
-diff $diffopt "$chkfile" "$outfile" || test_fail "test 13 failed"
+diff $diffopt "$chkfile" "$outfile" || test_fail "test 14 failed"
 
 rm -rf "$todir"
 $RSYNC -ivvplrtH --compare-dest="$lddir" "$fromdir/" "$todir/" \
     | tee "$outfile"
 filter_outfile
 # TODO fix really-old problem when combining -H with --compare-dest:
 # missing output for foo/extra hard-link (and it might not be updated)!
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 .f        bar/baz/rsync
 cd+++++++ foo/
 .f        foo/config1
 .f        foo/config2
 .L        foo/sym -> ../bar/baz/rsync
 EOT
-diff $diffopt "$chkfile" "$outfile" || test_fail "test 14 failed"
+diff $diffopt "$chkfile" "$outfile" || test_fail "test 15 failed"
 
 rm -rf "$todir"
 $RSYNC -iplrtH --compare-dest="$lddir" "$fromdir/" "$todir/" \
     | tee "$outfile"
 cat <<EOT >"$chkfile"
-.d..t.... ./
+cd+++++++ ./
 cd+++++++ bar/
 cd+++++++ bar/baz/
 cd+++++++ foo/
 EOT
-diff $diffopt "$chkfile" "$outfile" || test_fail "test 15 failed"
+diff $diffopt "$chkfile" "$outfile" || test_fail "test 16 failed"
 
 rm -rf "$todir"
 $RSYNC -vvplrtH --compare-dest="$lddir" "$fromdir/" "$todir/" \
     | tee "$outfile"
 filter_outfile
 cat <<EOT >"$chkfile"
@@ -262,10 +274,10 @@
 foo/
 foo/config1 is uptodate
 foo/config2 is uptodate
 "foo/extra" is a hard link
 foo/sym is uptodate
 EOT
-diff $diffopt "$chkfile" "$outfile" || test_fail "test 16 failed"
+diff $diffopt "$chkfile" "$outfile" || test_fail "test 17 failed"
 
 # The script would have aborted on error, so getting here means we've won.
 exit 0
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/rsync.fns /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/rsync.fns
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/testsuite/rsync.fns	2006-02-05 03:27:07.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/testsuite/rsync.fns	2006-05-31 02:26:17.000000000 +0800
@@ -221,23 +221,25 @@
     conf="$scratchdir/test-rsyncd.conf"
     echo "building configuration $conf"
 
     port=2612
     pidfile="$scratchdir/rsyncd.pid"
     logfile="$scratchdir/rsyncd.log"
+    hostname=`uname -n`
 
     cat >"$conf" <<EOF
 # rsyncd configuration file autogenerated by $0
 
 pid file = $pidfile
 use chroot = no
-hosts allow = localhost, 127.0.0.1
+hosts allow = localhost 127.0.0.1 $hostname
 log file = $logfile
+log format = %i %h [%a] %m (%u) %l %f%L
+transfer logging = yes
 exclude = foobar.baz
 max verbosity = 9
-
 uid = 0
 gid = 0
 
 [test-from]
 	path = $fromdir
 	read only = yes
@@ -242,12 +244,16 @@
 	path = $fromdir
 	read only = yes
 
 [test-to]
 	path = $todir
 	read only = no
+
+[test-scratch]
+	path = $scratchdir
+	read only = no
 EOF
 }
 
 
 build_symlinks() {
     mkdir "$fromdir"
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/tls.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/tls.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/tls.c	2005-09-22 01:42:15.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/tls.c	2006-10-14 07:42:52.000000000 +0800
@@ -1,45 +1,40 @@
-/* -*- c-file-style: "linux" -*-
+/*
+ * Trivial ls for comparing two directories after running an rsync.
  *
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License version
  * 2 as published by the Free Software Foundation.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/**
- * @file tls.c
- *
- * Trivial @c ls for comparing two directories after running an rsync.
- *
- * The problem with using the system's own ls is that some features
+/* The problem with using the system's own ls is that some features
  * have little quirks that make directories look different when for
  * our purposes they're the same -- for example, the BSD braindamage
  * about setting the mode on symlinks based on your current umask.
  *
  * All the filenames must be given on the command line -- tls does not
  * even read directories, let alone recurse.  The typical usage is
  * "find|sort|xargs tls".
  *
  * The format is not exactly the same as any particular Unix ls(1).
  *
  * A key requirement for this program is that the output be "very
  * reproducible."  So we mask away information that can accidentally
- * change.
- **/
-
+ * change. */
 
 #include "rsync.h"
 
 #define PROGRAM "tls"
 
 /* These are to make syscall.o shut up. */
@@ -79,13 +71,13 @@
 	 * symlink's mtime, so we have to ignore it too. */
 	if (S_ISLNK(buf.st_mode)) {
 		int len;
 		buf.st_mode &= ~0777;
 		buf.st_mtime = (time_t)0;
 		buf.st_uid = buf.st_gid = 0;
-		strcpy(linkbuf, " -> ");
+		strlcpy(linkbuf, " -> ", sizeof linkbuf);
 		/* const-cast required for silly UNICOS headers */
 		len = readlink((char *) fname, linkbuf+4, sizeof(linkbuf) - 4);
 		if (len == -1)
 			failed("readlink", fname);
 		else
 			/* it's not nul-terminated */
@@ -96,22 +88,22 @@
 
 	permstring(permbuf, buf.st_mode);
 
 	if (buf.st_mtime) {
 		mt = gmtime(&buf.st_mtime);
 
-		sprintf(datebuf, "%04d-%02d-%02d %02d:%02d:%02d",
+		snprintf(datebuf, sizeof datebuf,
+			"%04d-%02d-%02d %02d:%02d:%02d",
 			(int)mt->tm_year + 1900,
 			(int)mt->tm_mon + 1,
 			(int)mt->tm_mday,
 			(int)mt->tm_hour,
 			(int)mt->tm_min,
 			(int)mt->tm_sec);
-	} else {
-		strcpy(datebuf, "                   ");
-	}
+	} else
+		strlcpy(datebuf, "                   ", sizeof datebuf);
 
 	/* TODO: Perhaps escape special characters in fname? */
 
 	printf("%s ", permbuf);
 	if (S_ISCHR(buf.st_mode) || S_ISBLK(buf.st_mode)) {
 		printf("%5ld,%6ld",
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/token.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/token.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/token.c	2005-12-30 15:19:16.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/token.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,24 +1,27 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * Routines used by the file-transfer code.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2003, 2004, 2005 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 #include "zlib/zlib.h"
 
 extern int do_compression;
 extern int module_id;
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/trimslash.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/trimslash.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/trimslash.c	2003-09-10 16:27:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/trimslash.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,42 +1,40 @@
 /*
- * Copyright (C) 2002 by Martin Pool
- * 
+ * Simple utility used only by the test harness.
+ *
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003 Wayne Davison
+ *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
- * 
+ *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
- * 
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
 #include "rsync.h"
 
 /* These are to make syscall.o shut up. */
 int dry_run = 0;
 int read_only = 1;
 int list_only = 0;
 int preserve_perms = 0;
 
-/**
- * @file trimslash.c
- *
- * Test harness; not linked into release.
- **/
 int
 main(int argc, char **argv)
 {
 	int i;
-	
+
 	if (argc <= 1) {
 		fprintf(stderr, "trimslash: needs at least one argument\n");
 		return 1;
 	}
 
 	for (i = 1; i < argc; i++) {
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/t_stub.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/t_stub.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/t_stub.c	2006-02-24 09:56:29.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/t_stub.c	2006-09-24 11:11:41.000000000 +0800
@@ -1,38 +1,35 @@
-/*  -*- c-file-style: "linux" -*-
- * 
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+/*
+ * This file contains really simple implementations for rsync global
+ * functions, so that module test harnesses can run standalone.
+ *
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-   
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-   
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 #include "rsync.h"
 
-/**
- * @file t_stub.c
- *
- * This file contains really simple implementations for rsync global
- * functions, so that module test harnesses can run standalone.
- **/
-
 int modify_window = 0;
 int module_id = -1;
 int relative_paths = 0;
 int human_readable = 0;
+int module_dirlen = 0;
 mode_t orig_umask = 002;
 char *partial_dir;
 struct filter_list_struct server_filter_list;
 
  void rprintf(UNUSED(enum logcode code), const char *format, ...)
 {
@@ -66,19 +63,23 @@
 	 * just return 0. */
 	return 0;
 }
 
  char *lp_name(UNUSED(int mod))
 {
-    return NULL;
+	return NULL;
 }
 
  BOOL lp_use_chroot(UNUSED(int mod))
 {
-    return 0;
+	return 0;
 }
 
  char *lp_path(UNUSED(int mod))
 {
-    return NULL;
+	return NULL;
 }
 
+ const char *who_am_i(void)
+{
+	return "tester";
+}
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/t_unsafe.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/t_unsafe.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/t_unsafe.c	2003-09-10 16:27:34.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/t_unsafe.c	2006-04-26 07:51:15.000000000 +0800
@@ -1,32 +1,29 @@
 /*
- * Copyright (C) 2002 by Martin Pool
- * 
+ * Test harness for unsafe_symlink().  Not linked into rsync itself.
+ *
+ * Copyright (C) 2002 Martin Pool
+ * Copyright (C) 2003 Wayne Davison
+ *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
- * 
+ *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
- * 
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/**
- * @file 
- *
- * Test harness for unsafe_symlink().  Not linked into @c rsync itself.
- *
- * Prints either "safe" or "unsafe" depending on the two arguments.
- * Always returns 0 unless something extraordinary happens.
- **/
+/* Prints either "safe" or "unsafe" depending on the two arguments.
+ * Always returns 0 unless something extraordinary happens. */
 
 #include "rsync.h"
 
 int dry_run, read_only, list_only, verbose;
 int preserve_perms = 0;
 
@@ -38,9 +34,9 @@
 		fprintf(stderr, "usage: t_unsafe LINKDEST SRCDIR\n");
 		return 1;
 	}
 
 	printf("%s\n",
 	       unsafe_symlink(argv[1], argv[2]) ? "unsafe" : "safe");
-	
+
 	return 0;
 }
Only in /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9: tweak_manpage_dashes
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/uidlist.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/uidlist.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/uidlist.c	2006-01-26 01:10:29.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/uidlist.c	2006-10-14 07:35:53.000000000 +0800
@@ -1,30 +1,31 @@
 /*
-   Copyright (C) Andrew Tridgell 1996
-   Copyright (C) Paul Mackerras 1996
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-/* handle the mapping of uid/gid and user/group names between systems.
-   If the source username/group does not exist on the target then use
-   the numeric IDs. Never do any mapping for uid=0 or gid=0 as these
-   are special.
-*/
+ * Handle the mapping of uid/gid and user/group names between systems.
+ *
+ * Copyright (C) 1996 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2004, 2005, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+/* If the source username/group does not exist on the target then use
+ * the numeric IDs.  Never do any mapping for uid=0 or gid=0 as these
+ * are special. */
 
 #include "rsync.h"
 
 #ifdef HAVE_GETGROUPS
 # ifndef GETGROUPS_T
 #  define GETGROUPS_T gid_t
@@ -122,18 +123,16 @@
 			gidset[ngroups++] = mygid;
 		if (verbose > 3) {
 			int pos;
 			char *gidbuf = new_array(char, ngroups*21+32);
 			if (!gidbuf)
 				out_of_memory("is_in_group");
-			sprintf(gidbuf, "process has %d gid%s: ",
-			    ngroups, ngroups == 1? "" : "s");
-			pos = strlen(gidbuf);
+			pos = snprintf(gidbuf, 32, "process has %d gid%s: ",
+				       ngroups, ngroups == 1? "" : "s");
 			for (n = 0; n < ngroups; n++) {
-				sprintf(gidbuf+pos, " %d", (int)gidset[n]);
-				pos += strlen(gidbuf+pos);
+				pos += snprintf(gidbuf+pos, 21, " %d", (int)gidset[n]);
 			}
 			rprintf(FINFO, "%s\n", gidbuf);
 			free(gidbuf);
 		}
 	}
 
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/util.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/util.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/util.c	2006-02-24 17:34:44.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/util.c	2006-10-15 04:31:33.000000000 +0800
@@ -1,72 +1,67 @@
-/*  -*- c-file-style: "linux" -*-
+/*
+ * Utility routines used in rsync.
  *
- * Copyright (C) 1996-2000 by Andrew Tridgell
- * Copyright (C) Paul Mackerras 1996
- * Copyright (C) 2001, 2002 by Martin Pool <mbp@samba.org>
+ * Copyright (C) 1996-2000 Andrew Tridgell
+ * Copyright (C) 1996 Paul Mackerras
+ * Copyright (C) 2001, 2002 Martin Pool <mbp@samba.org>
+ * Copyright (C) 2003, 2004, 2005, 2006 Wayne Davison
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-/**
- * @file
- *
- * Utilities used in rsync
- **/
-
 #include "rsync.h"
 
 extern int verbose;
 extern int dry_run;
 extern int module_id;
 extern int modify_window;
 extern int relative_paths;
 extern int human_readable;
+extern unsigned int module_dirlen;
 extern mode_t orig_umask;
 extern char *partial_dir;
 extern struct filter_list_struct server_filter_list;
 
 int sanitize_paths = 0;
 
+char curr_dir[MAXPATHLEN];
+unsigned int curr_dir_len;
+int curr_dir_depth; /* This is only set for a sanitizing daemon. */
 
-
-/**
- * Set a fd into nonblocking mode
- **/
+/* Set a fd into nonblocking mode. */
 void set_nonblocking(int fd)
 {
 	int val;
 
-	if ((val = fcntl(fd, F_GETFL, 0)) == -1)
+	if ((val = fcntl(fd, F_GETFL)) == -1)
 		return;
 	if (!(val & NONBLOCK_FLAG)) {
 		val |= NONBLOCK_FLAG;
 		fcntl(fd, F_SETFL, val);
 	}
 }
 
-/**
- * Set a fd into blocking mode
- **/
+/* Set a fd into blocking mode. */
 void set_blocking(int fd)
 {
 	int val;
 
-	if ((val = fcntl(fd, F_GETFL, 0)) == -1)
+	if ((val = fcntl(fd, F_GETFL)) == -1)
 		return;
 	if (val & NONBLOCK_FLAG) {
 		val &= ~NONBLOCK_FLAG;
 		fcntl(fd, F_SETFL, val);
 	}
 }
@@ -94,38 +89,38 @@
 
 	return ret;
 }
 
 void print_child_argv(char **cmd)
 {
-	rprintf(FINFO, "opening connection using ");
+	rprintf(FCLIENT, "opening connection using ");
 	for (; *cmd; cmd++) {
 		/* Look for characters that ought to be quoted.  This
 		* is not a great quoting algorithm, but it's
 		* sufficient for a log message. */
 		if (strspn(*cmd, "abcdefghijklmnopqrstuvwxyz"
 			   "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
 			   "0123456789"
 			   ",.-_=+@/") != strlen(*cmd)) {
-			rprintf(FINFO, "\"%s\" ", *cmd);
+			rprintf(FCLIENT, "\"%s\" ", *cmd);
 		} else {
-			rprintf(FINFO, "%s ", *cmd);
+			rprintf(FCLIENT, "%s ", *cmd);
 		}
 	}
-	rprintf(FINFO, "\n");
+	rprintf(FCLIENT, "\n");
 }
 
-void out_of_memory(char *str)
+NORETURN void out_of_memory(char *str)
 {
-	rprintf(FERROR, "ERROR: out of memory in %s\n", str);
+	rprintf(FERROR, "ERROR: out of memory in %s [%s]\n", str, who_am_i());
 	exit_cleanup(RERR_MALLOC);
 }
 
-void overflow_exit(char *str)
+NORETURN void overflow_exit(char *str)
 {
-	rprintf(FERROR, "ERROR: buffer overflow in %s\n", str);
+	rprintf(FERROR, "ERROR: buffer overflow in %s [%s]\n", str, who_am_i());
 	exit_cleanup(RERR_MALLOC);
 }
 
 int set_modtime(char *fname, time_t modtime, mode_t mode)
 {
 #if !defined HAVE_LUTIMES || !defined HAVE_UTIMES
@@ -361,13 +356,13 @@
 		return -1;
 	}
 
 	/* start where the last one left off to reduce chance of clashes */
 	start = counter;
 	do {
-		sprintf(&path[pos], "%03d", counter);
+		snprintf(&path[pos], MAX_RENAMES_DIGITS+1, "%03d", counter);
 		if (++counter >= MAX_RENAMES)
 			counter = 1;
 	} while ((rc = access(path, 0)) == 0 && counter != start);
 
 	if (verbose > 0) {
 		rprintf(FINFO,"renaming %s to %s because of text busy\n",
@@ -546,13 +541,13 @@
 	if (maxargs <= argc)
 		return;
 	if (!*s)
 		s = ".";
 
 	if (sanitize_paths)
-		s = sanitize_path(NULL, s, "", 0);
+		s = sanitize_path(NULL, s, "", 0, NULL);
 	else
 		s = strdup(s);
 
 	memset(&globbuf, 0, sizeof globbuf);
 	if (!filter_server_path(s))
 		glob(s, 0, NULL, &globbuf);
@@ -677,13 +672,13 @@
 
 int count_dir_elements(const char *p)
 {
 	int cnt = 0, new_component = 1;
 	while (*p) {
 		if (*p++ == '/')
-			new_component = 1;
+			new_component = (*p != '.' || (p[1] != '/' && p[1] != '\0'));
 		else if (new_component) {
 			new_component = 0;
 			cnt++;
 		}
 	}
 	return cnt;
@@ -752,28 +747,35 @@
  * to call with the dest and the path (p) pointing to the same buffer, but
  * rootdir will be ignored to avoid expansion of the string.
  *
  * The rootdir string contains a value to use in place of a leading slash.
  * Specify NULL to get the default of lp_path(module_id).
  *
- * If depth is >= 0, it is a count of how many '..'s to allow at the start
- * of the path.  Use -1 to allow unlimited depth.
+ * The depth var is a count of how many '..'s to allow at the start of the
+ * path.  If symlink is set, combine its value with the "p" value to get
+ * the target path, and **return NULL if any '..'s try to escape**.
  *
  * We also clean the path in a manner similar to clean_fname() but with a
- * few differences: 
+ * few differences:
  *
  * Turns multiple adjacent slashes into a single slash, gets rid of "." dir
  * elements (INCLUDING a trailing dot dir), PRESERVES a trailing slash, and
  * ALWAYS collapses ".." elements (except for those at the start of the
  * string up to "depth" deep).  If the resulting name would be empty,
  * change it into a ".". */
-char *sanitize_path(char *dest, const char *p, const char *rootdir, int depth)
+char *sanitize_path(char *dest, const char *p, const char *rootdir, int depth,
+		    const char *symlink)
 {
-	char *start, *sanp;
+	char *start, *sanp, *save_dest = dest;
 	int rlen = 0, leave_one_dotdir = relative_paths;
 
+	if (symlink && *symlink == '/') {
+		p = symlink;
+		symlink = "";
+	}
+
 	if (dest != p) {
 		int plen = strlen(p);
 		if (*p == '/') {
 			if (!rootdir)
 				rootdir = lp_path(module_id);
 			rlen = strlen(rootdir);
@@ -790,13 +792,24 @@
 			if (rlen > 1)
 				dest[rlen++] = '/';
 		}
 	}
 
 	start = sanp = dest + rlen;
-	while (*p != '\0') {
+	while (1) {
+		if (*p == '\0') {
+			if (!symlink || !*symlink)
+				break;
+			while (sanp != start && sanp[-1] != '/') {
+				/* strip last element */
+				sanp--;
+			}
+			/* Append a relative symlink */
+			p = symlink;
+			symlink = "";
+		}
 		/* discard leading or extra slashes */
 		if (*p == '/') {
 			p++;
 			continue;
 		}
 		/* this loop iterates once per filename component in p.
@@ -812,12 +825,17 @@
 				continue;
 			}
 		}
 		if (*p == '.' && p[1] == '.' && (p[2] == '/' || p[2] == '\0')) {
 			/* ".." component followed by slash or end */
 			if (depth <= 0 || sanp != start) {
+				if (symlink && sanp == start) {
+					if (!save_dest)
+						free(dest);
+					return NULL;
+				}
 				p += 2;
 				if (sanp != start) {
 					/* back up sanp one level */
 					--sanp; /* now pointing at slash */
 					while (sanp > start && sanp[-1] != '/') {
 						/* skip back up to slash */
@@ -840,21 +858,16 @@
 	}
 	*sanp = '\0';
 
 	return dest;
 }
 
-char curr_dir[MAXPATHLEN];
-unsigned int curr_dir_len;
-
-/**
- * Like chdir(), but it keeps track of the current directory (in the
+/* Like chdir(), but it keeps track of the current directory (in the
  * global "curr_dir"), and ensures that the path size doesn't overflow.
- * Also cleans the path using the clean_fname() function.
- **/
-int push_dir(char *dir)
+ * Also cleans the path using the clean_fname() function. */
+int push_dir(char *dir, int set_path_only)
 {
 	static int initialised;
 	unsigned int len;
 
 	if (!initialised) {
 		initialised = 1;
@@ -869,25 +882,30 @@
 	if (len == 1 && *dir == '.')
 		return 1;
 
 	if ((*dir == '/' ? len : curr_dir_len + 1 + len) >= sizeof curr_dir)
 		return 0;
 
-	if (chdir(dir))
+	if (!set_path_only && chdir(dir))
 		return 0;
 
 	if (*dir == '/') {
 		memcpy(curr_dir, dir, len + 1);
 		curr_dir_len = len;
 	} else {
 		curr_dir[curr_dir_len++] = '/';
 		memcpy(curr_dir + curr_dir_len, dir, len + 1);
 		curr_dir_len += len;
 	}
 
 	curr_dir_len = clean_fname(curr_dir, 1);
+	if (sanitize_paths) {
+		if (module_dirlen > curr_dir_len)
+			module_dirlen = curr_dir_len;
+		curr_dir_depth = count_dir_elements(curr_dir + module_dirlen);
+	}
 
 	return 1;
 }
 
 /**
  * Reverse a push_dir() call.  You must pass in an absolute path
@@ -898,12 +916,14 @@
 	if (chdir(dir))
 		return 0;
 
 	curr_dir_len = strlcpy(curr_dir, dir, sizeof curr_dir);
 	if (curr_dir_len >= sizeof curr_dir)
 		curr_dir_len = sizeof curr_dir - 1;
+	if (sanitize_paths)
+		curr_dir_depth = count_dir_elements(curr_dir + module_dirlen);
 
 	return 1;
 }
 
 /**
  * Return a quoted string with the full pathname of the indicated filename.
@@ -919,32 +939,26 @@
 	if (result)
 		free(result);
 
 	if (*fn == '/')
 		p1 = p2 = "";
 	else {
-		p1 = curr_dir;
+		p1 = curr_dir + module_dirlen;
 		for (p2 = p1; *p2 == '/'; p2++) {}
 		if (*p2)
 			p2 = "/";
 	}
 	if (module_id >= 0) {
 		m1 = " (in ";
 		m2 = lp_name(module_id);
 		m3 = ")";
-		if (p1 == curr_dir) {
-			if (!lp_use_chroot(module_id)) {
-				char *p = lp_path(module_id);
-				if (*p != '/' || p[1])
-					p1 += strlen(p);
-			}
-		}
 	} else
 		m1 = m2 = m3 = "";
 
-	asprintf(&result, "\"%s%s%s\"%s%s%s", p1, p2, fn, m1, m2, m3);
+	if (asprintf(&result, "\"%s%s%s\"%s%s%s", p1, p2, fn, m1, m2, m3) <= 0)
+		out_of_memory("full_fname");
 
 	return result;
 }
 
 static char partial_fname[MAXPATHLEN];
 
@@ -964,19 +978,17 @@
 		}
 	} else
 		fn = fname;
 	if ((int)pathjoin(t, sz, partial_dir, fn) >= sz)
 		return NULL;
 	if (server_filter_list.head) {
-		static int len;
-		if (!len)
-			len = strlen(partial_dir);
-		t[len] = '\0';
+		t = strrchr(partial_fname, '/');
+		*t = '\0';
 		if (check_filter(&server_filter_list, partial_fname, 1) < 0)
 			return NULL;
-		t[len] = '/';
+		*t = '/';
 		if (check_filter(&server_filter_list, partial_fname, 0) < 0)
 			return NULL;
 	}
 
 	return partial_fname;
 }
@@ -1100,13 +1112,13 @@
 			units = 'M';
 		} else if (num > mult) {
 			dnum = (double)num / mult;
 			units = 'K';
 		}
 		if (units) {
-			sprintf(bufs[n], "%.2f%c", dnum, units);
+			snprintf(bufs[n], sizeof bufs[0], "%.2f%c", dnum, units);
 			return bufs[n];
 		}
 	}
 
 	s = bufs[n] + sizeof bufs[0] - 1;
 	*s = '\0';
diff -BEr -U 6 /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/wildtest.c /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/wildtest.c
--- /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.8/wildtest.c	2006-01-27 06:32:59.000000000 +0800
+++ /usr/info/code/cpp/LogMonitor/LogMonitor/second/download/rsync/repos/rsync-2.6.9/wildtest.c	2006-04-26 07:51:16.000000000 +0800
@@ -1,9 +1,25 @@
 /*
-**  wildmatch test suite.
-*/
+ * Test suite for the wildmatch code.
+ *
+ * Copyright (C) 2003, 2004, 2006 Wayne Davison
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.
+ */
 
 /*#define COMPARE_WITH_FNMATCH*/
 
 #define WILD_TEST_ITERATIONS
 #include "lib/wildmatch.c"
 
