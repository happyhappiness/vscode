timeout = (timeoutms > LONG_MAX) ? LONG_MAX : (long)timeoutms